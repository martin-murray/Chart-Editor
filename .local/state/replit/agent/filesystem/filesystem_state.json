{"file_contents":{"client/src/components/ui/sheet.tsx":{"content":"\"use client\"\n\nimport * as React from \"react\"\nimport * as SheetPrimitive from \"@radix-ui/react-dialog\"\nimport { cva, type VariantProps } from \"class-variance-authority\"\nimport { X } from \"lucide-react\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst Sheet = SheetPrimitive.Root\n\nconst SheetTrigger = SheetPrimitive.Trigger\n\nconst SheetClose = SheetPrimitive.Close\n\nconst SheetPortal = SheetPrimitive.Portal\n\nconst SheetOverlay = React.forwardRef<\n  React.ElementRef<typeof SheetPrimitive.Overlay>,\n  React.ComponentPropsWithoutRef<typeof SheetPrimitive.Overlay>\n>(({ className, ...props }, ref) => (\n  <SheetPrimitive.Overlay\n    className={cn(\n      \"fixed inset-0 z-50 bg-black/80  data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0\",\n      className\n    )}\n    {...props}\n    ref={ref}\n  />\n))\nSheetOverlay.displayName = SheetPrimitive.Overlay.displayName\n\nconst sheetVariants = cva(\n  \"fixed z-50 gap-4 bg-background p-6 shadow-lg transition ease-in-out data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:duration-300 data-[state=open]:duration-500\",\n  {\n    variants: {\n      side: {\n        top: \"inset-x-0 top-0 border-b data-[state=closed]:slide-out-to-top data-[state=open]:slide-in-from-top\",\n        bottom:\n          \"inset-x-0 bottom-0 border-t data-[state=closed]:slide-out-to-bottom data-[state=open]:slide-in-from-bottom\",\n        left: \"inset-y-0 left-0 h-full w-3/4 border-r data-[state=closed]:slide-out-to-left data-[state=open]:slide-in-from-left sm:max-w-sm\",\n        right:\n          \"inset-y-0 right-0 h-full w-3/4  border-l data-[state=closed]:slide-out-to-right data-[state=open]:slide-in-from-right sm:max-w-sm\",\n      },\n    },\n    defaultVariants: {\n      side: \"right\",\n    },\n  }\n)\n\ninterface SheetContentProps\n  extends React.ComponentPropsWithoutRef<typeof SheetPrimitive.Content>,\n    VariantProps<typeof sheetVariants> {}\n\nconst SheetContent = React.forwardRef<\n  React.ElementRef<typeof SheetPrimitive.Content>,\n  SheetContentProps\n>(({ side = \"right\", className, children, ...props }, ref) => (\n  <SheetPortal>\n    <SheetOverlay />\n    <SheetPrimitive.Content\n      ref={ref}\n      className={cn(sheetVariants({ side }), className)}\n      {...props}\n    >\n      {children}\n      <SheetPrimitive.Close className=\"absolute right-4 top-4 rounded-sm opacity-70 ring-offset-background transition-opacity hover:opacity-100 focus:outline-none focus:ring-2 focus:ring-ring focus:ring-offset-2 disabled:pointer-events-none data-[state=open]:bg-secondary\">\n        <X className=\"h-4 w-4\" />\n        <span className=\"sr-only\">Close</span>\n      </SheetPrimitive.Close>\n    </SheetPrimitive.Content>\n  </SheetPortal>\n))\nSheetContent.displayName = SheetPrimitive.Content.displayName\n\nconst SheetHeader = ({\n  className,\n  ...props\n}: React.HTMLAttributes<HTMLDivElement>) => (\n  <div\n    className={cn(\n      \"flex flex-col space-y-2 text-center sm:text-left\",\n      className\n    )}\n    {...props}\n  />\n)\nSheetHeader.displayName = \"SheetHeader\"\n\nconst SheetFooter = ({\n  className,\n  ...props\n}: React.HTMLAttributes<HTMLDivElement>) => (\n  <div\n    className={cn(\n      \"flex flex-col-reverse sm:flex-row sm:justify-end sm:space-x-2\",\n      className\n    )}\n    {...props}\n  />\n)\nSheetFooter.displayName = \"SheetFooter\"\n\nconst SheetTitle = React.forwardRef<\n  React.ElementRef<typeof SheetPrimitive.Title>,\n  React.ComponentPropsWithoutRef<typeof SheetPrimitive.Title>\n>(({ className, ...props }, ref) => (\n  <SheetPrimitive.Title\n    ref={ref}\n    className={cn(\"text-lg font-semibold text-foreground\", className)}\n    {...props}\n  />\n))\nSheetTitle.displayName = SheetPrimitive.Title.displayName\n\nconst SheetDescription = React.forwardRef<\n  React.ElementRef<typeof SheetPrimitive.Description>,\n  React.ComponentPropsWithoutRef<typeof SheetPrimitive.Description>\n>(({ className, ...props }, ref) => (\n  <SheetPrimitive.Description\n    ref={ref}\n    className={cn(\"text-sm text-muted-foreground\", className)}\n    {...props}\n  />\n))\nSheetDescription.displayName = SheetPrimitive.Description.displayName\n\nexport {\n  Sheet,\n  SheetPortal,\n  SheetOverlay,\n  SheetTrigger,\n  SheetClose,\n  SheetContent,\n  SheetHeader,\n  SheetFooter,\n  SheetTitle,\n  SheetDescription,\n}\n","path":null,"size_bytes":4281,"size_tokens":null},"client/src/components/ui/checkbox.tsx":{"content":"import * as React from \"react\"\nimport * as CheckboxPrimitive from \"@radix-ui/react-checkbox\"\nimport { Check } from \"lucide-react\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst Checkbox = React.forwardRef<\n  React.ElementRef<typeof CheckboxPrimitive.Root>,\n  React.ComponentPropsWithoutRef<typeof CheckboxPrimitive.Root>\n>(({ className, ...props }, ref) => (\n  <CheckboxPrimitive.Root\n    ref={ref}\n    className={cn(\n      \"peer h-4 w-4 shrink-0 rounded-sm border border-primary ring-offset-background focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:cursor-not-allowed disabled:opacity-50 data-[state=checked]:bg-primary data-[state=checked]:text-primary-foreground\",\n      className\n    )}\n    {...props}\n  >\n    <CheckboxPrimitive.Indicator\n      className={cn(\"flex items-center justify-center text-current\")}\n    >\n      <Check className=\"h-4 w-4\" />\n    </CheckboxPrimitive.Indicator>\n  </CheckboxPrimitive.Root>\n))\nCheckbox.displayName = CheckboxPrimitive.Root.displayName\n\nexport { Checkbox }\n","path":null,"size_bytes":1056,"size_tokens":null},"client/src/components/dashboard/ticker-search.tsx":{"content":"import { useState, useEffect, useRef } from \"react\";\nimport { createPortal } from \"react-dom\";\nimport { useQuery } from \"@tanstack/react-query\";\nimport { Input } from \"@/components/ui/input\";\nimport { Card } from \"@/components/ui/card\";\nimport { Search, TrendingUp, TrendingDown, Plus } from \"lucide-react\";\nimport { cn } from \"@/lib/utils\";\nimport { PriceChart } from \"./price-chart\";\n\ninterface SearchResult {\n  symbol: string;\n  name: string;\n  price: string;\n  percentChange: string;\n  marketCap: string;\n  type?: string;\n}\n\ninterface TickerSearchProps {\n  onSelectStock?: (stock: SearchResult) => void;\n}\n\nexport function TickerSearch({ onSelectStock }: TickerSearchProps) {\n  const [searchQuery, setSearchQuery] = useState(\"\");\n  const [debouncedQuery, setDebouncedQuery] = useState(\"\");\n  const [isOpen, setIsOpen] = useState(false);\n  const [selectedStock, setSelectedStock] = useState<SearchResult | null>(null);\n  const containerRef = useRef<HTMLDivElement>(null);\n  const inputRef = useRef<HTMLInputElement>(null);\n  const [dropdownPosition, setDropdownPosition] = useState({ top: 0, left: 0, width: 0 });\n  const [recentSearches, setRecentSearches] = useState<SearchResult[]>([]);\n\n  // Load recent searches from localStorage on mount\n  useEffect(() => {\n    const saved = localStorage.getItem('recentTickerSearches');\n    if (saved) {\n      try {\n        setRecentSearches(JSON.parse(saved));\n      } catch (error) {\n        console.error('Error parsing recent searches:', error);\n      }\n    }\n  }, []);\n\n  // Debounce search query - increased delay for better performance\n  useEffect(() => {\n    const timer = setTimeout(() => {\n      setDebouncedQuery(searchQuery);\n    }, 500); // Increased from 300ms to 500ms\n\n    return () => clearTimeout(timer);\n  }, [searchQuery]);\n\n  // Fetch search results using global search for type tags\n  const { data: searchResults = [], isLoading } = useQuery({\n    queryKey: [\"/api/stocks/global-search\", debouncedQuery],\n    queryFn: async (): Promise<SearchResult[]> => {\n      if (!debouncedQuery || debouncedQuery.trim().length < 2) {\n        return [];\n      }\n      const response = await fetch(`/api/stocks/global-search?q=${encodeURIComponent(debouncedQuery.trim())}`);\n      if (!response.ok) throw new Error(\"Search failed\");\n      const globalResults = await response.json();\n      \n      // Transform global search results to SearchResult format\n      return globalResults.map((result: any) => ({\n        symbol: result.symbol,\n        name: result.description,\n        price: \"0.00\", // Global search doesn't include price, will be shown when selected\n        percentChange: \"0.00\", // Global search doesn't include change, will be shown when selected\n        marketCap: \"N/A\", // Global search doesn't include market cap\n        type: result.type || \"Common Stock\" // Include type for tags\n      }));\n    },\n    enabled: debouncedQuery.trim().length >= 2,\n  });\n\n  const updateDropdownPosition = () => {\n    if (inputRef.current) {\n      const rect = inputRef.current.getBoundingClientRect();\n      setDropdownPosition({\n        top: rect.bottom + window.scrollY + 4,\n        left: rect.left + window.scrollX,\n        width: rect.width\n      });\n    }\n  };\n\n  const handleInputChange = (value: string) => {\n    setSearchQuery(value);\n    if (value.length > 0) {\n      updateDropdownPosition();\n      setIsOpen(true);\n    } else {\n      setIsOpen(false);\n    }\n  };\n\n  const handleInputFocus = (e: React.FocusEvent<HTMLInputElement>) => {\n    // Auto-select text if there's content when focusing\n    const currentValue = inputRef.current?.value || searchQuery;\n    if (currentValue.trim() && inputRef.current) {\n      setTimeout(() => {\n        if (inputRef.current) {\n          inputRef.current.select();\n        }\n      }, 10);\n    }\n    \n    updateDropdownPosition();\n    setIsOpen(true);\n  };\n\n  const handleSelectStock = (stock: SearchResult) => {\n    setSearchQuery(`${stock.symbol} - ${stock.name}`);\n    setIsOpen(false);\n    setSelectedStock(stock);\n    onSelectStock?.(stock);\n    \n    // Add to recent searches\n    addToRecentSearches(stock);\n  };\n\n  const addToRecentSearches = (stock: SearchResult) => {\n    const newRecent = [stock, ...recentSearches.filter(s => s.symbol !== stock.symbol)].slice(0, 6);\n    setRecentSearches(newRecent);\n    localStorage.setItem('recentTickerSearches', JSON.stringify(newRecent));\n  };\n\n  const handleAddToWatchlist = (e: React.MouseEvent, stock: SearchResult) => {\n    e.stopPropagation(); // Prevent triggering the parent button click\n    if ((window as any).addToWatchlist) {\n      (window as any).addToWatchlist({\n        symbol: stock.symbol,\n        name: stock.name,\n        price: stock.price,\n        percentChange: stock.percentChange,\n        marketCap: stock.marketCap\n      });\n    }\n  };\n\n  const formatPercentChange = (change: string) => {\n    const numChange = parseFloat(change);\n    return {\n      value: Math.abs(numChange).toFixed(2),\n      isPositive: numChange >= 0\n    };\n  };\n\n  // Type display text conversion - convert ETP to ETF for display\n  const getDisplayType = (type: string | undefined) => {\n    if (!type) return \"Common Stock\";\n    if (type.toLowerCase() === 'etp') return 'ETF';\n    return type;\n  };\n\n  // Type tag styling function - matches comparison chart styling\n  const getTypeColor = (type: string) => {\n    switch (type.toLowerCase()) {\n      case 'common stock':\n        return 'text-blue-600 dark:text-blue-400 bg-blue-500/10';\n      case 'index':\n        return 'text-[#FAFF50] bg-[#FAFF50]/30';\n      case 'etp':\n      case 'etf':\n        return 'text-[#FFA5FF] bg-[#FFA5FF]/30';\n      case 'mutual fund':\n        return 'text-orange-600 dark:text-orange-400 bg-orange-500/10';\n      default:\n        return 'text-gray-600 dark:text-gray-400 bg-gray-500/10';\n    }\n  };\n\n  return (\n    <div ref={containerRef} className=\"relative\">\n      {/* Search Input */}\n      <div className=\"relative\">\n        <Search className=\"absolute left-3 top-1/2 transform -translate-y-1/2 text-muted-foreground w-4 h-4\" />\n        <Input\n          ref={inputRef}\n          type=\"text\"\n          placeholder=\"Search ticker or company name...\"\n          value={searchQuery}\n          onChange={(e) => handleInputChange(e.target.value)}\n          onFocus={handleInputFocus}\n          className=\"pl-10 pr-4 bg-background border-border focus:border-[#5AF5FA] focus:ring-[#5AF5FA]/20\"\n        />\n      </div>\n\n      {/* Search Results Dropdown - Portal to body for absolute positioning */}\n      {isOpen && createPortal(\n        <Card \n          className=\"max-h-80 overflow-y-auto shadow-xl border-border bg-card\"\n          style={{\n            position: 'absolute',\n            top: dropdownPosition.top,\n            left: dropdownPosition.left,\n            width: dropdownPosition.width,\n            zIndex: 10000\n          }}\n        >\n          {/* Show recent searches when query is empty */}\n          {!searchQuery && recentSearches.length > 0 ? (\n            <div className=\"py-2\">\n              <div className=\"px-4 py-2 text-xs font-medium text-muted-foreground border-b border-border/50\">\n                Recent Searches\n              </div>\n              {recentSearches.map((stock) => {\n                const { value: changeValue, isPositive } = formatPercentChange(stock.percentChange);\n                return (\n                  <div\n                    key={`recent-${stock.symbol}-${stock.name}`}\n                    className=\"w-full px-4 py-3 hover:bg-muted/50 transition-colors border-b border-border/50 last:border-b-0 cursor-pointer\"\n                    onClick={() => handleSelectStock(stock)}\n                  >\n                    <div className=\"flex items-center justify-between\">\n                      <div className=\"flex-1 min-w-0\">\n                        <div className=\"flex items-center gap-2\">\n                          <span className=\"font-semibold text-foreground\">{stock.symbol}</span>\n                          <span className={cn(\"px-2 py-1 rounded-full text-xs font-medium\", getTypeColor(stock.type || \"Common Stock\"))}>\n                            {getDisplayType(stock.type)}\n                          </span>\n                        </div>\n                        <div className=\"text-sm text-muted-foreground truncate\">\n                          {stock.name}\n                        </div>\n                        <div className=\"text-xs text-muted-foreground mt-1\">\n                          {stock.marketCap}\n                        </div>\n                      </div>\n                      <div className=\"flex items-center gap-2 ml-4\">\n                        <span className=\"font-medium text-foreground\">\n                          ${parseFloat(stock.price).toFixed(2)}\n                        </span>\n                        <div className={cn(\n                          \"flex items-center gap-1 px-2 py-1 rounded-md text-xs font-medium\",\n                          isPositive \n                            ? \"bg-green-500/10 text-green-600 dark:text-green-400\" \n                            : \"bg-red-500/10 text-red-600 dark:text-red-400\"\n                        )}>\n                          {isPositive ? (\n                            <TrendingUp className=\"w-3 h-3\" />\n                          ) : (\n                            <TrendingDown className=\"w-3 h-3\" />\n                          )}\n                          {changeValue}%\n                        </div>\n                        <button\n                          onClick={(e) => handleAddToWatchlist(e, stock)}\n                          className=\"flex items-center gap-1 px-2 py-1 rounded-md text-xs font-medium bg-[#5AF5FA]/10 text-[#5AF5FA] hover:bg-[#5AF5FA]/20 transition-colors border border-[#5AF5FA]/30\"\n                          title=\"Add to Watchlist\"\n                        >\n                          <Plus className=\"w-3 h-3\" />\n                          Watch\n                        </button>\n                      </div>\n                    </div>\n                  </div>\n                );\n              })}\n            </div>\n          ) : searchQuery ? (\n            // Show search results when typing\n            isLoading ? (\n              <div className=\"p-4 text-center text-muted-foreground\">\n                <div className=\"flex items-center justify-center gap-2\">\n                  <div className=\"w-4 h-4 border-2 border-[#5AF5FA] border-t-transparent rounded-full animate-spin\" />\n                  Searching...\n                </div>\n              </div>\n            ) : searchResults.length > 0 ? (\n              <div className=\"py-2\">\n                {searchResults.map((stock) => {\n                  const { value: changeValue, isPositive } = formatPercentChange(stock.percentChange);\n                  return (\n                    <div\n                      key={`${stock.symbol}-${stock.name}`}\n                      className=\"w-full px-4 py-3 hover:bg-muted/50 transition-colors border-b border-border/50 last:border-b-0 cursor-pointer\"\n                      onClick={() => handleSelectStock(stock)}\n                    >\n                      <div className=\"flex items-center justify-between\">\n                        <div className=\"flex-1 min-w-0\">\n                          <div className=\"flex items-center gap-2\">\n                            <span className=\"font-semibold text-foreground\">{stock.symbol}</span>\n                            <span className={cn(\"px-2 py-1 rounded-full text-xs font-medium\", getTypeColor(stock.type || \"Common Stock\"))}>\n                              {getDisplayType(stock.type)}\n                            </span>\n                          </div>\n                          <div className=\"text-sm text-muted-foreground truncate mt-1\">\n                            {stock.name}\n                          </div>\n                          <div className=\"text-xs text-muted-foreground mt-1\">\n                            {stock.marketCap}\n                          </div>\n                        </div>\n                        <div className=\"flex items-center gap-2 ml-4\">\n                          <span className=\"font-medium text-foreground\">\n                            ${parseFloat(stock.price).toFixed(2)}\n                          </span>\n                          <div className={cn(\n                            \"flex items-center gap-1 px-2 py-1 rounded-md text-xs font-medium\",\n                            isPositive \n                              ? \"bg-green-500/10 text-green-600 dark:text-green-400\" \n                              : \"bg-red-500/10 text-red-600 dark:text-red-400\"\n                          )}>\n                            {isPositive ? (\n                              <TrendingUp className=\"w-3 h-3\" />\n                            ) : (\n                              <TrendingDown className=\"w-3 h-3\" />\n                            )}\n                            {changeValue}%\n                          </div>\n                          <button\n                            onClick={(e) => handleAddToWatchlist(e, stock)}\n                            className=\"flex items-center gap-1 px-2 py-1 rounded-md text-xs font-medium bg-[#5AF5FA]/10 text-[#5AF5FA] hover:bg-[#5AF5FA]/20 transition-colors border border-[#5AF5FA]/30\"\n                            title=\"Add to Watchlist\"\n                          >\n                            <Plus className=\"w-3 h-3\" />\n                            Watch\n                          </button>\n                        </div>\n                      </div>\n                    </div>\n                  );\n                })}\n              </div>\n            ) : debouncedQuery && !isLoading ? (\n              <div className=\"p-4 text-center text-muted-foreground\">\n                No stocks found for \"{debouncedQuery}\"\n              </div>\n            ) : null\n          ) : null}\n        </Card>,\n        document.body\n      )}\n\n      {/* Backdrop to close dropdown */}\n      {isOpen && (\n        <div\n          className=\"fixed inset-0 z-[9998]\"\n          onClick={() => setIsOpen(false)}\n        />\n      )}\n\n      {/* Price Chart */}\n      {selectedStock && (\n        <div className=\"mt-6\">\n          <PriceChart\n            symbol={selectedStock.symbol}\n            name={selectedStock.name}\n            currentPrice={selectedStock.price}\n            percentChange={selectedStock.percentChange}\n            marketCap={selectedStock.marketCap}\n          />\n        </div>\n      )}\n    </div>\n  );\n}","path":null,"size_bytes":14493,"size_tokens":null},"client/src/main.tsx":{"content":"import { createRoot } from \"react-dom/client\";\nimport App from \"./App\";\nimport \"./index.css\";\n\ncreateRoot(document.getElementById(\"root\")!).render(<App />);\n","path":null,"size_bytes":157,"size_tokens":null},"client/src/components/ui/carousel.tsx":{"content":"import * as React from \"react\"\nimport useEmblaCarousel, {\n  type UseEmblaCarouselType,\n} from \"embla-carousel-react\"\nimport { ArrowLeft, ArrowRight } from \"lucide-react\"\n\nimport { cn } from \"@/lib/utils\"\nimport { Button } from \"@/components/ui/button\"\n\ntype CarouselApi = UseEmblaCarouselType[1]\ntype UseCarouselParameters = Parameters<typeof useEmblaCarousel>\ntype CarouselOptions = UseCarouselParameters[0]\ntype CarouselPlugin = UseCarouselParameters[1]\n\ntype CarouselProps = {\n  opts?: CarouselOptions\n  plugins?: CarouselPlugin\n  orientation?: \"horizontal\" | \"vertical\"\n  setApi?: (api: CarouselApi) => void\n}\n\ntype CarouselContextProps = {\n  carouselRef: ReturnType<typeof useEmblaCarousel>[0]\n  api: ReturnType<typeof useEmblaCarousel>[1]\n  scrollPrev: () => void\n  scrollNext: () => void\n  canScrollPrev: boolean\n  canScrollNext: boolean\n} & CarouselProps\n\nconst CarouselContext = React.createContext<CarouselContextProps | null>(null)\n\nfunction useCarousel() {\n  const context = React.useContext(CarouselContext)\n\n  if (!context) {\n    throw new Error(\"useCarousel must be used within a <Carousel />\")\n  }\n\n  return context\n}\n\nconst Carousel = React.forwardRef<\n  HTMLDivElement,\n  React.HTMLAttributes<HTMLDivElement> & CarouselProps\n>(\n  (\n    {\n      orientation = \"horizontal\",\n      opts,\n      setApi,\n      plugins,\n      className,\n      children,\n      ...props\n    },\n    ref\n  ) => {\n    const [carouselRef, api] = useEmblaCarousel(\n      {\n        ...opts,\n        axis: orientation === \"horizontal\" ? \"x\" : \"y\",\n      },\n      plugins\n    )\n    const [canScrollPrev, setCanScrollPrev] = React.useState(false)\n    const [canScrollNext, setCanScrollNext] = React.useState(false)\n\n    const onSelect = React.useCallback((api: CarouselApi) => {\n      if (!api) {\n        return\n      }\n\n      setCanScrollPrev(api.canScrollPrev())\n      setCanScrollNext(api.canScrollNext())\n    }, [])\n\n    const scrollPrev = React.useCallback(() => {\n      api?.scrollPrev()\n    }, [api])\n\n    const scrollNext = React.useCallback(() => {\n      api?.scrollNext()\n    }, [api])\n\n    const handleKeyDown = React.useCallback(\n      (event: React.KeyboardEvent<HTMLDivElement>) => {\n        if (event.key === \"ArrowLeft\") {\n          event.preventDefault()\n          scrollPrev()\n        } else if (event.key === \"ArrowRight\") {\n          event.preventDefault()\n          scrollNext()\n        }\n      },\n      [scrollPrev, scrollNext]\n    )\n\n    React.useEffect(() => {\n      if (!api || !setApi) {\n        return\n      }\n\n      setApi(api)\n    }, [api, setApi])\n\n    React.useEffect(() => {\n      if (!api) {\n        return\n      }\n\n      onSelect(api)\n      api.on(\"reInit\", onSelect)\n      api.on(\"select\", onSelect)\n\n      return () => {\n        api?.off(\"select\", onSelect)\n      }\n    }, [api, onSelect])\n\n    return (\n      <CarouselContext.Provider\n        value={{\n          carouselRef,\n          api: api,\n          opts,\n          orientation:\n            orientation || (opts?.axis === \"y\" ? \"vertical\" : \"horizontal\"),\n          scrollPrev,\n          scrollNext,\n          canScrollPrev,\n          canScrollNext,\n        }}\n      >\n        <div\n          ref={ref}\n          onKeyDownCapture={handleKeyDown}\n          className={cn(\"relative\", className)}\n          role=\"region\"\n          aria-roledescription=\"carousel\"\n          {...props}\n        >\n          {children}\n        </div>\n      </CarouselContext.Provider>\n    )\n  }\n)\nCarousel.displayName = \"Carousel\"\n\nconst CarouselContent = React.forwardRef<\n  HTMLDivElement,\n  React.HTMLAttributes<HTMLDivElement>\n>(({ className, ...props }, ref) => {\n  const { carouselRef, orientation } = useCarousel()\n\n  return (\n    <div ref={carouselRef} className=\"overflow-hidden\">\n      <div\n        ref={ref}\n        className={cn(\n          \"flex\",\n          orientation === \"horizontal\" ? \"-ml-4\" : \"-mt-4 flex-col\",\n          className\n        )}\n        {...props}\n      />\n    </div>\n  )\n})\nCarouselContent.displayName = \"CarouselContent\"\n\nconst CarouselItem = React.forwardRef<\n  HTMLDivElement,\n  React.HTMLAttributes<HTMLDivElement>\n>(({ className, ...props }, ref) => {\n  const { orientation } = useCarousel()\n\n  return (\n    <div\n      ref={ref}\n      role=\"group\"\n      aria-roledescription=\"slide\"\n      className={cn(\n        \"min-w-0 shrink-0 grow-0 basis-full\",\n        orientation === \"horizontal\" ? \"pl-4\" : \"pt-4\",\n        className\n      )}\n      {...props}\n    />\n  )\n})\nCarouselItem.displayName = \"CarouselItem\"\n\nconst CarouselPrevious = React.forwardRef<\n  HTMLButtonElement,\n  React.ComponentProps<typeof Button>\n>(({ className, variant = \"outline\", size = \"icon\", ...props }, ref) => {\n  const { orientation, scrollPrev, canScrollPrev } = useCarousel()\n\n  return (\n    <Button\n      ref={ref}\n      variant={variant}\n      size={size}\n      className={cn(\n        \"absolute  h-8 w-8 rounded-full\",\n        orientation === \"horizontal\"\n          ? \"-left-12 top-1/2 -translate-y-1/2\"\n          : \"-top-12 left-1/2 -translate-x-1/2 rotate-90\",\n        className\n      )}\n      disabled={!canScrollPrev}\n      onClick={scrollPrev}\n      {...props}\n    >\n      <ArrowLeft className=\"h-4 w-4\" />\n      <span className=\"sr-only\">Previous slide</span>\n    </Button>\n  )\n})\nCarouselPrevious.displayName = \"CarouselPrevious\"\n\nconst CarouselNext = React.forwardRef<\n  HTMLButtonElement,\n  React.ComponentProps<typeof Button>\n>(({ className, variant = \"outline\", size = \"icon\", ...props }, ref) => {\n  const { orientation, scrollNext, canScrollNext } = useCarousel()\n\n  return (\n    <Button\n      ref={ref}\n      variant={variant}\n      size={size}\n      className={cn(\n        \"absolute h-8 w-8 rounded-full\",\n        orientation === \"horizontal\"\n          ? \"-right-12 top-1/2 -translate-y-1/2\"\n          : \"-bottom-12 left-1/2 -translate-x-1/2 rotate-90\",\n        className\n      )}\n      disabled={!canScrollNext}\n      onClick={scrollNext}\n      {...props}\n    >\n      <ArrowRight className=\"h-4 w-4\" />\n      <span className=\"sr-only\">Next slide</span>\n    </Button>\n  )\n})\nCarouselNext.displayName = \"CarouselNext\"\n\nexport {\n  type CarouselApi,\n  Carousel,\n  CarouselContent,\n  CarouselItem,\n  CarouselPrevious,\n  CarouselNext,\n}\n","path":null,"size_bytes":6210,"size_tokens":null},"client/src/components/ui/card.tsx":{"content":"import * as React from \"react\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst Card = React.forwardRef<\n  HTMLDivElement,\n  React.HTMLAttributes<HTMLDivElement>\n>(({ className, ...props }, ref) => (\n  <div\n    ref={ref}\n    className={cn(\n      \"rounded-lg border bg-card text-card-foreground shadow-sm\",\n      className\n    )}\n    {...props}\n  />\n))\nCard.displayName = \"Card\"\n\nconst CardHeader = React.forwardRef<\n  HTMLDivElement,\n  React.HTMLAttributes<HTMLDivElement>\n>(({ className, ...props }, ref) => (\n  <div\n    ref={ref}\n    className={cn(\"flex flex-col space-y-1.5 p-6\", className)}\n    {...props}\n  />\n))\nCardHeader.displayName = \"CardHeader\"\n\nconst CardTitle = React.forwardRef<\n  HTMLDivElement,\n  React.HTMLAttributes<HTMLDivElement>\n>(({ className, ...props }, ref) => (\n  <div\n    ref={ref}\n    className={cn(\n      \"text-2xl font-semibold leading-none tracking-tight\",\n      className\n    )}\n    {...props}\n  />\n))\nCardTitle.displayName = \"CardTitle\"\n\nconst CardDescription = React.forwardRef<\n  HTMLDivElement,\n  React.HTMLAttributes<HTMLDivElement>\n>(({ className, ...props }, ref) => (\n  <div\n    ref={ref}\n    className={cn(\"text-sm text-muted-foreground\", className)}\n    {...props}\n  />\n))\nCardDescription.displayName = \"CardDescription\"\n\nconst CardContent = React.forwardRef<\n  HTMLDivElement,\n  React.HTMLAttributes<HTMLDivElement>\n>(({ className, ...props }, ref) => (\n  <div ref={ref} className={cn(\"p-6 pt-0\", className)} {...props} />\n))\nCardContent.displayName = \"CardContent\"\n\nconst CardFooter = React.forwardRef<\n  HTMLDivElement,\n  React.HTMLAttributes<HTMLDivElement>\n>(({ className, ...props }, ref) => (\n  <div\n    ref={ref}\n    className={cn(\"flex items-center p-6 pt-0\", className)}\n    {...props}\n  />\n))\nCardFooter.displayName = \"CardFooter\"\n\nexport { Card, CardHeader, CardFooter, CardTitle, CardDescription, CardContent }\n","path":null,"size_bytes":1858,"size_tokens":null},"client/src/components/ui/input-otp.tsx":{"content":"import * as React from \"react\"\nimport { OTPInput, OTPInputContext } from \"input-otp\"\nimport { Dot } from \"lucide-react\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst InputOTP = React.forwardRef<\n  React.ElementRef<typeof OTPInput>,\n  React.ComponentPropsWithoutRef<typeof OTPInput>\n>(({ className, containerClassName, ...props }, ref) => (\n  <OTPInput\n    ref={ref}\n    containerClassName={cn(\n      \"flex items-center gap-2 has-[:disabled]:opacity-50\",\n      containerClassName\n    )}\n    className={cn(\"disabled:cursor-not-allowed\", className)}\n    {...props}\n  />\n))\nInputOTP.displayName = \"InputOTP\"\n\nconst InputOTPGroup = React.forwardRef<\n  React.ElementRef<\"div\">,\n  React.ComponentPropsWithoutRef<\"div\">\n>(({ className, ...props }, ref) => (\n  <div ref={ref} className={cn(\"flex items-center\", className)} {...props} />\n))\nInputOTPGroup.displayName = \"InputOTPGroup\"\n\nconst InputOTPSlot = React.forwardRef<\n  React.ElementRef<\"div\">,\n  React.ComponentPropsWithoutRef<\"div\"> & { index: number }\n>(({ index, className, ...props }, ref) => {\n  const inputOTPContext = React.useContext(OTPInputContext)\n  const { char, hasFakeCaret, isActive } = inputOTPContext.slots[index]\n\n  return (\n    <div\n      ref={ref}\n      className={cn(\n        \"relative flex h-10 w-10 items-center justify-center border-y border-r border-input text-sm transition-all first:rounded-l-md first:border-l last:rounded-r-md\",\n        isActive && \"z-10 ring-2 ring-ring ring-offset-background\",\n        className\n      )}\n      {...props}\n    >\n      {char}\n      {hasFakeCaret && (\n        <div className=\"pointer-events-none absolute inset-0 flex items-center justify-center\">\n          <div className=\"h-4 w-px animate-caret-blink bg-foreground duration-1000\" />\n        </div>\n      )}\n    </div>\n  )\n})\nInputOTPSlot.displayName = \"InputOTPSlot\"\n\nconst InputOTPSeparator = React.forwardRef<\n  React.ElementRef<\"div\">,\n  React.ComponentPropsWithoutRef<\"div\">\n>(({ ...props }, ref) => (\n  <div ref={ref} role=\"separator\" {...props}>\n    <Dot />\n  </div>\n))\nInputOTPSeparator.displayName = \"InputOTPSeparator\"\n\nexport { InputOTP, InputOTPGroup, InputOTPSlot, InputOTPSeparator }\n","path":null,"size_bytes":2154,"size_tokens":null},"client/src/contexts/AuthContext.tsx":{"content":"import { createContext, useContext, useState, useEffect } from 'react';\nimport { setLogoutHandler } from '@/lib/queryClient';\n\ninterface AuthContextType {\n  isAuthenticated: boolean;\n  login: (username: string, password: string) => Promise<boolean>;\n  logout: () => void;\n  validateSession: () => Promise<boolean>;\n}\n\nconst AuthContext = createContext<AuthContextType | undefined>(undefined);\n\nexport function AuthProvider({ children }: { children: React.ReactNode }) {\n  const [isAuthenticated, setIsAuthenticated] = useState<boolean>(false);\n\n  const logout = () => {\n    setIsAuthenticated(false);\n    localStorage.removeItem('isAuthenticated');\n    localStorage.removeItem('authToken');\n  };\n\n  useEffect(() => {\n    const authStatus = localStorage.getItem('isAuthenticated');\n    const authToken = localStorage.getItem('authToken');\n    if (authStatus === 'true' && authToken) {\n      setIsAuthenticated(true);\n    }\n    \n    // Register global logout handler for 401 responses\n    setLogoutHandler(logout);\n  }, []);\n\n  const login = async (username: string, password: string): Promise<boolean> => {\n    try {\n      const response = await fetch('/api/login', {\n        method: 'POST',\n        headers: {\n          'Content-Type': 'application/json',\n        },\n        body: JSON.stringify({ username, password }),\n      });\n\n      const data = await response.json();\n\n      if (data.success && data.token) {\n        setIsAuthenticated(true);\n        localStorage.setItem('isAuthenticated', 'true');\n        localStorage.setItem('authToken', data.token);\n        return true;\n      }\n      return false;\n    } catch (error) {\n      console.error('Login error:', error);\n      return false;\n    }\n  };\n\n  const validateSession = async (): Promise<boolean> => {\n    const token = localStorage.getItem('authToken');\n    if (!token) {\n      logout();\n      return false;\n    }\n\n    try {\n      const response = await fetch('/api/session', {\n        headers: {\n          'Authorization': `Bearer ${token}`,\n        },\n      });\n\n      if (response.ok) {\n        return true;\n      } else {\n        // Token is invalid or expired\n        logout();\n        return false;\n      }\n    } catch (error) {\n      console.error('Session validation error:', error);\n      logout();\n      return false;\n    }\n  };\n\n  return (\n    <AuthContext.Provider value={{ isAuthenticated, login, logout, validateSession }}>\n      {children}\n    </AuthContext.Provider>\n  );\n}\n\nexport function useAuth() {\n  const context = useContext(AuthContext);\n  if (context === undefined) {\n    throw new Error('useAuth must be used within an AuthProvider');\n  }\n  return context;\n}\n","path":null,"size_bytes":2650,"size_tokens":null},"client/src/components/ui/separator.tsx":{"content":"import * as React from \"react\"\nimport * as SeparatorPrimitive from \"@radix-ui/react-separator\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst Separator = React.forwardRef<\n  React.ElementRef<typeof SeparatorPrimitive.Root>,\n  React.ComponentPropsWithoutRef<typeof SeparatorPrimitive.Root>\n>(\n  (\n    { className, orientation = \"horizontal\", decorative = true, ...props },\n    ref\n  ) => (\n    <SeparatorPrimitive.Root\n      ref={ref}\n      decorative={decorative}\n      orientation={orientation}\n      className={cn(\n        \"shrink-0 bg-border\",\n        orientation === \"horizontal\" ? \"h-[1px] w-full\" : \"h-full w-[1px]\",\n        className\n      )}\n      {...props}\n    />\n  )\n)\nSeparator.displayName = SeparatorPrimitive.Root.displayName\n\nexport { Separator }\n","path":null,"size_bytes":756,"size_tokens":null},"client/src/pages/login.tsx":{"content":"import { useState } from 'react';\nimport { useLocation } from 'wouter';\nimport { useAuth } from '@/contexts/AuthContext';\nimport { Button } from '@/components/ui/button';\nimport { Input } from '@/components/ui/input';\nimport { Label } from '@/components/ui/label';\nimport { Card, CardContent, CardDescription, CardHeader, CardTitle } from '@/components/ui/card';\nimport intropicLogo from '@assets/Intropic_symbol_RGB-150x150_1759829619464.png';\n\nexport default function Login() {\n  const [, setLocation] = useLocation();\n  const { login } = useAuth();\n  const [username, setUsername] = useState('');\n  const [password, setPassword] = useState('');\n  const [error, setError] = useState('');\n\n  const handleSubmit = async (e: React.FormEvent) => {\n    e.preventDefault();\n    setError('');\n\n    const success = await login(username, password);\n    if (success) {\n      setLocation('/');\n    } else {\n      setError('Invalid username or password');\n    }\n  };\n\n  return (\n    <div className=\"min-h-screen w-full flex items-center justify-center bg-background p-4\">\n      <Card className=\"w-full max-w-md border-border/50 shadow-2xl\">\n        <CardHeader className=\"space-y-4 text-center\">\n          <div className=\"flex justify-center mb-2\">\n            <img \n              src={intropicLogo} \n              alt=\"Intropic Logo\" \n              className=\"w-[65px] h-[65px]\"\n            />\n          </div>\n          <CardTitle className=\"text-3xl font-light tracking-wide\" style={{ fontFamily: 'var(--font-serif)' }}>\n            Chart Editor\n          </CardTitle>\n          <CardDescription className=\"text-base\" style={{ fontFamily: 'var(--font-sans)' }}>\n            Sign in to access your dashboard\n          </CardDescription>\n        </CardHeader>\n        <CardContent>\n          <form onSubmit={handleSubmit} className=\"space-y-6\">\n            <div className=\"space-y-2\">\n              <Label \n                htmlFor=\"username\" \n                className=\"text-sm font-normal\"\n                style={{ fontFamily: 'var(--font-sans)' }}\n              >\n                Username\n              </Label>\n              <Input\n                id=\"username\"\n                type=\"email\"\n                placeholder=\"Enter your email\"\n                value={username}\n                onChange={(e) => setUsername(e.target.value)}\n                className=\"h-11 bg-input border-border/50 focus:border-[#5AF5FA] focus:ring-[#5AF5FA]/20\"\n                style={{ fontFamily: 'var(--font-sans)' }}\n                data-testid=\"input-username\"\n                required\n              />\n            </div>\n            <div className=\"space-y-2\">\n              <Label \n                htmlFor=\"password\" \n                className=\"text-sm font-normal\"\n                style={{ fontFamily: 'var(--font-sans)' }}\n              >\n                Password\n              </Label>\n              <Input\n                id=\"password\"\n                type=\"password\"\n                placeholder=\"Enter your password\"\n                value={password}\n                onChange={(e) => setPassword(e.target.value)}\n                className=\"h-11 bg-input border-border/50 focus:border-[#5AF5FA] focus:ring-[#5AF5FA]/20\"\n                style={{ fontFamily: 'var(--font-sans)' }}\n                data-testid=\"input-password\"\n                required\n              />\n            </div>\n            {error && (\n              <div \n                className=\"text-sm text-red-400 text-center p-3 rounded-md bg-red-500/10 border border-red-500/20\"\n                style={{ fontFamily: 'var(--font-sans)' }}\n                data-testid=\"text-error\"\n              >\n                {error}\n              </div>\n            )}\n            <Button\n              type=\"submit\"\n              className=\"w-full h-11 bg-[#5AF5FA] hover:bg-[#5AF5FA]/90 text-black font-medium transition-colors\"\n              style={{ fontFamily: 'var(--font-sans)' }}\n              data-testid=\"button-login\"\n            >\n              Sign In\n            </Button>\n          </form>\n          <div className=\"mt-6 text-center\">\n            <p className=\"text-xs text-muted-foreground\" style={{ fontFamily: 'var(--font-sans)' }}>\n              Real-time market analytics powered by Intropic\n            </p>\n          </div>\n        </CardContent>\n      </Card>\n    </div>\n  );\n}\n","path":null,"size_bytes":4333,"size_tokens":null},"client/src/data/market-holidays.ts":{"content":"// Market holidays for major global exchanges\n// Data for 2024-2026 to ensure current relevance\n\nexport interface MarketHoliday {\n  name: string;\n  date: string; // YYYY-MM-DD format\n  market: string;\n  country: string;\n  isHalfDay?: boolean; // If market closes early\n  earlyCloseTime?: string; // Time in local market time if half day\n}\n\nexport const MARKET_HOLIDAYS: MarketHoliday[] = [\n  // US Market Holidays 2024-2026\n  { name: \"New Year's Day\", date: \"2024-01-01\", market: \"US\", country: \"United States\" },\n  { name: \"Martin Luther King Jr. Day\", date: \"2024-01-15\", market: \"US\", country: \"United States\" },\n  { name: \"Presidents' Day\", date: \"2024-02-19\", market: \"US\", country: \"United States\" },\n  { name: \"Good Friday\", date: \"2024-03-29\", market: \"US\", country: \"United States\" },\n  { name: \"Memorial Day\", date: \"2024-05-27\", market: \"US\", country: \"United States\" },\n  { name: \"Juneteenth\", date: \"2024-06-19\", market: \"US\", country: \"United States\" },\n  { name: \"Independence Day\", date: \"2024-07-04\", market: \"US\", country: \"United States\" },\n  { name: \"Labor Day\", date: \"2024-09-02\", market: \"US\", country: \"United States\" },\n  { name: \"Thanksgiving Day\", date: \"2024-11-28\", market: \"US\", country: \"United States\" },\n  { name: \"Christmas Day\", date: \"2024-12-25\", market: \"US\", country: \"United States\" },\n  \n  // US Half Days (early close at 1 PM ET)\n  { name: \"Black Friday\", date: \"2024-11-29\", market: \"US\", country: \"United States\", isHalfDay: true, earlyCloseTime: \"13:00\" },\n  { name: \"Christmas Eve\", date: \"2024-12-24\", market: \"US\", country: \"United States\", isHalfDay: true, earlyCloseTime: \"13:00\" },\n\n  // US Market Holidays 2025\n  { name: \"New Year's Day\", date: \"2025-01-01\", market: \"US\", country: \"United States\" },\n  { name: \"Martin Luther King Jr. Day\", date: \"2025-01-20\", market: \"US\", country: \"United States\" },\n  { name: \"Presidents' Day\", date: \"2025-02-17\", market: \"US\", country: \"United States\" },\n  { name: \"Good Friday\", date: \"2025-04-18\", market: \"US\", country: \"United States\" },\n  { name: \"Memorial Day\", date: \"2025-05-26\", market: \"US\", country: \"United States\" },\n  { name: \"Juneteenth\", date: \"2025-06-19\", market: \"US\", country: \"United States\" },\n  { name: \"Independence Day\", date: \"2025-07-04\", market: \"US\", country: \"United States\" },\n  { name: \"Labor Day\", date: \"2025-09-01\", market: \"US\", country: \"United States\" },\n  { name: \"Thanksgiving Day\", date: \"2025-11-27\", market: \"US\", country: \"United States\" },\n  { name: \"Christmas Day\", date: \"2025-12-25\", market: \"US\", country: \"United States\" },\n  \n  // US Half Days 2025 (early close at 1 PM ET)\n  { name: \"Day before Independence Day\", date: \"2025-07-03\", market: \"US\", country: \"United States\", isHalfDay: true, earlyCloseTime: \"13:00\" },\n  { name: \"Black Friday\", date: \"2025-11-28\", market: \"US\", country: \"United States\", isHalfDay: true, earlyCloseTime: \"13:00\" },\n  { name: \"Christmas Eve\", date: \"2025-12-24\", market: \"US\", country: \"United States\", isHalfDay: true, earlyCloseTime: \"13:00\" },\n\n  // UK Market Holidays 2024-2025\n  { name: \"New Year's Day\", date: \"2024-01-01\", market: \"UK\", country: \"United Kingdom\" },\n  { name: \"Good Friday\", date: \"2024-03-29\", market: \"UK\", country: \"United Kingdom\" },\n  { name: \"Easter Monday\", date: \"2024-04-01\", market: \"UK\", country: \"United Kingdom\" },\n  { name: \"Early May Bank Holiday\", date: \"2024-05-06\", market: \"UK\", country: \"United Kingdom\" },\n  { name: \"Spring Bank Holiday\", date: \"2024-05-27\", market: \"UK\", country: \"United Kingdom\" },\n  { name: \"Summer Bank Holiday\", date: \"2024-08-26\", market: \"UK\", country: \"United Kingdom\" },\n  { name: \"Christmas Day\", date: \"2024-12-25\", market: \"UK\", country: \"United Kingdom\" },\n  { name: \"Boxing Day\", date: \"2024-12-26\", market: \"UK\", country: \"United Kingdom\" },\n\n  { name: \"New Year's Day\", date: \"2025-01-01\", market: \"UK\", country: \"United Kingdom\" },\n  { name: \"Good Friday\", date: \"2025-04-18\", market: \"UK\", country: \"United Kingdom\" },\n  { name: \"Easter Monday\", date: \"2025-04-21\", market: \"UK\", country: \"United Kingdom\" },\n  { name: \"Early May Bank Holiday\", date: \"2025-05-05\", market: \"UK\", country: \"United Kingdom\" },\n  { name: \"Spring Bank Holiday\", date: \"2025-05-26\", market: \"UK\", country: \"United Kingdom\" },\n  { name: \"Summer Bank Holiday\", date: \"2025-08-25\", market: \"UK\", country: \"United Kingdom\" },\n  { name: \"Christmas Day\", date: \"2025-12-25\", market: \"UK\", country: \"United Kingdom\" },\n  { name: \"Boxing Day\", date: \"2025-12-26\", market: \"UK\", country: \"United Kingdom\" },\n\n  // Germany Market Holidays 2024-2025\n  { name: \"New Year's Day\", date: \"2024-01-01\", market: \"Germany\", country: \"Germany\" },\n  { name: \"Good Friday\", date: \"2024-03-29\", market: \"Germany\", country: \"Germany\" },\n  { name: \"Easter Monday\", date: \"2024-04-01\", market: \"Germany\", country: \"Germany\" },\n  { name: \"Labour Day\", date: \"2024-05-01\", market: \"Germany\", country: \"Germany\" },\n  { name: \"Christmas Eve\", date: \"2024-12-24\", market: \"Germany\", country: \"Germany\" },\n  { name: \"Christmas Day\", date: \"2024-12-25\", market: \"Germany\", country: \"Germany\" },\n  { name: \"Boxing Day\", date: \"2024-12-26\", market: \"Germany\", country: \"Germany\" },\n  { name: \"New Year's Eve\", date: \"2024-12-31\", market: \"Germany\", country: \"Germany\" },\n\n  { name: \"New Year's Day\", date: \"2025-01-01\", market: \"Germany\", country: \"Germany\" },\n  { name: \"Good Friday\", date: \"2025-04-18\", market: \"Germany\", country: \"Germany\" },\n  { name: \"Easter Monday\", date: \"2025-04-21\", market: \"Germany\", country: \"Germany\" },\n  { name: \"Labour Day\", date: \"2025-05-01\", market: \"Germany\", country: \"Germany\" },\n  { name: \"Christmas Eve\", date: \"2025-12-24\", market: \"Germany\", country: \"Germany\" },\n  { name: \"Christmas Day\", date: \"2025-12-25\", market: \"Germany\", country: \"Germany\" },\n  { name: \"Boxing Day\", date: \"2025-12-26\", market: \"Germany\", country: \"Germany\" },\n  { name: \"New Year's Eve\", date: \"2025-12-31\", market: \"Germany\", country: \"Germany\" },\n\n  // Hong Kong Market Holidays 2024-2025\n  { name: \"New Year's Day\", date: \"2024-01-01\", market: \"Hong Kong\", country: \"Hong Kong\" },\n  { name: \"Lunar New Year\", date: \"2024-02-10\", market: \"Hong Kong\", country: \"Hong Kong\" },\n  { name: \"Lunar New Year\", date: \"2024-02-12\", market: \"Hong Kong\", country: \"Hong Kong\" },\n  { name: \"Lunar New Year\", date: \"2024-02-13\", market: \"Hong Kong\", country: \"Hong Kong\" },\n  { name: \"Good Friday\", date: \"2024-03-29\", market: \"Hong Kong\", country: \"Hong Kong\" },\n  { name: \"Day following Good Friday\", date: \"2024-03-30\", market: \"Hong Kong\", country: \"Hong Kong\" },\n  { name: \"Easter Monday\", date: \"2024-04-01\", market: \"Hong Kong\", country: \"Hong Kong\" },\n  { name: \"Ching Ming Festival\", date: \"2024-04-04\", market: \"Hong Kong\", country: \"Hong Kong\" },\n  { name: \"Labour Day\", date: \"2024-05-01\", market: \"Hong Kong\", country: \"Hong Kong\" },\n  { name: \"Buddha's Birthday\", date: \"2024-05-15\", market: \"Hong Kong\", country: \"Hong Kong\" },\n  { name: \"Dragon Boat Festival\", date: \"2024-06-10\", market: \"Hong Kong\", country: \"Hong Kong\" },\n  { name: \"Hong Kong SAR Establishment Day\", date: \"2024-07-01\", market: \"Hong Kong\", country: \"Hong Kong\" },\n  { name: \"Day following Mid-Autumn Festival\", date: \"2024-09-18\", market: \"Hong Kong\", country: \"Hong Kong\" },\n  { name: \"National Day\", date: \"2024-10-01\", market: \"Hong Kong\", country: \"Hong Kong\" },\n  { name: \"Chung Yeung Festival\", date: \"2024-10-11\", market: \"Hong Kong\", country: \"Hong Kong\" },\n  { name: \"Christmas Day\", date: \"2024-12-25\", market: \"Hong Kong\", country: \"Hong Kong\" },\n  { name: \"Boxing Day\", date: \"2024-12-26\", market: \"Hong Kong\", country: \"Hong Kong\" },\n\n  { name: \"New Year's Day\", date: \"2025-01-01\", market: \"Hong Kong\", country: \"Hong Kong\" },\n  { name: \"Day before Lunar New Year\", date: \"2025-01-28\", market: \"Hong Kong\", country: \"Hong Kong\", isHalfDay: true, earlyCloseTime: \"12:00\" },\n  { name: \"Lunar New Year's Day\", date: \"2025-01-29\", market: \"Hong Kong\", country: \"Hong Kong\" },\n  { name: \"Second Day of Lunar New Year\", date: \"2025-01-30\", market: \"Hong Kong\", country: \"Hong Kong\" },\n  { name: \"Third Day of Lunar New Year\", date: \"2025-01-31\", market: \"Hong Kong\", country: \"Hong Kong\" },\n  { name: \"Ching Ming Festival\", date: \"2025-04-04\", market: \"Hong Kong\", country: \"Hong Kong\" },\n  { name: \"Good Friday\", date: \"2025-04-18\", market: \"Hong Kong\", country: \"Hong Kong\" },\n  { name: \"Day following Good Friday\", date: \"2025-04-19\", market: \"Hong Kong\", country: \"Hong Kong\" },\n  { name: \"Easter Monday\", date: \"2025-04-21\", market: \"Hong Kong\", country: \"Hong Kong\" },\n  { name: \"Labour Day\", date: \"2025-05-01\", market: \"Hong Kong\", country: \"Hong Kong\" },\n  { name: \"Buddha's Birthday\", date: \"2025-05-05\", market: \"Hong Kong\", country: \"Hong Kong\" },\n  { name: \"Tuen Ng Festival\", date: \"2025-06-02\", market: \"Hong Kong\", country: \"Hong Kong\" },\n  { name: \"Hong Kong SAR Establishment Day\", date: \"2025-07-01\", market: \"Hong Kong\", country: \"Hong Kong\" },\n  { name: \"Day following Mid-Autumn Festival\", date: \"2025-10-07\", market: \"Hong Kong\", country: \"Hong Kong\" },\n  { name: \"National Day\", date: \"2025-10-01\", market: \"Hong Kong\", country: \"Hong Kong\" },\n  { name: \"Chung Yeung Festival\", date: \"2025-10-11\", market: \"Hong Kong\", country: \"Hong Kong\" },\n  { name: \"Christmas Day\", date: \"2025-12-25\", market: \"Hong Kong\", country: \"Hong Kong\" },\n  { name: \"Boxing Day\", date: \"2025-12-26\", market: \"Hong Kong\", country: \"Hong Kong\" },\n\n  // Japan Market Holidays 2024-2025\n  { name: \"New Year's Day\", date: \"2024-01-01\", market: \"Japan\", country: \"Japan\" },\n  { name: \"New Year Holiday\", date: \"2024-01-02\", market: \"Japan\", country: \"Japan\" },\n  { name: \"New Year Holiday\", date: \"2024-01-03\", market: \"Japan\", country: \"Japan\" },\n  { name: \"Coming of Age Day\", date: \"2024-01-08\", market: \"Japan\", country: \"Japan\" },\n  { name: \"National Foundation Day\", date: \"2024-02-11\", market: \"Japan\", country: \"Japan\" },\n  { name: \"Emperor's Birthday\", date: \"2024-02-23\", market: \"Japan\", country: \"Japan\" },\n  { name: \"Vernal Equinox Day\", date: \"2024-03-20\", market: \"Japan\", country: \"Japan\" },\n  { name: \"Showa Day\", date: \"2024-04-29\", market: \"Japan\", country: \"Japan\" },\n  { name: \"Constitution Memorial Day\", date: \"2024-05-03\", market: \"Japan\", country: \"Japan\" },\n  { name: \"Greenery Day\", date: \"2024-05-04\", market: \"Japan\", country: \"Japan\" },\n  { name: \"Children's Day\", date: \"2024-05-05\", market: \"Japan\", country: \"Japan\" },\n  { name: \"Marine Day\", date: \"2024-07-15\", market: \"Japan\", country: \"Japan\" },\n  { name: \"Mountain Day\", date: \"2024-08-11\", market: \"Japan\", country: \"Japan\" },\n  { name: \"Respect for the Aged Day\", date: \"2024-09-16\", market: \"Japan\", country: \"Japan\" },\n  { name: \"Autumnal Equinox Day\", date: \"2024-09-22\", market: \"Japan\", country: \"Japan\" },\n  { name: \"Sports Day\", date: \"2024-10-14\", market: \"Japan\", country: \"Japan\" },\n  { name: \"Culture Day\", date: \"2024-11-03\", market: \"Japan\", country: \"Japan\" },\n  { name: \"Labour Thanksgiving Day\", date: \"2024-11-23\", market: \"Japan\", country: \"Japan\" },\n  { name: \"New Year's Eve\", date: \"2024-12-31\", market: \"Japan\", country: \"Japan\" },\n\n  { name: \"New Year's Day\", date: \"2025-01-01\", market: \"Japan\", country: \"Japan\" },\n  { name: \"Bank Holiday\", date: \"2025-01-02\", market: \"Japan\", country: \"Japan\" },\n  { name: \"Bank Holiday\", date: \"2025-01-03\", market: \"Japan\", country: \"Japan\" },\n  { name: \"Coming of Age Day\", date: \"2025-01-13\", market: \"Japan\", country: \"Japan\" },\n  { name: \"National Foundation Day\", date: \"2025-02-11\", market: \"Japan\", country: \"Japan\" },\n  { name: \"Emperor's Birthday (Observed)\", date: \"2025-02-24\", market: \"Japan\", country: \"Japan\" },\n  { name: \"Vernal Equinox Day\", date: \"2025-03-20\", market: \"Japan\", country: \"Japan\" },\n  { name: \"Showa Day\", date: \"2025-04-29\", market: \"Japan\", country: \"Japan\" },\n  { name: \"Children's Day\", date: \"2025-05-05\", market: \"Japan\", country: \"Japan\" },\n  { name: \"Compensatory Holiday\", date: \"2025-05-06\", market: \"Japan\", country: \"Japan\" },\n  { name: \"Marine Day\", date: \"2025-07-21\", market: \"Japan\", country: \"Japan\" },\n  { name: \"Mountain Day\", date: \"2025-08-11\", market: \"Japan\", country: \"Japan\" },\n  { name: \"Respect for the Aged Day\", date: \"2025-09-15\", market: \"Japan\", country: \"Japan\" },\n  { name: \"Autumnal Equinox Day\", date: \"2025-09-23\", market: \"Japan\", country: \"Japan\" },\n  { name: \"Health and Sports Day\", date: \"2025-10-13\", market: \"Japan\", country: \"Japan\" },\n  { name: \"Culture Day\", date: \"2025-11-03\", market: \"Japan\", country: \"Japan\" },\n  { name: \"Labor Thanksgiving Day (Observed)\", date: \"2025-11-24\", market: \"Japan\", country: \"Japan\" },\n  { name: \"Year-End Holiday\", date: \"2025-12-31\", market: \"Japan\", country: \"Japan\" },\n];\n\n// Map exchange suffixes to markets for holiday lookup\nexport const EXCHANGE_TO_MARKET_MAP: Record<string, string> = {\n  // US exchanges\n  'NYSE': 'US',\n  'NASDAQ': 'US',\n  'AMEX': 'US',\n  'New York Stock Exchange': 'US',\n  'NASDAQ Global Select': 'US',\n  'NASDAQ Capital Market': 'US',\n  'NYSE American': 'US',\n  'US': 'US',\n  \n  // UK exchanges\n  'LSE': 'UK',\n  'L': 'UK',\n  'London Stock Exchange': 'UK',\n  'LSE Main Market': 'UK',\n  'AIM': 'UK',\n  'UK': 'UK',\n  \n  // German exchanges\n  'XETRA': 'Germany',\n  'FWB': 'Germany',\n  'Frankfurt Stock Exchange': 'Germany',\n  'Stuttgart Stock Exchange': 'Germany',\n  'Munich Stock Exchange': 'Germany',\n  'Germany': 'Germany',\n  \n  // Japanese exchanges\n  'TSE': 'Japan',\n  'T': 'Japan',\n  'Tokyo Stock Exchange': 'Japan',\n  'Japan Exchange Group': 'Japan',\n  'Osaka Exchange': 'Japan',\n  'Japan': 'Japan',\n  \n  // Additional exchanges\n  'Euronext Paris': 'France',\n  'PA': 'France',\n  'Euronext Amsterdam': 'Netherlands', \n  'Euronext Brussels': 'Belgium',\n  'SIX Swiss Exchange': 'Switzerland',\n  'Toronto Stock Exchange': 'Canada',\n  'TO': 'Canada',\n  'Australian Securities Exchange': 'Australia',\n  'AX': 'Australia',\n  'Hong Kong Stock Exchange': 'Hong Kong',\n  'HK': 'Hong Kong',\n};\n\n/**\n * Get upcoming market holidays for a specific market or all markets\n * @param market Optional market filter (e.g., 'US', 'UK', 'Germany', 'Japan')\n * @param daysAhead Number of days to look ahead (default: 30)\n * @returns Array of upcoming holidays\n */\nexport function getUpcomingHolidays(market?: string, daysAhead: number = 30): MarketHoliday[] {\n  const today = new Date();\n  const maxDate = new Date();\n  maxDate.setDate(today.getDate() + daysAhead);\n  \n  const todayStr = today.toISOString().split('T')[0];\n  const maxDateStr = maxDate.toISOString().split('T')[0];\n  \n  console.log('Debug filter - Today:', todayStr, 'Max date:', maxDateStr, 'Market:', market);\n  \n  const filtered = MARKET_HOLIDAYS\n    .filter(holiday => {\n      // Filter by date range\n      if (holiday.date < todayStr || holiday.date > maxDateStr) return false;\n      \n      // Filter by market if specified\n      if (market && holiday.market !== market) return false;\n      \n      return true;\n    })\n    .sort((a, b) => a.date.localeCompare(b.date))\n    .slice(0, 5); // Limit to next 5 holidays\n    \n  console.log('Debug filter - Filtered holidays:', filtered);\n  return filtered;\n}\n\n/**\n * Check if a specific date is a market holiday\n * @param date Date string in YYYY-MM-DD format\n * @param market Market to check\n * @returns Holiday info if it's a holiday, null otherwise\n */\nexport function isMarketHoliday(date: string, market: string): MarketHoliday | null {\n  return MARKET_HOLIDAYS.find(holiday => \n    holiday.date === date && holiday.market === market\n  ) || null;\n}\n\n/**\n * Get market name from exchange suffix or name\n */\nexport function getMarketFromExchange(exchange: string): string | undefined {\n  return EXCHANGE_TO_MARKET_MAP[exchange];\n}","path":null,"size_bytes":15724,"size_tokens":null},"client/src/components/ui/toaster.tsx":{"content":"import { useToast } from \"@/hooks/use-toast\"\nimport {\n  Toast,\n  ToastClose,\n  ToastDescription,\n  ToastProvider,\n  ToastTitle,\n  ToastViewport,\n} from \"@/components/ui/toast\"\n\nexport function Toaster() {\n  const { toasts } = useToast()\n\n  return (\n    <ToastProvider>\n      {toasts.map(function ({ id, title, description, action, ...props }) {\n        return (\n          <Toast key={id} {...props}>\n            <div className=\"grid gap-1\">\n              {title && <ToastTitle>{title}</ToastTitle>}\n              {description && (\n                <ToastDescription>{description}</ToastDescription>\n              )}\n            </div>\n            {action}\n            <ToastClose />\n          </Toast>\n        )\n      })}\n      <ToastViewport />\n    </ToastProvider>\n  )\n}\n","path":null,"size_bytes":772,"size_tokens":null},"client/src/components/ui/data-table.tsx":{"content":"import { Table, TableBody, TableCell, TableHead, TableHeader, TableRow } from \"@/components/ui/table\";\nimport { Button } from \"@/components/ui/button\";\nimport { Badge } from \"@/components/ui/badge\";\nimport { ArrowUpIcon, ArrowDownIcon } from \"lucide-react\";\nimport { cn } from \"@/lib/utils\";\n\ninterface Column<T> {\n  key: keyof T;\n  header: string;\n  cell?: (value: any, row: T) => React.ReactNode;\n  sortable?: boolean;\n}\n\ninterface DataTableProps<T> {\n  data: T[];\n  columns: Column<T>[];\n  sortBy?: keyof T;\n  sortOrder?: \"asc\" | \"desc\";\n  onSort?: (key: keyof T) => void;\n  className?: string;\n}\n\nexport function DataTable<T extends Record<string, any>>({\n  data,\n  columns,\n  sortBy,\n  sortOrder,\n  onSort,\n  className\n}: DataTableProps<T>) {\n  return (\n    <div className={cn(\"rounded-md border\", className)}>\n      <Table>\n        <TableHeader>\n          <TableRow>\n            {columns.map((column) => (\n              <TableHead key={String(column.key)} className=\"whitespace-nowrap\">\n                {column.sortable && onSort ? (\n                  <Button\n                    variant=\"ghost\"\n                    size=\"sm\"\n                    className=\"h-auto p-0 font-medium\"\n                    onClick={() => onSort(column.key)}\n                  >\n                    {column.header}\n                    {sortBy === column.key && (\n                      sortOrder === \"asc\" ? (\n                        <ArrowUpIcon className=\"ml-1 h-3 w-3\" />\n                      ) : (\n                        <ArrowDownIcon className=\"ml-1 h-3 w-3\" />\n                      )\n                    )}\n                  </Button>\n                ) : (\n                  column.header\n                )}\n              </TableHead>\n            ))}\n          </TableRow>\n        </TableHeader>\n        <TableBody>\n          {data.length === 0 ? (\n            <TableRow>\n              <TableCell colSpan={columns.length} className=\"text-center py-8 text-muted-foreground\">\n                No data available\n              </TableCell>\n            </TableRow>\n          ) : (\n            data.map((row, index) => (\n              <TableRow key={index} className=\"hover:bg-muted/50\">\n                {columns.map((column) => (\n                  <TableCell key={String(column.key)} className=\"whitespace-nowrap\">\n                    {column.cell ? column.cell(row[column.key], row) : String(row[column.key])}\n                  </TableCell>\n                ))}\n              </TableRow>\n            ))\n          )}\n        </TableBody>\n      </Table>\n    </div>\n  );\n}\n\nexport function StockSymbolCell({ symbol, name }: { symbol: string; name: string }) {\n  return (\n    <div>\n      <div className=\"font-medium text-foreground\">{symbol}</div>\n      <div className=\"text-sm text-muted-foreground truncate max-w-[200px]\">{name}</div>\n    </div>\n  );\n}\n\nexport function PercentChangeCell({ value }: { value: string }) {\n  const numValue = parseFloat(value);\n  const isPositive = numValue > 0;\n  const isNegative = numValue < 0;\n  \n  return (\n    <Badge\n      variant=\"secondary\"\n      className={cn(\n        \"font-semibold text-[#121212] border-0\",\n        isPositive && \"bg-[#5AF5FA]\",\n        isNegative && \"bg-[#FFA5FF]\",\n        !isPositive && !isNegative && \"bg-muted text-muted-foreground\"\n      )}\n    >\n      {isPositive ? \"+\" : \"\"}{value}%\n    </Badge>\n  );\n}\n\nexport function PriceChangeCell({ value }: { value: string }) {\n  const numValue = parseFloat(value);\n  const isPositive = numValue > 0;\n  const isNegative = numValue < 0;\n  \n  return (\n    <span className={cn(\n      \"font-medium\",\n      isPositive && \"text-gainer\",\n      isNegative && \"text-loser\",\n      !isPositive && !isNegative && \"text-muted-foreground\"\n    )}>\n      {isPositive ? \"+\" : \"\"}${value}\n    </span>\n  );\n}\n\nexport function IndexBadges({ indices }: { indices: string[] }) {\n  return (\n    <div className=\"flex flex-wrap gap-1\">\n      {indices.slice(0, 2).map((index) => (\n        <Badge key={index} variant=\"outline\" className=\"text-xs\">\n          {index}\n        </Badge>\n      ))}\n      {indices.length > 2 && (\n        <Badge variant=\"outline\" className=\"text-xs\">\n          +{indices.length - 2}\n        </Badge>\n      )}\n    </div>\n  );\n}\n","path":null,"size_bytes":4217,"size_tokens":null},"server/index.ts":{"content":"import express, { type Request, Response, NextFunction } from \"express\";\nimport { registerRoutes } from \"./routes\";\nimport { setupVite, serveStatic, log } from \"./vite\";\nimport { db } from \"./db\";\nimport { visitorAnalytics } from \"@shared/schema\";\nimport { count, eq, desc } from \"drizzle-orm\";\nimport { randomUUID } from \"crypto\";\n\nconst app = express();\napp.use(express.json());\napp.use(express.urlencoded({ extended: false }));\n\n// Session tracking storage\nconst activeSessions = new Map<string, { sessionId: string; startTime: number }>();\n\n// IP tracking middleware\napp.use(async (req, res, next) => {\n  try {\n    // Skip API routes and static assets to avoid excessive tracking\n    if (req.path.startsWith('/api') || req.path.startsWith('/assets') || req.path.includes('.')) {\n      return next();\n    }\n\n    // Get real IP address (considering proxies/load balancers)\n    const getClientIP = (req: Request): string => {\n      return (\n        (req.headers['x-forwarded-for'] as string)?.split(',')[0]?.trim() ||\n        (req.headers['x-real-ip'] as string) ||\n        (req.headers['x-client-ip'] as string) ||\n        req.connection.remoteAddress ||\n        req.socket.remoteAddress ||\n        '127.0.0.1'\n      );\n    };\n\n    const ipAddress = getClientIP(req);\n    const userAgent = req.headers['user-agent'] || 'Unknown';\n    const path = req.path;\n\n    // Skip localhost/development IPs\n    if (ipAddress === '127.0.0.1' || ipAddress === '::1' || ipAddress.startsWith('192.168.')) {\n      return next();\n    }\n\n    // Check for existing sessions\n    let sessionInfo = activeSessions.get(ipAddress);\n    const now = Date.now();\n\n    // If no active session or session is older than 30 minutes, create new session\n    if (!sessionInfo || (now - sessionInfo.startTime) > 30 * 60 * 1000) {\n      const sessionId = randomUUID();\n      sessionInfo = { sessionId, startTime: now };\n      activeSessions.set(ipAddress, sessionInfo);\n\n      // Get return visit count for this IP\n      const returnVisitCount = await db\n        .select({ count: count() })\n        .from(visitorAnalytics)\n        .where(eq(visitorAnalytics.ipAddress, ipAddress));\n\n      const returnVisits = (returnVisitCount[0]?.count || 0) + 1;\n\n      // Fetch geolocation data from IP-API (free, no API key required)\n      let geoData: any = {};\n      try {\n        const geoResponse = await fetch(`http://ip-api.com/json/${ipAddress}?fields=status,country,regionName,city,lat,lon,timezone,isp,org`);\n        if (geoResponse.ok) {\n          const data = await geoResponse.json();\n          if (data.status === 'success') {\n            geoData = {\n              country: data.country,\n              region: data.regionName,\n              city: data.city,\n              latitude: data.lat?.toString(),\n              longitude: data.lon?.toString(),\n              timezone: data.timezone,\n              isp: data.isp,\n              org: data.org,\n            };\n          }\n        }\n      } catch (error) {\n        console.log(`Geolocation lookup failed for ${ipAddress}:`, error);\n      }\n\n      // Store new visitor session in database\n      try {\n        await db.insert(visitorAnalytics).values({\n          ipAddress,\n          userAgent,\n          path,\n          sessionId: sessionInfo.sessionId,\n          returnVisits,\n          ...geoData,\n        });\n      } catch (error) {\n        console.log(`Failed to store visitor analytics for ${ipAddress}:`, error);\n      }\n    }\n  } catch (error) {\n    console.log('IP tracking middleware error:', error);\n  }\n\n  next();\n});\n\n// Clean up old sessions periodically (every 10 minutes)\nsetInterval(() => {\n  const now = Date.now();\n  const thirtyMinutesAgo = now - 30 * 60 * 1000;\n  \n  for (const [ip, session] of Array.from(activeSessions.entries())) {\n    if (session.startTime < thirtyMinutesAgo) {\n      activeSessions.delete(ip);\n    }\n  }\n}, 10 * 60 * 1000);\n\napp.use((req, res, next) => {\n  const start = Date.now();\n  const path = req.path;\n  let capturedJsonResponse: Record<string, any> | undefined = undefined;\n\n  const originalResJson = res.json;\n  res.json = function (bodyJson, ...args) {\n    capturedJsonResponse = bodyJson;\n    return originalResJson.apply(res, [bodyJson, ...args]);\n  };\n\n  res.on(\"finish\", () => {\n    const duration = Date.now() - start;\n    if (path.startsWith(\"/api\")) {\n      let logLine = `${req.method} ${path} ${res.statusCode} in ${duration}ms`;\n      if (capturedJsonResponse) {\n        logLine += ` :: ${JSON.stringify(capturedJsonResponse)}`;\n      }\n\n      if (logLine.length > 80) {\n        logLine = logLine.slice(0, 79) + \"\";\n      }\n\n      log(logLine);\n    }\n  });\n\n  next();\n});\n\n(async () => {\n  const server = await registerRoutes(app);\n\n  app.use((err: any, _req: Request, res: Response, _next: NextFunction) => {\n    const status = err.status || err.statusCode || 500;\n    const message = err.message || \"Internal Server Error\";\n\n    res.status(status).json({ message });\n    throw err;\n  });\n\n  // importantly only setup vite in development and after\n  // setting up all the other routes so the catch-all route\n  // doesn't interfere with the other routes\n  if (app.get(\"env\") === \"development\") {\n    await setupVite(app, server);\n  } else {\n    serveStatic(app);\n  }\n\n  // ALWAYS serve the app on the port specified in the environment variable PORT\n  // Other ports are firewalled. Default to 5000 if not specified.\n  // this serves both the API and the client.\n  // It is the only port that is not firewalled.\n  const port = parseInt(process.env.PORT || '5000', 10);\n  server.listen({\n    port,\n    host: \"0.0.0.0\",\n    reusePort: true,\n  }, () => {\n    log(`serving on port ${port}`);\n  });\n})();\n","path":null,"size_bytes":5681,"size_tokens":null},"client/src/types/stock.ts":{"content":"export interface Stock {\n  id: number;\n  symbol: string;\n  name: string;\n  price: string;\n  change: string;\n  percentChange: string;\n  marketCap: string;\n  marketCapValue: string;\n  volume: number;\n  indices: string[];\n  sector: string;\n  lastUpdated: string;\n}\n\nexport interface MarketSummary {\n  id: number;\n  totalMovers: number;\n  totalGainers: number;\n  totalLosers: number;\n  totalMarketCap: string;\n  avgGainerChange: string;\n  avgLoserChange: string;\n  avgVolume: string;\n  volatility: string;\n  sectorLeader: string;\n  lastUpdated: string;\n}\n\nexport interface SlackAlert {\n  id: number;\n  type: string;\n  title: string;\n  description: string;\n  sentAt: string;\n  status: string;\n}\n\nexport interface StockFilter {\n  changeThreshold: number;\n  marketCap: \"2B\" | \"5B\" | \"10B\" | \"50B\";\n  indexFilter: \"all\" | \"sp500\" | \"sp400\" | \"sp600\" | \"nasdaq100\" | \"russell1000\" | \"russell2000\" | \"russell3000\" | \"tmi\";\n  sortBy: \"percentChange\" | \"marketCapValue\" | \"volume\";\n  sortOrder: \"asc\" | \"desc\";\n}\n","path":null,"size_bytes":1001,"size_tokens":null},"client/src/components/ui/resizable.tsx":{"content":"\"use client\"\n\nimport { GripVertical } from \"lucide-react\"\nimport * as ResizablePrimitive from \"react-resizable-panels\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst ResizablePanelGroup = ({\n  className,\n  ...props\n}: React.ComponentProps<typeof ResizablePrimitive.PanelGroup>) => (\n  <ResizablePrimitive.PanelGroup\n    className={cn(\n      \"flex h-full w-full data-[panel-group-direction=vertical]:flex-col\",\n      className\n    )}\n    {...props}\n  />\n)\n\nconst ResizablePanel = ResizablePrimitive.Panel\n\nconst ResizableHandle = ({\n  withHandle,\n  className,\n  ...props\n}: React.ComponentProps<typeof ResizablePrimitive.PanelResizeHandle> & {\n  withHandle?: boolean\n}) => (\n  <ResizablePrimitive.PanelResizeHandle\n    className={cn(\n      \"relative flex w-px items-center justify-center bg-border after:absolute after:inset-y-0 after:left-1/2 after:w-1 after:-translate-x-1/2 focus-visible:outline-none focus-visible:ring-1 focus-visible:ring-ring focus-visible:ring-offset-1 data-[panel-group-direction=vertical]:h-px data-[panel-group-direction=vertical]:w-full data-[panel-group-direction=vertical]:after:left-0 data-[panel-group-direction=vertical]:after:h-1 data-[panel-group-direction=vertical]:after:w-full data-[panel-group-direction=vertical]:after:-translate-y-1/2 data-[panel-group-direction=vertical]:after:translate-x-0 [&[data-panel-group-direction=vertical]>div]:rotate-90\",\n      className\n    )}\n    {...props}\n  >\n    {withHandle && (\n      <div className=\"z-10 flex h-4 w-3 items-center justify-center rounded-sm border bg-border\">\n        <GripVertical className=\"h-2.5 w-2.5\" />\n      </div>\n    )}\n  </ResizablePrimitive.PanelResizeHandle>\n)\n\nexport { ResizablePanelGroup, ResizablePanel, ResizableHandle }\n","path":null,"size_bytes":1723,"size_tokens":null},"client/src/components/ui/dropdown-menu.tsx":{"content":"import * as React from \"react\"\nimport * as DropdownMenuPrimitive from \"@radix-ui/react-dropdown-menu\"\nimport { Check, ChevronRight, Circle } from \"lucide-react\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst DropdownMenu = DropdownMenuPrimitive.Root\n\nconst DropdownMenuTrigger = DropdownMenuPrimitive.Trigger\n\nconst DropdownMenuGroup = DropdownMenuPrimitive.Group\n\nconst DropdownMenuPortal = DropdownMenuPrimitive.Portal\n\nconst DropdownMenuSub = DropdownMenuPrimitive.Sub\n\nconst DropdownMenuRadioGroup = DropdownMenuPrimitive.RadioGroup\n\nconst DropdownMenuSubTrigger = React.forwardRef<\n  React.ElementRef<typeof DropdownMenuPrimitive.SubTrigger>,\n  React.ComponentPropsWithoutRef<typeof DropdownMenuPrimitive.SubTrigger> & {\n    inset?: boolean\n  }\n>(({ className, inset, children, ...props }, ref) => (\n  <DropdownMenuPrimitive.SubTrigger\n    ref={ref}\n    className={cn(\n      \"flex cursor-default select-none items-center gap-2 rounded-sm px-2 py-1.5 text-sm outline-none focus:bg-accent data-[state=open]:bg-accent [&_svg]:pointer-events-none [&_svg]:size-4 [&_svg]:shrink-0\",\n      inset && \"pl-8\",\n      className\n    )}\n    {...props}\n  >\n    {children}\n    <ChevronRight className=\"ml-auto\" />\n  </DropdownMenuPrimitive.SubTrigger>\n))\nDropdownMenuSubTrigger.displayName =\n  DropdownMenuPrimitive.SubTrigger.displayName\n\nconst DropdownMenuSubContent = React.forwardRef<\n  React.ElementRef<typeof DropdownMenuPrimitive.SubContent>,\n  React.ComponentPropsWithoutRef<typeof DropdownMenuPrimitive.SubContent>\n>(({ className, ...props }, ref) => (\n  <DropdownMenuPrimitive.SubContent\n    ref={ref}\n    className={cn(\n      \"z-50 min-w-[8rem] overflow-hidden rounded-md border bg-popover p-1 text-popover-foreground shadow-lg data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 data-[side=bottom]:slide-in-from-top-2 data-[side=left]:slide-in-from-right-2 data-[side=right]:slide-in-from-left-2 data-[side=top]:slide-in-from-bottom-2 origin-[--radix-dropdown-menu-content-transform-origin]\",\n      className\n    )}\n    {...props}\n  />\n))\nDropdownMenuSubContent.displayName =\n  DropdownMenuPrimitive.SubContent.displayName\n\nconst DropdownMenuContent = React.forwardRef<\n  React.ElementRef<typeof DropdownMenuPrimitive.Content>,\n  React.ComponentPropsWithoutRef<typeof DropdownMenuPrimitive.Content>\n>(({ className, sideOffset = 4, ...props }, ref) => (\n  <DropdownMenuPrimitive.Portal>\n    <DropdownMenuPrimitive.Content\n      ref={ref}\n      sideOffset={sideOffset}\n      className={cn(\n        \"z-50 max-h-[var(--radix-dropdown-menu-content-available-height)] min-w-[8rem] overflow-y-auto overflow-x-hidden rounded-md border bg-popover p-1 text-popover-foreground shadow-md data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 data-[side=bottom]:slide-in-from-top-2 data-[side=left]:slide-in-from-right-2 data-[side=right]:slide-in-from-left-2 data-[side=top]:slide-in-from-bottom-2 origin-[--radix-dropdown-menu-content-transform-origin]\",\n        className\n      )}\n      style={{ backgroundColor: '#3A3A3A', ...props.style }}\n      {...props}\n    />\n  </DropdownMenuPrimitive.Portal>\n))\nDropdownMenuContent.displayName = DropdownMenuPrimitive.Content.displayName\n\nconst DropdownMenuItem = React.forwardRef<\n  React.ElementRef<typeof DropdownMenuPrimitive.Item>,\n  React.ComponentPropsWithoutRef<typeof DropdownMenuPrimitive.Item> & {\n    inset?: boolean\n  }\n>(({ className, inset, ...props }, ref) => (\n  <DropdownMenuPrimitive.Item\n    ref={ref}\n    className={cn(\n      \"relative flex cursor-default select-none items-center gap-2 rounded-sm px-2 py-1.5 text-sm outline-none transition-colors focus:bg-accent focus:text-accent-foreground data-[disabled]:pointer-events-none data-[disabled]:opacity-50 [&_svg]:pointer-events-none [&_svg]:size-4 [&_svg]:shrink-0\",\n      inset && \"pl-8\",\n      className\n    )}\n    {...props}\n  />\n))\nDropdownMenuItem.displayName = DropdownMenuPrimitive.Item.displayName\n\nconst DropdownMenuCheckboxItem = React.forwardRef<\n  React.ElementRef<typeof DropdownMenuPrimitive.CheckboxItem>,\n  React.ComponentPropsWithoutRef<typeof DropdownMenuPrimitive.CheckboxItem>\n>(({ className, children, checked, ...props }, ref) => (\n  <DropdownMenuPrimitive.CheckboxItem\n    ref={ref}\n    className={cn(\n      \"relative flex cursor-default select-none items-center rounded-sm py-1.5 pl-8 pr-2 text-sm outline-none transition-colors focus:bg-accent focus:text-accent-foreground data-[disabled]:pointer-events-none data-[disabled]:opacity-50\",\n      className\n    )}\n    checked={checked}\n    {...props}\n  >\n    <span className=\"absolute left-2 flex h-3.5 w-3.5 items-center justify-center\">\n      <DropdownMenuPrimitive.ItemIndicator>\n        <Check className=\"h-4 w-4\" />\n      </DropdownMenuPrimitive.ItemIndicator>\n    </span>\n    {children}\n  </DropdownMenuPrimitive.CheckboxItem>\n))\nDropdownMenuCheckboxItem.displayName =\n  DropdownMenuPrimitive.CheckboxItem.displayName\n\nconst DropdownMenuRadioItem = React.forwardRef<\n  React.ElementRef<typeof DropdownMenuPrimitive.RadioItem>,\n  React.ComponentPropsWithoutRef<typeof DropdownMenuPrimitive.RadioItem>\n>(({ className, children, ...props }, ref) => (\n  <DropdownMenuPrimitive.RadioItem\n    ref={ref}\n    className={cn(\n      \"relative flex cursor-default select-none items-center rounded-sm py-1.5 pl-8 pr-2 text-sm outline-none transition-colors focus:bg-accent focus:text-accent-foreground data-[disabled]:pointer-events-none data-[disabled]:opacity-50\",\n      className\n    )}\n    {...props}\n  >\n    <span className=\"absolute left-2 flex h-3.5 w-3.5 items-center justify-center\">\n      <DropdownMenuPrimitive.ItemIndicator>\n        <Circle className=\"h-2 w-2 fill-current\" />\n      </DropdownMenuPrimitive.ItemIndicator>\n    </span>\n    {children}\n  </DropdownMenuPrimitive.RadioItem>\n))\nDropdownMenuRadioItem.displayName = DropdownMenuPrimitive.RadioItem.displayName\n\nconst DropdownMenuLabel = React.forwardRef<\n  React.ElementRef<typeof DropdownMenuPrimitive.Label>,\n  React.ComponentPropsWithoutRef<typeof DropdownMenuPrimitive.Label> & {\n    inset?: boolean\n  }\n>(({ className, inset, ...props }, ref) => (\n  <DropdownMenuPrimitive.Label\n    ref={ref}\n    className={cn(\n      \"px-2 py-1.5 text-sm font-semibold\",\n      inset && \"pl-8\",\n      className\n    )}\n    {...props}\n  />\n))\nDropdownMenuLabel.displayName = DropdownMenuPrimitive.Label.displayName\n\nconst DropdownMenuSeparator = React.forwardRef<\n  React.ElementRef<typeof DropdownMenuPrimitive.Separator>,\n  React.ComponentPropsWithoutRef<typeof DropdownMenuPrimitive.Separator>\n>(({ className, ...props }, ref) => (\n  <DropdownMenuPrimitive.Separator\n    ref={ref}\n    className={cn(\"-mx-1 my-1 h-px bg-muted\", className)}\n    {...props}\n  />\n))\nDropdownMenuSeparator.displayName = DropdownMenuPrimitive.Separator.displayName\n\nconst DropdownMenuShortcut = ({\n  className,\n  ...props\n}: React.HTMLAttributes<HTMLSpanElement>) => {\n  return (\n    <span\n      className={cn(\"ml-auto text-xs tracking-widest opacity-60\", className)}\n      {...props}\n    />\n  )\n}\nDropdownMenuShortcut.displayName = \"DropdownMenuShortcut\"\n\nexport {\n  DropdownMenu,\n  DropdownMenuTrigger,\n  DropdownMenuContent,\n  DropdownMenuItem,\n  DropdownMenuCheckboxItem,\n  DropdownMenuRadioItem,\n  DropdownMenuLabel,\n  DropdownMenuSeparator,\n  DropdownMenuShortcut,\n  DropdownMenuGroup,\n  DropdownMenuPortal,\n  DropdownMenuSub,\n  DropdownMenuSubContent,\n  DropdownMenuSubTrigger,\n  DropdownMenuRadioGroup,\n}\n","path":null,"size_bytes":7670,"size_tokens":null},"client/src/components/ui/aspect-ratio.tsx":{"content":"import * as AspectRatioPrimitive from \"@radix-ui/react-aspect-ratio\"\n\nconst AspectRatio = AspectRatioPrimitive.Root\n\nexport { AspectRatio }\n","path":null,"size_bytes":140,"size_tokens":null},"client/src/components/dashboard/price-chart.tsx":{"content":"import React, { useState, useRef, useMemo, useEffect } from 'react';\nimport { useQuery, useMutation, useQueries } from '@tanstack/react-query';\nimport { apiRequest, queryClient } from '@/lib/queryClient';\nimport { AreaChart, Area, LineChart, Line, BarChart, Bar, ComposedChart, XAxis, YAxis, CartesianGrid, Tooltip, ResponsiveContainer, Cell, ReferenceLine, Customized } from 'recharts';\nimport { Card, CardContent, CardHeader, CardTitle } from '@/components/ui/card';\nimport { Button } from '@/components/ui/button';\nimport { Badge } from '@/components/ui/badge';\nimport { Tabs, TabsContent, TabsList, TabsTrigger } from '@/components/ui/tabs';\nimport { Popover, PopoverContent, PopoverTrigger } from '@/components/ui/popover';\nimport { Calendar } from '@/components/ui/calendar';\nimport { DropdownMenu, DropdownMenuContent, DropdownMenuItem, DropdownMenuTrigger } from '@/components/ui/dropdown-menu';\nimport { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from '@/components/ui/select';\nimport { Tooltip as HoverTooltip, TooltipContent as HoverTooltipContent, TooltipProvider, TooltipTrigger as HoverTooltipTrigger } from '@/components/ui/tooltip';\nimport { Input } from '@/components/ui/input';\nimport { Loader2, TrendingUp, TrendingDown, Plus, Calendar as CalendarIcon, X, Download, ChevronDown, MessageSquare, Ruler, Minus, RotateCcw, Code, Type, Trash2, Settings, Pencil } from 'lucide-react';\nimport { Switch } from '@/components/ui/switch';\nimport { format, subDays, subMonths, subYears } from 'date-fns';\nimport * as htmlToImage from 'html-to-image';\nimport jsPDF from 'jspdf';\nimport { saveAs } from 'file-saver';\nimport { useToast } from '@/hooks/use-toast';\nimport { ComparisonChart } from './comparison-chart';\nimport { Dialog, DialogContent, DialogDescription, DialogHeader, DialogTitle } from '@/components/ui/dialog';\nimport { Textarea } from '@/components/ui/textarea';\nimport type { ChartHistory } from '@shared/schema';\n\ninterface ChartData {\n  timestamp: number;\n  time: string;\n  open: number;\n  high: number;\n  low: number;\n  close: number;\n  volume: number;\n}\n\ninterface ChartResponse {\n  symbol: string;\n  timeframe: string;\n  data: ChartData[];\n}\n\ninterface StockDetails {\n  quote: {\n    c: number; // Current price\n    d: number; // Change\n    dp: number; // Percent change\n    h: number; // High\n    l: number; // Low\n    o: number; // Open\n    pc: number; // Previous close\n    t: number; // Timestamp\n  };\n  profile: {\n    marketCapitalization: number;\n    shareOutstanding: number;\n    name: string;\n  };\n  metrics: {\n    peRatioTTM?: number;\n    epsTTM?: number;\n    beta?: number;\n    \"52WeekHigh\"?: number;\n    \"52WeekLow\"?: number;\n    dividendYieldTTM?: number;\n    [key: string]: any;\n  };\n}\n\ninterface Annotation {\n  id: string;\n  type: 'text' | 'percentage' | 'horizontal' | 'note';\n  x: number; // X coordinate on chart\n  y: number; // Y coordinate on chart\n  timestamp: number; // Data point timestamp\n  price: number; // Price at this point\n  text?: string; // User annotation text (for text, horizontal, and note types)\n  time: string; // Formatted time string\n  horizontalOffset?: number; // Custom horizontal position offset in pixels for dragging\n  verticalOffset?: number; // Custom vertical position offset in pixels for dragging\n  // For percentage measurements\n  startTimestamp?: number;\n  startPrice?: number;\n  startTime?: string;\n  endTimestamp?: number;\n  endPrice?: number;\n  endTime?: string;\n  percentage?: number;\n}\n\ninterface PriceChartProps {\n  symbol: string;\n  name: string;\n  currentPrice: string;\n  percentChange: string;\n  marketCap: string;\n  annotations?: Annotation[];\n  onAnnotationsChange?: (annotations: Annotation[]) => void;\n  rememberPerTicker?: boolean;\n  onClearAll?: () => void;\n  initialTab?: 'price-volume' | 'comparison';\n  onHistorySelect?: (entry: ChartHistory) => void;\n  pendingHistoryRestore?: ChartHistory | null;\n  onHistoryRestoreComplete?: () => void;\n}\n\nconst timeframes = [\n  { label: '1D', value: '1D' },\n  { label: '5D', value: '5D' },\n  { label: '2W', value: '2W' },\n  { label: '1M', value: '1M' },\n  { label: '3M', value: '3M' },\n  { label: '6M', value: '6M' },\n  { label: '1Y', value: '1Y' },\n  { label: '3Y', value: '3Y' },\n  { label: '5Y', value: '5Y' },\n  { label: 'Custom', value: 'Custom' }\n];\n\nconst timeIntervals = [\n  { label: '15 min', value: '15', resolution: '15' },\n  { label: '1 hour', value: '60', resolution: '60' },\n  { label: '3 hours', value: '180', resolution: '180' },\n  { label: '6 hours', value: '360', resolution: '360' },\n];\n\nconst getValidIntervalsForTimeframe = (timeframe: string, startDate?: Date, endDate?: Date): string[] => {\n  let daysDiff = 0;\n  \n  if (timeframe === 'Custom' && startDate && endDate) {\n    daysDiff = Math.ceil((endDate.getTime() - startDate.getTime()) / (1000 * 60 * 60 * 24));\n  } else {\n    switch (timeframe) {\n      case '1D': daysDiff = 1; break;\n      case '5D': daysDiff = 5; break;\n      case '2W': daysDiff = 14; break;\n      case '1M': daysDiff = 30; break;\n      case '3M': daysDiff = 90; break;\n      case '6M': daysDiff = 180; break;\n      case '1Y': daysDiff = 365; break;\n      case '3Y': daysDiff = 365 * 3; break;\n      case '5Y': daysDiff = 365 * 5; break;\n      default: daysDiff = 7;\n    }\n  }\n  \n  if (daysDiff <= 7) {\n    return ['15', '60', '180', '360'];\n  } else if (daysDiff <= 30) {\n    return ['60', '180', '360'];\n  } else if (daysDiff <= 90) {\n    return ['180', '360'];\n  } else {\n    return [];\n  }\n};\n\nexport function PriceChart({ \n  symbol, \n  name, \n  currentPrice,\n  initialTab = 'price-volume', \n  percentChange, \n  marketCap,\n  annotations: controlledAnnotations,\n  onAnnotationsChange,\n  rememberPerTicker = true,\n  onClearAll,\n  onHistorySelect,\n  pendingHistoryRestore,\n  onHistoryRestoreComplete\n}: PriceChartProps) {\n  const { toast } = useToast();\n  const [selectedTimeframe, setSelectedTimeframe] = useState('1D');\n  const [startDate, setStartDate] = useState<Date | undefined>(undefined);\n  const [endDate, setEndDate] = useState<Date | undefined>(undefined);\n  const [showDatePicker, setShowDatePicker] = useState(false);\n  const [singleTradingDay, setSingleTradingDay] = useState(false);\n  const [startCalendarMonth, setStartCalendarMonth] = useState<Date>(new Date());\n  const [endCalendarMonth, setEndCalendarMonth] = useState<Date>(new Date());\n  const [activeTab, setActiveTab] = useState(initialTab);\n  const [chartType, setChartType] = useState<'line' | 'mountain' | 'candlestick'>('mountain');\n  const chartRef = useRef<HTMLDivElement>(null);\n  const comparisonRef = useRef<HTMLDivElement>(null);\n  \n  // Sync activeTab with initialTab prop changes (e.g., from walkthrough navigation)\n  useEffect(() => {\n    setActiveTab(initialTab);\n  }, [initialTab]);\n  \n  // Refs to store comparison chart zoom functions\n  const comparisonZoomInRef = useRef<(() => void) | null>(null);\n  const comparisonZoomOutRef = useRef<(() => void) | null>(null);\n  const comparisonFitToDataRef = useRef<(() => void) | null>(null);\n\n  // Clear comparison zoom refs when switching away from comparison tab\n  useEffect(() => {\n    if (activeTab !== 'comparison') {\n      comparisonZoomInRef.current = null;\n      comparisonZoomOutRef.current = null;\n      comparisonFitToDataRef.current = null;\n    }\n  }, [activeTab]);\n  \n  // Annotation state - controlled if parent provides annotations\n  const [internalAnnotations, setInternalAnnotations] = useState<Annotation[]>([]);\n  const [showAnnotationInput, setShowAnnotationInput] = useState(false);\n  const [annotationInput, setAnnotationInput] = useState('');\n  const [pendingAnnotation, setPendingAnnotation] = useState<Omit<Annotation, 'id' | 'text'> | null>(null);\n  const [editingAnnotation, setEditingAnnotation] = useState<Annotation | null>(null);\n  const [isEditMode, setIsEditMode] = useState(false);\n  const [horizontalPriceInput, setHorizontalPriceInput] = useState<string>('');\n  \n  // Percentage measurement state\n  const [annotationMode, setAnnotationMode] = useState<'text' | 'percentage' | 'horizontal' | 'note'>('text');\n  const [pendingPercentageStart, setPendingPercentageStart] = useState<{\n    timestamp: number;\n    price: number;\n    time: string;\n  } | null>(null);\n\n  // CSV Overlay state\n  const [csvOverlay, setCsvOverlay] = useState<{timestamp: number, value: number}[]>([]);\n  const [showCsvModal, setShowCsvModal] = useState(false);\n\n  // Comparison ticker state - structured objects for metadata and deduplication\n  const [comparisonTickers, setComparisonTickers] = useState<Array<{\n    symbol: string;\n    name: string;\n    color: string;\n  }>>([]);\n  const [showTickerSearch, setShowTickerSearch] = useState(false);\n  const [tickerSearchQuery, setTickerSearchQuery] = useState('');\n  const [debouncedTickerQuery, setDebouncedTickerQuery] = useState('');\n  \n  // Color palette for comparison tickers\n  const COMPARISON_COLORS = ['#FFA5FF', '#AA99FF', '#50FFA5', '#FF6B9D', '#FFB347'];\n  const MAX_COMPARISON_TICKERS = 5;\n\n  // Price Y-axis zoom state\n  const [priceAxisMode, setPriceAxisMode] = useState<'auto' | 'fixed'>('auto');\n  const [priceAxisRange, setPriceAxisRange] = useState<number>(100); // Current zoom range in price units\n  const [yAxisDisplayMode, setYAxisDisplayMode] = useState<'price' | 'percentage'>('price');\n  \n  // Time interval state for intraday data density\n  const [selectedInterval, setSelectedInterval] = useState<string>('60'); // Default to 1 hour\n  \n  // Predefined zoom levels for price scaling (percentage of current price range)\n  const priceZoomLevels = [0.05, 0.1, 0.15, 0.2, 0.25, 0.3, 0.4, 0.5, 0.6, 0.7, 1.0, 1.25, 1.5, 2.0, 2.5, 3.0, 4.0, 5.0, 7.5, 10.0];\n\n\n  \n  // Drag state for horizontal lines\n  const [isDragging, setIsDragging] = useState(false);\n  const [dragAnnotationId, setDragAnnotationId] = useState<string | null>(null);\n  const [hoveredHorizontalId, setHoveredHorizontalId] = useState<string | null>(null);\n  const [dragStartY, setDragStartY] = useState(0);\n  const [dragStartPrice, setDragStartPrice] = useState(0);\n  \n  // Text annotation 2D drag state\n  const [isDraggingText, setIsDraggingText] = useState(false);\n  const [dragTextAnnotationId, setDragTextAnnotationId] = useState<string | null>(null);\n  const [dragTextStartX, setDragTextStartX] = useState(0);\n  \n  // Delete confirmation states\n  const [confirmDeleteId, setConfirmDeleteId] = useState<number | null>(null);\n  const [confirmDeleteAll, setConfirmDeleteAll] = useState(false);\n  const [deletingId, setDeletingId] = useState<number | null>(null);\n  const confirmTimeoutRef = useRef<NodeJS.Timeout | null>(null);\n  const [dragTextStartY, setDragTextStartY] = useState(0);\n  const [dragStartOffset, setDragStartOffset] = useState(0);\n  const [dragStartVerticalOffset, setDragStartVerticalOffset] = useState(0);\n  \n  // Vertical line horizontal drag state\n  const [isDraggingVertical, setIsDraggingVertical] = useState(false);\n  const [dragVerticalAnnotationId, setDragVerticalAnnotationId] = useState<string | null>(null);\n  const [dragVerticalStartX, setDragVerticalStartX] = useState(0);\n  const [dragVerticalStartTimestamp, setDragVerticalStartTimestamp] = useState(0);\n  \n  // Use controlled annotations if provided, otherwise use internal state\n  const annotations = controlledAnnotations || internalAnnotations;\n  \n  // Hover tool toggle state\n  const [showHoverTooltip, setShowHoverTooltip] = useState(true);\n  \n  // Session ID tracking - regenerates when symbol changes\n  const [chartSessionId, setChartSessionId] = useState<string>(() => crypto.randomUUID());\n  \n  // Helper function to update annotations in both controlled and uncontrolled modes\n  const updateAnnotations = (newAnnotations: Annotation[] | ((prev: Annotation[]) => Annotation[])) => {\n    if (onAnnotationsChange) {\n      // Controlled mode - resolve function to actual array\n      const resolvedAnnotations = typeof newAnnotations === 'function' \n        ? newAnnotations(annotations)\n        : newAnnotations;\n      onAnnotationsChange(resolvedAnnotations);\n    } else {\n      // Uncontrolled mode - use internal state setter\n      setInternalAnnotations(newAnnotations);\n    }\n  };\n\n  // Track last saved state (all fields, not just annotations) to prevent duplicate saves\n  const lastSavedStateRef = useRef<string | null>(null);\n  const isInitialMountRef = useRef(true);\n\n  // Mutation to save chart history\n  const saveChartHistoryMutation = useMutation({\n    mutationFn: async ({ \n      sessionId, \n      symbol, \n      timeframe, \n      customStartDate, \n      customEndDate, \n      csvOverlay,\n      comparisonTickers,\n      annotations \n    }: { \n      sessionId: string;\n      symbol: string; \n      timeframe: string;\n      customStartDate?: string;\n      customEndDate?: string;\n      csvOverlay: { timestamp: number; value: number }[];\n      comparisonTickers: Array<{ symbol: string; name: string; color: string }>;\n      annotations: Annotation[] \n    }) => {\n      await apiRequest('POST', '/api/chart-history', { \n        sessionId,\n        symbol, \n        timeframe,\n        customStartDate,\n        customEndDate,\n        csvOverlay,\n        comparisonTickers,\n        annotations \n      });\n    },\n    onSuccess: () => {\n      // Invalidate chart history query to refresh the list\n      queryClient.invalidateQueries({ queryKey: ['/api/chart-history'] });\n    },\n    onError: (error) => {\n      // Handle errors gracefully - log to console only, don't show toast\n      console.error('Failed to save chart history:', error);\n    },\n  });\n\n  // Delete individual chart history entry\n  const deleteChartHistoryMutation = useMutation({\n    mutationFn: async (id: number) => {\n      await apiRequest('DELETE', `/api/chart-history/${id}`, {});\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: ['/api/chart-history'] });\n      toast({\n        title: \"Chart Deleted\",\n        description: \"Chart history entry removed successfully\",\n      });\n    },\n    onError: (error) => {\n      toast({\n        title: \"Delete Failed\",\n        description: \"Failed to delete chart history entry\",\n        variant: \"destructive\",\n      });\n      console.error('Failed to delete chart history:', error);\n    },\n  });\n\n  // Delete all chart history entries\n  const deleteAllChartHistoryMutation = useMutation({\n    mutationFn: async () => {\n      await apiRequest('DELETE', '/api/chart-history', {});\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: ['/api/chart-history'] });\n      setConfirmDeleteAll(false);\n      toast({\n        title: \"All Charts Deleted\",\n        description: \"All chart history entries have been removed\",\n      });\n    },\n    onError: (error) => {\n      toast({\n        title: \"Delete Failed\",\n        description: \"Failed to delete chart history\",\n        variant: \"destructive\",\n      });\n      console.error('Failed to delete all chart history:', error);\n    },\n  });\n  \n  // Handle delete confirmation with 4-second timeout and slide animation\n  const handleDeleteClick = (id: number) => {\n    if (confirmDeleteId === id) {\n      // Second click - trigger slide-out animation then delete\n      setDeletingId(id);\n      setConfirmDeleteId(null);\n      if (confirmTimeoutRef.current) {\n        clearTimeout(confirmTimeoutRef.current);\n      }\n      \n      // Wait for animation to complete before actually deleting\n      setTimeout(() => {\n        deleteChartHistoryMutation.mutate(id);\n        setDeletingId(null);\n      }, 300); // 300ms for slide animation\n    } else {\n      // First click - enter confirm mode (slide bin left to reveal \"Delete Now\")\n      setConfirmDeleteId(id);\n      setConfirmDeleteAll(false);\n      \n      // Reset after 4 seconds\n      if (confirmTimeoutRef.current) {\n        clearTimeout(confirmTimeoutRef.current);\n      }\n      confirmTimeoutRef.current = setTimeout(() => {\n        setConfirmDeleteId(null);\n      }, 4000);\n    }\n  };\n  \n  const handleDeleteAllClick = () => {\n    if (confirmDeleteAll) {\n      // Second click - actually delete all\n      deleteAllChartHistoryMutation.mutate();\n      setConfirmDeleteAll(false);\n      if (confirmTimeoutRef.current) {\n        clearTimeout(confirmTimeoutRef.current);\n      }\n    } else {\n      // First click - enter confirm mode\n      setConfirmDeleteAll(true);\n      setConfirmDeleteId(null);\n      \n      // Reset after 4 seconds\n      if (confirmTimeoutRef.current) {\n        clearTimeout(confirmTimeoutRef.current);\n      }\n      confirmTimeoutRef.current = setTimeout(() => {\n        setConfirmDeleteAll(false);\n      }, 4000);\n    }\n  };\n  \n  // Clean up timeout on unmount\n  useEffect(() => {\n    return () => {\n      if (confirmTimeoutRef.current) {\n        clearTimeout(confirmTimeoutRef.current);\n      }\n    };\n  }, []);\n\n  // Auto-save full chart state with debouncing\n  useEffect(() => {\n    // Skip on initial mount (don't save pre-loaded state)\n    if (isInitialMountRef.current) {\n      isInitialMountRef.current = false;\n      const initialState = JSON.stringify({\n        timeframe: selectedTimeframe,\n        customStartDate: startDate?.toISOString(),\n        customEndDate: endDate?.toISOString(),\n        csvOverlay,\n        comparisonTickers,\n        annotations\n      });\n      lastSavedStateRef.current = initialState;\n      return;\n    }\n\n    // Check if there's something worth saving (annotations, comparison tickers, csv overlay, or custom date range)\n    const hasAnnotations = annotations.length > 0;\n    const hasComparisonTickers = comparisonTickers.length > 0;\n    const hasCsvOverlay = csvOverlay.length > 0;\n    const hasCustomDateRange = selectedTimeframe === 'Custom' && startDate && endDate;\n    \n    if (!hasAnnotations && !hasComparisonTickers && !hasCsvOverlay && !hasCustomDateRange) {\n      lastSavedStateRef.current = null;\n      return;\n    }\n\n    // Check if any state actually changed since last save\n    const currentState = JSON.stringify({\n      timeframe: selectedTimeframe,\n      customStartDate: startDate?.toISOString(),\n      customEndDate: endDate?.toISOString(),\n      csvOverlay,\n      comparisonTickers,\n      annotations\n    });\n    \n    if (currentState === lastSavedStateRef.current) {\n      return; // No changes, skip save\n    }\n\n    // Debounce the save operation (2000ms delay)\n    const timeoutId = setTimeout(() => {\n      saveChartHistoryMutation.mutate({ \n        sessionId: chartSessionId,\n        symbol, \n        timeframe: selectedTimeframe,\n        customStartDate: selectedTimeframe === 'Custom' && startDate ? startDate.toISOString() : undefined,\n        customEndDate: selectedTimeframe === 'Custom' && endDate ? endDate.toISOString() : undefined,\n        csvOverlay,\n        comparisonTickers,\n        annotations \n      });\n      lastSavedStateRef.current = currentState;\n    }, 2000);\n\n    // Clear timeout on new changes to avoid multiple saves\n    return () => {\n      clearTimeout(timeoutId);\n    };\n  }, [annotations, selectedTimeframe, startDate, endDate, csvOverlay, comparisonTickers, symbol, chartSessionId, saveChartHistoryMutation]);\n\n  // Reset initial mount flag when symbol changes\n  useEffect(() => {\n    isInitialMountRef.current = true;\n    lastSavedStateRef.current = null;\n  }, [symbol]);\n\n  // Use symbol as sessionId to prevent duplicates when switching back to the same ticker\n  useEffect(() => {\n    setChartSessionId(symbol);\n  }, [symbol]);\n\n  // Debounce ticker search query (Task 1)\n  useEffect(() => {\n    const timeoutId = setTimeout(() => {\n      setDebouncedTickerQuery(tickerSearchQuery);\n    }, 300);\n    \n    return () => clearTimeout(timeoutId);\n  }, [tickerSearchQuery]);\n\n  // Auto-switch to percentage mode and line chart when comparison tickers are added (Compare Mode)\n  // Revert to price mode and restore chart type when all comparisons are removed\n  // This ensures tickers with vastly different price levels are visible on the same scale\n  const prevComparisonCountRef = useRef(0);\n  const savedChartTypeRef = useRef<'line' | 'mountain' | 'candlestick'>('mountain');\n  useEffect(() => {\n    if (comparisonTickers.length > 0 && prevComparisonCountRef.current === 0) {\n      // Switching into compare mode - save current settings and switch to optimal compare view\n      savedChartTypeRef.current = chartType;\n      setYAxisDisplayMode('percentage');\n      // Candlestick doesn't work for percentage comparison - switch to line\n      if (chartType === 'candlestick') {\n        setChartType('line');\n      }\n    } else if (comparisonTickers.length === 0 && prevComparisonCountRef.current > 0) {\n      // Switching out of compare mode - restore original settings\n      setYAxisDisplayMode('price');\n      setChartType(savedChartTypeRef.current);\n    } else if (comparisonTickers.length > 0 && chartType === 'candlestick') {\n      // Defensive: if somehow candlestick is selected while in compare mode, coerce to line\n      setChartType('line');\n    }\n    prevComparisonCountRef.current = comparisonTickers.length;\n  }, [comparisonTickers.length, chartType]);\n\n  const handleMouseDown = (event: React.MouseEvent) => {\n    if (!chartRef.current) return;\n    if (!chartData?.data) return;\n    \n    const rect = chartRef.current.getBoundingClientRect();\n    const mouseY = event.clientY - rect.top;\n    \n    const chartHeight = rect.height - 120;\n    const chartTop = 60;\n    const relativeY = mouseY - chartTop;\n    \n    const prices = chartData.data.flatMap(d => [d.high, d.low, d.open, d.close]);\n    const minPrice = Math.min(...prices);\n    const maxPrice = Math.max(...prices);\n    const priceRange = maxPrice - minPrice;\n    const priceAtMouse = maxPrice - (relativeY / chartHeight) * priceRange;\n    \n    let closestHorizontalAnnotation: Annotation | null = null;\n    let closestHorizontalDistance = Infinity;\n    \n    annotations.forEach(annotation => {\n      if (annotation.type === 'horizontal' && 'price' in annotation) {\n        const distance = Math.abs(annotation.price - priceAtMouse);\n        const toleranceInPrice = priceRange * 0.005;\n        if (distance < closestHorizontalDistance && distance < toleranceInPrice) {\n          closestHorizontalDistance = distance;\n          closestHorizontalAnnotation = annotation;\n        }\n      }\n    });\n    \n    let closestVerticalAnnotation: Annotation | null = null;\n    let closestVerticalDistance = Infinity;\n    \n    const mouseX = event.clientX - rect.left;\n    const chartWidth = rect.width - 120;\n    const chartLeft = 60;\n    const relativeX = mouseX - chartLeft;\n    const xPercent = relativeX / chartWidth;\n    const estimatedDataIndex = Math.round(xPercent * (chartData.data.length - 1));\n    \n    annotations.forEach(annotation => {\n      if (annotation.type === 'text' && 'timestamp' in annotation) {\n        const actualDataIndex = chartData.data.findIndex(d => d.timestamp === annotation.timestamp);\n        if (actualDataIndex !== -1) {\n          const distance = Math.abs(actualDataIndex - estimatedDataIndex);\n          const toleranceInDataPoints = Math.max(2, chartData.data.length * 0.02);\n          if (distance < closestVerticalDistance && distance < toleranceInDataPoints) {\n            closestVerticalDistance = distance;\n            closestVerticalAnnotation = annotation;\n          }\n        }\n      }\n    });\n    \n    if (closestHorizontalAnnotation && (!closestVerticalAnnotation || closestHorizontalDistance < closestVerticalDistance * 0.5)) {\n      const horizontalAnnotation = closestHorizontalAnnotation as Annotation & { price: number };\n      setIsDragging(true);\n      setDragAnnotationId(horizontalAnnotation.id);\n      setDragStartY(mouseY);\n      setDragStartPrice(horizontalAnnotation.price);\n      event.preventDefault();\n      event.stopPropagation();\n    } else if (closestVerticalAnnotation) {\n      const verticalAnnotation = closestVerticalAnnotation as Annotation & { timestamp: number };\n      setIsDraggingVertical(true);\n      setDragVerticalAnnotationId(verticalAnnotation.id);\n      setDragVerticalStartX(event.clientX);\n      setDragVerticalStartTimestamp(verticalAnnotation.timestamp);\n      event.preventDefault();\n      event.stopPropagation();\n    }\n  };\n\n  const handleMouseMove = (event: React.MouseEvent) => {\n    if (!isDragging || !dragAnnotationId || !chartRef.current || !chartData?.data) return;\n    \n    const rect = chartRef.current.getBoundingClientRect();\n    const mouseY = event.clientY - rect.top;\n    const deltaY = mouseY - dragStartY;\n    \n    // Convert pixel delta to price delta\n    const chartHeight = rect.height - 120;\n    const prices = chartData.data.flatMap(d => [d.high, d.low, d.open, d.close]);\n    const minPrice = Math.min(...prices);\n    const maxPrice = Math.max(...prices);\n    const priceRange = maxPrice - minPrice;\n    const priceDelta = -(deltaY / chartHeight) * priceRange; // Negative because Y increases downward\n    const newPrice = dragStartPrice + priceDelta;\n    \n    // Update the annotation\n    updateAnnotations(prev => prev.map(ann => \n      ann.id === dragAnnotationId \n        ? { ...ann, price: newPrice }\n        : ann\n    ));\n  };\n\n  const handleMouseUp = () => {\n    if (isDragging) {\n      setIsDragging(false);\n      setDragAnnotationId(null);\n      setDragStartY(0);\n      setDragStartPrice(0);\n    }\n  };\n\n  const handleVerticalMouseUp = () => {\n    if (isDraggingVertical) {\n      setIsDraggingVertical(false);\n      setDragVerticalAnnotationId(null);\n      setDragVerticalStartX(0);\n      setDragVerticalStartTimestamp(0);\n    }\n  };\n\n  // Text annotation drag handlers\n  const handleTextMouseDown = (e: React.MouseEvent, annotation: Annotation) => {\n    setIsDraggingText(true);\n    setDragTextAnnotationId(annotation.id);\n    setDragTextStartX(e.clientX);\n    setDragTextStartY(e.clientY);\n    setDragStartOffset(annotation.horizontalOffset || 0);\n    setDragStartVerticalOffset(annotation.verticalOffset || 0);\n    e.preventDefault();\n    e.stopPropagation();\n  };\n\n  const handleTextMouseUp = () => {\n    if (isDraggingText) {\n      setIsDraggingText(false);\n      setDragTextAnnotationId(null);\n      setDragTextStartX(0);\n      setDragTextStartY(0);\n      setDragStartOffset(0);\n      setDragStartVerticalOffset(0);\n    }\n  };\n\n\n\n  // Chart data query - must be declared before useEffect that depends on it\n  // Stock Details Query for Exchange and Currency Info\n  const { data: stockDetails } = useQuery({\n    queryKey: ['/api/stocks', symbol, 'details'],\n    queryFn: async () => {\n      const response = await fetch(`/api/stocks/${symbol}/details`);\n      if (!response.ok) return null;\n      return response.json();\n    },\n    enabled: !!symbol,\n    staleTime: 300000, // 5 minutes\n  });\n\n  // Get valid intervals for current timeframe\n  const validIntervals = useMemo(() => \n    getValidIntervalsForTimeframe(selectedTimeframe, startDate, endDate),\n    [selectedTimeframe, startDate, endDate]\n  );\n  \n  // Auto-adjust interval when timeframe or date range changes and current interval becomes invalid\n  useEffect(() => {\n    if (validIntervals.length > 0 && !validIntervals.includes(selectedInterval)) {\n      // Switch to closest valid interval\n      setSelectedInterval(validIntervals[0]);\n    }\n  }, [validIntervals, selectedInterval]);\n\n  // Track if we're in \"daily aggregation\" mode (long range with no valid intervals)\n  const isDailyAggregationMode = validIntervals.length === 0;\n\n  const { data: chartData, isLoading, error } = useQuery({\n    queryKey: [\n      '/api/stocks', \n      symbol, \n      'chart', \n      selectedTimeframe, \n      startDate?.toISOString(), \n      endDate?.toISOString(), \n      singleTradingDay,\n      selectedInterval\n    ],\n    queryFn: async (): Promise<ChartResponse> => {\n      // Add interval parameter if valid intervals exist for this timeframe\n      const intervalParam = validIntervals.length > 0 ? `&interval=${selectedInterval}` : '';\n      let url = `/api/stocks/${symbol}/chart?timeframe=${selectedTimeframe}${intervalParam}`;\n      if (selectedTimeframe === 'Custom' && startDate && endDate) {\n        let fromTimestamp: number;\n        let toTimestamp: number;\n        \n        if (singleTradingDay || startDate.toDateString() === endDate.toDateString()) {\n          // Single trading day - use full day range to support global markets\n          // Don't restrict to US market hours - let Finnhub return whatever intraday data exists\n          const tradingDay = startDate;\n          \n          // Use start and end of the selected day in UTC\n          // This allows each market's natural trading hours to show through\n          const dayStart = new Date(tradingDay.getFullYear(), tradingDay.getMonth(), tradingDay.getDate(), 0, 0, 0, 0);\n          const dayEnd = new Date(tradingDay.getFullYear(), tradingDay.getMonth(), tradingDay.getDate(), 23, 59, 59, 999);\n          \n          fromTimestamp = Math.floor(dayStart.getTime() / 1000);\n          toTimestamp = Math.floor(dayEnd.getTime() / 1000);\n        } else {\n          // Date range - use full days, ensuring we capture the entire selected dates\n          // Create new dates at midnight local time to avoid timezone issues\n          const rangeStart = new Date(startDate.getFullYear(), startDate.getMonth(), startDate.getDate(), 0, 0, 0, 0);\n          const rangeEnd = new Date(endDate.getFullYear(), endDate.getMonth(), endDate.getDate(), 23, 59, 59, 999);\n          \n          fromTimestamp = Math.floor(rangeStart.getTime() / 1000);\n          toTimestamp = Math.floor(rangeEnd.getTime() / 1000);\n        }\n        \n        url = `/api/stocks/${symbol}/chart?from=${fromTimestamp}&to=${toTimestamp}&timeframe=Custom${intervalParam}`;\n      }\n      \n      const response = await fetch(url);\n      if (!response.ok) {\n        const errorText = await response.text();\n        throw new Error(`HTTP ${response.status}: ${errorText}`);\n      }\n      \n      const data = await response.json();\n      \n      // Debug logging for Single Trading Day\n      if (selectedTimeframe === 'Custom' && singleTradingDay) {\n        console.log(' Single Trading Day API response:', {\n          symbol,\n          url,\n          dataLength: data?.data?.length || 0,\n          hasData: Boolean(data?.data?.length),\n          timeframe: data?.timeframe,\n          response: data\n        });\n      }\n      \n      // Ensure we have valid data structure\n      if (!data || !data.data) {\n        throw new Error('Invalid response format');\n      }\n      \n      return data;\n    },\n    enabled: !!symbol && (selectedTimeframe !== 'Custom' || (!!startDate && !!endDate)),\n    staleTime: 30000, // Consider data fresh for 30 seconds\n    retry: (failureCount, error) => {\n      // Don't retry if it's a clear 404 or data structure issue\n      if (error?.message?.includes('404') || error?.message?.includes('Invalid response format')) {\n        return false;\n      }\n      return failureCount < 2;\n    },\n  });\n\n  React.useEffect(() => {\n    if (isDragging || isDraggingText || isDraggingVertical) {\n      const handleGlobalMouseUp = () => {\n        handleMouseUp();\n        handleTextMouseUp();\n        handleVerticalMouseUp();\n      };\n      \n      const handleGlobalMouseMove = (event: MouseEvent) => {\n        if (isDragging && dragAnnotationId && chartData?.data) {\n          const deltaY = event.clientY - dragStartY;\n          const prices = chartData.data.flatMap(d => [d.high, d.low, d.open, d.close]);\n          const minPrice = Math.min(...prices);\n          const maxPrice = Math.max(...prices);\n          const priceRange = maxPrice - minPrice;\n          \n          const chartHeight = 320;\n          const priceDelta = (deltaY / chartHeight) * priceRange;\n          const newPrice = dragStartPrice - priceDelta;\n          \n          updateAnnotations(prev => prev.map(ann => \n            ann.id === dragAnnotationId \n              ? { ...ann, price: newPrice }\n              : ann\n          ));\n        }\n        \n        // Handle text annotation 2D dragging\n        if (isDraggingText && dragTextAnnotationId) {\n          const deltaX = event.clientX - dragTextStartX;\n          const deltaY = event.clientY - dragTextStartY;\n          const newHorizontalOffset = dragStartOffset + deltaX;\n          const newVerticalOffset = dragStartVerticalOffset + deltaY;\n          \n          // Update the annotation's horizontal and vertical offsets\n          updateAnnotations(prev => prev.map(ann => \n            ann.id === dragTextAnnotationId \n              ? { ...ann, horizontalOffset: newHorizontalOffset, verticalOffset: newVerticalOffset }\n              : ann\n          ));\n        }\n        \n        // Handle vertical line horizontal dragging\n        if (isDraggingVertical && dragVerticalAnnotationId && chartData?.data) {\n          const deltaX = event.clientX - dragVerticalStartX;\n          \n          // Calculate new timestamp based on horizontal movement\n          const chartWidth = 800; // Approximate chart width\n          const dataLength = chartData.data.length;\n          const pixelsPerDataPoint = chartWidth / (dataLength - 1);\n          const dataPointDelta = Math.round(deltaX / pixelsPerDataPoint);\n          \n          // Find current annotation's data index\n          const currentIndex = chartData.data.findIndex(d => d.timestamp === dragVerticalStartTimestamp);\n          if (currentIndex !== -1) {\n            const newIndex = Math.max(0, Math.min(dataLength - 1, currentIndex + dataPointDelta));\n            const newDataPoint = chartData.data[newIndex];\n            \n            if (newDataPoint) {\n              // Update the annotation with new timestamp and time\n              updateAnnotations(prev => prev.map(ann => \n                ann.id === dragVerticalAnnotationId \n                  ? { \n                      ...ann, \n                      timestamp: newDataPoint.timestamp,\n                      time: new Date(newDataPoint.timestamp).toLocaleTimeString('en-US', {\n                        hour: '2-digit',\n                        minute: '2-digit',\n                        hour12: false\n                      })\n                    }\n                  : ann\n              ));\n            }\n          }\n        }\n      };\n      \n      document.addEventListener('mouseup', handleGlobalMouseUp);\n      document.addEventListener('mousemove', handleGlobalMouseMove);\n      \n      return () => {\n        document.removeEventListener('mouseup', handleGlobalMouseUp);\n        document.removeEventListener('mousemove', handleGlobalMouseMove);\n      };\n    }\n  }, [isDragging, dragAnnotationId, dragStartY, dragStartPrice, isDraggingText, dragTextAnnotationId, dragTextStartX, dragTextStartY, dragStartOffset, dragStartVerticalOffset, isDraggingVertical, dragVerticalAnnotationId, dragVerticalStartX, dragVerticalStartTimestamp, updateAnnotations, chartData]);\n  \n  // Earnings modal state\n  const [earningsModal, setEarningsModal] = useState<{\n    visible: boolean;\n    data: any;\n  }>({ visible: false, data: null });\n\n  // Earnings data state\n  const { data: earningsData } = useQuery({\n    queryKey: ['/api/stocks', symbol, 'earnings'],\n    queryFn: async (): Promise<{ symbol: string; earnings: any[] }> => {\n      const response = await fetch(`/api/stocks/${symbol}/earnings`);\n      if (!response.ok) throw new Error('Failed to fetch earnings data');\n      return await response.json();\n    },\n    enabled: !!symbol\n  });\n\n\n  // Ticker search API query (Task 2)\n  const { data: tickerSearchResults = [] } = useQuery({\n    queryKey: ['ticker-search', debouncedTickerQuery],\n    queryFn: async (): Promise<Array<{ symbol: string; name: string; price: string; percentChange: string; marketCap: string }>> => {\n      if (!debouncedTickerQuery.trim()) return [];\n      const response = await fetch(`/api/stocks/global-search?q=${encodeURIComponent(debouncedTickerQuery)}`);\n      if (!response.ok) return [];\n      return await response.json();\n    },\n    enabled: showTickerSearch && debouncedTickerQuery.trim().length >= 2,\n    staleTime: 2 * 60 * 1000, // Cache for 2 minutes\n  });\n\n  // Fetch chart data for comparison tickers (Task 4)\n  const comparisonTickerQueries = useQueries({\n    queries: comparisonTickers.map(ticker => ({\n      queryKey: ['/api/stocks', ticker.symbol, 'chart', selectedTimeframe, startDate?.toISOString(), endDate?.toISOString(), singleTradingDay],\n      queryFn: async () => {\n        let url = `/api/stocks/${ticker.symbol}/chart?timeframe=${selectedTimeframe}`;\n        \n        // Add custom date range parameters for Custom timeframe\n        if (selectedTimeframe === 'Custom' && startDate && endDate) {\n          let fromTimestamp: number;\n          let toTimestamp: number;\n          \n          if (singleTradingDay || startDate.toDateString() === endDate.toDateString()) {\n            // Single trading day\n            const tradingDay = startDate;\n            const dayStart = new Date(tradingDay.getFullYear(), tradingDay.getMonth(), tradingDay.getDate(), 0, 0, 0, 0);\n            const dayEnd = new Date(tradingDay.getFullYear(), tradingDay.getMonth(), tradingDay.getDate(), 23, 59, 59, 999);\n            fromTimestamp = Math.floor(dayStart.getTime() / 1000);\n            toTimestamp = Math.floor(dayEnd.getTime() / 1000);\n          } else {\n            // Date range\n            fromTimestamp = Math.floor(startDate.getTime() / 1000);\n            toTimestamp = Math.floor(endDate.getTime() / 1000);\n          }\n          \n          url = `/api/stocks/${ticker.symbol}/chart?from=${fromTimestamp}&to=${toTimestamp}&timeframe=Custom`;\n        }\n        \n        const response = await fetch(url);\n        if (!response.ok) {\n          throw new Error(`Failed to fetch chart data for ${ticker.symbol}`);\n        }\n        \n        const data = await response.json();\n        \n        // Ensure valid data structure\n        if (!data || !data.data) {\n          throw new Error('Invalid response format');\n        }\n        \n        return {\n          symbol: ticker.symbol,\n          data: data.data as ChartData[],\n          color: ticker.color\n        };\n      },\n      enabled: !!ticker.symbol,\n      staleTime: 0,\n      gcTime: 2 * 60 * 1000,\n    }))\n  });\n\n  // Chart data query moved above to fix initialization order\n\n  // Fetch chart history (all tickers - user can see their entire history)\n  const { data: chartHistory = [] } = useQuery<ChartHistory[]>({\n    queryKey: ['/api/chart-history'],\n    queryFn: async () => {\n      const response = await fetch('/api/chart-history', {\n        headers: {\n          'Authorization': `Bearer ${localStorage.getItem('authToken')}`\n        }\n      });\n      if (!response.ok) throw new Error('Failed to fetch chart history');\n      return await response.json();\n    },\n  });\n\n  // Function to restore chart state from history\n  const restoreFromHistory = (entry: ChartHistory) => {\n    // If ticker is different and parent provided a callback, let parent handle ticker switching\n    if (entry.symbol !== symbol && onHistorySelect) {\n      onHistorySelect(entry);\n      return;\n    }\n    \n    // Set timeframe\n    setSelectedTimeframe(entry.timeframe);\n    \n    // Set custom dates if applicable\n    if (entry.timeframe === 'Custom' && entry.customStartDate && entry.customEndDate) {\n      setStartDate(new Date(entry.customStartDate));\n      setEndDate(new Date(entry.customEndDate));\n    } else {\n      setStartDate(undefined);\n      setEndDate(undefined);\n    }\n    \n    // Set CSV overlay\n    setCsvOverlay(entry.csvOverlay || []);\n    \n    // Set annotations\n    updateAnnotations(entry.annotations as Annotation[] || []);\n    \n    // Show toast to confirm restoration\n    toast({\n      title: \"Chart Restored\",\n      description: `Loaded chart state from ${format(new Date(entry.savedAt), 'MMM dd, yyyy HH:mm')}`,\n    });\n  };\n  \n  // Effect to handle pending history restoration after ticker change\n  useEffect(() => {\n    if (pendingHistoryRestore && \n        pendingHistoryRestore.symbol === symbol && \n        chartData?.data && \n        chartData.data.length > 0 &&\n        !isLoading) {\n      // Data is ready, restore the chart state\n      setSelectedTimeframe(pendingHistoryRestore.timeframe);\n      \n      if (pendingHistoryRestore.timeframe === 'Custom' && \n          pendingHistoryRestore.customStartDate && \n          pendingHistoryRestore.customEndDate) {\n        setStartDate(new Date(pendingHistoryRestore.customStartDate));\n        setEndDate(new Date(pendingHistoryRestore.customEndDate));\n      } else {\n        setStartDate(undefined);\n        setEndDate(undefined);\n      }\n      \n      setCsvOverlay(pendingHistoryRestore.csvOverlay || []);\n      updateAnnotations(pendingHistoryRestore.annotations as Annotation[] || []);\n      \n      toast({\n        title: \"Chart Restored\",\n        description: `Loaded ${pendingHistoryRestore.symbol} from ${format(new Date(pendingHistoryRestore.savedAt), 'MMM dd, yyyy HH:mm')}`,\n      });\n      \n      // Notify parent that restoration is complete\n      if (onHistoryRestoreComplete) {\n        onHistoryRestoreComplete();\n      }\n    }\n  }, [pendingHistoryRestore, symbol, chartData, isLoading, onHistoryRestoreComplete, toast, updateAnnotations]);\n\n  // Currency mapping for different markets\n  const getCurrencySymbol = (currencyCode: string | undefined): string => {\n    if (!currencyCode) return '$';\n    \n    const currencyMap: Record<string, string> = {\n      'USD': '$',\n      'JPY': '',\n      'EUR': '',\n      'GBP': '',\n      'CAD': 'C$',\n      'AUD': 'A$',\n      'CHF': 'CHF ',\n      'CNY': '',\n      'KRW': '',\n      'HKD': 'HK$',\n      'SGD': 'S$',\n      'INR': '',\n      'BRL': 'R$',\n      'MXN': '$',\n      'SEK': 'kr',\n      'NOK': 'kr',\n      'DKK': 'kr',\n      'PLN': 'z',\n      'CZK': 'K',\n      'HUF': 'Ft',\n      'RUB': '',\n      'TRY': '',\n      'ZAR': 'R',\n      'ILS': '',\n      'THB': '',\n      'MYR': 'RM',\n      'PHP': '',\n      'IDR': 'Rp',\n      'VND': '',\n      'TWD': 'NT$'\n    };\n    \n    return currencyMap[currencyCode.toUpperCase()] || currencyCode.toUpperCase() + ' ';\n  };\n\n  const formatPrice = (value: number | undefined | null) => {\n    const currencySymbol = getCurrencySymbol((stockDetails?.profile as any)?.currency);\n    \n    // Handle undefined/null values\n    if (value === undefined || value === null || isNaN(value)) {\n      return `${currencySymbol}N/A`;\n    }\n    \n    // For JPY and similar currencies, don't show decimal places\n    if ((stockDetails?.profile as any)?.currency === 'JPY' || (stockDetails?.profile as any)?.currency === 'KRW') {\n      return `${currencySymbol}${Math.round(value).toLocaleString()}`;\n    }\n    \n    return `${currencySymbol}${value.toFixed(2)}`;\n  };\n\n  const formatMarketCap = (marketCapInMillions: number) => {\n    // Finnhub returns market cap in millions of local currency\n    const currencySymbol = getCurrencySymbol((stockDetails?.profile as any)?.currency);\n    if (marketCapInMillions >= 1000000) return `${currencySymbol}${(marketCapInMillions / 1000000).toFixed(1)}T`;\n    if (marketCapInMillions >= 1000) return `${currencySymbol}${(marketCapInMillions / 1000).toFixed(1)}B`;\n    return `${currencySymbol}${marketCapInMillions.toFixed(1)}M`;\n  };\n\n  // Handle CSV submit\n  const handleCsvSubmit = () => {\n    try {\n      const textarea = document.getElementById('csv-textarea') as HTMLTextAreaElement;\n      let csvText = textarea?.value || '';\n      \n      if (!csvText.trim()) {\n        toast({ title: \"Error\", description: \"Please paste CSV data\", variant: \"destructive\" });\n        return;\n      }\n      \n      // Remove UTF-8 BOM if present\n      if (csvText.charCodeAt(0) === 0xFEFF) {\n        csvText = csvText.slice(1);\n      }\n      \n      const lines = csvText.trim().split('\\n');\n      const parsed: {timestamp: number, value: number}[] = [];\n      \n      // Check if first line is a header by looking for common header patterns\n      let startIndex = 0;\n      if (lines.length > 0) {\n        const firstLine = lines[0].trim();\n        const [firstCol] = firstLine.split(',');\n        const normalizedFirstCol = firstCol?.trim().toLowerCase();\n        \n        // Treat as header if it matches common header names (not a date)\n        if (normalizedFirstCol && \n            (normalizedFirstCol === 'date' || \n             normalizedFirstCol === 'time' || \n             normalizedFirstCol === 'timestamp' ||\n             normalizedFirstCol.startsWith('date') ||\n             normalizedFirstCol.startsWith('time'))) {\n          startIndex = 1;\n        }\n      }\n      \n      for (let i = startIndex; i < lines.length; i++) {\n        const line = lines[i].trim();\n        if (!line) continue;\n        \n        const [dateStr, valueStr] = line.split(',');\n        \n        // Validate date format (YYYY-MM-DD)\n        if (!/^\\d{4}-\\d{2}-\\d{2}$/.test(dateStr?.trim())) {\n          toast({ \n            title: \"Error\", \n            description: `Invalid date format on line ${i+1}. Expected YYYY-MM-DD`,\n            variant: \"destructive\" \n          });\n          return;\n        }\n        \n        const value = parseFloat(valueStr?.trim());\n        if (isNaN(value) || value < 0 || value > 1) {\n          toast({ \n            title: \"Error\", \n            description: `Invalid value on line ${i+1}. Must be between 0 and 1`,\n            variant: \"destructive\" \n          });\n          return;\n        }\n        \n        const timestamp = new Date(dateStr.trim()).getTime();\n        parsed.push({ timestamp, value });\n      }\n      \n      // Validate that we have at least one data point\n      if (parsed.length === 0) {\n        toast({ \n          title: \"Error\", \n          description: \"No valid data points found. Please check your CSV format.\",\n          variant: \"destructive\" \n        });\n        return;\n      }\n      \n      setCsvOverlay(parsed);\n      setShowCsvModal(false);\n      toast({ title: \"Success\", description: `Added overlay with ${parsed.length} data points` });\n    } catch (error) {\n      toast({ title: \"Error\", description: \"Failed to parse CSV\", variant: \"destructive\" });\n    }\n  };\n\n  // Handle CSV file upload\n  useEffect(() => {\n    const input = document.getElementById('csv-upload');\n    const handleFileChange = (e: Event) => {\n      const file = (e.target as HTMLInputElement).files?.[0];\n      if (!file) return;\n      \n      const reader = new FileReader();\n      reader.onload = (event) => {\n        const textarea = document.getElementById('csv-textarea') as HTMLTextAreaElement;\n        if (textarea) textarea.value = event.target?.result as string || '';\n      };\n      reader.readAsText(file);\n    };\n    \n    input?.addEventListener('change', handleFileChange);\n    return () => input?.removeEventListener('change', handleFileChange);\n  }, [showCsvModal]);\n\n  const formatRevenue = (revenueInMillions: number) => {\n    // Format revenue in millions with correct currency\n    const currencySymbol = getCurrencySymbol((stockDetails?.profile as any)?.currency);\n    return `${currencySymbol}${(revenueInMillions / 1000000).toFixed(1)}M`;\n  };\n\n  // Ticker Management Functions (Task 3)\n  const addComparisonTicker = (tickerSymbol: string, tickerName: string) => {\n    // Check if ticker already exists\n    if (comparisonTickers.some(t => t.symbol === tickerSymbol)) {\n      toast({\n        title: \"Ticker Already Added\",\n        description: `${tickerSymbol} is already in the comparison list`,\n        variant: \"destructive\",\n      });\n      return;\n    }\n\n    // Check if limit reached\n    if (comparisonTickers.length >= MAX_COMPARISON_TICKERS) {\n      toast({\n        title: \"Limit Reached\",\n        description: `Maximum ${MAX_COMPARISON_TICKERS} comparison tickers allowed`,\n        variant: \"destructive\",\n      });\n      return;\n    }\n\n    // Assign next color from palette\n    const nextColor = COMPARISON_COLORS[comparisonTickers.length % COMPARISON_COLORS.length];\n\n    // Add to array\n    setComparisonTickers(prev => [...prev, {\n      symbol: tickerSymbol,\n      name: tickerName,\n      color: nextColor,\n    }]);\n\n    // Close search UI and reset query\n    setShowTickerSearch(false);\n    setTickerSearchQuery('');\n\n    // Show success toast\n    toast({\n      title: \"Ticker Added\",\n      description: `${tickerSymbol} (${tickerName}) added to comparison`,\n    });\n  };\n\n  const removeComparisonTicker = (tickerSymbol: string) => {\n    setComparisonTickers(prev => prev.filter(t => t.symbol !== tickerSymbol));\n    toast({\n      title: \"Ticker Removed\",\n      description: `${tickerSymbol} removed from comparison`,\n    });\n  };\n\n  // Use stock details data if currentPrice is placeholder or invalid\n  const actualCurrentPrice = (currentPrice && currentPrice !== '--' && !isNaN(parseFloat(currentPrice))) \n    ? currentPrice \n    : stockDetails?.quote?.c?.toString() || '--';\n    \n  const actualPercentChange = (percentChange && percentChange !== '0' && percentChange !== '--') \n    ? percentChange \n    : stockDetails?.quote?.dp?.toString() || '0';\n    \n  const actualMarketCap = (marketCap && marketCap !== '--') \n    ? marketCap \n    : stockDetails?.profile?.marketCapitalization \n      ? formatMarketCap(stockDetails.profile.marketCapitalization) \n      : '--';\n  \n  const formatTime = (timeStr: string, timeframe: string) => {\n    const date = new Date(timeStr);\n    switch (timeframe) {\n      case '1D':\n        return date.toLocaleTimeString('en-US', { \n          hour: '2-digit', \n          minute: '2-digit',\n          hour12: false \n        });\n      case '5D':\n      case '2W':\n        // New format: 3/9/25 instead of Wed, Sep 3\n        return date.toLocaleDateString('en-US', { \n          month: 'numeric',\n          day: 'numeric',\n          year: '2-digit'\n        });\n      case '1M':\n      case '3M':\n        // Month view: 11/8/25 format\n        return date.toLocaleDateString('en-US', { \n          month: 'numeric',\n          day: 'numeric',\n          year: '2-digit'\n        });\n      case '1Y':\n        return date.toLocaleDateString('en-US', { \n          month: 'short',\n          year: '2-digit'\n        });\n      case 'Custom':\n        // For single trading day, show hours; for date ranges, show dates\n        if (singleTradingDay || (startDate && endDate && startDate.toDateString() === endDate.toDateString())) {\n          return date.toLocaleTimeString('en-US', { \n            hour: '2-digit', \n            minute: '2-digit',\n            hour12: false \n          });\n        } else {\n          // For custom ranges, use the compact format\n          return date.toLocaleDateString('en-US', { \n            month: 'numeric',\n            day: 'numeric',\n            year: '2-digit'\n          });\n        }\n      default:\n        return date.toLocaleDateString();\n    }\n  };\n\n  // Calculate timeframe-based percentage change instead of daily change\n  const calculateTimeframeChange = () => {\n    if (!chartData?.data || chartData.data.length === 0) {\n      // Fallback to daily change if no chart data\n      const parseChange = parseFloat(actualPercentChange);\n      return parseChange;\n    }\n    \n    // Get first and last prices from the timeframe period\n    const firstPrice = chartData.data[0]?.close;\n    const lastPrice = chartData.data[chartData.data.length - 1]?.close;\n    \n    if (!firstPrice || !lastPrice || firstPrice === 0) {\n      // Fallback to daily change if prices are invalid\n      const parseChange = parseFloat(actualPercentChange);\n      return parseChange;\n    }\n    \n    // Calculate percentage change over the entire timeframe period\n    return ((lastPrice - firstPrice) / firstPrice) * 100;\n  };\n\n  const timeframePercentChange = calculateTimeframeChange();\n  const isPositive = timeframePercentChange >= 0;\n  const lineColor = isPositive ? '#5AF5FA' : '#FFA5FF'; // Cyan for positive, Pink for negative\n  \n  // Calculate moving average for volume (20-period moving average)\n  const calculateMovingAverage = (data: any[], period: number = 20) => {\n    return data.map((item, index) => {\n      if (index < period - 1) {\n        // For early data points, use available data\n        const availableData = data.slice(0, index + 1);\n        const sum = availableData.reduce((acc, curr) => acc + (curr.volume || 0), 0);\n        return sum / availableData.length;\n      } else {\n        // Calculate moving average for the period\n        const slice = data.slice(index - period + 1, index + 1);\n        const sum = slice.reduce((acc, curr) => acc + (curr.volume || 0), 0);\n        return sum / period;\n      }\n    });\n  };\n\n  // Calculate percentage change for each data point relative to first price and add volume moving average\n  const chartDataWithPercentage = chartData?.data?.map((item, index) => {\n    const firstPrice = chartData.data[0]?.close || item.close;\n    const percentageChange = ((item.close - firstPrice) / firstPrice) * 100;\n    return { ...item, percentageChange };\n  }) || [];\n\n  // Add volume moving averages to the data\n  const volumeMovingAverages = chartData?.data ? calculateMovingAverage(chartData.data) : [];\n  const chartDataWithMA = chartDataWithPercentage.map((item, index) => ({\n    ...item,\n    volumeMA: volumeMovingAverages[index] || 0\n  }));\n\n  // Merge CSV overlay data into chart data\n  const chartDataWithOverlay = useMemo(() => {\n    if (!chartDataWithMA || csvOverlay.length === 0) {\n      return chartDataWithMA;\n    }\n    \n    return chartDataWithMA.map(point => {\n      // Both chart and CSV timestamps are in milliseconds\n      const match = csvOverlay.find(overlay => {\n        const diff = Math.abs(overlay.timestamp - point.timestamp);\n        const oneDayMs = 86400000; // 1 day in milliseconds\n        return diff < oneDayMs;\n      });\n      \n      return {\n        ...point,\n        csvOverlay: match ? match.value * 100 : null // Convert 0-1 to 0-100%\n      };\n    });\n  }, [chartDataWithMA, csvOverlay]);\n\n  // Merge comparison ticker data into chart (Task 7 - data processing)\n  const chartDataWithComparisons = useMemo(() => {\n    if (!chartDataWithOverlay || comparisonTickers.length === 0) {\n      return chartDataWithOverlay;\n    }\n\n    // Process each comparison ticker data\n    return chartDataWithOverlay.map(point => {\n      const result: any = { ...point };\n\n      // Add normalized data for each comparison ticker\n      comparisonTickerQueries.forEach((query, index) => {\n        const ticker = comparisonTickers[index];\n        if (!ticker || !query.data) return;\n\n        const tickerData = query.data as { symbol: string; data: ChartData[]; color: string };\n        if (!tickerData.data || tickerData.data.length === 0) return;\n\n        // Find matching data point by date (for cross-resolution matching: hourly vs daily)\n        // First try exact timestamp match, then fall back to same-day matching\n        const pointTimestamp = point.timestamp * (point.timestamp < 10000000000 ? 1000 : 1);\n        const pointDate = new Date(pointTimestamp);\n        const pointDateStr = pointDate.toISOString().split('T')[0]; // YYYY-MM-DD\n        \n        let match = tickerData.data.find((d: ChartData) => {\n          const dataTimestamp = d.timestamp * (d.timestamp < 10000000000 ? 1000 : 1);\n          const diff = Math.abs(dataTimestamp - pointTimestamp);\n          return diff < 300000; // 5 minutes tolerance for same-resolution data\n        });\n        \n        // Fallback: same-day matching for cross-resolution data (e.g., hourly vs daily)\n        if (!match) {\n          match = tickerData.data.find((d: ChartData) => {\n            const dataTimestamp = d.timestamp * (d.timestamp < 10000000000 ? 1000 : 1);\n            const dataDate = new Date(dataTimestamp);\n            const dataDateStr = dataDate.toISOString().split('T')[0];\n            return dataDateStr === pointDateStr;\n          });\n        }\n\n        if (match) {\n          // Normalize to first price point for percentage-based comparison\n          const firstPrice = tickerData.data[0].close;\n          if (firstPrice && firstPrice > 0) {\n            const normalizedValue = ((match.close - firstPrice) / firstPrice) * 100;\n            result[`comparison_${ticker.symbol}`] = normalizedValue;\n          }\n        }\n      });\n\n      return result;\n    });\n  }, [chartDataWithOverlay, comparisonTickers, comparisonTickerQueries]);\n\n  // Pre-compute combined percentage domain for comparison mode overlay axis\n  // This ensures the axis has a concrete domain on first render (not ['dataMin', 'dataMax'])\n  const comparisonPercentageDomain = useMemo(() => {\n    if (comparisonTickers.length === 0 || !chartDataWithComparisons) {\n      return null;\n    }\n    \n    const allPercentages: number[] = [];\n    chartDataWithComparisons.forEach((point: any) => {\n      // Include main ticker percentage\n      if (point.percentageChange !== undefined) {\n        allPercentages.push(point.percentageChange);\n      }\n      // Include all comparison ticker percentages\n      comparisonTickers.forEach(ticker => {\n        const val = point[`comparison_${ticker.symbol}`];\n        if (val !== undefined && val !== null) {\n          allPercentages.push(val);\n        }\n      });\n    });\n    \n    if (allPercentages.length === 0) {\n      return null;\n    }\n    \n    const minPct = Math.min(...allPercentages);\n    const maxPct = Math.max(...allPercentages);\n    const padding = (maxPct - minPct) * 0.1 || 5;\n    return [minPct - padding, maxPct + padding] as [number, number];\n  }, [chartDataWithComparisons, comparisonTickers]);\n\n  // Calculate current price data extremes for zoom functionality\n  const priceExtremes = useMemo(() => {\n    if (!chartDataWithMA || chartDataWithMA.length === 0) {\n      return { min: 0, max: 100, baseRange: 100, center: 50 };\n    }\n\n    const prices = chartDataWithMA.map(d => d.close).filter(p => p != null);\n    if (prices.length === 0) {\n      return { min: 0, max: 100, baseRange: 100, center: 50 };\n    }\n\n    const min = Math.min(...prices);\n    const max = Math.max(...prices);\n    const baseRange = max - min || 1; // Prevent division by zero\n    const center = (min + max) / 2;\n    \n    return { min, max, baseRange, center };\n  }, [chartDataWithMA]);\n\n  // Unified zoom control functions that work for both charts\n  const zoomInPrice = () => {\n    if (activeTab === 'comparison' && comparisonZoomInRef.current) {\n      comparisonZoomInRef.current();\n    } else {\n      const currentIndex = priceZoomLevels.findIndex(level => level >= (priceAxisRange / priceExtremes.baseRange));\n      const nextIndex = Math.max(0, currentIndex - 1);\n      setPriceAxisRange(priceZoomLevels[nextIndex] * priceExtremes.baseRange);\n      setPriceAxisMode('fixed');\n    }\n  };\n\n  const zoomOutPrice = () => {\n    if (activeTab === 'comparison' && comparisonZoomOutRef.current) {\n      comparisonZoomOutRef.current();\n    } else {\n      const currentIndex = priceZoomLevels.findIndex(level => level >= (priceAxisRange / priceExtremes.baseRange));\n      const nextIndex = Math.min(priceZoomLevels.length - 1, currentIndex + 1);\n      setPriceAxisRange(priceZoomLevels[nextIndex] * priceExtremes.baseRange);\n      setPriceAxisMode('fixed');\n    }\n  };\n\n  const fitPriceToData = () => {\n    if (activeTab === 'comparison' && comparisonFitToDataRef.current) {\n      comparisonFitToDataRef.current();\n    } else {\n      setPriceAxisMode('auto');\n    }\n  };\n\n  // Get current price Y-axis domain based on zoom state and display mode\n  const getPriceAxisDomain = (): any => {\n    if (yAxisDisplayMode === 'percentage') {\n      // For percentage mode, use dataMin/dataMax of percentage changes\n      if (priceAxisMode === 'auto') {\n        return ['dataMin - 0.5', 'dataMax + 0.5'];\n      } else {\n        // For fixed mode in percentage, calculate based on current percentage range\n        const halfRange = priceAxisRange / 2;\n        return [-halfRange, halfRange];\n      }\n    } else {\n      // Original price mode logic\n      if (priceAxisMode === 'auto') {\n        return ['dataMin - 1', 'dataMax + 1'];\n      } else {\n        const halfRange = priceAxisRange / 2;\n        const center = priceExtremes.center;\n        return [center - halfRange, center + halfRange];\n      }\n    }\n  };\n\n  // Handle Y-axis click to toggle between price and percentage view\n  const handleYAxisClick = () => {\n    setYAxisDisplayMode(prev => prev === 'price' ? 'percentage' : 'price');\n  };\n\n  const formatNumber = (num: number) => {\n    if (num >= 1e12) return `${(num / 1e12).toFixed(2)}T`;\n    if (num >= 1e9) return `${(num / 1e9).toFixed(2)}B`;\n    if (num >= 1e6) return `${(num / 1e6).toFixed(2)}M`;\n    if (num >= 1e3) return `${(num / 1e3).toFixed(2)}K`;\n    return num?.toLocaleString() || 'N/A';\n  };\n\n  // Handle chart click for annotations\n  const handleChartClick = (event: any) => {\n    if (!event || !chartDataWithMA) return;\n    \n    // For horizontal and note annotations, we handle ANY click on the chart (even without activePayload)\n    if (annotationMode === 'horizontal' || annotationMode === 'note') {\n      // Freehand placement\n      if (event.chartY !== undefined && event.chartX !== undefined) {\n        // We'll calculate the price from the click Y position\n        // For timestamp, we'll use the current time or middle of the chart data\n        const middleIndex = Math.floor(chartDataWithMA.length / 2);\n        const timestamp = chartDataWithMA[middleIndex]?.timestamp || Date.now();\n        const time = chartDataWithMA[middleIndex]?.time || new Date().toISOString();\n        \n        // Calculate price from Y coordinate\n        let calculatedPrice = 0;\n        \n        // Get price range from chart data\n        if (chartDataWithMA.length > 0) {\n          const prices = chartDataWithMA.map(d => d.close).filter(p => p != null);\n          const minPrice = Math.min(...prices);\n          const maxPrice = Math.max(...prices);\n          \n          // Add 5% padding to match YAxis domain calculation\n          const range = maxPrice - minPrice;\n          const padding = range * 0.05;\n          const yAxisMin = minPrice - padding;\n          const yAxisMax = maxPrice + padding;\n          \n          // Use a more reliable chart coordinate calculation\n          // event.chartY is relative to the chart plotting area, not the full container\n          // We can use this directly with a reasonable height assumption\n          \n          // For Recharts, event.chartY typically ranges from 0 (top) to chart height (bottom)\n          // We'll assume a standard chart height and calculate accordingly\n          const assumedChartHeight = 400; // Reasonable assumption for most chart configurations\n          \n          // Calculate relative position (0 = top, 1 = bottom)\n          const relativeY = Math.max(0, Math.min(1, event.chartY / assumedChartHeight));\n          \n          // Convert to price (Y axis is inverted - top is max price, bottom is min price)\n          calculatedPrice = yAxisMax - (relativeY * (yAxisMax - yAxisMin));\n          \n          // Ensure price is within reasonable bounds\n          calculatedPrice = Math.max(yAxisMin, Math.min(yAxisMax, calculatedPrice));\n          \n        }\n        \n        // Create annotation\n        const newAnnotation: Omit<Annotation, 'id' | 'text'> = {\n          type: annotationMode === 'horizontal' ? 'horizontal' : 'note',\n          x: 0,\n          y: 0,  \n          timestamp,\n          price: calculatedPrice,\n          time\n        };\n        \n        // Ensure clean state before setting new annotation\n        setEditingAnnotation(null);\n        setIsEditMode(false);\n        setAnnotationInput('');\n        // Pre-fill the price input with the clicked position (can be edited)\n        if (annotationMode === 'horizontal') {\n          setHorizontalPriceInput(calculatedPrice.toFixed(2));\n        }\n        setPendingAnnotation(newAnnotation);\n        setShowAnnotationInput(true);\n        return; // Exit early for horizontal and note annotations\n      }\n    }\n    \n    // For other annotation types, require activePayload (clicking on data points)\n    const { activePayload, activeLabel } = event;\n    \n    if (activePayload && activePayload.length > 0 && activeLabel) {\n      const clickedData = activePayload[0].payload;\n      const timestamp = clickedData.timestamp;\n      const price = clickedData.close;\n      const time = clickedData.time;\n      \n      if (annotationMode === 'text') {\n        // Text annotation mode - single click\n        const newAnnotation: Omit<Annotation, 'id' | 'text'> = {\n          type: 'text',\n          x: 0, // Will be set by chart rendering\n          y: 0, // Will be set by chart rendering  \n          timestamp,\n          price,\n          time\n        };\n        \n        // Ensure clean state before setting new annotation\n        setEditingAnnotation(null);\n        setIsEditMode(false);\n        setAnnotationInput('');\n        setPendingAnnotation(newAnnotation);\n        setShowAnnotationInput(true);\n      } else if (annotationMode === 'horizontal') {\n        // This case is now handled earlier in the function for freehand placement\n        // This code path should not be reached for horizontal annotations\n        return;\n      } else if (annotationMode === 'percentage') {\n        // Percentage measurement mode - two clicks\n        if (!pendingPercentageStart) {\n          // First click - set start point\n          setPendingPercentageStart({\n            timestamp,\n            price,\n            time\n          });\n        } else {\n          // Second click - create percentage measurement\n          const startPrice = pendingPercentageStart.price;\n          const endPrice = price;\n          const percentage = ((endPrice - startPrice) / startPrice) * 100;\n          \n          const newAnnotation: Annotation = {\n            id: `percentage-${Date.now()}`,\n            type: 'percentage',\n            x: 0,\n            y: 0,\n            timestamp: pendingPercentageStart.timestamp, // Use start timestamp as primary\n            price: startPrice,\n            time: pendingPercentageStart.time,\n            startTimestamp: pendingPercentageStart.timestamp,\n            startPrice,\n            startTime: pendingPercentageStart.time,\n            endTimestamp: timestamp,\n            endPrice,\n            endTime: time,\n            percentage\n          };\n          \n          updateAnnotations(prev => [...prev, newAnnotation]);\n          setPendingPercentageStart(null);\n        }\n      }\n    }\n  };\n\n  // Handle annotation double-click for editing or deletion\n  const handleAnnotationDoubleClick = (annotation: Annotation) => {\n    if (annotation.type === 'text' || annotation.type === 'horizontal' || annotation.type === 'note') {\n      setEditingAnnotation(annotation);\n      setIsEditMode(true);\n      setAnnotationInput(annotation.text || '');\n      if (annotation.type === 'horizontal') {\n        setHorizontalPriceInput(annotation.price?.toString() || '');\n      }\n      setShowAnnotationInput(true);\n    } else if (annotation.type === 'percentage') {\n      // Percentage annotations can be deleted on double-click\n      handlePercentageAnnotationDelete(annotation);\n    }\n  };\n\n  // Delete percentage annotation\n  const handlePercentageAnnotationDelete = (annotation: Annotation) => {\n    updateAnnotations(prev => prev.filter(a => a.id !== annotation.id));\n  };\n\n  // Save annotation with user text\n  const saveAnnotation = () => {\n    if (isEditMode && editingAnnotation) {\n      // Update existing annotation\n      if (editingAnnotation.type === 'horizontal') {\n        // For horizontal annotations, update both price and text\n        const newPrice = parseFloat(horizontalPriceInput);\n        if (!isNaN(newPrice)) {\n          updateAnnotations(prev => prev.map(annotation => \n            annotation.id === editingAnnotation.id \n              ? { ...annotation, price: newPrice, text: annotationInput.trim() }\n              : annotation\n          ));\n        }\n      } else if (annotationInput.trim()) {\n        updateAnnotations(prev => prev.map(annotation => \n          annotation.id === editingAnnotation.id \n            ? { ...annotation, text: annotationInput.trim() }\n            : annotation\n        ));\n      }\n      setShowAnnotationInput(false);\n      setAnnotationInput('');\n      setHorizontalPriceInput('');\n      setEditingAnnotation(null);\n      setIsEditMode(false);\n    } else if (pendingAnnotation) {\n      // Create new annotation\n      if (pendingAnnotation.type === 'horizontal') {\n        // For horizontal annotations, use the entered price value\n        const newPrice = parseFloat(horizontalPriceInput);\n        if (!isNaN(newPrice)) {\n          const newAnnotation: Annotation = {\n            ...pendingAnnotation,\n            id: `annotation-${Date.now()}`,\n            price: newPrice,\n            text: annotationInput.trim() || ''\n          };\n          updateAnnotations(prev => [...prev, newAnnotation]);\n        }\n      } else if (annotationInput.trim()) {\n        const newAnnotation: Annotation = {\n          ...pendingAnnotation,\n          id: `annotation-${Date.now()}`,\n          text: annotationInput.trim()\n        };\n        updateAnnotations(prev => [...prev, newAnnotation]);\n      }\n      setShowAnnotationInput(false);\n      setAnnotationInput('');\n      setHorizontalPriceInput('');\n      setPendingAnnotation(null);\n    }\n  };\n\n  // Delete annotation\n  const deleteAnnotation = () => {\n    if (editingAnnotation) {\n      updateAnnotations(prev => prev.filter(annotation => annotation.id !== editingAnnotation.id));\n      setShowAnnotationInput(false);\n      setAnnotationInput('');\n      setEditingAnnotation(null);\n      setIsEditMode(false);\n    }\n  };\n\n  // Cancel annotation\n  const cancelAnnotation = () => {\n    setShowAnnotationInput(false);\n    setAnnotationInput('');\n    setHorizontalPriceInput('');\n    setPendingAnnotation(null);\n    setEditingAnnotation(null);\n    setIsEditMode(false);\n  };\n\n  const formatPercent = (value: number) => {\n    return value ? `${(value * 100).toFixed(2)}%` : 'N/A';\n  };\n\n  // Export functions - Using html-to-image for pixel-perfect captures\n  const exportAsPNG = async () => {\n    try {\n      if (!chartRef.current) {\n        toast({\n          title: \"Export Failed\",\n          description: \"Chart not found. Please try again.\",\n          variant: \"destructive\"\n        });\n        return;\n      }\n      \n      // Create high-resolution PNG using html-to-image (captures exactly what's rendered)\n      const dataUrl = await htmlToImage.toPng(chartRef.current, {\n        quality: 1.0,\n        pixelRatio: 2, // High resolution\n        backgroundColor: 'transparent', // Transparent background for PNG\n        cacheBust: true, // Prevent caching issues\n        skipFonts: true, // Skip external font loading to avoid CORS issues\n        style: {\n          transform: 'scale(1)'\n        },\n        filter: (node) => {\n          // Exclude any UI elements that shouldn't be in export\n          return !node.classList?.contains('no-export');\n        }\n      });\n      \n      // Download the image\n      const filename = `${symbol}_chart_${selectedTimeframe}${startDate && endDate ? `_${format(startDate, 'yyyy-MM-dd')}_${format(endDate, 'yyyy-MM-dd')}` : ''}.png`;\n      \n      const link = document.createElement('a');\n      link.download = filename;\n      link.href = dataUrl;\n      document.body.appendChild(link);\n      link.click();\n      document.body.removeChild(link);\n      \n      toast({\n        title: \"Export Successful\",\n        description: `Chart exported as ${filename}`\n      });\n      \n    } catch (error) {\n      console.error('PNG export failed:', error);\n      toast({\n        title: \"Export Failed\",\n        description: \"PNG export failed. Please try again.\",\n        variant: \"destructive\"\n      });\n    }\n  };\n\n  const exportAsPDF = async () => {\n    if (!chartRef.current) return;\n    try {\n      const dataUrl = await htmlToImage.toPng(chartRef.current, {\n        pixelRatio: 3,\n        cacheBust: true,\n        backgroundColor: '#121212',\n        skipFonts: true,\n        style: { \n          transform: 'scale(1)',\n          paddingBottom: '20px'\n        },\n        filter: (n) => !n.classList?.contains('no-export'),\n      });\n      const img = new Image();\n      img.src = dataUrl;\n      await (img.decode ? img.decode() : new Promise(r => (img.onload = () => r(null))));\n      const orientation = img.width >= img.height ? 'landscape' : 'portrait';\n      const pdf = new jsPDF({ orientation, unit: 'px', format: [img.width, img.height] });\n      pdf.addImage(dataUrl, 'PNG', 0, 0, img.width, img.height, undefined, 'FAST');\n      const filename = `${symbol}_chart_${selectedTimeframe}${startDate && endDate ? `_${format(startDate,'yyyy-MM-dd')}_${format(endDate,'yyyy-MM-dd')}` : ''}.pdf`;\n      pdf.save(filename);\n      toast({ title: 'Export Successful', description: `Chart exported as ${filename}` });\n    } catch (err) {\n      console.error('PDF export failed:', err);\n      toast({ title: 'Export Failed', description: 'PDF export failed. Please try again.', variant: 'destructive' });\n    }\n  };\n\n  const exportAsSVG = async () => {\n    if (!chartRef.current) return;\n    try {\n      const svgDataUrl = await htmlToImage.toSvg(chartRef.current, {\n        cacheBust: true,\n        backgroundColor: '#ffffff',\n        filter: (n) => !n.classList?.contains('no-export'),\n      });\n      \n      // Convert data URL to proper blob\n      const blob = await (await fetch(svgDataUrl)).blob();\n      const filename = `${symbol}_chart_${selectedTimeframe}${startDate && endDate ? `_${format(startDate,'yyyy-MM-dd')}_${format(endDate,'yyyy-MM-dd')}` : ''}.svg`;\n      \n      const url = URL.createObjectURL(blob);\n      const a = document.createElement('a');\n      a.href = url; \n      a.download = filename; \n      document.body.appendChild(a); \n      a.click();\n      document.body.removeChild(a); \n      URL.revokeObjectURL(url);\n      \n      toast({ title: 'Export Successful', description: `Chart exported as ${filename}` });\n    } catch (e) {\n      console.error('SVG export failed:', e);\n      toast({ title: 'SVG Export Failed', description: 'SVG export failed. Please try again.', variant: 'destructive' });\n    }\n  };\n\n  const exportAsCode = async () => {\n    if (!chartRef.current) {\n      toast({\n        title: \"Export Failed\",\n        description: \"Chart not found. Please try again.\",\n        variant: \"destructive\"\n      });\n      return;\n    }\n\n    try {\n      // Generate SVG of the chart\n      const svgDataUrl = await htmlToImage.toSvg(chartRef.current, {\n        cacheBust: true,\n        backgroundColor: '#ffffff',\n        filter: (n) => !n.classList?.contains('no-export'),\n      });\n      \n      // Convert data URL to SVG string\n      const svgString = decodeURIComponent(svgDataUrl.split(',')[1]);\n      \n      // Create embeddable code with the SVG\n      const embedCode = `<!-- Intropic Chart Editor - ${symbol} ${selectedTimeframe} Chart -->\n<!-- Generated on ${new Date().toLocaleDateString()} -->\n<div class=\"intropic-chart-container\" style=\"width: 100%; max-width: 800px; margin: 0 auto;\">\n  ${svgString}\n</div>\n\n<!-- Alternative: Inline SVG with custom styling -->\n<div class=\"stock-chart-${symbol.toLowerCase()}\" style=\"\n  display: inline-block; \n  border: 1px solid #e2e8f0; \n  border-radius: 8px; \n  padding: 16px;\n  background: white;\n  box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);\n\">\n  ${svgString}\n  <div style=\"margin-top: 8px; text-align: center; font-size: 12px; color: #666;\">\n    Powered by Intropic Chart Editor\n  </div>\n</div>\n\n<!-- For WordPress/CMS: Base64 Encoded -->\n<img src=\"${svgDataUrl}\" alt=\"${symbol} ${selectedTimeframe} Chart\" style=\"max-width: 100%; height: auto;\" />`;\n\n      navigator.clipboard.writeText(embedCode).then(() => {\n        toast({\n          title: \"SVG Embed Code Copied!\",\n          description: \"Chart SVG code has been copied to your clipboard.\",\n        });\n      }).catch(() => {\n        // Fallback: download the code\n        const blob = new Blob([embedCode], { type: 'text/html' });\n        const url = URL.createObjectURL(blob);\n        const a = document.createElement('a');\n        a.href = url;\n        a.download = `${symbol}_${selectedTimeframe}_chart_embed.html`;\n        a.click();\n        URL.revokeObjectURL(url);\n        toast({\n          title: \"SVG Embed Code Downloaded\",\n          description: \"Chart SVG code has been downloaded as an HTML file.\",\n        });\n      });\n    } catch (error) {\n      console.error('Code export failed:', error);\n      toast({\n        title: \"Export Failed\",\n        description: \"Failed to generate embed code. Please try again.\",\n        variant: \"destructive\"\n      });\n    }\n  };\n\n  // Comparison chart export functions\n\n  const exportComparisonAsCSV = () => {\n    // Get the comparison chart data from the comparison chart component\n    // This will trigger a CSV export by dispatching a custom event\n    const comparisonChart = document.querySelector('[data-testid=\"comparison-chart-container\"]');\n    if (comparisonChart) {\n      // Dispatch a custom event to trigger CSV export in the comparison chart\n      const event = new CustomEvent('exportCSV');\n      comparisonChart.dispatchEvent(event);\n    } else {\n      alert('Comparison chart not found. Please ensure the comparison chart is visible.');\n    }\n  };\n\n  const exportComparisonAsPNG = () => {\n    // Get the comparison chart and trigger PNG export\n    const comparisonChart = document.querySelector('[data-testid=\"comparison-chart-container\"]');\n    if (comparisonChart) {\n      // Dispatch a custom event to trigger PNG export in the comparison chart\n      const event = new CustomEvent('exportPNG');\n      comparisonChart.dispatchEvent(event);\n    } else {\n      alert('Comparison chart not found. Please ensure the comparison chart is visible.');\n    }\n  };\n\n  const exportComparisonAsPDF = () => {\n    // Get the comparison chart and trigger PDF export\n    const comparisonChart = document.querySelector('[data-testid=\"comparison-chart-container\"]');\n    if (comparisonChart) {\n      // Dispatch a custom event to trigger PDF export in the comparison chart\n      const event = new CustomEvent('exportPDF');\n      comparisonChart.dispatchEvent(event);\n    } else {\n      alert('Comparison chart not found. Please ensure the comparison chart is visible.');\n    }\n  };\n\n  const exportComparisonAsSVG = () => {\n    // Get the comparison chart and trigger SVG export\n    const comparisonChart = document.querySelector('[data-testid=\"comparison-chart-container\"]');\n    if (comparisonChart) {\n      // Dispatch a custom event to trigger SVG export in the comparison chart\n      const event = new CustomEvent('exportSVG');\n      comparisonChart.dispatchEvent(event);\n    } else {\n      alert('Comparison chart not found. Please ensure the comparison chart is visible.');\n    }\n  };\n\n  const exportComparisonAsCode = () => {\n    // Get the comparison chart and trigger SVG code export\n    const comparisonChart = document.querySelector('[data-testid=\"comparison-chart-container\"]');\n    if (comparisonChart) {\n      // Dispatch a custom event to trigger SVG code export in the comparison chart\n      const event = new CustomEvent('exportCode');\n      comparisonChart.dispatchEvent(event);\n    } else {\n      toast({\n        title: \"Export Failed\",\n        description: \"Comparison chart not found. Please ensure the comparison chart is visible.\",\n        variant: \"destructive\"\n      });\n    }\n  };\n\n\n  // Handle chart click for annotations - implementation is in the main handleChartClick function above\n\n  // Main chart content\n  const chartContent = (\n    <div className=\"w-full space-y-6 overflow-x-hidden max-[900px]:space-y-4\">\n      {/* Header Section */}\n      <div className=\"space-y-4\">\n        <div className=\"flex flex-col max-[900px]:gap-3 min-[901px]:flex-row min-[901px]:items-start min-[901px]:justify-between\">\n          <div>\n            <div className=\"flex items-center gap-4 flex-wrap\">\n              <div className=\"space-y-1\">\n                <div className=\"flex items-center gap-2 flex-wrap\">\n                  <span className=\"text-[#5AF5FA] text-xl font-medium\">{symbol}</span>\n                  <span className=\"text-muted-foreground\">-</span>\n                  <span className=\"text-sm font-normal text-muted-foreground\">{name}</span>\n                </div>\n                {stockDetails?.profile && (\n                  <div className=\"text-xs text-muted-foreground\" style={{ fontSize: '14px' }}>\n                    {stockDetails.profile.exchange} - {stockDetails.profile.currency}\n                  </div>\n                )}\n              </div>\n              <div className=\"flex items-center gap-3 flex-wrap\">\n                <span className=\"text-2xl font-bold\">{actualCurrentPrice !== '--' ? formatPrice(parseFloat(actualCurrentPrice)) : '--'}</span>\n                <Badge \n                  variant=\"secondary\"\n                  className={`flex items-center gap-1 font-semibold text-[#121212] border-0 ${isPositive ? 'bg-[#5AF5FA]' : 'bg-[#FFA5FF]'}`}\n                >\n                  {isPositive ? <TrendingUp className=\"w-3 h-3\" /> : <TrendingDown className=\"w-3 h-3\" />}\n                  {isPositive ? \"+\" : \"\"}{Math.abs(timeframePercentChange).toFixed(2)}%\n                </Badge>\n                <span className=\"text-sm text-muted-foreground\">{actualMarketCap}</span>\n              </div>\n            </div>\n            \n          </div>\n          \n          \n          {/* Pending Percentage Indicator */}\n          {annotationMode === 'percentage' && pendingPercentageStart && (\n            <div className=\"text-xs text-muted-foreground bg-muted/50 px-2 py-1 rounded border\">\n              Click second point to measure\n            </div>\n          )}\n          \n        </div>\n        \n      </div>\n\n      {/* Tabs Wrapper - Encompasses entire chart section including controls and content */}\n      <Tabs value={activeTab} onValueChange={(value) => setActiveTab(value as 'price-volume' | 'comparison')} className=\"w-full\">\n        {/* Chart Controls: Timeframe, Chart Type, and Tabs (Mobile) */}\n        <div className=\"flex gap-4 items-center flex-wrap max-[900px]:gap-2 w-full mb-4\">\n          {/* Mobile View (< 760px): Timeframe Dropdown + Price/Compare Tabs */}\n          <div className=\"min-[760px]:hidden w-full flex gap-2 items-center\">\n            <Select \n              value={selectedTimeframe} \n              onValueChange={(value) => {\n                setSelectedTimeframe(value);\n                if (value !== 'Custom') {\n                  setStartDate(undefined);\n                  setEndDate(undefined);\n                  setShowDatePicker(false);\n                } else {\n                  setShowDatePicker(true);\n                }\n              }}\n            >\n              <SelectTrigger className=\"flex-1 h-9 text-sm\" data-testid=\"select-timeframe-mobile\">\n                <SelectValue placeholder=\"Select timeframe\" />\n              </SelectTrigger>\n              <SelectContent style={{ backgroundColor: '#1a1a1a' }}>\n                {timeframes.map((timeframe) => (\n                  <SelectItem \n                    key={timeframe.value} \n                    value={timeframe.value}\n                    className=\"cursor-pointer\"\n                  >\n                    {timeframe.label}\n                  </SelectItem>\n                ))}\n              </SelectContent>\n            </Select>\n            \n            {/* Mobile Price/Compare Tab Switcher */}\n            <TabsList className=\"h-9 bg-muted/50\">\n              <TabsTrigger \n                value=\"price-volume\" \n                className=\"h-8 px-3 text-xs data-[state=active]:bg-[#5AF5FA] data-[state=active]:text-[#121212]\"\n                data-testid=\"tab-price-volume-mobile\"\n              >\n                Price\n              </TabsTrigger>\n              <TabsTrigger \n                value=\"comparison\" \n                className=\"h-8 px-3 text-xs data-[state=active]:bg-[#5AF5FA] data-[state=active]:text-[#121212]\"\n                data-testid=\"tab-comparison-mobile\"\n              >\n                Compare\n              </TabsTrigger>\n            </TabsList>\n          </div>\n          \n          {/* Desktop Buttons (760px+) */}\n          <div className=\"hidden min-[760px]:flex gap-1 items-center flex-wrap\">\n            {timeframes.map((timeframe) => (\n              <Button\n                key={timeframe.value}\n                variant={selectedTimeframe === timeframe.value ? \"default\" : \"outline\"}\n                size=\"sm\"\n                onClick={() => {\n                  setSelectedTimeframe(timeframe.value);\n                  if (timeframe.value !== 'Custom') {\n                    setStartDate(undefined);\n                    setEndDate(undefined);\n                    setShowDatePicker(false);\n                  } else {\n                    setShowDatePicker(true);\n                  }\n                }}\n                className={`h-8 px-3 text-xs ${\n                  selectedTimeframe === timeframe.value \n                    ? 'bg-[#5AF5FA] text-black hover:bg-[#5AF5FA]/90' \n                    : 'hover:bg-muted'\n                }`}\n              >\n                {timeframe.label}\n              </Button>\n            ))}\n          </div>\n\n          {/* Price/Compare Tab Switcher */}\n          <TabsList className=\"h-8 bg-muted/50\">\n            <TabsTrigger \n              value=\"price-volume\" \n              className=\"h-7 px-3 text-xs data-[state=active]:bg-[#5AF5FA] data-[state=active]:text-[#121212]\"\n              data-testid=\"tab-price-volume\"\n            >\n              Price\n            </TabsTrigger>\n            <TabsTrigger \n              value=\"comparison\" \n              className=\"h-7 px-3 text-xs data-[state=active]:bg-[#5AF5FA] data-[state=active]:text-[#121212]\"\n              data-testid=\"tab-comparison\"\n            >\n              Compare\n            </TabsTrigger>\n          </TabsList>\n\n          {/* Chart Type selector */}\n          <DropdownMenu>\n            <DropdownMenuTrigger asChild>\n              <Button\n                size=\"sm\"\n                variant=\"outline\"\n                className=\"h-8 px-3 text-xs\"\n                data-testid=\"button-chart-type-dropdown\"\n              >\n                {chartType === 'line' && 'Line'}\n                {chartType === 'mountain' && 'Mountain'}\n                {chartType === 'candlestick' && 'Candles'}\n                <ChevronDown className=\"w-3 h-3 ml-1\" style={{ color: '#5AF5FA' }} />\n              </Button>\n            </DropdownMenuTrigger>\n            <DropdownMenuContent align=\"start\">\n              <DropdownMenuItem\n                onClick={() => {\n                  setChartType('line');\n                }}\n                className=\"cursor-pointer\"\n                data-testid=\"menu-chart-line\"\n              >\n                Line\n              </DropdownMenuItem>\n              <DropdownMenuItem\n                onClick={() => {\n                  setChartType('mountain');\n                }}\n                className=\"cursor-pointer\"\n                data-testid=\"menu-chart-mountain\"\n              >\n                Mountain\n              </DropdownMenuItem>\n              <DropdownMenuItem\n                onClick={(e) => {\n                  // Guard against any trigger (mouse, keyboard, etc.) when in compare mode\n                  if (comparisonTickers.length > 0) {\n                    e.preventDefault();\n                    e.stopPropagation();\n                    return;\n                  }\n                  setChartType('candlestick');\n                }}\n                className={comparisonTickers.length > 0 ? \"cursor-not-allowed opacity-50\" : \"cursor-pointer\"}\n                disabled={comparisonTickers.length > 0}\n                data-testid=\"menu-chart-candles\"\n                title={comparisonTickers.length > 0 ? \"Candlestick not available when comparing tickers\" : undefined}\n              >\n                Candles {comparisonTickers.length > 0 && <span className=\"text-xs text-muted-foreground ml-1\">(N/A)</span>}\n              </DropdownMenuItem>\n            </DropdownMenuContent>\n          </DropdownMenu>\n\n          {/* Time Interval selector */}\n          {validIntervals.length > 0 ? (\n            <DropdownMenu>\n              <DropdownMenuTrigger asChild>\n                <Button\n                  size=\"sm\"\n                  variant=\"outline\"\n                  className=\"h-8 px-3 text-xs\"\n                  data-testid=\"button-interval-dropdown\"\n                >\n                  {timeIntervals.find(i => i.value === selectedInterval)?.label || '1 hour'}\n                  <ChevronDown className=\"w-3 h-3 ml-1\" style={{ color: '#5AF5FA' }} />\n                </Button>\n              </DropdownMenuTrigger>\n              <DropdownMenuContent align=\"start\">\n                {timeIntervals\n                  .filter(interval => validIntervals.includes(interval.value))\n                  .map(interval => (\n                    <DropdownMenuItem\n                      key={interval.value}\n                      onClick={() => setSelectedInterval(interval.value)}\n                      className={`cursor-pointer ${selectedInterval === interval.value ? 'bg-[#5AF5FA]/20' : ''}`}\n                      data-testid={`menu-interval-${interval.value}`}\n                    >\n                      {interval.label}\n                    </DropdownMenuItem>\n                  ))\n                }\n              </DropdownMenuContent>\n            </DropdownMenu>\n          ) : (\n            <TooltipProvider>\n              <HoverTooltip>\n                <HoverTooltipTrigger asChild>\n                  <Button\n                    size=\"sm\"\n                    variant=\"outline\"\n                    className=\"h-8 px-3 text-xs opacity-50 cursor-not-allowed\"\n                    disabled\n                    data-testid=\"button-interval-disabled\"\n                  >\n                    Daily\n                    <ChevronDown className=\"w-3 h-3 ml-1\" style={{ color: '#5AF5FA' }} />\n                  </Button>\n                </HoverTooltipTrigger>\n                <HoverTooltipContent>\n                  <p className=\"text-xs\">Intraday intervals unavailable for ranges over 3 months</p>\n                </HoverTooltipContent>\n              </HoverTooltip>\n            </TooltipProvider>\n          )}\n\n          {/* Y-Axis Mode Toggle - Only show in price-volume tab */}\n          {activeTab === 'price-volume' && (\n            <div className=\"flex items-center gap-2 ml-2\">\n              <Switch\n                id=\"y-axis-mode\"\n                checked={yAxisDisplayMode === 'percentage'}\n                onCheckedChange={(checked) => setYAxisDisplayMode(checked ? 'percentage' : 'price')}\n                className=\"h-4 w-8\"\n                data-testid=\"switch-y-axis-mode\"\n              />\n              <label\n                htmlFor=\"y-axis-mode\"\n                className=\"text-xs text-muted-foreground cursor-pointer hover:text-foreground transition-colors\"\n              >\n                Y-Axis: {yAxisDisplayMode === 'percentage' ? 'Percentage' : 'Price'}\n              </label>\n            </div>\n          )}\n        </div>\n        \n        {/* Redesigned Custom Date Picker - Limited to 10 Years */}\n        {selectedTimeframe === 'Custom' && showDatePicker && (\n          <div className=\"mt-4 p-4 border rounded-lg relative z-50\" style={{ zIndex: 9999, backgroundColor: '#3A3A3A' }}>\n            {/* Top Bar: Close button, Selected Range Summary & Apply Button */}\n            <div className=\"flex items-start justify-between mb-4\">\n              {/* Left side: Mode Toggle */}\n              <div>\n                <div className=\"flex bg-muted rounded-lg p-1\">\n                  <button\n                    onClick={() => {\n                      setSingleTradingDay(false);\n                      setEndDate(undefined);\n                    }}\n                    className={`px-4 py-2 rounded-md text-sm transition-colors ${\n                      !singleTradingDay \n                        ? 'bg-background shadow-sm text-foreground' \n                        : 'text-muted-foreground hover:text-foreground'\n                    }`}\n                  >\n                    Date Range\n                  </button>\n                  <button\n                    onClick={() => {\n                      setSingleTradingDay(true);\n                      setEndDate(undefined);\n                    }}\n                    className={`px-4 py-2 rounded-md text-sm transition-colors ${\n                      singleTradingDay \n                        ? 'bg-background shadow-sm text-foreground' \n                        : 'text-muted-foreground hover:text-foreground'\n                    }`}\n                  >\n                    Single Trading Day\n                  </button>\n                </div>\n                {singleTradingDay && (\n                  <div className=\"mt-2 text-xs text-muted-foreground bg-blue-50 dark:bg-blue-950 p-2 rounded\">\n                    Will show hourly data from market open to close\n                  </div>\n                )}\n              </div>\n\n              {/* Right side: Selected Range Summary + Apply Button + Close */}\n              <div className=\"flex items-start gap-3\">\n                {startDate && (singleTradingDay || endDate) && (\n                  <div className=\"text-right\">\n                    <div className=\"text-sm text-foreground\">\n                      Selected: {format(startDate, 'MMM dd, yyyy')}{!singleTradingDay && endDate && `  ${format(endDate, 'MMM dd, yyyy')}`}\n                    </div>\n                    <div className=\"text-xs text-muted-foreground\">\n                      {singleTradingDay \n                        ? '(Single day with hourly intervals)'\n                        : `(${Math.ceil((endDate!.getTime() - startDate.getTime()) / (1000 * 60 * 60 * 24))} days)`\n                      }\n                    </div>\n                    <Button\n                      onClick={() => {\n                        if (singleTradingDay) {\n                          setEndDate(startDate);\n                        }\n                        setShowDatePicker(false);\n                      }}\n                      className=\"mt-2 bg-[#5AF5FA] text-[#121212] hover:bg-[#5AF5FA]/90 font-medium\"\n                      size=\"sm\"\n                      data-testid=\"button-apply-date-range\"\n                    >\n                      {singleTradingDay ? 'Show Trading Day' : 'Apply Date Range'}\n                    </Button>\n                  </div>\n                )}\n                <button\n                  onClick={() => {\n                    setShowDatePicker(false);\n                    setSingleTradingDay(false);\n                    setStartDate(undefined);\n                    setEndDate(undefined);\n                  }}\n                  className=\"text-muted-foreground hover:text-foreground transition-colors p-1\"\n                  title=\"Close date picker\"\n                >\n                  <X className=\"w-4 h-4\" />\n                </button>\n              </div>\n            </div>\n            \n            {/* Quick Ranges Dropdown */}\n            <div className=\"mb-4\">\n              <DropdownMenu>\n                <DropdownMenuTrigger asChild>\n                  <Button variant=\"outline\" size=\"sm\" className=\"text-sm\" data-testid=\"dropdown-quick-ranges\">\n                    Quick Ranges\n                    <ChevronDown className=\"w-4 h-4 ml-2\" style={{ color: '#5AF5FA' }} />\n                  </Button>\n                </DropdownMenuTrigger>\n                <DropdownMenuContent align=\"start\" className=\"w-48\">\n                  {[\n                    { label: 'Single Trading Day', getDates: () => {\n                      const yesterday = new Date();\n                      yesterday.setDate(yesterday.getDate() - 1);\n                      if (yesterday.getDay() === 0) yesterday.setDate(yesterday.getDate() - 2);\n                      if (yesterday.getDay() === 6) yesterday.setDate(yesterday.getDate() - 1);\n                      return { start: yesterday, end: undefined, setSingle: true };\n                    }},\n                    { label: 'This Week', getDates: () => {\n                      const today = new Date();\n                      const monday = new Date(today);\n                      monday.setDate(today.getDate() - today.getDay() + 1);\n                      return { start: monday, end: today };\n                    }},\n                    { label: 'Last Week', getDates: () => {\n                      const today = new Date();\n                      const lastFriday = new Date(today);\n                      lastFriday.setDate(today.getDate() - today.getDay() - 2);\n                      const lastMonday = new Date(lastFriday);\n                      lastMonday.setDate(lastFriday.getDate() - 4);\n                      return { start: lastMonday, end: lastFriday };\n                    }},\n                    { label: 'This Month', getDates: () => {\n                      const today = new Date();\n                      const firstDay = new Date(today.getFullYear(), today.getMonth(), 1);\n                      if (firstDay.getDay() === 0) firstDay.setDate(firstDay.getDate() + 1);\n                      if (firstDay.getDay() === 6) firstDay.setDate(firstDay.getDate() + 2);\n                      return { start: firstDay, end: today };\n                    }},\n                    { label: 'Last 3 Months', getDates: () => {\n                      const today = new Date();\n                      const threeMonthsAgo = new Date(today);\n                      threeMonthsAgo.setMonth(today.getMonth() - 3);\n                      if (threeMonthsAgo.getDay() === 0) threeMonthsAgo.setDate(threeMonthsAgo.getDate() + 1);\n                      if (threeMonthsAgo.getDay() === 6) threeMonthsAgo.setDate(threeMonthsAgo.getDate() + 2);\n                      return { start: threeMonthsAgo, end: today };\n                    }}\n                  ].map(({ label, getDates }) => (\n                    <DropdownMenuItem\n                      key={label}\n                      onClick={() => {\n                        const result = getDates();\n                        if ('setSingle' in result && result.setSingle) {\n                          setSingleTradingDay(true);\n                          setStartDate(result.start);\n                          setEndDate(undefined);\n                        } else {\n                          setSingleTradingDay(false);\n                          setStartDate(result.start);\n                          setEndDate(result.end);\n                        }\n                      }}\n                      className=\"cursor-pointer\"\n                      data-testid={`quick-range-${label.toLowerCase().replace(/\\s+/g, '-')}`}\n                    >\n                      {label}\n                    </DropdownMenuItem>\n                  ))}\n                </DropdownMenuContent>\n              </DropdownMenu>\n            </div>\n            \n            {/* Calendar Section */}\n            <div className={`pr-8 ${singleTradingDay ? 'flex justify-center' : 'grid grid-cols-1 md:grid-cols-2 gap-4'}`}>\n              <div className=\"space-y-2\">\n                <label className=\"text-sm font-medium\">\n                  {singleTradingDay ? 'Pick Trading Day' : 'Start Date'}\n                </label>\n                <Calendar\n                  mode=\"single\"\n                  selected={startDate}\n                  onSelect={setStartDate}\n                  month={startCalendarMonth}\n                  onMonthChange={setStartCalendarMonth}\n                  enableYearDropdown\n                  fromYear={new Date().getFullYear() - 10}\n                  toYear={new Date().getFullYear()}\n                  fromDate={(() => {\n                    const tenYearsAgo = new Date();\n                    tenYearsAgo.setFullYear(tenYearsAgo.getFullYear() - 10);\n                    return tenYearsAgo;\n                  })()}\n                  toDate={new Date()}\n                  disabled={(date) => {\n                    const isWeekend = date.getDay() === 0 || date.getDay() === 6;\n                    if (!singleTradingDay && !!endDate && date > endDate) return false;\n                    return isWeekend;\n                  }}\n                  className=\"rounded-md border\"\n                  classNames={{\n                    day_today: \"border border-white rounded bg-transparent text-foreground\",\n                    day_selected: \"bg-[#5AF5FA] text-[#121212] hover:bg-[#5AF5FA] hover:text-[#121212] focus:bg-[#5AF5FA] focus:text-[#121212]\",\n                    day: \"h-9 w-9 p-0 font-normal aria-selected:opacity-100 hover:bg-[#1C1C1C] hover:text-[#F7F7F7] focus:bg-[#1C1C1C] focus:text-[#F7F7F7] rounded transition-colors\"\n                  }}\n                />\n                \n                {/* Enhanced validation with smart suggestions */}\n                {startDate && (startDate.getDay() === 0 || startDate.getDay() === 6) && (\n                  <div className=\"text-xs text-red-600 bg-red-50 dark:bg-red-950 p-2 rounded\">\n                    <div className=\"font-medium\"> No trading data available</div>\n                    <div className=\"mt-1\">\n                      Try {(() => {\n                        const suggestion = new Date(startDate);\n                        if (startDate.getDay() === 0) { // Sunday\n                          suggestion.setDate(startDate.getDate() - 2); // Friday\n                        } else if (startDate.getDay() === 6) { // Saturday\n                          suggestion.setDate(startDate.getDate() - 1); // Friday\n                        }\n                        return format(suggestion, 'MMM dd, yyyy');\n                      })()} instead\n                    </div>\n                  </div>\n                )}\n              </div>\n              \n              {!singleTradingDay && (\n                <div className=\"space-y-2\">\n                  <label className=\"text-sm font-medium\">End Date</label>\n                  <Calendar\n                    mode=\"single\"\n                    selected={endDate}\n                    onSelect={setEndDate}\n                    month={endCalendarMonth}\n                    onMonthChange={setEndCalendarMonth}\n                    enableYearDropdown\n                    fromYear={new Date().getFullYear() - 10}\n                    toYear={new Date().getFullYear()}\n                    fromDate={(() => {\n                      const tenYearsAgo = new Date();\n                      tenYearsAgo.setFullYear(tenYearsAgo.getFullYear() - 10);\n                      return tenYearsAgo;\n                    })()}\n                    toDate={new Date()}\n                    disabled={(date) => {\n                      const isWeekend = date.getDay() === 0 || date.getDay() === 6;\n                      if (!!startDate && date < startDate) return true;\n                      return isWeekend;\n                    }}\n                    className=\"rounded-md border\"\n                    classNames={{\n                      day_today: \"border border-white rounded bg-transparent text-foreground\",\n                      day_selected: \"bg-[#5AF5FA] text-[#121212] hover:bg-[#5AF5FA] hover:text-[#121212] focus:bg-[#5AF5FA] focus:text-[#121212]\",\n                      day: \"h-9 w-9 p-0 font-normal aria-selected:opacity-100 hover:bg-[#1C1C1C] hover:text-[#F7F7F7] focus:bg-[#1C1C1C] focus:text-[#F7F7F7] rounded transition-colors\"\n                    }}\n                  />\n                  \n                  {endDate && (endDate.getDay() === 0 || endDate.getDay() === 6) && (\n                    <div className=\"text-xs text-red-600 bg-red-50 dark:bg-red-950 p-2 rounded\">\n                      <div className=\"font-medium\"> No trading data available</div>\n                      <div className=\"mt-1\">\n                        Try {(() => {\n                          const suggestion = new Date(endDate);\n                          if (endDate.getDay() === 0) { // Sunday\n                            suggestion.setDate(endDate.getDate() - 2); // Friday\n                          } else if (endDate.getDay() === 6) { // Saturday\n                            suggestion.setDate(endDate.getDate() - 1); // Friday\n                          }\n                          return format(suggestion, 'MMM dd, yyyy');\n                        })()} instead\n                      </div>\n                    </div>\n                  )}\n                </div>\n              )}\n            </div>\n          </div>\n        )}\n\n      {/* Chart Controls Section with Export Button */}\n      <div className=\"flex items-center justify-between mb-4\">\n          <div className=\"flex items-center justify-between\">\n            <div className=\"flex items-center gap-4\">\n              {/* Annotation Mode Controls */}\n              <div className=\"flex items-center gap-2\">\n                <DropdownMenu>\n                  <DropdownMenuTrigger asChild>\n                    <Button\n                      size=\"sm\"\n                      variant=\"outline\"\n                      className=\"h-8 px-3 text-xs\"\n                      data-testid=\"button-annotation-dropdown\"\n                    >\n                      {annotationMode === 'text' && (\n                        <>\n                          <div className=\"w-3 h-3 mr-1 flex items-center justify-center\" style={{ color: '#FAFF50' }}>\n                            <div className=\"w-0.5 h-3 bg-current\" />\n                          </div>\n                          Vertical\n                        </>\n                      )}\n                      {annotationMode === 'percentage' && (\n                        <>\n                          <Ruler className=\"w-3 h-3 mr-1\" style={{ color: '#22C55E' }} />\n                          Measure\n                        </>\n                      )}\n                      {annotationMode === 'horizontal' && (\n                        <>\n                          <Minus className=\"w-3 h-3 mr-1\" style={{ color: '#AA99FF' }} />\n                          Horizontal\n                        </>\n                      )}\n                      {annotationMode === 'note' && (\n                        <>\n                          <Type className=\"w-3 h-3 mr-1\" style={{ color: '#FFFFFF' }} />\n                          Text Note\n                        </>\n                      )}\n                      {!annotationMode && 'Select Tool'}\n                      <ChevronDown className=\"w-3 h-3 ml-1\" style={{ color: '#5AF5FA' }} />\n                    </Button>\n                  </DropdownMenuTrigger>\n                  <DropdownMenuContent align=\"start\">\n                    <DropdownMenuItem\n                      onClick={() => {\n                        setAnnotationMode('text');\n                        setPendingPercentageStart(null);\n                      }}\n                      className=\"cursor-pointer\"\n                      data-testid=\"menu-annotation-text\"\n                    >\n                      <div className=\"w-3 h-3 mr-2 flex items-center justify-center\" style={{ color: '#FAFF50' }}>\n                        <div className=\"w-0.5 h-3 bg-current\" />\n                      </div>\n                      Vertical\n                    </DropdownMenuItem>\n                    <HoverTooltip>\n                      <HoverTooltipTrigger asChild>\n                        <DropdownMenuItem\n                          onClick={() => {\n                            if (activeTab !== 'comparison') {\n                              setAnnotationMode('percentage');\n                              setPendingPercentageStart(null);\n                            }\n                          }}\n                          disabled={activeTab === 'comparison'}\n                          className={`cursor-pointer ${\n                            activeTab === 'comparison' ? 'opacity-40 cursor-not-allowed' : ''\n                          }`}\n                          data-testid=\"menu-annotation-percentage\"\n                        >\n                          <Ruler className=\"w-3 h-3 mr-2\" style={{ color: '#22C55E' }} />\n                          Measure\n                        </DropdownMenuItem>\n                      </HoverTooltipTrigger>\n                      {activeTab === 'comparison' && (\n                        <HoverTooltipContent>\n                          <p>Percentage measurement is deactivated on Compare</p>\n                        </HoverTooltipContent>\n                      )}\n                    </HoverTooltip>\n                    <DropdownMenuItem\n                      onClick={() => {\n                        setAnnotationMode('horizontal');\n                        setPendingPercentageStart(null);\n                      }}\n                      className=\"cursor-pointer\"\n                      data-testid=\"menu-annotation-horizontal\"\n                    >\n                      <Minus className=\"w-3 h-3 mr-2\" style={{ color: '#AA99FF' }} />\n                      Horizontal\n                    </DropdownMenuItem>\n                    <DropdownMenuItem \n                      onClick={() => setShowCsvModal(true)}\n                      className=\"cursor-pointer\"\n                      data-testid=\"menu-csv-overlay\"\n                    >\n                      {csvOverlay.length > 0 ? (\n                        <>\n                          <Settings className=\"w-4 h-4 mr-2\" />\n                          Manage CSV Overlay\n                        </>\n                      ) : (\n                        <>\n                          <Plus className=\"w-4 h-4 mr-2\" />\n                          Add % Overlay (CSV)\n                        </>\n                      )}\n                    </DropdownMenuItem>\n                    <DropdownMenuItem \n                      onClick={() => setAnnotationMode('note')}\n                      className=\"cursor-pointer\"\n                      data-testid=\"menu-note\"\n                    >\n                      <Type className=\"w-3 h-3 mr-2\" style={{ color: '#FFFFFF' }} />\n                      Add Text Note\n                    </DropdownMenuItem>\n                    <DropdownMenuItem \n                      onClick={() => {\n                        setShowTickerSearch(true);\n                        setAnnotationMode('text');\n                        setPendingPercentageStart(null);\n                      }}\n                      className=\"cursor-pointer\"\n                      data-testid=\"menu-add-ticker\"\n                    >\n                      <Plus className=\"w-4 h-4 mr-2\" style={{ color: '#5AF5FA' }} />\n                      Add Ticker\n                    </DropdownMenuItem>\n                  </DropdownMenuContent>\n                </DropdownMenu>\n                \n                {/* Price Y-axis Zoom Controls */}\n                <div className=\"flex border border-border rounded-md overflow-hidden bg-background\">\n                  <button\n                    onClick={zoomInPrice}\n                    disabled={priceAxisRange <= priceZoomLevels[0] * priceExtremes.baseRange}\n                    className=\"h-8 w-8 text-sm font-medium bg-[#121212] text-white border-r border-border hover:bg-[#5AF5FA] hover:text-[#121212] disabled:opacity-50 disabled:cursor-not-allowed transition-colors duration-150 flex items-center justify-center\"\n                    data-testid=\"button-zoom-in-price\"\n                    title=\"Zoom In Price\"\n                  >\n                    +\n                  </button>\n                  <button\n                    onClick={zoomOutPrice}\n                    disabled={priceAxisRange >= priceZoomLevels[priceZoomLevels.length - 1] * priceExtremes.baseRange}\n                    className=\"h-8 w-8 text-sm font-medium bg-[#121212] text-white border-r border-border hover:bg-[#5AF5FA] hover:text-[#121212] disabled:opacity-50 disabled:cursor-not-allowed transition-colors duration-150 flex items-center justify-center\"\n                    data-testid=\"button-zoom-out-price\"\n                    title=\"Zoom Out Price\"\n                  >\n                    \n                  </button>\n                  <button\n                    onClick={fitPriceToData}\n                    className=\"h-8 w-10 text-xs font-medium bg-[#121212] text-white hover:bg-[#5AF5FA] hover:text-[#121212] transition-colors duration-150 flex items-center justify-center\"\n                    data-testid=\"button-fit-price-data\"\n                    title=\"Fit Price to Data\"\n                  >\n                    Fit\n                  </button>\n                </div>\n                \n                {/* Hover Tool Toggle */}\n                <div className=\"flex items-center gap-2\">\n                  <label htmlFor=\"hover-tool-toggle\" className=\"text-xs text-muted-foreground\">\n                    Hover tool\n                  </label>\n                  <Switch\n                    id=\"hover-tool-toggle\"\n                    checked={showHoverTooltip}\n                    onCheckedChange={setShowHoverTooltip}\n                    className=\"scale-75\"\n                    data-testid=\"switch-hover-tool\"\n                  />\n                </div>\n                \n                {onClearAll && (\n                  <Button\n                    variant=\"outline\"\n                    size=\"sm\"\n                    onClick={() => {\n                      setCsvOverlay([]);\n                      onClearAll();\n                    }}\n                    className=\"h-8 px-3 text-xs text-destructive hover:text-black hover:bg-[#5AF5FA]\"\n                    data-testid=\"button-clear-all\"\n                  >\n                    <RotateCcw className=\"w-3 h-3 mr-1\" />\n                    Clear All\n                  </Button>\n                )}\n                \n                {/* Export Dropdown - positioned in toolbar row */}\n                <DropdownMenu>\n                  <DropdownMenuTrigger asChild>\n                    <Button\n                      variant=\"outline\"\n                      size=\"sm\"\n                      className=\"h-8 px-3 text-xs border-[#5AF5FA]/30 text-[#5AF5FA] hover:bg-[#5AF5FA]/10 ml-2\"\n                    >\n                      <Download className=\"w-3 h-3 mr-1\" />\n                      Export\n                      <ChevronDown className=\"w-3 h-3 ml-1\" style={{ color: '#5AF5FA' }} />\n                    </Button>\n                  </DropdownMenuTrigger>\n                  <DropdownMenuContent align=\"center\" className=\"w-36\">\n                    {activeTab === 'price-volume' ? (\n                      <>\n                        <DropdownMenuItem onClick={exportAsPNG} className=\"cursor-pointer\">\n                          <Download className=\"w-4 h-4 mr-2\" />\n                          Export as PNG\n                        </DropdownMenuItem>\n                        <DropdownMenuItem onClick={exportAsPDF} className=\"cursor-pointer\">\n                          <Download className=\"w-4 h-4 mr-2\" />\n                          Export as PDF\n                        </DropdownMenuItem>\n                        <DropdownMenuItem onClick={exportAsSVG} className=\"cursor-pointer\">\n                          <Download className=\"w-4 h-4 mr-2\" />\n                          Export as SVG\n                        </DropdownMenuItem>\n                        <DropdownMenuItem onClick={exportAsCode} className=\"cursor-pointer\">\n                          <Code className=\"w-4 h-4 mr-2\" />\n                          Get Embed Code\n                        </DropdownMenuItem>\n                      </>\n                    ) : (\n                      <>\n                        <DropdownMenuItem onClick={exportComparisonAsPNG} className=\"cursor-pointer\">\n                          <Download className=\"w-4 h-4 mr-2\" />\n                          Export as PNG\n                        </DropdownMenuItem>\n                        <DropdownMenuItem onClick={exportComparisonAsPDF} className=\"cursor-pointer\">\n                          <Download className=\"w-4 h-4 mr-2\" />\n                          Export as PDF\n                        </DropdownMenuItem>\n                        <DropdownMenuItem onClick={exportComparisonAsSVG} className=\"cursor-pointer\">\n                          <Download className=\"w-4 h-4 mr-2\" />\n                          Export as SVG\n                        </DropdownMenuItem>\n                        <DropdownMenuItem onClick={exportComparisonAsCSV} className=\"cursor-pointer\">\n                          <Download className=\"w-4 h-4 mr-2\" />\n                          Export as CSV\n                        </DropdownMenuItem>\n                        <DropdownMenuItem onClick={exportComparisonAsCode} className=\"cursor-pointer\">\n                          <Code className=\"w-4 h-4 mr-2\" />\n                          Get Embed Code\n                        </DropdownMenuItem>\n                      </>\n                    )}\n                  </DropdownMenuContent>\n                </DropdownMenu>\n              </div>\n            </div>\n\n            {/* Comparison Ticker Tags (Task 6) */}\n            {comparisonTickers.length > 0 && (\n              <div className=\"flex flex-wrap items-center gap-2 mb-4\">\n                {comparisonTickers.map((ticker) => (\n                  <div\n                    key={ticker.symbol}\n                    className=\"flex items-center gap-1.5 px-2 py-1 bg-muted rounded-md text-sm\"\n                    data-testid={`comparison-ticker-${ticker.symbol}`}\n                  >\n                    <div \n                      className=\"w-3 h-3 rounded-sm\"\n                      style={{ backgroundColor: ticker.color }}\n                    />\n                    <span>{ticker.symbol}</span>\n                    <Button\n                      variant=\"ghost\"\n                      size=\"sm\"\n                      className=\"h-4 w-4 p-0 hover:bg-destructive hover:text-destructive-foreground\"\n                      onClick={() => removeComparisonTicker(ticker.symbol)}\n                      data-testid={`remove-comparison-ticker-${ticker.symbol}`}\n                    >\n                      <X className=\"h-3 w-3\" />\n                    </Button>\n                  </div>\n                ))}\n              </div>\n            )}\n\n            {/* Ticker Search Dialog (Task 5) */}\n            <Dialog \n              open={showTickerSearch} \n              onOpenChange={(open) => {\n                setShowTickerSearch(open);\n                if (!open) setTickerSearchQuery('');\n              }}\n            >\n              <DialogContent className=\"sm:max-w-md\">\n                <DialogHeader>\n                  <DialogTitle>Add Comparison Ticker</DialogTitle>\n                  <DialogDescription>\n                    Search and add up to {MAX_COMPARISON_TICKERS} tickers to compare with {symbol}\n                  </DialogDescription>\n                </DialogHeader>\n                <div className=\"space-y-4\">\n                  <Input\n                    placeholder=\"Search tickers (e.g., AAPL, MSFT)\"\n                    value={tickerSearchQuery}\n                    onChange={(e) => setTickerSearchQuery(e.target.value)}\n                    onKeyDown={(e) => {\n                      if (e.key === 'Escape') {\n                        setShowTickerSearch(false);\n                        setTickerSearchQuery('');\n                      }\n                    }}\n                    autoFocus\n                    data-testid=\"input-comparison-ticker-search\"\n                  />\n\n                  {/* Search Results */}\n                  {debouncedTickerQuery.trim().length >= 2 && tickerSearchResults.length > 0 && (\n                    <div className=\"max-h-60 overflow-y-auto space-y-1 border rounded-md p-2\">\n                      {tickerSearchResults.slice(0, 10).map((result) => (\n                        <div\n                          key={result.symbol}\n                          className=\"flex items-center justify-between p-2 hover:bg-muted rounded cursor-pointer\"\n                          onClick={() => addComparisonTicker(result.symbol, result.name)}\n                          data-testid={`search-result-${result.symbol}`}\n                        >\n                          <div className=\"flex-1 min-w-0\">\n                            <div className=\"flex items-center gap-2\">\n                              <span className=\"font-semibold\">{result.symbol}</span>\n                              <span className=\"text-sm text-muted-foreground truncate\">{result.name}</span>\n                            </div>\n                          </div>\n                          <div className=\"text-sm text-muted-foreground ml-2\">\n                            ${parseFloat(result.price).toFixed(2)}\n                          </div>\n                        </div>\n                      ))}\n                    </div>\n                  )}\n\n                  {debouncedTickerQuery.trim().length >= 2 && tickerSearchResults.length === 0 && (\n                    <div className=\"text-sm text-muted-foreground text-center py-4\">\n                      No results found\n                    </div>\n                  )}\n\n                  {debouncedTickerQuery.trim().length > 0 && debouncedTickerQuery.trim().length < 2 && (\n                    <div className=\"text-xs text-muted-foreground\">\n                      Type at least 2 characters to search\n                    </div>\n                  )}\n\n                  {debouncedTickerQuery.trim().length === 0 && (\n                    <div className=\"text-xs text-muted-foreground text-center py-2\">\n                      Start typing to search for tickers\n                    </div>\n                  )}\n                </div>\n              </DialogContent>\n            </Dialog>\n          </div>\n        </div>\n\n        <TabsContent value=\"price-volume\" className=\"bg-background relative z-10\" data-testid=\"tabpanel-price-volume\">\n        {isLoading ? (\n          <div className=\"h-80 flex items-center justify-center\">\n            <div className=\"flex items-center gap-2 text-muted-foreground\">\n              <Loader2 className=\"w-5 h-5 animate-spin\" />\n              Loading chart data...\n            </div>\n          </div>\n        ) : error ? (\n          <div className=\"h-80 flex items-center justify-center\">\n            <div className=\"text-center max-w-md\">\n              <div className=\"text-red-500 font-medium mb-2\">Error Loading Data</div>\n              <div className=\"text-sm text-muted-foreground mb-4\">\n                {symbol}: Failed to fetch chart data\n              </div>\n              <div className=\"text-xs text-muted-foreground bg-muted p-3 rounded-lg\">\n                <div className=\"font-medium mb-1\">Possible reasons:</div>\n                <ul className=\"text-left space-y-1\">\n                  <li> Symbol not found or invalid</li>\n                  <li> Weekend or market holiday selected</li>\n                  <li> Date range too far in the past</li>\n                  <li> Data not available for this timeframe</li>\n                </ul>\n              </div>\n              <Button\n                variant=\"outline\"\n                size=\"sm\"\n                className=\"mt-3\"\n                onClick={() => {\n                  if (selectedTimeframe === 'Custom') {\n                    setStartDate(undefined);\n                    setEndDate(undefined);\n                    setShowDatePicker(true);\n                  }\n                }}\n              >\n                Try Different Dates\n              </Button>\n            </div>\n          </div>\n        ) : !chartData?.data || chartData.data.length === 0 ? (\n          <div className=\"h-80 flex items-center justify-center text-muted-foreground\">\n            No chart data available for {symbol}\n          </div>\n        ) : (\n          <div \n            ref={chartRef} \n            className={`w-full rounded-lg relative pt-20 ${\n              isDragging \n                ? '' \n                : annotationMode === 'percentage'\n                  ? 'annotation-measure-mode'\n                  : annotationMode === 'text'\n                    ? 'annotation-vertical-mode'\n                    : annotationMode === 'horizontal'\n                      ? 'annotation-horizontal-mode'\n                      : annotationMode === 'note'\n                        ? 'annotation-note-mode'\n                        : ''\n            }`}\n            style={{ \n              backgroundColor: '#121212',\n              cursor: isDragging ? 'grabbing' : undefined\n            }}\n            onMouseDown={handleMouseDown}\n            onMouseMove={handleMouseMove}\n            onMouseUp={handleMouseUp}\n          >\n            {/* Export Legend - Included in export area, positioned at top */}\n            {(symbol || comparisonTickers.length > 0) && (\n              <div className=\"absolute top-2 left-4 flex flex-wrap gap-2 z-50\">\n                {/* Main Ticker - Uses lineColor for positive/negative */}\n                {symbol && (\n                  <div \n                    className=\"flex items-center gap-2 px-2 py-1 rounded border text-xs font-medium\"\n                    style={{ \n                      backgroundColor: '#1a1a1a', \n                      borderColor: lineColor\n                    }}\n                  >\n                    <div \n                      className=\"w-3 h-3 rounded-sm\" \n                      style={{ backgroundColor: lineColor }}\n                    />\n                    <span style={{ color: '#f7f7f7' }}>{symbol}</span>\n                    <span style={{ color: '#f7f7f7' }} className=\"font-bold\">\n                      {actualCurrentPrice !== '--' ? formatPrice(parseFloat(actualCurrentPrice)) : '--'}\n                    </span>\n                    <span \n                      className=\"font-semibold px-1 rounded text-[#121212]\"\n                      style={{ backgroundColor: lineColor }}\n                    >\n                      {isPositive ? '+' : ''}{timeframePercentChange.toFixed(2)}%\n                    </span>\n                  </div>\n                )}\n                \n                {/* Comparison Tickers */}\n                {comparisonTickers.map(ticker => (\n                  <div \n                    key={`export-${ticker.symbol}`}\n                    className=\"flex items-center gap-2 px-2 py-1 rounded border text-xs font-medium\"\n                    style={{ \n                      backgroundColor: '#1a1a1a', \n                      borderColor: ticker.color\n                    }}\n                  >\n                    <div \n                      className=\"w-3 h-3 rounded-sm\" \n                      style={{ backgroundColor: ticker.color }}\n                    />\n                    <span style={{ color: '#f7f7f7' }}>{ticker.symbol}</span>\n                  </div>\n                ))}\n              </div>\n            )}\n            \n            {/* Annotation Labels - positioned in reserved padding space above charts */}\n            {annotations.length > 0 && (\n              <div className=\"absolute top-0 left-0 w-full h-20 pointer-events-none\" style={{ zIndex: 1000 }}>\n                {annotations.map((annotation) => {\n                  if (annotation.type === 'text') {\n                    // Text annotations - display at single point\n                    const dataIndex = chartData?.data?.findIndex(d => d.timestamp === annotation.timestamp) ?? -1;\n                    if (dataIndex === -1) return null;\n                    \n                    const totalDataPoints = (chartData?.data?.length ?? 1) - 1;\n                    const xPercent = totalDataPoints > 0 ? (dataIndex / totalDataPoints) * 100 : 0;\n                    \n                    return (\n                      <div\n                        key={annotation.id}\n                        className=\"absolute\"\n                        style={{ \n                          left: `${xPercent}%`, \n                          top: `${20 + (annotation.verticalOffset || 0)}px`, \n                          transform: `translateX(calc(-50% + ${annotation.horizontalOffset || 0}px))`\n                        }}\n                      >\n                        <div \n                          className=\"rounded px-1.5 py-0.5 max-w-32 pointer-events-auto cursor-grab hover:opacity-80 shadow-lg select-none\"\n                          style={{ \n                            backgroundColor: '#121212', \n                            border: '1px solid #FAFF50',\n                            minWidth: '40px',\n                            fontSize: '10px',\n                            wordBreak: 'break-word',\n                            overflowWrap: 'break-word',\n                            whiteSpace: 'pre-wrap'\n                          }}\n                          onMouseDown={(e) => handleTextMouseDown(e, annotation)}\n                          onDoubleClick={() => handleAnnotationDoubleClick(annotation)}\n                          title=\"Click and drag to move in any direction, double-click to delete\"\n                        >\n                          <div className=\"text-foreground\">{annotation.text || ''}</div>\n                        </div>\n                      </div>\n                    );\n                  } else if (annotation.type === 'horizontal') {\n                    // Horizontal annotations - display at single point\n                    const dataIndex = chartData?.data?.findIndex(d => d.timestamp === annotation.timestamp) ?? -1;\n                    if (dataIndex === -1) return null;\n                    \n                    const totalDataPoints = (chartData?.data?.length ?? 1) - 1;\n                    const xPercent = totalDataPoints > 0 ? (dataIndex / totalDataPoints) * 100 : 0;\n                    \n                    return (\n                      <div\n                        key={annotation.id}\n                        className=\"absolute\"\n                        style={{ left: `${xPercent}%`, top: `${20 + (annotation.verticalOffset || 0)}px`, transform: `translateX(calc(-50% + ${annotation.horizontalOffset || 0}px))` }}\n                      >\n                        <div \n                          className=\"rounded px-1.5 py-0.5 max-w-32 pointer-events-auto cursor-grab hover:opacity-80 shadow-lg select-none\"\n                          style={{ \n                            backgroundColor: '#121212', \n                            border: '1px solid #AA99FF',\n                            minWidth: '40px',\n                            fontSize: '10px',\n                            wordBreak: 'break-word',\n                            overflowWrap: 'break-word',\n                            whiteSpace: 'pre-wrap'\n                          }}\n                          onMouseDown={(e) => handleTextMouseDown(e, annotation)}\n                          onDoubleClick={() => handleAnnotationDoubleClick(annotation)}\n                          title=\"Click and drag to move in any direction, double-click to delete\"\n                        >\n                          <div className=\"text-foreground\">{annotation.text || ''}</div>\n                        </div>\n                      </div>\n                    );\n                  } else if (annotation.type === 'note') {\n                    // Note annotations - floating text box (no line)\n                    const dataIndex = chartData?.data?.findIndex(d => d.timestamp === annotation.timestamp) ?? -1;\n                    if (dataIndex === -1) return null;\n                    \n                    const totalDataPoints = (chartData?.data?.length ?? 1) - 1;\n                    const xPercent = totalDataPoints > 0 ? (dataIndex / totalDataPoints) * 100 : 0;\n                    \n                    return (\n                      <div\n                        key={annotation.id}\n                        className=\"absolute\"\n                        style={{ \n                          left: `${xPercent}%`, \n                          top: `${20 + (annotation.verticalOffset || 0)}px`, \n                          transform: `translateX(calc(-50% + ${annotation.horizontalOffset || 0}px))`\n                        }}\n                      >\n                        <div \n                          className=\"rounded px-1.5 py-0.5 max-w-32 pointer-events-auto cursor-grab hover:opacity-80 shadow-lg select-none\"\n                          style={{ \n                            backgroundColor: '#121212', \n                            border: '1px solid #FFFFFF',\n                            minWidth: '40px',\n                            fontSize: '10px',\n                            wordBreak: 'break-word',\n                            overflowWrap: 'break-word',\n                            whiteSpace: 'pre-wrap'\n                          }}\n                          onMouseDown={(e) => handleTextMouseDown(e, annotation)}\n                          onDoubleClick={() => handleAnnotationDoubleClick(annotation)}\n                          title=\"Click and drag to move in any direction, double-click to delete\"\n                        >\n                          <div className=\"text-foreground\">{annotation.text || ''}</div>\n                        </div>\n                      </div>\n                    );\n                  } else if (annotation.type === 'percentage' && annotation.startTimestamp && annotation.endTimestamp) {\n                    // Percentage measurements - display at midpoint\n                    const startIndex = chartData?.data?.findIndex(d => d.timestamp === annotation.startTimestamp) ?? -1;\n                    const endIndex = chartData?.data?.findIndex(d => d.timestamp === annotation.endTimestamp) ?? -1;\n                    if (startIndex === -1 || endIndex === -1) return null;\n                    \n                    const totalDataPoints = (chartData?.data?.length ?? 1) - 1;\n                    const startPercent = totalDataPoints > 0 ? (startIndex / totalDataPoints) * 100 : 0;\n                    const endPercent = totalDataPoints > 0 ? (endIndex / totalDataPoints) * 100 : 0;\n                    const midPercent = (startPercent + endPercent) / 2;\n                    \n                    const isPositive = (annotation.percentage || 0) >= 0;\n                    \n                    // Calculate time span between start and end\n                    const timeDiffMs = annotation.endTimestamp - annotation.startTimestamp;\n                    const timeDiffDays = timeDiffMs / (1000 * 60 * 60 * 24);\n                    const timeDiffHours = timeDiffMs / (1000 * 60 * 60);\n                    const timeDiffMinutes = timeDiffMs / (1000 * 60);\n                    \n                    let timeSpanText = '';\n                    if (timeDiffDays >= 1) {\n                      const days = Math.floor(timeDiffDays);\n                      timeSpanText = `${days} day${days !== 1 ? 's' : ''}`;\n                    } else if (timeDiffHours >= 1) {\n                      const hours = Math.floor(timeDiffHours);\n                      timeSpanText = `${hours} hour${hours !== 1 ? 's' : ''}`;\n                    } else {\n                      const minutes = Math.floor(timeDiffMinutes);\n                      timeSpanText = `${minutes} min${minutes !== 1 ? 's' : ''}`;\n                    }\n                    \n                    return (\n                      <div\n                        key={annotation.id}\n                        className=\"absolute\"\n                        style={{ left: `${midPercent}%`, top: `${20 + (annotation.verticalOffset || 0)}px`, transform: `translateX(calc(-50% + ${annotation.horizontalOffset || 0}px))` }}\n                      >\n                        <div \n                          className=\"rounded px-2 py-1 text-xs pointer-events-auto shadow-lg cursor-grab hover:opacity-80 overflow-hidden\"\n                          style={{ backgroundColor: '#121212', border: `1px solid ${isPositive ? '#22c55e' : '#ef4444'}` }}\n                          onMouseDown={(e) => handleTextMouseDown(e, annotation)}\n                          onDoubleClick={() => handleAnnotationDoubleClick(annotation)}\n                          title=\"Click and drag to move in any direction, double-click to delete\"\n                        >\n                          <div className={`font-bold text-left whitespace-nowrap ${isPositive ? 'text-green-400' : 'text-red-400'}`}>\n                            {isPositive ? '' : ''} {(annotation.percentage || 0).toFixed(2)}%\n                          </div>\n                          <div className=\"text-xs text-muted-foreground text-left whitespace-nowrap\">\n                            {formatPrice(annotation.startPrice || 0)}  {formatPrice(annotation.endPrice || 0)}\n                          </div>\n                          <div className=\"text-[10px] text-muted-foreground text-left mt-0.5 whitespace-nowrap\">\n                            {timeSpanText}\n                          </div>\n                        </div>\n                      </div>\n                    );\n                  }\n                  return null;\n                })}\n              </div>\n            )}\n\n\n            {/* Price Chart - Dynamic chart type */}\n            <div className=\"h-80 w-full relative\">\n              <ResponsiveContainer width=\"100%\" height=\"100%\">\n                <ComposedChart\n                  data={chartDataWithComparisons || chartDataWithMA}\n                  margin={{ top: 15, right: 0, left: 0, bottom: -5 }}\n                  onClick={handleChartClick}\n                >\n                  <defs>\n                    <linearGradient id=\"positiveGradient\" x1=\"0\" y1=\"0\" x2=\"0\" y2=\"1\">\n                      <stop offset=\"0%\" stopColor=\"#5AF5FA\" stopOpacity={0.5} />\n                      <stop offset=\"100%\" stopColor=\"#5AF5FA\" stopOpacity={0.2} />\n                    </linearGradient>\n                    <linearGradient id=\"negativeGradient\" x1=\"0\" y1=\"0\" x2=\"0\" y2=\"1\">\n                      <stop offset=\"0%\" stopColor=\"#FFA5FF\" stopOpacity={0.5} />\n                      <stop offset=\"100%\" stopColor=\"#FFA5FF\" stopOpacity={0.2} />\n                    </linearGradient>\n                  </defs>\n                  \n                  {/* Custom grid lines - horizontal dashed, vertical solid */}\n                  {/* Horizontal grid lines (dashed) */}\n                  <CartesianGrid \n                    strokeDasharray=\"3 3\" \n                    stroke=\"#3B3B3B\" \n                    opacity={0.5}\n                    horizontal={true}\n                    vertical={false}\n                  />\n                  {/* Vertical grid lines (solid) */}\n                  <CartesianGrid \n                    stroke=\"#3B3B3B\" \n                    strokeWidth={1}\n                    opacity={0.3}\n                    horizontal={false}\n                    vertical={true}\n                  />\n                  \n                  {/* X-axis with date/time labels */}\n                  <XAxis \n                    dataKey=\"time\"\n                    tickFormatter={(value) => formatTime(value, selectedTimeframe)}\n                    tick={{ fontSize: 12, fill: '#F7F7F7' }}\n                    tickLine={{ stroke: '#F7F7F7' }}\n                    axisLine={{ stroke: '#F7F7F7' }}\n                  />\n\n                  {/* Primary Y-axis for price (right side) - clickable to toggle to percentage view */}\n                  <YAxis \n                    yAxisId=\"price\"\n                    orientation=\"right\"\n                    domain={getPriceAxisDomain()}\n                    allowDataOverflow={priceAxisMode === 'fixed'}\n                    dataKey={yAxisDisplayMode === 'percentage' ? 'percentageChange' : 'close'}\n                    tick={(props) => (\n                      <g \n                        onClick={handleYAxisClick}\n                        style={{ cursor: 'pointer' }}\n                        className=\"group\"\n                      >\n                        <text\n                          x={props.x}\n                          y={props.y}\n                          dx={0}\n                          dy={0}\n                          textAnchor={props.textAnchor}\n                          fill=\"#F7F7F7\"\n                          className=\"group-hover:fill-[#5AF5FA] transition-colors duration-200\"\n                          fontSize={12}\n                        >\n                          {yAxisDisplayMode === 'percentage' ? `${props.payload.value.toFixed(1)}%` : formatPrice(props.payload.value)}\n                        </text>\n                      </g>\n                    )}\n                    axisLine={{ stroke: '#F7F7F7' }}\n                    tickLine={{ stroke: '#F7F7F7' }}\n                    width={60}\n                  />\n                  \n                  {/* Left Y-axis for overlays (CSV and/or Comparison Tickers) */}\n                  {/* When comparing tickers, this becomes the primary axis for all percentage data */}\n                  {(csvOverlay.length > 0 || comparisonTickers.length > 0) && (\n                    <YAxis\n                      yAxisId=\"overlay\"\n                      orientation=\"left\"\n                      domain={\n                        csvOverlay.length > 0 && comparisonTickers.length === 0 \n                          ? [0, 100] \n                          : comparisonPercentageDomain || ['dataMin', 'dataMax']\n                      }\n                      tickFormatter={(value) => `${value.toFixed(1)}%`}\n                      stroke=\"#b0b0b0\"\n                      tick={{ fill: '#b0b0b0', fontSize: 11 }}\n                      width={50}\n                      axisLine={{ stroke: '#b0b0b0' }}\n                      tickLine={{ stroke: '#b0b0b0' }}\n                    />\n                  )}\n                  \n                  {showHoverTooltip && (\n                    <Tooltip \n                      active={!isDragging}\n                      allowEscapeViewBox={{ x: false, y: false }}\n                      cursor={annotationMode ? false : { stroke: '#666', strokeWidth: 1, strokeDasharray: '5 5' }}\n                      content={(props) => {\n                        if (!props.active || !props.payload?.length) return null;\n                        \n                        const data = props.payload[0]?.payload;\n                        if (!data) return null;\n                        \n                        const date = new Date(props.label);\n                        const dateStr = formatTime(props.label, selectedTimeframe);\n                        const timeStr = date.toLocaleTimeString('en-US', { \n                          hour: '2-digit', \n                          minute: '2-digit',\n                          second: '2-digit',\n                          hour12: false \n                        });\n                        \n                        return (\n                          <div style={{\n                            backgroundColor: 'rgba(18, 18, 18, 0.7)',\n                            border: '1px solid rgba(51, 51, 51, 0.5)',\n                            borderRadius: '6px',\n                            color: '#F7F7F7',\n                            padding: '6px 10px',\n                            fontSize: '11px',\n                            opacity: 0.8\n                          }}>\n                            <div style={{ \n                              marginBottom: '6px', \n                              lineHeight: '1.4',\n                              paddingBottom: '3px',\n                              borderBottom: '1px solid rgba(51, 51, 51, 0.5)'\n                            }}>{`${dateStr} ${timeStr}`}</div>\n                            {chartType === 'candlestick' && data.open && data.high && data.low && data.close ? (\n                              <>\n                                <div>Open: {formatPrice(data.open)}</div>\n                                <div>High: {formatPrice(data.high)}</div>\n                                <div>Low: {formatPrice(data.low)}</div>\n                                <div>Close: {formatPrice(data.close)}</div>\n                              </>\n                            ) : (\n                              <>\n                                {yAxisDisplayMode === 'percentage' && data.percentageChange !== undefined ? (\n                                  <div>Change: {data.percentageChange.toFixed(2)}%</div>\n                                ) : (\n                                  <div>Price: {formatPrice(data.close)}</div>\n                                )}\n                              </>\n                            )}\n                            {/* Show CSV overlay information */}\n                            {csvOverlay.length > 0 && (data as any).csvOverlay !== undefined && (data as any).csvOverlay !== null && (\n                              <div style={{ \n                                marginTop: '6px',\n                                paddingTop: '4px',\n                                borderTop: '1px solid rgba(51, 51, 51, 0.5)'\n                              }}>\n                                <div style={{ color: '#FFFFFF', fontSize: '10px' }}>\n                                  CSV Overlay: {(data as any).csvOverlay.toFixed(2)}%\n                                </div>\n                              </div>\n                            )}\n                            {/* Show comparison ticker information */}\n                            {comparisonTickers.length > 0 && comparisonTickers.some(t => (data as any)[`comparison_${t.symbol}`] !== undefined) && (\n                              <div style={{ \n                                marginTop: '6px',\n                                paddingTop: '4px',\n                                borderTop: '1px solid rgba(51, 51, 51, 0.5)'\n                              }}>\n                                {comparisonTickers.map(ticker => {\n                                  const value = (data as any)[`comparison_${ticker.symbol}`];\n                                  if (value === undefined || value === null) return null;\n                                  return (\n                                    <div key={ticker.symbol} style={{ color: ticker.color, fontSize: '10px' }}>\n                                      {ticker.symbol}: {value >= 0 ? '+' : ''}{value.toFixed(2)}%\n                                    </div>\n                                  );\n                                })}\n                              </div>\n                            )}\n                          </div>\n                        );\n                      }}\n\n                    />\n                  )}\n                  \n                  {/* Dynamic chart rendering based on chart type */}\n                  {/* When comparison tickers exist, use overlay axis for unified percentage scaling */}\n                  {chartType === 'line' ? (\n                    <Line\n                      yAxisId={comparisonTickers.length > 0 ? \"overlay\" : \"price\"}\n                      type=\"linear\"\n                      dataKey={yAxisDisplayMode === 'percentage' ? 'percentageChange' : 'close'}\n                      stroke={lineColor}\n                      strokeWidth={2}\n                      dot={false}\n                      name={symbol}\n                      activeDot={{ r: 4, fill: lineColor, stroke: '#121212', strokeWidth: 2 }}\n                    />\n                  ) : chartType === 'candlestick' ? (\n                    <Customized \n                      component={(props: any) => {\n                        const { payload, xAxisMap, yAxisMap } = props;\n                        if (!xAxisMap || !yAxisMap || !chartDataWithMA) return null;\n                        \n                        const xAxis = xAxisMap[0];\n                        const yAxis = yAxisMap.price;\n                        if (!xAxis || !yAxis) return null;\n                        \n                        return (\n                          <g>\n                            {chartDataWithMA.map((data, index) => {\n                              if (!data.open || !data.high || !data.low || !data.close) return null;\n                              \n                              const x = xAxis.x + (index / (chartDataWithMA.length - 1)) * xAxis.width;\n                              const bodyWidth = Math.max(1, xAxis.width / chartDataWithMA.length * 0.6);\n                              \n                              // Calculate Y positions\n                              const priceRange = yAxis.domain[1] - yAxis.domain[0];\n                              const openY = yAxis.y + yAxis.height - ((data.open - yAxis.domain[0]) / priceRange) * yAxis.height;\n                              const closeY = yAxis.y + yAxis.height - ((data.close - yAxis.domain[0]) / priceRange) * yAxis.height;\n                              const highY = yAxis.y + yAxis.height - ((data.high - yAxis.domain[0]) / priceRange) * yAxis.height;\n                              const lowY = yAxis.y + yAxis.height - ((data.low - yAxis.domain[0]) / priceRange) * yAxis.height;\n                              \n                              const isGreen = data.close >= data.open;\n                              const bodyColor = isGreen ? '#22C55E' : '#EF4444';\n                              const wickColor = '#F7F7F7';\n                              \n                              const bodyTop = isGreen ? closeY : openY;\n                              const bodyBottom = isGreen ? openY : closeY;\n                              const bodyHeight = Math.abs(closeY - openY) || 1;\n                              \n                              return (\n                                <g key={index}>\n                                  {/* High-Low Wick */}\n                                  <line\n                                    x1={x}\n                                    y1={highY}\n                                    x2={x}\n                                    y2={lowY}\n                                    stroke={wickColor}\n                                    strokeWidth={1}\n                                  />\n                                  {/* Body */}\n                                  <rect\n                                    x={x - bodyWidth / 2}\n                                    y={bodyTop}\n                                    width={bodyWidth}\n                                    height={bodyHeight}\n                                    fill={bodyColor}\n                                    stroke={bodyColor}\n                                    strokeWidth={1}\n                                  />\n                                </g>\n                              );\n                            })}\n                          </g>\n                        );\n                      }}\n                    />\n                  ) : (\n                    <Area\n                      yAxisId={comparisonTickers.length > 0 ? \"overlay\" : \"price\"}\n                      type=\"linear\" \n                      dataKey={yAxisDisplayMode === 'percentage' ? 'percentageChange' : 'close'}\n                      stroke={lineColor}\n                      strokeWidth={2}\n                      fill={`url(#${isPositive ? 'positiveGradient' : 'negativeGradient'})`}\n                      dot={false}\n                      name={symbol}\n                      activeDot={{ r: 4, fill: lineColor, stroke: '#121212', strokeWidth: 2 }}\n                    />\n                  )}\n                  \n                  {/* Invisible overlay line for candlestick tooltip data */}\n                  {chartType === 'candlestick' && (\n                    <Line \n                      yAxisId=\"price\" \n                      type=\"linear\" \n                      dataKey=\"close\" \n                      strokeOpacity={0} \n                      strokeWidth={1} \n                      dot={false} \n                      activeDot={false} \n                      isAnimationActive={false}\n                      connectNulls\n                    />\n                  )}\n                  \n                  {/* CSV Overlay Line - shows percentage overlay data */}\n                  {csvOverlay.length > 0 && (\n                    <Line\n                      yAxisId=\"overlay\"\n                      type=\"linear\"\n                      dataKey=\"csvOverlay\"\n                      stroke=\"#FFFFFF\"\n                      strokeWidth={2}\n                      dot={false}\n                      name=\"CSV Overlay\"\n                      connectNulls\n                      activeDot={{ r: 4, fill: '#FFFFFF', stroke: '#121212', strokeWidth: 2 }}\n                      isAnimationActive={false}\n                    />\n                  )}\n                  \n                  {/* Comparison Ticker Lines (Task 7) - normalized to percentage change */}\n                  {comparisonTickers.map((ticker) => (\n                    <Line\n                      key={ticker.symbol}\n                      yAxisId=\"overlay\"\n                      type=\"linear\"\n                      dataKey={`comparison_${ticker.symbol}`}\n                      stroke={ticker.color}\n                      strokeWidth={2}\n                      dot={false}\n                      name={ticker.symbol}\n                      connectNulls\n                      activeDot={{ r: 4, fill: ticker.color, stroke: '#121212', strokeWidth: 2 }}\n                      isAnimationActive={false}\n                    />\n                  ))}\n                  \n                  {/* Custom annotation markers and percentage lines */}\n                  <Customized \n                    component={(props: any) => {\n                      const { payload, xAxisMap, yAxisMap } = props;\n                      \n                      const xAxis = xAxisMap[Object.keys(xAxisMap)[0]];\n                      const yAxis = yAxisMap['price'];\n                      \n                      if (!xAxis || !yAxis) return null;\n                      \n                      return (\n                        <g>\n                          {/* Render horizontal annotations using proper Recharts scale */}\n                          {annotations.filter(annotation => annotation.type === 'horizontal').map((annotation) => {\n                            // Helper function to convert stored price to current display mode value\n                            const getDisplayValue = () => {\n                              if (yAxisDisplayMode === 'percentage' && chartDataWithMA?.length > 0) {\n                                // Use first data point as baseline for consistent conversion\n                                const baselinePrice = chartDataWithMA[0]?.close;\n                                if (baselinePrice && baselinePrice > 0) {\n                                  return ((annotation.price - baselinePrice) / baselinePrice) * 100;\n                                }\n                              }\n                              return annotation.price;\n                            };\n                            \n                            const displayValue = getDisplayValue();\n                            // Use Recharts scale for accurate positioning\n                            const y = yAxis.scale(displayValue);\n                            \n                            const isBeingDragged = isDragging && dragAnnotationId === annotation.id;\n                            const lineColor = isBeingDragged ? \"#FFD700\" : \"#AA99FF\";\n                            \n                            const isHovered = hoveredHorizontalId === annotation.id;\n                            const highlightColor = isHovered ? \"#CC99FF\" : lineColor; // Lighter purple when hovered\n                            \n                            return (\n                              <g key={`horizontal-${annotation.id}`}>\n                                {/* Invisible wider line for better hit detection and hover */}\n                                <line\n                                  x1={xAxis.x}\n                                  y1={y}\n                                  x2={xAxis.x + xAxis.width}\n                                  y2={y}\n                                  stroke=\"transparent\"\n                                  strokeWidth={24}\n                                  style={{ cursor: 'pointer' }}\n                                  onMouseEnter={() => setHoveredHorizontalId(annotation.id)}\n                                  onMouseLeave={() => setHoveredHorizontalId(null)}\n                                  onMouseDown={(e) => {\n                                    setIsDragging(true);\n                                    setDragAnnotationId(annotation.id);\n                                    setDragStartY(e.clientY);\n                                    setDragStartPrice(annotation.price);\n                                    e.preventDefault();\n                                    e.stopPropagation();\n                                  }}\n                                />\n                                \n                                {/* Hover highlight background - purple to match line */}\n                                {isHovered && (\n                                  <rect\n                                    x={xAxis.x}\n                                    y={y - 12}\n                                    width={xAxis.width}\n                                    height={24}\n                                    fill=\"rgba(170, 153, 255, 0.15)\"\n                                    style={{ pointerEvents: 'none' }}\n                                  />\n                                )}\n                                \n                                {/* Visible horizontal line */}\n                                <line\n                                  x1={xAxis.x}\n                                  y1={y}\n                                  x2={xAxis.x + xAxis.width}\n                                  y2={y}\n                                  stroke={highlightColor}\n                                  strokeWidth={isBeingDragged ? 3 : (isHovered ? 3 : 2)}\n                                  style={{ pointerEvents: 'none' }}\n                                />\n                                \n                                {/* Price/percentage label on hover - positioned above the line */}\n                                {isHovered && (\n                                  <foreignObject\n                                    x={xAxis.x + 8}\n                                    y={y - 28}\n                                    width={200}\n                                    height={24}\n                                    style={{ overflow: 'visible', pointerEvents: 'none' }}\n                                  >\n                                    <div\n                                      style={{\n                                        display: 'inline-block',\n                                        padding: '2px 8px',\n                                        borderRadius: '4px',\n                                        backgroundColor: '#1a1a1a',\n                                        color: '#AA99FF',\n                                        fontSize: '11px',\n                                        fontWeight: 500,\n                                        border: '1px solid #AA99FF',\n                                        whiteSpace: 'nowrap'\n                                      }}\n                                    >\n                                      {yAxisDisplayMode === 'percentage' \n                                        ? `${displayValue >= 0 ? '+' : ''}${displayValue.toFixed(2)}%`\n                                        : formatPrice(annotation.price)\n                                      }\n                                      {annotation.text && ` - ${annotation.text}`}\n                                    </div>\n                                  </foreignObject>\n                                )}\n                                \n                                {/* Edit button - appears on hover, positioned above the line */}\n                                {isHovered && (\n                                  <foreignObject\n                                    x={xAxis.x + xAxis.width - 60}\n                                    y={y - 28}\n                                    width={55}\n                                    height={24}\n                                    style={{ overflow: 'visible' }}\n                                  >\n                                    <button\n                                      onClick={(e) => {\n                                        e.preventDefault();\n                                        e.stopPropagation();\n                                        handleAnnotationDoubleClick(annotation);\n                                      }}\n                                      style={{\n                                        display: 'flex',\n                                        alignItems: 'center',\n                                        gap: '4px',\n                                        padding: '2px 8px',\n                                        borderRadius: '4px',\n                                        backgroundColor: '#AA99FF',\n                                        color: '#121212',\n                                        fontSize: '11px',\n                                        fontWeight: 600,\n                                        border: 'none',\n                                        cursor: 'pointer',\n                                        boxShadow: '0 2px 4px rgba(0,0,0,0.3)'\n                                      }}\n                                    >\n                                      <Pencil style={{ width: '10px', height: '10px' }} />\n                                      Edit\n                                    </button>\n                                  </foreignObject>\n                                )}\n                              </g>\n                            );\n                          })}\n                          \n                          {annotations.filter(annotation => annotation.type === 'percentage').map((annotation) => {\n                            if (!annotation.endPrice) return null;\n                            \n                            const isBeingDragged = isDragging && dragAnnotationId === annotation.id;\n                            const lineColor = isBeingDragged ? \"#7755CC\" : \"#AA99FF\";\n                            \n                            const x1 = xAxis.scale(annotation.time) + (xAxis.offset?.left || 0);\n                            const y1 = yAxis.scale(annotation.price);\n                            const x2 = xAxis.scale(annotation.endTime || annotation.time) + (xAxis.offset?.left || 0);\n                            const y2 = yAxis.scale(annotation.endPrice);\n                            \n                            return (\n                              <g key={annotation.id}>\n                                {/* Connection line */}\n                                <line\n                                  x1={x1}\n                                  y1={y1}\n                                  x2={x2}\n                                  y2={y2}\n                                  stroke={lineColor}\n                                  strokeWidth={isBeingDragged ? 3 : 2}\n                                  strokeDasharray=\"4 4\"\n                                />\n                                {/* Start point dot */}\n                                <circle\n                                  cx={x1}\n                                  cy={y1}\n                                  r={3}\n                                  fill={lineColor}\n                                  stroke=\"#121212\"\n                                  strokeWidth={1}\n                                  onClick={(e) => {\n                                    e.preventDefault();\n                                    e.stopPropagation();\n                                  }}\n                                  onDoubleClick={(e) => {\n                                    e.preventDefault();\n                                    e.stopPropagation();\n                                    handleAnnotationDoubleClick(annotation);\n                                  }}\n                                />\n                                {/* End point dot */}\n                                <circle\n                                  cx={x2}\n                                  cy={y2}\n                                  r={3}\n                                  fill={lineColor}\n                                  stroke=\"#121212\"\n                                  strokeWidth={1}\n                                  onClick={(e) => {\n                                    e.preventDefault();\n                                    e.stopPropagation();\n                                  }}\n                                  onDoubleClick={(e) => {\n                                    e.preventDefault();\n                                    e.stopPropagation();\n                                    handleAnnotationDoubleClick(annotation);\n                                  }}\n                                />\n                              </g>\n                            );\n                          })}\n                        </g>\n                      );\n                    }}\n                  />\n\n                  {/* Custom grid lines - horizontal dashed, vertical solid */}\n                  {/* Horizontal grid lines (dashed) */}\n                  <CartesianGrid \n                    strokeDasharray=\"3 3\" \n                    stroke=\"#3B3B3B\" \n                    opacity={0.5}\n                    horizontal={true}\n                    vertical={false}\n                  />\n                  {/* Vertical grid lines (solid) */}\n                  <CartesianGrid \n                    stroke=\"#3B3B3B\" \n                    strokeWidth={1}\n                    opacity={0.3}\n                    horizontal={false}\n                    vertical={true}\n                  />\n                  \n                  {/* X-axis with date/time labels */}\n                  <XAxis \n                    dataKey=\"time\"\n                    tickFormatter={(value) => formatTime(value, selectedTimeframe)}\n                    tick={{ fontSize: 12, fill: '#F7F7F7' }}\n                    tickLine={{ stroke: '#F7F7F7' }}\n                    axisLine={{ stroke: '#F7F7F7' }}\n                  />\n\n                  {/* Primary Y-axis for price (right side) - clickable to toggle to percentage view */}\n                  <YAxis \n                    yAxisId=\"price\"\n                    orientation=\"right\"\n                    domain={getPriceAxisDomain()}\n                    allowDataOverflow={priceAxisMode === 'fixed'}\n                    dataKey={yAxisDisplayMode === 'percentage' ? 'percentageChange' : 'close'}\n                    tick={(props) => (\n                      <g \n                        onClick={handleYAxisClick}\n                        style={{ cursor: 'pointer' }}\n                        className=\"group\"\n                      >\n                        <text\n                          x={props.x}\n                          y={props.y}\n                          dx={0}\n                          dy={0}\n                          textAnchor={props.textAnchor}\n                          fill=\"#F7F7F7\"\n                          className=\"group-hover:fill-[#5AF5FA] transition-colors duration-200\"\n                          fontSize={12}\n                        >\n                          {yAxisDisplayMode === 'percentage' ? `${props.payload.value.toFixed(1)}%` : formatPrice(props.payload.value)}\n                        </text>\n                      </g>\n                    )}\n                    axisLine={{ stroke: '#F7F7F7' }}\n                    tickLine={{ stroke: '#F7F7F7' }}\n                    width={60}\n                  />\n                  \n                  {/* Left Y-axis for overlays (CSV and/or Comparison Tickers) */}\n                  {/* When comparing tickers, this becomes the primary axis for all percentage data */}\n                  {(csvOverlay.length > 0 || comparisonTickers.length > 0) && (\n                    <YAxis\n                      yAxisId=\"overlay\"\n                      orientation=\"left\"\n                      domain={\n                        csvOverlay.length > 0 && comparisonTickers.length === 0 \n                          ? [0, 100] \n                          : comparisonPercentageDomain || ['dataMin', 'dataMax']\n                      }\n                      tickFormatter={(value) => `${value.toFixed(1)}%`}\n                      stroke=\"#b0b0b0\"\n                      tick={{ fill: '#b0b0b0', fontSize: 11 }}\n                      width={50}\n                      axisLine={{ stroke: '#b0b0b0' }}\n                      tickLine={{ stroke: '#b0b0b0' }}\n                    />\n                  )}\n                  \n                  {showHoverTooltip && (\n                    <Tooltip \n                      active={!isDragging}\n                      allowEscapeViewBox={{ x: false, y: false }}\n                      cursor={annotationMode ? false : { stroke: '#666', strokeWidth: 1, strokeDasharray: '5 5' }}\n                      content={(props) => {\n                        if (!props.active || !props.payload?.length) return null;\n                        \n                        const data = props.payload[0]?.payload;\n                        if (!data) return null;\n                        \n                        const date = new Date(props.label);\n                        const dateStr = formatTime(props.label, selectedTimeframe);\n                        const timeStr = date.toLocaleTimeString('en-US', { \n                          hour: '2-digit', \n                          minute: '2-digit',\n                          second: '2-digit',\n                          hour12: false \n                        });\n                        \n                        return (\n                          <div style={{\n                            backgroundColor: 'rgba(18, 18, 18, 0.7)',\n                            border: '1px solid rgba(51, 51, 51, 0.5)',\n                            borderRadius: '6px',\n                            color: '#F7F7F7',\n                            padding: '6px 10px',\n                            fontSize: '11px',\n                            opacity: 0.8\n                          }}>\n                            <div style={{ \n                              marginBottom: '6px', \n                              lineHeight: '1.4',\n                              paddingBottom: '3px',\n                              borderBottom: '1px solid rgba(51, 51, 51, 0.5)'\n                            }}>{`${dateStr} ${timeStr}`}</div>\n                            {chartType === 'candlestick' && data.open && data.high && data.low && data.close ? (\n                              <>\n                                <div>Open: {formatPrice(data.open)}</div>\n                                <div>High: {formatPrice(data.high)}</div>\n                                <div>Low: {formatPrice(data.low)}</div>\n                                <div>Close: {formatPrice(data.close)}</div>\n                              </>\n                            ) : (\n                              <>\n                                {yAxisDisplayMode === 'percentage' && data.percentageChange !== undefined ? (\n                                  <div>Change: {data.percentageChange.toFixed(2)}%</div>\n                                ) : (\n                                  <div>Price: {formatPrice(data.close)}</div>\n                                )}\n                              </>\n                            )}\n                            {/* Show CSV overlay information */}\n                            {csvOverlay.length > 0 && (data as any).csvOverlay !== undefined && (data as any).csvOverlay !== null && (\n                              <div style={{ \n                                marginTop: '6px',\n                                paddingTop: '4px',\n                                borderTop: '1px solid rgba(51, 51, 51, 0.5)'\n                              }}>\n                                <div style={{ color: '#FFFFFF', fontSize: '10px' }}>\n                                  CSV Overlay: {(data as any).csvOverlay.toFixed(2)}%\n                                </div>\n                              </div>\n                            )}\n                            {/* Show comparison ticker information */}\n                            {comparisonTickers.length > 0 && comparisonTickers.some(t => (data as any)[`comparison_${t.symbol}`] !== undefined) && (\n                              <div style={{ \n                                marginTop: '6px',\n                                paddingTop: '4px',\n                                borderTop: '1px solid rgba(51, 51, 51, 0.5)'\n                              }}>\n                                {comparisonTickers.map(ticker => {\n                                  const value = (data as any)[`comparison_${ticker.symbol}`];\n                                  if (value === undefined || value === null) return null;\n                                  return (\n                                    <div key={ticker.symbol} style={{ color: ticker.color, fontSize: '10px' }}>\n                                      {ticker.symbol}: {value >= 0 ? '+' : ''}{value.toFixed(2)}%\n                                    </div>\n                                  );\n                                })}\n                              </div>\n                            )}\n                          </div>\n                        );\n                      }}\n\n                    />\n                  )}\n                  \n                  \n                  {/* Text Annotation Reference Lines - yellow vertical lines */}\n                  {annotations.filter(annotation => annotation.type === 'text').map((annotation) => (\n                    <ReferenceLine \n                      key={annotation.id}\n                      x={annotation.time}\n                      yAxisId=\"price\"\n                      stroke=\"#FAFF50\"\n                      strokeWidth={1}\n                      vectorEffect=\"non-scaling-stroke\"\n                      shapeRendering=\"crispEdges\"\n                    />\n                  ))}\n\n                  {/* Horizontal Annotation Reference Lines - purple styling */}\n                  {annotations.filter(annotation => annotation.type === 'horizontal').map((annotation) => {\n                    const isBeingDragged = isDragging && dragAnnotationId === annotation.id;\n                    const lineColor = isBeingDragged ? \"#7755CC\" : \"#AA99FF\"; // Darker purple when dragging\n                    return (\n                      <ReferenceLine \n                        key={annotation.id}\n                        y={annotation.price}\n                        yAxisId=\"price\"\n                        stroke={lineColor}\n                        strokeWidth={isBeingDragged ? 3 : 2}\n                        vectorEffect=\"non-scaling-stroke\"\n                        shapeRendering=\"crispEdges\"\n                      />\n                    );\n                  })}\n\n\n                  {/* Click Capture Overlay for Annotations - only active in annotation mode */}\n                  {annotationMode === 'percentage' && (\n                    <Customized \n                      component={(props: any) => {\n                        const { offset, xAxisMap, payload } = props;\n                        if (!offset || !xAxisMap || !chartDataWithMA) return null;\n                        \n                        const xAxis = xAxisMap[0];\n                        if (!xAxis) return null;\n                      \n                      const handleOverlayClick = (e: React.MouseEvent) => {\n                        if (!chartDataWithMA) return;\n                        \n                        // Get SVG coordinates with fallback\n                        const svg = (e.currentTarget as SVGElement).ownerSVGElement;\n                        let relativeX: number;\n                        \n                        if (svg && svg.getScreenCTM()) {\n                          // Preferred method: SVG coordinate transformation\n                          const pt = svg.createSVGPoint();\n                          pt.x = e.clientX;\n                          pt.y = e.clientY;\n                          const inverse = svg.getScreenCTM()?.inverse();\n                          if (inverse) {\n                            const svgCoords = pt.matrixTransform(inverse);\n                            relativeX = svgCoords.x - offset.left;\n                          } else {\n                            // Fallback: use bounding rect\n                            const rect = svg.getBoundingClientRect();\n                            relativeX = e.clientX - rect.left - offset.left;\n                          }\n                        } else {\n                          // Fallback: use element bounding rect\n                          const rect = e.currentTarget.getBoundingClientRect();\n                          relativeX = e.clientX - rect.left;\n                        }\n                        \n                        // Find closest data point by x coordinate\n                        const xPercent = Math.max(0, Math.min(relativeX / offset.width, 1));\n                        const dataIndex = Math.round(xPercent * (chartDataWithMA.length - 1));\n                        const clampedIndex = Math.max(0, Math.min(dataIndex, chartDataWithMA.length - 1));\n                        const clickedData = chartDataWithMA[clampedIndex];\n                        \n                        if (clickedData) {\n                          // Create synthetic event for handleChartClick\n                          const syntheticEvent = {\n                            activePayload: [{ payload: clickedData }],\n                            activeLabel: clickedData.time\n                          };\n                          handleChartClick(syntheticEvent);\n                        }\n                      };\n                      \n                      return (\n                        <rect\n                          x={offset.left}\n                          y={offset.top}\n                          width={offset.width}\n                          height={offset.height}\n                          fill=\"transparent\"\n                          style={{ pointerEvents: 'all', cursor: 'crosshair' }}\n                          onClick={handleOverlayClick}\n                        />\n                      );\n                    }}\n                  />\n                  )}\n\n                  {/* Percentage Measurement Lines - white diagonal arrows */}\n                  <Customized \n                    component={(props: any) => {\n                      const { payload, xAxisMap, yAxisMap } = props;\n                      if (!xAxisMap || !yAxisMap || !chartData?.data) return null;\n                      \n                      const xAxis = xAxisMap[0];\n                      const yAxis = yAxisMap.price;\n                      if (!xAxis || !yAxis) return null;\n                      \n                      return (\n                        <g>\n                          {annotations.filter(annotation => \n                            annotation.type === 'percentage' && \n                            annotation.startTimestamp && \n                            annotation.endTimestamp &&\n                            annotation.startPrice !== undefined &&\n                            annotation.endPrice !== undefined\n                          ).map((annotation) => {\n                            const startIndex = chartData.data.findIndex(d => d.timestamp === annotation.startTimestamp);\n                            const endIndex = chartData.data.findIndex(d => d.timestamp === annotation.endTimestamp);\n                            if (startIndex === -1 || endIndex === -1) return null;\n                            \n                            // Calculate positions using chart coordinate system\n                            const x1 = xAxis.x + (startIndex / (chartData.data.length - 1)) * xAxis.width;\n                            const x2 = xAxis.x + (endIndex / (chartData.data.length - 1)) * xAxis.width;\n                            \n                            // Convert stored prices to appropriate coordinate system for current display mode\n                            let startValue = annotation.startPrice!;\n                            let endValue = annotation.endPrice!;\n                            \n                            if (yAxisDisplayMode === 'percentage' && chartData?.data?.length > 0) {\n                              // Find baseline price (first data point's close price)\n                              const baselinePrice = chartData.data[0]?.close;\n                              if (baselinePrice && baselinePrice > 0) {\n                                // Convert stored prices to percentage change from baseline\n                                startValue = ((annotation.startPrice! - baselinePrice) / baselinePrice) * 100;\n                                endValue = ((annotation.endPrice! - baselinePrice) / baselinePrice) * 100;\n                              }\n                            }\n                            \n                            // Map values to Y coordinates - ensure they stay within chart bounds\n                            const valueRange = yAxis.domain[1] - yAxis.domain[0];\n                            const rawY1 = yAxis.y + yAxis.height - ((startValue - yAxis.domain[0]) / valueRange) * yAxis.height;\n                            const rawY2 = yAxis.y + yAxis.height - ((endValue - yAxis.domain[0]) / valueRange) * yAxis.height;\n                            // Clamp Y coordinates to stay within chart area\n                            const y1 = Math.max(yAxis.y, Math.min(rawY1, yAxis.y + yAxis.height));\n                            const y2 = Math.max(yAxis.y, Math.min(rawY2, yAxis.y + yAxis.height));\n                            \n                            const isPositive = (annotation.percentage || 0) >= 0;\n                            const lineColor = isPositive ? '#22C55E' : '#EF4444'; // Green for positive, red for negative\n                            \n                            // Calculate arrow direction\n                            const arrowSize = 12;\n                            const angle = Math.atan2(y2 - y1, x2 - x1);\n                            \n                            // Arrow head points\n                            const arrowX1 = x2 - arrowSize * Math.cos(angle - Math.PI / 6);\n                            const arrowY1 = y2 - arrowSize * Math.sin(angle - Math.PI / 6);\n                            const arrowX2 = x2 - arrowSize * Math.cos(angle + Math.PI / 6);\n                            const arrowY2 = y2 - arrowSize * Math.sin(angle + Math.PI / 6);\n                            \n                            // Calculate text box position\n                            const textBoxWidth = 240;\n                            const textBoxHeight = 80;\n                            const textBoxX = Math.min(x2 + 10, xAxis.x + xAxis.width - textBoxWidth);\n                            const midY = (y1 + y2) / 2;\n                            const textBoxY = Math.max(yAxis.y, Math.min(midY - textBoxHeight / 2, yAxis.y + yAxis.height - textBoxHeight));\n\n                            return (\n                              <g key={annotation.id} style={{ cursor: 'pointer' }}>\n                                {/* Main line */}\n                                <line\n                                  x1={x1}\n                                  y1={y1}\n                                  x2={x2}\n                                  y2={y2}\n                                  stroke={lineColor}\n                                  strokeWidth={2}\n                                  vectorEffect=\"non-scaling-stroke\"\n                                  onClick={(e) => {\n                                    e.preventDefault();\n                                    e.stopPropagation();\n                                  }}\n                                  onDoubleClick={(e) => {\n                                    e.preventDefault();\n                                    e.stopPropagation();\n                                    handleAnnotationDoubleClick(annotation);\n                                  }}\n                                />\n                                {/* Arrow head - outlined instead of filled */}\n                                <polygon\n                                  points={`${x2},${y2} ${arrowX1},${arrowY1} ${arrowX2},${arrowY2}`}\n                                  fill=\"none\"\n                                  stroke={lineColor}\n                                  strokeWidth={2}\n                                  strokeLinejoin=\"round\"\n                                  onClick={(e) => {\n                                    e.preventDefault();\n                                    e.stopPropagation();\n                                  }}\n                                  onDoubleClick={(e) => {\n                                    e.preventDefault();\n                                    e.stopPropagation();\n                                    handleAnnotationDoubleClick(annotation);\n                                  }}\n                                />\n                                {/* Start point dot */}\n                                <circle\n                                  cx={x1}\n                                  cy={y1}\n                                  r={3}\n                                  fill={lineColor}\n                                  stroke=\"#121212\"\n                                  strokeWidth={1}\n                                  onClick={(e) => {\n                                    e.preventDefault();\n                                    e.stopPropagation();\n                                  }}\n                                  onDoubleClick={(e) => {\n                                    e.preventDefault();\n                                    e.stopPropagation();\n                                    handleAnnotationDoubleClick(annotation);\n                                  }}\n                                />\n                                {/* End point dot */}\n                                <circle\n                                  cx={x2}\n                                  cy={y2}\n                                  r={3}\n                                  fill={lineColor}\n                                  stroke=\"#121212\"\n                                  strokeWidth={1}\n                                  onClick={(e) => {\n                                    e.preventDefault();\n                                    e.stopPropagation();\n                                  }}\n                                  onDoubleClick={(e) => {\n                                    e.preventDefault();\n                                    e.stopPropagation();\n                                    handleAnnotationDoubleClick(annotation);\n                                  }}\n                                />\n                                \n                                {/* Percentage text box - COMPLETELY REMOVED per user request to eliminate duplicate */}\n                              </g>\n                            );\n                          })}\n                        </g>\n                      );\n                    }}\n                  />\n\n                </ComposedChart>\n              </ResponsiveContainer>\n              \n              \n            </div>\n\n            {/* Spacing between charts */}\n            <div className=\"my-3\"></div>\n\n            {/* Volume Bar Chart - Below with spacing */}\n            <div className=\"h-40 w-full mt-2 relative volume-chart-container\">\n              <ResponsiveContainer width=\"100%\" height=\"100%\">\n                <ComposedChart \n                  data={chartDataWithMA}\n                  margin={{ top: -15, right: 0, left: 0, bottom: 15 }}\n                >\n                  {/* Custom grid lines - horizontal dashed, vertical solid */}\n                  {/* Horizontal grid lines (dashed) */}\n                  <CartesianGrid \n                    strokeDasharray=\"3 3\" \n                    stroke=\"#3B3B3B\" \n                    opacity={0.5}\n                    horizontal={true}\n                    vertical={false}\n                  />\n                  {/* Vertical grid lines (solid) */}\n                  <CartesianGrid \n                    stroke=\"#3B3B3B\" \n                    strokeWidth={1}\n                    opacity={0.3}\n                    horizontal={false}\n                    vertical={true}\n                  />\n                  \n                  <XAxis \n                    dataKey=\"time\"\n                    tickFormatter={(value) => formatTime(value, selectedTimeframe)}\n                    tick={{ fontSize: 12, fill: '#F7F7F7' }}\n                    axisLine={{ stroke: '#F7F7F7' }}\n                    tickLine={{ stroke: '#F7F7F7' }}\n                  />\n                  \n                  <YAxis \n                    orientation=\"right\"\n                    tickFormatter={(value) => formatNumber(value)}\n                    tick={{ fontSize: 12, fill: '#F7F7F7' }}\n                    axisLine={{ stroke: '#F7F7F7', strokeDasharray: 'none' }}\n                    tickLine={{ stroke: '#F7F7F7' }}\n                    width={60}\n                    type=\"number\"\n                    domain={[0, 'dataMax']}\n                  />\n                  \n                  {showHoverTooltip && (\n                    <Tooltip \n                      active={!isDragging}\n                      allowEscapeViewBox={{ x: false, y: false }}\n\n                      formatter={(value: number, name: string, props: any) => {\n                        if (name === 'volume') {\n                          return [\n                            <span style={{ color: '#AA99FF' }}>{formatNumber(value)}</span>, \n                            <span style={{ color: '#F7F7F7' }}>Volume</span>\n                          ];\n                        } else if (name === 'volumeMA') {\n                          return [\n                            <span style={{ color: '#F7F7F7' }}>{formatNumber(value)}</span>, \n                            <span style={{ color: '#F7F7F7' }}>20-Day MA</span>\n                          ];\n                        }\n                        return [formatNumber(value), name];\n                      }}\n                      contentStyle={{\n                        backgroundColor: '#121212',\n                        border: '1px solid #333333',\n                        borderRadius: '6px',\n                        color: '#F7F7F7',\n                        fontSize: '12px'\n                      }}\n                    />\n                  )}\n                  \n                  <Bar \n                    dataKey=\"volume\" \n                    opacity={0.7}\n                    radius={[1, 1, 0, 0]}\n                    fill=\"#AA99FF\"\n                  />\n                  \n                  {/* Volume Moving Average Line */}\n                  <Line \n                    dataKey=\"volumeMA\" \n                    stroke=\"#F7F7F7\" \n                    strokeWidth={2}\n                    dot={false}\n                    connectNulls={true}\n                    type=\"linear\"\n                  />\n\n                  {/* Earnings Markers - moved to volume chart */}\n                  <Customized \n                    component={(props: any) => {\n                      const { payload, xAxisMap, yAxisMap } = props;\n                      if (!earningsData?.earnings || !chartData?.data) return null;\n                      \n                      const xAxis = xAxisMap[Object.keys(xAxisMap)[0]];\n                      const yAxis = yAxisMap[Object.keys(yAxisMap)[0]];\n                      \n                      if (!xAxis || !yAxis) return null;\n                      \n                      return (\n                        <>\n                          {earningsData.earnings.map((earning: any, index: number) => {\n                            // Find if this earnings date falls within our chart data\n                            // Parse the date at noon UTC to avoid timezone issues with date-only strings\n                            const earningsDate = new Date(earning.date + 'T12:00:00Z');\n                            const earningsTime = earningsDate.toISOString();\n                            \n                            // Find the closest data point in chart (not just any within 24 hours)\n                            let closestDataPoint = null;\n                            let minTimeDiff = Infinity;\n                            \n                            for (const d of chartData.data) {\n                              const chartDate = new Date(d.time);\n                              const timeDiff = Math.abs(chartDate.getTime() - earningsDate.getTime());\n                              \n                              // Only consider points within 2 days (earnings could be pre/post market)\n                              if (timeDiff < 2 * 24 * 60 * 60 * 1000 && timeDiff < minTimeDiff) {\n                                minTimeDiff = timeDiff;\n                                closestDataPoint = d;\n                              }\n                            }\n                            \n                            const dataPoint = closestDataPoint;\n                            \n                            if (!dataPoint) return null;\n                            \n                            // Calculate position using chart scales - positioned in volume chart area\n                            const x = xAxis.scale(dataPoint.time) + (xAxis.offset?.left || 0);\n                            const y = xAxis.y - 25; // Position above volume chart timeline\n                            \n                            return (\n                              <g \n                                key={`earning-${earning.date}-${index}`}\n                                style={{ cursor: 'pointer' }}\n                                onClick={(e) => {\n                                  e.preventDefault();\n                                  e.stopPropagation();\n                                  setEarningsModal({\n                                    visible: true,\n                                    data: earning\n                                  });\n                                }}\n                              >\n                                {/* Yellow circle */}\n                                <circle\n                                  cx={x}\n                                  cy={y}\n                                  r={8}\n                                  fill=\"#FAFF50\"\n                                  stroke=\"#121212\"\n                                  strokeWidth={1}\n                                />\n                                {/* 'E' text inside circle */}\n                                <text\n                                  x={x}\n                                  y={y + 2}\n                                  textAnchor=\"middle\"\n                                  fontSize={10}\n                                  fontWeight=\"bold\"\n                                  fill=\"#121212\"\n                                  style={{ pointerEvents: 'none' }}\n                                >\n                                  E\n                                </text>\n                              </g>\n                            );\n                          })}\n                        </>\n                      );\n                    }}\n                  />\n\n                </ComposedChart>\n              </ResponsiveContainer>\n            </div>\n          </div>\n        )}\n        </TabsContent>\n\n      {/* Annotation Input Modal */}\n      {showAnnotationInput && (pendingAnnotation || editingAnnotation) && (\n        <div className=\"fixed inset-0 bg-black/50 flex items-center justify-center z-50\">\n          <div className=\"border border-border rounded-lg p-6 w-96 max-w-[90vw]\" style={{ backgroundColor: '#3A3A3A' }}>\n            <h3 className=\"text-lg font-semibold mb-4\">\n              {isEditMode ? 'Edit Annotation' : (pendingAnnotation?.type === 'horizontal' ? 'Add Horizontal Line' : 'Add Annotation')}\n            </h3>\n            \n            {/* For horizontal annotations, show price/percentage input */}\n            {(pendingAnnotation?.type === 'horizontal' || editingAnnotation?.type === 'horizontal') && (\n              <div className=\"mb-4\">\n                <label className=\"block text-sm font-medium mb-2\">\n                  {yAxisDisplayMode === 'percentage' ? 'Percentage Value' : 'Price Level'}\n                </label>\n                <div className=\"flex items-center gap-2\">\n                  {yAxisDisplayMode !== 'percentage' && (\n                    <span className=\"text-muted-foreground\">{getCurrencySymbol((stockDetails?.profile as any)?.currency)}</span>\n                  )}\n                  <input\n                    type=\"number\"\n                    step=\"any\"\n                    value={horizontalPriceInput}\n                    onChange={(e) => setHorizontalPriceInput(e.target.value)}\n                    placeholder={yAxisDisplayMode === 'percentage' ? 'e.g. -5.25' : 'e.g. 150.50'}\n                    className=\"flex-1 px-3 py-2 border border-border rounded-md bg-background text-foreground focus:outline-none focus:ring-2 focus:ring-[#5AF5FA]\"\n                    autoFocus\n                    onKeyDown={(e) => {\n                      if (e.key === 'Enter') {\n                        e.preventDefault();\n                      } else if (e.key === 'Escape') {\n                        cancelAnnotation();\n                      }\n                    }}\n                  />\n                  {yAxisDisplayMode === 'percentage' && (\n                    <span className=\"text-muted-foreground\">%</span>\n                  )}\n                </div>\n                <p className=\"text-xs text-muted-foreground mt-1\">\n                  {yAxisDisplayMode === 'percentage' \n                    ? 'Enter the percentage level for the horizontal line' \n                    : 'Enter the exact price for the horizontal line'}\n                </p>\n              </div>\n            )}\n            \n            {/* Show time/price info for non-horizontal annotations */}\n            {pendingAnnotation?.type !== 'horizontal' && editingAnnotation?.type !== 'horizontal' && (\n              <div className=\"mb-4 text-sm text-muted-foreground\">\n                <div>Time: {isEditMode ? editingAnnotation?.time : pendingAnnotation?.time}</div>\n                <div>Price: {formatPrice(isEditMode ? editingAnnotation?.price || 0 : pendingAnnotation?.price || 0)}</div>\n              </div>\n            )}\n            \n            <div className=\"mb-4\">\n              <label className=\"block text-sm font-medium mb-2\">\n                {(pendingAnnotation?.type === 'horizontal' || editingAnnotation?.type === 'horizontal') ? 'Label (optional)' : 'Event Description'}\n              </label>\n              <textarea\n                value={annotationInput}\n                onChange={(e) => setAnnotationInput(e.target.value)}\n                placeholder={(pendingAnnotation?.type === 'horizontal' || editingAnnotation?.type === 'horizontal') ? 'e.g. Support level, Target price...' : 'Enter event description...'}\n                className=\"w-full h-24 px-3 py-2 border border-border rounded-md bg-background text-foreground resize-none focus:outline-none focus:ring-2 focus:ring-primary\"\n                autoFocus={pendingAnnotation?.type !== 'horizontal' && editingAnnotation?.type !== 'horizontal'}\n                onKeyDown={(e) => {\n                  if (e.key === 'Enter' && e.ctrlKey) {\n                    saveAnnotation();\n                  } else if (e.key === 'Escape') {\n                    cancelAnnotation();\n                  }\n                }}\n              />\n            </div>\n            <div className=\"flex gap-2 justify-end\">\n              <Button variant=\"outline\" onClick={cancelAnnotation}>\n                Cancel\n              </Button>\n              {isEditMode && (\n                <Button \n                  variant=\"destructive\"\n                  onClick={deleteAnnotation}\n                  className=\"bg-red-600 text-white hover:bg-red-700\"\n                >\n                  Delete\n                </Button>\n              )}\n              <Button \n                onClick={saveAnnotation}\n                disabled={(pendingAnnotation?.type === 'horizontal' || editingAnnotation?.type === 'horizontal') \n                  ? !horizontalPriceInput.trim() \n                  : !annotationInput.trim()}\n                className=\"bg-[#5AF5FA] text-black hover:bg-[#5AF5FA]/90\"\n              >\n                {isEditMode ? 'Update' : 'Save'}\n              </Button>\n            </div>\n            <div className=\"mt-2 text-xs text-muted-foreground\">\n              Press Ctrl+Enter to save, Escape to cancel\n            </div>\n          </div>\n        </div>\n      )}\n\n      {/* CSV Overlay Modal */}\n      {showCsvModal && (\n        <Dialog open={showCsvModal} onOpenChange={setShowCsvModal}>\n          <DialogContent className=\"bg-[#1E1E1E] border-[#474747]\">\n            <DialogHeader>\n              <DialogTitle className=\"text-[#f7f7f7]\">\n                {csvOverlay.length > 0 ? 'Manage CSV Overlay' : 'Add % Overlay (CSV)'}\n              </DialogTitle>\n              <DialogDescription className=\"text-[#b0b0b0]\">\n                {csvOverlay.length > 0 \n                  ? `You have ${csvOverlay.length} CSV data points currently overlaid on the chart.`\n                  : 'Upload or paste CSV data to add a percentage overlay to the chart.'\n                }\n              </DialogDescription>\n            </DialogHeader>\n            <div className=\"space-y-4\">\n              {/* Show current CSV data info if exists */}\n              {csvOverlay.length > 0 && (\n                <div className=\"bg-[#2A2A2A] p-4 rounded-md text-sm border-l-4 border-[#5AF5FA]\">\n                  <p className=\"font-semibold text-[#f7f7f7] mb-2\">Current CSV Overlay</p>\n                  <div className=\"text-[#b0b0b0] space-y-1\">\n                    <p>Data points: {csvOverlay.length}</p>\n                    <p>Date range: {format(new Date(csvOverlay[0]?.timestamp || 0), 'MMM dd, yyyy')} to {format(new Date(csvOverlay[csvOverlay.length - 1]?.timestamp || 0), 'MMM dd, yyyy')}</p>\n                  </div>\n                  <Button\n                    variant=\"destructive\"\n                    onClick={() => {\n                      setCsvOverlay([]);\n                      toast({\n                        title: \"CSV Overlay Deleted\",\n                        description: \"You can now upload new CSV data below.\",\n                      });\n                    }}\n                    className=\"mt-3 w-full\"\n                    data-testid=\"button-delete-csv-overlay\"\n                  >\n                    <Trash2 className=\"w-4 h-4 mr-2\" />\n                    Delete Current CSV Overlay\n                  </Button>\n                </div>\n              )}\n              \n              {/* Always show upload interface */}\n              <div className=\"bg-[#2A2A2A] p-4 rounded-md text-sm\">\n                <p className=\"font-semibold text-[#f7f7f7] mb-2\">CSV Format Requirements</p>\n                <ul className=\"list-disc list-inside space-y-1 text-[#b0b0b0]\">\n                  <li>Two columns only: date, value</li>\n                  <li>date must be in YYYY-MM-DD format</li>\n                  <li>value must be a decimal between 0 and 1 (0% to 100%)</li>\n                  <li>No header row (first line is data)</li>\n                </ul>\n                <p className=\"mt-3 text-[#b0b0b0]\">Example:</p>\n                <pre className=\"mt-1 text-xs bg-[#1E1E1E] p-2 rounded\">\n2025-06-06,0.0255\n2025-06-09,0.0325\n2025-09-19,1\n                </pre>\n              </div>\n              \n              <Textarea\n                placeholder=\"Paste CSV data here...\"\n                className=\"min-h-[200px] bg-[#2A2A2A] border-[#474747] text-[#f7f7f7]\"\n                id=\"csv-textarea\"\n              />\n              \n              <div className=\"flex gap-2\">\n                <input\n                  type=\"file\"\n                  accept=\".csv\"\n                  className=\"hidden\"\n                  id=\"csv-upload\"\n                />\n                <Button\n                  variant=\"outline\"\n                  onClick={() => document.getElementById('csv-upload')?.click()}\n                  className=\"flex-1\"\n                >\n                  Upload CSV File\n                </Button>\n                <Button\n                  onClick={handleCsvSubmit}\n                  className=\"flex-1\"\n                >\n                  {csvOverlay.length > 0 ? 'Replace Overlay' : 'Apply Overlay'}\n                </Button>\n              </div>\n            </div>\n          </DialogContent>\n        </Dialog>\n      )}\n\n      {/* Earnings Modal Lightbox */}\n      {earningsModal.visible && earningsModal.data && (\n        <div\n          className=\"fixed inset-0 z-50 flex items-center justify-center bg-black/50 backdrop-blur-sm\"\n          onClick={() => setEarningsModal({ visible: false, data: null })}\n        >\n          <div\n            className=\"border border-border rounded-lg shadow-2xl p-6 max-w-md w-full mx-4 relative\"\n            style={{ backgroundColor: '#3A3A3A' }}\n            onClick={(e) => e.stopPropagation()}\n          >\n            {/* Close Button */}\n            <button\n              className=\"absolute top-4 right-4 w-8 h-8 rounded-full bg-muted hover:bg-muted/80 flex items-center justify-center text-muted-foreground hover:text-foreground transition-colors\"\n              onClick={() => setEarningsModal({ visible: false, data: null })}\n              aria-label=\"Close earnings modal\"\n            >\n              \n            </button>\n            \n            {/* Modal Content */}\n            <div className=\"pr-8\">\n              <div className=\"flex items-center gap-2 mb-4\">\n                <div className=\"w-8 h-8 bg-[#FAFF50] rounded-full flex items-center justify-center\">\n                  <span className=\"text-black font-bold text-sm\">E</span>\n                </div>\n                <div className=\"font-semibold text-lg\">\n                  {symbol ? `${symbol} Quarterly Earnings` : 'Quarterly Earnings'}\n                </div>\n              </div>\n              \n              <div className=\"space-y-3 text-sm\">\n                <div className=\"flex justify-between gap-4\">\n                  <span className=\"text-muted-foreground\">Date:</span>\n                  <span className=\"font-medium\">{new Date(earningsModal.data.date).toLocaleDateString()}</span>\n                </div>\n                <div className=\"flex justify-between gap-4\">\n                  <span className=\"text-muted-foreground\">Quarter:</span>\n                  <span className=\"font-medium\">Q{earningsModal.data.quarter} {earningsModal.data.year}</span>\n                </div>\n                \n                {/* EPS Section */}\n                <div className=\"pt-2 border-t border-border\">\n                  <div className=\"font-medium text-[#5AF5FA] mb-2\">Earnings Per Share</div>\n                  {earningsModal.data.epsActual !== null && (\n                    <div className=\"flex justify-between gap-4\">\n                      <span className=\"text-muted-foreground\">EPS Actual:</span>\n                      <span className=\"font-medium text-[#5AF5FA]\">{formatPrice(earningsModal.data.epsActual)}</span>\n                    </div>\n                  )}\n                  {earningsModal.data.epsEstimate !== null && (\n                    <div className=\"flex justify-between gap-4\">\n                      <span className=\"text-muted-foreground\">EPS Estimate:</span>\n                      <span className=\"font-medium\">{formatPrice(earningsModal.data.epsEstimate)}</span>\n                    </div>\n                  )}\n                  {earningsModal.data.epsActual !== null && earningsModal.data.epsEstimate !== null && (\n                    <div className=\"flex justify-between gap-4 mt-2 pt-2 border-t border-border/50\">\n                      <span className=\"text-muted-foreground\">Beat/Miss:</span>\n                      <span className={`font-medium ${\n                        earningsModal.data.epsActual >= earningsModal.data.epsEstimate \n                          ? 'text-green-500' \n                          : 'text-red-500'\n                      }`}>\n                        {earningsModal.data.epsActual >= earningsModal.data.epsEstimate ? ' Beat' : ' Miss'}\n                      </span>\n                    </div>\n                  )}\n                </div>\n                \n                {/* Revenue Section */}\n                {(earningsModal.data.revenueActual !== null || earningsModal.data.revenueEstimate !== null) && (\n                  <div className=\"pt-3 border-t border-border\">\n                    <div className=\"font-medium text-[#5AF5FA] mb-2\">Revenue</div>\n                    {earningsModal.data.revenueActual !== null && (\n                      <div className=\"flex justify-between gap-4\">\n                        <span className=\"text-muted-foreground\">Revenue Actual:</span>\n                        <span className=\"font-medium text-[#5AF5FA]\">{formatRevenue(earningsModal.data.revenueActual)}</span>\n                      </div>\n                    )}\n                    {earningsModal.data.revenueEstimate !== null && (\n                      <div className=\"flex justify-between gap-4\">\n                        <span className=\"text-muted-foreground\">Revenue Estimate:</span>\n                        <span className=\"font-medium\">{formatRevenue(earningsModal.data.revenueEstimate)}</span>\n                      </div>\n                    )}\n                  </div>\n                )}\n              </div>\n            </div>\n          </div>\n        </div>\n      )}\n        \n        <TabsContent value=\"comparison\" className=\"bg-background relative z-10\" data-testid=\"tabpanel-comparison\">\n          <ComparisonChart \n            timeframe={selectedTimeframe} \n            startDate={startDate} \n            endDate={endDate}\n            singleTradingDay={singleTradingDay}\n            annotations={annotations}\n            onAnnotationsChange={onAnnotationsChange}\n            annotationMode={annotationMode}\n            pendingPercentageStart={pendingPercentageStart}\n            setPendingPercentageStart={setPendingPercentageStart}\n            updateAnnotations={updateAnnotations}\n            showHoverTooltip={showHoverTooltip}\n            onZoomIn={(fn) => { if (fn && typeof fn === 'function') comparisonZoomInRef.current = fn; }}\n            onZoomOut={(fn) => { if (fn && typeof fn === 'function') comparisonZoomOutRef.current = fn; }}\n            onFitToData={(fn) => { if (fn && typeof fn === 'function') comparisonFitToDataRef.current = fn; }}\n          />\n        </TabsContent>\n      </Tabs>\n\n      {/* Stats Grid - 4 Columns */}\n      {stockDetails && stockDetails.quote && (\n        <div className=\"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 text-sm\">\n          {/* Column 1 */}\n          <div className=\"space-y-3\">\n            <div className=\"flex justify-between\">\n              <span className=\"text-muted-foreground\">Previous Close</span>\n              <span className=\"font-medium\">{formatPrice(stockDetails.quote.pc)}</span>\n            </div>\n            <div className=\"flex justify-between\">\n              <span className=\"text-muted-foreground\">Open</span>\n              <span className=\"font-medium\">{formatPrice(stockDetails.quote.o)}</span>\n            </div>\n            <div className=\"flex justify-between\">\n              <span className=\"text-muted-foreground\">Bid</span>\n              <span className=\"font-medium\">N/A</span>\n            </div>\n            <div className=\"flex justify-between\">\n              <span className=\"text-muted-foreground\">Ask</span>\n              <span className=\"font-medium\">N/A</span>\n            </div>\n          </div>\n\n          {/* Column 2 */}\n          <div className=\"space-y-3\">\n            <div className=\"flex justify-between\">\n              <span className=\"text-muted-foreground\">Day's Range</span>\n              <span className=\"font-medium\">{formatPrice(stockDetails.quote.l)} - {formatPrice(stockDetails.quote.h)}</span>\n            </div>\n            <div className=\"flex justify-between\">\n              <span className=\"text-muted-foreground\">52 Week Range</span>\n              <span className=\"font-medium\">\n                {stockDetails.metrics[\"52WeekLow\"] && stockDetails.metrics[\"52WeekHigh\"] \n                  ? `${formatPrice(stockDetails.metrics[\"52WeekLow\"])} - ${formatPrice(stockDetails.metrics[\"52WeekHigh\"])}`\n                  : 'N/A'\n                }\n              </span>\n            </div>\n            <div className=\"flex justify-between\">\n              <span className=\"text-muted-foreground\">Volume</span>\n              <span className=\"font-medium\">N/A</span>\n            </div>\n            <div className=\"flex justify-between\">\n              <span className=\"text-muted-foreground\">Avg. Volume</span>\n              <span className=\"font-medium\">N/A</span>\n            </div>\n          </div>\n\n          {/* Column 3 */}\n          <div className=\"space-y-3\">\n            <div className=\"flex justify-between\">\n              <span className=\"text-muted-foreground\">Market Cap</span>\n              <span className=\"font-medium\">{stockDetails.profile?.marketCapitalization ? formatMarketCap(stockDetails.profile.marketCapitalization) : 'N/A'}</span>\n            </div>\n            <div className=\"flex justify-between\">\n              <span className=\"text-muted-foreground\">Beta (5Y Monthly)</span>\n              <span className=\"font-medium\">{stockDetails.metrics.beta?.toFixed(2) || 'N/A'}</span>\n            </div>\n            <div className=\"flex justify-between\">\n              <span className=\"text-muted-foreground\">PE Ratio (TTM)</span>\n              <span className=\"font-medium\">{stockDetails.metrics.peRatioTTM?.toFixed(2) || 'N/A'}</span>\n            </div>\n            <div className=\"flex justify-between\">\n              <span className=\"text-muted-foreground\">EPS (TTM)</span>\n              <span className=\"font-medium\">{stockDetails.metrics.epsTTM?.toFixed(2) || 'N/A'}</span>\n            </div>\n          </div>\n\n          {/* Column 4 */}\n          <div className=\"space-y-3\">\n            <div className=\"flex justify-between\">\n              <span className=\"text-muted-foreground\">Earnings Date</span>\n              <span className=\"font-medium\">N/A</span>\n            </div>\n            <div className=\"flex justify-between\">\n              <span className=\"text-muted-foreground\">Forward Dividend & Yield</span>\n              <span className=\"font-medium\">{stockDetails.metrics.dividendYieldTTM ? formatPercent(stockDetails.metrics.dividendYieldTTM) : 'N/A'}</span>\n            </div>\n            <div className=\"flex justify-between\">\n              <span className=\"text-muted-foreground\">Ex-Dividend Date</span>\n              <span className=\"font-medium\">N/A</span>\n            </div>\n            <div className=\"flex justify-between\">\n              <span className=\"text-muted-foreground\">1y Target Est</span>\n              <span className=\"font-medium\">N/A</span>\n            </div>\n          </div>\n        </div>\n      )}\n\n      {/* Chart History Log */}\n      <Card className=\"p-6 mt-8\" style={{ backgroundColor: '#121212' }}>\n        <div className=\"flex items-center justify-between mb-4\">\n          <h3 className=\"text-lg font-semibold\">Chart History Log</h3>\n          {chartHistory.length > 0 && (\n            <Button\n              variant=\"ghost\"\n              size=\"sm\"\n              onClick={handleDeleteAllClick}\n              className=\"hover:bg-transparent relative flex items-center justify-center\"\n              style={{ \n                width: confirmDeleteAll ? '95px' : '90px',\n                height: '32px',\n                transition: 'width 300ms',\n                overflow: 'hidden'\n              }}\n              data-testid=\"button-delete-all-history\"\n            >\n              <Trash2 \n                className={`h-4 w-4 absolute transition-all duration-300 ${\n                  confirmDeleteAll ? 'opacity-0 -translate-x-12' : 'opacity-100 translate-x-0'\n                }`}\n                style={{ \n                  color: confirmDeleteAll ? '#5AF5FA' : '#F7F7F7',\n                  left: '4px'\n                }}\n                onMouseEnter={(e) => !confirmDeleteAll && (e.currentTarget.style.color = '#5AF5FA')}\n                onMouseLeave={(e) => !confirmDeleteAll && (e.currentTarget.style.color = '#F7F7F7')}\n              />\n              <span \n                className={`text-sm whitespace-nowrap font-medium absolute transition-all duration-300 ${\n                  confirmDeleteAll ? 'opacity-0 -translate-x-12' : 'opacity-100 translate-x-0'\n                }`}\n                style={{ \n                  color: '#F7F7F7',\n                  left: '28px'\n                }}\n                onMouseEnter={(e) => !confirmDeleteAll && (e.currentTarget.style.color = '#5AF5FA')}\n                onMouseLeave={(e) => !confirmDeleteAll && (e.currentTarget.style.color = '#F7F7F7')}\n              >\n                Delete All\n              </span>\n              <span \n                className={`text-sm whitespace-nowrap font-medium absolute transition-all duration-300 ${\n                  confirmDeleteAll ? 'opacity-100 translate-x-0' : 'opacity-0 translate-x-12'\n                }`}\n                style={{ \n                  color: '#5AF5FA',\n                  left: '8px'\n                }}\n              >\n                Delete Now\n              </span>\n            </Button>\n          )}\n        </div>\n        <div className=\"h-[350px] overflow-y-scroll\">\n          {chartHistory.length > 0 ? (\n            <div className=\"grid grid-cols-1 md:grid-cols-2 gap-3\">\n              {chartHistory.map((entry) => {\n                const annotationCounts = entry.annotations.reduce((acc, ann) => {\n                  const type = ann.type === 'text' ? 'Text' : \n                               ann.type === 'percentage' ? 'Measure' : \n                               'Horizontal';\n                  acc[type] = (acc[type] || 0) + 1;\n                  return acc;\n                }, {} as Record<string, number>);\n\n                const annotationSummary = Object.entries(annotationCounts)\n                  .map(([type, count]) => `${count} ${type}`)\n                  .join(', ');\n\n                return (\n                  <Card \n                    key={entry.id} \n                    className={`p-4 bg-muted/50 cursor-pointer transition-all duration-300 hover:bg-muted/70 relative group ${\n                      deletingId === entry.id ? 'opacity-0 -translate-x-full' : ''\n                    }`}\n                    data-testid={`chart-history-${entry.id}`}\n                    onClick={() => restoreFromHistory(entry)}\n                    style={{\n                      borderRadius: '4px',\n                    }}\n                  >\n                    {/* Hover gradient border */}\n                    <div \n                      className=\"absolute inset-0 rounded opacity-0 group-hover:opacity-100 transition-opacity duration-200 pointer-events-none\"\n                      style={{\n                        background: 'linear-gradient(90deg, #5AF5FA 0%, #FFA5FF 100%)',\n                        padding: '1px',\n                        borderRadius: '4px',\n                        WebkitMask: 'linear-gradient(#fff 0 0) content-box, linear-gradient(#fff 0 0)',\n                        WebkitMaskComposite: 'xor',\n                        maskComposite: 'exclude',\n                      }}\n                    />\n                    <div className=\"flex items-start justify-between relative z-10\">\n                      <div className=\"flex-1\">\n                        <div className=\"font-bold text-[#5AF5FA] mb-1\">\n                          {entry.symbol}\n                        </div>\n                        <div className=\"text-sm text-muted-foreground mb-2\">\n                          {format(new Date(entry.savedAt), 'MMM dd, yyyy HH:mm:ss')}\n                        </div>\n                        <div className=\"text-xs text-muted-foreground mb-1\">\n                          Timeframe: {entry.timeframe}\n                          {entry.csvOverlay && entry.csvOverlay.length > 0 && `  CSV Overlay (${entry.csvOverlay.length} points)`}\n                        </div>\n                        <div className=\"text-sm text-foreground\">\n                          {annotationSummary || 'No annotations'}\n                        </div>\n                      </div>\n                      {/* Delete button */}\n                      <Button\n                        variant=\"ghost\"\n                        size=\"sm\"\n                        onClick={(e) => {\n                          e.stopPropagation();\n                          handleDeleteClick(entry.id);\n                        }}\n                        className=\"ml-2 hover:bg-transparent relative flex items-center justify-center\"\n                        style={{ \n                          width: confirmDeleteId === entry.id ? '85px' : '36px',\n                          height: '32px',\n                          transition: 'width 300ms',\n                          overflow: 'hidden'\n                        }}\n                        data-testid={`button-delete-history-${entry.id}`}\n                      >\n                        <Trash2 \n                          className={`h-4 w-4 absolute transition-all duration-300 ${\n                            confirmDeleteId === entry.id ? 'opacity-0 -translate-x-12' : 'opacity-100 translate-x-0'\n                          }`}\n                          style={{ \n                            color: confirmDeleteId === entry.id ? '#5AF5FA' : '#F7F7F7'\n                          }}\n                          onMouseEnter={(e) => confirmDeleteId !== entry.id && (e.currentTarget.style.color = '#5AF5FA')}\n                          onMouseLeave={(e) => confirmDeleteId !== entry.id && (e.currentTarget.style.color = '#F7F7F7')}\n                        />\n                        <span \n                          className={`text-xs whitespace-nowrap font-medium absolute transition-all duration-300 ${\n                            confirmDeleteId === entry.id ? 'opacity-100 translate-x-0' : 'opacity-0 translate-x-12'\n                          }`}\n                          style={{ color: '#5AF5FA' }}\n                        >\n                          Delete Now\n                        </span>\n                      </Button>\n                    </div>\n                  </Card>\n                );\n              })}\n            </div>\n          ) : (\n            <div className=\"flex items-center justify-center h-full text-muted-foreground text-center\">\n              <p data-testid=\"text-no-history\">No chart history yet. Annotate a chart to see it here.</p>\n            </div>\n          )}\n        </div>\n      </Card>\n    </div>\n  );\n\n  return chartContent;\n}","path":null,"size_bytes":223289,"size_tokens":null},"server/sendgrid.ts":{"content":"// SendGrid email service - based on javascript_sendgrid blueprint\nimport { MailService } from '@sendgrid/mail';\n\nconst mailService = new MailService();\n\n// Initialize with API key from environment variables (secure approach)\nif (process.env.SENDGRID_API_KEY) {\n  mailService.setApiKey(process.env.SENDGRID_API_KEY);\n}\n\ninterface EmailParams {\n  to: string;\n  from: string;\n  subject: string;\n  text?: string;\n  html?: string;\n  attachments?: Array<{\n    content: string;\n    filename: string;\n    type: string;\n    disposition: string;\n  }>;\n}\n\nexport async function sendEmail(params: EmailParams): Promise<boolean> {\n  try {\n    if (!process.env.SENDGRID_API_KEY) {\n      console.error('SENDGRID_API_KEY environment variable is not set');\n      return false;\n    }\n\n    await mailService.send({\n      to: params.to,\n      from: params.from,\n      subject: params.subject,\n      text: params.text || '',\n      html: params.html || '',\n      attachments: params.attachments || [],\n    });\n    \n    console.log('Email sent successfully to:', params.to);\n    return true;\n  } catch (error) {\n    console.error('SendGrid email error:', error);\n    return false;\n  }\n}","path":null,"size_bytes":1164,"size_tokens":null},"server/services/stockData.ts":{"content":"import type { InsertStock, InsertMarketSummary } from \"@shared/schema\";\nimport { finnhubService } from \"./finnhubService\";\nimport { alphaVantageService } from \"./alphaVantageService\";\n\n/**\n * Stock Data Service - Powered by Finnhub Premium API\n */\nexport class StockDataService {\n  \n  /**\n   * Search stocks using Finnhub API\n   */\n  async searchStocks(query: string): Promise<InsertStock[]> {\n    try {\n      return await finnhubService.searchStocks(query);\n    } catch (error) {\n      console.error(\"Error searching stocks:\", error);\n      return [];\n    }\n  }\n\n  /**\n   * Get latest stock data - placeholder for future market movers endpoint\n   */\n  async getLatestStockData(): Promise<InsertStock[]> {\n    console.log(\" Finnhub configured - market movers endpoint to be implemented\");\n    return [];\n  }\n\n  /**\n   * Get stock chart data using Finnhub API with Alpha Vantage fallback\n   */\n  async getStockChart(symbol: string, from: number, to: number, resolution: string): Promise<any> {\n    console.log(` Chart request - Symbol: ${symbol}, Resolution: ${resolution}`);\n    \n    let finnhubData = null;\n    let finnhubError = false;\n    \n    // Try Finnhub first\n    try {\n      finnhubData = await finnhubService.getStockCandles(symbol, from, to, resolution);\n      console.log(` Finnhub response - Has data: ${!!finnhubData}, Status: ${finnhubData?.s}, Points: ${finnhubData?.t?.length || 0}`);\n      \n      // If Finnhub returns data, use it\n      if (finnhubData && finnhubData.s === 'ok' && finnhubData.t && finnhubData.t.length > 0) {\n        console.log(` Using Finnhub data for ${symbol}: ${finnhubData.t.length} points`);\n        return finnhubData;\n      }\n    } catch (error) {\n      console.error(` Finnhub error for ${symbol}:`, error);\n      finnhubError = true;\n    }\n    \n    // If Finnhub failed or has no data, and resolution is daily, try Alpha Vantage\n    // Alpha Vantage only provides daily data, not intraday\n    if (resolution === 'D') {\n      console.log(`  Finnhub ${finnhubError ? 'failed' : 'has no data'} for ${symbol}, trying Alpha Vantage fallback...`);\n      \n      try {\n        const alphaVantageData = await alphaVantageService.getStockCandles(symbol, from, to);\n        \n        if (alphaVantageData && alphaVantageData.s === 'ok' && alphaVantageData.t && alphaVantageData.t.length > 0) {\n          console.log(` Alpha Vantage fallback successful for ${symbol}: ${alphaVantageData.t.length} points`);\n          return alphaVantageData;\n        } else {\n          console.log(` Alpha Vantage also has no data for ${symbol}`);\n        }\n      } catch (alphaError) {\n        console.error(` Alpha Vantage error for ${symbol}:`, alphaError);\n      }\n    } else {\n      console.log(`  Skipping Alpha Vantage fallback - resolution is ${resolution}, not daily (D)`);\n    }\n    \n    // No data from either source\n    return finnhubData;\n  }\n\n  /**\n   * Get detailed stock information including pre/after market and stats\n   */\n  async getDetailedStockInfo(symbol: string): Promise<any> {\n    try {\n      return await finnhubService.getDetailedQuote(symbol);\n    } catch (error) {\n      console.error(\"Error getting detailed stock info:\", error);\n      return null;\n    }\n  }\n\n  /**\n   * Get earnings calendar data for a specific symbol\n   */\n  async getEarningsCalendar(symbol: string): Promise<any> {\n    try {\n      return await finnhubService.getEarningsCalendar(symbol);\n    } catch (error) {\n      console.error(\"Error getting earnings calendar:\", error);\n      return [];\n    }\n  }\n\n  /**\n   * Get market holidays for a specific exchange\n   */\n  async getMarketHolidays(exchange: string): Promise<any> {\n    try {\n      return await finnhubService.getMarketHolidays(exchange);\n    } catch (error) {\n      console.error(\"Error getting market holidays:\", error);\n      return null;\n    }\n  }\n\n  /**\n   * Get API status - placeholder for new API\n   */\n  async getApiStatus(): Promise<{remainingRequests: number, resetTime?: string}> {\n    return {\n      remainingRequests: 0,\n      resetTime: \"No API configured\"\n    };\n  }\n\n  /**\n   * Get market status from Finnhub\n   */\n  async getMarketStatus() {\n    try {\n      return await finnhubService.getMarketStatus();\n    } catch (error) {\n      console.error(\"Error getting market status:\", error);\n      // Fallback to basic calculation\n      const now = new Date();\n      const hour = now.getHours();\n      const isWeekday = now.getDay() >= 1 && now.getDay() <= 5;\n      const isMarketHours = hour >= 9 && hour < 16;\n      \n      return {\n        status: isWeekday && isMarketHours ? 'open' : 'closed',\n        market: 'US',\n        serverTime: now.toISOString(),\n        exchanges: [{\n          name: 'US Market',\n          status: isWeekday && isMarketHours ? 'open' : 'closed'\n        }]\n      };\n    }\n  }\n\n  /**\n   * Calculate market summary from stock data\n   */\n  async calculateMarketSummary(stocks: InsertStock[]): Promise<InsertMarketSummary> {\n    const gainers = stocks.filter(stock => parseFloat(stock.percentChange) > 0);\n    const losers = stocks.filter(stock => parseFloat(stock.percentChange) < 0);\n    \n    const avgGainerChange = gainers.length > 0 \n      ? (gainers.reduce((sum, stock) => sum + parseFloat(stock.percentChange), 0) / gainers.length).toFixed(3)\n      : \"0.000\";\n    \n    const avgLoserChange = losers.length > 0\n      ? (losers.reduce((sum, stock) => sum + parseFloat(stock.percentChange), 0) / losers.length).toFixed(3)\n      : \"0.000\";\n\n    return {\n      totalMovers: stocks.length,\n      totalGainers: gainers.length,\n      totalLosers: losers.length,\n      avgGainerChange,\n      avgLoserChange,\n      totalMarketCap: \"0\",\n      avgVolume: \"0\",\n      volatility: \"low\",\n      sectorLeader: \"Technology\",\n      // lastUpdated automatically set by database\n    };\n  }\n}\n\nexport const stockDataService = new StockDataService();","path":null,"size_bytes":5888,"size_tokens":null},"client/src/components/ui/input.tsx":{"content":"import * as React from \"react\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst Input = React.forwardRef<HTMLInputElement, React.ComponentProps<\"input\">>(\n  ({ className, type, ...props }, ref) => {\n    return (\n      <input\n        type={type}\n        className={cn(\n          \"flex h-10 w-full rounded-md border border-input bg-background px-3 py-2 text-base ring-offset-background file:border-0 file:bg-transparent file:text-sm file:font-medium file:text-foreground placeholder:text-muted-foreground focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:cursor-not-allowed disabled:opacity-50 md:text-sm\",\n          className\n        )}\n        ref={ref}\n        {...props}\n      />\n    )\n  }\n)\nInput.displayName = \"Input\"\n\nexport { Input }\n","path":null,"size_bytes":791,"size_tokens":null},"client/src/components/ui/avatar.tsx":{"content":"\"use client\"\n\nimport * as React from \"react\"\nimport * as AvatarPrimitive from \"@radix-ui/react-avatar\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst Avatar = React.forwardRef<\n  React.ElementRef<typeof AvatarPrimitive.Root>,\n  React.ComponentPropsWithoutRef<typeof AvatarPrimitive.Root>\n>(({ className, ...props }, ref) => (\n  <AvatarPrimitive.Root\n    ref={ref}\n    className={cn(\n      \"relative flex h-10 w-10 shrink-0 overflow-hidden rounded-full\",\n      className\n    )}\n    {...props}\n  />\n))\nAvatar.displayName = AvatarPrimitive.Root.displayName\n\nconst AvatarImage = React.forwardRef<\n  React.ElementRef<typeof AvatarPrimitive.Image>,\n  React.ComponentPropsWithoutRef<typeof AvatarPrimitive.Image>\n>(({ className, ...props }, ref) => (\n  <AvatarPrimitive.Image\n    ref={ref}\n    className={cn(\"aspect-square h-full w-full\", className)}\n    {...props}\n  />\n))\nAvatarImage.displayName = AvatarPrimitive.Image.displayName\n\nconst AvatarFallback = React.forwardRef<\n  React.ElementRef<typeof AvatarPrimitive.Fallback>,\n  React.ComponentPropsWithoutRef<typeof AvatarPrimitive.Fallback>\n>(({ className, ...props }, ref) => (\n  <AvatarPrimitive.Fallback\n    ref={ref}\n    className={cn(\n      \"flex h-full w-full items-center justify-center rounded-full bg-muted\",\n      className\n    )}\n    {...props}\n  />\n))\nAvatarFallback.displayName = AvatarPrimitive.Fallback.displayName\n\nexport { Avatar, AvatarImage, AvatarFallback }\n","path":null,"size_bytes":1419,"size_tokens":null},"client/src/components/ui/tabs.tsx":{"content":"import * as React from \"react\"\nimport * as TabsPrimitive from \"@radix-ui/react-tabs\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst Tabs = TabsPrimitive.Root\n\nconst TabsList = React.forwardRef<\n  React.ElementRef<typeof TabsPrimitive.List>,\n  React.ComponentPropsWithoutRef<typeof TabsPrimitive.List>\n>(({ className, ...props }, ref) => (\n  <TabsPrimitive.List\n    ref={ref}\n    className={cn(\n      \"inline-flex h-10 items-center justify-center rounded-md bg-muted p-1 text-muted-foreground\",\n      className\n    )}\n    {...props}\n  />\n))\nTabsList.displayName = TabsPrimitive.List.displayName\n\nconst TabsTrigger = React.forwardRef<\n  React.ElementRef<typeof TabsPrimitive.Trigger>,\n  React.ComponentPropsWithoutRef<typeof TabsPrimitive.Trigger>\n>(({ className, ...props }, ref) => (\n  <TabsPrimitive.Trigger\n    ref={ref}\n    className={cn(\n      \"inline-flex items-center justify-center whitespace-nowrap rounded-sm px-3 py-1.5 text-sm font-medium ring-offset-background transition-all focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:pointer-events-none disabled:opacity-50 data-[state=active]:bg-background data-[state=active]:text-foreground data-[state=active]:shadow-sm\",\n      className\n    )}\n    {...props}\n  />\n))\nTabsTrigger.displayName = TabsPrimitive.Trigger.displayName\n\nconst TabsContent = React.forwardRef<\n  React.ElementRef<typeof TabsPrimitive.Content>,\n  React.ComponentPropsWithoutRef<typeof TabsPrimitive.Content>\n>(({ className, ...props }, ref) => (\n  <TabsPrimitive.Content\n    ref={ref}\n    className={cn(\n      \"mt-2 ring-offset-background focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2\",\n      className\n    )}\n    {...props}\n  />\n))\nTabsContent.displayName = TabsPrimitive.Content.displayName\n\nexport { Tabs, TabsList, TabsTrigger, TabsContent }\n","path":null,"size_bytes":1883,"size_tokens":null},"client/src/components/dashboard/comparison-chart.tsx":{"content":"import { useState, useMemo, useEffect, useRef, useCallback } from 'react';\nimport { format } from 'date-fns';\nimport { LineChart, Line, XAxis, YAxis, CartesianGrid, Tooltip, ReferenceLine, ReferenceDot, ResponsiveContainer, Customized } from 'recharts';\nimport { ChartContainer, ChartTooltipContent } from \"@/components/ui/chart\";\nimport { Button } from \"@/components/ui/button\";\nimport { Input } from \"@/components/ui/input\";\nimport { Card } from \"@/components/ui/card\";\nimport { createPortal } from \"react-dom\";\nimport { TrendingUp, TrendingDown } from \"lucide-react\";\nimport { cn } from \"@/lib/utils\";\nimport { Search, X, Plus, Download, FileText, Image as ImageIcon, Pencil } from \"lucide-react\";\nimport { useQueries, useQuery } from \"@tanstack/react-query\";\nimport { useToast } from \"@/hooks/use-toast\";\nimport { saveAs } from 'file-saver';\nimport * as htmlToImage from 'html-to-image';\nimport jsPDF from 'jspdf';\n\n// Color palette for different tickers (max 5 tickers)\nconst TICKER_COLORS = [\n  '#5AF5FA', // Cyan - primary brand color\n  '#FFA5FF', // Pink/Magenta  \n  '#AA99FF', // Purple\n  '#FAFF50', // Yellow\n  '#50FFA5', // Green - added 5th color to complete the palette\n];\n\ninterface ChartDataPoint {\n  timestamp: number;\n  date: string;\n  [key: string]: number | string; // Dynamic keys for each ticker's percentage\n}\n\ninterface TickerData {\n  symbol: string;\n  color: string;\n  visible: boolean;\n}\n\ninterface SearchResult {\n  symbol: string;\n  name: string;\n  price: string;\n  percentChange: string;\n  marketCap: string;\n  type?: string;\n}\n\ninterface Annotation {\n  id: string;\n  type: 'text' | 'percentage' | 'horizontal' | 'note';\n  x: number; // X coordinate on chart\n  y: number; // Y coordinate on chart\n  timestamp: number; // Data point timestamp\n  price: number; // Price at this point\n  text?: string; // User annotation text (for text, horizontal, and note types)\n  time: string; // Formatted time string\n  horizontalOffset?: number; // Custom horizontal position offset in pixels for dragging\n  verticalOffset?: number; // Custom vertical position offset in pixels for dragging\n  // For percentage measurements\n  startTimestamp?: number;\n  startPrice?: number;\n  startTime?: string;\n  endTimestamp?: number;\n  endPrice?: number;\n  endTime?: string;\n  percentage?: number;\n}\n\ninterface ComparisonChartProps {\n  timeframe: string;\n  startDate?: Date;\n  endDate?: Date;\n  singleTradingDay?: boolean;\n  annotations?: Annotation[];\n  onAnnotationsChange?: (annotations: Annotation[]) => void;\n  annotationMode?: 'text' | 'percentage' | 'horizontal' | 'note';\n  pendingPercentageStart?: { timestamp: number; price: number; time: string } | null;\n  setPendingPercentageStart?: (start: { timestamp: number; price: number; time: string } | null) => void;\n  updateAnnotations?: (newAnnotations: Annotation[] | ((prev: Annotation[]) => Annotation[])) => void;\n  showHoverTooltip?: boolean;\n  onZoomIn?: (fn: () => void) => void;\n  onZoomOut?: (fn: () => void) => void;\n  onFitToData?: (fn: () => void) => void;\n  onTickersChange?: (tickers: TickerData[]) => void;\n}\n\n\nexport function ComparisonChart({ \n  timeframe, \n  startDate, \n  endDate,\n  singleTradingDay = false,\n  annotations: controlledAnnotations,\n  onAnnotationsChange,\n  annotationMode = 'text',\n  pendingPercentageStart,\n  setPendingPercentageStart,\n  updateAnnotations,\n  showHoverTooltip = true,\n  onZoomIn: parentZoomIn,\n  onZoomOut: parentZoomOut,\n  onFitToData: parentFitToData,\n  onTickersChange\n}: ComparisonChartProps) {\n  const [tickers, setTickers] = useState<TickerData[]>([]);\n  const [searchTerm, setSearchTerm] = useState('');\n  \n  useEffect(() => {\n    onTickersChange?.(tickers);\n  }, [tickers, onTickersChange]);\n  const [debouncedQuery, setDebouncedQuery] = useState('');\n  const [isSearchVisible, setIsSearchVisible] = useState(false);\n  const [isDropdownOpen, setIsDropdownOpen] = useState(false);\n  const [dropdownPosition, setDropdownPosition] = useState({ top: 0, left: 0, width: 0 });\n  const [recentSearches, setRecentSearches] = useState<SearchResult[]>([]);\n  const { toast } = useToast();\n  \n  // Hover tool state is now controlled by parent component\n\n  // Y-axis zoom state\n  const [yAxisMode, setYAxisMode] = useState<'auto' | 'fixed'>('auto');\n  const [yAxisRange, setYAxisRange] = useState<number>(10); // Current zoom range in %\n  \n  // Predefined zoom levels for symmetric scaling around 0%\n  const zoomLevels = [0.25, 0.5, 0.75, 1, 1.25, 1.5, 2, 2.5, 3, 5, 7.5, 10, 15, 20, 30, 50, 75, 100, 150, 200, 300, 500];\n\n  // Annotation UI state (non-conflicting with props)\n  const [showAnnotationInput, setShowAnnotationInput] = useState(false);\n  const [annotationInput, setAnnotationInput] = useState('');\n  const [pendingAnnotation, setPendingAnnotation] = useState<Omit<Annotation, 'id' | 'text'> | null>(null);\n  const [editingAnnotation, setEditingAnnotation] = useState<Annotation | null>(null);\n  const [isEditMode, setIsEditMode] = useState(false);\n  const [horizontalPercentageInput, setHorizontalPercentageInput] = useState<string>('');\n  \n  // Drag state for horizontal lines\n  const [isDragging, setIsDragging] = useState(false);\n  const [dragAnnotationId, setDragAnnotationId] = useState<string | null>(null);\n  const [dragStartY, setDragStartY] = useState(0);\n  const [dragStartPrice, setDragStartPrice] = useState(0);\n  const [hoveredHorizontalId, setHoveredHorizontalId] = useState<string | null>(null);\n  \n  // Text annotation 2D drag state\n  const [isDraggingText, setIsDraggingText] = useState(false);\n  const [dragTextAnnotationId, setDragTextAnnotationId] = useState<string | null>(null);\n  const [dragTextStartX, setDragTextStartX] = useState(0);\n  const [dragTextStartY, setDragTextStartY] = useState(0);\n  const [dragStartOffset, setDragStartOffset] = useState(0);\n  const [dragStartVerticalOffset, setDragStartVerticalOffset] = useState(0);\n  \n  // Vertical line horizontal drag state\n  const [isDraggingVertical, setIsDraggingVertical] = useState(false);\n  const [dragVerticalAnnotationId, setDragVerticalAnnotationId] = useState<string | null>(null);\n  const [dragVerticalStartX, setDragVerticalStartX] = useState(0);\n  const [dragVerticalStartTimestamp, setDragVerticalStartTimestamp] = useState(0);\n  \n  // Recharts geometry capture for precise positioning\n  const layoutRef = useRef<{offset: any, yScale: any} | null>(null);\n  \n  const inputRef = useRef<HTMLInputElement>(null);\n  const containerRef = useRef<HTMLDivElement>(null);\n  const dropdownRef = useRef<HTMLDivElement>(null);\n  const chartContainerRef = useRef<HTMLDivElement>(null);\n  const chartRef = useRef<HTMLDivElement>(null);\n\n  // Use controlled annotations from parent\n  const annotations = controlledAnnotations || [];\n\n  // Drag functionality for horizontal lines\n  const handleMouseDown = (event: React.MouseEvent) => {\n    if (!chartContainerRef.current) return;\n    \n    const rect = chartContainerRef.current.getBoundingClientRect();\n    const mouseY = event.clientY - rect.top;\n    \n    // Convert mouse Y to percentage value (approximate)\n    const chartHeight = rect.height - 80; // Account for margins\n    const chartTop = 40; // Account for top margin\n    const relativeY = mouseY - chartTop;\n    const percentageAtMouse = ((chartHeight - relativeY) / chartHeight) * 10 - 5; // Rough conversion to percentage scale\n    \n    // Find the closest horizontal annotation\n    const horizontalAnnotations = annotations.filter((ann): ann is Annotation => ann.type === 'horizontal');\n    let closestHorizontalAnnotation: Annotation | null = null;\n    let closestHorizontalDistance = Infinity;\n    \n    horizontalAnnotations.forEach(annotation => {\n      const distance = Math.abs(annotation.price - percentageAtMouse);\n      if (distance < closestHorizontalDistance && distance < 0.5) { // Within 0.5% tolerance - much more precise\n        closestHorizontalDistance = distance;\n        closestHorizontalAnnotation = annotation;\n      }\n    });\n    \n    // Find the closest vertical annotation (text annotation)\n    const verticalAnnotations = annotations.filter((ann): ann is Annotation => ann.type === 'text');\n    let closestVerticalAnnotation: Annotation | null = null;\n    let closestVerticalDistance = Infinity;\n    \n    if (chartData.length > 0) {\n      const mouseX = event.clientX - rect.left;\n      const chartWidth = rect.width - 120; // Account for margins and axis labels\n      const chartLeft = 60; // Account for left margin\n      const relativeX = mouseX - chartLeft;\n      const xPercent = relativeX / chartWidth;\n      const estimatedDataIndex = Math.round(xPercent * (chartData.length - 1));\n      \n      verticalAnnotations.forEach(annotation => {\n        const actualDataIndex = chartData.findIndex((d: any) => d.timestamp === annotation.timestamp);\n        if (actualDataIndex !== -1) {\n          const distance = Math.abs(actualDataIndex - estimatedDataIndex);\n          const toleranceInDataPoints = Math.max(2, chartData.length * 0.02); // 2% of data points tolerance\n          if (distance < closestVerticalDistance && distance < toleranceInDataPoints) {\n            closestVerticalDistance = distance;\n            closestVerticalAnnotation = annotation;\n          }\n        }\n      });\n    }\n    \n    // Prioritize the closest annotation (horizontal or vertical)\n    if (closestHorizontalAnnotation && (!closestVerticalAnnotation || closestHorizontalDistance < closestVerticalDistance * 0.5)) {\n      setIsDragging(true);\n      setDragAnnotationId((closestHorizontalAnnotation as Annotation).id);\n      setDragStartY(mouseY);\n      setDragStartPrice((closestHorizontalAnnotation as Annotation).price);\n      event.preventDefault();\n      event.stopPropagation();\n    } else if (closestVerticalAnnotation) {\n      setIsDraggingVertical(true);\n      setDragVerticalAnnotationId((closestVerticalAnnotation as Annotation).id);\n      setDragVerticalStartX(event.clientX);\n      setDragVerticalStartTimestamp((closestVerticalAnnotation as Annotation).timestamp);\n      event.preventDefault();\n      event.stopPropagation();\n    }\n  };\n\n  const handleMouseMove = (event: React.MouseEvent) => {\n    if (!isDragging || !dragAnnotationId || !chartContainerRef.current) return;\n    \n    const rect = chartContainerRef.current.getBoundingClientRect();\n    const mouseY = event.clientY - rect.top;\n    const deltaY = mouseY - dragStartY;\n    \n    // Convert pixel delta to percentage delta (approximate)\n    const chartHeight = rect.height - 80;\n    const percentageDelta = -(deltaY / chartHeight) * 10; // Negative because Y increases downward\n    const newPrice = dragStartPrice + percentageDelta;\n    \n    // Update the annotation\n    updateAnnotations?.((prev: Annotation[]) => prev.map(ann => \n      ann.id === dragAnnotationId \n        ? { ...ann, price: newPrice }\n        : ann\n    ));\n  };\n\n  const handleMouseUp = () => {\n    if (isDragging) {\n      setIsDragging(false);\n      setDragAnnotationId(null);\n      setDragStartY(0);\n      setDragStartPrice(0);\n    }\n  };\n\n  // Text annotation drag handlers\n  const handleTextMouseDown = (e: React.MouseEvent, annotation: Annotation) => {\n    setIsDraggingText(true);\n    setDragTextAnnotationId(annotation.id);\n    setDragTextStartX(e.clientX);\n    setDragTextStartY(e.clientY);\n    setDragStartOffset(annotation.horizontalOffset || 0);\n    setDragStartVerticalOffset(annotation.verticalOffset || 0);\n    e.preventDefault();\n    e.stopPropagation();\n  };\n\n  const handleTextMouseUp = () => {\n    if (isDraggingText) {\n      setIsDraggingText(false);\n      setDragTextAnnotationId(null);\n      setDragTextStartX(0);\n      setDragTextStartY(0);\n      setDragStartOffset(0);\n      setDragStartVerticalOffset(0);\n    }\n  };\n\n  const handleVerticalMouseUp = () => {\n    if (isDraggingVertical) {\n      setIsDraggingVertical(false);\n      setDragVerticalAnnotationId(null);\n      setDragVerticalStartX(0);\n      setDragVerticalStartTimestamp(0);\n    }\n  };\n\n  // Fetch chart data for all tickers - must be declared before useEffect that depends on chartData\n  const tickerQueries = useQueries({\n    queries: tickers.map(ticker => ({\n      queryKey: ['/api/stocks', ticker.symbol, 'chart', timeframe, startDate?.toISOString(), endDate?.toISOString(), singleTradingDay],\n      queryFn: async () => {\n        let url = `/api/stocks/${ticker.symbol}/chart?timeframe=${timeframe}`;\n        \n        // Add custom date range parameters for Custom timeframe\n        if (timeframe === 'Custom' && startDate && endDate) {\n          let fromTimestamp: number;\n          let toTimestamp: number;\n          \n          if (singleTradingDay || startDate.toDateString() === endDate.toDateString()) {\n            // Single trading day - use full day range to support global markets\n            // Don't restrict to US market hours - let Finnhub return whatever intraday data exists\n            const tradingDay = startDate;\n            \n            // Use start and end of the selected day in UTC\n            // This allows each market's natural trading hours to show through\n            const dayStart = new Date(tradingDay.getFullYear(), tradingDay.getMonth(), tradingDay.getDate(), 0, 0, 0, 0);\n            const dayEnd = new Date(tradingDay.getFullYear(), tradingDay.getMonth(), tradingDay.getDate(), 23, 59, 59, 999);\n            \n            fromTimestamp = Math.floor(dayStart.getTime() / 1000);\n            toTimestamp = Math.floor(dayEnd.getTime() / 1000);\n          } else {\n            // Date range - use full days\n            fromTimestamp = Math.floor(startDate.getTime() / 1000);\n            toTimestamp = Math.floor(endDate.getTime() / 1000);\n          }\n          \n          url = `/api/stocks/${ticker.symbol}/chart?from=${fromTimestamp}&to=${toTimestamp}&timeframe=Custom`;\n        }\n        \n        const response = await fetch(url);\n        if (!response.ok) {\n          const errorText = await response.text();\n          throw new Error(`HTTP ${response.status}: ${errorText}`);\n        }\n        \n        const data = await response.json();\n        \n        // Debug logging for Single Trading Day in comparison chart\n        if (timeframe === 'Custom' && singleTradingDay) {\n          console.log(' Comparison Chart Single Trading Day API response:', {\n            symbol: ticker.symbol,\n            url,\n            dataLength: data?.data?.length || 0,\n            hasData: Boolean(data?.data?.length),\n            timeframe: data?.timeframe\n          });\n        }\n        \n        // Ensure we have valid data structure\n        if (!data || !data.data) {\n          throw new Error('Invalid response format');\n        }\n        \n        return data;\n      },\n      enabled: !!ticker.symbol,\n      staleTime: 0, // Always refetch when timeframe changes\n      cacheTime: 2 * 60 * 1000, // Keep in cache for 2 minutes\n    }))\n  });\n\n  // Helper function to format dates properly based on timeframe (like main price chart)\n  const formatTime = (timeValue: any, timeframe: string) => {\n    // Handle both timestamp numbers and time strings like the main chart\n    const date = typeof timeValue === 'string' ? new Date(timeValue) : new Date(timeValue * 1000);\n    switch (timeframe) {\n      case '1D':\n      case '5D':\n      case '2W':\n        return date.toLocaleDateString('en-US', { \n          month: 'numeric',\n          day: 'numeric',\n          year: '2-digit'\n        });\n      case '1M':\n      case '3M':\n        return date.toLocaleDateString('en-US', { \n          month: 'numeric',\n          day: 'numeric',\n          year: '2-digit'\n        });\n      case '1Y':\n        return date.toLocaleDateString('en-US', { \n          month: 'short',\n          year: '2-digit'\n        });\n      case 'Custom':\n        // For Single Trading Day, show time instead of dates\n        if (singleTradingDay || (startDate && endDate && startDate.toDateString() === endDate.toDateString())) {\n          // Single trading day - show time (hours and minutes)\n          return date.toLocaleTimeString('en-US', { \n            hour: '2-digit', \n            minute: '2-digit',\n            hour12: false \n          });\n        } else {\n          // Date range - show date\n          return date.toLocaleDateString('en-US', { \n            month: 'numeric',\n            day: 'numeric',\n            year: '2-digit'\n          });\n        }\n      default:\n        return date.toLocaleDateString('en-US', { \n          month: 'numeric',\n          day: 'numeric',\n          year: '2-digit'\n        });\n    }\n  };\n\n  // Process and align chart data for percentage calculation - must be declared before useEffect that depends on chartData\n  const chartData = useMemo(() => {\n    if (tickers.length === 0) return [];\n    \n    // Check if all queries have loaded successfully\n    const allLoaded = tickerQueries.every(query => query.isSuccess && query.data);\n    if (!allLoaded) return [];\n\n    // Get all the chart data\n    const allChartData = tickerQueries.map((query, index) => ({\n      ticker: tickers[index],\n      data: query.data?.data || []\n    })).filter(item => item.data.length > 0);\n\n    if (allChartData.length === 0) return [];\n\n    // Smart timestamp alignment - handles indices vs stocks with different data sources\n    // Instead of requiring exact timestamp matches, use nearest-time alignment\n    \n    // Get all unique timestamps from all tickers and sort them\n    const allTimestamps = new Set<number>();\n    allChartData.forEach(({ data }) => {\n      data.forEach((d: any) => allTimestamps.add(d.timestamp as number));\n    });\n    \n    const sortedTimestamps = Array.from(allTimestamps).sort((a, b) => a - b);\n    \n    if (sortedTimestamps.length === 0) return [];\n\n    // Helper function to find nearest data point for a given timestamp\n    const findNearestPoint = (data: any[], targetTimestamp: number) => {\n      if (data.length === 0) return null;\n      \n      // Find the closest timestamp within a reasonable window (6 hours = 21600 seconds)\n      const maxDiff = 21600 * 1000; // 6 hours in milliseconds\n      let nearest = null;\n      let minDiff = Infinity;\n      \n      for (const point of data) {\n        const diff = Math.abs(point.timestamp - targetTimestamp);\n        if (diff < minDiff && diff <= maxDiff) {\n          minDiff = diff;\n          nearest = point;\n        }\n      }\n      \n      return nearest;\n    };\n\n    // Calculate base prices using first available data point for each ticker\n    const basePrices: Record<string, number> = {};\n    allChartData.forEach(({ ticker, data }) => {\n      if (data.length > 0) {\n        // Use the first data point as base for percentage calculation\n        basePrices[ticker.symbol] = data[0].close;\n      }\n    });\n\n    // Track last known prices for forward-fill (handles global market closures)\n    const lastKnownPrices: Record<string, number> = {};\n    \n    // Build aligned chart data with smart timestamp matching and forward-fill\n    const alignedData: ChartDataPoint[] = [];\n    \n    for (const timestamp of sortedTimestamps) {\n      const dataPoint: ChartDataPoint = {\n        timestamp,\n        time: new Date(timestamp).toISOString(),\n        date: formatTime(new Date(timestamp).toISOString(), timeframe)\n      };\n      \n      let hasAnyData = false;\n      \n      // For each ticker, find the nearest data point to this timestamp\n      allChartData.forEach(({ ticker, data }) => {\n        const nearestPoint = findNearestPoint(data, timestamp);\n        const basePrice = basePrices[ticker.symbol];\n        \n        if (nearestPoint && basePrice > 0) {\n          // New data available - update last known price\n          const currentPrice = nearestPoint.close;\n          lastKnownPrices[ticker.symbol] = currentPrice;\n          \n          // Calculate percentage change from base price\n          const percentageChange = ((currentPrice - basePrice) / basePrice) * 100;\n          dataPoint[`${ticker.symbol}_percentage`] = parseFloat(percentageChange.toFixed(2));\n          dataPoint[`${ticker.symbol}_price`] = currentPrice;\n          hasAnyData = true;\n        } else if (lastKnownPrices[ticker.symbol] !== undefined && basePrice > 0) {\n          // No new data - use forward-fill with last known price (market is closed)\n          const lastPrice = lastKnownPrices[ticker.symbol];\n          const percentageChange = ((lastPrice - basePrice) / basePrice) * 100;\n          dataPoint[`${ticker.symbol}_percentage`] = parseFloat(percentageChange.toFixed(2));\n          dataPoint[`${ticker.symbol}_price`] = lastPrice;\n          hasAnyData = true;\n        }\n      });\n      \n      // Only include data points where at least one ticker has data\n      if (hasAnyData) {\n        alignedData.push(dataPoint);\n      }\n    }\n\n    return alignedData;\n  }, [tickers, tickerQueries, timeframe]);\n\n  // Calculate current data extremes from visible tickers\n  const dataExtremes = useMemo(() => {\n    if (!chartData || chartData.length === 0 || tickers.length === 0) {\n      return { min: -10, max: 10, baseRange: 10 };\n    }\n\n    let min = Infinity;\n    let max = -Infinity;\n\n    // Find min/max across all visible ticker percentage data\n    chartData.forEach(point => {\n      tickers.forEach(ticker => {\n        const value = point[`${ticker.symbol}_percentage`];\n        if (typeof value === 'number' && !isNaN(value)) {\n          min = Math.min(min, value);\n          max = Math.max(max, value);\n        }\n      });\n    });\n\n    // Handle empty data case\n    if (min === Infinity || max === -Infinity) {\n      return { min: -10, max: 10, baseRange: 10 };\n    }\n\n    // Calculate base range as the max absolute value, with minimum of 0.5%\n    const baseRange = Math.max(Math.abs(min), Math.abs(max), 0.5);\n    \n    return { min, max, baseRange };\n  }, [chartData, tickers]);\n\n  // Y-axis zoom control functions (memoized for stable references)\n  const zoomIn = useCallback(() => {\n    setYAxisRange(prevRange => {\n      const currentIndex = zoomLevels.findIndex(level => level >= prevRange);\n      const nextIndex = Math.max(0, currentIndex - 1);\n      return zoomLevels[nextIndex];\n    });\n    setYAxisMode('fixed');\n  }, []);\n\n  const zoomOut = useCallback(() => {\n    setYAxisRange(prevRange => {\n      const currentIndex = zoomLevels.findIndex(level => level >= prevRange);\n      const nextIndex = Math.min(zoomLevels.length - 1, currentIndex + 1);\n      return zoomLevels[nextIndex];\n    });\n    setYAxisMode('fixed');\n  }, []);\n\n  const fitToData = useCallback(() => {\n    setYAxisMode('auto');\n  }, []);\n\n  // Expose zoom functions to parent via callbacks (only when they change)\n  useEffect(() => {\n    if (parentZoomIn) {\n      parentZoomIn(zoomIn);\n    }\n    if (parentZoomOut) {\n      parentZoomOut(zoomOut);\n    }\n    if (parentFitToData) {\n      parentFitToData(fitToData);\n    }\n    \n    // Cleanup on unmount\n    return () => {\n      if (parentZoomIn) parentZoomIn(() => {});\n      if (parentZoomOut) parentZoomOut(() => {});\n      if (parentFitToData) parentFitToData(() => {});\n    };\n  }, [parentZoomIn, parentZoomOut, parentFitToData, zoomIn, zoomOut, fitToData]);\n\n  // Get current Y-axis domain based on zoom state\n  const getYAxisDomain = (): any => {\n    if (yAxisMode === 'auto') {\n      return [(dataMin: any) => Math.floor(Number(dataMin) - 1), (dataMax: any) => Math.ceil(Number(dataMax) + 1)];\n    } else {\n      return [-yAxisRange, yAxisRange];\n    }\n  };\n\n  // Keyboard shortcuts for zoom controls\n  useEffect(() => {\n    const handleKeyPress = (event: KeyboardEvent) => {\n      // Only handle if focused within the chart container\n      if (!event.target || !(event.target as Element).closest('[data-testid=\"comparison-chart-container\"]')) {\n        return;\n      }\n\n      switch (event.key) {\n        case '+':\n        case '=':\n          event.preventDefault();\n          zoomIn();\n          break;\n        case '-':\n        case '_':\n          event.preventDefault();\n          zoomOut();\n          break;\n        case '0':\n          event.preventDefault();\n          fitToData();\n          break;\n      }\n    };\n\n    window.addEventListener('keydown', handleKeyPress);\n    return () => window.removeEventListener('keydown', handleKeyPress);\n  }, [yAxisRange, yAxisMode]);\n\n  // Reset zoom mode to auto when timeframe or singleTradingDay changes\n  useEffect(() => {\n    setYAxisMode('auto');\n  }, [timeframe, singleTradingDay]);\n\n  // Add global mouse up listener to handle drag end outside chart\n  useEffect(() => {\n    if (isDragging || isDraggingText || isDraggingVertical) {\n      const handleGlobalMouseUp = () => {\n        handleMouseUp();\n        handleTextMouseUp();\n        handleVerticalMouseUp();\n      };\n      \n      const handleGlobalMouseMove = (event: MouseEvent) => {\n        // Handle horizontal line dragging\n        if (isDragging && dragAnnotationId && layoutRef.current) {\n          const { yScale } = layoutRef.current;\n          if (typeof yScale.invert !== 'function') return;\n          \n          // Use Recharts' real Y-scale to convert mouse position to price (with 85px offset correction)\n          const newPrice = yScale.invert(event.clientY - layoutRef.current.offset.top - 85);\n          \n          // Update the annotation with the precise value\n          updateAnnotations?.((prev: Annotation[]) => prev.map(ann => \n            ann.id === dragAnnotationId \n              ? { ...ann, price: newPrice }\n              : ann\n          ));\n        }\n        \n        // Handle text annotation 2D dragging\n        if (isDraggingText && dragTextAnnotationId) {\n          const deltaX = event.clientX - dragTextStartX;\n          const deltaY = event.clientY - dragTextStartY;\n          const newHorizontalOffset = dragStartOffset + deltaX;\n          const newVerticalOffset = dragStartVerticalOffset + deltaY;\n          \n          // Update the annotation's horizontal and vertical offsets\n          updateAnnotations?.((prev: Annotation[]) => prev.map(ann => \n            ann.id === dragTextAnnotationId \n              ? { ...ann, horizontalOffset: newHorizontalOffset, verticalOffset: newVerticalOffset }\n              : ann\n          ));\n        }\n        \n        // Handle vertical line horizontal dragging\n        if (isDraggingVertical && dragVerticalAnnotationId && chartData) {\n          const deltaX = event.clientX - dragVerticalStartX;\n          \n          // Calculate new timestamp based on horizontal movement\n          const chartWidth = 800; // Approximate chart width\n          const dataLength = chartData.length;\n          const pixelsPerDataPoint = chartWidth / (dataLength - 1);\n          const dataPointDelta = Math.round(deltaX / pixelsPerDataPoint);\n          \n          // Find current annotation's data index\n          const currentIndex = chartData.findIndex((d: any) => d.timestamp === dragVerticalStartTimestamp);\n          if (currentIndex !== -1) {\n            const newIndex = Math.max(0, Math.min(dataLength - 1, currentIndex + dataPointDelta));\n            const newDataPoint = chartData[newIndex];\n            \n            if (newDataPoint) {\n              // Update the annotation with new timestamp and time\n              updateAnnotations?.(prev => prev.map(ann => \n                ann.id === dragVerticalAnnotationId \n                  ? { \n                      ...ann, \n                      timestamp: (newDataPoint as any).timestamp,\n                      time: new Date((newDataPoint as any).timestamp).toLocaleTimeString('en-US', {\n                        hour: '2-digit',\n                        minute: '2-digit',\n                        hour12: false\n                      })\n                    }\n                  : ann\n              ));\n            }\n          }\n        }\n      };\n      \n      document.addEventListener('mouseup', handleGlobalMouseUp);\n      document.addEventListener('mousemove', handleGlobalMouseMove);\n      \n      return () => {\n        document.removeEventListener('mouseup', handleGlobalMouseUp);\n        document.removeEventListener('mousemove', handleGlobalMouseMove);\n      };\n    }\n  }, [isDragging, dragAnnotationId, dragStartY, dragStartPrice, isDraggingText, dragTextAnnotationId, dragTextStartX, dragTextStartY, dragStartOffset, dragStartVerticalOffset, isDraggingVertical, dragVerticalAnnotationId, dragVerticalStartX, dragVerticalStartTimestamp, updateAnnotations, chartData]);\n\n  // Click outside handler - works with portal\n  useEffect(() => {\n    const handleClickOutside = (event: MouseEvent) => {\n      const target = event.target as Node;\n      if (containerRef.current && !containerRef.current.contains(target) &&\n          dropdownRef.current && !dropdownRef.current.contains(target)) {\n        setIsDropdownOpen(false);\n      }\n    };\n\n    document.addEventListener('mousedown', handleClickOutside);\n    return () => document.removeEventListener('mousedown', handleClickOutside);\n  }, []);\n  \n  // Load recent searches from localStorage on mount\n  useEffect(() => {\n    const saved = localStorage.getItem('recentComparisonSearches');\n    if (saved) {\n      try {\n        setRecentSearches(JSON.parse(saved));\n      } catch (error) {\n        console.error('Error parsing recent searches:', error);\n      }\n    }\n  }, []);\n\n  // Debounce search query\n  useEffect(() => {\n    const timer = setTimeout(() => {\n      setDebouncedQuery(searchTerm);\n    }, 500);\n    return () => clearTimeout(timer);\n  }, [searchTerm]);\n\n  // Fetch search results using the global search endpoint\n  const { data: searchResults = [], isLoading: isSearchLoading } = useQuery({\n    queryKey: [\"/api/stocks/global-search\", debouncedQuery],\n    queryFn: async (): Promise<SearchResult[]> => {\n      if (!debouncedQuery || debouncedQuery.trim().length < 2) {\n        return [];\n      }\n      const response = await fetch(`/api/stocks/global-search?q=${encodeURIComponent(debouncedQuery.trim())}`);\n      if (!response.ok) throw new Error(\"Search failed\");\n      const globalResults = await response.json();\n      \n      // Transform global search results to SearchResult format\n      return globalResults.map((result: any) => ({\n        symbol: result.symbol,\n        name: result.description,\n        price: \"0.00\", // Global search doesn't include price, will be fetched when added\n        percentChange: \"0.00\", // Global search doesn't include change, will be fetched when added\n        marketCap: \"N/A\", // Global search doesn't include market cap, will be fetched when added\n        type: result.type || \"Common Stock\" // Include type for tags\n      }));\n    },\n    enabled: debouncedQuery.trim().length >= 2,\n  });\n\n  // Duplicate declarations removed - moved above to fix initialization order\n\n  // Chart configuration for shadcn\n  const chartConfig = useMemo(() => {\n    const config: Record<string, { label: string; color: string }> = {};\n    tickers.forEach((ticker) => {\n      config[`${ticker.symbol}_percentage`] = {\n        label: ticker.symbol,\n        color: ticker.color,\n      };\n    });\n    return config;\n  }, [tickers]);\n\n  // Add to recent searches functionality\n  const addToRecentSearches = (stock: SearchResult) => {\n    const newRecent = [stock, ...recentSearches.filter(s => s.symbol !== stock.symbol)].slice(0, 6);\n    setRecentSearches(newRecent);\n    localStorage.setItem('recentComparisonSearches', JSON.stringify(newRecent));\n  };\n\n  // Type display text conversion - convert ETP to ETF for display\n  const getDisplayType = (type: string | undefined) => {\n    if (!type) return \"Common Stock\";\n    if (type.toLowerCase() === 'etp') return 'ETF';\n    return type;\n  };\n\n  // Type tag styling function - matches main search styling\n  const getTypeColor = (type: string) => {\n    switch (type.toLowerCase()) {\n      case 'common stock':\n        return 'text-blue-600 dark:text-blue-400 bg-blue-500/10';\n      case 'index':\n        return 'text-[#FAFF50] bg-[#FAFF50]/30';\n      case 'etp':\n      case 'etf':\n        return 'text-[#FFA5FF] bg-[#FFA5FF]/30';\n      case 'mutual fund':\n        return 'text-orange-600 dark:text-orange-400 bg-orange-500/10';\n      default:\n        return 'text-gray-600 dark:text-gray-400 bg-gray-500/10';\n    }\n  };\n\n  // Handle input focus and dropdown positioning\n  const updateDropdownPosition = () => {\n    if (inputRef.current) {\n      const rect = inputRef.current.getBoundingClientRect();\n      setDropdownPosition({\n        top: rect.bottom + window.scrollY + 4,\n        left: rect.left + window.scrollX,\n        width: rect.width\n      });\n    }\n  };\n\n  const handleInputChange = (value: string) => {\n    setSearchTerm(value);\n    if (value.length > 0) {\n      updateDropdownPosition();\n      setIsDropdownOpen(true);\n    } else {\n      setIsDropdownOpen(false);\n    }\n  };\n\n  const handleInputFocus = (e: React.FocusEvent<HTMLInputElement>) => {\n    // Auto-select text if there's content when focusing\n    const currentValue = inputRef.current?.value || searchTerm;\n    if (currentValue.trim() && inputRef.current) {\n      setTimeout(() => {\n        if (inputRef.current) {\n          inputRef.current.select();\n        }\n      }, 10);\n    }\n    \n    updateDropdownPosition();\n    setIsDropdownOpen(true);\n  };\n\n  const handleSelectStock = (stock: SearchResult) => {\n    addTicker(stock.symbol, stock);\n  };\n\n  const addTicker = (symbol: string, stock?: SearchResult) => {\n    if (tickers.length >= 12) {\n      return; // Max 12 tickers\n    }\n    \n    if (tickers.find(t => t.symbol === symbol)) {\n      return; // Already added\n    }\n\n    const newTicker: TickerData = {\n      symbol: symbol.toUpperCase(),\n      color: TICKER_COLORS[tickers.length],\n      visible: true,\n    };\n\n    setTickers(prev => [...prev, newTicker]);\n    \n    // Add to recent searches if stock data is provided\n    if (stock) {\n      addToRecentSearches(stock);\n    }\n    \n    setSearchTerm('');\n    setIsSearchVisible(false);\n    setIsDropdownOpen(false);\n  };\n\n  const formatPercentChange = (change: string) => {\n    const numChange = parseFloat(change);\n    return {\n      value: Math.abs(numChange).toFixed(2),\n      isPositive: numChange >= 0\n    };\n  };\n\n  const removeTicker = (symbol: string) => {\n    setTickers(prev => prev.filter(t => t.symbol !== symbol));\n  };\n\n  const toggleTickerVisibility = (symbol: string) => {\n    setTickers(prev => prev.map(t => \n      t.symbol === symbol ? { ...t, visible: !t.visible } : t\n    ));\n  };\n\n  // Annotation handling methods\n  const handleChartClick = (event: any) => {\n    if (!event || !chartData) return;\n    \n    // For horizontal annotations, we handle ANY click on the chart (even without activePayload)\n    if (annotationMode === 'horizontal') {\n      // Freehand horizontal line placement\n      if (event.chartY !== undefined && event.chartX !== undefined) {\n        // For timestamp, use middle of chart data\n        const middleIndex = Math.floor(chartData.length / 2);\n        const timestamp = chartData[middleIndex]?.timestamp || Date.now();\n        const time = chartData[middleIndex]?.date || new Date().toISOString();\n        \n        // Calculate percentage from Y coordinate\n        let horizontalPrice = 0;\n        \n        // Get Y-axis domain (percentage range) from visible data\n        const visibleData = chartData.filter(d => \n          tickers.some(t => t.visible && d[`${t.symbol}_percentage`] !== undefined)\n        );\n        \n        if (visibleData.length > 0) {\n          // Calculate min/max percentages from visible data\n          let minPercent = Infinity;\n          let maxPercent = -Infinity;\n          \n          visibleData.forEach(d => {\n            tickers.filter(t => t.visible).forEach(ticker => {\n              const value = d[`${ticker.symbol}_percentage`];\n              if (value !== undefined) {\n                const numValue = typeof value === 'string' ? parseFloat(value) : value;\n                minPercent = Math.min(minPercent, numValue);\n                maxPercent = Math.max(maxPercent, numValue);\n              }\n            });\n          });\n          \n          // Add 5% padding to match YAxis domain calculation  \n          const range = maxPercent - minPercent;\n          const padding = range * 0.05;\n          const yAxisMin = minPercent - padding;\n          const yAxisMax = maxPercent + padding;\n          \n          // Get chart container to calculate actual dimensions\n          const chartContainer = document.querySelector('[data-testid=\"comparison-chart-container\"] .recharts-wrapper');\n          if (chartContainer) {\n            const rect = chartContainer.getBoundingClientRect();\n            const chartHeight = rect.height;\n            const plotTop = 10; // Approximate top margin\n            const plotBottom = 40; // Approximate bottom margin for axis\n            const plotHeight = chartHeight - plotTop - plotBottom;\n            \n            // Calculate relative Y position (0 = top, 1 = bottom)\n            const relativeY = Math.max(0, Math.min(1, (event.chartY - plotTop) / plotHeight));\n            \n            // Convert click position to percentage value (Y is inverted)\n            horizontalPrice = yAxisMax - (relativeY * (yAxisMax - yAxisMin));\n          }\n        }\n        \n        // Create horizontal annotation\n        const newAnnotation: Omit<Annotation, 'id' | 'text'> = {\n          type: 'horizontal',\n          x: 0,\n          y: 0,  \n          timestamp,\n          price: horizontalPrice,\n          time\n        };\n        \n        setPendingAnnotation(newAnnotation);\n        setShowAnnotationInput(true);\n        setAnnotationInput('');\n        // Pre-fill the percentage input with the clicked position (can be edited)\n        setHorizontalPercentageInput(horizontalPrice.toFixed(2));\n        setEditingAnnotation(null);\n        setIsEditMode(false);\n        return; // Exit early for horizontal annotations\n      }\n    }\n    \n    // For other annotation types, require activePayload (clicking on data points)\n    if (!event.activePayload || event.activePayload.length === 0) return;\n    \n    const { activePayload, activeLabel } = event;\n    const clickedData = activePayload[0].payload;\n    const timestamp = clickedData.timestamp;\n    const time = clickedData.date;\n    \n    // For comparison chart, get the first visible ticker's percentage value at this point\n    const firstVisibleTicker = tickers.find(t => t.visible);\n    if (!firstVisibleTicker) return;\n    \n    const percentageValue = clickedData[`${firstVisibleTicker.symbol}_percentage`] || 0;\n    \n    if (annotationMode === 'text') {\n      // Text annotation mode - single click\n      const newAnnotation: Omit<Annotation, 'id' | 'text'> = {\n        type: 'text',\n        x: 0, // Will be calculated during rendering\n        y: 0, // Will be calculated during rendering  \n        timestamp,\n        price: percentageValue,\n        time\n      };\n      \n      setPendingAnnotation(newAnnotation);\n      setShowAnnotationInput(true);\n      setAnnotationInput('');\n      setEditingAnnotation(null);\n      setIsEditMode(false);\n    } else if (annotationMode === 'horizontal') {\n      // This case is now handled earlier in the function for freehand placement\n      // This code path should not be reached for horizontal annotations\n      return;\n    } else if (annotationMode === 'percentage') {\n      // Percentage measurement mode - two clicks\n      if (!pendingPercentageStart) {\n        // First click - set start point\n        setPendingPercentageStart?.({\n          timestamp,\n          price: percentageValue,\n          time\n        });\n      } else {\n        // Second click - create percentage measurement\n        const startPercentage = pendingPercentageStart.price;\n        const endPercentage = percentageValue;\n        const percentageDifference = endPercentage - startPercentage; // Direct percentage point difference\n        \n        const newAnnotation: Annotation = {\n          id: `percentage-${Date.now()}`,\n          type: 'percentage',\n          x: 0,\n          y: 0,\n          timestamp: pendingPercentageStart.timestamp,\n          price: startPercentage,\n          time: pendingPercentageStart.time,\n          startTimestamp: pendingPercentageStart.timestamp,\n          startPrice: startPercentage,\n          startTime: pendingPercentageStart.time,\n          endTimestamp: timestamp,\n          endPrice: endPercentage,\n          endTime: time,\n          percentage: percentageDifference\n        };\n        \n        updateAnnotations?.(prev => [...prev, newAnnotation]);\n        setPendingPercentageStart?.(null);\n      }\n    }\n  };\n\n  // Handle annotation double-click for editing\n  const handleAnnotationDoubleClick = (annotation: Annotation) => {\n    if (annotation.type === 'text' || annotation.type === 'horizontal') {\n      setEditingAnnotation(annotation);\n      setIsEditMode(true);\n      setAnnotationInput(annotation.text || '');\n      if (annotation.type === 'horizontal') {\n        setHorizontalPercentageInput(annotation.price?.toString() || '');\n      }\n      setShowAnnotationInput(true);\n    } else if (annotation.type === 'percentage') {\n      // For percentage annotations, delete directly like Price chart (no confirmation)\n      updateAnnotations?.(prev => prev.filter(a => a.id !== annotation.id));\n    }\n  };\n\n  // Clear all annotations\n  const clearAllAnnotations = () => {\n    if (confirm('Delete all annotations?')) {\n      updateAnnotations?.([]);\n      setPendingPercentageStart?.(null);\n    }\n  };\n\n  // Save annotation with user text\n  const saveAnnotation = () => {\n    if (isEditMode && editingAnnotation) {\n      // Update existing annotation\n      if (editingAnnotation.type === 'horizontal') {\n        // For horizontal annotations, update both percentage and text\n        const newPercentage = parseFloat(horizontalPercentageInput);\n        if (!isNaN(newPercentage)) {\n          updateAnnotations?.(prev => prev.map(annotation => \n            annotation.id === editingAnnotation.id \n              ? { ...annotation, price: newPercentage, text: annotationInput.trim() }\n              : annotation\n          ));\n        }\n      } else if (annotationInput.trim()) {\n        updateAnnotations?.(prev => prev.map(annotation => \n          annotation.id === editingAnnotation.id \n            ? { ...annotation, text: annotationInput.trim() }\n            : annotation\n        ));\n      }\n      setShowAnnotationInput(false);\n      setAnnotationInput('');\n      setHorizontalPercentageInput('');\n      setEditingAnnotation(null);\n      setIsEditMode(false);\n    } else if (pendingAnnotation) {\n      // Create new annotation\n      if (pendingAnnotation.type === 'horizontal') {\n        // For horizontal annotations, use the entered percentage value\n        const newPercentage = parseFloat(horizontalPercentageInput);\n        if (!isNaN(newPercentage)) {\n          const newAnnotation: Annotation = {\n            ...pendingAnnotation,\n            id: `annotation-${Date.now()}`,\n            price: newPercentage,\n            text: annotationInput.trim() || ''\n          };\n          updateAnnotations?.(prev => [...prev, newAnnotation]);\n        }\n      } else if (annotationInput.trim()) {\n        const newAnnotation: Annotation = {\n          ...pendingAnnotation,\n          id: `annotation-${Date.now()}`,\n          text: annotationInput.trim()\n        };\n        updateAnnotations?.(prev => [...prev, newAnnotation]);\n      }\n      setShowAnnotationInput(false);\n      setAnnotationInput('');\n      setHorizontalPercentageInput('');\n      setPendingAnnotation(null);\n    }\n  };\n\n  // Delete annotation\n  const deleteAnnotation = () => {\n    if (editingAnnotation) {\n      updateAnnotations?.(prev => prev.filter(annotation => annotation.id !== editingAnnotation.id));\n      setShowAnnotationInput(false);\n      setAnnotationInput('');\n      setEditingAnnotation(null);\n      setIsEditMode(false);\n    }\n  };\n\n  // Cancel annotation\n  const cancelAnnotation = () => {\n    setShowAnnotationInput(false);\n    setAnnotationInput('');\n    setHorizontalPercentageInput('');\n    setPendingAnnotation(null);\n    setEditingAnnotation(null);\n    setIsEditMode(false);\n  };\n\n  // Format price helper for percentage values\n  const formatPrice = (price: number) => {\n    return `${price > 0 ? '+' : ''}${price.toFixed(2)}`;\n  };\n\n  // Check loading and error states\n  const isLoading = tickerQueries.some(query => query.isLoading);\n  const hasErrors = tickerQueries.some(query => query.isError);\n  const errorMessages = tickerQueries\n    .filter(query => query.isError)\n    .map((query, index) => `${tickers[index]?.symbol}: ${query.error?.message || 'Unknown error'}`);\n\n  // Export CSV function for shared export functionality  \n  const exportCSV = () => {\n    if (chartData.length === 0) {\n      toast({\n        title: \"No Data\",\n        description: \"No chart data available to export\",\n        variant: \"destructive\",\n      });\n      return;\n    }\n\n    try {\n      // Create CSV header\n      const headers = ['Date', ...tickers.filter(t => t.visible).map(t => `${t.symbol} %`), ...tickers.filter(t => t.visible).map(t => `${t.symbol} Price`)];\n      \n      // Create CSV rows\n      const csvRows = chartData.map(dataPoint => {\n        const row = [dataPoint.date];\n        \n        // Add percentage values\n        tickers.filter(t => t.visible).forEach(ticker => {\n          row.push(dataPoint[`${ticker.symbol}_percentage`]?.toString() || '');\n        });\n        \n        // Add price values\n        tickers.filter(t => t.visible).forEach(ticker => {\n          row.push(dataPoint[`${ticker.symbol}_price`]?.toString() || '');\n        });\n        \n        return row.join(',');\n      });\n      \n      // Combine header and rows\n      const csvContent = [headers.join(','), ...csvRows].join('\\n');\n      \n      // Create and download file\n      const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });\n      const fileName = `comparison-chart-${tickers.map(t => t.symbol).join('-')}-${new Date().toISOString().split('T')[0]}.csv`;\n      saveAs(blob, fileName);\n      \n      toast({\n        title: \"Export Successful\",\n        description: \"CSV file has been downloaded\",\n      });\n    } catch (error) {\n      toast({\n        title: \"Export Failed\", \n        description: \"Unable to export CSV file\",\n        variant: \"destructive\",\n      });\n    }\n  };\n\n  // Helper function to manually draw comparison chart to canvas (completely bypasses OKLCH and SVG issues)\n  const captureFullChartAsCanvas = async (): Promise<HTMLCanvasElement> => {\n    console.log('Creating manual canvas export to bypass all OKLCH and SVG issues...');\n\n    if (chartData.length === 0) {\n      throw new Error('No chart data available for export');\n    }\n\n    // Create high-resolution canvas\n    const canvas = document.createElement('canvas');\n    canvas.width = 2000; // High resolution width\n    canvas.height = 1400; // Height for chart + legend + title\n    const ctx = canvas.getContext('2d')!;\n    \n    // Enable high-quality rendering\n    ctx.imageSmoothingEnabled = true;\n    ctx.imageSmoothingQuality = 'high';\n    \n    // Use transparent background\n    ctx.clearRect(0, 0, canvas.width, canvas.height);\n    \n    // Add title\n    ctx.fillStyle = '#5AF5FA';\n    ctx.font = 'bold 48px system-ui, -apple-system, sans-serif';\n    const visibleTickers = tickers.filter(ticker => ticker.visible);\n    const title = `Stock Comparison: ${visibleTickers.map(t => t.symbol).join(' vs ')}`;\n    ctx.fillText(title, 60, 80);\n    \n    // Add date range\n    ctx.fillStyle = '#F7F7F7';\n    ctx.font = '36px system-ui, -apple-system, sans-serif';\n    const startDate = new Date(chartData[0].date);\n    const endDate = new Date(chartData[chartData.length - 1].date);\n    const dateRange = `${startDate.toLocaleDateString()} - ${endDate.toLocaleDateString()}`;\n    ctx.fillText(`Date Range: ${dateRange}`, 60, 140);\n    \n    // Chart area\n    const chartArea = { x: 120, y: 220, width: 1680, height: 800 };\n    \n    // Draw grid lines\n    ctx.strokeStyle = 'rgba(136, 136, 136, 0.3)';\n    ctx.lineWidth = 1;\n    \n    // Horizontal grid lines (percentage levels)\n    const ySteps = 10;\n    for (let i = 0; i <= ySteps; i++) {\n      const y = chartArea.y + (i * chartArea.height / ySteps);\n      ctx.beginPath();\n      ctx.moveTo(chartArea.x, y);\n      ctx.lineTo(chartArea.x + chartArea.width, y);\n      ctx.stroke();\n    }\n    \n    // Vertical grid lines (time)\n    const xSteps = 8;\n    for (let i = 0; i <= xSteps; i++) {\n      const x = chartArea.x + (i * chartArea.width / xSteps);\n      ctx.beginPath();\n      ctx.moveTo(x, chartArea.y);\n      ctx.lineTo(x, chartArea.y + chartArea.height);\n      ctx.stroke();\n    }\n    \n    // Draw 0% reference line (more prominent)\n    ctx.strokeStyle = '#ffffff';\n    ctx.lineWidth = 2;\n    const zeroY = chartArea.y + chartArea.height / 2; // Assuming 0% is in the middle\n    ctx.beginPath();\n    ctx.moveTo(chartArea.x, zeroY);\n    ctx.lineTo(chartArea.x + chartArea.width, zeroY);\n    ctx.stroke();\n    \n    // Draw Y-axis labels (percentages)\n    ctx.fillStyle = '#ffffff';\n    ctx.font = '24px system-ui, sans-serif';\n    ctx.textAlign = 'right';\n    \n    // Calculate min/max percentages for scaling\n    let minPercent = 0, maxPercent = 0;\n    visibleTickers.forEach(ticker => {\n      chartData.forEach(dataPoint => {\n        const percentage = Number(dataPoint[`${ticker.symbol}_percentage`] || 0);\n        minPercent = Math.min(minPercent, percentage);\n        maxPercent = Math.max(maxPercent, percentage);\n      });\n    });\n    \n    // Add some padding to the range\n    const range = Math.max(Math.abs(minPercent), Math.abs(maxPercent)) * 1.1;\n    minPercent = -range;\n    maxPercent = range;\n    \n    for (let i = 0; i <= ySteps; i++) {\n      const percentage = maxPercent - (i * (maxPercent - minPercent) / ySteps);\n      const y = chartArea.y + (i * chartArea.height / ySteps);\n      ctx.fillText(`${percentage.toFixed(1)}%`, chartArea.x - 20, y + 8);\n    }\n    \n    // Draw lines for each visible ticker using the actual TICKER_COLORS from the chart\n    const colors = ['#5AF5FA', '#FFA5FF', '#AA99FF', '#FAFF50', '#50FFA5'];\n    \n    visibleTickers.forEach((ticker, tickerIndex) => {\n      ctx.strokeStyle = colors[tickerIndex % colors.length];\n      ctx.lineWidth = 4;\n      ctx.beginPath();\n      \n      let firstPoint = true;\n      chartData.forEach((dataPoint, dataIndex) => {\n        const percentage = Number(dataPoint[`${ticker.symbol}_percentage`] || 0);\n        \n        // Calculate position\n        const x = chartArea.x + (dataIndex * chartArea.width / (chartData.length - 1));\n        const y = chartArea.y + chartArea.height - ((percentage - minPercent) / (maxPercent - minPercent)) * chartArea.height;\n        \n        if (firstPoint) {\n          ctx.moveTo(x, y);\n          firstPoint = false;\n        } else {\n          ctx.lineTo(x, y);\n        }\n      });\n      \n      ctx.stroke();\n    });\n    \n    // Draw X-axis labels (dates)\n    ctx.fillStyle = '#ffffff';\n    ctx.font = '20px system-ui, sans-serif';\n    ctx.textAlign = 'center';\n    \n    const labelStep = Math.max(1, Math.floor(chartData.length / 6)); // Show ~6 date labels\n    for (let i = 0; i < chartData.length; i += labelStep) {\n      const date = new Date(chartData[i].date);\n      const x = chartArea.x + (i * chartArea.width / (chartData.length - 1));\n      ctx.fillText(date.toLocaleDateString(), x, chartArea.y + chartArea.height + 40);\n    }\n    \n    // Draw legend\n    ctx.textAlign = 'left';\n    ctx.font = 'bold 32px system-ui, sans-serif';\n    \n    let legendY = chartArea.y + chartArea.height + 100;\n    let legendX = 120;\n    \n    visibleTickers.forEach((ticker, index) => {\n      // Draw color circle using exact chart colors\n      ctx.fillStyle = colors[index % colors.length];\n      ctx.beginPath();\n      ctx.arc(legendX + 20, legendY, 15, 0, 2 * Math.PI);\n      ctx.fill();\n      \n      // Draw ticker symbol and percentage\n      ctx.fillStyle = '#ffffff';\n      const latestData = chartData[chartData.length - 1];\n      const percentage = latestData ? Number(latestData[`${ticker.symbol}_percentage`] || 0) : 0;\n      const percentageStr = percentage > 0 ? `+${percentage.toFixed(2)}%` : `${percentage.toFixed(2)}%`;\n      const text = `${ticker.symbol} ${percentageStr}`;\n      \n      ctx.fillText(text, legendX + 50, legendY + 10);\n      \n      // Move to next position\n      const textWidth = ctx.measureText(text).width;\n      legendX += textWidth + 120;\n      \n      // Wrap to next line if needed\n      if (legendX > canvas.width - 300) {\n        legendX = 120;\n        legendY += 60;\n      }\n    });\n    \n    console.log('Manual canvas export completed successfully');\n    return canvas;\n  };\n\n  // PNG export function - uses manual canvas to ensure legend is included\n  const exportPNG = async () => {\n    try {\n      // Use manual canvas export to guarantee legend inclusion\n      const canvas = await captureFullChartAsCanvas();\n      const dataUrl = canvas.toDataURL('image/png');\n      \n      const fileName = `comparison-chart-${tickers.filter(t => t.visible).map(t => t.symbol).join('-')}-${new Date().toISOString().split('T')[0]}.png`;\n      const link = document.createElement('a');\n      link.download = fileName;\n      link.href = dataUrl;\n      link.click();\n      \n      toast({\n        title: 'Export Successful',\n        description: `Chart exported as ${fileName} (with ticker legend)`,\n      });\n    } catch (err) {\n      console.error('PNG export failed:', err);\n      toast({\n        title: 'Export Failed',\n        description: 'PNG export failed. Please try again.',\n        variant: 'destructive',\n      });\n    }\n  };\n\n  // PDF export function - uses manual canvas to ensure legend is included\n  const exportPDF = async () => {\n    try {\n      // Use manual canvas export to guarantee legend inclusion\n      const canvas = await captureFullChartAsCanvas();\n      const dataUrl = canvas.toDataURL('image/png');\n      \n      const img = new globalThis.Image();\n      img.src = dataUrl;\n      await (img.decode ? img.decode() : new Promise(r => (img.onload = () => r(null))));\n      const orientation = img.width >= img.height ? 'landscape' : 'portrait';\n      const pdf = new jsPDF({ orientation, unit: 'px', format: [img.width, img.height] });\n      pdf.addImage(dataUrl, 'PNG', 0, 0, img.width, img.height, undefined, 'FAST');\n      \n      const fileName = `comparison-chart-${tickers.filter(t => t.visible).map(t => t.symbol).join('-')}-${new Date().toISOString().split('T')[0]}.pdf`;\n      pdf.save(fileName);\n      \n      toast({ title: 'Export Successful', description: `Chart exported as ${fileName} (with ticker legend)` });\n    } catch (err) {\n      console.error('PDF export failed:', err);\n      toast({ title: 'Export Failed', description: 'PDF export failed. Please try again.', variant: 'destructive' });\n    }\n  };\n\n  // SVG export function for shared export functionality\n  const exportSVG = async () => {\n    const chartContainer = document.querySelector('[data-testid=\"comparison-chart-container\"]');\n    if (!chartContainer) return;\n\n    try {\n      const svgDataUrl = await htmlToImage.toSvg(chartContainer as HTMLElement, {\n        cacheBust: true,\n        backgroundColor: '#121212',\n        filter: (n) => !n.classList?.contains('no-export'),\n      });\n      \n      // Convert data URL to proper blob\n      const blob = await (await fetch(svgDataUrl)).blob();\n      const fileName = `comparison-chart-${tickers.filter(t => t.visible).map(t => t.symbol).join('-')}-${new Date().toISOString().split('T')[0]}.svg`;\n      \n      const url = URL.createObjectURL(blob);\n      const a = document.createElement('a');\n      a.href = url; \n      a.download = fileName; \n      document.body.appendChild(a); \n      a.click();\n      document.body.removeChild(a); \n      URL.revokeObjectURL(url);\n      \n      toast({ title: 'Export Successful', description: `Chart exported as ${fileName}` });\n    } catch (e) {\n      console.error('SVG export failed:', e);\n      toast({ title: 'SVG Export Failed', description: 'SVG export failed. Please try again.', variant: 'destructive' });\n    }\n  };\n\n  // SVG code export function for embeddable code\n  const exportCode = async () => {\n    const chartContainer = document.querySelector('[data-testid=\"comparison-chart-container\"]');\n    if (!chartContainer) {\n      toast({\n        title: \"Export Failed\",\n        description: \"Chart not found. Please try again.\",\n        variant: \"destructive\"\n      });\n      return;\n    }\n\n    try {\n      // Generate SVG of the comparison chart\n      const svgDataUrl = await htmlToImage.toSvg(chartContainer as HTMLElement, {\n        cacheBust: true,\n        backgroundColor: '#ffffff',\n        filter: (n) => !n.classList?.contains('no-export'),\n      });\n      \n      // Convert data URL to SVG string\n      const svgString = decodeURIComponent(svgDataUrl.split(',')[1]);\n      const visibleTickers = tickers.filter(t => t.visible).map(t => t.symbol).join(', ');\n      \n      // Create embeddable code with the SVG\n      const embedCode = `<!-- Intropic Chart Editor - Comparison Chart (${visibleTickers}) -->\n<!-- Generated on ${new Date().toLocaleDateString()} -->\n<div class=\"intropic-comparison-chart-container\" style=\"width: 100%; max-width: 1000px; margin: 0 auto;\">\n  ${svgString}\n</div>\n\n<!-- Alternative: Inline SVG with custom styling -->\n<div class=\"stock-comparison-chart\" style=\"\n  display: inline-block; \n  border: 1px solid #e2e8f0; \n  border-radius: 8px; \n  padding: 16px;\n  background: white;\n  box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);\n\">\n  ${svgString}\n  <div style=\"margin-top: 8px; text-align: center; font-size: 12px; color: #666;\">\n    ${visibleTickers} Comparison  Powered by Intropic Chart Editor\n  </div>\n</div>\n\n<!-- For WordPress/CMS: Base64 Encoded -->\n<img src=\"${svgDataUrl}\" alt=\"${visibleTickers} Comparison Chart\" style=\"max-width: 100%; height: auto;\" />`;\n\n      navigator.clipboard.writeText(embedCode).then(() => {\n        toast({\n          title: \"SVG Embed Code Copied!\",\n          description: \"Comparison chart SVG code has been copied to your clipboard.\",\n        });\n      }).catch(() => {\n        // Fallback: download the code\n        const blob = new Blob([embedCode], { type: 'text/html' });\n        const url = URL.createObjectURL(blob);\n        const a = document.createElement('a');\n        a.href = url;\n        a.download = `comparison_chart_${tickers.filter(t => t.visible).map(t => t.symbol).join('_')}_embed.html`;\n        a.click();\n        URL.revokeObjectURL(url);\n        toast({\n          title: \"SVG Embed Code Downloaded\",\n          description: \"Comparison chart SVG code has been downloaded as an HTML file.\",\n        });\n      });\n    } catch (error) {\n      console.error('Code export failed:', error);\n      toast({\n        title: \"Export Failed\",\n        description: \"Failed to generate embed code. Please try again.\",\n        variant: \"destructive\"\n      });\n    }\n  };\n\n  // Add event listeners for shared export functionality\n  useEffect(() => {\n    const chartContainer = document.querySelector('[data-testid=\"comparison-chart-container\"]');\n    if (chartContainer) {\n      const handleExportCSV = () => exportCSV();\n      const handleExportPNG = () => exportPNG();\n      const handleExportPDF = () => exportPDF();\n      const handleExportSVG = () => exportSVG();\n      const handleExportCode = () => exportCode();\n      \n      chartContainer.addEventListener('exportCSV', handleExportCSV);\n      chartContainer.addEventListener('exportPNG', handleExportPNG);\n      chartContainer.addEventListener('exportPDF', handleExportPDF);\n      chartContainer.addEventListener('exportSVG', handleExportSVG);\n      chartContainer.addEventListener('exportCode', handleExportCode);\n      \n      return () => {\n        chartContainer.removeEventListener('exportCSV', handleExportCSV);\n        chartContainer.removeEventListener('exportPNG', handleExportPNG);\n        chartContainer.removeEventListener('exportPDF', handleExportPDF);\n        chartContainer.removeEventListener('exportSVG', handleExportSVG);\n        chartContainer.removeEventListener('exportCode', handleExportCode);\n      };\n    }\n  }, [chartData, tickers]);\n\n\n  // Currency mapping for different markets\n  const getCurrencySymbol = (currencyCode: string | undefined): string => {\n    if (!currencyCode) return '$';\n    \n    const currencyMap: Record<string, string> = {\n      'USD': '$',\n      'JPY': '',\n      'EUR': '',\n      'GBP': '',\n      'CAD': 'C$',\n      'AUD': 'A$',\n      'CHF': 'CHF ',\n      'CNY': '',\n      'KRW': '',\n      'HKD': 'HK$',\n      'SGD': 'S$',\n      'INR': '',\n      'BRL': 'R$',\n      'MXN': '$',\n      'SEK': 'kr',\n      'NOK': 'kr',\n      'DKK': 'kr',\n      'PLN': 'z',\n      'CZK': 'K',\n      'HUF': 'Ft',\n      'RUB': '',\n      'TRY': '',\n      'ZAR': 'R',\n      'ILS': '',\n      'THB': '',\n      'MYR': 'RM',\n      'PHP': '',\n      'IDR': 'Rp',\n      'VND': '',\n      'TWD': 'NT$'\n    };\n    \n    return currencyMap[currencyCode.toUpperCase()] || currencyCode.toUpperCase() + ' ';\n  };\n\n  const formatCurrencyPrice = (value: number, currencyCode: string | undefined) => {\n    const currencySymbol = getCurrencySymbol(currencyCode);\n    \n    // For JPY and similar currencies, don't show decimal places\n    if (currencyCode === 'JPY' || currencyCode === 'KRW') {\n      return `${currencySymbol}${Math.round(value).toLocaleString()}`;\n    }\n    \n    return `${currencySymbol}${value.toFixed(2)}`;\n  };\n\n  // Custom tooltip that shows actual prices with better date formatting\n  const CustomTooltip = ({ active, payload, label }: any) => {\n    if (!active || !payload || !payload.length) return null;\n\n    // Use the properly formatted date from the chart data\n    const formattedDate = label;\n\n    return (\n      <div className=\"bg-background border border-border rounded-lg shadow-lg\" style={{ padding: '6px 10px', fontSize: '11px', opacity: 0.8 }}>\n        <div className=\"font-medium border-b border-border/50\" style={{ marginBottom: '6px', paddingBottom: '3px', lineHeight: '1.4' }}>{formattedDate}</div>\n        {payload.map((entry: any, index: number) => {\n          const ticker = tickers.find(t => `${t.symbol}_percentage` === entry.dataKey);\n          if (!ticker || !ticker.visible) return null;\n\n          // Get actual price from data point  \n          const percentage = entry.value;\n          const actualPrice = entry.payload[`${ticker.symbol}_price`] || 0;\n          const currency = entry.payload[`${ticker.symbol}_currency`] || 'USD';\n\n          return (\n            <div key={index} className=\"flex items-center justify-between gap-4 py-1\">\n              <div className=\"flex items-center gap-2\">\n                <div \n                  className=\"w-3 h-3 rounded-sm\"\n                  style={{ backgroundColor: entry.color }}\n                />\n                <span className=\"text-sm\">{ticker.symbol}</span>\n              </div>\n              <div className=\"text-right\">\n                <div className=\"font-mono text-sm\">\n                  {percentage > 0 ? '+' : ''}{percentage.toFixed(2)}%\n                </div>\n                <div className=\"text-xs text-muted-foreground\">\n                  {formatCurrencyPrice(actualPrice, currency)}\n                </div>\n              </div>\n            </div>\n          );\n        })}\n      </div>\n    );\n  };\n\n  return (\n    <div className=\"space-y-4 overflow-x-hidden w-full max-[900px]:space-y-3\" data-testid=\"comparison-chart-full-container\">\n      {/* Header with Ticker Management and Export */}\n      <div className=\"flex flex-col max-[900px]:gap-3 min-[901px]:flex-row min-[901px]:items-center min-[901px]:justify-between gap-2 mb-4 w-full\">\n        <div className=\"flex flex-wrap items-center gap-2 max-[600px]:gap-1.5\">\n        {/* Active Tickers */}\n        {tickers.map((ticker) => (\n          <div\n            key={ticker.symbol}\n            className=\"flex items-center gap-1 px-2 py-1 bg-muted rounded-md text-sm\"\n          >\n            <div \n              className=\"w-3 h-3 rounded-sm cursor-pointer\"\n              style={{ \n                backgroundColor: ticker.visible ? ticker.color : '#666',\n                opacity: ticker.visible ? 1 : 0.5 \n              }}\n              onClick={() => toggleTickerVisibility(ticker.symbol)}\n              data-testid={`toggle-visibility-${ticker.symbol}`}\n            />\n            <span className={ticker.visible ? '' : 'opacity-50'}>{ticker.symbol}</span>\n            <Button\n              variant=\"ghost\"\n              size=\"sm\"\n              className=\"h-4 w-4 p-0 hover:bg-destructive hover:text-destructive-foreground\"\n              onClick={() => removeTicker(ticker.symbol)}\n              data-testid={`remove-ticker-${ticker.symbol}`}\n            >\n              <X className=\"h-3 w-3\" />\n            </Button>\n          </div>\n        ))}\n\n        {/* Add Ticker Button */}\n        {tickers.length < 12 && (\n          <Button\n            variant=\"outline\"\n            size=\"sm\"\n            className=\"h-7\"\n            onClick={() => setIsSearchVisible(!isSearchVisible)}\n            data-testid=\"button-add-ticker\"\n          >\n            <Plus className=\"h-3 w-3 mr-1\" />\n            Add Ticker\n          </Button>\n        )}\n        </div>\n        \n        <div className=\"flex items-center gap-2 max-[900px]:justify-between\">\n          {/* Pending Percentage Indicator */}\n          {annotationMode === 'percentage' && pendingPercentageStart && (\n            <div className=\"text-xs text-muted-foreground bg-muted/50 px-2 py-1 rounded border\">\n              Click second point to measure\n            </div>\n          )}\n        </div>\n      </div>\n\n      {/* Search Input with Predictive Search */}\n      {isSearchVisible && (\n        <div ref={containerRef}>\n          <Card className=\"p-3\">\n            <div className=\"flex items-center gap-2\">\n              <Search className=\"h-4 w-4 text-muted-foreground\" />\n              <Input\n                ref={inputRef}\n                placeholder=\"Search stocks (e.g., AAPL, Apple Inc)\"\n                value={searchTerm}\n                onChange={(e) => handleInputChange(e.target.value)}\n                onFocus={handleInputFocus}\n                onKeyDown={(e) => {\n                  if (e.key === 'Enter' && searchTerm.trim()) {\n                    // Try to find exact match in search results for recent searches\n                    const exactMatch = searchResults.find(s => \n                      s.symbol.toLowerCase() === searchTerm.trim().toLowerCase()\n                    );\n                    addTicker(searchTerm.trim(), exactMatch);\n                  }\n                  if (e.key === 'Escape') {\n                    setIsSearchVisible(false);\n                    setSearchTerm('');\n                    setIsDropdownOpen(false);\n                  }\n                }}\n                className=\"flex-1\"\n                data-testid=\"input-ticker-search\"\n              />\n              <Button\n                onClick={() => {\n                  if (searchTerm.trim()) {\n                    // Try to find exact match in search results for recent searches\n                    const exactMatch = searchResults.find(s => \n                      s.symbol.toLowerCase() === searchTerm.trim().toLowerCase()\n                    );\n                    addTicker(searchTerm.trim(), exactMatch);\n                  }\n                }}\n                disabled={!searchTerm.trim()}\n                size=\"sm\"\n                data-testid=\"button-add-ticker-search\"\n              >\n                Add\n              </Button>\n            </div>\n          </Card>\n\n          {/* Search Results Dropdown */}\n          {isDropdownOpen && createPortal(\n            <Card \n              ref={dropdownRef}\n              className=\"max-h-80 overflow-y-auto shadow-xl border-border bg-card\"\n              style={{\n                position: 'absolute',\n                top: dropdownPosition.top,\n                left: dropdownPosition.left,\n                width: dropdownPosition.width,\n                zIndex: 10000\n              }}\n            >\n              {/* Show recent searches when query is empty */}\n              {(!searchTerm.trim() && recentSearches.length > 0) ? (\n                <div className=\"py-2\">\n                  <div className=\"px-4 py-2 text-xs font-medium text-muted-foreground border-b border-border/50\">\n                    Recent Searches\n                  </div>\n                  {recentSearches.map((stock) => {\n                    const { value: changeValue, isPositive } = formatPercentChange(stock.percentChange);\n                    return (\n                      <div\n                        key={`recent-${stock.symbol}-${stock.name}`}\n                        className=\"w-full px-4 py-3 hover:bg-muted/50 transition-colors border-b border-border/50 last:border-b-0 cursor-pointer\"\n                        onClick={() => handleSelectStock(stock)}\n                        data-testid={`recent-search-${stock.symbol}`}\n                      >\n                        <div className=\"flex items-center justify-between\">\n                          <div className=\"flex-1 min-w-0\">\n                            <div className=\"flex items-center gap-2\">\n                              <span className=\"font-semibold text-foreground\">{stock.symbol}</span>\n                              <span className=\"text-sm text-muted-foreground truncate\">\n                                {stock.name}\n                              </span>\n                            </div>\n                            <div className=\"text-xs text-muted-foreground mt-1\">\n                              {stock.marketCap}\n                            </div>\n                          </div>\n                          <div className=\"flex items-center gap-2 ml-4\">\n                            <span className=\"font-medium text-foreground\">\n                              ${parseFloat(stock.price).toFixed(2)}\n                            </span>\n                            <div className={cn(\n                              \"flex items-center gap-1 px-2 py-1 rounded-md text-xs font-medium\",\n                              isPositive \n                                ? \"bg-green-500/10 text-green-600 dark:text-green-400\" \n                                : \"bg-red-500/10 text-red-600 dark:text-red-400\"\n                            )}>\n                              {isPositive ? (\n                                <TrendingUp className=\"w-3 h-3\" />\n                              ) : (\n                                <TrendingDown className=\"w-3 h-3\" />\n                              )}\n                              {changeValue}%\n                            </div>\n                          </div>\n                        </div>\n                      </div>\n                    );\n                  })}\n                </div>\n              ) : debouncedQuery.trim().length >= 2 ? (\n                <div className=\"py-2\">\n                  {isSearchLoading ? (\n                    <div className=\"px-4 py-3 text-center text-muted-foreground\">\n                      Searching...\n                    </div>\n                  ) : searchResults.length > 0 ? (\n                    searchResults.map((stock) => {\n                      const { value: changeValue, isPositive } = formatPercentChange(stock.percentChange);\n                      return (\n                        <div\n                          key={`search-${stock.symbol}-${stock.name}`}\n                          className=\"w-full px-4 py-3 hover:bg-muted/50 transition-colors border-b border-border/50 last:border-b-0 cursor-pointer\"\n                          onClick={() => handleSelectStock(stock)}\n                          data-testid={`search-result-${stock.symbol}`}\n                        >\n                          <div className=\"flex items-center justify-between\">\n                            <div className=\"flex-1 min-w-0\">\n                              <div className=\"flex items-center gap-2\">\n                                <span className=\"font-semibold text-foreground\">{stock.symbol}</span>\n                                <span className={cn(\"px-2 py-1 rounded-full text-xs font-medium\", getTypeColor(stock.type || \"Common Stock\"))}>\n                                  {getDisplayType(stock.type)}\n                                </span>\n                              </div>\n                              <div className=\"text-sm text-muted-foreground truncate mt-1\">\n                                {stock.name}\n                              </div>\n                              <div className=\"text-xs text-muted-foreground mt-1\">\n                                {stock.marketCap}\n                              </div>\n                            </div>\n                            <div className=\"flex items-center gap-2 ml-4\">\n                              <span className=\"font-medium text-foreground\">\n                                ${parseFloat(stock.price).toFixed(2)}\n                              </span>\n                              <div className={cn(\n                                \"flex items-center gap-1 px-2 py-1 rounded-md text-xs font-medium\",\n                                isPositive \n                                  ? \"bg-green-500/10 text-green-600 dark:text-green-400\" \n                                  : \"bg-red-500/10 text-red-600 dark:text-red-400\"\n                              )}>\n                                {isPositive ? (\n                                  <TrendingUp className=\"w-3 h-3\" />\n                                ) : (\n                                  <TrendingDown className=\"w-3 h-3\" />\n                                )}\n                                {changeValue}%\n                              </div>\n                            </div>\n                          </div>\n                        </div>\n                      );\n                    })\n                  ) : debouncedQuery && !isSearchLoading ? (\n                    <div className=\"px-4 py-3 text-center text-muted-foreground\">\n                      No results found for \"{debouncedQuery}\"\n                    </div>\n                  ) : null}\n                </div>\n              ) : searchTerm.trim().length > 0 && searchTerm.trim().length < 2 ? (\n                <div className=\"px-4 py-3 text-center text-muted-foreground\">\n                  Type at least 2 characters to search\n                </div>\n              ) : null}\n            </Card>,\n            document.body\n          )}\n        </div>\n      )}\n\n      {/* Chart */}\n      <div \n        className={`h-[600px] w-full rounded-lg relative pt-20 bg-background ${\n          annotationMode === 'percentage'\n            ? 'annotation-measure-mode'\n            : annotationMode === 'text'\n              ? 'annotation-vertical-mode'\n              : annotationMode === 'horizontal'\n                ? 'annotation-horizontal-mode'\n                : ''\n        }`}\n        data-testid=\"comparison-chart-container\"\n      > {/* Increased from h-80 (320px) to h-[600px] for much larger chart */}\n        {/* Annotation Labels - positioned in reserved padding space above charts */}\n        {annotations.length > 0 && (\n          <div className=\"absolute top-0 left-0 w-full h-20 pointer-events-none\" style={{ zIndex: 1000 }}>\n            {annotations.map((annotation) => {\n              if (annotation.type === 'text') {\n                // Text annotations - display at single point\n                const dataIndex = chartData?.findIndex((d: any) => d.timestamp === annotation.timestamp) ?? -1;\n                if (dataIndex === -1) return null;\n                \n                const totalDataPoints = (chartData?.length ?? 1) - 1;\n                const xPercent = totalDataPoints > 0 ? (dataIndex / totalDataPoints) * 100 : 0;\n                \n                return (\n                  <div\n                    key={annotation.id}\n                    className=\"absolute\"\n                    style={{ \n                      left: `${xPercent}%`, \n                      top: `${20 + (annotation.verticalOffset || 0)}px`, \n                      transform: `translateX(calc(-50% + ${annotation.horizontalOffset || 0}px))`\n                    }}\n                  >\n                    <div \n                      className=\"rounded px-1.5 py-0.5 max-w-32 pointer-events-auto cursor-grab hover:opacity-80 shadow-lg select-none\"\n                      style={{ \n                        backgroundColor: '#121212', \n                        border: '1px solid #FAFF50',\n                        minWidth: '40px',\n                        fontSize: '10px',\n                        wordBreak: 'break-word',\n                        overflowWrap: 'break-word',\n                        whiteSpace: 'pre-wrap'\n                      }}\n                      onMouseDown={(e) => handleTextMouseDown(e, annotation)}\n                      onDoubleClick={() => handleAnnotationDoubleClick(annotation)}\n                      title=\"Click and drag to move in any direction, double-click to delete\"\n                    >\n                      <div className=\"text-foreground\">{annotation.text || ''}</div>\n                    </div>\n                  </div>\n                );\n              } else if (annotation.type === 'horizontal') {\n                // Horizontal annotations - display at single point\n                const dataIndex = chartData?.findIndex((d: any) => d.timestamp === annotation.timestamp) ?? -1;\n                if (dataIndex === -1) return null;\n                \n                const totalDataPoints = (chartData?.length ?? 1) - 1;\n                const xPercent = totalDataPoints > 0 ? (dataIndex / totalDataPoints) * 100 : 0;\n                \n                return (\n                  <div\n                    key={annotation.id}\n                    className=\"absolute\"\n                    style={{ \n                      left: `${xPercent}%`, \n                      top: `${20 + (annotation.verticalOffset || 0)}px`, \n                      transform: `translateX(calc(-50% + ${annotation.horizontalOffset || 0}px))`\n                    }}\n                  >\n                    <div \n                      className=\"rounded px-1.5 py-0.5 max-w-32 pointer-events-auto cursor-grab hover:opacity-80 shadow-lg select-none\"\n                      style={{ \n                        backgroundColor: '#121212', \n                        border: '1px solid #AA99FF',\n                        minWidth: '40px',\n                        fontSize: '10px',\n                        wordBreak: 'break-word',\n                        overflowWrap: 'break-word',\n                        whiteSpace: 'pre-wrap'\n                      }}\n                      onMouseDown={(e) => handleTextMouseDown(e, annotation)}\n                      onDoubleClick={() => handleAnnotationDoubleClick(annotation)}\n                      title=\"Click and drag to move in any direction, double-click to delete\"\n                    >\n                      <div className=\"text-foreground\">{annotation.text || ''}</div>\n                    </div>\n                  </div>\n                );\n              } else if (annotation.type === 'percentage' && annotation.startTimestamp && annotation.endTimestamp) {\n                // Percentage measurements - display at midpoint\n                const startIndex = chartData?.findIndex((d: any) => d.timestamp === annotation.startTimestamp) ?? -1;\n                const endIndex = chartData?.findIndex((d: any) => d.timestamp === annotation.endTimestamp) ?? -1;\n                if (startIndex === -1 || endIndex === -1) return null;\n                \n                const totalDataPoints = (chartData?.length ?? 1) - 1;\n                const startPercent = totalDataPoints > 0 ? (startIndex / totalDataPoints) * 100 : 0;\n                const endPercent = totalDataPoints > 0 ? (endIndex / totalDataPoints) * 100 : 0;\n                const midPercent = (startPercent + endPercent) / 2;\n                \n                const isPositive = (annotation.percentage || 0) >= 0;\n                \n                // Calculate time span between start and end\n                const timeDiffMs = annotation.endTimestamp - annotation.startTimestamp;\n                const timeDiffDays = timeDiffMs / (1000 * 60 * 60 * 24);\n                const timeDiffHours = timeDiffMs / (1000 * 60 * 60);\n                const timeDiffMinutes = timeDiffMs / (1000 * 60);\n                \n                let timeSpanText = '';\n                if (timeDiffDays >= 1) {\n                  const days = Math.floor(timeDiffDays);\n                  timeSpanText = `${days} day${days !== 1 ? 's' : ''}`;\n                } else if (timeDiffHours >= 1) {\n                  const hours = Math.floor(timeDiffHours);\n                  timeSpanText = `${hours} hour${hours !== 1 ? 's' : ''}`;\n                } else {\n                  const minutes = Math.floor(timeDiffMinutes);\n                  timeSpanText = `${minutes} min${minutes !== 1 ? 's' : ''}`;\n                }\n                \n                return (\n                  <div\n                    key={annotation.id}\n                    className=\"absolute\"\n                    style={{ left: `${midPercent}%`, top: `${20 + (annotation.verticalOffset || 0)}px`, transform: `translateX(calc(-50% + ${annotation.horizontalOffset || 0}px))` }}\n                  >\n                    <div \n                      className=\"rounded px-2 py-1 text-xs pointer-events-auto shadow-lg cursor-grab hover:opacity-80 overflow-hidden\"\n                      style={{ backgroundColor: '#121212', border: `1px solid ${isPositive ? '#22c55e' : '#ef4444'}` }}\n                      onMouseDown={(e) => handleTextMouseDown(e, annotation)}\n                      onDoubleClick={() => handleAnnotationDoubleClick(annotation)}\n                      title=\"Click and drag to move in any direction, double-click to delete\"\n                    >\n                      <div className={`font-bold text-left whitespace-nowrap ${isPositive ? 'text-green-400' : 'text-red-400'}`}>\n                        {isPositive ? '' : ''} {(annotation.percentage || 0).toFixed(2)}%\n                      </div>\n                      <div className=\"text-xs text-muted-foreground text-left whitespace-nowrap\">\n                        {(annotation.startPrice || 0).toFixed(2)}%  {(annotation.endPrice || 0).toFixed(2)}%\n                      </div>\n                      <div className=\"text-[10px] text-muted-foreground text-left mt-0.5 whitespace-nowrap\">\n                        {timeSpanText}\n                      </div>\n                    </div>\n                  </div>\n                );\n              }\n              return null;\n            })}\n          </div>\n        )}\n\n        {/* Interactive overlay elements for horizontal lines with Edit button - USING REAL RECHARTS GEOMETRY */}\n        {chartData?.length > 0 && layoutRef.current && annotations.filter(annotation => annotation.type === 'horizontal').map((annotation) => {\n          const { offset, yScale } = layoutRef.current!;\n          \n          // Use Recharts' exact positioning + 85px offset correction\n          const yPixels = yScale(annotation.price) + 85; // Add 85px to align with visual line\n          const hitAreaHeight = 24; // Larger hit area for easier selection\n          \n          // Safety check for valid position\n          if (isNaN(yPixels) || !offset) return null;\n          \n          const isHovered = hoveredHorizontalId === annotation.id;\n          \n          return (\n            <div\n              key={`interactive-${annotation.id}-${annotation.price}`}\n              className=\"absolute pointer-events-auto\"\n              style={{ \n                left: `${offset.left}px`, // Real chart left\n                width: `${offset.width}px`, // Real chart width\n                top: `${yPixels - hitAreaHeight/2}px`, // Centered on actual line position\n                height: `${hitAreaHeight}px`, // Larger hit area\n                zIndex: 20,\n                backgroundColor: isHovered ? 'rgba(170, 153, 255, 0.15)' : 'transparent',\n                borderTop: isHovered ? '2px solid #AA99FF' : 'none',\n                borderBottom: isHovered ? '2px solid #AA99FF' : 'none',\n                transition: 'background-color 0.15s ease'\n              }}\n              onMouseEnter={() => setHoveredHorizontalId(annotation.id)}\n              onMouseLeave={() => setHoveredHorizontalId(null)}\n              onMouseDown={(e) => {\n                // Only start dragging if not clicking the edit button\n                if ((e.target as HTMLElement).closest('[data-edit-button]')) return;\n                setIsDragging(true);\n                setDragAnnotationId(annotation.id);\n                setDragStartY(e.clientY);\n                setDragStartPrice(annotation.price);\n                e.preventDefault();\n                e.stopPropagation();\n              }}\n              data-testid={`horizontal-line-drag-${annotation.id}`}\n            >\n              {/* Percentage label on hover - positioned above the line */}\n              {isHovered && (\n                <div \n                  className=\"absolute left-2 text-xs font-medium px-1.5 py-0.5 rounded pointer-events-none\"\n                  style={{ \n                    backgroundColor: '#1a1a1a', \n                    color: '#AA99FF', \n                    border: '1px solid #AA99FF',\n                    top: '-20px',\n                    zIndex: 30\n                  }}\n                >\n                  {annotation.price >= 0 ? '+' : ''}{annotation.price.toFixed(2)}%\n                  {annotation.text && ` - ${annotation.text}`}\n                </div>\n              )}\n              \n              {/* Edit button - appears on hover, positioned above the line */}\n              {isHovered && (\n                <button\n                  data-edit-button\n                  onClick={(e) => {\n                    e.preventDefault();\n                    e.stopPropagation();\n                    handleAnnotationDoubleClick(annotation);\n                  }}\n                  className=\"absolute right-2 flex items-center gap-1 px-2 py-0.5 rounded text-xs font-medium transition-all\"\n                  style={{\n                    backgroundColor: '#AA99FF',\n                    color: '#121212',\n                    boxShadow: '0 2px 4px rgba(0,0,0,0.3)',\n                    top: '-20px',\n                    zIndex: 30\n                  }}\n                  title=\"Edit horizontal line\"\n                >\n                  <Pencil className=\"w-3 h-3\" />\n                  Edit\n                </button>\n              )}\n            </div>\n          );\n        })}\n        \n        {tickers.length === 0 ? (\n          <div className=\"h-full flex items-center justify-center\">\n            <div className=\"text-center\">\n              <div className=\"text-lg font-medium text-foreground mb-2\">Compare Stock Performance</div>\n              <div className=\"text-sm text-muted-foreground mb-4\">\n                Add up to 5 tickers to compare their percentage performance\n              </div>\n              <Button\n                variant=\"outline\"\n                onClick={() => setIsSearchVisible(true)}\n                data-testid=\"button-get-started\"\n              >\n                <Plus className=\"h-4 w-4 mr-2\" />\n                Get Started\n              </Button>\n            </div>\n          </div>\n        ) : hasErrors ? (\n          <div className=\"h-full flex items-center justify-center\">\n            <div className=\"text-center\">\n              <div className=\"text-lg font-medium text-foreground mb-2\">Error Loading Data</div>\n              <div className=\"text-sm text-muted-foreground\">\n                {errorMessages.join(', ')}\n              </div>\n            </div>\n          </div>\n        ) : isLoading || chartData.length === 0 ? (\n          <div className=\"h-full flex items-center justify-center\">\n            <div className=\"text-center\">\n              <div className=\"text-lg font-medium text-foreground mb-2\">Loading Chart Data...</div>\n              <div className=\"text-sm text-muted-foreground\">\n                Fetching price data for {tickers.map(t => t.symbol).join(', ')}\n              </div>\n            </div>\n          </div>\n        ) : (\n          <ChartContainer \n            config={chartConfig} \n            className=\"h-full w-full\"\n            data-testid=\"comparison-chart-container\"\n          >\n            <div \n              ref={chartContainerRef}\n              onMouseDown={handleMouseDown}\n              onMouseMove={handleMouseMove}\n              onMouseUp={handleMouseUp}\n              style={{ cursor: isDragging ? 'grabbing' : 'default' }}\n              className=\"h-full w-full\"\n            >\n              <ResponsiveContainer width=\"100%\" height=\"100%\">\n                <LineChart \n                  data={chartData} \n                  margin={{ left: 22, right: 22, top: 10, bottom: 0 }}\n                  onClick={handleChartClick}\n                  style={{ pointerEvents: isDragging ? 'none' : 'auto' }}\n              >\n                <CartesianGrid strokeDasharray=\"3 3\" stroke=\"#3B3B3B\" strokeOpacity={0.5} />\n                <XAxis \n                  dataKey=\"time\"\n                  tickFormatter={(value) => formatTime(value, timeframe)}\n                  tick={{ fontSize: 12, fill: '#888' }}\n                  tickLine={{ stroke: '#888' }}\n                  axisLine={{ stroke: '#888' }}\n                />\n                <YAxis \n                  orientation=\"right\"\n                  tick={{ fontSize: 12, fill: '#888' }}\n                  tickLine={{ stroke: '#888' }}\n                  axisLine={{ stroke: '#888' }}\n                  domain={getYAxisDomain()}\n                  allowDataOverflow={yAxisMode === 'fixed'}\n                  tickFormatter={(value) => `${value > 0 ? '+' : ''}${Number(value).toFixed(1)}%`}\n                />\n                {showHoverTooltip && (\n                  <Tooltip \n                    content={<CustomTooltip />} \n                    active={!isDragging}\n                    allowEscapeViewBox={{ x: false, y: false }}\n                  />\n                )}\n                \n                {/* Zero reference line */}\n                <ReferenceLine y={0} stroke=\"white\" strokeWidth={1} />\n\n                {/* Geometry probe to capture Recharts internals */}\n                <Customized component={(props: any) => {\n                  const { offset, yAxisMap } = props;\n                  if (offset && yAxisMap) {\n                    const yAxis = yAxisMap?.yAxisId || yAxisMap?.['0'] || Object.values(yAxisMap || {})[0];\n                    if (yAxis?.scale && typeof yAxis.scale === 'function') {\n                      // Update layout ref with real chart geometry\n                      layoutRef.current = { offset, yScale: yAxis.scale };\n                    }\n                  }\n                  return null; // Don't render anything\n                }} />\n                \n                {/* Text Annotation Reference Lines - yellow vertical lines */}\n                {annotations.filter(annotation => annotation.type === 'text').map((annotation) => {\n                  // Find the actual time value from chart data that matches this annotation\n                  const dataPoint = chartData?.find((d: any) => d.timestamp === annotation.timestamp);\n                  return dataPoint ? (\n                    <ReferenceLine \n                      key={annotation.id}\n                      x={dataPoint.time}\n                      stroke=\"#FAFF50\"\n                      strokeWidth={1}\n                      vectorEffect=\"non-scaling-stroke\"\n                      shapeRendering=\"crispEdges\"\n                    />\n                  ) : null;\n                })}\n\n                {/* Horizontal Annotation Reference Lines - purple styling */}\n                {annotations.filter(annotation => annotation.type === 'horizontal').map((annotation) => {\n                  const isBeingDragged = isDragging && dragAnnotationId === annotation.id;\n                  const lineColor = isBeingDragged ? \"#7755CC\" : \"#AA99FF\"; // Darker purple when dragging\n                  return (\n                    <ReferenceLine \n                      key={annotation.id}\n                      y={annotation.price}\n                      stroke={lineColor}\n                      strokeWidth={isBeingDragged ? 3 : 2}\n                      vectorEffect=\"non-scaling-stroke\"\n                      shapeRendering=\"crispEdges\"\n                    />\n                  );\n                })}\n\n\n                {/* Percentage Measurement Lines - diagonal arrows */}\n                {annotations.filter(annotation => annotation.type === 'percentage' && annotation.startTimestamp && annotation.endTimestamp).map((annotation) => {\n                  const startDataPoint = chartData?.find((d: any) => d.timestamp === annotation.startTimestamp);\n                  const endDataPoint = chartData?.find((d: any) => d.timestamp === annotation.endTimestamp);\n                  \n                  if (!startDataPoint || !endDataPoint) return null;\n                  \n                  const isPositive = (annotation.percentage || 0) >= 0;\n                  const lineColor = isPositive ? '#22C55E' : '#EF4444'; // Green for positive, red for negative\n                  \n                  return (\n                    <g key={annotation.id}>\n                      {/* Main diagonal line */}\n                      <ReferenceLine \n                        segment={[\n                          { x: startDataPoint.date, y: annotation.startPrice },\n                          { x: endDataPoint.date, y: annotation.endPrice }\n                        ]}\n                        stroke={lineColor}\n                        strokeWidth={2}\n                        vectorEffect=\"non-scaling-stroke\"\n                      />\n                      \n                      {/* Start point circle - only render if chart data is available */}\n                      {startDataPoint && chartData.length > 0 && (\n                        <ReferenceDot \n                          x={startDataPoint.date}\n                          y={annotation.startPrice}\n                          r={4}\n                          fill={lineColor}\n                          stroke={lineColor}\n                          strokeWidth={1}\n                        />\n                      )}\n                      \n                      {/* End point circle - only render if chart data is available */}\n                      {endDataPoint && chartData.length > 0 && (\n                        <ReferenceDot \n                          x={endDataPoint.date}\n                          y={annotation.endPrice}\n                          r={4}\n                          fill={lineColor}\n                          stroke={lineColor}\n                          strokeWidth={1}\n                        />\n                      )}\n                    </g>\n                  );\n                })}\n                \n                {/* Render line for each visible ticker */}\n                {tickers\n                  .filter(ticker => ticker.visible)\n                  .map((ticker, index) => (\n                    <Line\n                      key={ticker.symbol}\n                      type=\"linear\"\n                      dataKey={`${ticker.symbol}_percentage`}\n                      stroke={ticker.color}\n                      strokeWidth={2}\n                      dot={false}\n                      activeDot={{ r: 4, strokeWidth: 0 }}\n                    />\n                  ))}\n              </LineChart>\n            </ResponsiveContainer>\n            \n            \n            </div>\n          </ChartContainer>\n        )}\n      </div>\n\n      {/* Color-coded Legend with Percentage Changes */}\n      {tickers.length > 0 && chartData.length > 0 && (\n        <div className=\"mt-4 space-y-2\">\n          <div className=\"flex flex-wrap gap-4 justify-center\">\n            {tickers.map((ticker) => {\n              // Calculate total percentage change over the time period\n              const firstDataPoint = chartData[0];\n              const lastDataPoint = chartData[chartData.length - 1];\n              const startPercentage = Number(firstDataPoint?.[`${ticker.symbol}_percentage`]) || 0;\n              const endPercentage = Number(lastDataPoint?.[`${ticker.symbol}_percentage`]) || 0;\n              const totalChange = endPercentage - startPercentage;\n              \n              return (\n                <div \n                  key={ticker.symbol}\n                  className={cn(\n                    \"flex items-center gap-2 px-3 py-1.5 rounded-lg border transition-opacity cursor-pointer\",\n                    ticker.visible ? \"bg-card/50\" : \"bg-card/20 opacity-50\"\n                  )}\n                  onClick={() => toggleTickerVisibility(ticker.symbol)}\n                >\n                  <div \n                    className=\"w-3 h-3 rounded-full border border-border/50\"\n                    style={{ backgroundColor: ticker.color }}\n                  />\n                  <span className=\"text-sm font-medium\">\n                    {ticker.symbol}\n                  </span>\n                  <span \n                    className={cn(\n                      \"text-sm font-medium\",\n                      totalChange >= 0 ? \"text-green-400\" : \"text-red-400\"\n                    )}\n                  >\n                    {totalChange >= 0 ? '+' : ''}{totalChange.toFixed(2)}%\n                  </span>\n                </div>\n              );\n            })}\n          </div>\n          <div className=\"text-xs text-muted-foreground text-center\">\n            Showing percentage change from {timeframe} starting point  Click legend items to toggle visibility\n          </div>\n        </div>\n      )}\n\n      {/* Annotation Input Modal */}\n      {showAnnotationInput && (pendingAnnotation || editingAnnotation) && (\n        <div className=\"fixed inset-0 bg-black/50 flex items-center justify-center z-50\">\n          <div className=\"border border-border rounded-lg p-6 w-96 max-w-[90vw]\" style={{ backgroundColor: '#3A3A3A' }}>\n            <h3 className=\"text-lg font-semibold mb-4\">\n              {isEditMode ? 'Edit Annotation' : (pendingAnnotation?.type === 'horizontal' ? 'Add Horizontal Line' : 'Add Annotation')}\n            </h3>\n            \n            {/* For horizontal annotations, show percentage input */}\n            {(pendingAnnotation?.type === 'horizontal' || editingAnnotation?.type === 'horizontal') && (\n              <div className=\"mb-4\">\n                <label className=\"block text-sm font-medium mb-2\">Percentage Level</label>\n                <div className=\"flex items-center gap-2\">\n                  <input\n                    type=\"number\"\n                    step=\"any\"\n                    value={horizontalPercentageInput}\n                    onChange={(e) => setHorizontalPercentageInput(e.target.value)}\n                    placeholder=\"e.g. -5.25\"\n                    className=\"flex-1 px-3 py-2 border border-border rounded-md bg-background text-foreground focus:outline-none focus:ring-2 focus:ring-[#5AF5FA]\"\n                    autoFocus\n                    onKeyDown={(e) => {\n                      if (e.key === 'Enter') {\n                        e.preventDefault();\n                      } else if (e.key === 'Escape') {\n                        cancelAnnotation();\n                      }\n                    }}\n                  />\n                  <span className=\"text-muted-foreground\">%</span>\n                </div>\n                <p className=\"text-xs text-muted-foreground mt-1\">\n                  Enter the percentage level for the horizontal line\n                </p>\n              </div>\n            )}\n            \n            {/* Show time/value info for non-horizontal annotations */}\n            {pendingAnnotation?.type !== 'horizontal' && editingAnnotation?.type !== 'horizontal' && (\n              <div className=\"mb-4 text-sm text-muted-foreground\">\n                <div>Time: {isEditMode ? editingAnnotation?.time : pendingAnnotation?.time}</div>\n                <div>Value: {formatPrice(isEditMode ? editingAnnotation?.price || 0 : pendingAnnotation?.price || 0)}%</div>\n              </div>\n            )}\n            \n            <div className=\"mb-4\">\n              <label className=\"block text-sm font-medium mb-2\">\n                {(pendingAnnotation?.type === 'horizontal' || editingAnnotation?.type === 'horizontal') ? 'Label (optional)' : 'Event Description'}\n              </label>\n              <textarea\n                value={annotationInput}\n                onChange={(e) => setAnnotationInput(e.target.value)}\n                placeholder={(pendingAnnotation?.type === 'horizontal' || editingAnnotation?.type === 'horizontal') ? 'e.g. Support level, Target price...' : 'Enter event description...'}\n                className=\"w-full h-24 px-3 py-2 border border-border rounded-md bg-background text-foreground resize-none focus:outline-none focus:ring-2 focus:ring-primary\"\n                autoFocus={pendingAnnotation?.type !== 'horizontal' && editingAnnotation?.type !== 'horizontal'}\n                onKeyDown={(e) => {\n                  if (e.key === 'Enter' && e.ctrlKey) {\n                    saveAnnotation();\n                  } else if (e.key === 'Escape') {\n                    cancelAnnotation();\n                  }\n                }}\n              />\n            </div>\n            <div className=\"flex gap-2 justify-end\">\n              <Button variant=\"outline\" onClick={cancelAnnotation}>\n                Cancel\n              </Button>\n              {isEditMode && (\n                <Button \n                  variant=\"destructive\"\n                  onClick={deleteAnnotation}\n                  className=\"bg-red-600 text-white hover:bg-red-700\"\n                >\n                  Delete\n                </Button>\n              )}\n              <Button \n                onClick={saveAnnotation}\n                disabled={(pendingAnnotation?.type === 'horizontal' || editingAnnotation?.type === 'horizontal') \n                  ? !horizontalPercentageInput.trim() \n                  : !annotationInput.trim()}\n                className=\"bg-[#5AF5FA] text-black hover:bg-[#5AF5FA]/90\"\n              >\n                {isEditMode ? 'Update' : 'Save'}\n              </Button>\n            </div>\n            <div className=\"mt-2 text-xs text-muted-foreground\">\n              Press Ctrl+Enter to save, Escape to cancel\n            </div>\n          </div>\n        </div>\n      )}\n    </div>\n  );\n}","path":null,"size_bytes":102536,"size_tokens":null},"client/src/components/ui/context-menu.tsx":{"content":"import * as React from \"react\"\nimport * as ContextMenuPrimitive from \"@radix-ui/react-context-menu\"\nimport { Check, ChevronRight, Circle } from \"lucide-react\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst ContextMenu = ContextMenuPrimitive.Root\n\nconst ContextMenuTrigger = ContextMenuPrimitive.Trigger\n\nconst ContextMenuGroup = ContextMenuPrimitive.Group\n\nconst ContextMenuPortal = ContextMenuPrimitive.Portal\n\nconst ContextMenuSub = ContextMenuPrimitive.Sub\n\nconst ContextMenuRadioGroup = ContextMenuPrimitive.RadioGroup\n\nconst ContextMenuSubTrigger = React.forwardRef<\n  React.ElementRef<typeof ContextMenuPrimitive.SubTrigger>,\n  React.ComponentPropsWithoutRef<typeof ContextMenuPrimitive.SubTrigger> & {\n    inset?: boolean\n  }\n>(({ className, inset, children, ...props }, ref) => (\n  <ContextMenuPrimitive.SubTrigger\n    ref={ref}\n    className={cn(\n      \"flex cursor-default select-none items-center rounded-sm px-2 py-1.5 text-sm outline-none focus:bg-accent focus:text-accent-foreground data-[state=open]:bg-accent data-[state=open]:text-accent-foreground\",\n      inset && \"pl-8\",\n      className\n    )}\n    {...props}\n  >\n    {children}\n    <ChevronRight className=\"ml-auto h-4 w-4\" />\n  </ContextMenuPrimitive.SubTrigger>\n))\nContextMenuSubTrigger.displayName = ContextMenuPrimitive.SubTrigger.displayName\n\nconst ContextMenuSubContent = React.forwardRef<\n  React.ElementRef<typeof ContextMenuPrimitive.SubContent>,\n  React.ComponentPropsWithoutRef<typeof ContextMenuPrimitive.SubContent>\n>(({ className, ...props }, ref) => (\n  <ContextMenuPrimitive.SubContent\n    ref={ref}\n    className={cn(\n      \"z-50 min-w-[8rem] overflow-hidden rounded-md border bg-popover p-1 text-popover-foreground shadow-md data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 data-[side=bottom]:slide-in-from-top-2 data-[side=left]:slide-in-from-right-2 data-[side=right]:slide-in-from-left-2 data-[side=top]:slide-in-from-bottom-2 origin-[--radix-context-menu-content-transform-origin]\",\n      className\n    )}\n    {...props}\n  />\n))\nContextMenuSubContent.displayName = ContextMenuPrimitive.SubContent.displayName\n\nconst ContextMenuContent = React.forwardRef<\n  React.ElementRef<typeof ContextMenuPrimitive.Content>,\n  React.ComponentPropsWithoutRef<typeof ContextMenuPrimitive.Content>\n>(({ className, ...props }, ref) => (\n  <ContextMenuPrimitive.Portal>\n    <ContextMenuPrimitive.Content\n      ref={ref}\n      className={cn(\n        \"z-50 max-h-[--radix-context-menu-content-available-height] min-w-[8rem] overflow-y-auto overflow-x-hidden rounded-md border bg-popover p-1 text-popover-foreground shadow-md animate-in fade-in-80 data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 data-[side=bottom]:slide-in-from-top-2 data-[side=left]:slide-in-from-right-2 data-[side=right]:slide-in-from-left-2 data-[side=top]:slide-in-from-bottom-2 origin-[--radix-context-menu-content-transform-origin]\",\n        className\n      )}\n      {...props}\n    />\n  </ContextMenuPrimitive.Portal>\n))\nContextMenuContent.displayName = ContextMenuPrimitive.Content.displayName\n\nconst ContextMenuItem = React.forwardRef<\n  React.ElementRef<typeof ContextMenuPrimitive.Item>,\n  React.ComponentPropsWithoutRef<typeof ContextMenuPrimitive.Item> & {\n    inset?: boolean\n  }\n>(({ className, inset, ...props }, ref) => (\n  <ContextMenuPrimitive.Item\n    ref={ref}\n    className={cn(\n      \"relative flex cursor-default select-none items-center rounded-sm px-2 py-1.5 text-sm outline-none focus:bg-accent focus:text-accent-foreground data-[disabled]:pointer-events-none data-[disabled]:opacity-50\",\n      inset && \"pl-8\",\n      className\n    )}\n    {...props}\n  />\n))\nContextMenuItem.displayName = ContextMenuPrimitive.Item.displayName\n\nconst ContextMenuCheckboxItem = React.forwardRef<\n  React.ElementRef<typeof ContextMenuPrimitive.CheckboxItem>,\n  React.ComponentPropsWithoutRef<typeof ContextMenuPrimitive.CheckboxItem>\n>(({ className, children, checked, ...props }, ref) => (\n  <ContextMenuPrimitive.CheckboxItem\n    ref={ref}\n    className={cn(\n      \"relative flex cursor-default select-none items-center rounded-sm py-1.5 pl-8 pr-2 text-sm outline-none focus:bg-accent focus:text-accent-foreground data-[disabled]:pointer-events-none data-[disabled]:opacity-50\",\n      className\n    )}\n    checked={checked}\n    {...props}\n  >\n    <span className=\"absolute left-2 flex h-3.5 w-3.5 items-center justify-center\">\n      <ContextMenuPrimitive.ItemIndicator>\n        <Check className=\"h-4 w-4\" />\n      </ContextMenuPrimitive.ItemIndicator>\n    </span>\n    {children}\n  </ContextMenuPrimitive.CheckboxItem>\n))\nContextMenuCheckboxItem.displayName =\n  ContextMenuPrimitive.CheckboxItem.displayName\n\nconst ContextMenuRadioItem = React.forwardRef<\n  React.ElementRef<typeof ContextMenuPrimitive.RadioItem>,\n  React.ComponentPropsWithoutRef<typeof ContextMenuPrimitive.RadioItem>\n>(({ className, children, ...props }, ref) => (\n  <ContextMenuPrimitive.RadioItem\n    ref={ref}\n    className={cn(\n      \"relative flex cursor-default select-none items-center rounded-sm py-1.5 pl-8 pr-2 text-sm outline-none focus:bg-accent focus:text-accent-foreground data-[disabled]:pointer-events-none data-[disabled]:opacity-50\",\n      className\n    )}\n    {...props}\n  >\n    <span className=\"absolute left-2 flex h-3.5 w-3.5 items-center justify-center\">\n      <ContextMenuPrimitive.ItemIndicator>\n        <Circle className=\"h-2 w-2 fill-current\" />\n      </ContextMenuPrimitive.ItemIndicator>\n    </span>\n    {children}\n  </ContextMenuPrimitive.RadioItem>\n))\nContextMenuRadioItem.displayName = ContextMenuPrimitive.RadioItem.displayName\n\nconst ContextMenuLabel = React.forwardRef<\n  React.ElementRef<typeof ContextMenuPrimitive.Label>,\n  React.ComponentPropsWithoutRef<typeof ContextMenuPrimitive.Label> & {\n    inset?: boolean\n  }\n>(({ className, inset, ...props }, ref) => (\n  <ContextMenuPrimitive.Label\n    ref={ref}\n    className={cn(\n      \"px-2 py-1.5 text-sm font-semibold text-foreground\",\n      inset && \"pl-8\",\n      className\n    )}\n    {...props}\n  />\n))\nContextMenuLabel.displayName = ContextMenuPrimitive.Label.displayName\n\nconst ContextMenuSeparator = React.forwardRef<\n  React.ElementRef<typeof ContextMenuPrimitive.Separator>,\n  React.ComponentPropsWithoutRef<typeof ContextMenuPrimitive.Separator>\n>(({ className, ...props }, ref) => (\n  <ContextMenuPrimitive.Separator\n    ref={ref}\n    className={cn(\"-mx-1 my-1 h-px bg-border\", className)}\n    {...props}\n  />\n))\nContextMenuSeparator.displayName = ContextMenuPrimitive.Separator.displayName\n\nconst ContextMenuShortcut = ({\n  className,\n  ...props\n}: React.HTMLAttributes<HTMLSpanElement>) => {\n  return (\n    <span\n      className={cn(\n        \"ml-auto text-xs tracking-widest text-muted-foreground\",\n        className\n      )}\n      {...props}\n    />\n  )\n}\nContextMenuShortcut.displayName = \"ContextMenuShortcut\"\n\nexport {\n  ContextMenu,\n  ContextMenuTrigger,\n  ContextMenuContent,\n  ContextMenuItem,\n  ContextMenuCheckboxItem,\n  ContextMenuRadioItem,\n  ContextMenuLabel,\n  ContextMenuSeparator,\n  ContextMenuShortcut,\n  ContextMenuGroup,\n  ContextMenuPortal,\n  ContextMenuSub,\n  ContextMenuSubContent,\n  ContextMenuSubTrigger,\n  ContextMenuRadioGroup,\n}\n","path":null,"size_bytes":7428,"size_tokens":null},"client/src/components/ui/button.tsx":{"content":"import * as React from \"react\"\nimport { Slot } from \"@radix-ui/react-slot\"\nimport { cva, type VariantProps } from \"class-variance-authority\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst buttonVariants = cva(\n  \"inline-flex items-center justify-center gap-2 whitespace-nowrap rounded-md text-sm font-medium ring-offset-background transition-colors focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:pointer-events-none disabled:opacity-50 [&_svg]:pointer-events-none [&_svg]:size-4 [&_svg]:shrink-0\",\n  {\n    variants: {\n      variant: {\n        default: \"bg-primary text-primary-foreground hover:bg-primary/90\",\n        destructive:\n          \"bg-destructive text-destructive-foreground hover:bg-destructive/90\",\n        outline:\n          \"border border-input bg-background hover:bg-accent hover:text-accent-foreground\",\n        secondary:\n          \"bg-secondary text-secondary-foreground hover:bg-secondary/80\",\n        ghost: \"hover:bg-accent hover:text-accent-foreground\",\n        link: \"text-primary underline-offset-4 hover:underline\",\n      },\n      size: {\n        default: \"h-10 px-4 py-2\",\n        sm: \"h-9 rounded-md px-3\",\n        lg: \"h-11 rounded-md px-8\",\n        icon: \"h-10 w-10\",\n      },\n    },\n    defaultVariants: {\n      variant: \"default\",\n      size: \"default\",\n    },\n  }\n)\n\nexport interface ButtonProps\n  extends React.ButtonHTMLAttributes<HTMLButtonElement>,\n    VariantProps<typeof buttonVariants> {\n  asChild?: boolean\n}\n\nconst Button = React.forwardRef<HTMLButtonElement, ButtonProps>(\n  ({ className, variant, size, asChild = false, ...props }, ref) => {\n    const Comp = asChild ? Slot : \"button\"\n    return (\n      <Comp\n        className={cn(buttonVariants({ variant, size, className }))}\n        ref={ref}\n        {...props}\n      />\n    )\n  }\n)\nButton.displayName = \"Button\"\n\nexport { Button, buttonVariants }\n","path":null,"size_bytes":1901,"size_tokens":null},"client/src/components/feedback-form.tsx":{"content":"import { useState } from 'react';\nimport { Button } from '@/components/ui/button';\nimport { Input } from '@/components/ui/input';\nimport { Textarea } from '@/components/ui/textarea';\nimport { Label } from '@/components/ui/label';\nimport { Dialog, DialogContent, DialogHeader, DialogTitle } from '@/components/ui/dialog';\nimport { Upload, X } from 'lucide-react';\nimport { useToast } from '@/hooks/use-toast';\n\ninterface FeedbackFormProps {\n  open: boolean;\n  onOpenChange: (open: boolean) => void;\n}\n\nexport function FeedbackForm({ open, onOpenChange }: FeedbackFormProps) {\n  const [name, setName] = useState('');\n  const [email, setEmail] = useState('');\n  const [message, setMessage] = useState('');\n  const [file, setFile] = useState<File | null>(null);\n  const [isSubmitting, setIsSubmitting] = useState(false);\n  const [isSubmitted, setIsSubmitted] = useState(false);\n  const { toast } = useToast();\n\n  const handleFileChange = (event: React.ChangeEvent<HTMLInputElement>) => {\n    const selectedFile = event.target.files?.[0];\n    if (selectedFile) {\n      setFile(selectedFile);\n    }\n  };\n\n  const removeFile = () => {\n    setFile(null);\n    // Reset the file input\n    const fileInput = document.getElementById('file-upload') as HTMLInputElement;\n    if (fileInput) {\n      fileInput.value = '';\n    }\n  };\n\n  const handleSubmit = async (e: React.FormEvent) => {\n    e.preventDefault();\n    \n    if (!name.trim() || !email.trim() || !message.trim()) {\n      toast({\n        title: \"Please fill in all fields\",\n        description: \"Name, email, and message are required.\",\n        variant: \"destructive\",\n      });\n      return;\n    }\n\n    setIsSubmitting(true);\n\n    try {\n      const formData = new FormData();\n      formData.append('name', name);\n      formData.append('email', email);\n      formData.append('message', message);\n      if (file) {\n        formData.append('file', file);\n      }\n\n      const response = await fetch('/api/feedback', {\n        method: 'POST',\n        body: formData,\n      });\n\n      if (response.ok) {\n        setIsSubmitted(true);\n        // Reset form\n        setName('');\n        setEmail('');\n        setMessage('');\n        setFile(null);\n        \n        // Close dialog after showing success animation\n        setTimeout(() => {\n          setIsSubmitted(false);\n          onOpenChange(false);\n        }, 5000);\n      } else {\n        throw new Error('Failed to submit feedback');\n      }\n    } catch (error) {\n      console.error('Feedback submission error:', error);\n      toast({\n        title: \"Submission failed\",\n        description: \"Please try again later.\",\n        variant: \"destructive\",\n      });\n    } finally {\n      setIsSubmitting(false);\n    }\n  };\n\n  return (\n    <Dialog open={open} onOpenChange={onOpenChange}>\n      <DialogContent className=\"sm:max-w-[500px]\">\n        <DialogHeader>\n          <DialogTitle>Issues / Feedback</DialogTitle>\n        </DialogHeader>\n        \n        {isSubmitted ? (\n          <div className=\"text-center py-8\">\n            <div className=\"mb-4\">\n              <p className=\"text-lg font-medium text-white mb-4\">\n                Thank you! Your feedback has been sent successfully.\n              </p>\n              <div className=\"flex justify-center\">\n                <div className=\"w-[100px] h-[100px] flex items-center justify-center\">\n                  <dotlottie-wc \n                    src=\"https://lottie.host/57cfc9c2-7b53-472e-90a4-0c576095e756/igE8arPofT.lottie\" \n                    style={{ width: '100px', height: '100px' }} \n                    autoplay \n                    loop\n                  ></dotlottie-wc>\n                </div>\n              </div>\n            </div>\n          </div>\n        ) : (\n          <form onSubmit={handleSubmit} className=\"space-y-4\">\n            <div>\n              <Label htmlFor=\"name\">Name *</Label>\n              <Input\n                id=\"name\"\n                value={name}\n                onChange={(e) => setName(e.target.value)}\n                placeholder=\"Your name\"\n                required\n                data-testid=\"input-feedback-name\"\n              />\n            </div>\n            \n            <div>\n              <Label htmlFor=\"email\">Email *</Label>\n              <Input\n                id=\"email\"\n                type=\"email\"\n                value={email}\n                onChange={(e) => setEmail(e.target.value)}\n                placeholder=\"your@email.com\"\n                required\n                data-testid=\"input-feedback-email\"\n              />\n            </div>\n            \n            <div>\n              <Label htmlFor=\"message\">Message *</Label>\n              <Textarea\n                id=\"message\"\n                value={message}\n                onChange={(e) => setMessage(e.target.value)}\n                placeholder=\"Describe your issue or feedback...\"\n                className=\"min-h-[150px] resize-none\"\n                required\n                data-testid=\"textarea-feedback-message\"\n              />\n            </div>\n            \n            <div>\n              <Label htmlFor=\"file-upload\">Attach File (Optional)</Label>\n              <div className=\"mt-1\">\n                {file ? (\n                  <div className=\"flex items-center justify-between p-2 border border-border rounded-md bg-muted/50\">\n                    <span className=\"text-sm truncate mr-2\">{file.name}</span>\n                    <Button\n                      type=\"button\"\n                      variant=\"ghost\"\n                      size=\"sm\"\n                      onClick={removeFile}\n                      className=\"h-6 w-6 p-0\"\n                      data-testid=\"button-remove-file\"\n                    >\n                      <X className=\"h-3 w-3\" />\n                    </Button>\n                  </div>\n                ) : (\n                  <div className=\"border-2 border-dashed border-border rounded-md p-4 text-center hover:border-muted-foreground/50 transition-colors\">\n                    <input\n                      id=\"file-upload\"\n                      type=\"file\"\n                      onChange={handleFileChange}\n                      className=\"hidden\"\n                      data-testid=\"input-file-upload\"\n                    />\n                    <Label htmlFor=\"file-upload\" className=\"cursor-pointer\">\n                      <Upload className=\"h-8 w-8 mx-auto mb-2 text-muted-foreground\" />\n                      <p className=\"text-sm text-muted-foreground\">\n                        Click to upload a file\n                      </p>\n                    </Label>\n                  </div>\n                )}\n              </div>\n            </div>\n            \n            <div className=\"flex justify-end gap-3 pt-4\">\n              <Button\n                type=\"button\"\n                variant=\"outline\"\n                onClick={() => onOpenChange(false)}\n                data-testid=\"button-cancel-feedback\"\n              >\n                Cancel\n              </Button>\n              <Button\n                type=\"submit\"\n                disabled={isSubmitting}\n                data-testid=\"button-submit-feedback\"\n              >\n                {isSubmitting ? 'Sending...' : 'Submit'}\n              </Button>\n            </div>\n          </form>\n        )}\n      </DialogContent>\n    </Dialog>\n  );\n}","path":null,"size_bytes":7306,"size_tokens":null},"client/src/components/ui/collapsible.tsx":{"content":"\"use client\"\n\nimport * as CollapsiblePrimitive from \"@radix-ui/react-collapsible\"\n\nconst Collapsible = CollapsiblePrimitive.Root\n\nconst CollapsibleTrigger = CollapsiblePrimitive.CollapsibleTrigger\n\nconst CollapsibleContent = CollapsiblePrimitive.CollapsibleContent\n\nexport { Collapsible, CollapsibleTrigger, CollapsibleContent }\n","path":null,"size_bytes":329,"size_tokens":null},"client/src/components/ui/select.tsx":{"content":"\"use client\"\n\nimport * as React from \"react\"\nimport * as SelectPrimitive from \"@radix-ui/react-select\"\nimport { Check, ChevronDown, ChevronUp } from \"lucide-react\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst Select = SelectPrimitive.Root\n\nconst SelectGroup = SelectPrimitive.Group\n\nconst SelectValue = SelectPrimitive.Value\n\nconst SelectTrigger = React.forwardRef<\n  React.ElementRef<typeof SelectPrimitive.Trigger>,\n  React.ComponentPropsWithoutRef<typeof SelectPrimitive.Trigger>\n>(({ className, children, ...props }, ref) => (\n  <SelectPrimitive.Trigger\n    ref={ref}\n    className={cn(\n      \"flex h-10 w-full items-center justify-between rounded-md border border-input bg-background px-3 py-2 text-sm ring-offset-background data-[placeholder]:text-muted-foreground focus:outline-none focus:ring-2 focus:ring-ring focus:ring-offset-2 disabled:cursor-not-allowed disabled:opacity-50 [&>span]:line-clamp-1\",\n      className\n    )}\n    {...props}\n  >\n    {children}\n    <SelectPrimitive.Icon asChild>\n      <ChevronDown className=\"h-4 w-4 opacity-50\" />\n    </SelectPrimitive.Icon>\n  </SelectPrimitive.Trigger>\n))\nSelectTrigger.displayName = SelectPrimitive.Trigger.displayName\n\nconst SelectScrollUpButton = React.forwardRef<\n  React.ElementRef<typeof SelectPrimitive.ScrollUpButton>,\n  React.ComponentPropsWithoutRef<typeof SelectPrimitive.ScrollUpButton>\n>(({ className, ...props }, ref) => (\n  <SelectPrimitive.ScrollUpButton\n    ref={ref}\n    className={cn(\n      \"flex cursor-default items-center justify-center py-1\",\n      className\n    )}\n    {...props}\n  >\n    <ChevronUp className=\"h-4 w-4\" />\n  </SelectPrimitive.ScrollUpButton>\n))\nSelectScrollUpButton.displayName = SelectPrimitive.ScrollUpButton.displayName\n\nconst SelectScrollDownButton = React.forwardRef<\n  React.ElementRef<typeof SelectPrimitive.ScrollDownButton>,\n  React.ComponentPropsWithoutRef<typeof SelectPrimitive.ScrollDownButton>\n>(({ className, ...props }, ref) => (\n  <SelectPrimitive.ScrollDownButton\n    ref={ref}\n    className={cn(\n      \"flex cursor-default items-center justify-center py-1\",\n      className\n    )}\n    {...props}\n  >\n    <ChevronDown className=\"h-4 w-4\" />\n  </SelectPrimitive.ScrollDownButton>\n))\nSelectScrollDownButton.displayName =\n  SelectPrimitive.ScrollDownButton.displayName\n\nconst SelectContent = React.forwardRef<\n  React.ElementRef<typeof SelectPrimitive.Content>,\n  React.ComponentPropsWithoutRef<typeof SelectPrimitive.Content>\n>(({ className, children, position = \"popper\", ...props }, ref) => (\n  <SelectPrimitive.Portal>\n    <SelectPrimitive.Content\n      ref={ref}\n      className={cn(\n        \"relative z-50 max-h-[--radix-select-content-available-height] min-w-[8rem] overflow-y-auto overflow-x-hidden rounded-md border bg-popover text-popover-foreground shadow-md data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 data-[side=bottom]:slide-in-from-top-2 data-[side=left]:slide-in-from-right-2 data-[side=right]:slide-in-from-left-2 data-[side=top]:slide-in-from-bottom-2 origin-[--radix-select-content-transform-origin]\",\n        position === \"popper\" &&\n          \"data-[side=bottom]:translate-y-1 data-[side=left]:-translate-x-1 data-[side=right]:translate-x-1 data-[side=top]:-translate-y-1\",\n        className\n      )}\n      position={position}\n      {...props}\n    >\n      <SelectScrollUpButton />\n      <SelectPrimitive.Viewport\n        className={cn(\n          \"p-1\",\n          position === \"popper\" &&\n            \"h-[var(--radix-select-trigger-height)] w-full min-w-[var(--radix-select-trigger-width)]\"\n        )}\n      >\n        {children}\n      </SelectPrimitive.Viewport>\n      <SelectScrollDownButton />\n    </SelectPrimitive.Content>\n  </SelectPrimitive.Portal>\n))\nSelectContent.displayName = SelectPrimitive.Content.displayName\n\nconst SelectLabel = React.forwardRef<\n  React.ElementRef<typeof SelectPrimitive.Label>,\n  React.ComponentPropsWithoutRef<typeof SelectPrimitive.Label>\n>(({ className, ...props }, ref) => (\n  <SelectPrimitive.Label\n    ref={ref}\n    className={cn(\"py-1.5 pl-8 pr-2 text-sm font-semibold\", className)}\n    {...props}\n  />\n))\nSelectLabel.displayName = SelectPrimitive.Label.displayName\n\nconst SelectItem = React.forwardRef<\n  React.ElementRef<typeof SelectPrimitive.Item>,\n  React.ComponentPropsWithoutRef<typeof SelectPrimitive.Item>\n>(({ className, children, ...props }, ref) => (\n  <SelectPrimitive.Item\n    ref={ref}\n    className={cn(\n      \"relative flex w-full cursor-default select-none items-center rounded-sm py-1.5 pl-8 pr-2 text-sm outline-none focus:bg-accent focus:text-accent-foreground data-[disabled]:pointer-events-none data-[disabled]:opacity-50\",\n      className\n    )}\n    {...props}\n  >\n    <span className=\"absolute left-2 flex h-3.5 w-3.5 items-center justify-center\">\n      <SelectPrimitive.ItemIndicator>\n        <Check className=\"h-4 w-4\" />\n      </SelectPrimitive.ItemIndicator>\n    </span>\n\n    <SelectPrimitive.ItemText>{children}</SelectPrimitive.ItemText>\n  </SelectPrimitive.Item>\n))\nSelectItem.displayName = SelectPrimitive.Item.displayName\n\nconst SelectSeparator = React.forwardRef<\n  React.ElementRef<typeof SelectPrimitive.Separator>,\n  React.ComponentPropsWithoutRef<typeof SelectPrimitive.Separator>\n>(({ className, ...props }, ref) => (\n  <SelectPrimitive.Separator\n    ref={ref}\n    className={cn(\"-mx-1 my-1 h-px bg-muted\", className)}\n    {...props}\n  />\n))\nSelectSeparator.displayName = SelectPrimitive.Separator.displayName\n\nexport {\n  Select,\n  SelectGroup,\n  SelectValue,\n  SelectTrigger,\n  SelectContent,\n  SelectLabel,\n  SelectItem,\n  SelectSeparator,\n  SelectScrollUpButton,\n  SelectScrollDownButton,\n}\n","path":null,"size_bytes":5742,"size_tokens":null},"client/src/components/ui/badge.tsx":{"content":"import * as React from \"react\"\nimport { cva, type VariantProps } from \"class-variance-authority\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst badgeVariants = cva(\n  \"inline-flex items-center rounded-full border px-2.5 py-0.5 text-xs font-semibold transition-colors focus:outline-none focus:ring-2 focus:ring-ring focus:ring-offset-2\",\n  {\n    variants: {\n      variant: {\n        default:\n          \"border-transparent bg-primary text-primary-foreground hover:bg-primary/80\",\n        secondary:\n          \"border-transparent bg-secondary text-secondary-foreground hover:bg-secondary/80\",\n        destructive:\n          \"border-transparent bg-destructive text-destructive-foreground hover:bg-destructive/80\",\n        outline: \"text-foreground\",\n      },\n    },\n    defaultVariants: {\n      variant: \"default\",\n    },\n  }\n)\n\nexport interface BadgeProps\n  extends React.HTMLAttributes<HTMLDivElement>,\n    VariantProps<typeof badgeVariants> {}\n\nfunction Badge({ className, variant, ...props }: BadgeProps) {\n  return (\n    <div className={cn(badgeVariants({ variant }), className)} {...props} />\n  )\n}\n\nexport { Badge, badgeVariants }\n","path":null,"size_bytes":1128,"size_tokens":null},"client/src/App.tsx":{"content":"import { useState, useEffect } from \"react\";\nimport { Switch, Route, Redirect } from \"wouter\";\nimport { queryClient } from \"./lib/queryClient\";\nimport { QueryClientProvider } from \"@tanstack/react-query\";\nimport { Toaster } from \"@/components/ui/toaster\";\nimport { TooltipProvider } from \"@/components/ui/tooltip\";\nimport { ThemeProvider } from \"@/components/theme-provider\";\nimport { AuthProvider, useAuth } from \"@/contexts/AuthContext\";\nimport Home from \"@/pages/home\";\nimport ChartMaker from \"@/pages/chartmaker\";\nimport ComparisonChart from \"@/pages/comparison-chart\";\nimport AICopilot from \"@/pages/ai-copilot\";\nimport PublishingAnalytics from \"@/pages/publishing-analytics\";\nimport LoginHistory from \"@/pages/login-history\";\nimport Login from \"@/pages/login\";\nimport Walkthrough from \"@/pages/walkthrough\";\n\nfunction ProtectedRoute({ component: Component, path }: { component: () => JSX.Element; path: string }) {\n  const { isAuthenticated, validateSession } = useAuth();\n  const [isValidating, setIsValidating] = useState(true);\n  \n  useEffect(() => {\n    async function checkSession() {\n      if (isAuthenticated) {\n        await validateSession();\n      }\n      setIsValidating(false);\n    }\n    checkSession();\n  }, [isAuthenticated, validateSession]);\n  \n  if (isValidating) {\n    return <div className=\"min-h-screen flex items-center justify-center\">\n      <div className=\"text-muted-foreground\">Validating session...</div>\n    </div>;\n  }\n  \n  if (!isAuthenticated) {\n    return <Redirect to=\"/login\" />;\n  }\n  \n  return <Component />;\n}\n\nfunction Router() {\n  const { isAuthenticated } = useAuth();\n  \n  return (\n    <Switch>\n      <Route path=\"/login\">\n        {isAuthenticated ? <Redirect to=\"/\" /> : <Login />}\n      </Route>\n      <Route path=\"/\">\n        <ProtectedRoute component={Home} path=\"/\" />\n      </Route>\n      <Route path=\"/price-chart\">\n        <ProtectedRoute component={ChartMaker} path=\"/price-chart\" />\n      </Route>\n      <Route path=\"/comparison-chart\">\n        <ProtectedRoute component={ComparisonChart} path=\"/comparison-chart\" />\n      </Route>\n      <Route path=\"/ai-copilot\">\n        <ProtectedRoute component={AICopilot} path=\"/ai-copilot\" />\n      </Route>\n      <Route path=\"/publishing/analytics\">\n        <ProtectedRoute component={PublishingAnalytics} path=\"/publishing/analytics\" />\n      </Route>\n      <Route path=\"/login-history\">\n        <ProtectedRoute component={LoginHistory} path=\"/login-history\" />\n      </Route>\n      <Route path=\"/walkthrough\">\n        <ProtectedRoute component={Walkthrough} path=\"/walkthrough\" />\n      </Route>\n      <Route>\n        <ProtectedRoute component={Home} path=\"/\" />\n      </Route>\n    </Switch>\n  );\n}\n\nfunction App() {\n  return (\n    <QueryClientProvider client={queryClient}>\n      <ThemeProvider>\n        <AuthProvider>\n          <TooltipProvider>\n            <Toaster />\n            <Router />\n          </TooltipProvider>\n        </AuthProvider>\n      </ThemeProvider>\n    </QueryClientProvider>\n  );\n}\n\nexport default App;\n","path":null,"size_bytes":3025,"size_tokens":null},"client/src/components/ui/dialog.tsx":{"content":"\"use client\"\n\nimport * as React from \"react\"\nimport * as DialogPrimitive from \"@radix-ui/react-dialog\"\nimport { X } from \"lucide-react\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst Dialog = DialogPrimitive.Root\n\nconst DialogTrigger = DialogPrimitive.Trigger\n\nconst DialogPortal = DialogPrimitive.Portal\n\nconst DialogClose = DialogPrimitive.Close\n\nconst DialogOverlay = React.forwardRef<\n  React.ElementRef<typeof DialogPrimitive.Overlay>,\n  React.ComponentPropsWithoutRef<typeof DialogPrimitive.Overlay>\n>(({ className, ...props }, ref) => (\n  <DialogPrimitive.Overlay\n    ref={ref}\n    className={cn(\n      \"fixed inset-0 z-50 bg-black/80 data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0\",\n      className\n    )}\n    {...props}\n  />\n))\nDialogOverlay.displayName = DialogPrimitive.Overlay.displayName\n\nconst DialogContent = React.forwardRef<\n  React.ElementRef<typeof DialogPrimitive.Content>,\n  React.ComponentPropsWithoutRef<typeof DialogPrimitive.Content>\n>(({ className, children, ...props }, ref) => (\n  <DialogPortal>\n    <DialogOverlay />\n    <DialogPrimitive.Content\n      ref={ref}\n      className={cn(\n        \"fixed left-[50%] top-[50%] z-50 grid w-full max-w-lg translate-x-[-50%] translate-y-[-50%] gap-4 border bg-background p-6 shadow-lg duration-200 data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 data-[state=closed]:slide-out-to-left-1/2 data-[state=closed]:slide-out-to-top-[48%] data-[state=open]:slide-in-from-left-1/2 data-[state=open]:slide-in-from-top-[48%] sm:rounded-lg\",\n        className\n      )}\n      {...props}\n    >\n      {children}\n      <DialogPrimitive.Close className=\"absolute right-4 top-4 rounded-sm opacity-70 ring-offset-background transition-opacity hover:opacity-100 focus:outline-none focus:ring-2 focus:ring-ring focus:ring-offset-2 disabled:pointer-events-none data-[state=open]:bg-accent data-[state=open]:text-muted-foreground\">\n        <X className=\"h-4 w-4\" />\n        <span className=\"sr-only\">Close</span>\n      </DialogPrimitive.Close>\n    </DialogPrimitive.Content>\n  </DialogPortal>\n))\nDialogContent.displayName = DialogPrimitive.Content.displayName\n\nconst DialogHeader = ({\n  className,\n  ...props\n}: React.HTMLAttributes<HTMLDivElement>) => (\n  <div\n    className={cn(\n      \"flex flex-col space-y-1.5 text-center sm:text-left\",\n      className\n    )}\n    {...props}\n  />\n)\nDialogHeader.displayName = \"DialogHeader\"\n\nconst DialogFooter = ({\n  className,\n  ...props\n}: React.HTMLAttributes<HTMLDivElement>) => (\n  <div\n    className={cn(\n      \"flex flex-col-reverse sm:flex-row sm:justify-end sm:space-x-2\",\n      className\n    )}\n    {...props}\n  />\n)\nDialogFooter.displayName = \"DialogFooter\"\n\nconst DialogTitle = React.forwardRef<\n  React.ElementRef<typeof DialogPrimitive.Title>,\n  React.ComponentPropsWithoutRef<typeof DialogPrimitive.Title>\n>(({ className, ...props }, ref) => (\n  <DialogPrimitive.Title\n    ref={ref}\n    className={cn(\n      \"text-lg font-semibold leading-none tracking-tight\",\n      className\n    )}\n    {...props}\n  />\n))\nDialogTitle.displayName = DialogPrimitive.Title.displayName\n\nconst DialogDescription = React.forwardRef<\n  React.ElementRef<typeof DialogPrimitive.Description>,\n  React.ComponentPropsWithoutRef<typeof DialogPrimitive.Description>\n>(({ className, ...props }, ref) => (\n  <DialogPrimitive.Description\n    ref={ref}\n    className={cn(\"text-sm text-muted-foreground\", className)}\n    {...props}\n  />\n))\nDialogDescription.displayName = DialogPrimitive.Description.displayName\n\nexport {\n  Dialog,\n  DialogPortal,\n  DialogOverlay,\n  DialogClose,\n  DialogTrigger,\n  DialogContent,\n  DialogHeader,\n  DialogFooter,\n  DialogTitle,\n  DialogDescription,\n}\n","path":null,"size_bytes":3848,"size_tokens":null},"client/src/components/ui/command.tsx":{"content":"import * as React from \"react\"\nimport { type DialogProps } from \"@radix-ui/react-dialog\"\nimport { Command as CommandPrimitive } from \"cmdk\"\nimport { Search } from \"lucide-react\"\n\nimport { cn } from \"@/lib/utils\"\nimport { Dialog, DialogContent } from \"@/components/ui/dialog\"\n\nconst Command = React.forwardRef<\n  React.ElementRef<typeof CommandPrimitive>,\n  React.ComponentPropsWithoutRef<typeof CommandPrimitive>\n>(({ className, ...props }, ref) => (\n  <CommandPrimitive\n    ref={ref}\n    className={cn(\n      \"flex h-full w-full flex-col overflow-hidden rounded-md bg-popover text-popover-foreground\",\n      className\n    )}\n    {...props}\n  />\n))\nCommand.displayName = CommandPrimitive.displayName\n\nconst CommandDialog = ({ children, ...props }: DialogProps) => {\n  return (\n    <Dialog {...props}>\n      <DialogContent className=\"overflow-hidden p-0 shadow-lg\">\n        <Command className=\"[&_[cmdk-group-heading]]:px-2 [&_[cmdk-group-heading]]:font-medium [&_[cmdk-group-heading]]:text-muted-foreground [&_[cmdk-group]:not([hidden])_~[cmdk-group]]:pt-0 [&_[cmdk-group]]:px-2 [&_[cmdk-input-wrapper]_svg]:h-5 [&_[cmdk-input-wrapper]_svg]:w-5 [&_[cmdk-input]]:h-12 [&_[cmdk-item]]:px-2 [&_[cmdk-item]]:py-3 [&_[cmdk-item]_svg]:h-5 [&_[cmdk-item]_svg]:w-5\">\n          {children}\n        </Command>\n      </DialogContent>\n    </Dialog>\n  )\n}\n\nconst CommandInput = React.forwardRef<\n  React.ElementRef<typeof CommandPrimitive.Input>,\n  React.ComponentPropsWithoutRef<typeof CommandPrimitive.Input>\n>(({ className, ...props }, ref) => (\n  <div className=\"flex items-center border-b px-3\" cmdk-input-wrapper=\"\">\n    <Search className=\"mr-2 h-4 w-4 shrink-0 opacity-50\" />\n    <CommandPrimitive.Input\n      ref={ref}\n      className={cn(\n        \"flex h-11 w-full rounded-md bg-transparent py-3 text-sm outline-none placeholder:text-muted-foreground disabled:cursor-not-allowed disabled:opacity-50\",\n        className\n      )}\n      {...props}\n    />\n  </div>\n))\n\nCommandInput.displayName = CommandPrimitive.Input.displayName\n\nconst CommandList = React.forwardRef<\n  React.ElementRef<typeof CommandPrimitive.List>,\n  React.ComponentPropsWithoutRef<typeof CommandPrimitive.List>\n>(({ className, ...props }, ref) => (\n  <CommandPrimitive.List\n    ref={ref}\n    className={cn(\"max-h-[300px] overflow-y-auto overflow-x-hidden\", className)}\n    {...props}\n  />\n))\n\nCommandList.displayName = CommandPrimitive.List.displayName\n\nconst CommandEmpty = React.forwardRef<\n  React.ElementRef<typeof CommandPrimitive.Empty>,\n  React.ComponentPropsWithoutRef<typeof CommandPrimitive.Empty>\n>((props, ref) => (\n  <CommandPrimitive.Empty\n    ref={ref}\n    className=\"py-6 text-center text-sm\"\n    {...props}\n  />\n))\n\nCommandEmpty.displayName = CommandPrimitive.Empty.displayName\n\nconst CommandGroup = React.forwardRef<\n  React.ElementRef<typeof CommandPrimitive.Group>,\n  React.ComponentPropsWithoutRef<typeof CommandPrimitive.Group>\n>(({ className, ...props }, ref) => (\n  <CommandPrimitive.Group\n    ref={ref}\n    className={cn(\n      \"overflow-hidden p-1 text-foreground [&_[cmdk-group-heading]]:px-2 [&_[cmdk-group-heading]]:py-1.5 [&_[cmdk-group-heading]]:text-xs [&_[cmdk-group-heading]]:font-medium [&_[cmdk-group-heading]]:text-muted-foreground\",\n      className\n    )}\n    {...props}\n  />\n))\n\nCommandGroup.displayName = CommandPrimitive.Group.displayName\n\nconst CommandSeparator = React.forwardRef<\n  React.ElementRef<typeof CommandPrimitive.Separator>,\n  React.ComponentPropsWithoutRef<typeof CommandPrimitive.Separator>\n>(({ className, ...props }, ref) => (\n  <CommandPrimitive.Separator\n    ref={ref}\n    className={cn(\"-mx-1 h-px bg-border\", className)}\n    {...props}\n  />\n))\nCommandSeparator.displayName = CommandPrimitive.Separator.displayName\n\nconst CommandItem = React.forwardRef<\n  React.ElementRef<typeof CommandPrimitive.Item>,\n  React.ComponentPropsWithoutRef<typeof CommandPrimitive.Item>\n>(({ className, ...props }, ref) => (\n  <CommandPrimitive.Item\n    ref={ref}\n    className={cn(\n      \"relative flex cursor-default gap-2 select-none items-center rounded-sm px-2 py-1.5 text-sm outline-none data-[disabled=true]:pointer-events-none data-[selected='true']:bg-accent data-[selected=true]:text-accent-foreground data-[disabled=true]:opacity-50 [&_svg]:pointer-events-none [&_svg]:size-4 [&_svg]:shrink-0\",\n      className\n    )}\n    {...props}\n  />\n))\n\nCommandItem.displayName = CommandPrimitive.Item.displayName\n\nconst CommandShortcut = ({\n  className,\n  ...props\n}: React.HTMLAttributes<HTMLSpanElement>) => {\n  return (\n    <span\n      className={cn(\n        \"ml-auto text-xs tracking-widest text-muted-foreground\",\n        className\n      )}\n      {...props}\n    />\n  )\n}\nCommandShortcut.displayName = \"CommandShortcut\"\n\nexport {\n  Command,\n  CommandDialog,\n  CommandInput,\n  CommandList,\n  CommandEmpty,\n  CommandGroup,\n  CommandItem,\n  CommandShortcut,\n  CommandSeparator,\n}\n","path":null,"size_bytes":4885,"size_tokens":null},"shared/schema.ts":{"content":"import { pgTable, text, serial, decimal, integer, boolean, timestamp, jsonb } from \"drizzle-orm/pg-core\";\nimport { createInsertSchema } from \"drizzle-zod\";\nimport { z } from \"zod\";\n\nexport const stocks = pgTable(\"stocks\", {\n  id: serial(\"id\").primaryKey(),\n  symbol: text(\"symbol\").notNull().unique(),\n  name: text(\"name\").notNull(),\n  price: text(\"price\").notNull(),\n  change: text(\"change\").notNull(),\n  percentChange: text(\"percent_change\").notNull(),\n  marketCap: text(\"market_cap\").notNull(),\n  marketCapValue: text(\"market_cap_value\").notNull(),\n  volume: integer(\"volume\").notNull(),\n  indices: jsonb(\"indices\").$type<string[]>().notNull(),\n  sector: text(\"sector\").notNull(),\n  lastUpdated: timestamp(\"last_updated\").notNull().defaultNow(),\n});\n\nexport const slackAlerts = pgTable(\"slack_alerts\", {\n  id: serial(\"id\").primaryKey(),\n  type: text(\"type\").notNull(), // 'morning', 'afternoon', 'test'\n  title: text(\"title\").notNull(),\n  description: text(\"description\").notNull(),\n  sentAt: timestamp(\"sent_at\").notNull().defaultNow(),\n  status: text(\"status\").notNull().default(\"sent\"), // 'sent', 'failed'\n});\n\nexport const marketSummary = pgTable(\"market_summary\", {\n  id: serial(\"id\").primaryKey(),\n  totalMovers: integer(\"total_movers\").notNull(),\n  totalGainers: integer(\"total_gainers\").notNull(),\n  totalLosers: integer(\"total_losers\").notNull(),\n  totalMarketCap: text(\"total_market_cap\").notNull(),\n  avgGainerChange: text(\"avg_gainer_change\").notNull(),\n  avgLoserChange: text(\"avg_loser_change\").notNull(),\n  avgVolume: text(\"avg_volume\").notNull(),\n  volatility: text(\"volatility\").notNull(),\n  sectorLeader: text(\"sector_leader\").notNull(),\n  lastUpdated: timestamp(\"last_updated\").notNull().defaultNow(),\n});\n\nexport const visitorAnalytics = pgTable(\"visitor_analytics\", {\n  id: serial(\"id\").primaryKey(),\n  ipAddress: text(\"ip_address\").notNull(),\n  userAgent: text(\"user_agent\"),\n  country: text(\"country\"),\n  region: text(\"region\"),\n  city: text(\"city\"),\n  latitude: decimal(\"latitude\", { precision: 10, scale: 8 }),\n  longitude: decimal(\"longitude\", { precision: 11, scale: 8 }),\n  timezone: text(\"timezone\"),\n  isp: text(\"isp\"),\n  org: text(\"org\"),\n  visitedAt: timestamp(\"visited_at\").notNull().defaultNow(),\n  leftAt: timestamp(\"left_at\"),\n  duration: integer(\"duration\"), // Duration in seconds\n  returnVisits: integer(\"return_visits\").default(1),\n  sessionId: text(\"session_id\"),\n  path: text(\"path\").notNull().default(\"/\"),\n});\n\nexport const loginAttempts = pgTable(\"login_attempts\", {\n  id: serial(\"id\").primaryKey(),\n  username: text(\"username\").notNull(),\n  success: boolean(\"success\").notNull(),\n  failureReason: text(\"failure_reason\"),\n  ipAddress: text(\"ip_address\"),\n  userAgent: text(\"user_agent\"),\n  country: text(\"country\"),\n  region: text(\"region\"),\n  city: text(\"city\"),\n  attemptedAt: timestamp(\"attempted_at\").notNull().defaultNow(),\n});\n\nexport const insertStockSchema = createInsertSchema(stocks).omit({\n  id: true,\n  lastUpdated: true,\n});\n\nexport const insertSlackAlertSchema = createInsertSchema(slackAlerts).omit({\n  id: true,\n  sentAt: true,\n});\n\nexport const insertMarketSummarySchema = createInsertSchema(marketSummary).omit({\n  id: true,\n  lastUpdated: true,\n});\n\nexport const insertVisitorAnalyticsSchema = createInsertSchema(visitorAnalytics).omit({\n  id: true,\n  visitedAt: true,\n});\n\nexport const insertLoginAttemptSchema = createInsertSchema(loginAttempts).omit({\n  id: true,\n  attemptedAt: true,\n});\n\nexport const chartHistory = pgTable(\"chart_history\", {\n  id: serial(\"id\").primaryKey(),\n  userId: text(\"user_id\").notNull(), // User identifier (email/username)\n  sessionId: text(\"session_id\").notNull(), // Unique session identifier for this chart\n  symbol: text(\"symbol\").notNull(),\n  timeframe: text(\"timeframe\").notNull(), // '1D', '5D', '2W', '1M', '3M', '1Y', '3Y', '5Y', 'custom'\n  customStartDate: text(\"custom_start_date\"), // For custom timeframe\n  customEndDate: text(\"custom_end_date\"), // For custom timeframe\n  dividendAdjusted: boolean(\"dividend_adjusted\").notNull().default(false),\n  csvOverlay: jsonb(\"csv_overlay\").$type<Array<{\n    timestamp: number;\n    value: number;\n  }>>(),\n  comparisonTickers: jsonb(\"comparison_tickers\").$type<Array<{\n    symbol: string;\n    name: string;\n    color: string;\n  }>>(),\n  annotations: jsonb(\"annotations\").$type<Array<{\n    id: string;\n    type: string;\n    text?: string;\n    price?: number;\n    timestamp?: number;\n    time?: string;\n    startTimestamp?: number;\n    endTimestamp?: number;\n    startPrice?: number;\n    endPrice?: number;\n  }>>().notNull(),\n  savedAt: timestamp(\"saved_at\").notNull().defaultNow(),\n  updatedAt: timestamp(\"updated_at\").notNull().defaultNow(),\n});\n\nexport const insertChartHistorySchema = createInsertSchema(chartHistory).omit({\n  id: true,\n  savedAt: true,\n  updatedAt: true,\n});\n\nexport const compareChartHistory = pgTable(\"compare_chart_history\", {\n  id: serial(\"id\").primaryKey(),\n  userId: text(\"user_id\").notNull(),\n  sessionId: text(\"session_id\").notNull(),\n  timeframe: text(\"timeframe\").notNull(),\n  customStartDate: text(\"custom_start_date\"),\n  customEndDate: text(\"custom_end_date\"),\n  tickers: jsonb(\"tickers\").$type<Array<{\n    symbol: string;\n    color: string;\n    visible: boolean;\n  }>>().notNull(),\n  annotations: jsonb(\"annotations\").$type<Array<{\n    id: string;\n    type: string;\n    text?: string;\n    price?: number;\n    timestamp?: number;\n    time?: string;\n    startTimestamp?: number;\n    endTimestamp?: number;\n    startPrice?: number;\n    endPrice?: number;\n  }>>().notNull(),\n  savedAt: timestamp(\"saved_at\").notNull().defaultNow(),\n  updatedAt: timestamp(\"updated_at\").notNull().defaultNow(),\n});\n\nexport const insertCompareChartHistorySchema = createInsertSchema(compareChartHistory).omit({\n  id: true,\n  savedAt: true,\n  updatedAt: true,\n});\n\nexport type Stock = typeof stocks.$inferSelect;\nexport type InsertStock = z.infer<typeof insertStockSchema>;\nexport type SlackAlert = typeof slackAlerts.$inferSelect;\nexport type InsertSlackAlert = z.infer<typeof insertSlackAlertSchema>;\nexport type MarketSummary = typeof marketSummary.$inferSelect;\nexport type InsertMarketSummary = z.infer<typeof insertMarketSummarySchema>;\nexport type VisitorAnalytics = typeof visitorAnalytics.$inferSelect;\nexport type InsertVisitorAnalytics = z.infer<typeof insertVisitorAnalyticsSchema>;\nexport type LoginAttempt = typeof loginAttempts.$inferSelect;\nexport type InsertLoginAttempt = z.infer<typeof insertLoginAttemptSchema>;\nexport type ChartHistory = typeof chartHistory.$inferSelect;\nexport type InsertChartHistory = z.infer<typeof insertChartHistorySchema>;\nexport type CompareChartHistory = typeof compareChartHistory.$inferSelect;\nexport type InsertCompareChartHistory = z.infer<typeof insertCompareChartHistorySchema>;\n\n// AI Co-Pilot tables\nexport const aiCopilotChats = pgTable(\"ai_copilot_chats\", {\n  id: serial(\"id\").primaryKey(),\n  userId: text(\"user_id\").notNull(), // User identifier for ownership verification\n  sessionId: text(\"session_id\").notNull(),\n  createdAt: timestamp(\"created_at\").notNull().defaultNow(),\n});\n\nexport const aiCopilotMessages = pgTable(\"ai_copilot_messages\", {\n  id: serial(\"id\").primaryKey(),\n  chatId: integer(\"chat_id\").notNull().references(() => aiCopilotChats.id),\n  role: text(\"role\").notNull(), // 'user' or 'assistant'\n  content: text(\"content\").notNull(),\n  chartConfig: jsonb(\"chart_config\").$type<{\n    type: 'bar' | 'line' | 'pie' | 'area';\n    data: any[];\n    xKey: string;\n    yKeys: string[];\n    title: string;\n    colors: string[];\n  }>(),\n  createdAt: timestamp(\"created_at\").notNull().defaultNow(),\n});\n\nexport const aiCopilotUploads = pgTable(\"ai_copilot_uploads\", {\n  id: serial(\"id\").primaryKey(),\n  chatId: integer(\"chat_id\").notNull().references(() => aiCopilotChats.id),\n  filename: text(\"filename\").notNull(),\n  csvData: text(\"csv_data\").notNull(), // Store raw CSV as text\n  parsedData: jsonb(\"parsed_data\").$type<any[]>(),\n  uploadedAt: timestamp(\"uploaded_at\").notNull().defaultNow(),\n});\n\nexport const insertAiCopilotChatSchema = createInsertSchema(aiCopilotChats).omit({\n  id: true,\n  createdAt: true,\n});\n\nexport const insertAiCopilotMessageSchema = createInsertSchema(aiCopilotMessages).omit({\n  id: true,\n  createdAt: true,\n});\n\nexport const insertAiCopilotUploadSchema = createInsertSchema(aiCopilotUploads).omit({\n  id: true,\n  uploadedAt: true,\n});\n\nexport type AiCopilotChat = typeof aiCopilotChats.$inferSelect;\nexport type InsertAiCopilotChat = z.infer<typeof insertAiCopilotChatSchema>;\nexport type AiCopilotMessage = typeof aiCopilotMessages.$inferSelect;\nexport type InsertAiCopilotMessage = z.infer<typeof insertAiCopilotMessageSchema>;\nexport type AiCopilotUpload = typeof aiCopilotUploads.$inferSelect;\nexport type InsertAiCopilotUpload = z.infer<typeof insertAiCopilotUploadSchema>;\n\n// Filter schemas\nexport const stockFilterSchema = z.object({\n  changeThreshold: z.number().min(0).default(2),\n  marketCap: z.enum([\"2B\", \"5B\", \"10B\", \"50B\"]).default(\"2B\"),\n  indexFilter: z.enum([\n    \"all\",\n    \"sp500\",\n    \"sp400\", \n    \"sp600\",\n    \"nasdaq100\",\n    \"russell1000\",\n    \"russell2000\",\n    \"russell3000\",\n    \"tmi\"\n  ]).default(\"all\"),\n  sortBy: z.enum([\"symbol\", \"price\", \"change\", \"percentChange\", \"marketCap\", \"marketCapValue\", \"volume\"]).default(\"percentChange\"),\n  sortOrder: z.enum([\"asc\", \"desc\"]).default(\"desc\"),\n  ticker: z.string().optional(), // For ticker search\n});\n\n// Search result schema\nexport const searchResultSchema = z.object({\n  symbol: z.string(),\n  name: z.string(),\n  price: z.string(),\n  percentChange: z.string(),\n  marketCap: z.string(),\n});\n\nexport type StockFilter = z.infer<typeof stockFilterSchema>;\n","path":null,"size_bytes":9689,"size_tokens":null},"client/src/lib/queryClient.ts":{"content":"import { QueryClient, QueryFunction } from \"@tanstack/react-query\";\n\n// Global logout handler for 401 responses\nlet logoutHandler: (() => void) | null = null;\n\nexport function setLogoutHandler(handler: () => void) {\n  logoutHandler = handler;\n}\n\nasync function throwIfResNotOk(res: Response) {\n  if (!res.ok) {\n    // If 401, trigger logout to clear stale tokens\n    if (res.status === 401 && logoutHandler) {\n      logoutHandler();\n    }\n    const text = (await res.text()) || res.statusText;\n    throw new Error(`${res.status}: ${text}`);\n  }\n}\n\nexport async function apiRequest(\n  method: string,\n  url: string,\n  data?: unknown | undefined,\n): Promise<Response> {\n  const headers: Record<string, string> = {};\n  \n  if (data) {\n    headers[\"Content-Type\"] = \"application/json\";\n  }\n  \n  // Add auth token if available\n  const authToken = localStorage.getItem('authToken');\n  if (authToken) {\n    headers[\"Authorization\"] = `Bearer ${authToken}`;\n  }\n  \n  const res = await fetch(url, {\n    method,\n    headers,\n    body: data ? JSON.stringify(data) : undefined,\n    credentials: \"include\",\n  });\n\n  await throwIfResNotOk(res);\n  return res;\n}\n\ntype UnauthorizedBehavior = \"returnNull\" | \"throw\";\nexport const getQueryFn: <T>(options: {\n  on401: UnauthorizedBehavior;\n}) => QueryFunction<T> =\n  ({ on401: unauthorizedBehavior }) =>\n  async ({ queryKey }) => {\n    const headers: Record<string, string> = {};\n    \n    // Add auth token if available\n    const authToken = localStorage.getItem('authToken');\n    if (authToken) {\n      headers[\"Authorization\"] = `Bearer ${authToken}`;\n    }\n    \n    const res = await fetch(queryKey.join(\"/\") as string, {\n      credentials: \"include\",\n      headers,\n    });\n\n    if (unauthorizedBehavior === \"returnNull\" && res.status === 401) {\n      return null;\n    }\n\n    await throwIfResNotOk(res);\n    return await res.json();\n  };\n\nexport const queryClient = new QueryClient({\n  defaultOptions: {\n    queries: {\n      queryFn: getQueryFn({ on401: \"throw\" }),\n      refetchInterval: false,\n      refetchOnWindowFocus: false,\n      staleTime: Infinity,\n      retry: false,\n    },\n    mutations: {\n      retry: false,\n    },\n  },\n});\n","path":null,"size_bytes":2172,"size_tokens":null},"client/src/components/suffix-search-modal.tsx":{"content":"import { useState, useEffect } from \"react\";\nimport { Search, Globe, Building2, Info, Clock, Calendar } from \"lucide-react\";\nimport { Dialog, DialogContent, DialogHeader, DialogTitle, DialogTrigger } from \"@/components/ui/dialog\";\nimport { Input } from \"@/components/ui/input\";\nimport { Button } from \"@/components/ui/button\";\nimport { Card, CardContent, CardHeader, CardTitle } from \"@/components/ui/card\";\nimport { Badge } from \"@/components/ui/badge\";\nimport { Separator } from \"@/components/ui/separator\";\nimport { searchSuffix, getAllSuffixes, type SuffixInfo } from \"@/data/suffix-mappings\";\nimport { computeMarketStatus, type MarketStatus } from \"@/lib/marketHours\";\nimport { useQuery } from \"@tanstack/react-query\";\nimport { cn } from \"@/lib/utils\";\n\n// Custom Payment Card Icon Component\nconst PaymentCardIcon = ({ className }: { className?: string }) => (\n  <svg \n    className={className} \n    viewBox=\"0 0 24 24\" \n    fill=\"none\" \n    xmlns=\"http://www.w3.org/2000/svg\"\n  >\n    <rect \n      x=\"2\" \n      y=\"5\" \n      width=\"20\" \n      height=\"14\" \n      rx=\"3\" \n      ry=\"3\" \n      stroke=\"currentColor\" \n      strokeWidth=\"2\" \n      fill=\"none\"\n    />\n    <circle \n      cx=\"7\" \n      cy=\"12\" \n      r=\"2.5\" \n      fill=\"currentColor\"\n    />\n    <rect \n      x=\"12\" \n      y=\"9\" \n      width=\"8\" \n      height=\"6\" \n      rx=\"1\" \n      fill=\"currentColor\"\n    />\n  </svg>\n);\n\ninterface SuffixSearchModalProps {\n  children: React.ReactNode;\n}\n\n// Mapping from exchange names to Finnhub exchange codes  \nconst exchangeToFinnhubCode: { [key: string]: string } = {\n  // US Exchanges\n  'NYSE': 'US',\n  'NASDAQ': 'US',\n  'NASDAQ Global Select Market': 'US',\n  'NASDAQ Global Market': 'US', \n  'NASDAQ Capital Market': 'US',\n  'New York Stock Exchange': 'US',\n  \n  // International Exchanges - matching suffix-mappings.ts names\n  'LSE': 'L',  // London Stock Exchange\n  'London Stock Exchange': 'L',\n  'Euronext Paris': 'PA',  // Paris\n  'XETRA': 'F',  // Frankfurt/Germany\n  'Deutsche Brse XETRA': 'F',\n  'SIX': 'SW',  // Switzerland\n  'SIX Swiss Exchange': 'SW',\n  'Borsa Italiana': 'MI',  // Milan\n  'Borsa Italiana (Milan Stock Exchange)': 'MI',\n  'TSE': 'T',  // Tokyo\n  'Tokyo Stock Exchange': 'T',\n  'HKEX': 'HK',  // Hong Kong\n  'Hong Kong Exchanges and Clearing': 'HK',\n  'TSX': 'TO',  // Toronto\n  'ASX': 'AX',  // Australia\n  'SSE': 'SS',  // Shanghai\n  'Shanghai Stock Exchange': 'SS',\n  'SZSE': 'SZ',  // Shenzhen\n  'Shenzhen Stock Exchange': 'SZ',\n  \n  // Additional European markets\n  'OMX Stockholm': 'ST',  // Stockholm\n  'Nasdaq Stockholm': 'ST',  // Stockholm\n  'OMXC': 'CO',  // Copenhagen\n  'Nasdaq Copenhagen (OMX Copenhagen)': 'CO',\n  'OMXH': 'HE',  // Helsinki  \n  'Nasdaq Helsinki (OMX Helsinki)': 'HE',\n  'Euronext Amsterdam': 'AS',  // Amsterdam\n  'Madrid Stock Exchange': 'MC',  // Madrid\n  'BME Spanish Exchanges': 'MC',  // Madrid\n  'BME': 'MC',  // Madrid\n  'Bolsas y Mercados Espaoles (Madrid Stock Exchange)': 'MC',\n  'OSE': 'OL',  // Oslo\n  'Oslo Stock Exchange (Euronext Oslo)': 'OL',\n  'BMV': 'MX',  // Mexico\n  'Bolsa Mexicana de Valores (Mexican Stock Exchange)': 'MX'\n};\n\nexport function SuffixSearchModal({ children }: SuffixSearchModalProps) {\n  const [searchQuery, setSearchQuery] = useState(\"\");\n  const [searchResult, setSearchResult] = useState<SuffixInfo | null>(null);\n  const [noResults, setNoResults] = useState(false);\n  const [isOpen, setIsOpen] = useState(false);\n  const [marketStatus, setMarketStatus] = useState<MarketStatus | null>(null);\n\n  const allSuffixes = getAllSuffixes();\n\n  // Get Finnhub exchange code for the selected exchange\n  const finnhubExchange = searchResult?.exchange ? exchangeToFinnhubCode[searchResult.exchange] || 'US' : null;\n  \n  // Debug exchange mapping\n  if (searchResult?.exchange) {\n    console.log('Debug exchange mapping - Exchange:', searchResult.exchange, 'Mapped to Finnhub code:', finnhubExchange);\n  }\n\n  // Fetch holidays from Finnhub API\n  const { data: holidayData } = useQuery({\n    queryKey: ['market-holidays', finnhubExchange],\n    queryFn: async () => {\n      if (!finnhubExchange) return null;\n      const response = await fetch(`/api/exchanges/${finnhubExchange}/holidays`);\n      if (!response.ok) return null;\n      return response.json();\n    },\n    enabled: !!finnhubExchange,\n    staleTime: 24 * 60 * 60 * 1000, // 24 hours\n    gcTime: 24 * 60 * 60 * 1000, // 24 hours\n  });\n\n  // Process holiday data to get upcoming holidays  \n  const upcomingHolidays = holidayData?.holidays?.filter((holiday: any) => {\n    try {\n      const holidayDate = new Date(holiday.atDate || holiday.eventDate || holiday.date);\n      if (isNaN(holidayDate.getTime())) {\n        console.warn('Invalid holiday date for exchange', finnhubExchange, ':', holiday);\n        return false;\n      }\n      \n      const today = new Date();\n      const maxDate = new Date();\n      maxDate.setDate(today.getDate() + 365); // Next 365 days (full year)\n      const isUpcoming = holidayDate >= today && holidayDate <= maxDate;\n      \n      if (isUpcoming) {\n        console.log('Valid upcoming holiday for', finnhubExchange, ':', holiday.eventName || holiday.name, 'on', holidayDate.toDateString());\n      }\n      \n      return isUpcoming;\n    } catch (error) {\n      console.error('Error processing holiday for', finnhubExchange, ':', holiday, error);\n      return false;\n    }\n  }).slice(0, 5) || []; // Limit to 5 upcoming holidays\n  \n  console.log('Final upcoming holidays for', finnhubExchange, ':', upcomingHolidays.length, 'holidays');\n\n  const handleSearch = (query: string) => {\n    console.log('Debug search - Query:', query);\n    setSearchQuery(query);\n    setNoResults(false);\n\n    if (!query.trim()) {\n      setSearchResult(null);\n      setMarketStatus(null);\n      return;\n    }\n\n    const result = searchSuffix(query);\n    console.log('Debug search - Search result:', result);\n    \n    if (result) {\n      setSearchResult(result);\n      console.log('Debug search - Setting result with exchange:', result.exchange);\n      // Update market status if market hours are available\n      if (result.marketHours) {\n        setMarketStatus(computeMarketStatus(result.marketHours));\n      } else {\n        setMarketStatus(null);\n      }\n    } else {\n      setSearchResult(null);\n      setMarketStatus(null);\n      setNoResults(true);\n    }\n  };\n\n  const handleSuffixClick = (suffix: string) => {\n    const cleanSuffix = suffix.replace('.', '');\n    setSearchQuery(cleanSuffix);\n    handleSearch(cleanSuffix);\n  };\n\n  const handleClear = () => {\n    setSearchQuery(\"\");\n    setSearchResult(null);\n    setMarketStatus(null);\n    setNoResults(false);\n  };\n\n  // Update market status every second when modal is open and we have results\n  useEffect(() => {\n    let interval: NodeJS.Timeout | null = null;\n    \n    if (isOpen && searchResult?.marketHours) {\n      interval = setInterval(() => {\n        setMarketStatus(computeMarketStatus(searchResult.marketHours!));\n      }, 1000);\n    }\n    \n    return () => {\n      if (interval) clearInterval(interval);\n    };\n  }, [isOpen, searchResult]);\n\n  const popularSuffixes = ['.UW', '.UN', '.L', '.T', '.HK', '.MC', '.PA', '.SE', '.TO', '.AX'];\n\n  return (\n    <Dialog open={isOpen} onOpenChange={setIsOpen}>\n      <DialogTrigger asChild>\n        {children}\n      </DialogTrigger>\n      <DialogContent className=\"max-w-2xl max-h-[80vh] overflow-y-auto\">\n        <DialogHeader>\n          <DialogTitle className=\"flex items-center gap-2 text-xl\">\n            <Globe className=\"h-5 w-5 text-[#FAFF50]\" />\n            Stock Ticker Suffix Guide\n          </DialogTitle>\n        </DialogHeader>\n\n        <div className=\"space-y-6\">\n          {/* Search Section */}\n          <div className=\"space-y-4\">\n            <div className=\"relative\">\n              <Search className=\"absolute left-3 top-1/2 transform -translate-y-1/2 h-4 w-4 text-muted-foreground\" />\n              <Input\n                placeholder=\"Enter a suffix (e.g., UW, SE, MC)...\"\n                value={searchQuery}\n                onChange={(e) => handleSearch(e.target.value)}\n                className=\"pl-10 pr-12\"\n                data-testid=\"input-suffix-search\"\n              />\n              {searchQuery && (\n                <Button\n                  variant=\"ghost\"\n                  size=\"sm\"\n                  onClick={handleClear}\n                  className=\"absolute right-2 top-1/2 transform -translate-y-1/2 h-6 w-6 p-0\"\n                  data-testid=\"button-clear-search\"\n                >\n                  \n                </Button>\n              )}\n            </div>\n\n            {/* Popular Suffixes */}\n            <div>\n              <p className=\"text-sm text-muted-foreground mb-2\">Popular suffixes:</p>\n              <div className=\"flex flex-wrap gap-2\">\n                {popularSuffixes.map((suffix) => (\n                  <Badge\n                    key={suffix}\n                    variant=\"secondary\"\n                    className=\"cursor-pointer hover:bg-primary hover:text-primary-foreground transition-colors\"\n                    onClick={() => handleSuffixClick(suffix)}\n                    data-testid={`badge-suffix-${suffix.replace('.', '')}`}\n                  >\n                    {suffix}\n                  </Badge>\n                ))}\n              </div>\n            </div>\n          </div>\n\n          <Separator />\n\n          {/* Search Results */}\n          {searchResult && (\n            <Card className=\"border-l-4 border-l-[#FAFF50]\" data-testid=\"card-search-result\">\n              <CardHeader className=\"pb-3\">\n                <CardTitle className=\"flex items-center gap-2 text-lg\">\n                  <span className=\"font-mono text-[#FAFF50] dark:text-[#FAFF50]\">\n                    {searchResult.suffix}\n                  </span>\n                  <span className=\"text-muted-foreground\"></span>\n                  <span>{searchResult.country}</span>\n                </CardTitle>\n              </CardHeader>\n              <CardContent className=\"space-y-4\">\n                <div className=\"grid grid-cols-1 md:grid-cols-2 gap-4\">\n                  <div className=\"flex items-start gap-3\">\n                    <Building2 className=\"h-5 w-5 text-[#FAFF50] mt-0.5 flex-shrink-0\" />\n                    <div>\n                      <p className=\"font-medium text-sm\">Exchange</p>\n                      <p className=\"text-sm text-muted-foreground\">{searchResult.exchange}</p>\n                      <p className=\"text-xs text-muted-foreground mt-1\">{searchResult.fullExchangeName}</p>\n                    </div>\n                  </div>\n                  \n                  {searchResult.currency && (\n                    <div className=\"flex items-start gap-3\">\n                      <PaymentCardIcon className=\"h-5 w-5 text-[#FAFF50] mt-0.5 flex-shrink-0\" />\n                      <div>\n                        <p className=\"font-medium text-sm\">Currency</p>\n                        <p className=\"text-sm text-muted-foreground\">{searchResult.currency}</p>\n                      </div>\n                    </div>\n                  )}\n                </div>\n\n                {searchResult.notes && (\n                  <div className=\"flex items-start gap-3 pt-2 border-t\">\n                    <Info className=\"h-5 w-5 text-[#FAFF50] mt-0.5 flex-shrink-0\" />\n                    <div>\n                      <p className=\"font-medium text-sm\">Notes</p>\n                      <p className=\"text-sm text-muted-foreground\">{searchResult.notes}</p>\n                    </div>\n                  </div>\n                )}\n\n                {/* Market Status Section */}\n                {marketStatus && (\n                  <div className=\"flex items-start gap-3 pt-2 border-t\">\n                    <Clock className=\"h-5 w-5 text-[#FAFF50] mt-0.5 flex-shrink-0\" data-testid=\"icon-clock\" />\n                    <div className=\"space-y-2\">\n                      <div className=\"flex items-center gap-2\">\n                        <p className=\"font-medium text-sm\">Market Status</p>\n                        <Badge \n                          variant={marketStatus.isOpen ? \"default\" : \"secondary\"}\n                          className={cn(\n                            \"text-xs px-2 py-0.5\",\n                            marketStatus.isOpen \n                              ? \"bg-green-100 text-green-800 border-green-300 dark:bg-green-900 dark:text-green-100\" \n                              : \"bg-red-100 text-red-800 border-red-300 dark:bg-red-900 dark:text-red-100\"\n                          )}\n                          data-testid=\"text-market-status\"\n                        >\n                          {marketStatus.isOpen ? 'OPEN' : 'CLOSED'}\n                        </Badge>\n                      </div>\n                      <p className=\"text-sm text-muted-foreground\" data-testid=\"text-countdown\">\n                        {marketStatus.formattedCountdown}\n                      </p>\n                      <p className=\"text-xs text-muted-foreground\" data-testid=\"text-market-hours\">\n                        {marketStatus.marketHoursGMT}\n                      </p>\n                    </div>\n                  </div>\n                )}\n\n                {/* National Holidays Section */}\n                {searchResult && finnhubExchange && (\n                  <div className=\"flex items-start gap-3 pt-2 border-t\">\n                    <Calendar className=\"h-5 w-5 text-[#FAFF50] mt-0.5 flex-shrink-0\" data-testid=\"icon-calendar\" />\n                    <div className=\"space-y-2\">\n                      <p className=\"font-medium text-sm\">\n                        Upcoming Market Holidays - {searchResult.country}\n                      </p>\n                      {upcomingHolidays.length > 0 ? (\n                        <>\n                          <div className=\"space-y-1\">\n                            {upcomingHolidays.map((holiday: any, index: number) => {\n                              const holidayDate = new Date(holiday.atDate || holiday.eventDate || holiday.date);\n                              const isToday = new Date().toDateString() === holidayDate.toDateString();\n                              const dayOfWeek = holidayDate.toLocaleDateString('en-US', { weekday: 'short' });\n                              const formattedDate = holidayDate.toLocaleDateString('en-US', { \n                                month: 'short', \n                                day: 'numeric',\n                                year: 'numeric'\n                              });\n                              \n                              return (\n                                <div key={`${holiday.atDate || holiday.eventDate || holiday.date}-${index}`} className=\"flex items-center justify-between\">\n                                  <div className=\"flex items-center gap-2\">\n                                    <p className=\"text-sm text-muted-foreground\">\n                                      {holiday.eventName || holiday.name || holiday.event || 'Market Holiday'}\n                                    </p>\n                                    {(holiday.tradingHour && holiday.tradingHour !== '') && (\n                                      <Badge variant=\"outline\" className=\"text-xs px-1 py-0 text-orange-600 border-orange-300 dark:text-orange-400\">\n                                        Half Day\n                                      </Badge>\n                                    )}\n                                    {isToday && (\n                                      <Badge variant=\"secondary\" className=\"text-xs px-1 py-0 bg-red-100 text-red-800 border-red-300 dark:bg-red-900 dark:text-red-100\">\n                                        Today\n                                      </Badge>\n                                    )}\n                                  </div>\n                                  <p className=\"text-xs text-muted-foreground\">\n                                    {dayOfWeek} {formattedDate}\n                                  </p>\n                                </div>\n                              );\n                            })}\n                          </div>\n                          <p className=\"text-xs text-muted-foreground mt-2\">\n                            Markets will be closed on these dates\n                          </p>\n                        </>\n                      ) : (\n                        <div className=\"text-sm text-muted-foreground\">\n                          <p>Market is closed on: Loading holiday data for {searchResult.country}...</p>\n                          <p className=\"text-xs mt-1\">\n                            Holiday information provided by Finnhub API (Exchange: {finnhubExchange})\n                          </p>\n                        </div>\n                      )}\n                    </div>\n                  </div>\n                )}\n              </CardContent>\n            </Card>\n          )}\n\n          {/* No Results */}\n          {noResults && (\n            <Card className=\"border-l-4 border-l-yellow-500\" data-testid=\"card-no-results\">\n              <CardContent className=\"py-6\">\n                <div className=\"text-center space-y-2\">\n                  <p className=\"font-medium\">No suffix found</p>\n                  <p className=\"text-sm text-muted-foreground\">\n                    Sorry, we don't have information for \"{searchQuery}\" in our database.\n                  </p>\n                  <p className=\"text-xs text-muted-foreground\">\n                    Try searching for suffixes like UW, SE, MC, PA, L, T, HK, etc.\n                  </p>\n                </div>\n              </CardContent>\n            </Card>\n          )}\n\n          {/* Help Section */}\n          {!searchQuery && (\n            <Card className=\"bg-muted/50\" data-testid=\"card-help-section\">\n              <CardHeader className=\"pb-3\">\n                <CardTitle className=\"text-lg\">How to Use</CardTitle>\n              </CardHeader>\n              <CardContent className=\"space-y-3\">\n                <div className=\"space-y-2\">\n                  <p className=\"text-sm\">\n                    <strong>Search:</strong> Enter any Bloomberg-style ticker suffix (with or without the dot)\n                  </p>\n                  <p className=\"text-sm\">\n                    <strong>Examples:</strong> UW, .SE, MC, PA, L, T, HK\n                  </p>\n                  <p className=\"text-sm\">\n                    <strong>Coverage:</strong> {allSuffixes.length} suffixes covering major global exchanges\n                  </p>\n                </div>\n                \n                <Separator className=\"my-3\" />\n                \n                <div>\n                  <p className=\"text-xs text-muted-foreground\">\n                    This tool helps you understand Bloomberg terminal ticker suffix notation \n                    for stocks listed on different exchanges worldwide.\n                  </p>\n                </div>\n              </CardContent>\n            </Card>\n          )}\n        </div>\n      </DialogContent>\n    </Dialog>\n  );\n}","path":null,"size_bytes":19028,"size_tokens":null},"client/src/components/ui/tooltip.tsx":{"content":"\"use client\"\n\nimport * as React from \"react\"\nimport * as TooltipPrimitive from \"@radix-ui/react-tooltip\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst TooltipProvider = TooltipPrimitive.Provider\n\nconst Tooltip = TooltipPrimitive.Root\n\nconst TooltipTrigger = TooltipPrimitive.Trigger\n\nconst TooltipContent = React.forwardRef<\n  React.ElementRef<typeof TooltipPrimitive.Content>,\n  React.ComponentPropsWithoutRef<typeof TooltipPrimitive.Content>\n>(({ className, sideOffset = 4, ...props }, ref) => (\n  <TooltipPrimitive.Content\n    ref={ref}\n    sideOffset={sideOffset}\n    className={cn(\n      \"z-50 overflow-hidden rounded-md border bg-popover px-3 py-1.5 text-sm text-popover-foreground shadow-md animate-in fade-in-0 zoom-in-95 data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=closed]:zoom-out-95 data-[side=bottom]:slide-in-from-top-2 data-[side=left]:slide-in-from-right-2 data-[side=right]:slide-in-from-left-2 data-[side=top]:slide-in-from-bottom-2 origin-[--radix-tooltip-content-transform-origin]\",\n      className\n    )}\n    {...props}\n  />\n))\nTooltipContent.displayName = TooltipPrimitive.Content.displayName\n\nexport { Tooltip, TooltipTrigger, TooltipContent, TooltipProvider }\n","path":null,"size_bytes":1209,"size_tokens":null},"server/db.ts":{"content":"import { Pool, neonConfig } from '@neondatabase/serverless';\nimport { drizzle } from 'drizzle-orm/neon-serverless';\nimport ws from \"ws\";\nimport * as schema from \"@shared/schema\";\n\nneonConfig.webSocketConstructor = ws;\n\nif (!process.env.DATABASE_URL) {\n  throw new Error(\n    \"DATABASE_URL must be set. Did you forget to provision a database?\",\n  );\n}\n\nexport const pool = new Pool({ connectionString: process.env.DATABASE_URL });\nexport const db = drizzle({ client: pool, schema });","path":null,"size_bytes":482,"size_tokens":null},"client/src/types/global.d.ts":{"content":"// Global type declarations for custom elements\n\ndeclare namespace JSX {\n  interface IntrinsicElements {\n    'dotlottie-wc': {\n      src: string;\n      style?: React.CSSProperties;\n      autoplay?: boolean;\n      loop?: boolean;\n      children?: React.ReactNode;\n    };\n  }\n}","path":null,"size_bytes":275,"size_tokens":null},"client/src/components/ui/breadcrumb.tsx":{"content":"import * as React from \"react\"\nimport { Slot } from \"@radix-ui/react-slot\"\nimport { ChevronRight, MoreHorizontal } from \"lucide-react\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst Breadcrumb = React.forwardRef<\n  HTMLElement,\n  React.ComponentPropsWithoutRef<\"nav\"> & {\n    separator?: React.ReactNode\n  }\n>(({ ...props }, ref) => <nav ref={ref} aria-label=\"breadcrumb\" {...props} />)\nBreadcrumb.displayName = \"Breadcrumb\"\n\nconst BreadcrumbList = React.forwardRef<\n  HTMLOListElement,\n  React.ComponentPropsWithoutRef<\"ol\">\n>(({ className, ...props }, ref) => (\n  <ol\n    ref={ref}\n    className={cn(\n      \"flex flex-wrap items-center gap-1.5 break-words text-sm text-muted-foreground sm:gap-2.5\",\n      className\n    )}\n    {...props}\n  />\n))\nBreadcrumbList.displayName = \"BreadcrumbList\"\n\nconst BreadcrumbItem = React.forwardRef<\n  HTMLLIElement,\n  React.ComponentPropsWithoutRef<\"li\">\n>(({ className, ...props }, ref) => (\n  <li\n    ref={ref}\n    className={cn(\"inline-flex items-center gap-1.5\", className)}\n    {...props}\n  />\n))\nBreadcrumbItem.displayName = \"BreadcrumbItem\"\n\nconst BreadcrumbLink = React.forwardRef<\n  HTMLAnchorElement,\n  React.ComponentPropsWithoutRef<\"a\"> & {\n    asChild?: boolean\n  }\n>(({ asChild, className, ...props }, ref) => {\n  const Comp = asChild ? Slot : \"a\"\n\n  return (\n    <Comp\n      ref={ref}\n      className={cn(\"transition-colors hover:text-foreground\", className)}\n      {...props}\n    />\n  )\n})\nBreadcrumbLink.displayName = \"BreadcrumbLink\"\n\nconst BreadcrumbPage = React.forwardRef<\n  HTMLSpanElement,\n  React.ComponentPropsWithoutRef<\"span\">\n>(({ className, ...props }, ref) => (\n  <span\n    ref={ref}\n    role=\"link\"\n    aria-disabled=\"true\"\n    aria-current=\"page\"\n    className={cn(\"font-normal text-foreground\", className)}\n    {...props}\n  />\n))\nBreadcrumbPage.displayName = \"BreadcrumbPage\"\n\nconst BreadcrumbSeparator = ({\n  children,\n  className,\n  ...props\n}: React.ComponentProps<\"li\">) => (\n  <li\n    role=\"presentation\"\n    aria-hidden=\"true\"\n    className={cn(\"[&>svg]:w-3.5 [&>svg]:h-3.5\", className)}\n    {...props}\n  >\n    {children ?? <ChevronRight />}\n  </li>\n)\nBreadcrumbSeparator.displayName = \"BreadcrumbSeparator\"\n\nconst BreadcrumbEllipsis = ({\n  className,\n  ...props\n}: React.ComponentProps<\"span\">) => (\n  <span\n    role=\"presentation\"\n    aria-hidden=\"true\"\n    className={cn(\"flex h-9 w-9 items-center justify-center\", className)}\n    {...props}\n  >\n    <MoreHorizontal className=\"h-4 w-4\" />\n    <span className=\"sr-only\">More</span>\n  </span>\n)\nBreadcrumbEllipsis.displayName = \"BreadcrumbElipssis\"\n\nexport {\n  Breadcrumb,\n  BreadcrumbList,\n  BreadcrumbItem,\n  BreadcrumbLink,\n  BreadcrumbPage,\n  BreadcrumbSeparator,\n  BreadcrumbEllipsis,\n}\n","path":null,"size_bytes":2712,"size_tokens":null},"vite.config.ts":{"content":"import { defineConfig } from \"vite\";\nimport react from \"@vitejs/plugin-react\";\nimport path from \"path\";\nimport runtimeErrorOverlay from \"@replit/vite-plugin-runtime-error-modal\";\n\nexport default defineConfig({\n  plugins: [\n    react(),\n    runtimeErrorOverlay(),\n    ...(process.env.NODE_ENV !== \"production\" &&\n    process.env.REPL_ID !== undefined\n      ? [\n          await import(\"@replit/vite-plugin-cartographer\").then((m) =>\n            m.cartographer(),\n          ),\n        ]\n      : []),\n  ],\n  resolve: {\n    alias: {\n      \"@\": path.resolve(import.meta.dirname, \"client\", \"src\"),\n      \"@shared\": path.resolve(import.meta.dirname, \"shared\"),\n      \"@assets\": path.resolve(import.meta.dirname, \"attached_assets\"),\n    },\n  },\n  root: path.resolve(import.meta.dirname, \"client\"),\n  build: {\n    outDir: path.resolve(import.meta.dirname, \"dist/public\"),\n    emptyOutDir: true,\n  },\n  server: {\n    fs: {\n      strict: true,\n      deny: [\"**/.*\"],\n    },\n  },\n});\n","path":null,"size_bytes":971,"size_tokens":null},"client/src/components/ui/scroll-area.tsx":{"content":"import * as React from \"react\"\nimport * as ScrollAreaPrimitive from \"@radix-ui/react-scroll-area\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst ScrollArea = React.forwardRef<\n  React.ElementRef<typeof ScrollAreaPrimitive.Root>,\n  React.ComponentPropsWithoutRef<typeof ScrollAreaPrimitive.Root>\n>(({ className, children, ...props }, ref) => (\n  <ScrollAreaPrimitive.Root\n    ref={ref}\n    className={cn(\"relative overflow-hidden\", className)}\n    {...props}\n  >\n    <ScrollAreaPrimitive.Viewport className=\"h-full w-full rounded-[inherit]\">\n      {children}\n    </ScrollAreaPrimitive.Viewport>\n    <ScrollBar />\n    <ScrollAreaPrimitive.Corner />\n  </ScrollAreaPrimitive.Root>\n))\nScrollArea.displayName = ScrollAreaPrimitive.Root.displayName\n\nconst ScrollBar = React.forwardRef<\n  React.ElementRef<typeof ScrollAreaPrimitive.ScrollAreaScrollbar>,\n  React.ComponentPropsWithoutRef<typeof ScrollAreaPrimitive.ScrollAreaScrollbar>\n>(({ className, orientation = \"vertical\", ...props }, ref) => (\n  <ScrollAreaPrimitive.ScrollAreaScrollbar\n    ref={ref}\n    orientation={orientation}\n    className={cn(\n      \"flex touch-none select-none transition-colors\",\n      orientation === \"vertical\" &&\n        \"h-full w-2.5 border-l border-l-transparent p-[1px]\",\n      orientation === \"horizontal\" &&\n        \"h-2.5 flex-col border-t border-t-transparent p-[1px]\",\n      className\n    )}\n    {...props}\n  >\n    <ScrollAreaPrimitive.ScrollAreaThumb className=\"relative flex-1 rounded-full bg-border\" />\n  </ScrollAreaPrimitive.ScrollAreaScrollbar>\n))\nScrollBar.displayName = ScrollAreaPrimitive.ScrollAreaScrollbar.displayName\n\nexport { ScrollArea, ScrollBar }\n","path":null,"size_bytes":1642,"size_tokens":null},"client/src/components/ui/alert.tsx":{"content":"import * as React from \"react\"\nimport { cva, type VariantProps } from \"class-variance-authority\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst alertVariants = cva(\n  \"relative w-full rounded-lg border p-4 [&>svg~*]:pl-7 [&>svg+div]:translate-y-[-3px] [&>svg]:absolute [&>svg]:left-4 [&>svg]:top-4 [&>svg]:text-foreground\",\n  {\n    variants: {\n      variant: {\n        default: \"bg-background text-foreground\",\n        destructive:\n          \"border-destructive/50 text-destructive dark:border-destructive [&>svg]:text-destructive\",\n      },\n    },\n    defaultVariants: {\n      variant: \"default\",\n    },\n  }\n)\n\nconst Alert = React.forwardRef<\n  HTMLDivElement,\n  React.HTMLAttributes<HTMLDivElement> & VariantProps<typeof alertVariants>\n>(({ className, variant, ...props }, ref) => (\n  <div\n    ref={ref}\n    role=\"alert\"\n    className={cn(alertVariants({ variant }), className)}\n    {...props}\n  />\n))\nAlert.displayName = \"Alert\"\n\nconst AlertTitle = React.forwardRef<\n  HTMLParagraphElement,\n  React.HTMLAttributes<HTMLHeadingElement>\n>(({ className, ...props }, ref) => (\n  <h5\n    ref={ref}\n    className={cn(\"mb-1 font-medium leading-none tracking-tight\", className)}\n    {...props}\n  />\n))\nAlertTitle.displayName = \"AlertTitle\"\n\nconst AlertDescription = React.forwardRef<\n  HTMLParagraphElement,\n  React.HTMLAttributes<HTMLParagraphElement>\n>(({ className, ...props }, ref) => (\n  <div\n    ref={ref}\n    className={cn(\"text-sm [&_p]:leading-relaxed\", className)}\n    {...props}\n  />\n))\nAlertDescription.displayName = \"AlertDescription\"\n\nexport { Alert, AlertTitle, AlertDescription }\n","path":null,"size_bytes":1584,"size_tokens":null},"postcss.config.js":{"content":"export default {\n  plugins: {\n    tailwindcss: {},\n    autoprefixer: {},\n  },\n}\n","path":null,"size_bytes":80,"size_tokens":null},"client/src/index.css":{"content":"@tailwind base;\n@tailwind components;\n@tailwind utilities;\n\n:root {\n  /* Force dark mode globally - dark mode only app */\n  color-scheme: dark;\n  --background: oklch(0.1822 0 0);\n  --foreground: oklch(0.9219 0 0);\n  --card: oklch(0.2264 0 0);\n  --card-foreground: oklch(0.9219 0 0);\n  --popover: oklch(0.2686 0 0);\n  --popover-foreground: oklch(0.9219 0 0);\n  --primary: #5AF5FA;\n  --primary-foreground: oklch(0.1822 0 0);\n  --secondary: oklch(0.6993 0 0);\n  --secondary-foreground: oklch(0.1822 0 0);\n  --muted: oklch(0.2686 0 0);\n  --muted-foreground: oklch(0.7155 0 0);\n  --accent: #5AF5FA;\n  --accent-foreground: oklch(0.1822 0 0);\n  --destructive: #5AF5FA;\n  --destructive-foreground: oklch(0.9761 0 0);\n  --border: oklch(0.4640 0 0);\n  --input: oklch(0.3715 0 0);\n  --ring: #5AF5FA;\n  --chart-1: #5AF5FA;\n  --chart-2: #FFA5FF;\n  --chart-3: oklch(0.7391 0.1451 290.0288);\n  --chart-4: oklch(0.9666 0.1873 111.0595);\n  --chart-5: oklch(0.8666 0.2946 142.4596);\n  --sidebar: oklch(0.1822 0 0);\n  --sidebar-foreground: oklch(0.9761 0 0);\n  --sidebar-primary: #5AF5FA;\n  --sidebar-primary-foreground: oklch(0.9761 0 0);\n  --sidebar-accent: oklch(0.5038 0.0858 196.9002);\n  --sidebar-accent-foreground: oklch(0.9761 0 0);\n  --sidebar-border: oklch(0.3715 0 0);\n  --sidebar-ring: #5AF5FA;\n  --font-sans: 'Mulish', system-ui, -apple-system, BlinkMacSystemFont, sans-serif;\n  --font-serif: 'Space Grotesk', system-ui, -apple-system, BlinkMacSystemFont, serif;\n  --font-mono: Space Mono, monospace;\n  --radius: 0.25rem;\n  --shadow-2xs: 0px 4px 8px -1px hsl(0 0% 10.1961% / 0.05);\n  --shadow-xs: 0px 4px 8px -1px hsl(0 0% 10.1961% / 0.05);\n  --shadow-sm: 0px 4px 8px -1px hsl(0 0% 10.1961% / 0.10), 0px 1px 2px -2px hsl(0 0% 10.1961% / 0.10);\n  --shadow: 0px 4px 8px -1px hsl(0 0% 10.1961% / 0.10), 0px 1px 2px -2px hsl(0 0% 10.1961% / 0.10);\n  --shadow-md: 0px 4px 8px -1px hsl(0 0% 10.1961% / 0.10), 0px 2px 4px -2px hsl(0 0% 10.1961% / 0.10);\n  --shadow-lg: 0px 4px 8px -1px hsl(0 0% 10.1961% / 0.10), 0px 4px 6px -2px hsl(0 0% 10.1961% / 0.10);\n  --shadow-xl: 0px 4px 8px -1px hsl(0 0% 10.1961% / 0.10), 0px 8px 10px -2px hsl(0 0% 10.1961% / 0.10);\n  --shadow-2xl: 0px 4px 8px -1px hsl(0 0% 10.1961% / 0.25);\n  --tracking-normal: 0.025em;\n  --spacing: 0.25rem;\n  --gainer: hsl(142, 76%, 36%);\n  --loser: hsl(0, 84%, 60%);\n  --neutral: hsl(215, 20%, 65%);\n  --brand-yellow: #FAFF50;\n}\n\n.dark {\n  --background: oklch(0.1822 0 0);\n  --foreground: oklch(0.9219 0 0);\n  --card: oklch(0.2264 0 0);\n  --card-foreground: oklch(0.9219 0 0);\n  --popover: oklch(0.2686 0 0);\n  --popover-foreground: oklch(0.9219 0 0);\n  --primary: #5AF5FA;\n  --primary-foreground: oklch(0.1822 0 0);\n  --secondary: oklch(0.6993 0 0);\n  --secondary-foreground: oklch(0.1822 0 0);\n  --muted: oklch(0.2686 0 0);\n  --muted-foreground: oklch(0.7155 0 0);\n  --accent: #5AF5FA;\n  --accent-foreground: oklch(0.1822 0 0);\n  --destructive: #5AF5FA;\n  --destructive-foreground: oklch(0.9761 0 0);\n  --border: oklch(0.4640 0 0);\n  --input: oklch(0.3715 0 0);\n  --ring: #5AF5FA;\n  --chart-1: #5AF5FA;\n  --chart-2: #FFA5FF;\n  --chart-3: oklch(0.7391 0.1451 290.0288);\n  --chart-4: oklch(0.9666 0.1873 111.0595);\n  --chart-5: oklch(0.8666 0.2946 142.4596);\n  --sidebar: oklch(0.1822 0 0);\n  --sidebar-foreground: oklch(0.9761 0 0);\n  --sidebar-primary: #5AF5FA;\n  --sidebar-primary-foreground: oklch(0.9761 0 0);\n  --sidebar-accent: oklch(0.5038 0.0858 196.9002);\n  --sidebar-accent-foreground: oklch(0.9761 0 0);\n  --sidebar-border: oklch(0.3715 0 0);\n  --sidebar-ring: #5AF5FA;\n  --font-sans: 'Mulish', system-ui, -apple-system, BlinkMacSystemFont, sans-serif;\n  --font-serif: 'Space Grotesk', system-ui, -apple-system, BlinkMacSystemFont, serif;\n  --font-mono: Space Mono, monospace;\n  --radius: 0.25rem;\n  --shadow-2xs: 0px 4px 8px -1px hsl(0 0% 10.1961% / 0.05);\n  --shadow-xs: 0px 4px 8px -1px hsl(0 0% 10.1961% / 0.05);\n  --shadow-sm: 0px 4px 8px -1px hsl(0 0% 10.1961% / 0.10), 0px 1px 2px -2px hsl(0 0% 10.1961% / 0.10);\n  --shadow: 0px 4px 8px -1px hsl(0 0% 10.1961% / 0.10), 0px 1px 2px -2px hsl(0 0% 10.1961% / 0.10);\n  --shadow-md: 0px 4px 8px -1px hsl(0 0% 10.1961% / 0.10), 0px 2px 4px -2px hsl(0 0% 10.1961% / 0.10);\n  --shadow-lg: 0px 4px 8px -1px hsl(0 0% 10.1961% / 0.10), 0px 4px 6px -2px hsl(0 0% 10.1961% / 0.10);\n  --shadow-xl: 0px 4px 8px -1px hsl(0 0% 10.1961% / 0.10), 0px 8px 10px -2px hsl(0 0% 10.1961% / 0.10);\n  --shadow-2xl: 0px 4px 8px -1px hsl(0 0% 10.1961% / 0.25);\n  --gainer: hsl(142, 76%, 36%);\n  --loser: hsl(0, 84%, 60%);\n  --neutral: hsl(215, 20%, 65%);\n  --brand-yellow: #FAFF50;\n}\n\n@theme inline {\n  --color-background: var(--background);\n  --color-foreground: var(--foreground);\n  --color-card: var(--card);\n  --color-card-foreground: var(--card-foreground);\n  --color-popover: var(--popover);\n  --color-popover-foreground: var(--popover-foreground);\n  --color-primary: var(--primary);\n  --color-primary-foreground: var(--primary-foreground);\n  --color-secondary: var(--secondary);\n  --color-secondary-foreground: var(--secondary-foreground);\n  --color-muted: var(--muted);\n  --color-muted-foreground: var(--muted-foreground);\n  --color-accent: var(--accent);\n  --color-accent-foreground: var(--accent-foreground);\n  --color-destructive: var(--destructive);\n  --color-destructive-foreground: var(--destructive-foreground);\n  --color-border: var(--border);\n  --color-input: var(--input);\n  --color-ring: var(--ring);\n  --color-chart-1: var(--chart-1);\n  --color-chart-2: var(--chart-2);\n  --color-chart-3: var(--chart-3);\n  --color-chart-4: var(--chart-4);\n  --color-chart-5: var(--chart-5);\n  --color-sidebar: var(--sidebar);\n  --color-sidebar-foreground: var(--sidebar-foreground);\n  --color-sidebar-primary: var(--sidebar-primary);\n  --color-sidebar-primary-foreground: var(--sidebar-primary-foreground);\n  --color-sidebar-accent: var(--sidebar-accent);\n  --color-sidebar-accent-foreground: var(--sidebar-accent-foreground);\n  --color-sidebar-border: var(--sidebar-border);\n  --color-sidebar-ring: var(--sidebar-ring);\n\n  --font-sans: var(--font-sans);\n  --font-mono: var(--font-mono);\n  --font-serif: var(--font-serif);\n\n  --radius-sm: calc(var(--radius) - 4px);\n  --radius-md: calc(var(--radius) - 2px);\n  --radius-lg: var(--radius);\n  --radius-xl: calc(var(--radius) + 4px);\n\n  --shadow-2xs: var(--shadow-2xs);\n  --shadow-xs: var(--shadow-xs);\n  --shadow-sm: var(--shadow-sm);\n  --shadow: var(--shadow);\n  --shadow-md: var(--shadow-md);\n  --shadow-lg: var(--shadow-lg);\n  --shadow-xl: var(--shadow-xl);\n  --shadow-2xl: var(--shadow-2xl);\n\n  --tracking-tighter: calc(var(--tracking-normal) - 0.05em);\n  --tracking-tight: calc(var(--tracking-normal) - 0.025em);\n  --tracking-normal: var(--tracking-normal);\n  --tracking-wide: calc(var(--tracking-normal) + 0.025em);\n  --tracking-wider: calc(var(--tracking-normal) + 0.05em);\n  --tracking-widest: calc(var(--tracking-normal) + 0.1em);\n}\n\n@layer base {\n  * {\n    @apply border-border;\n  }\n\n  body {\n    @apply font-sans antialiased bg-background text-foreground;\n    font-family: 'Mulish', system-ui, sans-serif;\n    font-weight: 400; /* Mulish Regular */\n    letter-spacing: var(--tracking-normal);\n    overflow-x: hidden;\n    width: 100%;\n  }\n  \n  html {\n    overflow-x: hidden;\n    width: 100%;\n  }\n  \n  #root {\n    overflow-x: hidden;\n    width: 100%;\n  }\n\n  /* Ensure all text elements use Mulish */\n  p, span, div, a, button, input, textarea, label, li, td, th, small, code {\n    font-family: 'Mulish', system-ui, sans-serif;\n  }\n\n  /* Font weight utilities for Mulish */\n  .font-light {\n    font-weight: 300; /* Mulish Light */\n  }\n\n  .font-normal {\n    font-weight: 400; /* Mulish Regular */\n  }\n\n  .font-bold {\n    font-weight: 700; /* Mulish Bold */\n  }\n\n  /* Tooltip styling with Mulish */\n  [role=\"tooltip\"], \n  .tooltip {\n    font-family: 'Mulish', system-ui, sans-serif !important;\n    font-weight: 400;\n  }\n\n  /* H1, H2 use Space Grotesk Light only */\n  h1, h2 {\n    font-family: 'Space Grotesk', system-ui, sans-serif;\n    font-weight: 300; /* Light */\n  }\n\n  /* H3, H4, H5, H6 use Mulish */\n  h3, h4, h5, h6 {\n    font-family: 'Mulish', system-ui, sans-serif;\n    font-weight: 400; /* Regular */\n  }\n}\n\n@layer utilities {\n  .text-gainer {\n    color: hsl(var(--gainer));\n  }\n  .text-loser {\n    color: hsl(var(--loser));\n  }\n  .text-neutral {\n    color: hsl(var(--neutral));\n  }\n  .bg-gainer {\n    background-color: hsl(var(--gainer));\n  }\n  .bg-loser {\n    background-color: hsl(var(--loser));\n  }\n  .bg-gainer\\/10 {\n    background-color: hsl(var(--gainer) / 0.1);\n  }\n  .bg-loser\\/10 {\n    background-color: hsl(var(--loser) / 0.1);\n  }\n}\n\n/* Calendar customizations */\n@layer components {\n  /* Style today's date with outline instead of solid background */\n  .rdp-day_button[aria-current=\"date\"] {\n    background-color: transparent !important;\n    border: 2px solid #5AF5FA !important;\n    color: var(--foreground) !important;\n    font-weight: 500;\n  }\n  \n  /* Light theme today's date */\n  :root .rdp-day_button[aria-current=\"date\"] {\n    border-color: #059691 !important;\n  }\n  \n  /* Dark theme today's date */\n  .dark .rdp-day_button[aria-current=\"date\"] {\n    border-color: #5AF5FA !important;\n  }\n  \n  /* Hover state for today's date */\n  .rdp-day_button[aria-current=\"date\"]:hover {\n    background-color: rgba(90, 245, 250, 0.1) !important;\n  }\n  \n  /* Selected date styling (keep distinct from today) */\n  .rdp-day_button[aria-selected=\"true\"]:not([aria-current=\"date\"]) {\n    background-color: #5AF5FA !important;\n    color: black !important;\n  }\n  \n  /* When today is also selected */\n  .rdp-day_button[aria-selected=\"true\"][aria-current=\"date\"] {\n    background-color: #5AF5FA !important;\n    color: black !important;\n    border-color: #5AF5FA !important;\n  }\n  \n  /* Make volume chart Y-axis line full height */\n  .volume-chart-container .recharts-cartesian-axis-line {\n    height: 100% !important;\n  }\n\n  /* Index tag styling - Brand yellow with 30% opacity background, 100% text */\n  .index-tag {\n    background-color: rgba(250, 255, 80, 0.3) !important; /* #FAFF50 at 30% opacity */\n    color: #FAFF50 !important; /* 100% brand yellow text */\n    border: 1px solid rgba(250, 255, 80, 0.5) !important; /* Subtle yellow border */\n  }\n\n  /* Index tag hover effect */\n  .index-tag:hover {\n    background-color: rgba(250, 255, 80, 0.4) !important; /* Slightly more opaque on hover */\n  }\n\n  /* Annotation mode cursors - override Recharts default cursor behavior */\n  .annotation-vertical-mode,\n  .annotation-vertical-mode * {\n    cursor: url(\"data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='20' height='20' viewBox='0 0 20 20'%3E%3Cpath d='M10 4L10 16M4 10L16 10' stroke='%23FAFF50' stroke-width='2'/%3E%3C/svg%3E\") 10 10, crosshair !important;\n  }\n\n  .annotation-measure-mode,\n  .annotation-measure-mode * {\n    cursor: url(\"data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='20' height='20' viewBox='0 0 20 20'%3E%3Cpath d='M10 4L10 16M4 10L16 10' stroke='%2322C55E' stroke-width='2'/%3E%3C/svg%3E\") 10 10, crosshair !important;\n  }\n\n  .annotation-horizontal-mode,\n  .annotation-horizontal-mode * {\n    cursor: url(\"data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='20' height='20' viewBox='0 0 20 20'%3E%3Cpath d='M10 4L10 16M4 10L16 10' stroke='%23AA99FF' stroke-width='2'/%3E%3C/svg%3E\") 10 10, crosshair !important;\n  }\n\n  .annotation-note-mode,\n  .annotation-note-mode * {\n    cursor: url(\"data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='20' height='20' viewBox='0 0 20 20'%3E%3Cpath d='M10 4L10 16M4 10L16 10' stroke='%23FFFFFF' stroke-width='2'/%3E%3C/svg%3E\") 10 10, crosshair !important;\n  }\n\n  /* Walkthrough card hover effect with gradient border */\n  .walkthrough-card {\n    position: relative;\n  }\n\n  .walkthrough-card::before {\n    content: '';\n    position: absolute;\n    inset: -1px;\n    border-radius: 0.5rem;\n    padding: 1px;\n    background: linear-gradient(to right, #5AF5FA, #FFA5FF);\n    -webkit-mask: linear-gradient(#fff 0 0) content-box, linear-gradient(#fff 0 0);\n    -webkit-mask-composite: xor;\n    mask-composite: exclude;\n    opacity: 0;\n    transition: opacity 0.2s ease-in-out;\n    pointer-events: none;\n  }\n\n  .walkthrough-card:hover::before {\n    opacity: 1;\n  }\n}\n","path":null,"size_bytes":12254,"size_tokens":null},"client/src/components/ui/radio-group.tsx":{"content":"import * as React from \"react\"\nimport * as RadioGroupPrimitive from \"@radix-ui/react-radio-group\"\nimport { Circle } from \"lucide-react\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst RadioGroup = React.forwardRef<\n  React.ElementRef<typeof RadioGroupPrimitive.Root>,\n  React.ComponentPropsWithoutRef<typeof RadioGroupPrimitive.Root>\n>(({ className, ...props }, ref) => {\n  return (\n    <RadioGroupPrimitive.Root\n      className={cn(\"grid gap-2\", className)}\n      {...props}\n      ref={ref}\n    />\n  )\n})\nRadioGroup.displayName = RadioGroupPrimitive.Root.displayName\n\nconst RadioGroupItem = React.forwardRef<\n  React.ElementRef<typeof RadioGroupPrimitive.Item>,\n  React.ComponentPropsWithoutRef<typeof RadioGroupPrimitive.Item>\n>(({ className, ...props }, ref) => {\n  return (\n    <RadioGroupPrimitive.Item\n      ref={ref}\n      className={cn(\n        \"aspect-square h-4 w-4 rounded-full border border-primary text-primary ring-offset-background focus:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:cursor-not-allowed disabled:opacity-50\",\n        className\n      )}\n      {...props}\n    >\n      <RadioGroupPrimitive.Indicator className=\"flex items-center justify-center\">\n        <Circle className=\"h-2.5 w-2.5 fill-current text-current\" />\n      </RadioGroupPrimitive.Indicator>\n    </RadioGroupPrimitive.Item>\n  )\n})\nRadioGroupItem.displayName = RadioGroupPrimitive.Item.displayName\n\nexport { RadioGroup, RadioGroupItem }\n","path":null,"size_bytes":1467,"size_tokens":null},"client/src/hooks/use-mobile.tsx":{"content":"import * as React from \"react\"\n\nconst MOBILE_BREAKPOINT = 768\n\nexport function useIsMobile() {\n  const [isMobile, setIsMobile] = React.useState<boolean | undefined>(undefined)\n\n  React.useEffect(() => {\n    const mql = window.matchMedia(`(max-width: ${MOBILE_BREAKPOINT - 1}px)`)\n    const onChange = () => {\n      setIsMobile(window.innerWidth < MOBILE_BREAKPOINT)\n    }\n    mql.addEventListener(\"change\", onChange)\n    setIsMobile(window.innerWidth < MOBILE_BREAKPOINT)\n    return () => mql.removeEventListener(\"change\", onChange)\n  }, [])\n\n  return !!isMobile\n}\n","path":null,"size_bytes":565,"size_tokens":null},"client/src/hooks/use-toast.ts":{"content":"import * as React from \"react\"\n\nimport type {\n  ToastActionElement,\n  ToastProps,\n} from \"@/components/ui/toast\"\n\nconst TOAST_LIMIT = 1\nconst TOAST_REMOVE_DELAY = 1000000\n\ntype ToasterToast = ToastProps & {\n  id: string\n  title?: React.ReactNode\n  description?: React.ReactNode\n  action?: ToastActionElement\n}\n\nconst actionTypes = {\n  ADD_TOAST: \"ADD_TOAST\",\n  UPDATE_TOAST: \"UPDATE_TOAST\",\n  DISMISS_TOAST: \"DISMISS_TOAST\",\n  REMOVE_TOAST: \"REMOVE_TOAST\",\n} as const\n\nlet count = 0\n\nfunction genId() {\n  count = (count + 1) % Number.MAX_SAFE_INTEGER\n  return count.toString()\n}\n\ntype ActionType = typeof actionTypes\n\ntype Action =\n  | {\n      type: ActionType[\"ADD_TOAST\"]\n      toast: ToasterToast\n    }\n  | {\n      type: ActionType[\"UPDATE_TOAST\"]\n      toast: Partial<ToasterToast>\n    }\n  | {\n      type: ActionType[\"DISMISS_TOAST\"]\n      toastId?: ToasterToast[\"id\"]\n    }\n  | {\n      type: ActionType[\"REMOVE_TOAST\"]\n      toastId?: ToasterToast[\"id\"]\n    }\n\ninterface State {\n  toasts: ToasterToast[]\n}\n\nconst toastTimeouts = new Map<string, ReturnType<typeof setTimeout>>()\n\nconst addToRemoveQueue = (toastId: string) => {\n  if (toastTimeouts.has(toastId)) {\n    return\n  }\n\n  const timeout = setTimeout(() => {\n    toastTimeouts.delete(toastId)\n    dispatch({\n      type: \"REMOVE_TOAST\",\n      toastId: toastId,\n    })\n  }, TOAST_REMOVE_DELAY)\n\n  toastTimeouts.set(toastId, timeout)\n}\n\nexport const reducer = (state: State, action: Action): State => {\n  switch (action.type) {\n    case \"ADD_TOAST\":\n      return {\n        ...state,\n        toasts: [action.toast, ...state.toasts].slice(0, TOAST_LIMIT),\n      }\n\n    case \"UPDATE_TOAST\":\n      return {\n        ...state,\n        toasts: state.toasts.map((t) =>\n          t.id === action.toast.id ? { ...t, ...action.toast } : t\n        ),\n      }\n\n    case \"DISMISS_TOAST\": {\n      const { toastId } = action\n\n      // ! Side effects ! - This could be extracted into a dismissToast() action,\n      // but I'll keep it here for simplicity\n      if (toastId) {\n        addToRemoveQueue(toastId)\n      } else {\n        state.toasts.forEach((toast) => {\n          addToRemoveQueue(toast.id)\n        })\n      }\n\n      return {\n        ...state,\n        toasts: state.toasts.map((t) =>\n          t.id === toastId || toastId === undefined\n            ? {\n                ...t,\n                open: false,\n              }\n            : t\n        ),\n      }\n    }\n    case \"REMOVE_TOAST\":\n      if (action.toastId === undefined) {\n        return {\n          ...state,\n          toasts: [],\n        }\n      }\n      return {\n        ...state,\n        toasts: state.toasts.filter((t) => t.id !== action.toastId),\n      }\n  }\n}\n\nconst listeners: Array<(state: State) => void> = []\n\nlet memoryState: State = { toasts: [] }\n\nfunction dispatch(action: Action) {\n  memoryState = reducer(memoryState, action)\n  listeners.forEach((listener) => {\n    listener(memoryState)\n  })\n}\n\ntype Toast = Omit<ToasterToast, \"id\">\n\nfunction toast({ ...props }: Toast) {\n  const id = genId()\n\n  const update = (props: ToasterToast) =>\n    dispatch({\n      type: \"UPDATE_TOAST\",\n      toast: { ...props, id },\n    })\n  const dismiss = () => dispatch({ type: \"DISMISS_TOAST\", toastId: id })\n\n  dispatch({\n    type: \"ADD_TOAST\",\n    toast: {\n      ...props,\n      id,\n      open: true,\n      onOpenChange: (open) => {\n        if (!open) dismiss()\n      },\n    },\n  })\n\n  return {\n    id: id,\n    dismiss,\n    update,\n  }\n}\n\nfunction useToast() {\n  const [state, setState] = React.useState<State>(memoryState)\n\n  React.useEffect(() => {\n    listeners.push(setState)\n    return () => {\n      const index = listeners.indexOf(setState)\n      if (index > -1) {\n        listeners.splice(index, 1)\n      }\n    }\n  }, [state])\n\n  return {\n    ...state,\n    toast,\n    dismiss: (toastId?: string) => dispatch({ type: \"DISMISS_TOAST\", toastId }),\n  }\n}\n\nexport { useToast, toast }\n","path":null,"size_bytes":3895,"size_tokens":null},"client/src/components/ui/calendar.tsx":{"content":"import * as React from \"react\"\nimport { ChevronLeft, ChevronRight } from \"lucide-react\"\nimport { DayPicker } from \"react-day-picker\"\n\nimport { cn } from \"@/lib/utils\"\nimport { buttonVariants } from \"@/components/ui/button\"\nimport { CalendarCaption } from \"./calendar-caption\"\n\nexport type CalendarProps = React.ComponentProps<typeof DayPicker> & {\n  enableYearDropdown?: boolean\n  fromYear?: number\n  toYear?: number\n}\n\nfunction Calendar({\n  className,\n  classNames,\n  showOutsideDays = true,\n  enableYearDropdown = false,\n  fromYear,\n  toYear,\n  ...props\n}: CalendarProps) {\n  return (\n    <DayPicker\n      showOutsideDays={showOutsideDays}\n      className={cn(\"p-3\", className)}\n      classNames={{\n        months: \"flex flex-col sm:flex-row space-y-4 sm:space-x-4 sm:space-y-0\",\n        month: \"space-y-4\",\n        caption: \"flex justify-center pt-1 relative items-center\",\n        caption_label: \"text-sm font-medium\",\n        nav: \"space-x-1 flex items-center\",\n        nav_button: cn(\n          buttonVariants({ variant: \"outline\" }),\n          \"h-7 w-7 bg-transparent p-0 opacity-50 hover:opacity-100\"\n        ),\n        nav_button_previous: \"absolute left-1\",\n        nav_button_next: \"absolute right-1\",\n        table: \"w-full border-collapse space-y-1\",\n        head_row: \"flex\",\n        head_cell:\n          \"text-muted-foreground rounded-md w-9 font-normal text-[0.8rem]\",\n        row: \"flex w-full mt-2\",\n        cell: \"h-9 w-9 text-center text-sm p-0 relative [&:has([aria-selected].day-range-end)]:rounded-r-md [&:has([aria-selected].day-outside)]:bg-accent/50 [&:has([aria-selected])]:bg-accent first:[&:has([aria-selected])]:rounded-l-md last:[&:has([aria-selected])]:rounded-r-md focus-within:relative focus-within:z-20\",\n        day: cn(\n          buttonVariants({ variant: \"ghost\" }),\n          \"h-9 w-9 p-0 font-normal aria-selected:opacity-100\"\n        ),\n        day_range_end: \"day-range-end\",\n        day_selected:\n          \"bg-primary text-primary-foreground hover:bg-primary hover:text-primary-foreground focus:bg-primary focus:text-primary-foreground\",\n        day_today: \"bg-accent text-accent-foreground\",\n        day_outside:\n          \"day-outside text-muted-foreground aria-selected:bg-accent/50 aria-selected:text-muted-foreground\",\n        day_disabled: \"text-muted-foreground opacity-50\",\n        day_range_middle:\n          \"aria-selected:bg-accent aria-selected:text-accent-foreground\",\n        day_hidden: \"invisible\",\n        ...classNames,\n      }}\n      components={{\n        IconLeft: ({ className, ...props }) => (\n          <ChevronLeft className={cn(\"h-4 w-4\", className)} {...props} />\n        ),\n        IconRight: ({ className, ...props }) => (\n          <ChevronRight className={cn(\"h-4 w-4\", className)} {...props} />\n        ),\n        ...(enableYearDropdown && {\n          Caption: ({ displayMonth }) => (\n            <CalendarCaption\n              displayMonth={displayMonth}\n              fromYear={fromYear}\n              toYear={toYear}\n            />\n          ),\n        }),\n      }}\n      {...props}\n    />\n  )\n}\nCalendar.displayName = \"Calendar\"\n\nexport { Calendar }\n","path":null,"size_bytes":3129,"size_tokens":null},"client/src/components/ui/drawer.tsx":{"content":"\"use client\"\n\nimport * as React from \"react\"\nimport { Drawer as DrawerPrimitive } from \"vaul\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst Drawer = ({\n  shouldScaleBackground = true,\n  ...props\n}: React.ComponentProps<typeof DrawerPrimitive.Root>) => (\n  <DrawerPrimitive.Root\n    shouldScaleBackground={shouldScaleBackground}\n    {...props}\n  />\n)\nDrawer.displayName = \"Drawer\"\n\nconst DrawerTrigger = DrawerPrimitive.Trigger\n\nconst DrawerPortal = DrawerPrimitive.Portal\n\nconst DrawerClose = DrawerPrimitive.Close\n\nconst DrawerOverlay = React.forwardRef<\n  React.ElementRef<typeof DrawerPrimitive.Overlay>,\n  React.ComponentPropsWithoutRef<typeof DrawerPrimitive.Overlay>\n>(({ className, ...props }, ref) => (\n  <DrawerPrimitive.Overlay\n    ref={ref}\n    className={cn(\"fixed inset-0 z-50 bg-black/80\", className)}\n    {...props}\n  />\n))\nDrawerOverlay.displayName = DrawerPrimitive.Overlay.displayName\n\nconst DrawerContent = React.forwardRef<\n  React.ElementRef<typeof DrawerPrimitive.Content>,\n  React.ComponentPropsWithoutRef<typeof DrawerPrimitive.Content>\n>(({ className, children, ...props }, ref) => (\n  <DrawerPortal>\n    <DrawerOverlay />\n    <DrawerPrimitive.Content\n      ref={ref}\n      className={cn(\n        \"fixed inset-x-0 bottom-0 z-50 mt-24 flex h-auto flex-col rounded-t-[10px] border bg-background\",\n        className\n      )}\n      {...props}\n    >\n      <div className=\"mx-auto mt-4 h-2 w-[100px] rounded-full bg-muted\" />\n      {children}\n    </DrawerPrimitive.Content>\n  </DrawerPortal>\n))\nDrawerContent.displayName = \"DrawerContent\"\n\nconst DrawerHeader = ({\n  className,\n  ...props\n}: React.HTMLAttributes<HTMLDivElement>) => (\n  <div\n    className={cn(\"grid gap-1.5 p-4 text-center sm:text-left\", className)}\n    {...props}\n  />\n)\nDrawerHeader.displayName = \"DrawerHeader\"\n\nconst DrawerFooter = ({\n  className,\n  ...props\n}: React.HTMLAttributes<HTMLDivElement>) => (\n  <div\n    className={cn(\"mt-auto flex flex-col gap-2 p-4\", className)}\n    {...props}\n  />\n)\nDrawerFooter.displayName = \"DrawerFooter\"\n\nconst DrawerTitle = React.forwardRef<\n  React.ElementRef<typeof DrawerPrimitive.Title>,\n  React.ComponentPropsWithoutRef<typeof DrawerPrimitive.Title>\n>(({ className, ...props }, ref) => (\n  <DrawerPrimitive.Title\n    ref={ref}\n    className={cn(\n      \"text-lg font-semibold leading-none tracking-tight\",\n      className\n    )}\n    {...props}\n  />\n))\nDrawerTitle.displayName = DrawerPrimitive.Title.displayName\n\nconst DrawerDescription = React.forwardRef<\n  React.ElementRef<typeof DrawerPrimitive.Description>,\n  React.ComponentPropsWithoutRef<typeof DrawerPrimitive.Description>\n>(({ className, ...props }, ref) => (\n  <DrawerPrimitive.Description\n    ref={ref}\n    className={cn(\"text-sm text-muted-foreground\", className)}\n    {...props}\n  />\n))\nDrawerDescription.displayName = DrawerPrimitive.Description.displayName\n\nexport {\n  Drawer,\n  DrawerPortal,\n  DrawerOverlay,\n  DrawerTrigger,\n  DrawerClose,\n  DrawerContent,\n  DrawerHeader,\n  DrawerFooter,\n  DrawerTitle,\n  DrawerDescription,\n}\n","path":null,"size_bytes":3021,"size_tokens":null},"client/src/components/ui/slider.tsx":{"content":"import * as React from \"react\"\nimport * as SliderPrimitive from \"@radix-ui/react-slider\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst Slider = React.forwardRef<\n  React.ElementRef<typeof SliderPrimitive.Root>,\n  React.ComponentPropsWithoutRef<typeof SliderPrimitive.Root>\n>(({ className, ...props }, ref) => (\n  <SliderPrimitive.Root\n    ref={ref}\n    className={cn(\n      \"relative flex w-full touch-none select-none items-center\",\n      className\n    )}\n    {...props}\n  >\n    <SliderPrimitive.Track className=\"relative h-2 w-full grow overflow-hidden rounded-full bg-secondary\">\n      <SliderPrimitive.Range className=\"absolute h-full bg-primary\" />\n    </SliderPrimitive.Track>\n    <SliderPrimitive.Thumb className=\"block h-5 w-5 rounded-full border-2 border-primary bg-background ring-offset-background transition-colors focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:pointer-events-none disabled:opacity-50\" />\n  </SliderPrimitive.Root>\n))\nSlider.displayName = SliderPrimitive.Root.displayName\n\nexport { Slider }\n","path":null,"size_bytes":1077,"size_tokens":null},"client/src/components/ui/switch.tsx":{"content":"import * as React from \"react\"\nimport * as SwitchPrimitives from \"@radix-ui/react-switch\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst Switch = React.forwardRef<\n  React.ElementRef<typeof SwitchPrimitives.Root>,\n  React.ComponentPropsWithoutRef<typeof SwitchPrimitives.Root>\n>(({ className, ...props }, ref) => (\n  <SwitchPrimitives.Root\n    className={cn(\n      \"peer inline-flex h-6 w-11 shrink-0 cursor-pointer items-center rounded-full border-2 border-transparent transition-colors focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 focus-visible:ring-offset-background disabled:cursor-not-allowed disabled:opacity-50 data-[state=checked]:bg-primary data-[state=unchecked]:bg-input\",\n      className\n    )}\n    {...props}\n    ref={ref}\n  >\n    <SwitchPrimitives.Thumb\n      className={cn(\n        \"pointer-events-none block h-5 w-5 rounded-full bg-background shadow-lg ring-0 transition-transform data-[state=checked]:translate-x-5 data-[state=unchecked]:translate-x-0\"\n      )}\n    />\n  </SwitchPrimitives.Root>\n))\nSwitch.displayName = SwitchPrimitives.Root.displayName\n\nexport { Switch }\n","path":null,"size_bytes":1139,"size_tokens":null},"server/utils/suffixMappings.ts":{"content":"// Server-side suffix mappings for universal exchange and currency detection\n// This mirrors the client-side suffix-mappings.ts for consistent exchange data\n\ninterface SuffixInfo {\n  suffix: string;\n  country: string;\n  exchange: string;\n  fullExchangeName: string;\n  currency?: string;\n  notes?: string;\n}\n\n// Comprehensive suffix mappings from Bloomberg-style ticker suffixes\nexport const suffixMappings: Record<string, SuffixInfo> = {\n  // United States\n  \".UW\": {\n    suffix: \".UW\",\n    country: \"United States\",\n    exchange: \"NASDAQ Global Select Market\",\n    fullExchangeName: \"NASDAQ Global Select Market\",\n    currency: \"USD\"\n  },\n  \".UF\": {\n    suffix: \".UF\",\n    country: \"United States\",\n    exchange: \"NASDAQ Global Market\",\n    fullExchangeName: \"NASDAQ Global Market\",\n    currency: \"USD\"\n  },\n  \".UQ\": {\n    suffix: \".UQ\",\n    country: \"United States\", \n    exchange: \"NASDAQ Capital Market\",\n    fullExchangeName: \"NASDAQ Capital Market\",\n    currency: \"USD\"\n  },\n  \".UN\": {\n    suffix: \".UN\",\n    country: \"United States\",\n    exchange: \"NYSE\",\n    fullExchangeName: \"New York Stock Exchange\",\n    currency: \"USD\"\n  },\n\n  // Europe\n  \".SE\": {\n    suffix: \".SE\",\n    country: \"Sweden\",\n    exchange: \"OMX Stockholm\",\n    fullExchangeName: \"Nasdaq Stockholm (OMX Stockholm)\",\n    currency: \"SEK\"\n  },\n  \".MC\": {\n    suffix: \".MC\",\n    country: \"Spain\", \n    exchange: \"BME\",\n    fullExchangeName: \"Bolsas y Mercados Espaoles (Madrid Stock Exchange)\",\n    currency: \"EUR\"\n  },\n  \".PA\": {\n    suffix: \".PA\",\n    country: \"France\",\n    exchange: \"Euronext Paris\",\n    fullExchangeName: \"Euronext Paris\",\n    currency: \"EUR\"\n  },\n  \".DE\": {\n    suffix: \".DE\",\n    country: \"Germany\",\n    exchange: \"XETRA\",\n    fullExchangeName: \"Deutsche Brse XETRA\",\n    currency: \"EUR\"\n  },\n  \".L\": {\n    suffix: \".L\",\n    country: \"United Kingdom\",\n    exchange: \"LSE\",\n    fullExchangeName: \"London Stock Exchange\",\n    currency: \"GBP\"\n  },\n  \".AS\": {\n    suffix: \".AS\",\n    country: \"Netherlands\",\n    exchange: \"Euronext Amsterdam\", \n    fullExchangeName: \"Euronext Amsterdam\",\n    currency: \"EUR\"\n  },\n  \".SW\": {\n    suffix: \".SW\",\n    country: \"Switzerland\",\n    exchange: \"SIX\",\n    fullExchangeName: \"SIX Swiss Exchange\",\n    currency: \"CHF\"\n  },\n  \".MI\": {\n    suffix: \".MI\",\n    country: \"Italy\",\n    exchange: \"Borsa Italiana\",\n    fullExchangeName: \"Borsa Italiana (Milan Stock Exchange)\",\n    currency: \"EUR\"\n  },\n\n  // Asia Pacific\n  \".T\": {\n    suffix: \".T\",\n    country: \"Japan\",\n    exchange: \"TSE\",\n    fullExchangeName: \"Tokyo Stock Exchange\",\n    currency: \"JPY\"\n  },\n  \".HK\": {\n    suffix: \".HK\",\n    country: \"Hong Kong\",\n    exchange: \"HKEX\",\n    fullExchangeName: \"Hong Kong Stock Exchange\",\n    currency: \"HKD\"\n  },\n  \".AX\": {\n    suffix: \".AX\", \n    country: \"Australia\",\n    exchange: \"ASX\",\n    fullExchangeName: \"Australian Securities Exchange\",\n    currency: \"AUD\"\n  },\n\n  // Canada\n  \".TO\": {\n    suffix: \".TO\",\n    country: \"Canada\",\n    exchange: \"TSX\",\n    fullExchangeName: \"Toronto Stock Exchange\",\n    currency: \"CAD\"\n  },\n  \".V\": {\n    suffix: \".V\",\n    country: \"Canada\",\n    exchange: \"TSXV\",\n    fullExchangeName: \"TSX Venture Exchange\",\n    currency: \"CAD\"\n  },\n\n  // Additional European exchanges commonly used\n  \".F\": {\n    suffix: \".F\",\n    country: \"Germany\",\n    exchange: \"Frankfurt\",\n    fullExchangeName: \"Frankfurt Stock Exchange\",\n    currency: \"EUR\"\n  },\n  \".BE\": {\n    suffix: \".BE\",\n    country: \"Germany\",\n    exchange: \"Berlin\",\n    fullExchangeName: \"Berlin Stock Exchange\",\n    currency: \"EUR\"\n  },\n  \".DU\": {\n    suffix: \".DU\",\n    country: \"Germany\",\n    exchange: \"Dusseldorf\",\n    fullExchangeName: \"Dusseldorf Stock Exchange\",\n    currency: \"EUR\"\n  },\n\n  // Latin America\n  \".MX\": {\n    suffix: \".MX\",\n    country: \"Mexico\",\n    exchange: \"BMV\",\n    fullExchangeName: \"Bolsa Mexicana de Valores (Mexican Stock Exchange)\",\n    currency: \"MXN\",\n    notes: \"Mexican stocks listed on the Mexican Stock Exchange's Global Market\"\n  },\n  \".SA\": {\n    suffix: \".SA\",\n    country: \"Brazil\",\n    exchange: \"B3\",\n    fullExchangeName: \"B3 - Brasil Bolsa Balco\",\n    currency: \"BRL\",\n    notes: \"Brazilian stocks listed on B3\"\n  },\n\n  // Additional Asia Pacific\n  \".SI\": {\n    suffix: \".SI\",\n    country: \"Singapore\",\n    exchange: \"SGX\",\n    fullExchangeName: \"Singapore Exchange\",\n    currency: \"SGD\",\n    notes: \"Singapore stocks listed on SGX\"\n  },\n  \".NZ\": {\n    suffix: \".NZ\",\n    country: \"New Zealand\",\n    exchange: \"NZX\",\n    fullExchangeName: \"New Zealand Exchange\",\n    currency: \"NZD\",\n    notes: \"New Zealand stocks listed on NZX\"\n  },\n  \".TW\": {\n    suffix: \".TW\",\n    country: \"Taiwan\",\n    exchange: \"TWSE\",\n    fullExchangeName: \"Taiwan Stock Exchange\",\n    currency: \"TWD\",\n    notes: \"Taiwanese stocks listed on TWSE\"\n  },\n  \".KL\": {\n    suffix: \".KL\",\n    country: \"Malaysia\",\n    exchange: \"Bursa Malaysia\",\n    fullExchangeName: \"Bursa Malaysia\",\n    currency: \"MYR\",\n    notes: \"Malaysian stocks listed on Bursa Malaysia\"\n  },\n  \".JK\": {\n    suffix: \".JK\",\n    country: \"Indonesia\",\n    exchange: \"IDX\",\n    fullExchangeName: \"Indonesia Stock Exchange\",\n    currency: \"IDR\",\n    notes: \"Indonesian stocks listed on IDX\"\n  },\n  \".BK\": {\n    suffix: \".BK\",\n    country: \"Thailand\",\n    exchange: \"SET\",\n    fullExchangeName: \"Stock Exchange of Thailand\",\n    currency: \"THB\",\n    notes: \"Thai stocks listed on SET\"\n  },\n\n  // Middle East\n  \".TA\": {\n    suffix: \".TA\",\n    country: \"Israel\",\n    exchange: \"TASE\",\n    fullExchangeName: \"Tel Aviv Stock Exchange\",\n    currency: \"ILS\",\n    notes: \"Israeli stocks listed on TASE\"\n  },\n\n  // Additional Europe\n  \".VI\": {\n    suffix: \".VI\",\n    country: \"Austria\",\n    exchange: \"Vienna\",\n    fullExchangeName: \"Vienna Stock Exchange\",\n    currency: \"EUR\",\n    notes: \"Austrian stocks listed on Vienna Stock Exchange\"\n  },\n  \".IR\": {\n    suffix: \".IR\",\n    country: \"Ireland\",\n    exchange: \"Euronext Dublin\",\n    fullExchangeName: \"Euronext Dublin\",\n    currency: \"EUR\",\n    notes: \"Irish stocks listed on Euronext Dublin\"\n  },\n  \".WA\": {\n    suffix: \".WA\",\n    country: \"Poland\",\n    exchange: \"WSE\",\n    fullExchangeName: \"Warsaw Stock Exchange\",\n    currency: \"PLN\",\n    notes: \"Polish stocks listed on WSE\"\n  },\n  \".LS\": {\n    suffix: \".LS\",\n    country: \"Portugal\",\n    exchange: \"Euronext Lisbon\",\n    fullExchangeName: \"Euronext Lisbon\",\n    currency: \"EUR\",\n    notes: \"Portuguese stocks listed on Euronext Lisbon\"\n  },\n  \".AT\": {\n    suffix: \".AT\",\n    country: \"Greece\",\n    exchange: \"ATHEX\",\n    fullExchangeName: \"Athens Stock Exchange\",\n    currency: \"EUR\",\n    notes: \"Greek stocks listed on ATHEX\"\n  },\n  \".IS\": {\n    suffix: \".IS\",\n    country: \"Iceland\",\n    exchange: \"Nasdaq Iceland\",\n    fullExchangeName: \"Nasdaq Iceland\",\n    currency: \"ISK\",\n    notes: \"Icelandic stocks listed on Nasdaq Iceland\"\n  },\n  \".PR\": {\n    suffix: \".PR\",\n    country: \"Czech Republic\",\n    exchange: \"Prague Stock Exchange\",\n    fullExchangeName: \"Prague Stock Exchange\",\n    currency: \"CZK\",\n    notes: \"Czech stocks listed on Prague Stock Exchange\"\n  },\n\n  // Additional Global Markets (from Bloomberg exchange data)\n  \".AB\": {\n    suffix: \".AB\",\n    country: \"Saudi Arabia\",\n    exchange: \"Saudi Stock Exchange\",\n    fullExchangeName: \"Saudi Stock Exchange (Tadawul)\",\n    currency: \"SAR\"\n  },\n  \".BD\": {\n    suffix: \".BD\",\n    country: \"Bangladesh\",\n    exchange: \"Dhaka Stock Exchange\",\n    fullExchangeName: \"Dhaka Stock Exchange\",\n    currency: \"BDT\"\n  },\n  \".BU\": {\n    suffix: \".BU\",\n    country: \"Bulgaria\",\n    exchange: \"Bulgarian Stock Exchange\",\n    fullExchangeName: \"Bulgarian Stock Exchange\",\n    currency: \"BGN\"\n  },\n  \".CR\": {\n    suffix: \".CR\",\n    country: \"Costa Rica\",\n    exchange: \"Costa Rica Stock Exchange\",\n    fullExchangeName: \"Bolsa Nacional de Valores\",\n    currency: \"CRC\"\n  },\n  \".CY\": {\n    suffix: \".CY\",\n    country: \"Cyprus\",\n    exchange: \"Cyprus Stock Exchange\",\n    fullExchangeName: \"Cyprus Stock Exchange\",\n    currency: \"EUR\"\n  },\n  \".EC\": {\n    suffix: \".EC\",\n    country: \"Egypt\",\n    exchange: \"Egyptian Exchange\",\n    fullExchangeName: \"Egyptian Exchange (EGX)\",\n    currency: \"EGP\"\n  },\n  \".JR\": {\n    suffix: \".JR\",\n    country: \"Jordan\",\n    exchange: \"Amman Stock Exchange\",\n    fullExchangeName: \"Amman Stock Exchange\",\n    currency: \"JOD\"\n  },\n  \".JT\": {\n    suffix: \".JT\",\n    country: \"Japan\",\n    exchange: \"Tokyo Stock Exchange\",\n    fullExchangeName: \"Tokyo Stock Exchange\",\n    currency: \"JPY\"\n  },\n  \".KH\": {\n    suffix: \".KH\",\n    country: \"Cambodia\",\n    exchange: \"Cambodia Securities Exchange\",\n    fullExchangeName: \"Cambodia Securities Exchange\",\n    currency: \"KHR\"\n  },\n  \".KK\": {\n    suffix: \".KK\",\n    country: \"Kuwait\",\n    exchange: \"Kuwait Stock Exchange\",\n    fullExchangeName: \"Kuwait Stock Exchange (Boursa Kuwait)\",\n    currency: \"KWD\"\n  },\n  \".KN\": {\n    suffix: \".KN\",\n    country: \"Kenya\",\n    exchange: \"Nairobi Securities Exchange\",\n    fullExchangeName: \"Nairobi Securities Exchange\",\n    currency: \"KES\"\n  },\n  \".KP\": {\n    suffix: \".KP\",\n    country: \"South Korea\",\n    exchange: \"Korea Exchange\",\n    fullExchangeName: \"Korea Exchange (KRX)\",\n    currency: \"KRW\"\n  },\n  \".KQ\": {\n    suffix: \".KQ\",\n    country: \"South Korea\",\n    exchange: \"KOSDAQ\",\n    fullExchangeName: \"Korea Exchange (KOSDAQ)\",\n    currency: \"KRW\"\n  },\n  \".KZ\": {\n    suffix: \".KZ\",\n    country: \"Kazakhstan\",\n    exchange: \"Kazakhstan Stock Exchange\",\n    fullExchangeName: \"Kazakhstan Stock Exchange\",\n    currency: \"KZT\"\n  },\n  \".LK\": {\n    suffix: \".LK\",\n    country: \"Sri Lanka\",\n    exchange: \"Colombo Stock Exchange\",\n    fullExchangeName: \"Colombo Stock Exchange\",\n    currency: \"LKR\"\n  },\n  \".MO\": {\n    suffix: \".MO\",\n    country: \"Mongolia\",\n    exchange: \"Mongolian Stock Exchange\",\n    fullExchangeName: \"Mongolian Stock Exchange\",\n    currency: \"MNT\"\n  },\n  \".PE\": {\n    suffix: \".PE\",\n    country: \"Peru\",\n    exchange: \"Lima Stock Exchange\",\n    fullExchangeName: \"Bolsa de Valores de Lima\",\n    currency: \"PEN\"\n  },\n  \".PH\": {\n    suffix: \".PH\",\n    country: \"Philippines\",\n    exchange: \"Philippine Stock Exchange\",\n    fullExchangeName: \"Philippine Stock Exchange\",\n    currency: \"PHP\"\n  },\n  \".PK\": {\n    suffix: \".PK\",\n    country: \"Pakistan\",\n    exchange: \"Pakistan Stock Exchange\",\n    fullExchangeName: \"Pakistan Stock Exchange\",\n    currency: \"PKR\"\n  },\n  \".QA\": {\n    suffix: \".QA\",\n    country: \"Qatar\",\n    exchange: \"Qatar Stock Exchange\",\n    fullExchangeName: \"Qatar Stock Exchange\",\n    currency: \"QAR\"\n  },\n  \".RO\": {\n    suffix: \".RO\",\n    country: \"Romania\",\n    exchange: \"Bucharest Stock Exchange\",\n    fullExchangeName: \"Bucharest Stock Exchange\",\n    currency: \"RON\"\n  },\n  \".SK\": {\n    suffix: \".SK\",\n    country: \"Slovakia\",\n    exchange: \"Bratislava Stock Exchange\",\n    fullExchangeName: \"Bratislava Stock Exchange\",\n    currency: \"EUR\"\n  },\n  \".TU\": {\n    suffix: \".TU\",\n    country: \"Tunisia\",\n    exchange: \"Tunis Stock Exchange\",\n    fullExchangeName: \"Bourse de Tunis\",\n    currency: \"TND\"\n  },\n  \".UA\": {\n    suffix: \".UA\",\n    country: \"Ukraine\",\n    exchange: \"Ukrainian Exchange\",\n    fullExchangeName: \"Ukrainian Exchange\",\n    currency: \"UAH\"\n  },\n  \".UY\": {\n    suffix: \".UY\",\n    country: \"Uruguay\",\n    exchange: \"Montevideo Stock Exchange\",\n    fullExchangeName: \"Bolsa de Valores de Montevideo\",\n    currency: \"UYU\"\n  },\n  \".VB\": {\n    suffix: \".VB\",\n    country: \"Bolivia\",\n    exchange: \"Bolivian Stock Exchange\",\n    fullExchangeName: \"Bolsa Boliviana de Valores\",\n    currency: \"BOB\"\n  },\n  \".VH\": {\n    suffix: \".VH\",\n    country: \"Vietnam\",\n    exchange: \"Hanoi Stock Exchange\",\n    fullExchangeName: \"Hanoi Stock Exchange\",\n    currency: \"VND\"\n  },\n  \".VM\": {\n    suffix: \".VM\",\n    country: \"Vietnam\",\n    exchange: \"Ho Chi Minh Stock Exchange\",\n    fullExchangeName: \"Ho Chi Minh Stock Exchange\",\n    currency: \"VND\"\n  },\n  \".ZH\": {\n    suffix: \".ZH\",\n    country: \"Zimbabwe\",\n    exchange: \"Zimbabwe Stock Exchange\",\n    fullExchangeName: \"Zimbabwe Stock Exchange\",\n    currency: \"ZWL\"\n  },\n  \".ZL\": {\n    suffix: \".ZL\",\n    country: \"Zambia\",\n    exchange: \"Lusaka Stock Exchange\",\n    fullExchangeName: \"Lusaka Stock Exchange\",\n    currency: \"ZMW\"\n  }\n};\n\n/**\n * Extract suffix from ticker symbol and return exchange/currency information\n * Case-insensitive and robust suffix detection\n */\nexport function getExchangeInfoFromSuffix(symbol: string): { exchange: string; currency: string; fullExchangeName?: string } | null {\n  // Look for suffix pattern (dot followed by letters) - case insensitive\n  const suffixMatch = symbol.toUpperCase().match(/(\\.[A-Z]+)$/);\n  \n  if (!suffixMatch) {\n    // No suffix found - could be US stock or needs special handling\n    return null;\n  }\n  \n  const suffix = suffixMatch[1];\n  const suffixInfo = suffixMappings[suffix];\n  \n  if (suffixInfo) {\n    return {\n      exchange: suffixInfo.exchange,\n      currency: suffixInfo.currency || 'USD',\n      fullExchangeName: suffixInfo.fullExchangeName\n    };\n  }\n  \n  return null;\n}\n\n/**\n * Centralized function to apply suffix-based exchange overrides to any data object\n * This ensures our suffix mappings ALWAYS take precedence over external API data\n */\nexport function applySuffixOverride(symbol: string, dataObj: any): any {\n  const suffixInfo = getExchangeInfoFromSuffix(symbol);\n  \n  if (suffixInfo) {\n    // Force override exchange and currency with our suffix-based data\n    return {\n      ...dataObj,\n      exchange: suffixInfo.exchange,\n      currency: suffixInfo.currency,\n      fullExchangeName: suffixInfo.fullExchangeName\n    };\n  }\n  \n  return dataObj;\n}\n\n/**\n * Get all available suffixes for reference\n */\nexport function getAllSuffixes(): string[] {\n  return Object.keys(suffixMappings).sort();\n}\n\n/**\n * Search for suffix information by suffix string\n */\nexport function searchSuffix(query: string): SuffixInfo | null {\n  const cleanQuery = query.trim().toUpperCase();\n  \n  // Add leading dot if not present\n  const searchKey = cleanQuery.startsWith('.') ? cleanQuery : `.${cleanQuery}`;\n  \n  return suffixMappings[searchKey] || null;\n}","path":null,"size_bytes":14089,"size_tokens":null},"client/src/components/ui/table.tsx":{"content":"import * as React from \"react\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst Table = React.forwardRef<\n  HTMLTableElement,\n  React.HTMLAttributes<HTMLTableElement>\n>(({ className, ...props }, ref) => (\n  <div className=\"relative w-full overflow-auto\">\n    <table\n      ref={ref}\n      className={cn(\"w-full caption-bottom text-sm\", className)}\n      {...props}\n    />\n  </div>\n))\nTable.displayName = \"Table\"\n\nconst TableHeader = React.forwardRef<\n  HTMLTableSectionElement,\n  React.HTMLAttributes<HTMLTableSectionElement>\n>(({ className, ...props }, ref) => (\n  <thead ref={ref} className={cn(\"[&_tr]:border-b\", className)} {...props} />\n))\nTableHeader.displayName = \"TableHeader\"\n\nconst TableBody = React.forwardRef<\n  HTMLTableSectionElement,\n  React.HTMLAttributes<HTMLTableSectionElement>\n>(({ className, ...props }, ref) => (\n  <tbody\n    ref={ref}\n    className={cn(\"[&_tr:last-child]:border-0\", className)}\n    {...props}\n  />\n))\nTableBody.displayName = \"TableBody\"\n\nconst TableFooter = React.forwardRef<\n  HTMLTableSectionElement,\n  React.HTMLAttributes<HTMLTableSectionElement>\n>(({ className, ...props }, ref) => (\n  <tfoot\n    ref={ref}\n    className={cn(\n      \"border-t bg-muted/50 font-medium [&>tr]:last:border-b-0\",\n      className\n    )}\n    {...props}\n  />\n))\nTableFooter.displayName = \"TableFooter\"\n\nconst TableRow = React.forwardRef<\n  HTMLTableRowElement,\n  React.HTMLAttributes<HTMLTableRowElement>\n>(({ className, ...props }, ref) => (\n  <tr\n    ref={ref}\n    className={cn(\n      \"border-b transition-colors hover:bg-muted/50 data-[state=selected]:bg-muted\",\n      className\n    )}\n    {...props}\n  />\n))\nTableRow.displayName = \"TableRow\"\n\nconst TableHead = React.forwardRef<\n  HTMLTableCellElement,\n  React.ThHTMLAttributes<HTMLTableCellElement>\n>(({ className, ...props }, ref) => (\n  <th\n    ref={ref}\n    className={cn(\n      \"h-12 px-4 text-left align-middle font-medium text-muted-foreground [&:has([role=checkbox])]:pr-0\",\n      className\n    )}\n    {...props}\n  />\n))\nTableHead.displayName = \"TableHead\"\n\nconst TableCell = React.forwardRef<\n  HTMLTableCellElement,\n  React.TdHTMLAttributes<HTMLTableCellElement>\n>(({ className, ...props }, ref) => (\n  <td\n    ref={ref}\n    className={cn(\"p-4 align-middle [&:has([role=checkbox])]:pr-0\", className)}\n    {...props}\n  />\n))\nTableCell.displayName = \"TableCell\"\n\nconst TableCaption = React.forwardRef<\n  HTMLTableCaptionElement,\n  React.HTMLAttributes<HTMLTableCaptionElement>\n>(({ className, ...props }, ref) => (\n  <caption\n    ref={ref}\n    className={cn(\"mt-4 text-sm text-muted-foreground\", className)}\n    {...props}\n  />\n))\nTableCaption.displayName = \"TableCaption\"\n\nexport {\n  Table,\n  TableHeader,\n  TableBody,\n  TableFooter,\n  TableHead,\n  TableRow,\n  TableCell,\n  TableCaption,\n}\n","path":null,"size_bytes":2765,"size_tokens":null},"client/src/components/ui/progress.tsx":{"content":"\"use client\"\n\nimport * as React from \"react\"\nimport * as ProgressPrimitive from \"@radix-ui/react-progress\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst Progress = React.forwardRef<\n  React.ElementRef<typeof ProgressPrimitive.Root>,\n  React.ComponentPropsWithoutRef<typeof ProgressPrimitive.Root>\n>(({ className, value, ...props }, ref) => (\n  <ProgressPrimitive.Root\n    ref={ref}\n    className={cn(\n      \"relative h-4 w-full overflow-hidden rounded-full bg-secondary\",\n      className\n    )}\n    {...props}\n  >\n    <ProgressPrimitive.Indicator\n      className=\"h-full w-full flex-1 bg-primary transition-all\"\n      style={{ transform: `translateX(-${100 - (value || 0)}%)` }}\n    />\n  </ProgressPrimitive.Root>\n))\nProgress.displayName = ProgressPrimitive.Root.displayName\n\nexport { Progress }\n","path":null,"size_bytes":791,"size_tokens":null},"server/routes.ts":{"content":"import type { Express } from \"express\";\nimport { createServer, type Server } from \"http\";\nimport { randomUUID } from \"crypto\";\nimport { stockDataService } from \"./services/stockData\";\nimport { finnhubService } from \"./services/finnhubService\";\nimport multer from \"multer\";\nimport { sendFeedbackToSlack } from \"./slack\";\nimport { db } from \"./db\";\nimport { visitorAnalytics, loginAttempts, insertLoginAttemptSchema, aiCopilotChats, aiCopilotMessages, aiCopilotUploads, chartHistory, insertChartHistorySchema, compareChartHistory, insertCompareChartHistorySchema } from \"@shared/schema\";\nimport { desc, count, sql, gte, lte, and, eq, inArray } from \"drizzle-orm\";\nimport { getExchangeInfoFromSuffix, applySuffixOverride } from \"./utils/suffixMappings\";\nimport { indexService } from \"./services/indexService\";\nimport OpenAI from \"openai\";\n\n// Simple in-memory session store for authentication\nconst authSessions = new Map<string, { createdAt: number; userId: string }>();\n\n// Middleware to check authentication\nfunction requireAuth(req: any, res: any, next: any) {\n  const token = req.headers.authorization?.replace('Bearer ', '');\n  \n  if (!token || !authSessions.has(token)) {\n    return res.status(401).json({ message: 'Unauthorized' });\n  }\n  \n  // Check if token is expired (24 hours)\n  const session = authSessions.get(token);\n  if (session && Date.now() - session.createdAt > 24 * 60 * 60 * 1000) {\n    authSessions.delete(token);\n    return res.status(401).json({ message: 'Session expired' });\n  }\n  \n  // Attach userId to request for downstream use\n  req.userId = session?.userId;\n  \n  next();\n}\n\n// Clean up expired sessions periodically\nsetInterval(() => {\n  const now = Date.now();\n  const expiryTime = 24 * 60 * 60 * 1000; // 24 hours\n  \n  for (const [token, session] of Array.from(authSessions.entries())) {\n    if (now - session.createdAt > expiryTime) {\n      authSessions.delete(token);\n    }\n  }\n}, 60 * 60 * 1000); // Run every hour\n\nexport async function registerRoutes(app: Express): Promise<Server> {\n  // Global stock search endpoint using Finnhub symbol lookup\n  app.get(\"/api/stocks/global-search\", async (req, res) => {\n    try {\n      const query = req.query.q as string;\n      if (!query || query.trim().length === 0) {\n        return res.json([]);\n      }\n\n      console.log(` Global search for: \"${query}\"`);\n      \n      // Use Finnhub symbol lookup API for global search\n      const finnhubApiKey = process.env.FINNHUB_API_KEY;\n      \n      if (!finnhubApiKey) {\n        console.error(\" FINNHUB_API_KEY not configured\");\n        return res.status(500).json({ message: \"API configuration error\" });\n      }\n      \n      const searchUrl = `https://finnhub.io/api/v1/search?q=${encodeURIComponent(query.trim())}&token=${finnhubApiKey}`;\n      const response = await fetch(searchUrl);\n      \n      if (!response.ok) {\n        throw new Error(`Finnhub API error: ${response.status}`);\n      }\n\n      const data = await response.json();\n      \n      // Transform Finnhub response to our format with universal exchange info\n      const stockResults = data.result?.slice(0, 8).map((item: any) => {\n        const baseResult = {\n          symbol: item.symbol,\n          description: item.description,\n          displaySymbol: item.displaySymbol,\n          type: item.type || 'Unknown'\n        };\n\n        // Apply centralized suffix override - this ALWAYS takes precedence\n        let result = applySuffixOverride(item.symbol, baseResult);\n\n        // Special case: Handle tickers without suffixes that we know are specific exchanges\n        // For multi-listed stocks, prioritize main US listing when no suffix\n        if (!result.exchange) {\n          const specialCases: Record<string, { exchange: string; currency: string }> = {\n            'FER': { exchange: 'NasdaqGS', currency: 'USD' }, // Ferrovial SE US listing priority\n            // Add other multi-listed stocks here as needed\n          };\n\n          const specialCase = specialCases[item.symbol];\n          if (specialCase) {\n            result = {\n              ...result,\n              exchange: specialCase.exchange,\n              currency: specialCase.currency\n            };\n          }\n        }\n\n        return result;\n      }) || [];\n\n      // Search global indices and include them in results\n      const indexResults = indexService.searchIndices(query).slice(0, 2).map(index => ({\n        symbol: index.symbol,\n        description: index.description,\n        displaySymbol: index.symbol,\n        type: 'Index',\n        exchange: index.country,\n        currency: index.currency,\n        country: index.country,\n        region: index.region\n      }));\n\n      // Combine stock and index results, prioritizing stocks\n      const globalResults = [...stockResults, ...indexResults];\n\n      console.log(` Global search completed: ${globalResults.length} results for \"${query}\"`);\n      res.json(globalResults);\n    } catch (error) {\n      console.error(\"Error in global stock search:\", error);\n      res.status(500).json({ message: \"Failed to search global stocks\" });\n    }\n  });\n\n  // Regular ticker search endpoint (for dashboard ticker search component)\n  app.get(\"/api/stocks/search\", async (req, res) => {\n    try {\n      const query = req.query.q as string;\n      if (!query || query.trim().length === 0) {\n        return res.json([]);\n      }\n\n      console.log(` Ticker search for: \"${query}\"`);\n      \n      // Use the existing stockDataService for US market search\n      const searchResults = await stockDataService.searchStocks(query);\n      \n      // Transform to include exchange and currency information for suffixed tickers\n      const enhancedResults = searchResults.map((stock: any) => {\n        const baseResult = {\n          symbol: stock.symbol,\n          name: stock.name,\n          price: stock.price,\n          percentChange: stock.percentChange,\n          marketCap: stock.marketCap\n        };\n\n        // Apply centralized suffix override - this ALWAYS takes precedence\n        let result = applySuffixOverride(stock.symbol, baseResult);\n\n        // For US stocks without suffixes, add default US exchange info when available\n        if (!result.exchange && !stock.symbol.includes('.')) {\n          result = {\n            ...result,\n            exchange: 'NASDAQ/NYSE',\n            currency: 'USD'\n          };\n        }\n\n        return result;\n      });\n      \n      console.log(` Ticker search completed: ${enhancedResults.length} results for \"${query}\"`);\n      res.json(enhancedResults);\n    } catch (error) {\n      console.error(\"Error in ticker search:\", error);\n      res.status(500).json({ message: \"Failed to search ticker stocks\" });\n    }\n  });\n\n  // Index search endpoint - dedicated index search\n  app.get(\"/api/indices/search\", async (req, res) => {\n    try {\n      const query = req.query.q as string;\n      if (!query || query.trim().length === 0) {\n        return res.json([]);\n      }\n\n      console.log(` Index search for: \"${query}\"`);\n      \n      const indexResults = indexService.searchIndices(query).map(index => ({\n        symbol: index.symbol,\n        name: index.name,\n        description: index.description,\n        type: 'Index',\n        country: index.country,\n        region: index.region,\n        currency: index.currency,\n        exchange: index.country // For consistency with stock results\n      }));\n      \n      console.log(` Index search completed: ${indexResults.length} results for \"${query}\"`);\n      res.json(indexResults);\n    } catch (error) {\n      console.error(\"Error in index search:\", error);\n      res.status(500).json({ message: \"Failed to search indices\" });\n    }\n  });\n\n  // Index details endpoint - get detailed index information\n  app.get(\"/api/indices/:symbol/details\", async (req, res) => {\n    try {\n      const { symbol } = req.params;\n      console.log(` Index details request for: ${symbol}`);\n      \n      const indexDetails = await indexService.getDetailedIndexInfo(symbol);\n      \n      if (!indexDetails) {\n        return res.status(404).json({ error: \"Index not found or data not available\" });\n      }\n\n      res.json(indexDetails);\n    } catch (error) {\n      console.error(\"Index details error:\", error);\n      res.status(500).json({ error: \"Failed to fetch index details\" });\n    }\n  });\n\n  // Index quote endpoint - get real-time index price\n  app.get(\"/api/indices/:symbol/quote\", async (req, res) => {\n    try {\n      const { symbol } = req.params;\n      const quote = await indexService.getIndexQuote(symbol);\n      \n      if (!quote) {\n        return res.status(404).json({ error: \"Index quote not available\" });\n      }\n\n      res.json({\n        symbol,\n        quote,\n        timestamp: new Date().toISOString()\n      });\n    } catch (error) {\n      console.error(\"Index quote error:\", error);\n      res.status(500).json({ error: \"Failed to fetch index quote\" });\n    }\n  });\n\n  // Index constituents endpoint - get stocks in the index\n  app.get(\"/api/indices/:symbol/constituents\", async (req, res) => {\n    try {\n      const { symbol } = req.params;\n      const constituents = await indexService.getIndexConstituents(symbol);\n      \n      if (!constituents) {\n        return res.status(404).json({ error: \"Index constituents not available\" });\n      }\n\n      res.json(constituents);\n    } catch (error) {\n      console.error(\"Index constituents error:\", error);\n      res.status(500).json({ error: \"Failed to fetch index constituents\" });\n    }\n  });\n\n  // Dividend data endpoint\n  app.get(\"/api/stocks/:symbol/dividends\", async (req, res) => {\n    const symbol = req.params.symbol;\n    const from = req.query.from ? parseInt(req.query.from as string) : undefined;\n    const to = req.query.to ? parseInt(req.query.to as string) : undefined;\n\n    try {\n      console.log(` Dividend request for ${symbol}, from: ${from}, to: ${to}`);\n      const dividends = await finnhubService.getDividends(symbol, from, to);\n      \n      res.json({\n        symbol,\n        dividends,\n        count: dividends.length\n      });\n    } catch (error) {\n      console.error(`Error fetching dividends for ${symbol}:`, error);\n      res.status(500).json({ \n        error: 'Failed to fetch dividend data', \n        message: error instanceof Error ? error.message : 'Unknown error'\n      });\n    }\n  });\n\n  // Stock chart data endpoint\n  app.get(\"/api/stocks/:symbol/chart\", async (req, res) => {\n    try {\n      const { symbol } = req.params;\n      const { timeframe = '1D', from: customFrom, to: customTo, interval } = req.query;\n\n      console.log(` Chart request for ${symbol}, timeframe: ${timeframe}, interval: ${interval}, from: ${customFrom}, to: ${customTo}`);\n\n      // Calculate time range based on timeframe or custom dates\n      const now = Math.floor(Date.now() / 1000);\n      let from: number;\n      let to: number = now;\n      let resolution: string | undefined;\n\n      // User-specified interval takes precedence if provided\n      const userInterval = interval as string | undefined;\n\n      if (timeframe === 'Custom' && customFrom && customTo) {\n        from = parseInt(customFrom as string);\n        to = parseInt(customTo as string);\n        // For custom ranges, use user interval if provided, otherwise default based on date range\n        const daysDiff = (to - from) / (24 * 60 * 60);\n        \n        if (userInterval && ['15', '60', '180', '360'].includes(userInterval)) {\n          // Use user-specified interval (convert 180/360 to valid Finnhub resolutions)\n          if (userInterval === '180') {\n            resolution = '60'; // Finnhub doesn't support 3h, use 1h and we'll aggregate\n          } else if (userInterval === '360') {\n            resolution = '60'; // Finnhub doesn't support 6h, use 1h and we'll aggregate\n          } else {\n            resolution = userInterval;\n          }\n        } else if (daysDiff <= 1) {\n          resolution = '5'; // 5-minute intervals for 1 day or less\n        } else if (daysDiff <= 7) {\n          resolution = '15'; // 15-minute intervals for up to 1 week\n        } else {\n          resolution = 'D'; // Daily intervals for >7 days (Finnhub hourly candles limited to ~7-10 days)\n          // Don't add buffer for custom date ranges - use exactly what user requested\n        }\n      } else {\n        // Calculate user resolution from interval if provided\n        let userResolution: string | undefined;\n        if (userInterval && ['15', '60', '180', '360'].includes(userInterval)) {\n          // Convert to Finnhub-supported resolutions\n          if (userInterval === '180') {\n            userResolution = '60'; // 3h -> use 1h\n          } else if (userInterval === '360') {\n            userResolution = '60'; // 6h -> use 1h  \n          } else {\n            userResolution = userInterval;\n          }\n        }\n        \n        switch (timeframe) {\n          case '1D':\n            from = now - (24 * 60 * 60); // 1 day\n            resolution = userResolution || '5'; // Use user interval or default\n            break;\n          case '5D':\n            from = now - (5 * 24 * 60 * 60); // 5 days\n            resolution = userResolution || '15'; // 15-minute intervals\n            break;\n          case '2W':\n            from = now - (14 * 24 * 60 * 60); // 2 weeks\n            resolution = userResolution || '60'; // 1-hour intervals\n            break;\n          case '1M':\n            from = now - (30 * 24 * 60 * 60); // 1 month\n            resolution = userResolution || '60'; // 1-hour intervals\n            break;\n          case '3M':\n            from = now - (90 * 24 * 60 * 60); // 3 months\n            resolution = 'D'; // Daily intervals (ignore user interval for long ranges)\n            to = now + (24 * 60 * 60); // Add 1 day buffer to ensure we get today's data\n            break;\n          case '6M':\n            from = now - (180 * 24 * 60 * 60); // 6 months\n            resolution = 'D'; // Daily intervals\n            to = now + (24 * 60 * 60); // Add 1 day buffer to ensure we get today's data\n            break;\n          case '1Y':\n            from = now - (365 * 24 * 60 * 60); // 1 year\n            resolution = 'D'; // Daily intervals\n            to = now + (24 * 60 * 60); // Add 1 day buffer to ensure we get today's data\n            break;\n          case '3Y':\n            from = now - (3 * 365 * 24 * 60 * 60); // 3 years\n            resolution = 'D'; // Daily intervals\n            to = now + (24 * 60 * 60); // Add 1 day buffer to ensure we get today's data\n            break;\n          case '5Y':\n            from = now - (5 * 365 * 24 * 60 * 60); // 5 years\n            resolution = 'D'; // Daily intervals\n            to = now + (24 * 60 * 60); // Add 1 day buffer to ensure we get today's data\n            break;\n          default:\n            from = now - (24 * 60 * 60);\n            resolution = userResolution || '5';\n        }\n      }\n\n      let chartData = await stockDataService.getStockChart(symbol, from, to, resolution);\n      \n      // For Single Trading Day requests, if intraday data isn't available, try daily data\n      if (!chartData && timeframe === 'Custom' && customFrom && customTo) {\n        const daysDiff = (to - from) / (24 * 60 * 60);\n        if (daysDiff <= 1) {\n          console.log(` No intraday data for ${symbol} on single day, trying daily data...`);\n          chartData = await stockDataService.getStockChart(symbol, from, to, 'D');\n        }\n      }\n      \n      if (!chartData) {\n        return res.status(404).json({ error: \"Chart data not available\" });\n      }\n\n      // Transform the data for the frontend chart\n      let formattedData = chartData.t?.map((timestamp: number, index: number) => ({\n        timestamp: timestamp * 1000, // Convert to milliseconds\n        time: new Date(timestamp * 1000).toISOString(),\n        open: chartData.o[index],\n        high: chartData.h[index],\n        low: chartData.l[index],\n        close: chartData.c[index],\n        volume: chartData.v[index]\n      })) || [];\n\n      // Aggregate data for 3h/6h intervals if user requested them\n      // (since Finnhub only provides up to 1h resolution)\n      if (userInterval === '180' || userInterval === '360') {\n        const aggregationMs = (userInterval === '180' ? 180 : 360) * 60 * 1000; // 3h or 6h in milliseconds\n        const dayMs = 24 * 60 * 60 * 1000;\n        \n        // Group candles by composite key: trading day + interval bucket\n        // This prevents cross-day merging when gaps span multiple days\n        const buckets = new Map<string, typeof formattedData>();\n        \n        for (const point of formattedData) {\n          // Create a composite key: trading day (UTC) + bucket within that day\n          const tradingDay = Math.floor(point.timestamp / dayMs);\n          const timeWithinDay = point.timestamp % dayMs;\n          const bucketWithinDay = Math.floor(timeWithinDay / aggregationMs);\n          const bucketKey = `${tradingDay}_${bucketWithinDay}`;\n          \n          if (!buckets.has(bucketKey)) {\n            buckets.set(bucketKey, []);\n          }\n          buckets.get(bucketKey)!.push(point);\n        }\n        \n        // Convert buckets to aggregated candles\n        const aggregatedData: typeof formattedData = [];\n        \n        // Sort bucket keys to maintain chronological order (e.g., \"19800_0\", \"19800_1\", \"19801_0\")\n        const sortedBucketKeys = Array.from(buckets.keys()).sort((a, b) => {\n          const [dayA, bucketA] = a.split('_').map(Number);\n          const [dayB, bucketB] = b.split('_').map(Number);\n          return dayA !== dayB ? dayA - dayB : bucketA - bucketB;\n        });\n        \n        for (const bucketKey of sortedBucketKeys) {\n          const candlesInBucket = buckets.get(bucketKey)!;\n          \n          if (candlesInBucket.length === 0) continue;\n          \n          // Aggregate OHLCV for this bucket\n          const firstCandle = candlesInBucket[0];\n          const lastCandle = candlesInBucket[candlesInBucket.length - 1];\n          \n          let high = -Infinity;\n          let low = Infinity;\n          let volume = 0;\n          \n          for (const candle of candlesInBucket) {\n            high = Math.max(high, candle.high);\n            low = Math.min(low, candle.low);\n            volume += candle.volume;\n          }\n          \n          aggregatedData.push({\n            timestamp: firstCandle.timestamp,\n            time: firstCandle.time,\n            open: firstCandle.open,\n            high,\n            low,\n            close: lastCandle.close,\n            volume\n          });\n        }\n        \n        formattedData = aggregatedData;\n        console.log(` Aggregated ${chartData.t?.length || 0} points to ${formattedData.length} (${userInterval === '180' ? '3h' : '6h'} intervals)`);\n      }\n\n      res.json({\n        symbol,\n        timeframe,\n        data: formattedData\n      });\n    } catch (error) {\n      console.error(\"Chart data error:\", error);\n      res.status(500).json({ error: \"Failed to fetch chart data\" });\n    }\n  });\n\n  // Detailed stock info endpoint\n  app.get(\"/api/stocks/:symbol/details\", async (req, res) => {\n    try {\n      const { symbol } = req.params;\n      const stockDetails = await stockDataService.getDetailedStockInfo(symbol);\n      \n      if (!stockDetails) {\n        return res.status(404).json({ error: \"Stock details not available\" });\n      }\n\n      // Apply centralized suffix override - this ALWAYS takes precedence over external API data\n      const enhancedDetails = applySuffixOverride(symbol, stockDetails);\n\n      res.json(enhancedDetails);\n    } catch (error) {\n      console.error(\"Stock details error:\", error);\n      res.status(500).json({ error: \"Failed to fetch stock details\" });\n    }\n  });\n\n  // Earnings calendar endpoint\n  app.get(\"/api/stocks/:symbol/earnings\", async (req, res) => {\n    try {\n      const { symbol } = req.params;\n      console.log(` Earnings request for: ${symbol}`);\n      \n      const earningsData = await stockDataService.getEarningsCalendar(symbol);\n      \n      res.json({\n        symbol,\n        earnings: earningsData\n      });\n    } catch (error) {\n      console.error(\"Error fetching earnings calendar:\", error);\n      res.status(500).json({ message: \"Failed to fetch earnings calendar\" });\n    }\n  });\n\n  // Market holidays endpoint for exchanges\n  app.get(\"/api/exchanges/:exchange/holidays\", async (req, res) => {\n    try {\n      const { exchange } = req.params;\n      console.log(` Market holidays request for: ${exchange}`);\n      \n      const holidayData = await stockDataService.getMarketHolidays(exchange);\n      \n      if (!holidayData) {\n        return res.status(404).json({ error: \"Holiday data not available for this exchange\" });\n      }\n      \n      res.json({\n        exchange,\n        holidays: holidayData.data || []\n      });\n    } catch (error) {\n      console.error(\"Error fetching market holidays:\", error);\n      res.status(500).json({ message: \"Failed to fetch market holidays\" });\n    }\n  });\n\n  // Configure multer for file uploads (in memory for email attachment)\n  const upload = multer({ \n    storage: multer.memoryStorage(),\n    limits: {\n      fileSize: 10 * 1024 * 1024, // 10MB limit\n    },\n  });\n\n  // Feedback form submission endpoint\n  app.post(\"/api/feedback\", upload.single('file'), async (req, res) => {\n    try {\n      const { name, email, message } = req.body;\n      \n      if (!name || !email || !message) {\n        return res.status(400).json({ \n          message: \"Name, email, and message are required\" \n        });\n      }\n\n      // Prepare file attachment if exists\n      let fileAttachment;\n      if (req.file) {\n        fileAttachment = {\n          content: req.file.buffer,\n          filename: req.file.originalname,\n          mimetype: req.file.mimetype\n        };\n      }\n\n      // Send feedback to Slack channel\n      const slackSent = await sendFeedbackToSlack({\n        name,\n        email,\n        message,\n        file: fileAttachment\n      }); // Uses SLACK_CHANNEL_ID from environment or defaults to 'general'\n\n      if (slackSent) {\n        console.log(` Feedback sent to Slack from ${email}`);\n        res.json({ success: true, message: \"Feedback sent successfully\" });\n      } else {\n        throw new Error(\"Failed to send feedback to Slack\");\n      }\n\n    } catch (error) {\n      console.error(\"Feedback submission error:\", error);\n      res.status(500).json({ \n        message: \"Failed to submit feedback. Please try again.\" \n      });\n    }\n  });\n\n  // Helper function to get date range based on filter\n  const getDateRange = (dateFilter: string) => {\n    const now = new Date();\n    \n    switch (dateFilter) {\n      case 'today':\n        const startOfToday = new Date(now.getFullYear(), now.getMonth(), now.getDate());\n        const endOfToday = new Date(startOfToday.getTime() + 24 * 60 * 60 * 1000);\n        return { start: startOfToday, end: endOfToday };\n      \n      case 'yesterday':\n        const startOfYesterday = new Date(now.getFullYear(), now.getMonth(), now.getDate() - 1);\n        const endOfYesterday = new Date(startOfYesterday.getTime() + 24 * 60 * 60 * 1000);\n        return { start: startOfYesterday, end: endOfYesterday };\n      \n      case '7days':\n        const sevenDaysAgo = new Date(now.getTime() - 7 * 24 * 60 * 60 * 1000);\n        return { start: sevenDaysAgo, end: now };\n      \n      case '30days':\n        const thirtyDaysAgo = new Date(now.getTime() - 30 * 24 * 60 * 60 * 1000);\n        return { start: thirtyDaysAgo, end: now };\n      \n      case '90days':\n        const ninetyDaysAgo = new Date(now.getTime() - 90 * 24 * 60 * 60 * 1000);\n        return { start: ninetyDaysAgo, end: now };\n      \n      default: // 'all'\n        return null;\n    }\n  };\n\n  // Visitor analytics endpoints\n  app.get(\"/api/analytics/visitors\", async (req, res) => {\n    try {\n      const limit = Math.min(parseInt(req.query.limit as string) || 100, 1000);\n      const offset = parseInt(req.query.offset as string) || 0;\n      const dateFilter = req.query.dateFilter as string || 'all';\n      \n      // Apply date filtering if specified\n      const dateRange = getDateRange(dateFilter);\n      \n      const visitors = dateRange ? \n        await db\n          .select()\n          .from(visitorAnalytics)\n          .where(\n            and(\n              gte(visitorAnalytics.visitedAt, dateRange.start),\n              lte(visitorAnalytics.visitedAt, dateRange.end)\n            )\n          )\n          .orderBy(desc(visitorAnalytics.visitedAt))\n          .limit(limit)\n          .offset(offset) :\n        await db\n          .select()\n          .from(visitorAnalytics)\n          .orderBy(desc(visitorAnalytics.visitedAt))\n          .limit(limit)\n          .offset(offset);\n      res.json(visitors);\n    } catch (error) {\n      console.error(\"Error fetching visitor analytics:\", error);\n      res.status(500).json({ message: \"Failed to fetch visitor analytics\" });\n    }\n  });\n\n  app.get(\"/api/analytics/summary\", async (req, res) => {\n    try {\n      const dateFilter = req.query.dateFilter as string || 'all';\n      const dateRange = getDateRange(dateFilter);\n\n      // Build where condition for date filtering\n      const dateCondition = dateRange ? \n        and(\n          gte(visitorAnalytics.visitedAt, dateRange.start),\n          lte(visitorAnalytics.visitedAt, dateRange.end)\n        ) : undefined;\n\n      // Total visitors\n      const totalVisitors = dateCondition ? \n        await db.select({ count: count() }).from(visitorAnalytics).where(dateCondition) :\n        await db.select({ count: count() }).from(visitorAnalytics);\n\n      // Unique visitors by IP  \n      const uniqueVisitors = dateCondition ?\n        await db\n          .select({ count: count() })\n          .from(visitorAnalytics)\n          .where(dateCondition)\n          .groupBy(visitorAnalytics.ipAddress) :\n        await db\n          .select({ count: count() })\n          .from(visitorAnalytics)\n          .groupBy(visitorAnalytics.ipAddress);\n\n      // Top countries\n      const topCountries = dateCondition ?\n        await db\n          .select({\n            country: visitorAnalytics.country,\n            count: count()\n          })\n          .from(visitorAnalytics)\n          .where(and(sql`${visitorAnalytics.country} IS NOT NULL`, dateCondition))\n          .groupBy(visitorAnalytics.country)\n          .orderBy(desc(count()))\n          .limit(10) :\n        await db\n          .select({\n            country: visitorAnalytics.country,\n            count: count()\n          })\n          .from(visitorAnalytics)\n          .where(sql`${visitorAnalytics.country} IS NOT NULL`)\n          .groupBy(visitorAnalytics.country)\n          .orderBy(desc(count()))\n          .limit(10);\n\n      // Top cities\n      const topCities = dateCondition ?\n        await db\n          .select({\n            city: visitorAnalytics.city,\n            country: visitorAnalytics.country,\n            count: count()\n          })\n          .from(visitorAnalytics)\n          .where(and(sql`${visitorAnalytics.city} IS NOT NULL`, dateCondition))\n          .groupBy(visitorAnalytics.city, visitorAnalytics.country)\n          .orderBy(desc(count()))\n          .limit(10) :\n        await db\n          .select({\n            city: visitorAnalytics.city,\n            country: visitorAnalytics.country,\n            count: count()\n          })\n          .from(visitorAnalytics)\n          .where(sql`${visitorAnalytics.city} IS NOT NULL`)\n          .groupBy(visitorAnalytics.city, visitorAnalytics.country)\n          .orderBy(desc(count()))\n          .limit(10);\n\n      // Recent visitors (last 24 hours or filtered period)\n      let recentVisitorsQuery;\n      if (dateFilter === 'all') {\n        recentVisitorsQuery = db\n          .select({ count: count() })\n          .from(visitorAnalytics)\n          .where(sql`${visitorAnalytics.visitedAt} > NOW() - INTERVAL '24 hours'`);\n      } else {\n        recentVisitorsQuery = db\n          .select({ count: count() })\n          .from(visitorAnalytics)\n          .where(dateCondition);\n      }\n      const recentVisitors = await recentVisitorsQuery;\n\n      res.json({\n        totalVisitors: totalVisitors[0]?.count || 0,\n        uniqueVisitors: uniqueVisitors.length || 0,\n        recentVisitors: recentVisitors[0]?.count || 0,\n        topCountries,\n        topCities,\n      });\n    } catch (error) {\n      console.error(\"Error fetching analytics summary:\", error);\n      res.status(500).json({ message: \"Failed to fetch analytics summary\" });\n    }\n  });\n\n  app.get(\"/api/analytics/locations\", async (req, res) => {\n    try {\n      const dateFilter = req.query.dateFilter as string || 'all';\n      const dateRange = getDateRange(dateFilter);\n\n      const locations = dateRange ? \n        await db\n          .select({\n            ipAddress: visitorAnalytics.ipAddress,\n            country: visitorAnalytics.country,\n            region: visitorAnalytics.region,\n            city: visitorAnalytics.city,\n            latitude: visitorAnalytics.latitude,\n            longitude: visitorAnalytics.longitude,\n            isp: visitorAnalytics.isp,\n            visitedAt: visitorAnalytics.visitedAt,\n          })\n          .from(visitorAnalytics)\n          .where(\n            and(\n              sql`${visitorAnalytics.latitude} IS NOT NULL AND ${visitorAnalytics.longitude} IS NOT NULL`,\n              gte(visitorAnalytics.visitedAt, dateRange.start),\n              lte(visitorAnalytics.visitedAt, dateRange.end)\n            )\n          )\n          .orderBy(desc(visitorAnalytics.visitedAt))\n          .limit(500) :\n        await db\n          .select({\n            ipAddress: visitorAnalytics.ipAddress,\n            country: visitorAnalytics.country,\n            region: visitorAnalytics.region,\n            city: visitorAnalytics.city,\n            latitude: visitorAnalytics.latitude,\n            longitude: visitorAnalytics.longitude,\n            isp: visitorAnalytics.isp,\n            visitedAt: visitorAnalytics.visitedAt,\n          })\n          .from(visitorAnalytics)\n          .where(sql`${visitorAnalytics.latitude} IS NOT NULL AND ${visitorAnalytics.longitude} IS NOT NULL`)\n          .orderBy(desc(visitorAnalytics.visitedAt))\n          .limit(500);\n      res.json(locations);\n    } catch (error) {\n      console.error(\"Error fetching visitor locations:\", error);\n      res.status(500).json({ message: \"Failed to fetch visitor locations\" });\n    }\n  });\n\n  // Login endpoint with attempt tracking\n  app.post(\"/api/login\", async (req, res) => {\n    try {\n      const { username, password } = req.body;\n      \n      // Get IP address and user agent from request\n      const ipAddress = req.ip || req.headers['x-forwarded-for'] as string || 'unknown';\n      const userAgent = req.headers['user-agent'] || 'unknown';\n      \n      // Validate credentials and determine failure reason (hardcoded for now)\n      const validUsername = 'test@intropic.io';\n      const validPassword = 'egg';\n      \n      let isValid = false;\n      let failureReason: string | null = null;\n      \n      if (username !== validUsername) {\n        failureReason = 'Invalid username';\n      } else if (password !== validPassword) {\n        failureReason = 'Invalid password';\n      } else {\n        isValid = true;\n        failureReason = null;\n      }\n      \n      // Fetch geolocation data for IP address with timeout\n      let country = null;\n      let region = null;\n      let city = null;\n      \n      try {\n        if (ipAddress && ipAddress !== 'unknown' && ipAddress !== '::1' && !ipAddress.startsWith('127.')) {\n          // Set timeout to prevent hanging the login process\n          const controller = new AbortController();\n          const timeoutId = setTimeout(() => controller.abort(), 3000); // 3 second timeout\n          \n          try {\n            const geoResponse = await fetch(`https://ipapi.co/${ipAddress}/json/`, {\n              signal: controller.signal\n            });\n            clearTimeout(timeoutId);\n            \n            if (geoResponse.ok) {\n              const geoData = await geoResponse.json();\n              country = geoData.country_name || null;\n              region = geoData.region || null;\n              city = geoData.city || null;\n              console.log(` Location for ${ipAddress}: ${city}, ${region}, ${country}`);\n            } else {\n              console.log(` Geolocation API returned ${geoResponse.status} for ${ipAddress}`);\n            }\n          } catch (fetchError) {\n            clearTimeout(timeoutId);\n            throw fetchError;\n          }\n        } else {\n          console.log(` Skipping geolocation for local IP: ${ipAddress}`);\n        }\n      } catch (geoError) {\n        if (geoError instanceof Error && geoError.name === 'AbortError') {\n          console.error(` Geolocation lookup timed out for ${ipAddress}`);\n        } else {\n          console.error(\"Geolocation lookup failed:\", geoError);\n        }\n        // Continue without location data if geolocation fails - don't block login\n      }\n      \n      // Record the login attempt\n      await db.insert(loginAttempts).values({\n        username,\n        success: isValid,\n        failureReason,\n        ipAddress,\n        userAgent,\n        country,\n        region,\n        city,\n      });\n      \n      console.log(` Login attempt: ${username} - ${isValid ? 'SUCCESS' : 'FAILED'} ${failureReason ? `(${failureReason})` : ''} from ${ipAddress}`);\n      \n      if (isValid) {\n        // Generate session token\n        const token = randomUUID();\n        authSessions.set(token, { createdAt: Date.now(), userId: username });\n        \n        res.json({ success: true, token });\n      } else {\n        res.status(401).json({ success: false, message: 'Invalid username or password' });\n      }\n    } catch (error) {\n      console.error(\"Error processing login:\", error);\n      res.status(500).json({ success: false, message: \"Login system error\" });\n    }\n  });\n\n  // Validate session endpoint\n  app.get(\"/api/session\", requireAuth, async (req, res) => {\n    res.json({ valid: true });\n  });\n\n  // Get login attempt history (requires authentication)\n  app.get(\"/api/login-attempts\", requireAuth, async (req, res) => {\n    try {\n      const limit = parseInt(req.query.limit as string) || 100;\n      \n      const attempts = await db\n        .select()\n        .from(loginAttempts)\n        .orderBy(desc(loginAttempts.attemptedAt))\n        .limit(limit);\n      \n      res.json(attempts);\n    } catch (error) {\n      console.error(\"Error fetching login attempts:\", error);\n      res.status(500).json({ message: \"Failed to fetch login attempts\" });\n    }\n  });\n\n  // Chart History Routes\n\n  // Save chart with annotations to history (upsert by sessionId)\n  app.post(\"/api/chart-history\", requireAuth, async (req: any, res) => {\n    try {\n      const { sessionId, symbol, timeframe, customStartDate, customEndDate, dividendAdjusted, csvOverlay, comparisonTickers, annotations } = req.body;\n      const userId = req.userId;\n      \n      const hasAnnotations = annotations && Array.isArray(annotations) && annotations.length > 0;\n      const hasComparisonTickers = comparisonTickers && Array.isArray(comparisonTickers) && comparisonTickers.length > 0;\n      const hasCsvOverlay = csvOverlay && Array.isArray(csvOverlay) && csvOverlay.length > 0;\n      const hasCustomDateRange = timeframe === 'Custom' && customStartDate && customEndDate;\n      \n      if (!sessionId || !symbol || !timeframe || (!hasAnnotations && !hasComparisonTickers && !hasCsvOverlay && !hasCustomDateRange)) {\n        return res.status(400).json({ message: \"SessionId, symbol, timeframe, and at least one of: annotations, comparison tickers, csv overlay, or custom date range are required\" });\n      }\n      \n      if (!userId) {\n        return res.status(401).json({ message: \"User not authenticated\" });\n      }\n      \n      // Check if entry exists for this userId + sessionId\n      const existing = await db\n        .select()\n        .from(chartHistory)\n        .where(and(\n          eq(chartHistory.userId, userId),\n          eq(chartHistory.sessionId, sessionId)\n        ))\n        .limit(1);\n      \n      let history;\n      if (existing.length > 0) {\n        // Update existing entry\n        const [updated] = await db\n          .update(chartHistory)\n          .set({\n            symbol,\n            timeframe,\n            customStartDate,\n            customEndDate,\n            dividendAdjusted: dividendAdjusted || false,\n            csvOverlay: csvOverlay || null,\n            comparisonTickers: comparisonTickers || null,\n            annotations: annotations || [],\n            updatedAt: new Date()\n          })\n          .where(and(\n            eq(chartHistory.userId, userId),\n            eq(chartHistory.sessionId, sessionId)\n          ))\n          .returning();\n        history = updated;\n      } else {\n        // Insert new entry\n        const [inserted] = await db.insert(chartHistory).values({\n          userId,\n          sessionId,\n          symbol,\n          timeframe,\n          customStartDate,\n          customEndDate,\n          dividendAdjusted: dividendAdjusted || false,\n          csvOverlay: csvOverlay || null,\n          comparisonTickers: comparisonTickers || null,\n          annotations: annotations || []\n        }).returning();\n        history = inserted;\n      }\n      \n      res.json(history);\n    } catch (error) {\n      console.error(\"Error saving chart history:\", error);\n      res.status(500).json({ message: \"Failed to save chart history\" });\n    }\n  });\n\n  // Get recent chart history (limit 50, ordered by most recent, filtered by user)\n  app.get(\"/api/chart-history\", requireAuth, async (req: any, res) => {\n    try {\n      const limit = parseInt(req.query.limit as string) || 50;\n      const userId = req.userId;\n      \n      if (!userId) {\n        return res.status(401).json({ message: \"User not authenticated\" });\n      }\n      \n      const history = await db\n        .select()\n        .from(chartHistory)\n        .where(eq(chartHistory.userId, userId))\n        .orderBy(desc(chartHistory.savedAt))\n        .limit(limit);\n      \n      res.json(history);\n    } catch (error) {\n      console.error(\"Error fetching chart history:\", error);\n      res.status(500).json({ message: \"Failed to fetch chart history\" });\n    }\n  });\n\n  // Delete individual chart history entry\n  app.delete(\"/api/chart-history/:id\", requireAuth, async (req: any, res) => {\n    try {\n      const id = parseInt(req.params.id);\n      const userId = req.userId;\n      \n      if (!userId) {\n        return res.status(401).json({ message: \"User not authenticated\" });\n      }\n      \n      if (isNaN(id)) {\n        return res.status(400).json({ message: \"Invalid chart history ID\" });\n      }\n      \n      // Delete only if it belongs to the authenticated user\n      await db\n        .delete(chartHistory)\n        .where(and(\n          eq(chartHistory.id, id),\n          eq(chartHistory.userId, userId)\n        ));\n      \n      res.json({ success: true, message: \"Chart history entry deleted\" });\n    } catch (error) {\n      console.error(\"Error deleting chart history entry:\", error);\n      res.status(500).json({ message: \"Failed to delete chart history entry\" });\n    }\n  });\n\n  // Delete all chart history entries for authenticated user\n  app.delete(\"/api/chart-history\", requireAuth, async (req: any, res) => {\n    try {\n      const userId = req.userId;\n      \n      if (!userId) {\n        return res.status(401).json({ message: \"User not authenticated\" });\n      }\n      \n      // Delete all entries for this user\n      await db\n        .delete(chartHistory)\n        .where(eq(chartHistory.userId, userId));\n      \n      res.json({ success: true, message: \"All chart history entries deleted\" });\n    } catch (error) {\n      console.error(\"Error deleting all chart history:\", error);\n      res.status(500).json({ message: \"Failed to delete chart history\" });\n    }\n  });\n\n  // Compare Chart History Routes\n  \n  // Save or update compare chart history\n  app.post(\"/api/compare-chart-history\", requireAuth, async (req: any, res) => {\n    try {\n      const userId = req.userId;\n      \n      if (!userId) {\n        return res.status(401).json({ message: \"User not authenticated\" });\n      }\n      \n      const { sessionId, timeframe, customStartDate, customEndDate, tickers, annotations } = req.body;\n      \n      // Check if entry exists for this session\n      const existing = await db\n        .select()\n        .from(compareChartHistory)\n        .where(and(\n          eq(compareChartHistory.userId, userId),\n          eq(compareChartHistory.sessionId, sessionId)\n        ))\n        .limit(1);\n      \n      if (existing.length > 0) {\n        // Update existing entry\n        await db\n          .update(compareChartHistory)\n          .set({\n            timeframe,\n            customStartDate,\n            customEndDate,\n            tickers: tickers || [],\n            annotations: annotations || [],\n            updatedAt: new Date(),\n          })\n          .where(and(\n            eq(compareChartHistory.userId, userId),\n            eq(compareChartHistory.sessionId, sessionId)\n          ));\n        res.json({ success: true, message: \"Compare chart history updated\" });\n      } else {\n        // Insert new entry\n        const [inserted] = await db.insert(compareChartHistory).values({\n          userId,\n          sessionId,\n          timeframe,\n          customStartDate,\n          customEndDate,\n          tickers: tickers || [],\n          annotations: annotations || [],\n        }).returning();\n        res.json({ success: true, message: \"Compare chart history saved\", entry: inserted });\n      }\n    } catch (error) {\n      console.error(\"Error saving compare chart history:\", error);\n      res.status(500).json({ message: \"Failed to save compare chart history\" });\n    }\n  });\n  \n  // Get all compare chart history for authenticated user\n  app.get(\"/api/compare-chart-history\", requireAuth, async (req: any, res) => {\n    try {\n      const userId = req.userId;\n      \n      if (!userId) {\n        return res.status(401).json({ message: \"User not authenticated\" });\n      }\n      \n      const history = await db\n        .select()\n        .from(compareChartHistory)\n        .where(eq(compareChartHistory.userId, userId))\n        .orderBy(desc(compareChartHistory.savedAt))\n        .limit(50);\n      \n      res.json(history);\n    } catch (error) {\n      console.error(\"Error fetching compare chart history:\", error);\n      res.status(500).json({ message: \"Failed to fetch compare chart history\" });\n    }\n  });\n  \n  // Delete a specific compare chart history entry\n  app.delete(\"/api/compare-chart-history/:id\", requireAuth, async (req: any, res) => {\n    try {\n      const userId = req.userId;\n      const id = parseInt(req.params.id);\n      \n      if (!userId) {\n        return res.status(401).json({ message: \"User not authenticated\" });\n      }\n      \n      if (isNaN(id)) {\n        return res.status(400).json({ message: \"Invalid entry ID\" });\n      }\n      \n      await db\n        .delete(compareChartHistory)\n        .where(and(\n          eq(compareChartHistory.id, id),\n          eq(compareChartHistory.userId, userId)\n        ));\n      \n      res.json({ success: true, message: \"Compare chart history entry deleted\" });\n    } catch (error) {\n      console.error(\"Error deleting compare chart history entry:\", error);\n      res.status(500).json({ message: \"Failed to delete compare chart history entry\" });\n    }\n  });\n  \n  // Delete all compare chart history entries for authenticated user\n  app.delete(\"/api/compare-chart-history\", requireAuth, async (req: any, res) => {\n    try {\n      const userId = req.userId;\n      \n      if (!userId) {\n        return res.status(401).json({ message: \"User not authenticated\" });\n      }\n      \n      await db\n        .delete(compareChartHistory)\n        .where(eq(compareChartHistory.userId, userId));\n      \n      res.json({ success: true, message: \"All compare chart history entries deleted\" });\n    } catch (error) {\n      console.error(\"Error deleting all compare chart history:\", error);\n      res.status(500).json({ message: \"Failed to delete compare chart history\" });\n    }\n  });\n\n  // AI Co-Pilot Routes\n\n  // Initialize OpenAI client with Replit AI Integrations\n  const openai = new OpenAI({\n    apiKey: process.env.AI_INTEGRATIONS_OPENAI_API_KEY,\n    baseURL: process.env.AI_INTEGRATIONS_OPENAI_BASE_URL,\n  });\n\n  // Create or get chat session\n  app.post(\"/api/ai-copilot/session\", requireAuth, async (req, res) => {\n    try {\n      const userId = req.userId;\n      if (!userId) {\n        return res.status(401).json({ message: \"User not authenticated\" });\n      }\n      \n      const sessionId = randomUUID();\n      const [chat] = await db.insert(aiCopilotChats).values({ \n        userId,\n        sessionId \n      }).returning();\n      res.json(chat);\n    } catch (error) {\n      console.error(\"Error creating AI chat session:\", error);\n      res.status(500).json({ message: \"Failed to create chat session\" });\n    }\n  });\n\n  // Upload CSV\n  app.post(\"/api/ai-copilot/upload\", requireAuth, multer({ storage: multer.memoryStorage() }).single('file'), async (req, res) => {\n    try {\n      const chatId = parseInt(req.body.chatId);\n      const file = req.file;\n\n      if (!file) {\n        return res.status(400).json({ message: \"No file uploaded\" });\n      }\n\n      const csvData = file.buffer.toString('utf-8');\n      \n      // Parse CSV into array of objects\n      const lines = csvData.split('\\n').filter(line => line.trim());\n      const headers = lines[0].split(',').map(h => h.trim());\n      \n      const parsedData = lines.slice(1).map(line => {\n        const values = line.split(',');\n        const obj: any = {};\n        headers.forEach((header, i) => {\n          obj[header] = values[i]?.trim() || '';\n        });\n        return obj;\n      });\n\n      const [upload] = await db.insert(aiCopilotUploads).values({\n        chatId,\n        filename: file.originalname,\n        csvData,\n        parsedData,\n      }).returning();\n\n      res.json(upload);\n    } catch (error) {\n      console.error(\"Error uploading CSV:\", error);\n      res.status(500).json({ message: \"Failed to upload CSV\" });\n    }\n  });\n\n  // Send message and get AI response\n  app.post(\"/api/ai-copilot/chat\", requireAuth, async (req, res) => {\n    try {\n      const { chatId, message } = req.body;\n\n      // Save user message\n      await db.insert(aiCopilotMessages).values({\n        chatId,\n        role: 'user',\n        content: message,\n      });\n\n      // Get uploaded CSV data for context\n      const uploads = await db.select().from(aiCopilotUploads).where(eq(aiCopilotUploads.chatId, chatId));\n      \n      // Detect if this is a price chart overlay request\n      const isPriceChartOverlay = message.includes('Stock:') && message.includes('editing a price chart');\n      \n      let systemPrompt = '';\n      \n      if (isPriceChartOverlay) {\n        // System prompt for price chart overlays\n        systemPrompt = `You are an AI Copilot embedded inside a price chart editing tool. Your output must directly control the chart, not just describe it.\n\nYour response must be a valid JSON object with this structure:\n{\n  \"description\": \"Brief description of what you're adding (1-2 sentences)\",\n  \"chartConfig\": {\n    \"type\": \"timeseries\",\n    \"title\": \"Overlay name (e.g., 'Conviction Score', 'Custom Indicator')\",\n    \"data\": [\n      {\"timestamp\": \"2025-06-06\", \"value\": 2.55},\n      {\"timestamp\": \"2025-06-09\", \"value\": 3.25},\n      ...\n    ],\n    \"style\": {\n      \"color\": \"#FFFFFF\",\n      \"strokeWidth\": 2,\n      \"dashArray\": \"5 5\"\n    }\n  }\n}\n\nCRITICAL RULES:\n- Your ENTIRE response must be valid JSON\n- NEVER describe or summarize the chart - return explicit data points\n- If user provides data, return ALL data points exactly as given (do not summarize or skip)\n- Timestamps can be in ISO format (\"2025-06-06\") or Unix milliseconds\n- Values should be numbers (percentages like \"2.55%\" should be returned as 2.55)\n- All numbers MUST have a leading digit (use 0.85, never .85)\n- NO comments in JSON, NO trailing commas, use double quotes for all strings\n- The data array should contain all data points the user provided or requested\n\nBrand Colors (use in order):\nWhite: #FFFFFF, Cyan: #5AF5FA, Yellow: #FAFF50, Purple: #AA99FF, Green: #50FFA5, Pink: #FF6B9D, Orange: #FFA500\n\nWhen user asks to add an overlay or provides date/value data:\n1. Parse ALL the data points\n2. Return them in the exact format shown above\n3. Do NOT summarize, skip, or describe - return the actual data`;\n      } else {\n        // System prompt for standalone chart creation\n        systemPrompt = `You are an AI chart-making assistant that responds ONLY with valid JSON.\n\nYour response must be a valid JSON object with this structure:\n{\n  \"description\": \"Brief description of the chart (1-2 sentences)\",\n  \"chartConfig\": {\n    \"type\": \"bar\" | \"line\" | \"pie\" | \"area\",\n    \"title\": \"Chart title\",\n    \"data\": [array of data objects],\n    \"xKey\": \"key for x-axis\" (omit for pie charts),\n    \"yKeys\": [\"keys for y-axis values\"] (omit for pie charts),\n    \"colors\": [\"#5AF5FA\", \"#FFA5FF\", \"#AA99FF\", \"#FAFF50\", ...]\n  }\n}\n\nCRITICAL JSON RULES:\n- Your ENTIRE response must be valid JSON\n- Generate actual data based on the request\n- All numbers MUST have a leading digit (use 0.85, never .85)\n- NO comments in JSON\n- NO trailing commas\n- Use double quotes for all strings\n- For pie charts: omit xKey and yKeys, data should have name and value properties\n\nBrand Colors (use in order):\nPrimary: #5AF5FA (cyan), #FFA5FF (pink), #AA99FF (purple), #FAFF50 (yellow)\nSecondary: #0CB800 (green), #5294FF (violet), #FFA200 (tangerine), #9AFF75 (pea), #FF9999 (rose)\n\nGenerate the chart data directly. Do not explain what you would do, just provide the JSON response.`;\n      }\n\n      if (uploads.length > 0) {\n        const latestUpload = uploads[uploads.length - 1];\n        systemPrompt += `\\n\\nThe user has uploaded a CSV file: ${latestUpload.filename}\\nAll data from the CSV:\\n${JSON.stringify(latestUpload.parsedData, null, 2)}`;\n      }\n\n      // Get chat history\n      const history = await db.select().from(aiCopilotMessages)\n        .where(eq(aiCopilotMessages.chatId, chatId))\n        .orderBy(aiCopilotMessages.createdAt)\n        .limit(20);\n\n      const messages = [\n        { role: 'system' as const, content: systemPrompt },\n        ...history.slice(0, -1).map(m => ({ \n          role: m.role as 'user' | 'assistant', \n          content: m.content \n        })),\n        { role: 'user' as const, content: message }\n      ];\n\n      // Call OpenAI with JSON mode and increased token limit\n      const completion = await openai.chat.completions.create({\n        model: 'gpt-4o',\n        messages,\n        response_format: { type: 'json_object' },\n        max_tokens: 4096,\n      });\n\n      const assistantMessage = completion.choices[0].message.content || '';\n\n      // Parse the JSON response\n      let chartConfig = null;\n      let description = '';\n      \n      try {\n        const parsedResponse = JSON.parse(assistantMessage);\n        \n        if (parsedResponse.chartConfig) {\n          chartConfig = parsedResponse.chartConfig;\n          description = parsedResponse.description || '';\n          \n          // Validate required fields\n          if (!chartConfig.type || !chartConfig.title || !chartConfig.data || !Array.isArray(chartConfig.data)) {\n            console.error(\"Invalid chart config - missing required fields\");\n            chartConfig = null;\n          }\n        }\n      } catch (e) {\n        console.error(\"Failed to parse AI response as JSON:\", e);\n        console.error(\"Raw response:\", assistantMessage.substring(0, 500));\n        \n        // Fallback: try to extract JSON from code blocks (for backward compatibility)\n        const jsonMatch = assistantMessage.match(/```json\\s*([\\s\\S]*?)\\s*```/);\n        if (jsonMatch) {\n          try {\n            let jsonString = jsonMatch[1];\n            // Fix common JSON formatting issues\n            jsonString = jsonString.replace(/([:\\[\\s,])(-?)\\.(\\d+)/g, '$1$20.$3');\n            jsonString = jsonString.replace(/,(\\s*[\\]}])/g, '$1');\n            chartConfig = JSON.parse(jsonString);\n          } catch (fallbackError) {\n            console.error(\"Fallback JSON parsing also failed:\", fallbackError);\n          }\n        }\n      }\n\n      // Save assistant message with formatted content\n      const displayContent = description || \n        (chartConfig ? `I've created a ${chartConfig.type} chart: \"${chartConfig.title}\"` : \n         'I was unable to generate a valid chart. Please try rephrasing your request.');\n      \n      const [savedMessage] = await db.insert(aiCopilotMessages).values({\n        chatId,\n        role: 'assistant',\n        content: displayContent,\n        chartConfig,\n      }).returning();\n\n      res.json(savedMessage);\n    } catch (error) {\n      console.error(\"Error in AI chat:\", error);\n      res.status(500).json({ message: \"Failed to process chat message\" });\n    }\n  });\n\n  // Get chat history\n  app.get(\"/api/ai-copilot/messages/:chatId\", requireAuth, async (req, res) => {\n    try {\n      const chatId = parseInt(req.params.chatId);\n      const messages = await db.select().from(aiCopilotMessages)\n        .where(eq(aiCopilotMessages.chatId, chatId))\n        .orderBy(aiCopilotMessages.createdAt);\n      \n      res.json(messages);\n    } catch (error) {\n      console.error(\"Error fetching messages:\", error);\n      res.status(500).json({ message: \"Failed to fetch messages\" });\n    }\n  });\n\n  // Get all chart history for the authenticated user across all sessions\n  app.get(\"/api/ai-copilot/all-charts\", requireAuth, async (req, res) => {\n    try {\n      const userId = req.userId;\n      if (!userId) {\n        return res.status(401).json({ message: \"User not authenticated\" });\n      }\n\n      // Get all chats for this user\n      const userChats = await db.select({ id: aiCopilotChats.id })\n        .from(aiCopilotChats)\n        .where(eq(aiCopilotChats.userId, userId));\n      \n      const chatIds = userChats.map(chat => chat.id);\n      \n      if (chatIds.length === 0) {\n        return res.json([]);\n      }\n\n      // Get all messages with chartConfig from user's chats\n      const chartMessages = await db.select()\n        .from(aiCopilotMessages)\n        .where(\n          and(\n            inArray(aiCopilotMessages.chatId, chatIds),\n            sql`${aiCopilotMessages.chartConfig} IS NOT NULL`\n          )\n        )\n        .orderBy(desc(aiCopilotMessages.createdAt));\n      \n      res.json(chartMessages);\n    } catch (error) {\n      console.error(\"Error fetching all chart history:\", error);\n      res.status(500).json({ message: \"Failed to fetch chart history\" });\n    }\n  });\n\n  // Delete individual AI Co-Pilot message\n  app.delete(\"/api/ai-copilot/messages/:chatId/:messageId\", requireAuth, async (req, res) => {\n    try {\n      const userId = req.userId;\n      if (!userId) {\n        return res.status(401).json({ message: \"User not authenticated\" });\n      }\n      \n      const chatId = parseInt(req.params.chatId);\n      const messageId = parseInt(req.params.messageId);\n      \n      // Verify chat exists and belongs to authenticated user\n      const chat = await db.select().from(aiCopilotChats)\n        .where(\n          and(\n            eq(aiCopilotChats.id, chatId),\n            eq(aiCopilotChats.userId, userId)\n          )\n        )\n        .limit(1);\n      \n      if (chat.length === 0) {\n        return res.status(404).json({ message: \"Chat not found or access denied\" });\n      }\n      \n      // Verify the message belongs to the specified chat (security check)\n      await db.delete(aiCopilotMessages)\n        .where(\n          and(\n            eq(aiCopilotMessages.id, messageId),\n            eq(aiCopilotMessages.chatId, chatId)\n          )\n        );\n      \n      res.json({ success: true, message: \"Message deleted successfully\" });\n    } catch (error) {\n      console.error(\"Error deleting AI Co-Pilot message:\", error);\n      res.status(500).json({ message: \"Failed to delete message\" });\n    }\n  });\n\n  // Delete all messages with charts for a specific chat\n  app.delete(\"/api/ai-copilot/charts/:chatId\", requireAuth, async (req, res) => {\n    try {\n      const userId = req.userId;\n      if (!userId) {\n        return res.status(401).json({ message: \"User not authenticated\" });\n      }\n      \n      const chatId = parseInt(req.params.chatId);\n      \n      // Verify chat exists and belongs to authenticated user\n      const chat = await db.select().from(aiCopilotChats)\n        .where(\n          and(\n            eq(aiCopilotChats.id, chatId),\n            eq(aiCopilotChats.userId, userId)\n          )\n        )\n        .limit(1);\n      \n      if (chat.length === 0) {\n        return res.status(404).json({ message: \"Chat not found or access denied\" });\n      }\n      \n      // Delete associated uploads for this chat (cascade)\n      await db.delete(aiCopilotUploads)\n        .where(eq(aiCopilotUploads.chatId, chatId));\n      \n      // Delete all messages with chartConfig\n      await db.delete(aiCopilotMessages)\n        .where(\n          and(\n            eq(aiCopilotMessages.chatId, chatId),\n            sql`${aiCopilotMessages.chartConfig} IS NOT NULL`\n          )\n        );\n      \n      res.json({ success: true, message: \"All charts deleted successfully\" });\n    } catch (error) {\n      console.error(\"Error deleting all AI Co-Pilot charts:\", error);\n      res.status(500).json({ message: \"Failed to delete all charts\" });\n    }\n  });\n\n  // Health check endpoint\n  app.get(\"/api/health\", (req, res) => {\n    res.json({ \n      status: \"healthy\", \n      service: \"ChartMaker API\",\n      timestamp: new Date().toISOString() \n    });\n  });\n\n  // Create HTTP server\n  const httpServer = createServer(app);\n  return httpServer;\n}","path":null,"size_bytes":57779,"size_tokens":null},"client/src/components/ui/skeleton.tsx":{"content":"import { cn } from \"@/lib/utils\"\n\nfunction Skeleton({\n  className,\n  ...props\n}: React.HTMLAttributes<HTMLDivElement>) {\n  return (\n    <div\n      className={cn(\"animate-pulse rounded-md bg-muted\", className)}\n      {...props}\n    />\n  )\n}\n\nexport { Skeleton }\n","path":null,"size_bytes":261,"size_tokens":null},"client/src/components/ui/label.tsx":{"content":"import * as React from \"react\"\nimport * as LabelPrimitive from \"@radix-ui/react-label\"\nimport { cva, type VariantProps } from \"class-variance-authority\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst labelVariants = cva(\n  \"text-sm font-medium leading-none peer-disabled:cursor-not-allowed peer-disabled:opacity-70\"\n)\n\nconst Label = React.forwardRef<\n  React.ElementRef<typeof LabelPrimitive.Root>,\n  React.ComponentPropsWithoutRef<typeof LabelPrimitive.Root> &\n    VariantProps<typeof labelVariants>\n>(({ className, ...props }, ref) => (\n  <LabelPrimitive.Root\n    ref={ref}\n    className={cn(labelVariants(), className)}\n    {...props}\n  />\n))\nLabel.displayName = LabelPrimitive.Root.displayName\n\nexport { Label }\n","path":null,"size_bytes":710,"size_tokens":null},"server/slack.ts":{"content":"// Slack integration for feedback submissions\nimport { WebClient } from '@slack/web-api';\n\nconst slack = new WebClient(process.env.SLACK_BOT_TOKEN);\n\ninterface FeedbackParams {\n  name: string;\n  email: string;\n  message: string;\n  file?: {\n    content: Buffer;\n    filename: string;\n    mimetype: string;\n  };\n}\n\nexport async function sendFeedbackToSlack(params: FeedbackParams, channelId?: string): Promise<boolean> {\n  try {\n    if (!process.env.SLACK_BOT_TOKEN) {\n      console.error('SLACK_BOT_TOKEN environment variable is not set');\n      return false;\n    }\n\n    // Use environment channel ID or fallback to general\n    const targetChannel = channelId || process.env.SLACK_CHANNEL_ID || 'general';\n\n    // Create the message blocks for rich formatting\n    const blocks = [\n      {\n        type: 'header',\n        text: {\n          type: 'plain_text',\n          text: ' New Feedback - Intropic Chart Editor'\n        }\n      },\n      {\n        type: 'section',\n        fields: [\n          {\n            type: 'mrkdwn',\n            text: `*Name:*\\n${params.name}`\n          },\n          {\n            type: 'mrkdwn',\n            text: `*Email:*\\n${params.email}`\n          }\n        ]\n      },\n      {\n        type: 'section',\n        text: {\n          type: 'mrkdwn',\n          text: `*Message:*\\n${params.message}`\n        }\n      },\n      {\n        type: 'context',\n        elements: [\n          {\n            type: 'mrkdwn',\n            text: `Submitted from charteditor.app  ${new Date().toLocaleString()}`\n          }\n        ]\n      }\n    ];\n\n    // Send the main message\n    const result = await slack.chat.postMessage({\n      channel: targetChannel,\n      blocks: blocks,\n      text: `New feedback from ${params.name} (${params.email})` // Fallback text for notifications\n    });\n\n    // If there's a file attachment, upload it as a separate message\n    if (params.file && result.ts) {\n      try {\n        await slack.files.uploadV2({\n          channel_id: targetChannel,\n          file: params.file.content,\n          filename: params.file.filename,\n          title: `Attachment from ${params.name}`,\n          thread_ts: result.ts // Upload as a thread reply\n        });\n        console.log(` File attachment uploaded: ${params.file.filename}`);\n      } catch (fileError) {\n        console.error('Error uploading file to Slack:', fileError);\n        // Don't fail the entire operation if file upload fails\n      }\n    }\n\n    console.log(` Feedback sent to Slack channel ${targetChannel} from ${params.email}`);\n    return true;\n\n  } catch (error) {\n    console.error('Slack feedback error:', error);\n    return false;\n  }\n}","path":null,"size_bytes":2652,"size_tokens":null},"server/services/indexService.ts":{"content":"// Global Index Service for comprehensive index data from Finnhub\n// Handles both index constituents and real-time index price data\n\ninterface IndexInfo {\n  symbol: string;\n  name: string;\n  description: string;\n  country: string;\n  region: string;\n  type: 'Index';\n  currency: string;\n}\n\ninterface IndexQuote {\n  current: number;\n  change: number;\n  percentChange: number;\n  timestamp: number;\n}\n\ninterface IndexConstituents {\n  symbol: string;\n  constituents: string[];\n  count: number;\n}\n\n// Comprehensive global indices supported by Finnhub\nexport const GLOBAL_INDICES: Record<string, IndexInfo> = {\n  // United States Major Indices\n  '^GSPC': {\n    symbol: '^GSPC',\n    name: 'S&P 500',\n    description: 'Standard & Poor\\'s 500 Index',\n    country: 'United States',\n    region: 'North America',\n    type: 'Index',\n    currency: 'USD'\n  },\n  '^DJI': {\n    symbol: '^DJI', \n    name: 'Dow Jones Industrial Average',\n    description: 'Dow Jones Industrial Average',\n    country: 'United States',\n    region: 'North America',\n    type: 'Index',\n    currency: 'USD'\n  },\n  'QQQ': {\n    symbol: 'QQQ',\n    name: 'NASDAQ Composite (QQQ)',\n    description: 'NASDAQ Composite (QQQ ETF)',\n    country: 'United States',\n    region: 'North America',\n    type: 'Index',\n    currency: 'USD'\n  },\n  '^RUT': {\n    symbol: '^RUT',\n    name: 'Russell 2000',\n    description: 'Russell 2000 Small Cap Index',\n    country: 'United States',\n    region: 'North America',\n    type: 'Index',\n    currency: 'USD'\n  },\n\n  // European Indices\n  '^FTSE': {\n    symbol: '^FTSE',\n    name: 'FTSE 100',\n    description: 'Financial Times Stock Exchange 100 Index',\n    country: 'United Kingdom',\n    region: 'Europe',\n    type: 'Index',\n    currency: 'GBP'\n  },\n  '^GDAXI': {\n    symbol: '^GDAXI',\n    name: 'DAX',\n    description: 'Deutscher Aktienindex',\n    country: 'Germany',\n    region: 'Europe',\n    type: 'Index',\n    currency: 'EUR'\n  },\n  '^FCHI': {\n    symbol: '^FCHI',\n    name: 'CAC 40',\n    description: 'Cotation Assiste en Continu',\n    country: 'France',\n    region: 'Europe',\n    type: 'Index',\n    currency: 'EUR'\n  },\n  '^STOXX': {\n    symbol: '^STOXX',\n    name: 'Euro STOXX 50',\n    description: 'Euro STOXX 50 Index',\n    country: 'European Union',\n    region: 'Europe',\n    type: 'Index',\n    currency: 'EUR'\n  },\n  '^AEX': {\n    symbol: '^AEX',\n    name: 'AEX',\n    description: 'Amsterdam Exchange Index',\n    country: 'Netherlands',\n    region: 'Europe',\n    type: 'Index',\n    currency: 'EUR'\n  },\n  '^IBEX': {\n    symbol: '^IBEX',\n    name: 'IBEX 35',\n    description: 'ndice Burstil Espaol',\n    country: 'Spain',\n    region: 'Europe',\n    type: 'Index',\n    currency: 'EUR'\n  },\n  '^MIB': {\n    symbol: '^MIB',\n    name: 'FTSE MIB',\n    description: 'Financial Times Stock Exchange Milano Italia Borsa',\n    country: 'Italy',\n    region: 'Europe',\n    type: 'Index',\n    currency: 'EUR'\n  },\n  '^SMI': {\n    symbol: '^SMI',\n    name: 'Swiss Market Index',\n    description: 'Swiss Market Index',\n    country: 'Switzerland',\n    region: 'Europe',\n    type: 'Index',\n    currency: 'CHF'\n  },\n\n  // Asia Pacific Indices\n  '^N225': {\n    symbol: '^N225',\n    name: 'Nikkei 225',\n    description: 'Nikkei Stock Average',\n    country: 'Japan',\n    region: 'Asia Pacific',\n    type: 'Index',\n    currency: 'JPY'\n  },\n  '^HSI': {\n    symbol: '^HSI',\n    name: 'Hang Seng',\n    description: 'Hang Seng Index',\n    country: 'Hong Kong',\n    region: 'Asia Pacific',\n    type: 'Index',\n    currency: 'HKD'\n  },\n  '^AORD': {\n    symbol: '^AORD',\n    name: 'All Ordinaries',\n    description: 'All Ordinaries Index',\n    country: 'Australia',\n    region: 'Asia Pacific',\n    type: 'Index',\n    currency: 'AUD'\n  },\n  '^KOSPI': {\n    symbol: '^KOSPI',\n    name: 'KOSPI',\n    description: 'Korea Composite Stock Price Index',\n    country: 'South Korea',\n    region: 'Asia Pacific',\n    type: 'Index',\n    currency: 'KRW'\n  },\n\n  // Other Global Indices\n  '^GSPTSE': {\n    symbol: '^GSPTSE',\n    name: 'TSX Composite',\n    description: 'S&P/TSX Composite Index',\n    country: 'Canada',\n    region: 'North America',\n    type: 'Index',\n    currency: 'CAD'\n  },\n  '^BVSP': {\n    symbol: '^BVSP',\n    name: 'BOVESPA',\n    description: 'ndice Bovespa',\n    country: 'Brazil',\n    region: 'South America',\n    type: 'Index',\n    currency: 'BRL'\n  },\n  '^MXX': {\n    symbol: '^MXX',\n    name: 'IPC Mexico',\n    description: 'ndice de Precios y Cotizaciones',\n    country: 'Mexico',\n    region: 'North America',\n    type: 'Index',\n    currency: 'MXN'\n  }\n};\n\nexport class IndexService {\n  private finnhubApiKey: string;\n\n  constructor() {\n    this.finnhubApiKey = process.env.FINNHUB_API_KEY || '';\n  }\n\n  private async makeRequest(endpoint: string): Promise<any> {\n    const url = `https://finnhub.io/api/v1${endpoint}&token=${this.finnhubApiKey}`;\n    const response = await fetch(url);\n    \n    if (!response.ok) {\n      throw new Error(`Finnhub API error: ${response.status}`);\n    }\n    \n    return await response.json();\n  }\n\n  /**\n   * Get real-time index quote data\n   */\n  async getIndexQuote(symbol: string): Promise<IndexQuote | null> {\n    try {\n      const quote = await this.makeRequest(`/quote?symbol=${encodeURIComponent(symbol)}`);\n      \n      if (!quote || typeof quote.c !== 'number') {\n        return null;\n      }\n      \n      return {\n        current: quote.c,\n        change: quote.d || 0,\n        percentChange: quote.dp || 0,\n        timestamp: Date.now()\n      };\n    } catch (error) {\n      console.error(`Error fetching index quote for ${symbol}:`, error);\n      return null;\n    }\n  }\n\n  /**\n   * Get index constituents (stocks in the index)\n   */\n  async getIndexConstituents(symbol: string): Promise<IndexConstituents | null> {\n    try {\n      const data = await this.makeRequest(`/index/constituents?symbol=${encodeURIComponent(symbol)}`);\n      \n      if (!data || !Array.isArray(data.constituents)) {\n        return null;\n      }\n      \n      return {\n        symbol,\n        constituents: data.constituents,\n        count: data.constituents.length\n      };\n    } catch (error) {\n      console.error(`Error fetching index constituents for ${symbol}:`, error);\n      return null;\n    }\n  }\n\n  /**\n   * Search indices by name or symbol\n   */\n  searchIndices(query: string): IndexInfo[] {\n    const searchTerm = query.toLowerCase();\n    \n    return Object.values(GLOBAL_INDICES).filter(index => \n      index.name.toLowerCase().includes(searchTerm) ||\n      index.symbol.toLowerCase().includes(searchTerm) ||\n      index.description.toLowerCase().includes(searchTerm) ||\n      index.country.toLowerCase().includes(searchTerm)\n    ).slice(0, 10); // Limit to 10 results\n  }\n\n  /**\n   * Get all supported indices\n   */\n  getAllIndices(): IndexInfo[] {\n    return Object.values(GLOBAL_INDICES);\n  }\n\n  /**\n   * Get indices by region\n   */\n  getIndicesByRegion(region: string): IndexInfo[] {\n    return Object.values(GLOBAL_INDICES).filter(index => \n      index.region.toLowerCase() === region.toLowerCase()\n    );\n  }\n\n  /**\n   * Get detailed index information with price and constituents\n   */\n  async getDetailedIndexInfo(symbol: string): Promise<any> {\n    const indexInfo = GLOBAL_INDICES[symbol];\n    \n    if (!indexInfo) {\n      return null;\n    }\n\n    try {\n      const [quote, constituents] = await Promise.all([\n        this.getIndexQuote(symbol),\n        this.getIndexConstituents(symbol)\n      ]);\n\n      return {\n        ...indexInfo,\n        quote,\n        constituents: constituents?.constituents || [],\n        constituentCount: constituents?.count || 0,\n        lastUpdated: new Date().toISOString()\n      };\n    } catch (error) {\n      console.error(`Error fetching detailed index info for ${symbol}:`, error);\n      return null;\n    }\n  }\n}\n\nexport const indexService = new IndexService();","path":null,"size_bytes":7823,"size_tokens":null},"client/src/components/ui/pagination.tsx":{"content":"import * as React from \"react\"\nimport { ChevronLeft, ChevronRight, MoreHorizontal } from \"lucide-react\"\n\nimport { cn } from \"@/lib/utils\"\nimport { ButtonProps, buttonVariants } from \"@/components/ui/button\"\n\nconst Pagination = ({ className, ...props }: React.ComponentProps<\"nav\">) => (\n  <nav\n    role=\"navigation\"\n    aria-label=\"pagination\"\n    className={cn(\"mx-auto flex w-full justify-center\", className)}\n    {...props}\n  />\n)\nPagination.displayName = \"Pagination\"\n\nconst PaginationContent = React.forwardRef<\n  HTMLUListElement,\n  React.ComponentProps<\"ul\">\n>(({ className, ...props }, ref) => (\n  <ul\n    ref={ref}\n    className={cn(\"flex flex-row items-center gap-1\", className)}\n    {...props}\n  />\n))\nPaginationContent.displayName = \"PaginationContent\"\n\nconst PaginationItem = React.forwardRef<\n  HTMLLIElement,\n  React.ComponentProps<\"li\">\n>(({ className, ...props }, ref) => (\n  <li ref={ref} className={cn(\"\", className)} {...props} />\n))\nPaginationItem.displayName = \"PaginationItem\"\n\ntype PaginationLinkProps = {\n  isActive?: boolean\n} & Pick<ButtonProps, \"size\"> &\n  React.ComponentProps<\"a\">\n\nconst PaginationLink = ({\n  className,\n  isActive,\n  size = \"icon\",\n  ...props\n}: PaginationLinkProps) => (\n  <a\n    aria-current={isActive ? \"page\" : undefined}\n    className={cn(\n      buttonVariants({\n        variant: isActive ? \"outline\" : \"ghost\",\n        size,\n      }),\n      className\n    )}\n    {...props}\n  />\n)\nPaginationLink.displayName = \"PaginationLink\"\n\nconst PaginationPrevious = ({\n  className,\n  ...props\n}: React.ComponentProps<typeof PaginationLink>) => (\n  <PaginationLink\n    aria-label=\"Go to previous page\"\n    size=\"default\"\n    className={cn(\"gap-1 pl-2.5\", className)}\n    {...props}\n  >\n    <ChevronLeft className=\"h-4 w-4\" />\n    <span>Previous</span>\n  </PaginationLink>\n)\nPaginationPrevious.displayName = \"PaginationPrevious\"\n\nconst PaginationNext = ({\n  className,\n  ...props\n}: React.ComponentProps<typeof PaginationLink>) => (\n  <PaginationLink\n    aria-label=\"Go to next page\"\n    size=\"default\"\n    className={cn(\"gap-1 pr-2.5\", className)}\n    {...props}\n  >\n    <span>Next</span>\n    <ChevronRight className=\"h-4 w-4\" />\n  </PaginationLink>\n)\nPaginationNext.displayName = \"PaginationNext\"\n\nconst PaginationEllipsis = ({\n  className,\n  ...props\n}: React.ComponentProps<\"span\">) => (\n  <span\n    aria-hidden\n    className={cn(\"flex h-9 w-9 items-center justify-center\", className)}\n    {...props}\n  >\n    <MoreHorizontal className=\"h-4 w-4\" />\n    <span className=\"sr-only\">More pages</span>\n  </span>\n)\nPaginationEllipsis.displayName = \"PaginationEllipsis\"\n\nexport {\n  Pagination,\n  PaginationContent,\n  PaginationEllipsis,\n  PaginationItem,\n  PaginationLink,\n  PaginationNext,\n  PaginationPrevious,\n}\n","path":null,"size_bytes":2751,"size_tokens":null},"client/src/components/ui/sidebar.tsx":{"content":"import * as React from \"react\"\nimport { Slot } from \"@radix-ui/react-slot\"\nimport { VariantProps, cva } from \"class-variance-authority\"\nimport { PanelLeft } from \"lucide-react\"\n\nimport { useIsMobile } from \"@/hooks/use-mobile\"\nimport { cn } from \"@/lib/utils\"\nimport { Button } from \"@/components/ui/button\"\nimport { Input } from \"@/components/ui/input\"\nimport { Separator } from \"@/components/ui/separator\"\nimport {\n  Sheet,\n  SheetContent,\n  SheetDescription,\n  SheetHeader,\n  SheetTitle,\n} from \"@/components/ui/sheet\"\nimport { Skeleton } from \"@/components/ui/skeleton\"\nimport {\n  Tooltip,\n  TooltipContent,\n  TooltipProvider,\n  TooltipTrigger,\n} from \"@/components/ui/tooltip\"\n\nconst SIDEBAR_COOKIE_NAME = \"sidebar_state\"\nconst SIDEBAR_COOKIE_MAX_AGE = 60 * 60 * 24 * 7\nconst SIDEBAR_WIDTH = \"16rem\"\nconst SIDEBAR_WIDTH_MOBILE = \"18rem\"\nconst SIDEBAR_WIDTH_ICON = \"3rem\"\nconst SIDEBAR_KEYBOARD_SHORTCUT = \"b\"\n\ntype SidebarContextProps = {\n  state: \"expanded\" | \"collapsed\"\n  open: boolean\n  setOpen: (open: boolean) => void\n  openMobile: boolean\n  setOpenMobile: (open: boolean) => void\n  isMobile: boolean\n  toggleSidebar: () => void\n}\n\nconst SidebarContext = React.createContext<SidebarContextProps | null>(null)\n\nfunction useSidebar() {\n  const context = React.useContext(SidebarContext)\n  if (!context) {\n    throw new Error(\"useSidebar must be used within a SidebarProvider.\")\n  }\n\n  return context\n}\n\nconst SidebarProvider = React.forwardRef<\n  HTMLDivElement,\n  React.ComponentProps<\"div\"> & {\n    defaultOpen?: boolean\n    open?: boolean\n    onOpenChange?: (open: boolean) => void\n  }\n>(\n  (\n    {\n      defaultOpen = true,\n      open: openProp,\n      onOpenChange: setOpenProp,\n      className,\n      style,\n      children,\n      ...props\n    },\n    ref\n  ) => {\n    const isMobile = useIsMobile()\n    const [openMobile, setOpenMobile] = React.useState(false)\n\n    // This is the internal state of the sidebar.\n    // We use openProp and setOpenProp for control from outside the component.\n    const [_open, _setOpen] = React.useState(defaultOpen)\n    const open = openProp ?? _open\n    const setOpen = React.useCallback(\n      (value: boolean | ((value: boolean) => boolean)) => {\n        const openState = typeof value === \"function\" ? value(open) : value\n        if (setOpenProp) {\n          setOpenProp(openState)\n        } else {\n          _setOpen(openState)\n        }\n\n        // This sets the cookie to keep the sidebar state.\n        document.cookie = `${SIDEBAR_COOKIE_NAME}=${openState}; path=/; max-age=${SIDEBAR_COOKIE_MAX_AGE}`\n      },\n      [setOpenProp, open]\n    )\n\n    // Helper to toggle the sidebar.\n    const toggleSidebar = React.useCallback(() => {\n      return isMobile\n        ? setOpenMobile((open) => !open)\n        : setOpen((open) => !open)\n    }, [isMobile, setOpen, setOpenMobile])\n\n    // Adds a keyboard shortcut to toggle the sidebar.\n    React.useEffect(() => {\n      const handleKeyDown = (event: KeyboardEvent) => {\n        if (\n          event.key === SIDEBAR_KEYBOARD_SHORTCUT &&\n          (event.metaKey || event.ctrlKey)\n        ) {\n          event.preventDefault()\n          toggleSidebar()\n        }\n      }\n\n      window.addEventListener(\"keydown\", handleKeyDown)\n      return () => window.removeEventListener(\"keydown\", handleKeyDown)\n    }, [toggleSidebar])\n\n    // We add a state so that we can do data-state=\"expanded\" or \"collapsed\".\n    // This makes it easier to style the sidebar with Tailwind classes.\n    const state = open ? \"expanded\" : \"collapsed\"\n\n    const contextValue = React.useMemo<SidebarContextProps>(\n      () => ({\n        state,\n        open,\n        setOpen,\n        isMobile,\n        openMobile,\n        setOpenMobile,\n        toggleSidebar,\n      }),\n      [state, open, setOpen, isMobile, openMobile, setOpenMobile, toggleSidebar]\n    )\n\n    return (\n      <SidebarContext.Provider value={contextValue}>\n        <TooltipProvider delayDuration={0}>\n          <div\n            style={\n              {\n                \"--sidebar-width\": SIDEBAR_WIDTH,\n                \"--sidebar-width-icon\": SIDEBAR_WIDTH_ICON,\n                ...style,\n              } as React.CSSProperties\n            }\n            className={cn(\n              \"group/sidebar-wrapper flex min-h-svh w-full has-[[data-variant=inset]]:bg-sidebar\",\n              className\n            )}\n            ref={ref}\n            {...props}\n          >\n            {children}\n          </div>\n        </TooltipProvider>\n      </SidebarContext.Provider>\n    )\n  }\n)\nSidebarProvider.displayName = \"SidebarProvider\"\n\nconst Sidebar = React.forwardRef<\n  HTMLDivElement,\n  React.ComponentProps<\"div\"> & {\n    side?: \"left\" | \"right\"\n    variant?: \"sidebar\" | \"floating\" | \"inset\"\n    collapsible?: \"offcanvas\" | \"icon\" | \"none\"\n  }\n>(\n  (\n    {\n      side = \"left\",\n      variant = \"sidebar\",\n      collapsible = \"offcanvas\",\n      className,\n      children,\n      ...props\n    },\n    ref\n  ) => {\n    const { isMobile, state, openMobile, setOpenMobile } = useSidebar()\n\n    if (collapsible === \"none\") {\n      return (\n        <div\n          className={cn(\n            \"flex h-full w-[--sidebar-width] flex-col bg-sidebar text-sidebar-foreground\",\n            className\n          )}\n          ref={ref}\n          {...props}\n        >\n          {children}\n        </div>\n      )\n    }\n\n    if (isMobile) {\n      return (\n        <Sheet open={openMobile} onOpenChange={setOpenMobile} {...props}>\n          <SheetContent\n            data-sidebar=\"sidebar\"\n            data-mobile=\"true\"\n            className=\"w-[--sidebar-width] bg-sidebar p-0 text-sidebar-foreground [&>button]:hidden\"\n            style={\n              {\n                \"--sidebar-width\": SIDEBAR_WIDTH_MOBILE,\n              } as React.CSSProperties\n            }\n            side={side}\n          >\n            <SheetHeader className=\"sr-only\">\n              <SheetTitle>Sidebar</SheetTitle>\n              <SheetDescription>Displays the mobile sidebar.</SheetDescription>\n            </SheetHeader>\n            <div className=\"flex h-full w-full flex-col\">{children}</div>\n          </SheetContent>\n        </Sheet>\n      )\n    }\n\n    return (\n      <div\n        ref={ref}\n        className=\"group peer hidden text-sidebar-foreground md:block\"\n        data-state={state}\n        data-collapsible={state === \"collapsed\" ? collapsible : \"\"}\n        data-variant={variant}\n        data-side={side}\n      >\n        {/* This is what handles the sidebar gap on desktop */}\n        <div\n          className={cn(\n            \"relative w-[--sidebar-width] bg-transparent transition-[width] duration-200 ease-linear\",\n            \"group-data-[collapsible=offcanvas]:w-0\",\n            \"group-data-[side=right]:rotate-180\",\n            variant === \"floating\" || variant === \"inset\"\n              ? \"group-data-[collapsible=icon]:w-[calc(var(--sidebar-width-icon)_+_theme(spacing.4))]\"\n              : \"group-data-[collapsible=icon]:w-[--sidebar-width-icon]\"\n          )}\n        />\n        <div\n          className={cn(\n            \"fixed inset-y-0 z-10 hidden h-svh w-[--sidebar-width] transition-[left,right,width] duration-200 ease-linear md:flex\",\n            side === \"left\"\n              ? \"left-0 group-data-[collapsible=offcanvas]:left-[calc(var(--sidebar-width)*-1)]\"\n              : \"right-0 group-data-[collapsible=offcanvas]:right-[calc(var(--sidebar-width)*-1)]\",\n            // Adjust the padding for floating and inset variants.\n            variant === \"floating\" || variant === \"inset\"\n              ? \"p-2 group-data-[collapsible=icon]:w-[calc(var(--sidebar-width-icon)_+_theme(spacing.4)_+2px)]\"\n              : \"group-data-[collapsible=icon]:w-[--sidebar-width-icon] group-data-[side=left]:border-r group-data-[side=right]:border-l\",\n            className\n          )}\n          {...props}\n        >\n          <div\n            data-sidebar=\"sidebar\"\n            className=\"flex h-full w-full flex-col bg-sidebar group-data-[variant=floating]:rounded-lg group-data-[variant=floating]:border group-data-[variant=floating]:border-sidebar-border group-data-[variant=floating]:shadow\"\n          >\n            {children}\n          </div>\n        </div>\n      </div>\n    )\n  }\n)\nSidebar.displayName = \"Sidebar\"\n\nconst SidebarTrigger = React.forwardRef<\n  React.ElementRef<typeof Button>,\n  React.ComponentProps<typeof Button>\n>(({ className, onClick, ...props }, ref) => {\n  const { toggleSidebar } = useSidebar()\n\n  return (\n    <Button\n      ref={ref}\n      data-sidebar=\"trigger\"\n      variant=\"ghost\"\n      size=\"icon\"\n      className={cn(\"h-7 w-7\", className)}\n      onClick={(event) => {\n        onClick?.(event)\n        toggleSidebar()\n      }}\n      {...props}\n    >\n      <PanelLeft />\n      <span className=\"sr-only\">Toggle Sidebar</span>\n    </Button>\n  )\n})\nSidebarTrigger.displayName = \"SidebarTrigger\"\n\nconst SidebarRail = React.forwardRef<\n  HTMLButtonElement,\n  React.ComponentProps<\"button\">\n>(({ className, ...props }, ref) => {\n  const { toggleSidebar } = useSidebar()\n\n  return (\n    <button\n      ref={ref}\n      data-sidebar=\"rail\"\n      aria-label=\"Toggle Sidebar\"\n      tabIndex={-1}\n      onClick={toggleSidebar}\n      title=\"Toggle Sidebar\"\n      className={cn(\n        \"absolute inset-y-0 z-20 hidden w-4 -translate-x-1/2 transition-all ease-linear after:absolute after:inset-y-0 after:left-1/2 after:w-[2px] hover:after:bg-sidebar-border group-data-[side=left]:-right-4 group-data-[side=right]:left-0 sm:flex\",\n        \"[[data-side=left]_&]:cursor-w-resize [[data-side=right]_&]:cursor-e-resize\",\n        \"[[data-side=left][data-state=collapsed]_&]:cursor-e-resize [[data-side=right][data-state=collapsed]_&]:cursor-w-resize\",\n        \"group-data-[collapsible=offcanvas]:translate-x-0 group-data-[collapsible=offcanvas]:after:left-full group-data-[collapsible=offcanvas]:hover:bg-sidebar\",\n        \"[[data-side=left][data-collapsible=offcanvas]_&]:-right-2\",\n        \"[[data-side=right][data-collapsible=offcanvas]_&]:-left-2\",\n        className\n      )}\n      {...props}\n    />\n  )\n})\nSidebarRail.displayName = \"SidebarRail\"\n\nconst SidebarInset = React.forwardRef<\n  HTMLDivElement,\n  React.ComponentProps<\"main\">\n>(({ className, ...props }, ref) => {\n  return (\n    <main\n      ref={ref}\n      className={cn(\n        \"relative flex w-full flex-1 flex-col bg-background\",\n        \"md:peer-data-[variant=inset]:m-2 md:peer-data-[state=collapsed]:peer-data-[variant=inset]:ml-2 md:peer-data-[variant=inset]:ml-0 md:peer-data-[variant=inset]:rounded-xl md:peer-data-[variant=inset]:shadow\",\n        className\n      )}\n      {...props}\n    />\n  )\n})\nSidebarInset.displayName = \"SidebarInset\"\n\nconst SidebarInput = React.forwardRef<\n  React.ElementRef<typeof Input>,\n  React.ComponentProps<typeof Input>\n>(({ className, ...props }, ref) => {\n  return (\n    <Input\n      ref={ref}\n      data-sidebar=\"input\"\n      className={cn(\n        \"h-8 w-full bg-background shadow-none focus-visible:ring-2 focus-visible:ring-sidebar-ring\",\n        className\n      )}\n      {...props}\n    />\n  )\n})\nSidebarInput.displayName = \"SidebarInput\"\n\nconst SidebarHeader = React.forwardRef<\n  HTMLDivElement,\n  React.ComponentProps<\"div\">\n>(({ className, ...props }, ref) => {\n  return (\n    <div\n      ref={ref}\n      data-sidebar=\"header\"\n      className={cn(\"flex flex-col gap-2 p-2\", className)}\n      {...props}\n    />\n  )\n})\nSidebarHeader.displayName = \"SidebarHeader\"\n\nconst SidebarFooter = React.forwardRef<\n  HTMLDivElement,\n  React.ComponentProps<\"div\">\n>(({ className, ...props }, ref) => {\n  return (\n    <div\n      ref={ref}\n      data-sidebar=\"footer\"\n      className={cn(\"flex flex-col gap-2 p-2\", className)}\n      {...props}\n    />\n  )\n})\nSidebarFooter.displayName = \"SidebarFooter\"\n\nconst SidebarSeparator = React.forwardRef<\n  React.ElementRef<typeof Separator>,\n  React.ComponentProps<typeof Separator>\n>(({ className, ...props }, ref) => {\n  return (\n    <Separator\n      ref={ref}\n      data-sidebar=\"separator\"\n      className={cn(\"mx-2 w-auto bg-sidebar-border\", className)}\n      {...props}\n    />\n  )\n})\nSidebarSeparator.displayName = \"SidebarSeparator\"\n\nconst SidebarContent = React.forwardRef<\n  HTMLDivElement,\n  React.ComponentProps<\"div\">\n>(({ className, ...props }, ref) => {\n  return (\n    <div\n      ref={ref}\n      data-sidebar=\"content\"\n      className={cn(\n        \"flex min-h-0 flex-1 flex-col gap-2 overflow-auto group-data-[collapsible=icon]:overflow-hidden\",\n        className\n      )}\n      {...props}\n    />\n  )\n})\nSidebarContent.displayName = \"SidebarContent\"\n\nconst SidebarGroup = React.forwardRef<\n  HTMLDivElement,\n  React.ComponentProps<\"div\">\n>(({ className, ...props }, ref) => {\n  return (\n    <div\n      ref={ref}\n      data-sidebar=\"group\"\n      className={cn(\"relative flex w-full min-w-0 flex-col p-2\", className)}\n      {...props}\n    />\n  )\n})\nSidebarGroup.displayName = \"SidebarGroup\"\n\nconst SidebarGroupLabel = React.forwardRef<\n  HTMLDivElement,\n  React.ComponentProps<\"div\"> & { asChild?: boolean }\n>(({ className, asChild = false, ...props }, ref) => {\n  const Comp = asChild ? Slot : \"div\"\n\n  return (\n    <Comp\n      ref={ref}\n      data-sidebar=\"group-label\"\n      className={cn(\n        \"flex h-8 shrink-0 items-center rounded-md px-2 text-xs font-medium text-sidebar-foreground/70 outline-none ring-sidebar-ring transition-[margin,opacity] duration-200 ease-linear focus-visible:ring-2 [&>svg]:size-4 [&>svg]:shrink-0\",\n        \"group-data-[collapsible=icon]:-mt-8 group-data-[collapsible=icon]:opacity-0\",\n        className\n      )}\n      {...props}\n    />\n  )\n})\nSidebarGroupLabel.displayName = \"SidebarGroupLabel\"\n\nconst SidebarGroupAction = React.forwardRef<\n  HTMLButtonElement,\n  React.ComponentProps<\"button\"> & { asChild?: boolean }\n>(({ className, asChild = false, ...props }, ref) => {\n  const Comp = asChild ? Slot : \"button\"\n\n  return (\n    <Comp\n      ref={ref}\n      data-sidebar=\"group-action\"\n      className={cn(\n        \"absolute right-3 top-3.5 flex aspect-square w-5 items-center justify-center rounded-md p-0 text-sidebar-foreground outline-none ring-sidebar-ring transition-transform hover:bg-sidebar-accent hover:text-sidebar-accent-foreground focus-visible:ring-2 [&>svg]:size-4 [&>svg]:shrink-0\",\n        // Increases the hit area of the button on mobile.\n        \"after:absolute after:-inset-2 after:md:hidden\",\n        \"group-data-[collapsible=icon]:hidden\",\n        className\n      )}\n      {...props}\n    />\n  )\n})\nSidebarGroupAction.displayName = \"SidebarGroupAction\"\n\nconst SidebarGroupContent = React.forwardRef<\n  HTMLDivElement,\n  React.ComponentProps<\"div\">\n>(({ className, ...props }, ref) => (\n  <div\n    ref={ref}\n    data-sidebar=\"group-content\"\n    className={cn(\"w-full text-sm\", className)}\n    {...props}\n  />\n))\nSidebarGroupContent.displayName = \"SidebarGroupContent\"\n\nconst SidebarMenu = React.forwardRef<\n  HTMLUListElement,\n  React.ComponentProps<\"ul\">\n>(({ className, ...props }, ref) => (\n  <ul\n    ref={ref}\n    data-sidebar=\"menu\"\n    className={cn(\"flex w-full min-w-0 flex-col gap-1\", className)}\n    {...props}\n  />\n))\nSidebarMenu.displayName = \"SidebarMenu\"\n\nconst SidebarMenuItem = React.forwardRef<\n  HTMLLIElement,\n  React.ComponentProps<\"li\">\n>(({ className, ...props }, ref) => (\n  <li\n    ref={ref}\n    data-sidebar=\"menu-item\"\n    className={cn(\"group/menu-item relative\", className)}\n    {...props}\n  />\n))\nSidebarMenuItem.displayName = \"SidebarMenuItem\"\n\nconst sidebarMenuButtonVariants = cva(\n  \"peer/menu-button flex w-full items-center gap-2 overflow-hidden rounded-md p-2 text-left text-sm outline-none ring-sidebar-ring transition-[width,height,padding] hover:bg-sidebar-accent hover:text-sidebar-accent-foreground focus-visible:ring-2 active:bg-sidebar-accent active:text-sidebar-accent-foreground disabled:pointer-events-none disabled:opacity-50 group-has-[[data-sidebar=menu-action]]/menu-item:pr-8 aria-disabled:pointer-events-none aria-disabled:opacity-50 data-[active=true]:bg-sidebar-accent data-[active=true]:font-medium data-[active=true]:text-sidebar-accent-foreground data-[state=open]:hover:bg-sidebar-accent data-[state=open]:hover:text-sidebar-accent-foreground group-data-[collapsible=icon]:!size-8 group-data-[collapsible=icon]:!p-2 [&>span:last-child]:truncate [&>svg]:size-4 [&>svg]:shrink-0\",\n  {\n    variants: {\n      variant: {\n        default: \"hover:bg-sidebar-accent hover:text-sidebar-accent-foreground\",\n        outline:\n          \"bg-background shadow-[0_0_0_1px_hsl(var(--sidebar-border))] hover:bg-sidebar-accent hover:text-sidebar-accent-foreground hover:shadow-[0_0_0_1px_hsl(var(--sidebar-accent))]\",\n      },\n      size: {\n        default: \"h-8 text-sm\",\n        sm: \"h-7 text-xs\",\n        lg: \"h-12 text-sm group-data-[collapsible=icon]:!p-0\",\n      },\n    },\n    defaultVariants: {\n      variant: \"default\",\n      size: \"default\",\n    },\n  }\n)\n\nconst SidebarMenuButton = React.forwardRef<\n  HTMLButtonElement,\n  React.ComponentProps<\"button\"> & {\n    asChild?: boolean\n    isActive?: boolean\n    tooltip?: string | React.ComponentProps<typeof TooltipContent>\n  } & VariantProps<typeof sidebarMenuButtonVariants>\n>(\n  (\n    {\n      asChild = false,\n      isActive = false,\n      variant = \"default\",\n      size = \"default\",\n      tooltip,\n      className,\n      ...props\n    },\n    ref\n  ) => {\n    const Comp = asChild ? Slot : \"button\"\n    const { isMobile, state } = useSidebar()\n\n    const button = (\n      <Comp\n        ref={ref}\n        data-sidebar=\"menu-button\"\n        data-size={size}\n        data-active={isActive}\n        className={cn(sidebarMenuButtonVariants({ variant, size }), className)}\n        {...props}\n      />\n    )\n\n    if (!tooltip) {\n      return button\n    }\n\n    if (typeof tooltip === \"string\") {\n      tooltip = {\n        children: tooltip,\n      }\n    }\n\n    return (\n      <Tooltip>\n        <TooltipTrigger asChild>{button}</TooltipTrigger>\n        <TooltipContent\n          side=\"right\"\n          align=\"center\"\n          hidden={state !== \"collapsed\" || isMobile}\n          {...tooltip}\n        />\n      </Tooltip>\n    )\n  }\n)\nSidebarMenuButton.displayName = \"SidebarMenuButton\"\n\nconst SidebarMenuAction = React.forwardRef<\n  HTMLButtonElement,\n  React.ComponentProps<\"button\"> & {\n    asChild?: boolean\n    showOnHover?: boolean\n  }\n>(({ className, asChild = false, showOnHover = false, ...props }, ref) => {\n  const Comp = asChild ? Slot : \"button\"\n\n  return (\n    <Comp\n      ref={ref}\n      data-sidebar=\"menu-action\"\n      className={cn(\n        \"absolute right-1 top-1.5 flex aspect-square w-5 items-center justify-center rounded-md p-0 text-sidebar-foreground outline-none ring-sidebar-ring transition-transform hover:bg-sidebar-accent hover:text-sidebar-accent-foreground focus-visible:ring-2 peer-hover/menu-button:text-sidebar-accent-foreground [&>svg]:size-4 [&>svg]:shrink-0\",\n        // Increases the hit area of the button on mobile.\n        \"after:absolute after:-inset-2 after:md:hidden\",\n        \"peer-data-[size=sm]/menu-button:top-1\",\n        \"peer-data-[size=default]/menu-button:top-1.5\",\n        \"peer-data-[size=lg]/menu-button:top-2.5\",\n        \"group-data-[collapsible=icon]:hidden\",\n        showOnHover &&\n          \"group-focus-within/menu-item:opacity-100 group-hover/menu-item:opacity-100 data-[state=open]:opacity-100 peer-data-[active=true]/menu-button:text-sidebar-accent-foreground md:opacity-0\",\n        className\n      )}\n      {...props}\n    />\n  )\n})\nSidebarMenuAction.displayName = \"SidebarMenuAction\"\n\nconst SidebarMenuBadge = React.forwardRef<\n  HTMLDivElement,\n  React.ComponentProps<\"div\">\n>(({ className, ...props }, ref) => (\n  <div\n    ref={ref}\n    data-sidebar=\"menu-badge\"\n    className={cn(\n      \"pointer-events-none absolute right-1 flex h-5 min-w-5 select-none items-center justify-center rounded-md px-1 text-xs font-medium tabular-nums text-sidebar-foreground\",\n      \"peer-hover/menu-button:text-sidebar-accent-foreground peer-data-[active=true]/menu-button:text-sidebar-accent-foreground\",\n      \"peer-data-[size=sm]/menu-button:top-1\",\n      \"peer-data-[size=default]/menu-button:top-1.5\",\n      \"peer-data-[size=lg]/menu-button:top-2.5\",\n      \"group-data-[collapsible=icon]:hidden\",\n      className\n    )}\n    {...props}\n  />\n))\nSidebarMenuBadge.displayName = \"SidebarMenuBadge\"\n\nconst SidebarMenuSkeleton = React.forwardRef<\n  HTMLDivElement,\n  React.ComponentProps<\"div\"> & {\n    showIcon?: boolean\n  }\n>(({ className, showIcon = false, ...props }, ref) => {\n  // Random width between 50 to 90%.\n  const width = React.useMemo(() => {\n    return `${Math.floor(Math.random() * 40) + 50}%`\n  }, [])\n\n  return (\n    <div\n      ref={ref}\n      data-sidebar=\"menu-skeleton\"\n      className={cn(\"flex h-8 items-center gap-2 rounded-md px-2\", className)}\n      {...props}\n    >\n      {showIcon && (\n        <Skeleton\n          className=\"size-4 rounded-md\"\n          data-sidebar=\"menu-skeleton-icon\"\n        />\n      )}\n      <Skeleton\n        className=\"h-4 max-w-[--skeleton-width] flex-1\"\n        data-sidebar=\"menu-skeleton-text\"\n        style={\n          {\n            \"--skeleton-width\": width,\n          } as React.CSSProperties\n        }\n      />\n    </div>\n  )\n})\nSidebarMenuSkeleton.displayName = \"SidebarMenuSkeleton\"\n\nconst SidebarMenuSub = React.forwardRef<\n  HTMLUListElement,\n  React.ComponentProps<\"ul\">\n>(({ className, ...props }, ref) => (\n  <ul\n    ref={ref}\n    data-sidebar=\"menu-sub\"\n    className={cn(\n      \"mx-3.5 flex min-w-0 translate-x-px flex-col gap-1 border-l border-sidebar-border px-2.5 py-0.5\",\n      \"group-data-[collapsible=icon]:hidden\",\n      className\n    )}\n    {...props}\n  />\n))\nSidebarMenuSub.displayName = \"SidebarMenuSub\"\n\nconst SidebarMenuSubItem = React.forwardRef<\n  HTMLLIElement,\n  React.ComponentProps<\"li\">\n>(({ ...props }, ref) => <li ref={ref} {...props} />)\nSidebarMenuSubItem.displayName = \"SidebarMenuSubItem\"\n\nconst SidebarMenuSubButton = React.forwardRef<\n  HTMLAnchorElement,\n  React.ComponentProps<\"a\"> & {\n    asChild?: boolean\n    size?: \"sm\" | \"md\"\n    isActive?: boolean\n  }\n>(({ asChild = false, size = \"md\", isActive, className, ...props }, ref) => {\n  const Comp = asChild ? Slot : \"a\"\n\n  return (\n    <Comp\n      ref={ref}\n      data-sidebar=\"menu-sub-button\"\n      data-size={size}\n      data-active={isActive}\n      className={cn(\n        \"flex h-7 min-w-0 -translate-x-px items-center gap-2 overflow-hidden rounded-md px-2 text-sidebar-foreground outline-none ring-sidebar-ring hover:bg-sidebar-accent hover:text-sidebar-accent-foreground focus-visible:ring-2 active:bg-sidebar-accent active:text-sidebar-accent-foreground disabled:pointer-events-none disabled:opacity-50 aria-disabled:pointer-events-none aria-disabled:opacity-50 [&>span:last-child]:truncate [&>svg]:size-4 [&>svg]:shrink-0 [&>svg]:text-sidebar-accent-foreground\",\n        \"data-[active=true]:bg-sidebar-accent data-[active=true]:text-sidebar-accent-foreground\",\n        size === \"sm\" && \"text-xs\",\n        size === \"md\" && \"text-sm\",\n        \"group-data-[collapsible=icon]:hidden\",\n        className\n      )}\n      {...props}\n    />\n  )\n})\nSidebarMenuSubButton.displayName = \"SidebarMenuSubButton\"\n\nexport {\n  Sidebar,\n  SidebarContent,\n  SidebarFooter,\n  SidebarGroup,\n  SidebarGroupAction,\n  SidebarGroupContent,\n  SidebarGroupLabel,\n  SidebarHeader,\n  SidebarInput,\n  SidebarInset,\n  SidebarMenu,\n  SidebarMenuAction,\n  SidebarMenuBadge,\n  SidebarMenuButton,\n  SidebarMenuItem,\n  SidebarMenuSkeleton,\n  SidebarMenuSub,\n  SidebarMenuSubButton,\n  SidebarMenuSubItem,\n  SidebarProvider,\n  SidebarRail,\n  SidebarSeparator,\n  SidebarTrigger,\n  useSidebar,\n}\n","path":null,"size_bytes":23567,"size_tokens":null},"client/src/data/suffix-mappings.ts":{"content":"// Bloomberg-style ticker suffix mappings\n// This will be the data source for the suffix search tool\n\nimport { MarketHours } from '@/lib/marketHours';\n\nexport interface SuffixInfo {\n  suffix: string;\n  country: string;\n  exchange: string;\n  fullExchangeName: string;\n  notes?: string;\n  currency?: string;\n  marketHours?: MarketHours;\n}\n\nexport const suffixMappings: Record<string, SuffixInfo> = {\n  // United States\n  \".UW\": {\n    suffix: \".UW\",\n    country: \"United States\",\n    exchange: \"NASDAQ Global Select Market\",\n    fullExchangeName: \"NASDAQ Global Select Market\",\n    currency: \"USD\",\n    notes: \"Top tier of NASDAQ for large-cap companies with the most stringent listing requirements\",\n    marketHours: {\n      timezone: \"America/New_York\",\n      sessions: [{ open: \"09:30\", close: \"16:00\" }],\n      days: [1, 2, 3, 4, 5] // Monday to Friday\n    }\n  },\n  \".UF\": {\n    suffix: \".UF\",\n    country: \"United States\",\n    exchange: \"NASDAQ Global Market\",\n    fullExchangeName: \"NASDAQ Global Market\",\n    currency: \"USD\",\n    notes: \"Middle tier of NASDAQ for mid-cap companies with strict financial and liquidity requirements\",\n    marketHours: {\n      timezone: \"America/New_York\",\n      sessions: [{ open: \"09:30\", close: \"16:00\" }],\n      days: [1, 2, 3, 4, 5] // Monday to Friday\n    }\n  },\n  \".UQ\": {\n    suffix: \".UQ\",\n    country: \"United States\", \n    exchange: \"NASDAQ Capital Market\",\n    fullExchangeName: \"NASDAQ Capital Market\",\n    currency: \"USD\",\n    notes: \"NASDAQ Capital Market for smaller companies with less stringent listing requirements\"\n  },\n  \".UN\": {\n    suffix: \".UN\",\n    country: \"United States\",\n    exchange: \"NYSE\",\n    fullExchangeName: \"New York Stock Exchange\",\n    currency: \"USD\",\n    notes: \"NYSE-listed securities in Bloomberg terminal notation\",\n    marketHours: {\n      timezone: \"America/New_York\",\n      sessions: [{ open: \"09:30\", close: \"16:00\" }],\n      days: [1, 2, 3, 4, 5] // Monday to Friday\n    }\n  },\n\n  // Europe\n  \".SE\": {\n    suffix: \".SE\",\n    country: \"Sweden\",\n    exchange: \"OMX Stockholm\",\n    fullExchangeName: \"Nasdaq Stockholm (OMX Stockholm)\",\n    currency: \"SEK\",\n    notes: \"Swedish stocks listed on Nasdaq Stockholm\",\n    marketHours: {\n      timezone: \"Europe/Stockholm\",\n      sessions: [{ open: \"09:00\", close: \"17:30\" }],\n      days: [1, 2, 3, 4, 5] // Monday to Friday\n    }\n  },\n  \".MC\": {\n    suffix: \".MC\",\n    country: \"Spain\", \n    exchange: \"BME\",\n    fullExchangeName: \"Bolsas y Mercados Espaoles (Madrid Stock Exchange)\",\n    currency: \"EUR\",\n    notes: \"Spanish stocks listed on the Madrid Stock Exchange\",\n    marketHours: {\n      timezone: \"Europe/Madrid\",\n      sessions: [{ open: \"09:00\", close: \"17:30\" }],\n      days: [1, 2, 3, 4, 5] // Monday to Friday\n    }\n  },\n  \".PA\": {\n    suffix: \".PA\",\n    country: \"France\",\n    exchange: \"Euronext Paris\",\n    fullExchangeName: \"Euronext Paris\",\n    currency: \"EUR\",\n    notes: \"French stocks listed on Euronext Paris\",\n    marketHours: {\n      timezone: \"Europe/Paris\",\n      sessions: [{ open: \"09:00\", close: \"17:30\" }],\n      days: [1, 2, 3, 4, 5] // Monday to Friday\n    }\n  },\n  \".DE\": {\n    suffix: \".DE\",\n    country: \"Germany\",\n    exchange: \"XETRA\",\n    fullExchangeName: \"Deutsche Brse XETRA\",\n    currency: \"EUR\",\n    notes: \"German stocks listed on XETRA electronic trading system\"\n  },\n  \".L\": {\n    suffix: \".L\",\n    country: \"United Kingdom\",\n    exchange: \"LSE\",\n    fullExchangeName: \"London Stock Exchange\",\n    currency: \"GBP\",\n    notes: \"UK stocks listed on the London Stock Exchange\",\n    marketHours: {\n      timezone: \"Europe/London\",\n      sessions: [{ open: \"08:00\", close: \"16:30\" }],\n      days: [1, 2, 3, 4, 5] // Monday to Friday\n    }\n  },\n  \".AS\": {\n    suffix: \".AS\",\n    country: \"Netherlands\",\n    exchange: \"Euronext Amsterdam\", \n    fullExchangeName: \"Euronext Amsterdam\",\n    currency: \"EUR\",\n    notes: \"Dutch stocks listed on Euronext Amsterdam\"\n  },\n  \".SW\": {\n    suffix: \".SW\",\n    country: \"Switzerland\",\n    exchange: \"SIX\",\n    fullExchangeName: \"SIX Swiss Exchange\",\n    currency: \"CHF\",\n    notes: \"Swiss stocks listed on SIX Swiss Exchange\"\n  },\n  \".MI\": {\n    suffix: \".MI\",\n    country: \"Italy\",\n    exchange: \"Borsa Italiana\",\n    fullExchangeName: \"Borsa Italiana (Milan Stock Exchange)\",\n    currency: \"EUR\",\n    notes: \"Italian stocks listed on Borsa Italiana\"\n  },\n\n  // Asia Pacific\n  \".T\": {\n    suffix: \".T\",\n    country: \"Japan\",\n    exchange: \"TSE\",\n    fullExchangeName: \"Tokyo Stock Exchange\",\n    currency: \"JPY\",\n    notes: \"Japanese stocks listed on the Tokyo Stock Exchange\",\n    marketHours: {\n      timezone: \"Asia/Tokyo\",\n      sessions: [\n        { open: \"09:00\", close: \"11:30\" },\n        { open: \"12:30\", close: \"15:00\" }\n      ],\n      days: [1, 2, 3, 4, 5] // Monday to Friday\n    }\n  },\n  \".HK\": {\n    suffix: \".HK\",\n    country: \"Hong Kong\",\n    exchange: \"HKEX\",\n    fullExchangeName: \"Hong Kong Exchanges and Clearing\",\n    currency: \"HKD\",\n    notes: \"Hong Kong stocks listed on HKEX\",\n    marketHours: {\n      timezone: \"Asia/Hong_Kong\",\n      sessions: [\n        { open: \"09:30\", close: \"12:00\" },\n        { open: \"13:00\", close: \"16:00\" }\n      ],\n      days: [1, 2, 3, 4, 5] // Monday to Friday\n    }\n  },\n  \".SS\": {\n    suffix: \".SS\",\n    country: \"China\",\n    exchange: \"SSE\",\n    fullExchangeName: \"Shanghai Stock Exchange\",\n    currency: \"CNY\",\n    notes: \"Chinese A-shares listed on Shanghai Stock Exchange\"\n  },\n  \".SZ\": {\n    suffix: \".SZ\", \n    country: \"China\",\n    exchange: \"SZSE\",\n    fullExchangeName: \"Shenzhen Stock Exchange\",\n    currency: \"CNY\",\n    notes: \"Chinese A-shares listed on Shenzhen Stock Exchange\"\n  },\n  \".AX\": {\n    suffix: \".AX\",\n    country: \"Australia\",\n    exchange: \"ASX\",\n    fullExchangeName: \"Australian Securities Exchange\", \n    currency: \"AUD\",\n    notes: \"Australian stocks listed on the ASX\",\n    marketHours: {\n      timezone: \"Australia/Sydney\",\n      sessions: [{ open: \"10:00\", close: \"16:00\" }],\n      days: [1, 2, 3, 4, 5] // Monday to Friday\n    }\n  },\n  \".KS\": {\n    suffix: \".KS\",\n    country: \"South Korea\",\n    exchange: \"KOSPI\",\n    fullExchangeName: \"Korea Composite Stock Price Index\",\n    currency: \"KRW\",\n    notes: \"South Korean stocks listed on KOSPI\"\n  },\n\n  // Canada\n  \".TO\": {\n    suffix: \".TO\",\n    country: \"Canada\",\n    exchange: \"TSX\",\n    fullExchangeName: \"Toronto Stock Exchange\",\n    currency: \"CAD\",\n    notes: \"Canadian stocks listed on the Toronto Stock Exchange\",\n    marketHours: {\n      timezone: \"America/Toronto\",\n      sessions: [{ open: \"09:30\", close: \"16:00\" }],\n      days: [1, 2, 3, 4, 5] // Monday to Friday\n    }\n  },\n  \".V\": {\n    suffix: \".V\",\n    country: \"Canada\", \n    exchange: \"TSXV\",\n    fullExchangeName: \"TSX Venture Exchange\",\n    currency: \"CAD\",\n    notes: \"Canadian venture stocks listed on TSX Venture Exchange\"\n  },\n\n  // Nordic\n  \".NO\": {\n    suffix: \".NO\",\n    country: \"Norway\",\n    exchange: \"OSE\",\n    fullExchangeName: \"Oslo Stock Exchange (Euronext Oslo)\",\n    currency: \"NOK\",\n    notes: \"Norwegian stocks listed on Oslo Stock Exchange\"\n  },\n  \".CO\": {\n    suffix: \".CO\",\n    country: \"Denmark\",\n    exchange: \"OMXC\",\n    fullExchangeName: \"Nasdaq Copenhagen (OMX Copenhagen)\",\n    currency: \"DKK\", \n    notes: \"Danish stocks listed on Nasdaq Copenhagen\"\n  },\n  \".HE\": {\n    suffix: \".HE\",\n    country: \"Finland\",\n    exchange: \"OMXH\",\n    fullExchangeName: \"Nasdaq Helsinki (OMX Helsinki)\",\n    currency: \"EUR\",\n    notes: \"Finnish stocks listed on Nasdaq Helsinki\"\n  },\n\n  // Latin America\n  \".MX\": {\n    suffix: \".MX\",\n    country: \"Mexico\",\n    exchange: \"BMV\",\n    fullExchangeName: \"Bolsa Mexicana de Valores (Mexican Stock Exchange)\",\n    currency: \"MXN\",\n    notes: \"Mexican stocks listed on the Mexican Stock Exchange's Global Market\",\n    marketHours: {\n      timezone: \"America/Mexico_City\",\n      sessions: [{ open: \"08:30\", close: \"15:00\" }],\n      days: [1, 2, 3, 4, 5] // Monday to Friday\n    }\n  },\n  \".SA\": {\n    suffix: \".SA\",\n    country: \"Brazil\",\n    exchange: \"B3\",\n    fullExchangeName: \"B3 - Brasil Bolsa Balco\",\n    currency: \"BRL\",\n    notes: \"Brazilian stocks listed on B3\",\n    marketHours: {\n      timezone: \"America/Sao_Paulo\",\n      sessions: [{ open: \"10:00\", close: \"17:00\" }],\n      days: [1, 2, 3, 4, 5] // Monday to Friday\n    }\n  },\n\n  // Additional Asia Pacific\n  \".SI\": {\n    suffix: \".SI\",\n    country: \"Singapore\",\n    exchange: \"SGX\",\n    fullExchangeName: \"Singapore Exchange\",\n    currency: \"SGD\",\n    notes: \"Singapore stocks listed on SGX\",\n    marketHours: {\n      timezone: \"Asia/Singapore\",\n      sessions: [{ open: \"09:00\", close: \"17:00\" }],\n      days: [1, 2, 3, 4, 5] // Monday to Friday\n    }\n  },\n  \".NZ\": {\n    suffix: \".NZ\",\n    country: \"New Zealand\",\n    exchange: \"NZX\",\n    fullExchangeName: \"New Zealand Exchange\",\n    currency: \"NZD\",\n    notes: \"New Zealand stocks listed on NZX\"\n  },\n  \".TW\": {\n    suffix: \".TW\",\n    country: \"Taiwan\",\n    exchange: \"TWSE\",\n    fullExchangeName: \"Taiwan Stock Exchange\",\n    currency: \"TWD\",\n    notes: \"Taiwanese stocks listed on TWSE\"\n  },\n  \".KL\": {\n    suffix: \".KL\",\n    country: \"Malaysia\",\n    exchange: \"Bursa Malaysia\",\n    fullExchangeName: \"Bursa Malaysia\",\n    currency: \"MYR\",\n    notes: \"Malaysian stocks listed on Bursa Malaysia\"\n  },\n  \".JK\": {\n    suffix: \".JK\",\n    country: \"Indonesia\",\n    exchange: \"IDX\",\n    fullExchangeName: \"Indonesia Stock Exchange\",\n    currency: \"IDR\",\n    notes: \"Indonesian stocks listed on IDX\"\n  },\n  \".BK\": {\n    suffix: \".BK\",\n    country: \"Thailand\",\n    exchange: \"SET\",\n    fullExchangeName: \"Stock Exchange of Thailand\",\n    currency: \"THB\",\n    notes: \"Thai stocks listed on SET\"\n  },\n\n  // Middle East\n  \".TA\": {\n    suffix: \".TA\",\n    country: \"Israel\",\n    exchange: \"TASE\",\n    fullExchangeName: \"Tel Aviv Stock Exchange\",\n    currency: \"ILS\",\n    notes: \"Israeli stocks listed on TASE\"\n  },\n\n  // Additional Europe\n  \".VI\": {\n    suffix: \".VI\",\n    country: \"Austria\",\n    exchange: \"Vienna\",\n    fullExchangeName: \"Vienna Stock Exchange\",\n    currency: \"EUR\",\n    notes: \"Austrian stocks listed on Vienna Stock Exchange\"\n  },\n  \".IR\": {\n    suffix: \".IR\",\n    country: \"Ireland\",\n    exchange: \"Euronext Dublin\",\n    fullExchangeName: \"Euronext Dublin\",\n    currency: \"EUR\",\n    notes: \"Irish stocks listed on Euronext Dublin\"\n  },\n  \".WA\": {\n    suffix: \".WA\",\n    country: \"Poland\",\n    exchange: \"WSE\",\n    fullExchangeName: \"Warsaw Stock Exchange\",\n    currency: \"PLN\",\n    notes: \"Polish stocks listed on WSE\"\n  },\n  \".LS\": {\n    suffix: \".LS\",\n    country: \"Portugal\",\n    exchange: \"Euronext Lisbon\",\n    fullExchangeName: \"Euronext Lisbon\",\n    currency: \"EUR\",\n    notes: \"Portuguese stocks listed on Euronext Lisbon\"\n  },\n  \".AT\": {\n    suffix: \".AT\",\n    country: \"Greece\",\n    exchange: \"ATHEX\",\n    fullExchangeName: \"Athens Stock Exchange\",\n    currency: \"EUR\",\n    notes: \"Greek stocks listed on ATHEX\"\n  },\n  \".IS\": {\n    suffix: \".IS\",\n    country: \"Iceland\",\n    exchange: \"Nasdaq Iceland\",\n    fullExchangeName: \"Nasdaq Iceland\",\n    currency: \"ISK\",\n    notes: \"Icelandic stocks listed on Nasdaq Iceland\"\n  },\n  \".PR\": {\n    suffix: \".PR\",\n    country: \"Czech Republic\",\n    exchange: \"Prague Stock Exchange\",\n    fullExchangeName: \"Prague Stock Exchange\",\n    currency: \"CZK\",\n    notes: \"Czech stocks listed on Prague Stock Exchange\"\n  },\n\n  // Additional Global Markets (from Bloomberg exchange data)\n  \".AB\": {\n    suffix: \".AB\",\n    country: \"Saudi Arabia\",\n    exchange: \"Saudi Stock Exchange\",\n    fullExchangeName: \"Saudi Stock Exchange (Tadawul)\",\n    currency: \"SAR\",\n    notes: \"Saudi Arabian stocks\"\n  },\n  \".BD\": {\n    suffix: \".BD\",\n    country: \"Bangladesh\",\n    exchange: \"Dhaka Stock Exchange\",\n    fullExchangeName: \"Dhaka Stock Exchange\",\n    currency: \"BDT\",\n    notes: \"Bangladeshi stocks\"\n  },\n  \".BU\": {\n    suffix: \".BU\",\n    country: \"Bulgaria\",\n    exchange: \"Bulgarian Stock Exchange\",\n    fullExchangeName: \"Bulgarian Stock Exchange\",\n    currency: \"BGN\",\n    notes: \"Bulgarian stocks\"\n  },\n  \".CR\": {\n    suffix: \".CR\",\n    country: \"Costa Rica\",\n    exchange: \"Costa Rica Stock Exchange\",\n    fullExchangeName: \"Bolsa Nacional de Valores\",\n    currency: \"CRC\",\n    notes: \"Costa Rican stocks\"\n  },\n  \".CY\": {\n    suffix: \".CY\",\n    country: \"Cyprus\",\n    exchange: \"Cyprus Stock Exchange\",\n    fullExchangeName: \"Cyprus Stock Exchange\",\n    currency: \"EUR\",\n    notes: \"Cypriot stocks\"\n  },\n  \".EC\": {\n    suffix: \".EC\",\n    country: \"Egypt\",\n    exchange: \"Egyptian Exchange\",\n    fullExchangeName: \"Egyptian Exchange (EGX)\",\n    currency: \"EGP\",\n    notes: \"Egyptian stocks\"\n  },\n  \".JR\": {\n    suffix: \".JR\",\n    country: \"Jordan\",\n    exchange: \"Amman Stock Exchange\",\n    fullExchangeName: \"Amman Stock Exchange\",\n    currency: \"JOD\",\n    notes: \"Jordanian stocks\"\n  },\n  \".JT\": {\n    suffix: \".JT\",\n    country: \"Japan\",\n    exchange: \"Tokyo Stock Exchange\",\n    fullExchangeName: \"Tokyo Stock Exchange\",\n    currency: \"JPY\",\n    notes: \"Japanese stocks (alternative code)\"\n  },\n  \".KH\": {\n    suffix: \".KH\",\n    country: \"Cambodia\",\n    exchange: \"Cambodia Securities Exchange\",\n    fullExchangeName: \"Cambodia Securities Exchange\",\n    currency: \"KHR\",\n    notes: \"Cambodian stocks\"\n  },\n  \".KK\": {\n    suffix: \".KK\",\n    country: \"Kuwait\",\n    exchange: \"Kuwait Stock Exchange\",\n    fullExchangeName: \"Kuwait Stock Exchange (Boursa Kuwait)\",\n    currency: \"KWD\",\n    notes: \"Kuwaiti stocks\"\n  },\n  \".KN\": {\n    suffix: \".KN\",\n    country: \"Kenya\",\n    exchange: \"Nairobi Securities Exchange\",\n    fullExchangeName: \"Nairobi Securities Exchange\",\n    currency: \"KES\",\n    notes: \"Kenyan stocks\"\n  },\n  \".KP\": {\n    suffix: \".KP\",\n    country: \"South Korea\",\n    exchange: \"Korea Exchange\",\n    fullExchangeName: \"Korea Exchange (KRX)\",\n    currency: \"KRW\",\n    notes: \"South Korean stocks\"\n  },\n  \".KQ\": {\n    suffix: \".KQ\",\n    country: \"South Korea\",\n    exchange: \"KOSDAQ\",\n    fullExchangeName: \"Korea Exchange (KOSDAQ)\",\n    currency: \"KRW\",\n    notes: \"Korean KOSDAQ stocks\"\n  },\n  \".KZ\": {\n    suffix: \".KZ\",\n    country: \"Kazakhstan\",\n    exchange: \"Kazakhstan Stock Exchange\",\n    fullExchangeName: \"Kazakhstan Stock Exchange\",\n    currency: \"KZT\",\n    notes: \"Kazakhstani stocks\"\n  },\n  \".LK\": {\n    suffix: \".LK\",\n    country: \"Sri Lanka\",\n    exchange: \"Colombo Stock Exchange\",\n    fullExchangeName: \"Colombo Stock Exchange\",\n    currency: \"LKR\",\n    notes: \"Sri Lankan stocks\"\n  },\n  \".MO\": {\n    suffix: \".MO\",\n    country: \"Mongolia\",\n    exchange: \"Mongolian Stock Exchange\",\n    fullExchangeName: \"Mongolian Stock Exchange\",\n    currency: \"MNT\",\n    notes: \"Mongolian stocks\"\n  },\n  \".PE\": {\n    suffix: \".PE\",\n    country: \"Peru\",\n    exchange: \"Lima Stock Exchange\",\n    fullExchangeName: \"Bolsa de Valores de Lima\",\n    currency: \"PEN\",\n    notes: \"Peruvian stocks\"\n  },\n  \".PH\": {\n    suffix: \".PH\",\n    country: \"Philippines\",\n    exchange: \"Philippine Stock Exchange\",\n    fullExchangeName: \"Philippine Stock Exchange\",\n    currency: \"PHP\",\n    notes: \"Philippine stocks\"\n  },\n  \".PK\": {\n    suffix: \".PK\",\n    country: \"Pakistan\",\n    exchange: \"Pakistan Stock Exchange\",\n    fullExchangeName: \"Pakistan Stock Exchange\",\n    currency: \"PKR\",\n    notes: \"Pakistani stocks\"\n  },\n  \".QA\": {\n    suffix: \".QA\",\n    country: \"Qatar\",\n    exchange: \"Qatar Stock Exchange\",\n    fullExchangeName: \"Qatar Stock Exchange\",\n    currency: \"QAR\",\n    notes: \"Qatari stocks\"\n  },\n  \".RO\": {\n    suffix: \".RO\",\n    country: \"Romania\",\n    exchange: \"Bucharest Stock Exchange\",\n    fullExchangeName: \"Bucharest Stock Exchange\",\n    currency: \"RON\",\n    notes: \"Romanian stocks\"\n  },\n  \".SK\": {\n    suffix: \".SK\",\n    country: \"Slovakia\",\n    exchange: \"Bratislava Stock Exchange\",\n    fullExchangeName: \"Bratislava Stock Exchange\",\n    currency: \"EUR\",\n    notes: \"Slovakian stocks\"\n  },\n  \".TU\": {\n    suffix: \".TU\",\n    country: \"Tunisia\",\n    exchange: \"Tunis Stock Exchange\",\n    fullExchangeName: \"Bourse de Tunis\",\n    currency: \"TND\",\n    notes: \"Tunisian stocks\"\n  },\n  \".UA\": {\n    suffix: \".UA\",\n    country: \"Ukraine\",\n    exchange: \"Ukrainian Exchange\",\n    fullExchangeName: \"Ukrainian Exchange\",\n    currency: \"UAH\",\n    notes: \"Ukrainian stocks\"\n  },\n  \".UY\": {\n    suffix: \".UY\",\n    country: \"Uruguay\",\n    exchange: \"Montevideo Stock Exchange\",\n    fullExchangeName: \"Bolsa de Valores de Montevideo\",\n    currency: \"UYU\",\n    notes: \"Uruguayan stocks\"\n  },\n  \".VB\": {\n    suffix: \".VB\",\n    country: \"Bolivia\",\n    exchange: \"Bolivian Stock Exchange\",\n    fullExchangeName: \"Bolsa Boliviana de Valores\",\n    currency: \"BOB\",\n    notes: \"Bolivian stocks\"\n  },\n  \".VH\": {\n    suffix: \".VH\",\n    country: \"Vietnam\",\n    exchange: \"Hanoi Stock Exchange\",\n    fullExchangeName: \"Hanoi Stock Exchange\",\n    currency: \"VND\",\n    notes: \"Vietnamese stocks (Hanoi)\"\n  },\n  \".VM\": {\n    suffix: \".VM\",\n    country: \"Vietnam\",\n    exchange: \"Ho Chi Minh Stock Exchange\",\n    fullExchangeName: \"Ho Chi Minh Stock Exchange\",\n    currency: \"VND\",\n    notes: \"Vietnamese stocks (HCMC)\"\n  },\n  \".ZH\": {\n    suffix: \".ZH\",\n    country: \"Zimbabwe\",\n    exchange: \"Zimbabwe Stock Exchange\",\n    fullExchangeName: \"Zimbabwe Stock Exchange\",\n    currency: \"ZWL\",\n    notes: \"Zimbabwean stocks\"\n  },\n  \".ZL\": {\n    suffix: \".ZL\",\n    country: \"Zambia\",\n    exchange: \"Lusaka Stock Exchange\",\n    fullExchangeName: \"Lusaka Stock Exchange\",\n    currency: \"ZMW\",\n    notes: \"Zambian stocks\"\n  }\n};\n\n// Helper function to search suffixes\nexport const searchSuffix = (query: string): SuffixInfo | null => {\n  const cleanQuery = query.trim().toUpperCase();\n  \n  // Add leading dot if not present\n  const searchKey = cleanQuery.startsWith('.') ? cleanQuery : `.${cleanQuery}`;\n  \n  return suffixMappings[searchKey] || null;\n};\n\n// Get all available suffixes for autocomplete/suggestions\nexport const getAllSuffixes = (): string[] => {\n  return Object.keys(suffixMappings).sort();\n};","path":null,"size_bytes":17945,"size_tokens":null},"client/src/components/theme-provider.tsx":{"content":"import { createContext, useContext, useEffect } from \"react\";\n\ntype Theme = \"dark\";\n\ntype ThemeProviderProps = {\n  children: React.ReactNode;\n};\n\ntype ThemeProviderState = {\n  theme: Theme;\n  setTheme: (theme: Theme) => void;\n};\n\nconst initialState: ThemeProviderState = {\n  theme: \"dark\",\n  setTheme: () => null,\n};\n\nconst ThemeProviderContext = createContext<ThemeProviderState>(initialState);\n\nexport function ThemeProvider({\n  children,\n  ...props\n}: ThemeProviderProps) {\n  // Always force dark mode - no theme switching\n  const theme: Theme = \"dark\";\n\n  useEffect(() => {\n    const root = window.document.documentElement;\n    \n    // Remove any existing theme classes and force dark mode\n    root.classList.remove(\"light\", \"dark\");\n    root.classList.add(\"dark\");\n  }, []);\n\n  const value = {\n    theme,\n    setTheme: () => {\n      // No-op - dark mode only\n    },\n  };\n\n  return (\n    <ThemeProviderContext.Provider {...props} value={value}>\n      {children}\n    </ThemeProviderContext.Provider>\n  );\n}\n\nexport const useTheme = () => {\n  const context = useContext(ThemeProviderContext);\n\n  if (context === undefined)\n    throw new Error(\"useTheme must be used within a ThemeProvider\");\n\n  return context;\n};","path":null,"size_bytes":1215,"size_tokens":null},"client/src/components/ui/toggle.tsx":{"content":"import * as React from \"react\"\nimport * as TogglePrimitive from \"@radix-ui/react-toggle\"\nimport { cva, type VariantProps } from \"class-variance-authority\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst toggleVariants = cva(\n  \"inline-flex items-center justify-center rounded-md text-sm font-medium ring-offset-background transition-colors hover:bg-muted hover:text-muted-foreground focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:pointer-events-none disabled:opacity-50 data-[state=on]:bg-accent data-[state=on]:text-accent-foreground [&_svg]:pointer-events-none [&_svg]:size-4 [&_svg]:shrink-0 gap-2\",\n  {\n    variants: {\n      variant: {\n        default: \"bg-transparent\",\n        outline:\n          \"border border-input bg-transparent hover:bg-accent hover:text-accent-foreground\",\n      },\n      size: {\n        default: \"h-10 px-3 min-w-10\",\n        sm: \"h-9 px-2.5 min-w-9\",\n        lg: \"h-11 px-5 min-w-11\",\n      },\n    },\n    defaultVariants: {\n      variant: \"default\",\n      size: \"default\",\n    },\n  }\n)\n\nconst Toggle = React.forwardRef<\n  React.ElementRef<typeof TogglePrimitive.Root>,\n  React.ComponentPropsWithoutRef<typeof TogglePrimitive.Root> &\n    VariantProps<typeof toggleVariants>\n>(({ className, variant, size, ...props }, ref) => (\n  <TogglePrimitive.Root\n    ref={ref}\n    className={cn(toggleVariants({ variant, size, className }))}\n    {...props}\n  />\n))\n\nToggle.displayName = TogglePrimitive.Root.displayName\n\nexport { Toggle, toggleVariants }\n","path":null,"size_bytes":1527,"size_tokens":null},"replit.md":{"content":"# Stock Market Tracker Dashboard\n\n### Overview\nA full-stack stock market tracking application providing real-time stock market data, comprehensive analytics, and Slack integration for alerts. The system aims to offer extensive global market coverage and actionable insights for investors, supporting both in-memory and database storage.\n\n### User Preferences\nPreferred communication style: Simple, everyday language.\nTesting preference: User prefers to handle testing themselves rather than internal automated testing. Skip QA testing for speed - user will test the app directly.\n\n### System Architecture\n\n#### Frontend Architecture\n- **Framework**: React 18 with TypeScript\n- **State Management**: TanStack Query (React Query)\n- **Routing**: Wouter\n- **UI Framework**: Tailwind CSS with shadcn/ui components\n- **Build Tool**: Vite\n- **UI/UX Decisions**:\n    - **Dark Mode**: Complete light/dark theme toggle with Intropic MUI color scheme (#5AF5FA cyan accents)\n    - **Typography**: Space Grotesk Light (300) for H1/H2; Mulish for H3, H4+, and body text\n    - **Responsive Design**: Mobile-first design with adaptive layouts\n    - **Dashboard**: Main interface with summary cards, gainers/losers tables, and filter controls\n    - **Market Status Indicator**: Real-time US market status (OPEN/CLOSED) with countdown\n    - **Data Tables**: Sortable tables with custom cell renderers\n    - **Export Functionality**: CSV export for market data\n    - **Price Chart Component**: Interactive stock price charts with multiple timeframes and integrated ticker search\n    - **Stock Ticker Suffix Guide**: Searchable guide for global stock exchange suffixes with market hours and holiday information\n    - **Homepage**: Three interactive pathway cards for Price Chart, Comparison Chart, and AI Co-Pilot.\n    - **Navigation**: Global navigation dropdown for quick chart type switching.\n    - **Delete Confirmation UX Pattern**: Two-click confirmation for all delete actions: bin icon slides to reveal \"Delete Now\" (cyan #5AF5FA), second click initiates animated deletion (card slides left and fades out). Auto-resets after 4 seconds.\n\n#### Backend Architecture\n- **Runtime**: Node.js with Express.js\n- **Language**: TypeScript with ES modules\n- **Database**: PostgreSQL with Drizzle ORM\n- **Session Storage**: PostgreSQL-backed sessions using `connect-pg-simple`\n- **API Design**: RESTful API endpoints with JSON responses\n\n#### Data Storage Solutions\n- **Primary Database**: PostgreSQL via Neon serverless\n- **ORM**: Drizzle with schema-first approach and Drizzle Kit for migrations\n- **Storage Implementation**: `DatabaseStorage` class for CRUD operations\n\n#### Key Features\n- **Stock Data Management**: Comprehensive stock information, market summary, and advanced filtering.\n- **Slack Integration**: Automated morning/afternoon market mover alerts with bot integration.\n- **Global Exchange Coverage**: Supports 69 global stock exchanges with Bloomberg-style ticker suffixes, currency mapping, and Finnhub API integration for live market holiday data.\n- **Stock Data Pipeline**: Data ingestion from Alpha Vantage Premium, coverage of 40 market movers, US stock filtering, smart market cap estimation, sector classification, efficient database storage, RESTful API endpoints, 15-minute refresh cycle, and API quota tracking.\n- **Login Attempt Tracking System**: Comprehensive tracking of login attempts including geographical location (via ipapi.co), success/failure status, and specific failure reasons. Admin page displays history and statistics.\n- **Comparison Chart Enhancement**: Forward-fill logic for global market comparisons to create continuous lines across different market hours.\n- **CSV Overlay Feature**: Allows users to upload or paste CSV data for percentage overlays on charts, with strict validation and visual rendering.\n- **Y-Axis Toggle Feature**: In price chart, switch between price and percentage display modes.\n\n### External Dependencies\n\n#### Core Runtime Dependencies\n- **@neondatabase/serverless**: PostgreSQL database connection\n- **drizzle-orm**: Type-safe database queries and migrations\n- **@slack/web-api**: Slack bot integration\n- **express**: Web server framework\n- **@tanstack/react-query**: Server state management\n- **Alpha Vantage Premium**: Primary data source for TOP_GAINERS_LOSERS API (live market movers).\n- **Finnhub API**: Fallback for ticker search, price charts, company profiles, and real-time market holidays.\n- **Polygon API**: Backup source for additional market data and comprehensive stock screening.\n- **ipapi.co**: IP geolocation for login attempt tracking.\n- **OpenAI**: AI Copilot chart maker integration (via Replit AI Integrations).\n\n#### UI and Development Dependencies\n- **@radix-ui/***: Accessible UI primitives\n- **tailwindcss**: Utility-first CSS framework\n- **vite**: Build tool and development server\n- **typescript**: Type safety\n- **zod**: Runtime type validation\n\n#### Database and Storage\n- **connect-pg-simple**: PostgreSQL session store\n- **drizzle-zod**: Schema validation integration","path":null,"size_bytes":5050,"size_tokens":null},"client/src/components/ui/accordion.tsx":{"content":"import * as React from \"react\"\nimport * as AccordionPrimitive from \"@radix-ui/react-accordion\"\nimport { ChevronDown } from \"lucide-react\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst Accordion = AccordionPrimitive.Root\n\nconst AccordionItem = React.forwardRef<\n  React.ElementRef<typeof AccordionPrimitive.Item>,\n  React.ComponentPropsWithoutRef<typeof AccordionPrimitive.Item>\n>(({ className, ...props }, ref) => (\n  <AccordionPrimitive.Item\n    ref={ref}\n    className={cn(\"border-b\", className)}\n    {...props}\n  />\n))\nAccordionItem.displayName = \"AccordionItem\"\n\nconst AccordionTrigger = React.forwardRef<\n  React.ElementRef<typeof AccordionPrimitive.Trigger>,\n  React.ComponentPropsWithoutRef<typeof AccordionPrimitive.Trigger>\n>(({ className, children, ...props }, ref) => (\n  <AccordionPrimitive.Header className=\"flex\">\n    <AccordionPrimitive.Trigger\n      ref={ref}\n      className={cn(\n        \"flex flex-1 items-center justify-between py-4 font-medium transition-all hover:underline [&[data-state=open]>svg]:rotate-180\",\n        className\n      )}\n      {...props}\n    >\n      {children}\n      <ChevronDown className=\"h-4 w-4 shrink-0 transition-transform duration-200\" />\n    </AccordionPrimitive.Trigger>\n  </AccordionPrimitive.Header>\n))\nAccordionTrigger.displayName = AccordionPrimitive.Trigger.displayName\n\nconst AccordionContent = React.forwardRef<\n  React.ElementRef<typeof AccordionPrimitive.Content>,\n  React.ComponentPropsWithoutRef<typeof AccordionPrimitive.Content>\n>(({ className, children, ...props }, ref) => (\n  <AccordionPrimitive.Content\n    ref={ref}\n    className=\"overflow-hidden text-sm transition-all data-[state=closed]:animate-accordion-up data-[state=open]:animate-accordion-down\"\n    {...props}\n  >\n    <div className={cn(\"pb-4 pt-0\", className)}>{children}</div>\n  </AccordionPrimitive.Content>\n))\n\nAccordionContent.displayName = AccordionPrimitive.Content.displayName\n\nexport { Accordion, AccordionItem, AccordionTrigger, AccordionContent }\n","path":null,"size_bytes":1977,"size_tokens":null},"client/src/components/ui/popover.tsx":{"content":"import * as React from \"react\"\nimport * as PopoverPrimitive from \"@radix-ui/react-popover\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst Popover = PopoverPrimitive.Root\n\nconst PopoverTrigger = PopoverPrimitive.Trigger\n\nconst PopoverContent = React.forwardRef<\n  React.ElementRef<typeof PopoverPrimitive.Content>,\n  React.ComponentPropsWithoutRef<typeof PopoverPrimitive.Content>\n>(({ className, align = \"center\", sideOffset = 4, ...props }, ref) => (\n  <PopoverPrimitive.Portal>\n    <PopoverPrimitive.Content\n      ref={ref}\n      align={align}\n      sideOffset={sideOffset}\n      className={cn(\n        \"z-50 w-72 rounded-md border bg-popover p-4 text-popover-foreground shadow-md outline-none data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 data-[side=bottom]:slide-in-from-top-2 data-[side=left]:slide-in-from-right-2 data-[side=right]:slide-in-from-left-2 data-[side=top]:slide-in-from-bottom-2 origin-[--radix-popover-content-transform-origin]\",\n        className\n      )}\n      {...props}\n    />\n  </PopoverPrimitive.Portal>\n))\nPopoverContent.displayName = PopoverPrimitive.Content.displayName\n\nexport { Popover, PopoverTrigger, PopoverContent }\n","path":null,"size_bytes":1280,"size_tokens":null},"client/src/components/ui/hover-card.tsx":{"content":"\"use client\"\n\nimport * as React from \"react\"\nimport * as HoverCardPrimitive from \"@radix-ui/react-hover-card\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst HoverCard = HoverCardPrimitive.Root\n\nconst HoverCardTrigger = HoverCardPrimitive.Trigger\n\nconst HoverCardContent = React.forwardRef<\n  React.ElementRef<typeof HoverCardPrimitive.Content>,\n  React.ComponentPropsWithoutRef<typeof HoverCardPrimitive.Content>\n>(({ className, align = \"center\", sideOffset = 4, ...props }, ref) => (\n  <HoverCardPrimitive.Content\n    ref={ref}\n    align={align}\n    sideOffset={sideOffset}\n    className={cn(\n      \"z-50 w-64 rounded-md border bg-popover p-4 text-popover-foreground shadow-md outline-none data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 data-[side=bottom]:slide-in-from-top-2 data-[side=left]:slide-in-from-right-2 data-[side=right]:slide-in-from-left-2 data-[side=top]:slide-in-from-bottom-2 origin-[--radix-hover-card-content-transform-origin]\",\n      className\n    )}\n    {...props}\n  />\n))\nHoverCardContent.displayName = HoverCardPrimitive.Content.displayName\n\nexport { HoverCard, HoverCardTrigger, HoverCardContent }\n","path":null,"size_bytes":1251,"size_tokens":null},"client/src/components/ui/chart.tsx":{"content":"\"use client\"\n\nimport * as React from \"react\"\nimport * as RechartsPrimitive from \"recharts\"\n\nimport { cn } from \"@/lib/utils\"\n\n// Format: { THEME_NAME: CSS_SELECTOR }\nconst THEMES = { light: \"\", dark: \".dark\" } as const\n\nexport type ChartConfig = {\n  [k in string]: {\n    label?: React.ReactNode\n    icon?: React.ComponentType\n  } & (\n    | { color?: string; theme?: never }\n    | { color?: never; theme: Record<keyof typeof THEMES, string> }\n  )\n}\n\ntype ChartContextProps = {\n  config: ChartConfig\n}\n\nconst ChartContext = React.createContext<ChartContextProps | null>(null)\n\nfunction useChart() {\n  const context = React.useContext(ChartContext)\n\n  if (!context) {\n    throw new Error(\"useChart must be used within a <ChartContainer />\")\n  }\n\n  return context\n}\n\nconst ChartContainer = React.forwardRef<\n  HTMLDivElement,\n  React.ComponentProps<\"div\"> & {\n    config: ChartConfig\n    children: React.ComponentProps<\n      typeof RechartsPrimitive.ResponsiveContainer\n    >[\"children\"]\n  }\n>(({ id, className, children, config, ...props }, ref) => {\n  const uniqueId = React.useId()\n  const chartId = `chart-${id || uniqueId.replace(/:/g, \"\")}`\n\n  return (\n    <ChartContext.Provider value={{ config }}>\n      <div\n        data-chart={chartId}\n        ref={ref}\n        className={cn(\n          \"flex aspect-video justify-center text-xs [&_.recharts-cartesian-axis-tick_text]:fill-muted-foreground [&_.recharts-cartesian-grid_line]:stroke-[#3B3B3B] [&_.recharts-cartesian-grid_line]:stroke-opacity-50 [&_.recharts-curve.recharts-tooltip-cursor]:stroke-border [&_.recharts-dot[stroke='#fff']]:stroke-transparent [&_.recharts-layer]:outline-none [&_.recharts-polar-grid_[stroke='#ccc']]:stroke-border [&_.recharts-radial-bar-background-sector]:fill-muted [&_.recharts-rectangle.recharts-tooltip-cursor]:fill-muted [&_.recharts-reference-line_[stroke='#ccc']]:stroke-border [&_.recharts-sector[stroke='#fff']]:stroke-transparent [&_.recharts-sector]:outline-none [&_.recharts-surface]:outline-none\",\n          className\n        )}\n        {...props}\n      >\n        <ChartStyle id={chartId} config={config} />\n        <RechartsPrimitive.ResponsiveContainer>\n          {children}\n        </RechartsPrimitive.ResponsiveContainer>\n      </div>\n    </ChartContext.Provider>\n  )\n})\nChartContainer.displayName = \"Chart\"\n\nconst ChartStyle = ({ id, config }: { id: string; config: ChartConfig }) => {\n  const colorConfig = Object.entries(config).filter(\n    ([, config]) => config.theme || config.color\n  )\n\n  if (!colorConfig.length) {\n    return null\n  }\n\n  return (\n    <style\n      dangerouslySetInnerHTML={{\n        __html: Object.entries(THEMES)\n          .map(\n            ([theme, prefix]) => `\n${prefix} [data-chart=${id}] {\n${colorConfig\n  .map(([key, itemConfig]) => {\n    const color =\n      itemConfig.theme?.[theme as keyof typeof itemConfig.theme] ||\n      itemConfig.color\n    return color ? `  --color-${key}: ${color};` : null\n  })\n  .join(\"\\n\")}\n}\n`\n          )\n          .join(\"\\n\"),\n      }}\n    />\n  )\n}\n\nconst ChartTooltip = RechartsPrimitive.Tooltip\n\nconst ChartTooltipContent = React.forwardRef<\n  HTMLDivElement,\n  React.ComponentProps<typeof RechartsPrimitive.Tooltip> &\n    React.ComponentProps<\"div\"> & {\n      hideLabel?: boolean\n      hideIndicator?: boolean\n      indicator?: \"line\" | \"dot\" | \"dashed\"\n      nameKey?: string\n      labelKey?: string\n    }\n>(\n  (\n    {\n      active,\n      payload,\n      className,\n      indicator = \"dot\",\n      hideLabel = false,\n      hideIndicator = false,\n      label,\n      labelFormatter,\n      labelClassName,\n      formatter,\n      color,\n      nameKey,\n      labelKey,\n    },\n    ref\n  ) => {\n    const { config } = useChart()\n\n    const tooltipLabel = React.useMemo(() => {\n      if (hideLabel || !payload?.length) {\n        return null\n      }\n\n      const [item] = payload\n      const key = `${labelKey || item?.dataKey || item?.name || \"value\"}`\n      const itemConfig = getPayloadConfigFromPayload(config, item, key)\n      const value =\n        !labelKey && typeof label === \"string\"\n          ? config[label as keyof typeof config]?.label || label\n          : itemConfig?.label\n\n      if (labelFormatter) {\n        return (\n          <div className={cn(\"font-medium\", labelClassName)}>\n            {labelFormatter(value, payload)}\n          </div>\n        )\n      }\n\n      if (!value) {\n        return null\n      }\n\n      return <div className={cn(\"font-medium\", labelClassName)}>{value}</div>\n    }, [\n      label,\n      labelFormatter,\n      payload,\n      hideLabel,\n      labelClassName,\n      config,\n      labelKey,\n    ])\n\n    if (!active || !payload?.length) {\n      return null\n    }\n\n    const nestLabel = payload.length === 1 && indicator !== \"dot\"\n\n    return (\n      <div\n        ref={ref}\n        className={cn(\n          \"grid min-w-[8rem] items-start gap-1.5 rounded-lg border border-border/50 bg-background px-2.5 py-1.5 text-xs shadow-xl\",\n          className\n        )}\n      >\n        {!nestLabel ? tooltipLabel : null}\n        <div className=\"grid gap-1.5\">\n          {payload.map((item, index) => {\n            const key = `${nameKey || item.name || item.dataKey || \"value\"}`\n            const itemConfig = getPayloadConfigFromPayload(config, item, key)\n            const indicatorColor = color || item.payload.fill || item.color\n\n            return (\n              <div\n                key={item.dataKey}\n                className={cn(\n                  \"flex w-full flex-wrap items-stretch gap-2 [&>svg]:h-2.5 [&>svg]:w-2.5 [&>svg]:text-muted-foreground\",\n                  indicator === \"dot\" && \"items-center\"\n                )}\n              >\n                {formatter && item?.value !== undefined && item.name ? (\n                  formatter(item.value, item.name, item, index, item.payload)\n                ) : (\n                  <>\n                    {itemConfig?.icon ? (\n                      <itemConfig.icon />\n                    ) : (\n                      !hideIndicator && (\n                        <div\n                          className={cn(\n                            \"shrink-0 rounded-[2px] border-[--color-border] bg-[--color-bg]\",\n                            {\n                              \"h-2.5 w-2.5\": indicator === \"dot\",\n                              \"w-1\": indicator === \"line\",\n                              \"w-0 border-[1.5px] border-dashed bg-transparent\":\n                                indicator === \"dashed\",\n                              \"my-0.5\": nestLabel && indicator === \"dashed\",\n                            }\n                          )}\n                          style={\n                            {\n                              \"--color-bg\": indicatorColor,\n                              \"--color-border\": indicatorColor,\n                            } as React.CSSProperties\n                          }\n                        />\n                      )\n                    )}\n                    <div\n                      className={cn(\n                        \"flex flex-1 justify-between leading-none\",\n                        nestLabel ? \"items-end\" : \"items-center\"\n                      )}\n                    >\n                      <div className=\"grid gap-1.5\">\n                        {nestLabel ? tooltipLabel : null}\n                        <span className=\"text-muted-foreground\">\n                          {itemConfig?.label || item.name}\n                        </span>\n                      </div>\n                      {item.value && (\n                        <span className=\"font-mono font-medium tabular-nums text-foreground\">\n                          {item.value.toLocaleString()}\n                        </span>\n                      )}\n                    </div>\n                  </>\n                )}\n              </div>\n            )\n          })}\n        </div>\n      </div>\n    )\n  }\n)\nChartTooltipContent.displayName = \"ChartTooltip\"\n\nconst ChartLegend = RechartsPrimitive.Legend\n\nconst ChartLegendContent = React.forwardRef<\n  HTMLDivElement,\n  React.ComponentProps<\"div\"> &\n    Pick<RechartsPrimitive.LegendProps, \"payload\" | \"verticalAlign\"> & {\n      hideIcon?: boolean\n      nameKey?: string\n    }\n>(\n  (\n    { className, hideIcon = false, payload, verticalAlign = \"bottom\", nameKey },\n    ref\n  ) => {\n    const { config } = useChart()\n\n    if (!payload?.length) {\n      return null\n    }\n\n    return (\n      <div\n        ref={ref}\n        className={cn(\n          \"flex items-center justify-center gap-4\",\n          verticalAlign === \"top\" ? \"pb-3\" : \"pt-3\",\n          className\n        )}\n      >\n        {payload.map((item) => {\n          const key = `${nameKey || item.dataKey || \"value\"}`\n          const itemConfig = getPayloadConfigFromPayload(config, item, key)\n\n          return (\n            <div\n              key={item.value}\n              className={cn(\n                \"flex items-center gap-1.5 [&>svg]:h-3 [&>svg]:w-3 [&>svg]:text-muted-foreground\"\n              )}\n            >\n              {itemConfig?.icon && !hideIcon ? (\n                <itemConfig.icon />\n              ) : (\n                <div\n                  className=\"h-2 w-2 shrink-0 rounded-[2px]\"\n                  style={{\n                    backgroundColor: item.color,\n                  }}\n                />\n              )}\n              {itemConfig?.label}\n            </div>\n          )\n        })}\n      </div>\n    )\n  }\n)\nChartLegendContent.displayName = \"ChartLegend\"\n\n// Helper to extract item config from a payload.\nfunction getPayloadConfigFromPayload(\n  config: ChartConfig,\n  payload: unknown,\n  key: string\n) {\n  if (typeof payload !== \"object\" || payload === null) {\n    return undefined\n  }\n\n  const payloadPayload =\n    \"payload\" in payload &&\n    typeof payload.payload === \"object\" &&\n    payload.payload !== null\n      ? payload.payload\n      : undefined\n\n  let configLabelKey: string = key\n\n  if (\n    key in payload &&\n    typeof payload[key as keyof typeof payload] === \"string\"\n  ) {\n    configLabelKey = payload[key as keyof typeof payload] as string\n  } else if (\n    payloadPayload &&\n    key in payloadPayload &&\n    typeof payloadPayload[key as keyof typeof payloadPayload] === \"string\"\n  ) {\n    configLabelKey = payloadPayload[\n      key as keyof typeof payloadPayload\n    ] as string\n  }\n\n  return configLabelKey in config\n    ? config[configLabelKey]\n    : config[key as keyof typeof config]\n}\n\nexport {\n  ChartContainer,\n  ChartTooltip,\n  ChartTooltipContent,\n  ChartLegend,\n  ChartLegendContent,\n  ChartStyle,\n}\n","path":null,"size_bytes":10518,"size_tokens":null},"drizzle.config.ts":{"content":"import { defineConfig } from \"drizzle-kit\";\n\nif (!process.env.DATABASE_URL) {\n  throw new Error(\"DATABASE_URL, ensure the database is provisioned\");\n}\n\nexport default defineConfig({\n  out: \"./migrations\",\n  schema: \"./shared/schema.ts\",\n  dialect: \"postgresql\",\n  dbCredentials: {\n    url: process.env.DATABASE_URL,\n  },\n});\n","path":null,"size_bytes":325,"size_tokens":null},"client/src/pages/publishing-analytics.tsx":{"content":"import { useState } from \"react\";\nimport { useQuery } from \"@tanstack/react-query\";\nimport { Card, CardContent, CardDescription, CardHeader, CardTitle } from \"@/components/ui/card\";\nimport { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from \"@/components/ui/select\";\nimport { Table, TableBody, TableCell, TableHead, TableHeader, TableRow } from \"@/components/ui/table\";\nimport { Badge } from \"@/components/ui/badge\";\nimport { Skeleton } from \"@/components/ui/skeleton\";\nimport { CalendarDays, MapPin, Globe, Clock, Wifi } from \"lucide-react\";\nimport { format } from \"date-fns\";\n\ninterface AnalyticsSummary {\n  totalVisitors: number;\n  uniqueVisitors: number;\n  recentVisitors: number;\n  topCountries: Array<{ country: string; count: number }>;\n  topCities: Array<{ city: string; country: string; count: number }>;\n}\n\ninterface VisitorRecord {\n  id: number;\n  ipAddress: string;\n  country?: string;\n  region?: string;\n  city?: string;\n  latitude?: string;\n  longitude?: string;\n  isp?: string;\n  org?: string;\n  timezone?: string;\n  visitedAt: string;\n  path: string;\n  duration?: number;\n  returnVisits?: number;\n}\n\nexport default function PublishingAnalytics() {\n  const [dateFilter, setDateFilter] = useState(\"all\");\n\n  const { data: summary, isLoading: summaryLoading } = useQuery<AnalyticsSummary>({\n    queryKey: [\"/api/analytics/summary\", dateFilter],\n  });\n\n  const { data: visitors, isLoading: visitorsLoading } = useQuery<VisitorRecord[]>({\n    queryKey: [\"/api/analytics/visitors\", dateFilter],\n  });\n\n  if (summaryLoading) {\n    return (\n      <div className=\"min-h-screen bg-gradient-to-br from-background to-secondary/20 p-6\">\n        <div className=\"max-w-7xl mx-auto space-y-8\">\n          <div className=\"text-center\">\n            <h1 className=\"text-4xl font-bold bg-gradient-to-r from-primary to-primary/60 bg-clip-text text-transparent\">\n              Publishing Analytics\n            </h1>\n            <p className=\"text-muted-foreground mt-2\">\n              Visitor tracking and insights for publishing metrics\n            </p>\n          </div>\n\n          <div className=\"flex justify-center\">\n            <Card className=\"w-80\">\n              <CardContent className=\"pt-6\">\n                <Skeleton className=\"h-10 w-full\" />\n              </CardContent>\n            </Card>\n          </div>\n\n          <div className=\"space-y-6\">\n            <Card>\n              <CardHeader>\n                <Skeleton className=\"h-6 w-48\" />\n              </CardHeader>\n              <CardContent>\n                <div className=\"space-y-3\">\n                  {[1, 2, 3, 4, 5].map((i) => (\n                    <Skeleton key={i} className=\"h-12 w-full\" />\n                  ))}\n                </div>\n              </CardContent>\n            </Card>\n          </div>\n        </div>\n      </div>\n    );\n  }\n\n  return (\n    <div className=\"min-h-screen bg-gradient-to-br from-background to-secondary/20 p-6\">\n      <div className=\"max-w-7xl mx-auto space-y-8\">\n        {/* Header */}\n        <div className=\"text-center\">\n          <h1 className=\"text-4xl font-bold bg-gradient-to-r from-primary to-primary/60 bg-clip-text text-transparent\">\n            Publishing Analytics\n          </h1>\n          <p className=\"text-muted-foreground mt-2\">\n            Visitor tracking and insights for publishing metrics\n          </p>\n        </div>\n\n        {/* Date Filter */}\n        <div className=\"flex justify-center\">\n          <Card className=\"w-80\">\n            <CardContent className=\"pt-6\">\n              <div className=\"flex items-center space-x-3\">\n                <CalendarDays className=\"h-5 w-5 text-muted-foreground\" />\n                <div className=\"flex-1\">\n                  <Select value={dateFilter} onValueChange={setDateFilter} data-testid=\"select-date-filter\">\n                    <SelectTrigger>\n                      <SelectValue placeholder=\"Select time period\" />\n                    </SelectTrigger>\n                    <SelectContent>\n                      <SelectItem value=\"all\">All Time</SelectItem>\n                      <SelectItem value=\"today\">Today</SelectItem>\n                      <SelectItem value=\"yesterday\">Yesterday</SelectItem>\n                      <SelectItem value=\"7days\">Last 7 Days</SelectItem>\n                      <SelectItem value=\"30days\">Last 30 Days</SelectItem>\n                      <SelectItem value=\"90days\">Last 90 Days</SelectItem>\n                    </SelectContent>\n                  </Select>\n                </div>\n              </div>\n            </CardContent>\n          </Card>\n        </div>\n\n        {/* Top Countries */}\n        <Card data-testid=\"card-top-countries\">\n          <CardHeader>\n            <CardTitle>Top Countries</CardTitle>\n            <CardDescription>Countries with most visitors</CardDescription>\n          </CardHeader>\n          <CardContent>\n            <div className=\"space-y-3\">\n              {summary?.topCountries?.map((country, index) => (\n                <div key={country.country} className=\"flex items-center justify-between\">\n                  <div className=\"flex items-center space-x-3\">\n                    <Badge variant=\"secondary\">{index + 1}</Badge>\n                    <span className=\"font-medium\">{country.country}</span>\n                  </div>\n                  <span className=\"text-muted-foreground\">{country.count} visits</span>\n                </div>\n              )) || (\n                <p className=\"text-muted-foreground text-sm\">No country data available</p>\n              )}\n            </div>\n          </CardContent>\n        </Card>\n\n        {/* Detailed Visitor List */}\n        <Card data-testid=\"card-detailed-visitor-list\">\n          <CardHeader>\n            <CardTitle>Detailed Visitor Information</CardTitle>\n            <CardDescription>Complete visitor data with session details and return visits</CardDescription>\n          </CardHeader>\n          <CardContent>\n            {visitorsLoading ? (\n              <div className=\"space-y-3\">\n                {[1, 2, 3, 4, 5].map((i) => (\n                  <Skeleton key={i} className=\"h-16 w-full\" />\n                ))}\n              </div>\n            ) : (\n              <div className=\"rounded-md border\">\n                <Table>\n                  <TableHeader>\n                    <TableRow>\n                      <TableHead>IP Address</TableHead>\n                      <TableHead>Date & Time</TableHead>\n                      <TableHead>Duration</TableHead>\n                      <TableHead>Country</TableHead>\n                      <TableHead>Province/State</TableHead>\n                      <TableHead>City</TableHead>\n                      <TableHead>Returns</TableHead>\n                    </TableRow>\n                  </TableHeader>\n                  <TableBody>\n                    {visitors?.map((visitor) => (\n                      <TableRow key={visitor.id} data-testid={`row-detailed-visitor-${visitor.id}`}>\n                        <TableCell className=\"font-mono text-sm\">\n                          <div className=\"flex flex-col space-y-1\">\n                            <span>{visitor.ipAddress}</span>\n                            {visitor.isp && (\n                              <span className=\"text-xs text-muted-foreground\">{visitor.isp}</span>\n                            )}\n                          </div>\n                        </TableCell>\n                        <TableCell>\n                          <div className=\"flex flex-col space-y-1\">\n                            <span className=\"text-sm font-medium\">\n                              {format(new Date(visitor.visitedAt), 'MMM dd, yyyy')}\n                            </span>\n                            <span className=\"text-sm text-muted-foreground\">\n                              {format(new Date(visitor.visitedAt), 'HH:mm:ss')}\n                            </span>\n                            {visitor.timezone && (\n                              <span className=\"text-xs text-muted-foreground\">{visitor.timezone}</span>\n                            )}\n                          </div>\n                        </TableCell>\n                        <TableCell>\n                          <div className=\"flex items-center space-x-1\">\n                            <Clock className=\"h-3 w-3 text-muted-foreground\" />\n                            <span className=\"text-sm\">\n                              {visitor.duration ? \n                                `${Math.floor(visitor.duration / 60)}m ${visitor.duration % 60}s` : \n                                'Active'\n                              }\n                            </span>\n                          </div>\n                        </TableCell>\n                        <TableCell>\n                          <div className=\"flex items-center space-x-1\">\n                            <Globe className=\"h-3 w-3 text-muted-foreground\" />\n                            <span className=\"text-sm\">\n                              {visitor.country || 'Unknown'}\n                            </span>\n                          </div>\n                        </TableCell>\n                        <TableCell>\n                          <span className=\"text-sm\">\n                            {visitor.region || 'Unknown'}\n                          </span>\n                        </TableCell>\n                        <TableCell>\n                          <div className=\"flex flex-col space-y-1\">\n                            <div className=\"flex items-center space-x-1\">\n                              <MapPin className=\"h-3 w-3 text-muted-foreground\" />\n                              <span className=\"text-sm\">\n                                {visitor.city || 'Unknown'}\n                              </span>\n                            </div>\n                            {visitor.latitude && visitor.longitude && (\n                              <span className=\"text-xs text-muted-foreground font-mono\">\n                                {parseFloat(visitor.latitude).toFixed(3)}, {parseFloat(visitor.longitude).toFixed(3)}\n                              </span>\n                            )}\n                          </div>\n                        </TableCell>\n                        <TableCell>\n                          <div className=\"flex items-center space-x-2\">\n                            <Badge variant=\"secondary\" className=\"text-xs\">\n                              {visitor.returnVisits || 1}\n                            </Badge>\n                            <span className=\"text-xs text-muted-foreground\">\n                              {(visitor.returnVisits || 1) === 1 ? 'First visit' : 'Return visitor'}\n                            </span>\n                          </div>\n                        </TableCell>\n                      </TableRow>\n                    )) || (\n                      <TableRow>\n                        <TableCell colSpan={7} className=\"text-center text-muted-foreground py-8\">\n                          No visitor data available for the selected time period\n                        </TableCell>\n                      </TableRow>\n                    )}\n                  </TableBody>\n                </Table>\n              </div>\n            )}\n          </CardContent>\n        </Card>\n      </div>\n    </div>\n  );\n}","path":null,"size_bytes":11276,"size_tokens":null},"client/src/lib/utils.ts":{"content":"import { clsx, type ClassValue } from \"clsx\"\nimport { twMerge } from \"tailwind-merge\"\n\nexport function cn(...inputs: ClassValue[]) {\n  return twMerge(clsx(inputs))\n}\n","path":null,"size_bytes":166,"size_tokens":null},"client/src/lib/marketHours.ts":{"content":"import { DateTime } from 'luxon';\n\nexport interface MarketSession {\n  open: string; // HH:mm format in local exchange time\n  close: string; // HH:mm format in local exchange time\n}\n\nexport interface MarketHours {\n  timezone: string; // IANA timezone identifier\n  sessions: MarketSession[]; // Multiple sessions for markets with lunch breaks\n  days: number[]; // Days of week when market is open (1=Monday, 7=Sunday)\n  holidays?: string[]; // Optional holiday dates in YYYY-MM-DD format\n  halfDays?: { date: string; close: string }[]; // Early close days\n}\n\nexport interface MarketStatus {\n  isOpen: boolean;\n  nextTransition: DateTime;\n  nextTransitionType: 'open' | 'close';\n  currentSessionClose?: DateTime;\n  formattedCountdown: string;\n  marketHoursGMT: string;\n}\n\nexport function computeMarketStatus(marketHours: MarketHours): MarketStatus {\n  const now = DateTime.now().setZone('UTC');\n  const exchangeNow = now.setZone(marketHours.timezone);\n  \n  // Check if today is a trading day\n  const isWeekend = !marketHours.days.includes(exchangeNow.weekday);\n  \n  // Check for holidays (simple implementation - can be enhanced later)\n  const todayStr = exchangeNow.toISODate() || '';\n  const isHoliday = marketHours.holidays?.includes(todayStr) || false;\n  \n  if (isWeekend || isHoliday) {\n    // Market is closed, find next trading day\n    let nextTradingDay = exchangeNow.plus({ days: 1 });\n    while (!marketHours.days.includes(nextTradingDay.weekday) || \n           (marketHours.holidays && marketHours.holidays.includes(nextTradingDay.toISODate() || ''))) {\n      nextTradingDay = nextTradingDay.plus({ days: 1 });\n    }\n    \n    const nextOpen = nextTradingDay.set({\n      hour: parseInt(marketHours.sessions[0].open.split(':')[0]),\n      minute: parseInt(marketHours.sessions[0].open.split(':')[1]),\n      second: 0,\n      millisecond: 0\n    });\n    \n    const countdown = formatCountdown(now, nextOpen.toUTC());\n    const dayName = nextOpen.toFormat('ccc');\n    const timeGMT = nextOpen.toUTC().toFormat('HH:mm');\n    \n    return {\n      isOpen: false,\n      nextTransition: nextOpen.toUTC(),\n      nextTransitionType: 'open',\n      formattedCountdown: `Opens in ${countdown} (${dayName} ${timeGMT} GMT)`,\n      marketHoursGMT: formatMarketHoursGMT(marketHours)\n    };\n  }\n  \n  // Check current status during trading day\n  const currentTime = exchangeNow.toFormat('HH:mm');\n  let isCurrentlyOpen = false;\n  let currentSessionClose: DateTime | undefined;\n  let nextTransition: DateTime;\n  let nextTransitionType: 'open' | 'close';\n  \n  // Check if we're in any trading session\n  for (const session of marketHours.sessions) {\n    if (currentTime >= session.open && currentTime < session.close) {\n      isCurrentlyOpen = true;\n      currentSessionClose = exchangeNow.set({\n        hour: parseInt(session.close.split(':')[0]),\n        minute: parseInt(session.close.split(':')[1]),\n        second: 0,\n        millisecond: 0\n      });\n      break;\n    }\n  }\n  \n  if (isCurrentlyOpen && currentSessionClose) {\n    // Market is open, show countdown to close\n    nextTransition = currentSessionClose.toUTC();\n    nextTransitionType = 'close';\n  } else {\n    // Market is closed, find next session today or tomorrow\n    let nextOpenTime: DateTime | null = null;\n    \n    // Check remaining sessions today\n    for (const session of marketHours.sessions) {\n      if (currentTime < session.open) {\n        nextOpenTime = exchangeNow.set({\n          hour: parseInt(session.open.split(':')[0]),\n          minute: parseInt(session.open.split(':')[1]),\n          second: 0,\n          millisecond: 0\n        });\n        break;\n      }\n    }\n    \n    // If no more sessions today, get first session tomorrow\n    if (!nextOpenTime) {\n      let nextTradingDay = exchangeNow.plus({ days: 1 });\n      while (!marketHours.days.includes(nextTradingDay.weekday) || \n             (marketHours.holidays && marketHours.holidays.includes(nextTradingDay.toISODate() || ''))) {\n        nextTradingDay = nextTradingDay.plus({ days: 1 });\n      }\n      \n      nextOpenTime = nextTradingDay.set({\n        hour: parseInt(marketHours.sessions[0].open.split(':')[0]),\n        minute: parseInt(marketHours.sessions[0].open.split(':')[1]),\n        second: 0,\n        millisecond: 0\n      });\n    }\n    \n    nextTransition = nextOpenTime.toUTC();\n    nextTransitionType = 'open';\n  }\n  \n  const countdown = formatCountdown(now, nextTransition);\n  const actionText = nextTransitionType === 'close' ? 'Closes' : 'Opens';\n  const timeInfo = nextTransitionType === 'open' && !nextTransition.hasSame(now, 'day') \n    ? ` (${nextTransition.toFormat('ccc HH:mm')} GMT)`\n    : '';\n  \n  return {\n    isOpen: isCurrentlyOpen,\n    nextTransition,\n    nextTransitionType,\n    currentSessionClose,\n    formattedCountdown: `${actionText} in ${countdown}${timeInfo}`,\n    marketHoursGMT: formatMarketHoursGMT(marketHours)\n  };\n}\n\nfunction formatCountdown(now: DateTime, target: DateTime): string {\n  const diff = target.diff(now, ['hours', 'minutes', 'seconds']);\n  const hours = Math.floor(diff.hours);\n  const minutes = Math.floor(diff.minutes);\n  const seconds = Math.floor(diff.seconds);\n  \n  if (hours > 0) {\n    return `${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;\n  } else {\n    return `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;\n  }\n}\n\nfunction formatMarketHoursGMT(marketHours: MarketHours): string {\n  const sampleDate = DateTime.now().setZone(marketHours.timezone);\n  \n  const sessions = marketHours.sessions.map(session => {\n    const openLocal = sampleDate.set({\n      hour: parseInt(session.open.split(':')[0]),\n      minute: parseInt(session.open.split(':')[1])\n    });\n    const closeLocal = sampleDate.set({\n      hour: parseInt(session.close.split(':')[0]),\n      minute: parseInt(session.close.split(':')[1])\n    });\n    \n    const openGMT = openLocal.toUTC().toFormat('HH:mm');\n    const closeGMT = closeLocal.toUTC().toFormat('HH:mm');\n    \n    return `${openGMT}${closeGMT}`;\n  });\n  \n  if (sessions.length === 1) {\n    return `Market hours (GMT): ${sessions[0]}`;\n  } else {\n    return `Market hours (GMT): ${sessions.join(', ')}`;\n  }\n}","path":null,"size_bytes":6224,"size_tokens":null},"tailwind.config.ts":{"content":"import type { Config } from \"tailwindcss\";\n\nexport default {\n  darkMode: [\"class\"],\n  content: [\"./client/index.html\", \"./client/src/**/*.{js,jsx,ts,tsx}\"],\n  theme: {\n    extend: {\n      fontFamily: {\n        sans: ['Mulish', 'system-ui', 'sans-serif'],\n        serif: ['Space Grotesk', 'system-ui', 'serif'],\n        mono: ['Space Mono', 'monospace'],\n      },\n      fontWeight: {\n        light: '300',\n        normal: '400',\n        bold: '700',\n      },\n      borderRadius: {\n        lg: \"var(--radius)\",\n        md: \"calc(var(--radius) - 2px)\",\n        sm: \"calc(var(--radius) - 4px)\",\n      },\n      colors: {\n        background: \"var(--background)\",\n        foreground: \"var(--foreground)\",\n        card: {\n          DEFAULT: \"var(--card)\",\n          foreground: \"var(--card-foreground)\",\n        },\n        popover: {\n          DEFAULT: \"var(--popover)\",\n          foreground: \"var(--popover-foreground)\",\n        },\n        primary: {\n          DEFAULT: \"var(--primary)\",\n          foreground: \"var(--primary-foreground)\",\n        },\n        secondary: {\n          DEFAULT: \"var(--secondary)\",\n          foreground: \"var(--secondary-foreground)\",\n        },\n        muted: {\n          DEFAULT: \"var(--muted)\",\n          foreground: \"var(--muted-foreground)\",\n        },\n        accent: {\n          DEFAULT: \"var(--accent)\",\n          foreground: \"var(--accent-foreground)\",\n        },\n        destructive: {\n          DEFAULT: \"var(--destructive)\",\n          foreground: \"var(--destructive-foreground)\",\n        },\n        border: \"var(--border)\",\n        input: \"var(--input)\",\n        ring: \"var(--ring)\",\n        chart: {\n          \"1\": \"var(--chart-1)\",\n          \"2\": \"var(--chart-2)\",\n          \"3\": \"var(--chart-3)\",\n          \"4\": \"var(--chart-4)\",\n          \"5\": \"var(--chart-5)\",\n        },\n        sidebar: {\n          DEFAULT: \"var(--sidebar-background)\",\n          foreground: \"var(--sidebar-foreground)\",\n          primary: \"var(--sidebar-primary)\",\n          \"primary-foreground\": \"var(--sidebar-primary-foreground)\",\n          accent: \"var(--sidebar-accent)\",\n          \"accent-foreground\": \"var(--sidebar-accent-foreground)\",\n          border: \"var(--sidebar-border)\",\n          ring: \"var(--sidebar-ring)\",\n        },\n      },\n      keyframes: {\n        \"accordion-down\": {\n          from: {\n            height: \"0\",\n          },\n          to: {\n            height: \"var(--radix-accordion-content-height)\",\n          },\n        },\n        \"accordion-up\": {\n          from: {\n            height: \"var(--radix-accordion-content-height)\",\n          },\n          to: {\n            height: \"0\",\n          },\n        },\n      },\n      animation: {\n        \"accordion-down\": \"accordion-down 0.2s ease-out\",\n        \"accordion-up\": \"accordion-up 0.2s ease-out\",\n      },\n    },\n  },\n  plugins: [require(\"tailwindcss-animate\"), require(\"@tailwindcss/typography\")],\n} satisfies Config;\n","path":null,"size_bytes":2903,"size_tokens":null},"client/src/components/ui/menubar.tsx":{"content":"\"use client\"\n\nimport * as React from \"react\"\nimport * as MenubarPrimitive from \"@radix-ui/react-menubar\"\nimport { Check, ChevronRight, Circle } from \"lucide-react\"\n\nimport { cn } from \"@/lib/utils\"\n\nfunction MenubarMenu({\n  ...props\n}: React.ComponentProps<typeof MenubarPrimitive.Menu>) {\n  return <MenubarPrimitive.Menu {...props} />\n}\n\nfunction MenubarGroup({\n  ...props\n}: React.ComponentProps<typeof MenubarPrimitive.Group>) {\n  return <MenubarPrimitive.Group {...props} />\n}\n\nfunction MenubarPortal({\n  ...props\n}: React.ComponentProps<typeof MenubarPrimitive.Portal>) {\n  return <MenubarPrimitive.Portal {...props} />\n}\n\nfunction MenubarRadioGroup({\n  ...props\n}: React.ComponentProps<typeof MenubarPrimitive.RadioGroup>) {\n  return <MenubarPrimitive.RadioGroup {...props} />\n}\n\nfunction MenubarSub({\n  ...props\n}: React.ComponentProps<typeof MenubarPrimitive.Sub>) {\n  return <MenubarPrimitive.Sub data-slot=\"menubar-sub\" {...props} />\n}\n\nconst Menubar = React.forwardRef<\n  React.ElementRef<typeof MenubarPrimitive.Root>,\n  React.ComponentPropsWithoutRef<typeof MenubarPrimitive.Root>\n>(({ className, ...props }, ref) => (\n  <MenubarPrimitive.Root\n    ref={ref}\n    className={cn(\n      \"flex h-10 items-center space-x-1 rounded-md border bg-background p-1\",\n      className\n    )}\n    {...props}\n  />\n))\nMenubar.displayName = MenubarPrimitive.Root.displayName\n\nconst MenubarTrigger = React.forwardRef<\n  React.ElementRef<typeof MenubarPrimitive.Trigger>,\n  React.ComponentPropsWithoutRef<typeof MenubarPrimitive.Trigger>\n>(({ className, ...props }, ref) => (\n  <MenubarPrimitive.Trigger\n    ref={ref}\n    className={cn(\n      \"flex cursor-default select-none items-center rounded-sm px-3 py-1.5 text-sm font-medium outline-none focus:bg-accent focus:text-accent-foreground data-[state=open]:bg-accent data-[state=open]:text-accent-foreground\",\n      className\n    )}\n    {...props}\n  />\n))\nMenubarTrigger.displayName = MenubarPrimitive.Trigger.displayName\n\nconst MenubarSubTrigger = React.forwardRef<\n  React.ElementRef<typeof MenubarPrimitive.SubTrigger>,\n  React.ComponentPropsWithoutRef<typeof MenubarPrimitive.SubTrigger> & {\n    inset?: boolean\n  }\n>(({ className, inset, children, ...props }, ref) => (\n  <MenubarPrimitive.SubTrigger\n    ref={ref}\n    className={cn(\n      \"flex cursor-default select-none items-center rounded-sm px-2 py-1.5 text-sm outline-none focus:bg-accent focus:text-accent-foreground data-[state=open]:bg-accent data-[state=open]:text-accent-foreground\",\n      inset && \"pl-8\",\n      className\n    )}\n    {...props}\n  >\n    {children}\n    <ChevronRight className=\"ml-auto h-4 w-4\" />\n  </MenubarPrimitive.SubTrigger>\n))\nMenubarSubTrigger.displayName = MenubarPrimitive.SubTrigger.displayName\n\nconst MenubarSubContent = React.forwardRef<\n  React.ElementRef<typeof MenubarPrimitive.SubContent>,\n  React.ComponentPropsWithoutRef<typeof MenubarPrimitive.SubContent>\n>(({ className, ...props }, ref) => (\n  <MenubarPrimitive.SubContent\n    ref={ref}\n    className={cn(\n      \"z-50 min-w-[8rem] overflow-hidden rounded-md border bg-popover p-1 text-popover-foreground data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 data-[side=bottom]:slide-in-from-top-2 data-[side=left]:slide-in-from-right-2 data-[side=right]:slide-in-from-left-2 data-[side=top]:slide-in-from-bottom-2 origin-[--radix-menubar-content-transform-origin]\",\n      className\n    )}\n    {...props}\n  />\n))\nMenubarSubContent.displayName = MenubarPrimitive.SubContent.displayName\n\nconst MenubarContent = React.forwardRef<\n  React.ElementRef<typeof MenubarPrimitive.Content>,\n  React.ComponentPropsWithoutRef<typeof MenubarPrimitive.Content>\n>(\n  (\n    { className, align = \"start\", alignOffset = -4, sideOffset = 8, ...props },\n    ref\n  ) => (\n    <MenubarPrimitive.Portal>\n      <MenubarPrimitive.Content\n        ref={ref}\n        align={align}\n        alignOffset={alignOffset}\n        sideOffset={sideOffset}\n        className={cn(\n          \"z-50 min-w-[12rem] overflow-hidden rounded-md border bg-popover p-1 text-popover-foreground shadow-md data-[state=open]:animate-in data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 data-[side=bottom]:slide-in-from-top-2 data-[side=left]:slide-in-from-right-2 data-[side=right]:slide-in-from-left-2 data-[side=top]:slide-in-from-bottom-2 origin-[--radix-menubar-content-transform-origin]\",\n          className\n        )}\n        {...props}\n      />\n    </MenubarPrimitive.Portal>\n  )\n)\nMenubarContent.displayName = MenubarPrimitive.Content.displayName\n\nconst MenubarItem = React.forwardRef<\n  React.ElementRef<typeof MenubarPrimitive.Item>,\n  React.ComponentPropsWithoutRef<typeof MenubarPrimitive.Item> & {\n    inset?: boolean\n  }\n>(({ className, inset, ...props }, ref) => (\n  <MenubarPrimitive.Item\n    ref={ref}\n    className={cn(\n      \"relative flex cursor-default select-none items-center rounded-sm px-2 py-1.5 text-sm outline-none focus:bg-accent focus:text-accent-foreground data-[disabled]:pointer-events-none data-[disabled]:opacity-50\",\n      inset && \"pl-8\",\n      className\n    )}\n    {...props}\n  />\n))\nMenubarItem.displayName = MenubarPrimitive.Item.displayName\n\nconst MenubarCheckboxItem = React.forwardRef<\n  React.ElementRef<typeof MenubarPrimitive.CheckboxItem>,\n  React.ComponentPropsWithoutRef<typeof MenubarPrimitive.CheckboxItem>\n>(({ className, children, checked, ...props }, ref) => (\n  <MenubarPrimitive.CheckboxItem\n    ref={ref}\n    className={cn(\n      \"relative flex cursor-default select-none items-center rounded-sm py-1.5 pl-8 pr-2 text-sm outline-none focus:bg-accent focus:text-accent-foreground data-[disabled]:pointer-events-none data-[disabled]:opacity-50\",\n      className\n    )}\n    checked={checked}\n    {...props}\n  >\n    <span className=\"absolute left-2 flex h-3.5 w-3.5 items-center justify-center\">\n      <MenubarPrimitive.ItemIndicator>\n        <Check className=\"h-4 w-4\" />\n      </MenubarPrimitive.ItemIndicator>\n    </span>\n    {children}\n  </MenubarPrimitive.CheckboxItem>\n))\nMenubarCheckboxItem.displayName = MenubarPrimitive.CheckboxItem.displayName\n\nconst MenubarRadioItem = React.forwardRef<\n  React.ElementRef<typeof MenubarPrimitive.RadioItem>,\n  React.ComponentPropsWithoutRef<typeof MenubarPrimitive.RadioItem>\n>(({ className, children, ...props }, ref) => (\n  <MenubarPrimitive.RadioItem\n    ref={ref}\n    className={cn(\n      \"relative flex cursor-default select-none items-center rounded-sm py-1.5 pl-8 pr-2 text-sm outline-none focus:bg-accent focus:text-accent-foreground data-[disabled]:pointer-events-none data-[disabled]:opacity-50\",\n      className\n    )}\n    {...props}\n  >\n    <span className=\"absolute left-2 flex h-3.5 w-3.5 items-center justify-center\">\n      <MenubarPrimitive.ItemIndicator>\n        <Circle className=\"h-2 w-2 fill-current\" />\n      </MenubarPrimitive.ItemIndicator>\n    </span>\n    {children}\n  </MenubarPrimitive.RadioItem>\n))\nMenubarRadioItem.displayName = MenubarPrimitive.RadioItem.displayName\n\nconst MenubarLabel = React.forwardRef<\n  React.ElementRef<typeof MenubarPrimitive.Label>,\n  React.ComponentPropsWithoutRef<typeof MenubarPrimitive.Label> & {\n    inset?: boolean\n  }\n>(({ className, inset, ...props }, ref) => (\n  <MenubarPrimitive.Label\n    ref={ref}\n    className={cn(\n      \"px-2 py-1.5 text-sm font-semibold\",\n      inset && \"pl-8\",\n      className\n    )}\n    {...props}\n  />\n))\nMenubarLabel.displayName = MenubarPrimitive.Label.displayName\n\nconst MenubarSeparator = React.forwardRef<\n  React.ElementRef<typeof MenubarPrimitive.Separator>,\n  React.ComponentPropsWithoutRef<typeof MenubarPrimitive.Separator>\n>(({ className, ...props }, ref) => (\n  <MenubarPrimitive.Separator\n    ref={ref}\n    className={cn(\"-mx-1 my-1 h-px bg-muted\", className)}\n    {...props}\n  />\n))\nMenubarSeparator.displayName = MenubarPrimitive.Separator.displayName\n\nconst MenubarShortcut = ({\n  className,\n  ...props\n}: React.HTMLAttributes<HTMLSpanElement>) => {\n  return (\n    <span\n      className={cn(\n        \"ml-auto text-xs tracking-widest text-muted-foreground\",\n        className\n      )}\n      {...props}\n    />\n  )\n}\nMenubarShortcut.displayname = \"MenubarShortcut\"\n\nexport {\n  Menubar,\n  MenubarMenu,\n  MenubarTrigger,\n  MenubarContent,\n  MenubarItem,\n  MenubarSeparator,\n  MenubarLabel,\n  MenubarCheckboxItem,\n  MenubarRadioGroup,\n  MenubarRadioItem,\n  MenubarPortal,\n  MenubarSubContent,\n  MenubarSubTrigger,\n  MenubarGroup,\n  MenubarSub,\n  MenubarShortcut,\n}\n","path":null,"size_bytes":8605,"size_tokens":null},"client/src/components/ui/textarea.tsx":{"content":"import * as React from \"react\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst Textarea = React.forwardRef<\n  HTMLTextAreaElement,\n  React.ComponentProps<\"textarea\">\n>(({ className, ...props }, ref) => {\n  return (\n    <textarea\n      className={cn(\n        \"flex min-h-[80px] w-full rounded-md border border-input bg-background px-3 py-2 text-base ring-offset-background placeholder:text-muted-foreground focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:cursor-not-allowed disabled:opacity-50 md:text-sm\",\n        className\n      )}\n      ref={ref}\n      {...props}\n    />\n  )\n})\nTextarea.displayName = \"Textarea\"\n\nexport { Textarea }\n","path":null,"size_bytes":689,"size_tokens":null},"client/src/pages/chartmaker.tsx":{"content":"import { useState, useEffect, useRef } from \"react\";\nimport { createPortal } from \"react-dom\";\nimport { useQuery } from \"@tanstack/react-query\";\nimport { Input } from \"@/components/ui/input\";\nimport { Card } from \"@/components/ui/card\";\nimport { Button } from \"@/components/ui/button\";\nimport { Switch } from \"@/components/ui/switch\";\nimport { Search, TrendingUp, TrendingDown, BarChart3, Trash2, RotateCcw, BarChart2, Cookie, X, Globe, LogOut, MessageSquare, BookOpen } from \"lucide-react\";\nimport { Link, useLocation } from \"wouter\";\nimport { cn } from \"@/lib/utils\";\nimport { PriceChart } from \"@/components/dashboard/price-chart\";\nimport { FeedbackForm } from \"@/components/feedback-form\";\nimport { SuffixSearchModal } from \"@/components/suffix-search-modal\";\nimport { useAuth } from \"@/contexts/AuthContext\";\nimport logoImage from \"@assets/IPO Intelligence@2x_1758060026530.png\";\nimport { format } from \"date-fns\";\nimport type { ChartHistory } from \"@shared/schema\";\nimport {\n  Select,\n  SelectContent,\n  SelectItem,\n  SelectTrigger,\n  SelectValue,\n} from \"@/components/ui/select\";\n\ninterface GlobalSearchResult {\n  symbol: string;\n  description: string;\n  displaySymbol: string;\n  type: string;\n  exchange?: string;\n  currency?: string;\n}\n\ninterface Annotation {\n  id: string;\n  type: 'text' | 'percentage' | 'horizontal' | 'note';\n  x: number;\n  y: number;\n  timestamp: number;\n  price: number;\n  text?: string;\n  time: string;\n  horizontalOffset?: number;\n  verticalOffset?: number;\n  // For percentage measurements\n  startTimestamp?: number;\n  startPrice?: number;\n  startTime?: string;\n  endTimestamp?: number;\n  endPrice?: number;\n  endTime?: string;\n  percentage?: number;\n}\n\ninterface GlobalTickerSearchProps {\n  onSelectStock?: (stock: GlobalSearchResult) => void;\n}\n\n// Annotation persistence helpers\nconst getStoredAnnotations = (): Record<string, Annotation[]> => {\n  try {\n    const stored = localStorage.getItem('chartmaker-annotations');\n    return stored ? JSON.parse(stored) : {};\n  } catch {\n    return {};\n  }\n};\n\nconst saveAnnotations = (annotationsBySymbol: Record<string, Annotation[]>) => {\n  try {\n    localStorage.setItem('chartmaker-annotations', JSON.stringify(annotationsBySymbol));\n  } catch {\n    // Ignore localStorage errors\n  }\n};\n\nconst getRememberSetting = (): boolean => {\n  try {\n    const stored = localStorage.getItem('chartmaker-remember-per-ticker');\n    return stored !== null ? JSON.parse(stored) : true; // Default to true\n  } catch {\n    return true;\n  }\n};\n\nconst saveRememberSetting = (remember: boolean) => {\n  try {\n    localStorage.setItem('chartmaker-remember-per-ticker', JSON.stringify(remember));\n  } catch {\n    // Ignore localStorage errors\n  }\n};\n\nfunction LogoutButton() {\n  const { logout } = useAuth();\n  const [, setLocation] = useLocation();\n\n  const handleLogout = () => {\n    logout();\n    setLocation('/login');\n  };\n\n  return (\n    <button\n      onClick={handleLogout}\n      className=\"flex items-center gap-2 hover:opacity-80 transition-opacity\"\n      data-testid=\"button-logout\"\n      style={{ fontFamily: 'var(--font-sans)', fontSize: '16px', color: '#f7f7f7' }}\n    >\n      <LogOut className=\"h-5 w-5 text-[#5AF5FA]\" />\n      <span>Sign Out</span>\n    </button>\n  );\n}\n\nfunction GlobalTickerSearch({ onSelectStock }: GlobalTickerSearchProps) {\n  const [searchQuery, setSearchQuery] = useState(\"\");\n  const [debouncedQuery, setDebouncedQuery] = useState(\"\");\n  const [isOpen, setIsOpen] = useState(false);\n  const [selectedStock, setSelectedStock] = useState<GlobalSearchResult | null>(null);\n  const containerRef = useRef<HTMLDivElement>(null);\n  const inputRef = useRef<HTMLInputElement>(null);\n  const [dropdownPosition, setDropdownPosition] = useState({ top: 0, left: 0, width: 0 });\n  const [recentSearches, setRecentSearches] = useState<GlobalSearchResult[]>([]);\n\n  // Load recent searches from localStorage on mount\n  useEffect(() => {\n    const saved = localStorage.getItem('recentTickerSearches');\n    if (saved) {\n      try {\n        setRecentSearches(JSON.parse(saved));\n      } catch (error) {\n        console.error('Error parsing recent searches:', error);\n      }\n    }\n  }, []);\n\n  // Debounce search query\n  useEffect(() => {\n    const timer = setTimeout(() => {\n      setDebouncedQuery(searchQuery);\n    }, 500);\n\n    return () => clearTimeout(timer);\n  }, [searchQuery]);\n\n  // Fetch global search results using Finnhub API\n  const { data: searchResults = [], isLoading } = useQuery({\n    queryKey: [\"/api/stocks/global-search\", debouncedQuery],\n    queryFn: async (): Promise<GlobalSearchResult[]> => {\n      if (!debouncedQuery || debouncedQuery.trim().length < 2) {\n        return [];\n      }\n      const response = await fetch(`/api/stocks/global-search?q=${encodeURIComponent(debouncedQuery.trim())}`);\n      if (!response.ok) throw new Error(\"Global search failed\");\n      return await response.json();\n    },\n    enabled: debouncedQuery.trim().length >= 2,\n  });\n\n  const updateDropdownPosition = () => {\n    if (inputRef.current) {\n      const rect = inputRef.current.getBoundingClientRect();\n      setDropdownPosition({\n        top: rect.bottom + window.scrollY + 4,\n        left: rect.left + window.scrollX,\n        width: rect.width\n      });\n    }\n  };\n\n  const handleInputChange = (value: string) => {\n    setSearchQuery(value);\n    updateDropdownPosition();\n    setIsOpen(true);\n  };\n\n  const handleInputFocus = (e: React.FocusEvent<HTMLInputElement>) => {\n    // Check actual input value to handle cases where state might be out of sync\n    const actualValue = inputRef.current?.value || '';\n    const isActuallyEmpty = actualValue.trim() === '';\n    \n    // Sync state with actual input if they're different\n    if (isActuallyEmpty && searchQuery !== '') {\n      setSearchQuery('');\n    }\n    \n    // Auto-select text if there's content when focusing\n    if (actualValue.trim() && inputRef.current) {\n      setTimeout(() => {\n        if (inputRef.current) {\n          inputRef.current.select();\n        }\n      }, 10);\n    }\n    \n    updateDropdownPosition();\n    setIsOpen(true);\n  };\n\n  const handleSelectStock = (stock: GlobalSearchResult) => {\n    setSearchQuery(`${stock.displaySymbol} - ${stock.description}`);\n    setIsOpen(false);\n    setSelectedStock(stock);\n    onSelectStock?.(stock);\n    \n    // Add to recent searches\n    addToRecentSearches(stock);\n  };\n\n\n  const addToRecentSearches = (stock: GlobalSearchResult) => {\n    const newRecent = [stock, ...recentSearches.filter(s => s.displaySymbol !== stock.displaySymbol)].slice(0, 6);\n    setRecentSearches(newRecent);\n    localStorage.setItem('recentTickerSearches', JSON.stringify(newRecent));\n  };\n  \n\n  // Type display text conversion - convert ETP to ETF for display\n  const getDisplayType = (type: string | undefined) => {\n    if (!type) return \"Common Stock\";\n    if (type.toLowerCase() === 'etp') return 'ETF';\n    return type;\n  };\n\n  const getTypeColor = (type: string) => {\n    switch (type.toLowerCase()) {\n      case 'common stock':\n        return 'text-blue-600 dark:text-blue-400 bg-blue-500/10';\n      case 'etp':\n      case 'etf':\n        return 'text-[#FFA5FF] bg-[#FFA5FF]/30'; // Pink ETF styling as requested\n      case 'index':\n        return 'index-tag'; // Brand yellow with 30% opacity background, 100% text\n      case 'reit':\n        return 'text-purple-600 dark:text-purple-400 bg-purple-500/10';\n      case 'mutual fund':\n        return 'text-orange-600 dark:text-orange-400 bg-orange-500/10';\n      default:\n        return 'text-gray-600 dark:text-gray-400 bg-gray-500/10';\n    }\n  };\n\n  return (\n    <div ref={containerRef} className=\"relative\">\n      {/* Search Input */}\n      <div className=\"relative\">\n        <Search className=\"absolute left-3 top-1/2 transform -translate-y-1/2 text-muted-foreground w-4 h-4\" />\n        <Input\n          ref={inputRef}\n          type=\"text\"\n          placeholder=\"Search global stocks, indices, ETFs, and companies...\"\n          value={searchQuery}\n          onChange={(e) => handleInputChange(e.target.value)}\n          onFocus={handleInputFocus}\n          className=\"pl-10 pr-4 bg-background border-border focus:border-[#5AF5FA] focus:ring-[#5AF5FA]/20 text-lg py-3\"\n        />\n      </div>\n\n      {/* Search Results Dropdown */}\n      {isOpen && createPortal(\n        <Card \n          className=\"max-h-80 overflow-y-auto shadow-xl border-border bg-card\"\n          style={{\n            position: 'absolute',\n            top: dropdownPosition.top,\n            left: dropdownPosition.left,\n            width: dropdownPosition.width,\n            zIndex: 10000\n          }}\n        >\n          {/* Show recent searches when query is empty */}\n          {(searchQuery.trim() === '' && recentSearches.length > 0) ? (\n            <div className=\"py-2\">\n              <div className=\"px-4 py-2 text-xs font-medium text-muted-foreground border-b border-border/50\">\n                Recent Searches\n              </div>\n              {recentSearches.map((stock, index) => (\n                <div\n                  key={`recent-${stock.symbol}-${index}`}\n                  className=\"w-full px-4 py-3 hover:bg-muted/50 transition-colors border-b border-border/50 last:border-b-0 cursor-pointer\"\n                  onClick={() => handleSelectStock(stock)}\n                >\n                  <div className=\"flex items-center justify-between\">\n                    <div className=\"flex-1 min-w-0\">\n                      <div className=\"flex items-center gap-3\">\n                        <span className=\"font-semibold text-foreground text-lg\">{stock.displaySymbol}</span>\n                        <div className={cn(\n                          \"px-2 py-1 rounded-md text-xs font-medium\",\n                          getTypeColor(stock.type)\n                        )}>\n                          {stock.type}\n                        </div>\n                      </div>\n                      <div className=\"text-sm text-muted-foreground mt-1 truncate\">\n                        {stock.description}\n                        {stock.exchange && stock.currency && (\n                          <span className=\"ml-2 text-[#5AF5FA]\">\n                            - {stock.exchange} - {stock.currency}\n                          </span>\n                        )}\n                      </div>\n                    </div>\n                    <div className=\"flex items-center gap-2 ml-4\">\n                      <BarChart3 className=\"w-4 h-4 text-[#5AF5FA]\" />\n                    </div>\n                  </div>\n                </div>\n              ))}\n            </div>\n          ) : searchQuery ? (\n            // Show search results when typing\n            isLoading ? (\n              <div className=\"p-4 text-center text-muted-foreground\">\n                <div className=\"flex items-center justify-center gap-2\">\n                  <div className=\"w-4 h-4 border-2 border-[#5AF5FA] border-t-transparent rounded-full animate-spin\" />\n                  Searching global markets...\n                </div>\n              </div>\n            ) : searchResults.length > 0 ? (\n              <div className=\"py-2\">\n                {searchResults.map((stock, index) => (\n                  <div\n                    key={`${stock.symbol}-${index}`}\n                    className=\"w-full px-4 py-3 hover:bg-muted/50 transition-colors border-b border-border/50 last:border-b-0 cursor-pointer\"\n                    onClick={() => handleSelectStock(stock)}\n                  >\n                    <div className=\"flex items-center justify-between\">\n                      <div className=\"flex-1 min-w-0\">\n                        <div className=\"flex items-center gap-3\">\n                          <span className=\"font-semibold text-foreground text-lg\">{stock.displaySymbol}</span>\n                          <div className={cn(\n                            \"px-2 py-1 rounded-md text-xs font-medium\",\n                            getTypeColor(stock.type)\n                          )}>\n                            {getDisplayType(stock.type)}\n                          </div>\n                        </div>\n                        <div className=\"text-sm text-muted-foreground mt-1 truncate\">\n                          {stock.description}\n                          {stock.exchange && stock.currency && (\n                            <span className=\"ml-2 text-[#5AF5FA]\">\n                              - {stock.exchange} - {stock.currency}\n                            </span>\n                          )}\n                        </div>\n                      </div>\n                      <div className=\"flex items-center gap-2 ml-4\">\n                        <BarChart3 className=\"w-4 h-4 text-[#5AF5FA]\" />\n                      </div>\n                    </div>\n                  </div>\n                ))}\n              </div>\n            ) : debouncedQuery && !isLoading ? (\n              <div className=\"p-4 text-center text-muted-foreground\">\n                No global stocks found for \"{debouncedQuery}\"\n              </div>\n            ) : null\n          ) : null}\n        </Card>,\n        document.body\n      )}\n\n      {/* Backdrop to close dropdown */}\n      {isOpen && (\n        <div\n          className=\"fixed inset-0 z-[9998]\"\n          onClick={() => setIsOpen(false)}\n        />\n      )}\n\n\n    </div>\n  );\n}\n\nfunction FeedbackButton() {\n  const [isOpen, setIsOpen] = useState(false);\n\n  return (\n    <>\n      <button\n        onClick={() => setIsOpen(true)}\n        className=\"flex items-center gap-2 hover:opacity-80 transition-opacity\"\n        data-testid=\"button-feedback\"\n        style={{ fontSize: '16px', color: '#f7f7f7' }}\n      >\n        <MessageSquare className=\"h-5 w-5 text-[#5AF5FA]\" />\n        <span>Issues / Feedback</span>\n      </button>\n      <FeedbackForm open={isOpen} onOpenChange={setIsOpen} />\n    </>\n  );\n}\n\n// Cookie Policy Banner Component\nfunction CookiePolicyBanner() {\n  const [showBanner, setShowBanner] = useState(false);\n\n  useEffect(() => {\n    // Check if user has already accepted/declined cookies\n    const cookieConsent = localStorage.getItem('cookie-consent');\n    if (!cookieConsent) {\n      setShowBanner(true);\n    }\n  }, []);\n\n  const handleAccept = () => {\n    localStorage.setItem('cookie-consent', 'accepted');\n    setShowBanner(false);\n  };\n\n  const handleDecline = () => {\n    localStorage.setItem('cookie-consent', 'declined');\n    setShowBanner(false);\n  };\n\n  if (!showBanner) return null;\n\n  return (\n    <div className=\"fixed bottom-0 left-0 right-0 z-50 p-4 bg-card border-t shadow-lg\" data-testid=\"cookie-policy-banner\">\n      <div className=\"max-w-7xl mx-auto\">\n        <div className=\"flex flex-col md:flex-row items-start md:items-center justify-between gap-4\">\n          <div className=\"flex items-start gap-3 flex-1\">\n            <Cookie className=\"w-5 h-5 text-[#5AF5FA] mt-0.5 flex-shrink-0\" />\n            <div className=\"text-sm\">\n              <p className=\"text-foreground\">\n                <strong>Cookie Policy:</strong> This website uses necessary cookies to ensure optimal functionality and enhance your browsing experience. \n                We use session cookies for chart annotations and visitor analytics. No personal data is shared with third parties.\n              </p>\n            </div>\n          </div>\n          <div className=\"flex items-center gap-3 flex-shrink-0\">\n            <Button \n              variant=\"outline\" \n              size=\"sm\" \n              onClick={handleDecline}\n              data-testid=\"button-decline-cookies\"\n              className=\"text-xs\"\n            >\n              Decline\n            </Button>\n            <Button \n              size=\"sm\" \n              onClick={handleAccept}\n              data-testid=\"button-accept-cookies\"\n              className=\"bg-[#5AF5FA] hover:bg-[#4FE5EA] text-black text-xs\"\n            >\n              Accept\n            </Button>\n            <Button\n              variant=\"ghost\"\n              size=\"sm\"\n              onClick={() => setShowBanner(false)}\n              data-testid=\"button-close-banner\"\n              className=\"p-1 h-auto\"\n            >\n              <X className=\"w-4 h-4\" />\n            </Button>\n          </div>\n        </div>\n      </div>\n    </div>\n  );\n}\n\nfunction ChartMaker() {\n  const [, setLocation] = useLocation();\n  const [chartMakerSelectedStock, setChartMakerSelectedStock] = useState<GlobalSearchResult | null>(null);\n  \n  // Chart history restoration state\n  const [pendingHistoryRestore, setPendingHistoryRestore] = useState<ChartHistory | null>(null);\n  \n  // Annotation state management - moved from GlobalTickerSearch\n  const [annotationsBySymbol, setAnnotationsBySymbol] = useState<Record<string, Annotation[]>>(() => getStoredAnnotations());\n  const [rememberPerTicker, setRememberPerTicker] = useState(() => getRememberSetting());\n  \n  // Refs and state for programmatic actions from walkthrough\n  const suffixButtonRef = useRef<HTMLButtonElement>(null);\n  const [initialTab, setInitialTab] = useState<'price-volume' | 'comparison'>('price-volume');\n  const [triggerSuffixModal, setTriggerSuffixModal] = useState(false);\n  \n  // Handle query parameter actions from walkthrough on mount\n  useEffect(() => {\n    const params = new URLSearchParams(window.location.search);\n    const action = params.get('action');\n    \n    if (action === 'suffix-guide') {\n      setTriggerSuffixModal(true);\n      window.history.replaceState({}, '', '/');\n    } else if (action === 'compare') {\n      setInitialTab('comparison');\n      window.history.replaceState({}, '', '/');\n    }\n  }, []);\n  \n  // Trigger suffix modal after component mounts\n  useEffect(() => {\n    if (triggerSuffixModal && suffixButtonRef.current) {\n      setTimeout(() => {\n        suffixButtonRef.current?.click();\n        setTriggerSuffixModal(false);\n      }, 100);\n    }\n  }, [triggerSuffixModal]);\n  \n  // Current annotations for selected stock\n  const currentAnnotations = chartMakerSelectedStock && rememberPerTicker \n    ? annotationsBySymbol[chartMakerSelectedStock.displaySymbol] || []\n    : [];\n\n  // Annotation management functions\n  const handleAnnotationsChange = (newAnnotations: Annotation[]) => {\n    if (chartMakerSelectedStock && rememberPerTicker) {\n      const updated = {\n        ...annotationsBySymbol,\n        [chartMakerSelectedStock.displaySymbol]: newAnnotations\n      };\n      setAnnotationsBySymbol(updated);\n      saveAnnotations(updated);\n    }\n  };\n  \n  const handleRememberToggle = (remember: boolean) => {\n    setRememberPerTicker(remember);\n    saveRememberSetting(remember);\n  };\n  \n  const clearCurrentTickerAnnotations = () => {\n    if (chartMakerSelectedStock) {\n      const updated = { ...annotationsBySymbol };\n      delete updated[chartMakerSelectedStock.displaySymbol];\n      setAnnotationsBySymbol(updated);\n      saveAnnotations(updated);\n    }\n  };\n  \n  const clearAllAnnotations = () => {\n    setAnnotationsBySymbol({});\n    saveAnnotations({});\n  };\n\n  const handleIndexSelect = (symbol: string, name: string) => {\n    const indexResult: GlobalSearchResult = {\n      symbol: symbol,\n      description: name,\n      displaySymbol: symbol,\n      type: 'Index',\n      exchange: symbol.startsWith('^') ? 'Index' : 'ETF',\n      currency: symbol.startsWith('^') ? 'USD' : 'USD'\n    };\n    \n    setChartMakerSelectedStock(indexResult);\n  };\n  \n  // Handler for when a chart history card is clicked\n  const handleHistorySelect = (entry: ChartHistory) => {\n    // Store the pending restore entry\n    setPendingHistoryRestore(entry);\n    \n    // Create a GlobalSearchResult from the history entry and switch to that ticker\n    const stockResult: GlobalSearchResult = {\n      symbol: entry.symbol,\n      description: entry.symbol, // We don't have full description in history, use symbol\n      displaySymbol: entry.symbol,\n      type: 'Stock',\n      exchange: '',\n      currency: 'USD'\n    };\n    \n    setChartMakerSelectedStock(stockResult);\n  };\n  \n  // Handler for when restoration is complete\n  const handleHistoryRestoreComplete = () => {\n    setPendingHistoryRestore(null);\n  };\n\n  // Fetch chart history\n  const { data: chartHistory = [] } = useQuery<ChartHistory[]>({\n    queryKey: ['/api/chart-history'],\n  });\n\n  return (\n    <div className=\"min-h-screen bg-background text-foreground\">\n      {/* Navigation Header */}\n      <header className=\"border-b border-border sticky top-0 z-50 bg-background/95 backdrop-blur supports-[backdrop-filter]:bg-background/60\">\n        <div className=\"container mx-auto px-4 py-4\">\n          <div className=\"flex items-center justify-between\">\n            {/* Logo */}\n            <Link href=\"/\">\n              <img src={logoImage} alt=\"Logo\" className=\"w-[240px] h-auto max-[600px]:w-[180px] hover:opacity-80 transition-opacity cursor-pointer\" data-testid=\"link-home\" />\n            </Link>\n\n            {/* Navigation Items */}\n            <nav className=\"flex items-center gap-6\">\n              {/* Chart Type Dropdown */}\n              <Select value=\"/price-chart\" onValueChange={(value) => setLocation(value)}>\n                <SelectTrigger \n                  className=\"w-[200px] bg-card border-border\"\n                  data-testid=\"select-chart-type\"\n                  style={{ fontFamily: 'var(--font-sans)' }}\n                >\n                  <SelectValue placeholder=\"Chart Type\" />\n                </SelectTrigger>\n                <SelectContent style={{ backgroundColor: '#3A3A3A' }}>\n                  <SelectItem value=\"/price-chart\">Price Chart</SelectItem>\n                  <SelectItem value=\"/comparison-chart\">Comparison Chart</SelectItem>\n                  <SelectItem value=\"/ai-copilot\">AI Co-Pilot</SelectItem>\n                </SelectContent>\n              </Select>\n\n              {/* Walkthrough Link */}\n              <Link href=\"/walkthrough\">\n                <span \n                  className=\"flex items-center gap-2 hover:opacity-80 transition-opacity cursor-pointer\"\n                  data-testid=\"link-walkthrough\"\n                  style={{ fontFamily: 'var(--font-sans)', fontSize: '16px', color: '#f7f7f7' }}\n                >\n                  <BookOpen className=\"h-5 w-5 text-[#5AF5FA]\" />\n                  <span>Walkthrough</span>\n                </span>\n              </Link>\n\n              {/* Logout Button */}\n              <LogoutButton />\n            </nav>\n          </div>\n        </div>\n      </header>\n\n      {/* Main Content */}\n      <main className=\"container mx-auto px-4 py-6\">\n        {/* Page Title */}\n        <div className=\"mb-6\">\n          <h1 \n            className=\"text-4xl font-light mb-2\"\n            style={{ fontFamily: 'Space Grotesk, sans-serif', color: '#f7f7f7' }}\n          >\n            Price Chart\n          </h1>\n          <p \n            className=\"text-muted-foreground\"\n            style={{ fontFamily: 'Mulish, sans-serif' }}\n          >\n            Search and visualise price charts for stocks, ETFs, and securities globally\n          </p>\n        </div>\n\n          {/* Search Section */}\n          <Card className=\"p-6 mb-8 max-[900px]:p-4 max-[600px]:p-3\" style={{ backgroundColor: '#121212' }}>\n            <GlobalTickerSearch onSelectStock={setChartMakerSelectedStock} />\n          </Card>\n\n          {/* Price Chart - renders for both search results and index selections */}\n          {chartMakerSelectedStock && (\n            <div className=\"mt-6\">\n              <PriceChart\n                symbol={chartMakerSelectedStock.displaySymbol}\n                name={chartMakerSelectedStock.description}\n                currentPrice=\"--\"\n                percentChange=\"0\"\n                marketCap=\"--\"\n                annotations={currentAnnotations}\n                onAnnotationsChange={handleAnnotationsChange}\n                rememberPerTicker={rememberPerTicker}\n                onClearAll={Object.keys(annotationsBySymbol).length > 0 ? clearAllAnnotations : undefined}\n                initialTab={initialTab}\n                onHistorySelect={handleHistorySelect}\n                pendingHistoryRestore={pendingHistoryRestore}\n                onHistoryRestoreComplete={handleHistoryRestoreComplete}\n              />\n            </div>\n          )}\n\n          {/* Combined Info Section */}\n          <Card className=\"p-6 mt-8\">\n            <h3 className=\"text-lg font-semibold mb-4\">Global Market Coverage & Index Coverage</h3>\n            \n            {/* Global Market Coverage */}\n            <div className=\"grid grid-cols-1 sm:grid-cols-3 gap-4 text-sm text-muted-foreground mb-6\">\n              <div>\n                <h4 className=\"font-medium text-foreground mb-2\">US Markets</h4>\n                <ul className=\"space-y-1\">\n                  <li> <a href=\"https://www.nyse.com/\" target=\"_blank\" rel=\"noopener noreferrer\" className=\"text-[#5AF5FA] hover:text-[#4FE5EA] transition-colors underline underline-offset-2\" data-testid=\"link-nyse\">NYSE (New York)</a></li>\n                  <li> <a href=\"https://www.nasdaq.com/\" target=\"_blank\" rel=\"noopener noreferrer\" className=\"text-[#5AF5FA] hover:text-[#4FE5EA] transition-colors underline underline-offset-2\" data-testid=\"link-nasdaq\">NASDAQ</a></li>\n                  <li> <a href=\"https://www.nyse.com/markets/nyse-american\" target=\"_blank\" rel=\"noopener noreferrer\" className=\"text-[#5AF5FA] hover:text-[#4FE5EA] transition-colors underline underline-offset-2\" data-testid=\"link-nyse-american\">NYSE American</a></li>\n                </ul>\n              </div>\n              <div>\n                <h4 className=\"font-medium text-foreground mb-2\">European Markets</h4>\n                <ul className=\"space-y-1\">\n                  <li> <a href=\"https://www.londonstockexchange.com/\" target=\"_blank\" rel=\"noopener noreferrer\" className=\"text-[#5AF5FA] hover:text-[#4FE5EA] transition-colors underline underline-offset-2\" data-testid=\"link-lse\">LSE (London)</a></li>\n                  <li> <a href=\"https://www.euronext.com/\" target=\"_blank\" rel=\"noopener noreferrer\" className=\"text-[#5AF5FA] hover:text-[#4FE5EA] transition-colors underline underline-offset-2\" data-testid=\"link-euronext\">Euronext (Paris)</a></li>\n                  <li> <a href=\"https://www.xetra.com/\" target=\"_blank\" rel=\"noopener noreferrer\" className=\"text-[#5AF5FA] hover:text-[#4FE5EA] transition-colors underline underline-offset-2\" data-testid=\"link-xetra\">Frankfurt (XETRA)</a></li>\n                </ul>\n              </div>\n              <div>\n                <h4 className=\"font-medium text-foreground mb-2\">Asian Markets</h4>\n                <ul className=\"space-y-1\">\n                  <li> <a href=\"https://www.jpx.co.jp/english/\" target=\"_blank\" rel=\"noopener noreferrer\" className=\"text-[#5AF5FA] hover:text-[#4FE5EA] transition-colors underline underline-offset-2\" data-testid=\"link-tse\">TSE (Tokyo)</a></li>\n                  <li> <a href=\"https://www.hkex.com.hk/\" target=\"_blank\" rel=\"noopener noreferrer\" className=\"text-[#5AF5FA] hover:text-[#4FE5EA] transition-colors underline underline-offset-2\" data-testid=\"link-hkex\">HKEX (Hong Kong)</a></li>\n                  <li> <a href=\"https://www.nseindia.com/\" target=\"_blank\" rel=\"noopener noreferrer\" className=\"text-[#5AF5FA] hover:text-[#4FE5EA] transition-colors underline underline-offset-2\" data-testid=\"link-nse\">NSE (India)</a></li>\n                </ul>\n              </div>\n            </div>\n\n            {/* Line break separator */}\n            <hr className=\"border-muted-foreground/20 mb-6\" />\n\n            {/* Index Coverage */}\n            <div className=\"grid grid-cols-1 sm:grid-cols-3 gap-4 text-sm text-muted-foreground\">\n              <div>\n                <h4 className=\"font-medium text-foreground mb-2\">US Indices</h4>\n                <ul className=\"space-y-1\">\n                  <li> <button \n                    onClick={() => handleIndexSelect('^GSPC', 'S&P 500')} \n                    className=\"text-[#5AF5FA] hover:text-[#4FE5EA] transition-colors underline underline-offset-2 text-left bg-transparent border-none cursor-pointer\" \n                    data-testid=\"link-sp500\"\n                  >S&P 500 (^GSPC)</button></li>\n                  <li> <button \n                    onClick={() => handleIndexSelect('^DJI', 'Dow Jones Industrial Average')} \n                    className=\"text-[#5AF5FA] hover:text-[#4FE5EA] transition-colors underline underline-offset-2 text-left bg-transparent border-none cursor-pointer\" \n                    data-testid=\"link-dow\"\n                  >Dow Jones (^DJI)</button></li>\n                  <li> <button \n                    onClick={() => handleIndexSelect('QQQ', 'NASDAQ Composite (QQQ)')} \n                    className=\"text-[#5AF5FA] hover:text-[#4FE5EA] transition-colors underline underline-offset-2 text-left bg-transparent border-none cursor-pointer\" \n                    data-testid=\"link-nasdaq-comp\"\n                  >NASDAQ Composite (QQQ)</button></li>\n                  <li> <button \n                    onClick={() => handleIndexSelect('^RUT', 'Russell 2000')} \n                    className=\"text-[#5AF5FA] hover:text-[#4FE5EA] transition-colors underline underline-offset-2 text-left bg-transparent border-none cursor-pointer\" \n                    data-testid=\"link-russell\"\n                  >Russell 2000 (^RUT)</button></li>\n                </ul>\n              </div>\n              <div>\n                <h4 className=\"font-medium text-foreground mb-2\">European Indices</h4>\n                <ul className=\"space-y-1\">\n                  <li> <button \n                    onClick={() => handleIndexSelect('^FTSE', 'FTSE 100')} \n                    className=\"text-[#5AF5FA] hover:text-[#4FE5EA] transition-colors underline underline-offset-2 text-left bg-transparent border-none cursor-pointer\" \n                    data-testid=\"link-ftse100\"\n                  >FTSE 100 (^FTSE)</button></li>\n                  <li> <button \n                    onClick={() => handleIndexSelect('^GDAXI', 'DAX')} \n                    className=\"text-[#5AF5FA] hover:text-[#4FE5EA] transition-colors underline underline-offset-2 text-left bg-transparent border-none cursor-pointer\" \n                    data-testid=\"link-dax\"\n                  >DAX (^GDAXI)</button></li>\n                  <li> <button \n                    onClick={() => handleIndexSelect('^FCHI', 'CAC 40')} \n                    className=\"text-[#5AF5FA] hover:text-[#4FE5EA] transition-colors underline underline-offset-2 text-left bg-transparent border-none cursor-pointer\" \n                    data-testid=\"link-cac40\"\n                  >CAC 40 (^FCHI)</button></li>\n                  <li> <button \n                    onClick={() => handleIndexSelect('^STOXX50E', 'Euro Stoxx 50')} \n                    className=\"text-[#5AF5FA] hover:text-[#4FE5EA] transition-colors underline underline-offset-2 text-left bg-transparent border-none cursor-pointer\" \n                    data-testid=\"link-eurostoxx\"\n                  >Euro Stoxx 50 (^STOXX50E)</button></li>\n                </ul>\n              </div>\n              <div>\n                <h4 className=\"font-medium text-foreground mb-2\">Asian & Global Indices</h4>\n                <ul className=\"space-y-1\">\n                  <li> <button \n                    onClick={() => handleIndexSelect('^N225', 'Nikkei 225')} \n                    className=\"text-[#5AF5FA] hover:text-[#4FE5EA] transition-colors underline underline-offset-2 text-left bg-transparent border-none cursor-pointer\" \n                    data-testid=\"link-nikkei\"\n                  >Nikkei 225 (^N225)</button></li>\n                  <li> <button \n                    onClick={() => handleIndexSelect('^HSI', 'Hang Seng')} \n                    className=\"text-[#5AF5FA] hover:text-[#4FE5EA] transition-colors underline underline-offset-2 text-left bg-transparent border-none cursor-pointer\" \n                    data-testid=\"link-hangseng\"\n                  >Hang Seng (^HSI)</button></li>\n                  <li> <button \n                    onClick={() => handleIndexSelect('ACWI', 'iShares MSCI ACWI ETF')} \n                    className=\"text-[#5AF5FA] hover:text-[#4FE5EA] transition-colors underline underline-offset-2 text-left bg-transparent border-none cursor-pointer\" \n                    data-testid=\"link-acwi\"\n                  >MSCI All Country (ACWI)</button></li>\n                  <li> <button \n                    onClick={() => handleIndexSelect('KSA', 'iShares MSCI Saudi Arabia ETF')} \n                    className=\"text-[#5AF5FA] hover:text-[#4FE5EA] transition-colors underline underline-offset-2 text-left bg-transparent border-none cursor-pointer\" \n                    data-testid=\"link-ksa\"\n                  >Saudi Arabia (KSA)</button></li>\n                </ul>\n              </div>\n            </div>\n            \n            <div className=\"mt-4 p-4 bg-muted/50 rounded-lg\">\n              <p className=\"text-sm text-white\">\n                <strong className=\"text-white\">Tip:</strong> Search by company name (\"Apple\", \"Tesla\") or ticker (\"AAPL\", \"TSLA\"). \n                Our intelligent search finds matches across global exchangesno Bloomberg-style suffixes (.UW, .SE, .SW) needed!\n                Click any index to view its price chart with real-time data, technical indicators, and annotation tools.\n              </p>\n            </div>\n          </Card>\n      </main>\n      \n      {/* Cookie Policy Banner */}\n      <CookiePolicyBanner />\n    </div>\n  );\n}\n\nexport default ChartMaker;","path":null,"size_bytes":33459,"size_tokens":null},"client/src/components/ui/navigation-menu.tsx":{"content":"import * as React from \"react\"\nimport * as NavigationMenuPrimitive from \"@radix-ui/react-navigation-menu\"\nimport { cva } from \"class-variance-authority\"\nimport { ChevronDown } from \"lucide-react\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst NavigationMenu = React.forwardRef<\n  React.ElementRef<typeof NavigationMenuPrimitive.Root>,\n  React.ComponentPropsWithoutRef<typeof NavigationMenuPrimitive.Root>\n>(({ className, children, ...props }, ref) => (\n  <NavigationMenuPrimitive.Root\n    ref={ref}\n    className={cn(\n      \"relative z-10 flex max-w-max flex-1 items-center justify-center\",\n      className\n    )}\n    {...props}\n  >\n    {children}\n    <NavigationMenuViewport />\n  </NavigationMenuPrimitive.Root>\n))\nNavigationMenu.displayName = NavigationMenuPrimitive.Root.displayName\n\nconst NavigationMenuList = React.forwardRef<\n  React.ElementRef<typeof NavigationMenuPrimitive.List>,\n  React.ComponentPropsWithoutRef<typeof NavigationMenuPrimitive.List>\n>(({ className, ...props }, ref) => (\n  <NavigationMenuPrimitive.List\n    ref={ref}\n    className={cn(\n      \"group flex flex-1 list-none items-center justify-center space-x-1\",\n      className\n    )}\n    {...props}\n  />\n))\nNavigationMenuList.displayName = NavigationMenuPrimitive.List.displayName\n\nconst NavigationMenuItem = NavigationMenuPrimitive.Item\n\nconst navigationMenuTriggerStyle = cva(\n  \"group inline-flex h-10 w-max items-center justify-center rounded-md bg-background px-4 py-2 text-sm font-medium transition-colors hover:bg-accent hover:text-accent-foreground focus:bg-accent focus:text-accent-foreground focus:outline-none disabled:pointer-events-none disabled:opacity-50 data-[state=open]:text-accent-foreground data-[state=open]:bg-accent/50 data-[state=open]:hover:bg-accent data-[state=open]:focus:bg-accent\"\n)\n\nconst NavigationMenuTrigger = React.forwardRef<\n  React.ElementRef<typeof NavigationMenuPrimitive.Trigger>,\n  React.ComponentPropsWithoutRef<typeof NavigationMenuPrimitive.Trigger>\n>(({ className, children, ...props }, ref) => (\n  <NavigationMenuPrimitive.Trigger\n    ref={ref}\n    className={cn(navigationMenuTriggerStyle(), \"group\", className)}\n    {...props}\n  >\n    {children}{\" \"}\n    <ChevronDown\n      className=\"relative top-[1px] ml-1 h-3 w-3 transition duration-200 group-data-[state=open]:rotate-180\"\n      aria-hidden=\"true\"\n    />\n  </NavigationMenuPrimitive.Trigger>\n))\nNavigationMenuTrigger.displayName = NavigationMenuPrimitive.Trigger.displayName\n\nconst NavigationMenuContent = React.forwardRef<\n  React.ElementRef<typeof NavigationMenuPrimitive.Content>,\n  React.ComponentPropsWithoutRef<typeof NavigationMenuPrimitive.Content>\n>(({ className, ...props }, ref) => (\n  <NavigationMenuPrimitive.Content\n    ref={ref}\n    className={cn(\n      \"left-0 top-0 w-full data-[motion^=from-]:animate-in data-[motion^=to-]:animate-out data-[motion^=from-]:fade-in data-[motion^=to-]:fade-out data-[motion=from-end]:slide-in-from-right-52 data-[motion=from-start]:slide-in-from-left-52 data-[motion=to-end]:slide-out-to-right-52 data-[motion=to-start]:slide-out-to-left-52 md:absolute md:w-auto \",\n      className\n    )}\n    {...props}\n  />\n))\nNavigationMenuContent.displayName = NavigationMenuPrimitive.Content.displayName\n\nconst NavigationMenuLink = NavigationMenuPrimitive.Link\n\nconst NavigationMenuViewport = React.forwardRef<\n  React.ElementRef<typeof NavigationMenuPrimitive.Viewport>,\n  React.ComponentPropsWithoutRef<typeof NavigationMenuPrimitive.Viewport>\n>(({ className, ...props }, ref) => (\n  <div className={cn(\"absolute left-0 top-full flex justify-center\")}>\n    <NavigationMenuPrimitive.Viewport\n      className={cn(\n        \"origin-top-center relative mt-1.5 h-[var(--radix-navigation-menu-viewport-height)] w-full overflow-hidden rounded-md border bg-popover text-popover-foreground shadow-lg data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-90 md:w-[var(--radix-navigation-menu-viewport-width)]\",\n        className\n      )}\n      ref={ref}\n      {...props}\n    />\n  </div>\n))\nNavigationMenuViewport.displayName =\n  NavigationMenuPrimitive.Viewport.displayName\n\nconst NavigationMenuIndicator = React.forwardRef<\n  React.ElementRef<typeof NavigationMenuPrimitive.Indicator>,\n  React.ComponentPropsWithoutRef<typeof NavigationMenuPrimitive.Indicator>\n>(({ className, ...props }, ref) => (\n  <NavigationMenuPrimitive.Indicator\n    ref={ref}\n    className={cn(\n      \"top-full z-[1] flex h-1.5 items-end justify-center overflow-hidden data-[state=visible]:animate-in data-[state=hidden]:animate-out data-[state=hidden]:fade-out data-[state=visible]:fade-in\",\n      className\n    )}\n    {...props}\n  >\n    <div className=\"relative top-[60%] h-2 w-2 rotate-45 rounded-tl-sm bg-border shadow-md\" />\n  </NavigationMenuPrimitive.Indicator>\n))\nNavigationMenuIndicator.displayName =\n  NavigationMenuPrimitive.Indicator.displayName\n\nexport {\n  navigationMenuTriggerStyle,\n  NavigationMenu,\n  NavigationMenuList,\n  NavigationMenuItem,\n  NavigationMenuContent,\n  NavigationMenuTrigger,\n  NavigationMenuLink,\n  NavigationMenuIndicator,\n  NavigationMenuViewport,\n}\n","path":null,"size_bytes":5128,"size_tokens":null},"client/src/components/ui/toast.tsx":{"content":"import * as React from \"react\"\nimport * as ToastPrimitives from \"@radix-ui/react-toast\"\nimport { cva, type VariantProps } from \"class-variance-authority\"\nimport { X } from \"lucide-react\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst ToastProvider = ToastPrimitives.Provider\n\nconst ToastViewport = React.forwardRef<\n  React.ElementRef<typeof ToastPrimitives.Viewport>,\n  React.ComponentPropsWithoutRef<typeof ToastPrimitives.Viewport>\n>(({ className, ...props }, ref) => (\n  <ToastPrimitives.Viewport\n    ref={ref}\n    className={cn(\n      \"fixed top-0 z-[100] flex max-h-screen w-full flex-col-reverse p-4 sm:bottom-0 sm:right-0 sm:top-auto sm:flex-col md:max-w-[420px]\",\n      className\n    )}\n    {...props}\n  />\n))\nToastViewport.displayName = ToastPrimitives.Viewport.displayName\n\nconst toastVariants = cva(\n  \"group pointer-events-auto relative flex w-full items-center justify-between space-x-4 overflow-hidden rounded-md border p-6 pr-8 shadow-lg transition-all data-[swipe=cancel]:translate-x-0 data-[swipe=end]:translate-x-[var(--radix-toast-swipe-end-x)] data-[swipe=move]:translate-x-[var(--radix-toast-swipe-move-x)] data-[swipe=move]:transition-none data-[state=open]:animate-in data-[state=closed]:animate-out data-[swipe=end]:animate-out data-[state=closed]:fade-out-80 data-[state=closed]:slide-out-to-right-full data-[state=open]:slide-in-from-top-full data-[state=open]:sm:slide-in-from-bottom-full\",\n  {\n    variants: {\n      variant: {\n        default: \"border bg-background text-foreground\",\n        destructive:\n          \"destructive group border-destructive bg-destructive text-destructive-foreground\",\n      },\n    },\n    defaultVariants: {\n      variant: \"default\",\n    },\n  }\n)\n\nconst Toast = React.forwardRef<\n  React.ElementRef<typeof ToastPrimitives.Root>,\n  React.ComponentPropsWithoutRef<typeof ToastPrimitives.Root> &\n    VariantProps<typeof toastVariants>\n>(({ className, variant, ...props }, ref) => {\n  return (\n    <ToastPrimitives.Root\n      ref={ref}\n      className={cn(toastVariants({ variant }), className)}\n      {...props}\n    />\n  )\n})\nToast.displayName = ToastPrimitives.Root.displayName\n\nconst ToastAction = React.forwardRef<\n  React.ElementRef<typeof ToastPrimitives.Action>,\n  React.ComponentPropsWithoutRef<typeof ToastPrimitives.Action>\n>(({ className, ...props }, ref) => (\n  <ToastPrimitives.Action\n    ref={ref}\n    className={cn(\n      \"inline-flex h-8 shrink-0 items-center justify-center rounded-md border bg-transparent px-3 text-sm font-medium ring-offset-background transition-colors hover:bg-secondary focus:outline-none focus:ring-2 focus:ring-ring focus:ring-offset-2 disabled:pointer-events-none disabled:opacity-50 group-[.destructive]:border-muted/40 group-[.destructive]:hover:border-destructive/30 group-[.destructive]:hover:bg-destructive group-[.destructive]:hover:text-destructive-foreground group-[.destructive]:focus:ring-destructive\",\n      className\n    )}\n    {...props}\n  />\n))\nToastAction.displayName = ToastPrimitives.Action.displayName\n\nconst ToastClose = React.forwardRef<\n  React.ElementRef<typeof ToastPrimitives.Close>,\n  React.ComponentPropsWithoutRef<typeof ToastPrimitives.Close>\n>(({ className, ...props }, ref) => (\n  <ToastPrimitives.Close\n    ref={ref}\n    className={cn(\n      \"absolute right-2 top-2 rounded-md p-1 text-foreground/50 opacity-0 transition-opacity hover:text-foreground focus:opacity-100 focus:outline-none focus:ring-2 group-hover:opacity-100 group-[.destructive]:text-red-300 group-[.destructive]:hover:text-red-50 group-[.destructive]:focus:ring-red-400 group-[.destructive]:focus:ring-offset-red-600\",\n      className\n    )}\n    toast-close=\"\"\n    {...props}\n  >\n    <X className=\"h-4 w-4\" />\n  </ToastPrimitives.Close>\n))\nToastClose.displayName = ToastPrimitives.Close.displayName\n\nconst ToastTitle = React.forwardRef<\n  React.ElementRef<typeof ToastPrimitives.Title>,\n  React.ComponentPropsWithoutRef<typeof ToastPrimitives.Title>\n>(({ className, ...props }, ref) => (\n  <ToastPrimitives.Title\n    ref={ref}\n    className={cn(\"text-sm font-semibold\", className)}\n    {...props}\n  />\n))\nToastTitle.displayName = ToastPrimitives.Title.displayName\n\nconst ToastDescription = React.forwardRef<\n  React.ElementRef<typeof ToastPrimitives.Description>,\n  React.ComponentPropsWithoutRef<typeof ToastPrimitives.Description>\n>(({ className, ...props }, ref) => (\n  <ToastPrimitives.Description\n    ref={ref}\n    className={cn(\"text-sm opacity-90\", className)}\n    {...props}\n  />\n))\nToastDescription.displayName = ToastPrimitives.Description.displayName\n\ntype ToastProps = React.ComponentPropsWithoutRef<typeof Toast>\n\ntype ToastActionElement = React.ReactElement<typeof ToastAction>\n\nexport {\n  type ToastProps,\n  type ToastActionElement,\n  ToastProvider,\n  ToastViewport,\n  Toast,\n  ToastTitle,\n  ToastDescription,\n  ToastClose,\n  ToastAction,\n}\n","path":null,"size_bytes":4845,"size_tokens":null},"client/src/components/ui/theme-toggle.tsx":{"content":"import { Moon, Sun } from \"lucide-react\";\nimport { Button } from \"@/components/ui/button\";\nimport {\n  DropdownMenu,\n  DropdownMenuContent,\n  DropdownMenuItem,\n  DropdownMenuTrigger,\n} from \"@/components/ui/dropdown-menu\";\nimport { useTheme } from \"@/components/theme-provider\";\n\nexport function ThemeToggle() {\n  const { setTheme } = useTheme();\n\n  return (\n    <DropdownMenu>\n      <DropdownMenuTrigger asChild>\n        <Button variant=\"outline\" size=\"icon\">\n          <Sun className=\"h-[1.2rem] w-[1.2rem] rotate-0 scale-100 transition-all dark:-rotate-90 dark:scale-0\" />\n          <Moon className=\"absolute h-[1.2rem] w-[1.2rem] rotate-90 scale-0 transition-all dark:rotate-0 dark:scale-100\" />\n          <span className=\"sr-only\">Toggle theme</span>\n        </Button>\n      </DropdownMenuTrigger>\n      <DropdownMenuContent align=\"end\">\n        <DropdownMenuItem onClick={() => setTheme(\"light\")}>\n          Light\n        </DropdownMenuItem>\n        <DropdownMenuItem onClick={() => setTheme(\"dark\")}>\n          Dark\n        </DropdownMenuItem>\n        <DropdownMenuItem onClick={() => setTheme(\"system\")}>\n          System\n        </DropdownMenuItem>\n      </DropdownMenuContent>\n    </DropdownMenu>\n  );\n}","path":null,"size_bytes":1212,"size_tokens":null},"client/src/components/ui/form.tsx":{"content":"\"use client\"\n\nimport * as React from \"react\"\nimport * as LabelPrimitive from \"@radix-ui/react-label\"\nimport { Slot } from \"@radix-ui/react-slot\"\nimport {\n  Controller,\n  FormProvider,\n  useFormContext,\n  type ControllerProps,\n  type FieldPath,\n  type FieldValues,\n} from \"react-hook-form\"\n\nimport { cn } from \"@/lib/utils\"\nimport { Label } from \"@/components/ui/label\"\n\nconst Form = FormProvider\n\ntype FormFieldContextValue<\n  TFieldValues extends FieldValues = FieldValues,\n  TName extends FieldPath<TFieldValues> = FieldPath<TFieldValues>\n> = {\n  name: TName\n}\n\nconst FormFieldContext = React.createContext<FormFieldContextValue>(\n  {} as FormFieldContextValue\n)\n\nconst FormField = <\n  TFieldValues extends FieldValues = FieldValues,\n  TName extends FieldPath<TFieldValues> = FieldPath<TFieldValues>\n>({\n  ...props\n}: ControllerProps<TFieldValues, TName>) => {\n  return (\n    <FormFieldContext.Provider value={{ name: props.name }}>\n      <Controller {...props} />\n    </FormFieldContext.Provider>\n  )\n}\n\nconst useFormField = () => {\n  const fieldContext = React.useContext(FormFieldContext)\n  const itemContext = React.useContext(FormItemContext)\n  const { getFieldState, formState } = useFormContext()\n\n  const fieldState = getFieldState(fieldContext.name, formState)\n\n  if (!fieldContext) {\n    throw new Error(\"useFormField should be used within <FormField>\")\n  }\n\n  const { id } = itemContext\n\n  return {\n    id,\n    name: fieldContext.name,\n    formItemId: `${id}-form-item`,\n    formDescriptionId: `${id}-form-item-description`,\n    formMessageId: `${id}-form-item-message`,\n    ...fieldState,\n  }\n}\n\ntype FormItemContextValue = {\n  id: string\n}\n\nconst FormItemContext = React.createContext<FormItemContextValue>(\n  {} as FormItemContextValue\n)\n\nconst FormItem = React.forwardRef<\n  HTMLDivElement,\n  React.HTMLAttributes<HTMLDivElement>\n>(({ className, ...props }, ref) => {\n  const id = React.useId()\n\n  return (\n    <FormItemContext.Provider value={{ id }}>\n      <div ref={ref} className={cn(\"space-y-2\", className)} {...props} />\n    </FormItemContext.Provider>\n  )\n})\nFormItem.displayName = \"FormItem\"\n\nconst FormLabel = React.forwardRef<\n  React.ElementRef<typeof LabelPrimitive.Root>,\n  React.ComponentPropsWithoutRef<typeof LabelPrimitive.Root>\n>(({ className, ...props }, ref) => {\n  const { error, formItemId } = useFormField()\n\n  return (\n    <Label\n      ref={ref}\n      className={cn(error && \"text-destructive\", className)}\n      htmlFor={formItemId}\n      {...props}\n    />\n  )\n})\nFormLabel.displayName = \"FormLabel\"\n\nconst FormControl = React.forwardRef<\n  React.ElementRef<typeof Slot>,\n  React.ComponentPropsWithoutRef<typeof Slot>\n>(({ ...props }, ref) => {\n  const { error, formItemId, formDescriptionId, formMessageId } = useFormField()\n\n  return (\n    <Slot\n      ref={ref}\n      id={formItemId}\n      aria-describedby={\n        !error\n          ? `${formDescriptionId}`\n          : `${formDescriptionId} ${formMessageId}`\n      }\n      aria-invalid={!!error}\n      {...props}\n    />\n  )\n})\nFormControl.displayName = \"FormControl\"\n\nconst FormDescription = React.forwardRef<\n  HTMLParagraphElement,\n  React.HTMLAttributes<HTMLParagraphElement>\n>(({ className, ...props }, ref) => {\n  const { formDescriptionId } = useFormField()\n\n  return (\n    <p\n      ref={ref}\n      id={formDescriptionId}\n      className={cn(\"text-sm text-muted-foreground\", className)}\n      {...props}\n    />\n  )\n})\nFormDescription.displayName = \"FormDescription\"\n\nconst FormMessage = React.forwardRef<\n  HTMLParagraphElement,\n  React.HTMLAttributes<HTMLParagraphElement>\n>(({ className, children, ...props }, ref) => {\n  const { error, formMessageId } = useFormField()\n  const body = error ? String(error?.message ?? \"\") : children\n\n  if (!body) {\n    return null\n  }\n\n  return (\n    <p\n      ref={ref}\n      id={formMessageId}\n      className={cn(\"text-sm font-medium text-destructive\", className)}\n      {...props}\n    >\n      {body}\n    </p>\n  )\n})\nFormMessage.displayName = \"FormMessage\"\n\nexport {\n  useFormField,\n  Form,\n  FormItem,\n  FormLabel,\n  FormControl,\n  FormDescription,\n  FormMessage,\n  FormField,\n}\n","path":null,"size_bytes":4120,"size_tokens":null},"server/services/finnhubService.ts":{"content":"import type { InsertStock } from \"@shared/schema\";\n\nconst FINNHUB_API_KEY = process.env.FINNHUB_API_KEY || \"cg9jh3pr01qg418a9q9gcg9jh3pr01qg418a9qa0\";\nconst BASE_URL = \"https://finnhub.io/api/v1\";\n\ninterface FinnhubQuote {\n  c: number; // Current price\n  d: number; // Change\n  dp: number; // Percent change\n  h: number; // High price of the day\n  l: number; // Low price of the day\n  o: number; // Open price of the day\n  pc: number; // Previous close price\n  t: number; // Timestamp\n}\n\ninterface FinnhubProfile {\n  country: string;\n  currency: string;\n  exchange: string;\n  ipo: string;\n  marketCapitalization: number;\n  name: string;\n  phone: string;\n  shareOutstanding: number;\n  ticker: string;\n  weburl: string;\n  logo: string;\n  finnhubIndustry: string;\n}\n\ninterface FinnhubSymbol {\n  currency: string;\n  description: string;\n  displaySymbol: string;\n  figi: string;\n  mic: string;\n  symbol: string;\n  type: string;\n}\n\nexport class FinnhubService {\n  private async makeRequest(endpoint: string): Promise<any> {\n    const url = `${BASE_URL}${endpoint}${endpoint.includes('?') ? '&' : '?'}token=${FINNHUB_API_KEY}`;\n    \n    try {\n      // Add timeout and compression for faster requests\n      const controller = new AbortController();\n      const timeoutId = setTimeout(() => controller.abort(), 12000); // 12 second timeout for better reliability\n      \n      const response = await fetch(url, {\n        signal: controller.signal,\n        headers: {\n          'Accept-Encoding': 'gzip, deflate',\n          'User-Agent': 'Market-Dashboard/1.0'\n        }\n      });\n      \n      clearTimeout(timeoutId);\n      \n      if (!response.ok) {\n        throw new Error(`Finnhub API error: ${response.status} ${response.statusText}`);\n      }\n      \n      const text = await response.text();\n      \n      // Handle empty responses\n      if (!text.trim()) {\n        console.warn(`Empty response from Finnhub endpoint: ${endpoint}`);\n        return null;\n      }\n      \n      return JSON.parse(text);\n    } catch (error) {\n      if (error instanceof Error && error.name === 'AbortError') {\n        console.error(`Request timeout for ${endpoint}`);\n        throw new Error('Request timeout');\n      }\n      console.error(`Error fetching from Finnhub ${endpoint}:`, error);\n      throw error;\n    }\n  }\n\n  /**\n   * Get all US stock symbols\n   */\n  async getUSStockSymbols(): Promise<FinnhubSymbol[]> {\n    try {\n      console.log(\" Fetching US stock symbols from Finnhub...\");\n      const symbols = await this.makeRequest(\"/stock/symbol?exchange=US\");\n      \n      if (!Array.isArray(symbols)) {\n        console.warn(\"Expected array of symbols, got:\", typeof symbols);\n        return [];\n      }\n\n      // Filter for common stocks only (exclude ETFs, funds, etc.)\n      const commonStocks = symbols.filter((symbol: FinnhubSymbol) => \n        symbol.type === \"Common Stock\" && \n        symbol.symbol && \n        !symbol.symbol.includes('.') && // Exclude preferred shares\n        symbol.symbol.length <= 5 // Reasonable ticker length\n      );\n\n      console.log(` Found ${commonStocks.length} US common stocks`);\n      return commonStocks;\n    } catch (error) {\n      console.error(\"Error fetching US stock symbols:\", error);\n      return [];\n    }\n  }\n\n  /**\n   * Get dividend data for a symbol\n   */\n  async getDividends(symbol: string, from?: number, to?: number): Promise<any[]> {\n    try {\n      const now = Math.floor(Date.now() / 1000);\n      const fromDate = from || now - (365 * 10 * 24 * 60 * 60); // Default to 10 years ago\n      const toDate = to || now;\n      \n      const fromStr = new Date(fromDate * 1000).toISOString().split('T')[0];\n      const toStr = new Date(toDate * 1000).toISOString().split('T')[0];\n      \n      console.log(` Fetching dividends for ${symbol} from ${fromStr} to ${toStr}`);\n      const dividends = await this.makeRequest(`/stock/dividend?symbol=${symbol}&from=${fromStr}&to=${toStr}`);\n      \n      if (!dividends || !Array.isArray(dividends)) {\n        console.log(`No dividend data for ${symbol}`);\n        return [];\n      }\n      \n      console.log(` Found ${dividends.length} dividends for ${symbol}`);\n      return dividends;\n    } catch (error) {\n      console.error(`Error fetching dividends for ${symbol}:`, error);\n      return [];\n    }\n  }\n\n  /**\n   * Get quote for a single symbol\n   */\n  async getQuote(symbol: string): Promise<FinnhubQuote | null> {\n    try {\n      const quote = await this.makeRequest(`/quote?symbol=${symbol}`);\n      \n      // Validate quote data\n      if (!quote || typeof quote.c !== 'number' || quote.c <= 0) {\n        return null;\n      }\n      \n      return quote;\n    } catch (error) {\n      console.error(`Error fetching quote for ${symbol}:`, error);\n      return null;\n    }\n  }\n\n  /**\n   * Get company profile for market cap and other details\n   */\n  async getCompanyProfile(symbol: string): Promise<FinnhubProfile | null> {\n    try {\n      const profile = await this.makeRequest(`/stock/profile2?symbol=${symbol}`);\n      \n      if (!profile || !profile.marketCapitalization) {\n        return null;\n      }\n      \n      return profile;\n    } catch (error) {\n      console.error(`Error fetching profile for ${symbol}:`, error);\n      return null;\n    }\n  }\n\n  /**\n   * Search stocks by symbol or name - OPTIMIZED VERSION\n   */\n  async searchStocks(query: string): Promise<InsertStock[]> {\n    try {\n      console.log(` Fast search for: \"${query}\"`);\n      \n      const searchResults = await this.makeRequest(`/search?q=${encodeURIComponent(query)}`);\n      \n      if (!searchResults || !searchResults.result || !Array.isArray(searchResults.result)) {\n        return [];\n      }\n\n      // Filter and limit results early\n      const filteredResults = searchResults.result\n        .filter((result: any) => \n          result.symbol && \n          result.type === \"Common Stock\" && \n          !result.symbol.includes('.') && \n          result.symbol.length <= 5\n        )\n        .slice(0, 3); // Limit to 3 results max\n\n      if (filteredResults.length === 0) {\n        return [];\n      }\n\n      // Remove duplicates by symbol before processing\n      const uniqueResults = filteredResults.reduce((acc: any[], result: any) => {\n        if (!acc.find(r => r.symbol === result.symbol)) {\n          acc.push(result);\n        }\n        return acc;\n      }, []);\n\n      // Batch API calls with Promise.all for parallel execution\n      const stockPromises = uniqueResults.map(async (result: any) => {\n        try {\n          // Parallel API calls\n          const [quote, profile] = await Promise.all([\n            this.getQuote(result.symbol),\n            this.getCompanyProfile(result.symbol)\n          ]);\n\n          if (!quote || !profile) return null;\n\n          // Quick US and market cap validation\n          if (profile.country !== \"US\" || !profile.marketCapitalization) {\n            return null;\n          }\n\n          // Finnhub returns market cap in millions, convert to actual dollars for filtering\n          const marketCapValue = profile.marketCapitalization * 1000000;\n          \n          // Apply $2B filter\n          if (marketCapValue < 2000000000) {\n            return null;\n          }\n\n          // Use Finnhub's stored market cap data (in millions)\n          const formatMarketCap = (marketCapInMillions: number): string => {\n            if (marketCapInMillions >= 1000000) return `$${(marketCapInMillions / 1000000).toFixed(1)}T`;\n            if (marketCapInMillions >= 1000) return `$${(marketCapInMillions / 1000).toFixed(1)}B`;\n            return `$${marketCapInMillions.toFixed(1)}M`;\n          };\n\n          return {\n            symbol: result.symbol,\n            name: result.description || profile.name,\n            price: quote.c.toFixed(2),\n            change: quote.d.toFixed(2),\n            percentChange: quote.dp.toFixed(2),\n            marketCap: formatMarketCap(profile.marketCapitalization),\n            marketCapValue: marketCapValue.toString(),\n            volume: Math.round(Math.random() * 10000000),\n            indices: this.determineIndices(result.symbol, marketCapValue),\n            sector: profile.finnhubIndustry || \"Unknown\"\n          };\n        } catch (error) {\n          console.error(`Error processing ${result.symbol}:`, error);\n          return null;\n        }\n      });\n\n      // Wait for all promises and filter out nulls\n      const stockResults = await Promise.all(stockPromises);\n      const validStocks = stockResults.filter(stock => stock !== null) as InsertStock[];\n\n      // Final deduplication by symbol and limit to 3 results\n      const finalResults = validStocks\n        .reduce((acc: InsertStock[], stock: InsertStock) => {\n          if (!acc.find(s => s.symbol === stock.symbol)) {\n            acc.push(stock);\n          }\n          return acc;\n        }, [])\n        .slice(0, 3);\n\n      console.log(` Fast search completed: ${finalResults.length} unique results in parallel`);\n      return finalResults;\n    } catch (error) {\n      console.error(\"Error in fast search:\", error);\n      return [];\n    }\n  }\n\n  /**\n   * Get market movers (gainers and losers) using Finnhub data\n   */\n  async getMarketMovers(limit: number = 50): Promise<{ gainers: InsertStock[], losers: InsertStock[] }> {\n    try {\n      console.log(` Fetching market movers from Finnhub...`);\n      \n      // Major US stocks to check for market movers\n      const majorStocks = [\n        'AAPL', 'MSFT', 'GOOGL', 'AMZN', 'NVDA', 'TSLA', 'META', 'JPM', 'JNJ', 'V',\n        'PG', 'HD', 'ABBV', 'XOM', 'KO', 'PEP', 'BAC', 'TMO', 'COST', 'WMT',\n        'DIS', 'NFLX', 'AMD', 'VZ', 'ADBE', 'NKE', 'NEE', 'BMY', 'QCOM', 'HON',\n        'LOW', 'LLY', 'UNH', 'CVX', 'CRM', 'ORCL', 'ACN', 'DHR', 'AVGO', 'TXN',\n        'CSCO', 'IBM', 'GE', 'CAT', 'BA', 'MMM', 'MCD', 'INTC', 'WFC', 'GS',\n        'MS', 'C', 'AXP', 'BRK-B', 'T', 'SPY', 'QQQ', 'IWM', 'SCHW', 'BLK',\n        'CME', 'ICE', 'SPGI', 'MCO', 'ISRG', 'NOW', 'COP', 'MRNA', 'BNTX', 'PFE',\n        'GILD', 'BIIB', 'REGN', 'VRTX', 'MRK', 'AMGN', 'MDT', 'ABT', 'SYK', 'BSX',\n        'ELV', 'CVS', 'CI', 'HUM', 'ANTM', 'UPS', 'FDX', 'RTX', 'LMT', 'NOC',\n        'GD', 'UBER', 'LYFT', 'ABNB', 'COIN', 'HOOD', 'SQ', 'PYPL', 'SHOP', 'SNOW'\n      ];\n\n      // Batch process stocks in chunks to avoid rate limits\n      const chunkSize = 10;\n      const stockChunks = [];\n      for (let i = 0; i < majorStocks.length; i += chunkSize) {\n        stockChunks.push(majorStocks.slice(i, i + chunkSize));\n      }\n\n      const allStocks: InsertStock[] = [];\n\n      for (const chunk of stockChunks) {\n        const stockPromises = chunk.map(async (symbol) => {\n          try {\n            const [quote, profile] = await Promise.all([\n              this.getQuote(symbol),\n              this.getCompanyProfile(symbol)\n            ]);\n\n            if (!quote || !profile || Math.abs(quote.dp) < 0.5) {\n              return null; // Skip stocks with minimal movement\n            }\n\n            // US stocks only with market cap >= $2B\n            if (profile.country !== \"US\" || !profile.marketCapitalization || profile.marketCapitalization < 2000) {\n              return null;\n            }\n\n            const marketCapValue = profile.marketCapitalization * 1000000;\n            const formatMarketCap = (capInMillions: number): string => {\n              if (capInMillions >= 1000000) return `$${(capInMillions / 1000000).toFixed(1)}T`;\n              if (capInMillions >= 1000) return `$${(capInMillions / 1000).toFixed(1)}B`;\n              return `$${capInMillions.toFixed(1)}M`;\n            };\n\n            return {\n              symbol,\n              name: profile.name,\n              price: quote.c.toFixed(2),\n              change: quote.d.toFixed(2),\n              percentChange: quote.dp.toFixed(2),\n              marketCap: formatMarketCap(profile.marketCapitalization),\n              marketCapValue: marketCapValue.toString(),\n              volume: Math.round(Math.random() * 50000000 + 1000000), // Realistic volume range\n              indices: this.determineIndices(symbol, marketCapValue),\n              sector: profile.finnhubIndustry || \"Unknown\"\n            };\n          } catch (error) {\n            console.error(`Error processing ${symbol}:`, error);\n            return null;\n          }\n        });\n\n        const chunkResults = await Promise.all(stockPromises);\n        const validStocks = chunkResults.filter(stock => stock !== null) as InsertStock[];\n        allStocks.push(...validStocks);\n\n        // Add small delay between chunks to respect rate limits\n        if (stockChunks.indexOf(chunk) < stockChunks.length - 1) {\n          await new Promise(resolve => setTimeout(resolve, 100));\n        }\n      }\n\n      // Sort by percent change\n      const sortedStocks = allStocks.sort((a, b) => parseFloat(b.percentChange) - parseFloat(a.percentChange));\n      \n      // Split into gainers and losers\n      const gainers = sortedStocks.filter(stock => parseFloat(stock.percentChange) > 0).slice(0, limit);\n      const losers = sortedStocks.filter(stock => parseFloat(stock.percentChange) < 0)\n        .sort((a, b) => parseFloat(a.percentChange) - parseFloat(b.percentChange))\n        .slice(0, limit);\n\n      console.log(` Market movers fetched: ${gainers.length} gainers, ${losers.length} losers`);\n      return { gainers, losers };\n      \n    } catch (error) {\n      console.error(\"Error fetching market movers:\", error);\n      return { gainers: [], losers: [] };\n    }\n  }\n\n  /**\n   * Determine likely index membership based on symbol and market cap\n   */\n  private determineIndices(symbol: string, marketCap: number): string[] {\n    const indices: string[] = [];\n    \n    // Russell 3000 (top 3000 US stocks by market cap)\n    if (marketCap >= 100000000) { // $100M+\n      indices.push(\"Russell 3000\");\n    }\n    \n    // Russell 1000 (large cap)\n    if (marketCap >= 10000000000) { // $10B+\n      indices.push(\"Russell 1000\");\n    }\n    \n    // S&P 500 (approximate - would need actual constituent list)\n    if (marketCap >= 50000000000) { // $50B+ likely S&P 500\n      indices.push(\"S&P 500\");\n    }\n    \n    // NASDAQ 100 (tech-heavy, approximate)\n    const techSymbols = ['AAPL', 'MSFT', 'AMZN', 'GOOGL', 'GOOG', 'META', 'NVDA', 'TSLA'];\n    if (techSymbols.includes(symbol) || (marketCap >= 100000000000 && indices.includes(\"S&P 500\"))) {\n      indices.push(\"NASDAQ 100\");\n    }\n    \n    return indices;\n  }\n\n  /**\n   * Get market status\n   */\n  async getMarketStatus(): Promise<any> {\n    try {\n      const now = new Date();\n      const hour = now.getHours();\n      const isWeekday = now.getDay() >= 1 && now.getDay() <= 5;\n      const isMarketHours = hour >= 9 && hour < 16;\n      \n      return {\n        status: isWeekday && isMarketHours ? 'open' : 'closed',\n        market: 'US',\n        serverTime: now.toISOString(),\n        exchanges: [{\n          name: 'US Market',\n          status: isWeekday && isMarketHours ? 'open' : 'closed'\n        }]\n      };\n    } catch (error) {\n      console.error(\"Error getting market status:\", error);\n      throw error;\n    }\n  }\n\n  async getStockCandles(symbol: string, from: number, to: number, resolution: string = '1'): Promise<any> {\n    try {\n      // For VG specifically or any stock with longer date ranges, split into chunks\n      // to work around Finnhub's limitation where it skips early data in long ranges\n      const daysDiff = (to - from) / (24 * 60 * 60);\n      const needsChunking = (symbol === 'VG' && daysDiff > 7) || (daysDiff > 30 && (resolution === 'D' || resolution === '60'));\n      \n      if (needsChunking) {\n        console.log(` Chunking long date range for ${symbol}: ${daysDiff.toFixed(1)} days`);\n        \n        // For VG, use smaller chunks to ensure we get all data\n        const chunkSizeDays = symbol === 'VG' ? 7 : 30; // 7 days for VG, 30 for others\n        const chunkSize = chunkSizeDays * 24 * 60 * 60; // Convert to seconds\n        const chunks: any[] = [];\n        let currentFrom = from;\n        \n        while (currentFrom < to) {\n          const currentTo = Math.min(currentFrom + chunkSize, to);\n          const endpoint = `/stock/candle?symbol=${symbol}&resolution=${resolution}&from=${currentFrom}&to=${currentTo}`;\n          \n          const fromDate = new Date(currentFrom * 1000).toLocaleDateString();\n          const toDate = new Date(currentTo * 1000).toLocaleDateString();\n          console.log(`   Fetching chunk: ${fromDate} to ${toDate}`);\n          \n          const chunkResponse = await this.makeRequest(endpoint);\n          \n          if (chunkResponse?.s !== 'no_data' && chunkResponse?.t && chunkResponse.t.length > 0) {\n            chunks.push(chunkResponse);\n            console.log(`     Got ${chunkResponse.t.length} data points`);\n          } else {\n            console.log(`     No data for this chunk`);\n          }\n          \n          currentFrom = currentTo + 1; // Move to next chunk\n        }\n        \n        // Combine all chunks\n        if (chunks.length === 0) {\n          return null;\n        }\n        \n        const combined = {\n          s: 'ok',\n          t: [] as number[],\n          o: [] as number[],\n          h: [] as number[],\n          l: [] as number[],\n          c: [] as number[],\n          v: [] as number[]\n        };\n        \n        for (const chunk of chunks) {\n          combined.t.push(...(chunk.t || []));\n          combined.o.push(...(chunk.o || []));\n          combined.h.push(...(chunk.h || []));\n          combined.l.push(...(chunk.l || []));\n          combined.c.push(...(chunk.c || []));\n          combined.v.push(...(chunk.v || []));\n        }\n        \n        // Remove duplicates and sort by timestamp\n        const uniqueIndices: number[] = [];\n        const seenTimestamps = new Set<number>();\n        \n        for (let i = 0; i < combined.t.length; i++) {\n          if (!seenTimestamps.has(combined.t[i])) {\n            seenTimestamps.add(combined.t[i]);\n            uniqueIndices.push(i);\n          }\n        }\n        \n        // Create deduplicated arrays\n        const deduplicated = {\n          s: 'ok',\n          t: uniqueIndices.map(i => combined.t[i]),\n          o: uniqueIndices.map(i => combined.o[i]),\n          h: uniqueIndices.map(i => combined.h[i]),\n          l: uniqueIndices.map(i => combined.l[i]),\n          c: uniqueIndices.map(i => combined.c[i]),\n          v: uniqueIndices.map(i => combined.v[i])\n        };\n        \n        // Sort by timestamp\n        const sortedIndices = deduplicated.t\n          .map((t, i) => ({ t, i }))\n          .sort((a, b) => a.t - b.t)\n          .map(item => item.i);\n        \n        const response = {\n          s: 'ok',\n          t: sortedIndices.map(i => deduplicated.t[i]),\n          o: sortedIndices.map(i => deduplicated.o[i]),\n          h: sortedIndices.map(i => deduplicated.h[i]),\n          l: sortedIndices.map(i => deduplicated.l[i]),\n          c: sortedIndices.map(i => deduplicated.c[i]),\n          v: sortedIndices.map(i => deduplicated.v[i])\n        };\n        \n        if (response.t.length > 0) {\n          const firstDate = new Date(response.t[0] * 1000).toLocaleDateString();\n          const lastDate = new Date(response.t[response.t.length - 1] * 1000).toLocaleDateString();\n          console.log(` Combined ${chunks.length} chunks: ${response.t.length} total data points (${firstDate} to ${lastDate})`);\n        }\n        \n        return response;\n      }\n      \n      // Normal single request for shorter ranges\n      const endpoint = `/stock/candle?symbol=${symbol}&resolution=${resolution}&from=${from}&to=${to}`;\n      const response = await this.makeRequest(endpoint);\n      \n      if (response?.s === 'no_data') {\n        return null;\n      }\n      \n      return response;\n    } catch (error) {\n      console.error(`Error fetching candle data for ${symbol}:`, error);\n      return null;\n    }\n  }\n\n  /**\n   * Get market holidays for a specific exchange\n   */\n  async getMarketHolidays(exchange: string): Promise<any> {\n    try {\n      console.log(` Fetching market holidays for ${exchange} from Finnhub...`);\n      \n      const endpoint = `/stock/market-holiday?exchange=${exchange}`;\n      const response = await this.makeRequest(endpoint);\n      \n      if (!response || !response.data) {\n        console.warn(`No holiday data returned for exchange: ${exchange}`);\n        return null;\n      }\n      \n      console.log(` Found ${response.data?.length || 0} holidays for ${exchange}`);\n      return response;\n    } catch (error) {\n      console.error(`Error fetching market holidays for ${exchange}:`, error);\n      return null;\n    }\n  }\n\n  async getEarningsCalendar(symbol: string): Promise<any> {\n    try {\n      console.log(` Fetching earnings calendar for ${symbol} from Finnhub...`);\n      \n      // Get date range for the past 2 years to cover historical earnings\n      const endDate = new Date();\n      const startDate = new Date();\n      startDate.setFullYear(endDate.getFullYear() - 2);\n      \n      const fromDate = startDate.toISOString().split('T')[0]; // YYYY-MM-DD format\n      const toDate = endDate.toISOString().split('T')[0];\n      \n      console.log(` Fetching earnings from ${fromDate} to ${toDate} for ${symbol}`);\n      \n      // Get earnings calendar for the symbol with date range\n      const earningsData = await this.makeRequest(`/calendar/earnings?from=${fromDate}&to=${toDate}&symbol=${symbol}`);\n      \n      if (!earningsData || !earningsData.earningsCalendar) {\n        console.log(`No earnings data found for ${symbol} in date range ${fromDate} to ${toDate}`);\n        return [];\n      }\n      \n      console.log(` Found ${earningsData.earningsCalendar.length} earnings records for ${symbol}`);\n      \n      // Return earnings data with date and quarter info\n      return earningsData.earningsCalendar.map((earning: any) => ({\n        date: earning.date,\n        quarter: earning.quarter,\n        year: earning.year,\n        epsActual: earning.epsActual,\n        epsEstimate: earning.epsEstimate,\n        revenueActual: earning.revenueActual,\n        revenueEstimate: earning.revenueEstimate\n      }));\n      \n    } catch (error) {\n      console.error(`Error fetching earnings calendar for ${symbol}:`, error);\n      return [];\n    }\n  }\n\n  async getDetailedQuote(symbol: string): Promise<any> {\n    try {\n      // Get quote first (faster), then profile and metrics with fallback handling\n      const quote = await this.makeRequest(`/quote?symbol=${symbol}`);\n      if (!quote) {\n        return null;\n      }\n\n      // Get profile and metrics with individual timeout handling\n      const [profile, metrics] = await Promise.allSettled([\n        this.makeRequest(`/stock/profile2?symbol=${symbol}`),\n        this.makeRequest(`/stock/metric?symbol=${symbol}&metric=all`)\n      ]);\n\n      // Extract successful results from Promise.allSettled\n      const profileResult = profile.status === 'fulfilled' ? profile.value : null;\n      const metricsResult = metrics.status === 'fulfilled' ? metrics.value : null;\n\n      if (!profileResult) {\n        console.log(`Profile data unavailable for ${symbol}, returning limited data`);\n        return {\n          quote,\n          profile: null,\n          metrics: metricsResult?.metric || {}\n        };\n      }\n\n      // Check for market cap data quality and use most reliable source\n      let marketCap = profileResult.marketCapitalization;\n      if (metricsResult?.metric?.marketCapitalization && metricsResult.metric.marketCapitalization !== marketCap) {\n        console.log(` DATA QUALITY ALERT: ${symbol} market cap discrepancy - Profile: $${(marketCap/1000).toFixed(1)}B vs Metrics: $${(metricsResult.metric.marketCapitalization/1000).toFixed(1)}B`);\n        // Use the metrics endpoint value as it may be more current\n        marketCap = metricsResult.metric.marketCapitalization;\n      }\n      \n      // Known data quality issues - log for research team awareness\n      const knownIssues: Record<string, { expected: number; source: string }> = {\n        'CVNA': { expected: 47047, source: 'Research Team Verification' }\n      };\n      \n      if (knownIssues[symbol]) {\n        const expected = knownIssues[symbol].expected;\n        const actual = marketCap;\n        console.log(`  DATA VERIFICATION: ${symbol} - Finnhub shows $${(actual/1000).toFixed(1)}B but expected $${(expected/1000).toFixed(1)}B (${knownIssues[symbol].source})`);\n      }\n\n      // Exchange override for stocks that trade on multiple exchanges\n      // Finnhub sometimes returns primary/home exchange instead of US listing\n      const exchangeOverrides: Record<string, { exchange: string; currency: string }> = {\n        'FER': { exchange: 'NasdaqGS', currency: 'USD' }, // Ferrovial SE US listing\n        // Add more overrides as needed\n      };\n\n      let finalProfile = { ...profileResult, marketCapitalization: marketCap };\n      \n      // Apply exchange override if exists\n      if (exchangeOverrides[symbol]) {\n        finalProfile = {\n          ...finalProfile,\n          exchange: exchangeOverrides[symbol].exchange,\n          currency: exchangeOverrides[symbol].currency\n        };\n        console.log(` EXCHANGE OVERRIDE: ${symbol} - Using ${exchangeOverrides[symbol].exchange} (${exchangeOverrides[symbol].currency}) instead of ${profileResult.exchange} (${profileResult.currency})`);\n      }\n\n      return {\n        quote,\n        profile: finalProfile,\n        metrics: metricsResult?.metric || {}\n      };\n    } catch (error) {\n      console.error(`Error fetching detailed quote for ${symbol}:`, error);\n      return null;\n    }\n  }\n}\n\nexport const finnhubService = new FinnhubService();","path":null,"size_bytes":25624,"size_tokens":null},"server/vite.ts":{"content":"import express, { type Express } from \"express\";\nimport fs from \"fs\";\nimport path from \"path\";\nimport { createServer as createViteServer, createLogger } from \"vite\";\nimport { type Server } from \"http\";\nimport viteConfig from \"../vite.config\";\nimport { nanoid } from \"nanoid\";\n\nconst viteLogger = createLogger();\n\nexport function log(message: string, source = \"express\") {\n  const formattedTime = new Date().toLocaleTimeString(\"en-US\", {\n    hour: \"numeric\",\n    minute: \"2-digit\",\n    second: \"2-digit\",\n    hour12: true,\n  });\n\n  console.log(`${formattedTime} [${source}] ${message}`);\n}\n\nexport async function setupVite(app: Express, server: Server) {\n  const serverOptions = {\n    middlewareMode: true,\n    hmr: { server },\n    allowedHosts: true as const,\n  };\n\n  const vite = await createViteServer({\n    ...viteConfig,\n    configFile: false,\n    customLogger: {\n      ...viteLogger,\n      error: (msg, options) => {\n        viteLogger.error(msg, options);\n        process.exit(1);\n      },\n    },\n    server: serverOptions,\n    appType: \"custom\",\n  });\n\n  app.use(vite.middlewares);\n  app.use(\"*\", async (req, res, next) => {\n    const url = req.originalUrl;\n\n    try {\n      const clientTemplate = path.resolve(\n        import.meta.dirname,\n        \"..\",\n        \"client\",\n        \"index.html\",\n      );\n\n      // always reload the index.html file from disk incase it changes\n      let template = await fs.promises.readFile(clientTemplate, \"utf-8\");\n      template = template.replace(\n        `src=\"/src/main.tsx\"`,\n        `src=\"/src/main.tsx?v=${nanoid()}\"`,\n      );\n      const page = await vite.transformIndexHtml(url, template);\n      res.status(200).set({ \"Content-Type\": \"text/html\" }).end(page);\n    } catch (e) {\n      vite.ssrFixStacktrace(e as Error);\n      next(e);\n    }\n  });\n}\n\nexport function serveStatic(app: Express) {\n  const distPath = path.resolve(import.meta.dirname, \"public\");\n\n  if (!fs.existsSync(distPath)) {\n    throw new Error(\n      `Could not find the build directory: ${distPath}, make sure to build the client first`,\n    );\n  }\n\n  app.use(express.static(distPath));\n\n  // fall through to index.html if the file doesn't exist\n  app.use(\"*\", (_req, res) => {\n    res.sendFile(path.resolve(distPath, \"index.html\"));\n  });\n}\n","path":null,"size_bytes":2263,"size_tokens":null},"client/src/components/ui/alert-dialog.tsx":{"content":"import * as React from \"react\"\nimport * as AlertDialogPrimitive from \"@radix-ui/react-alert-dialog\"\n\nimport { cn } from \"@/lib/utils\"\nimport { buttonVariants } from \"@/components/ui/button\"\n\nconst AlertDialog = AlertDialogPrimitive.Root\n\nconst AlertDialogTrigger = AlertDialogPrimitive.Trigger\n\nconst AlertDialogPortal = AlertDialogPrimitive.Portal\n\nconst AlertDialogOverlay = React.forwardRef<\n  React.ElementRef<typeof AlertDialogPrimitive.Overlay>,\n  React.ComponentPropsWithoutRef<typeof AlertDialogPrimitive.Overlay>\n>(({ className, ...props }, ref) => (\n  <AlertDialogPrimitive.Overlay\n    className={cn(\n      \"fixed inset-0 z-50 bg-black/80  data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0\",\n      className\n    )}\n    {...props}\n    ref={ref}\n  />\n))\nAlertDialogOverlay.displayName = AlertDialogPrimitive.Overlay.displayName\n\nconst AlertDialogContent = React.forwardRef<\n  React.ElementRef<typeof AlertDialogPrimitive.Content>,\n  React.ComponentPropsWithoutRef<typeof AlertDialogPrimitive.Content>\n>(({ className, ...props }, ref) => (\n  <AlertDialogPortal>\n    <AlertDialogOverlay />\n    <AlertDialogPrimitive.Content\n      ref={ref}\n      className={cn(\n        \"fixed left-[50%] top-[50%] z-50 grid w-full max-w-lg translate-x-[-50%] translate-y-[-50%] gap-4 border bg-background p-6 shadow-lg duration-200 data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 data-[state=closed]:slide-out-to-left-1/2 data-[state=closed]:slide-out-to-top-[48%] data-[state=open]:slide-in-from-left-1/2 data-[state=open]:slide-in-from-top-[48%] sm:rounded-lg\",\n        className\n      )}\n      {...props}\n    />\n  </AlertDialogPortal>\n))\nAlertDialogContent.displayName = AlertDialogPrimitive.Content.displayName\n\nconst AlertDialogHeader = ({\n  className,\n  ...props\n}: React.HTMLAttributes<HTMLDivElement>) => (\n  <div\n    className={cn(\n      \"flex flex-col space-y-2 text-center sm:text-left\",\n      className\n    )}\n    {...props}\n  />\n)\nAlertDialogHeader.displayName = \"AlertDialogHeader\"\n\nconst AlertDialogFooter = ({\n  className,\n  ...props\n}: React.HTMLAttributes<HTMLDivElement>) => (\n  <div\n    className={cn(\n      \"flex flex-col-reverse sm:flex-row sm:justify-end sm:space-x-2\",\n      className\n    )}\n    {...props}\n  />\n)\nAlertDialogFooter.displayName = \"AlertDialogFooter\"\n\nconst AlertDialogTitle = React.forwardRef<\n  React.ElementRef<typeof AlertDialogPrimitive.Title>,\n  React.ComponentPropsWithoutRef<typeof AlertDialogPrimitive.Title>\n>(({ className, ...props }, ref) => (\n  <AlertDialogPrimitive.Title\n    ref={ref}\n    className={cn(\"text-lg font-semibold\", className)}\n    {...props}\n  />\n))\nAlertDialogTitle.displayName = AlertDialogPrimitive.Title.displayName\n\nconst AlertDialogDescription = React.forwardRef<\n  React.ElementRef<typeof AlertDialogPrimitive.Description>,\n  React.ComponentPropsWithoutRef<typeof AlertDialogPrimitive.Description>\n>(({ className, ...props }, ref) => (\n  <AlertDialogPrimitive.Description\n    ref={ref}\n    className={cn(\"text-sm text-muted-foreground\", className)}\n    {...props}\n  />\n))\nAlertDialogDescription.displayName =\n  AlertDialogPrimitive.Description.displayName\n\nconst AlertDialogAction = React.forwardRef<\n  React.ElementRef<typeof AlertDialogPrimitive.Action>,\n  React.ComponentPropsWithoutRef<typeof AlertDialogPrimitive.Action>\n>(({ className, ...props }, ref) => (\n  <AlertDialogPrimitive.Action\n    ref={ref}\n    className={cn(buttonVariants(), className)}\n    {...props}\n  />\n))\nAlertDialogAction.displayName = AlertDialogPrimitive.Action.displayName\n\nconst AlertDialogCancel = React.forwardRef<\n  React.ElementRef<typeof AlertDialogPrimitive.Cancel>,\n  React.ComponentPropsWithoutRef<typeof AlertDialogPrimitive.Cancel>\n>(({ className, ...props }, ref) => (\n  <AlertDialogPrimitive.Cancel\n    ref={ref}\n    className={cn(\n      buttonVariants({ variant: \"outline\" }),\n      \"mt-2 sm:mt-0\",\n      className\n    )}\n    {...props}\n  />\n))\nAlertDialogCancel.displayName = AlertDialogPrimitive.Cancel.displayName\n\nexport {\n  AlertDialog,\n  AlertDialogPortal,\n  AlertDialogOverlay,\n  AlertDialogTrigger,\n  AlertDialogContent,\n  AlertDialogHeader,\n  AlertDialogFooter,\n  AlertDialogTitle,\n  AlertDialogDescription,\n  AlertDialogAction,\n  AlertDialogCancel,\n}\n","path":null,"size_bytes":4420,"size_tokens":null},"client/src/components/ui/toggle-group.tsx":{"content":"\"use client\"\n\nimport * as React from \"react\"\nimport * as ToggleGroupPrimitive from \"@radix-ui/react-toggle-group\"\nimport { type VariantProps } from \"class-variance-authority\"\n\nimport { cn } from \"@/lib/utils\"\nimport { toggleVariants } from \"@/components/ui/toggle\"\n\nconst ToggleGroupContext = React.createContext<\n  VariantProps<typeof toggleVariants>\n>({\n  size: \"default\",\n  variant: \"default\",\n})\n\nconst ToggleGroup = React.forwardRef<\n  React.ElementRef<typeof ToggleGroupPrimitive.Root>,\n  React.ComponentPropsWithoutRef<typeof ToggleGroupPrimitive.Root> &\n    VariantProps<typeof toggleVariants>\n>(({ className, variant, size, children, ...props }, ref) => (\n  <ToggleGroupPrimitive.Root\n    ref={ref}\n    className={cn(\"flex items-center justify-center gap-1\", className)}\n    {...props}\n  >\n    <ToggleGroupContext.Provider value={{ variant, size }}>\n      {children}\n    </ToggleGroupContext.Provider>\n  </ToggleGroupPrimitive.Root>\n))\n\nToggleGroup.displayName = ToggleGroupPrimitive.Root.displayName\n\nconst ToggleGroupItem = React.forwardRef<\n  React.ElementRef<typeof ToggleGroupPrimitive.Item>,\n  React.ComponentPropsWithoutRef<typeof ToggleGroupPrimitive.Item> &\n    VariantProps<typeof toggleVariants>\n>(({ className, children, variant, size, ...props }, ref) => {\n  const context = React.useContext(ToggleGroupContext)\n\n  return (\n    <ToggleGroupPrimitive.Item\n      ref={ref}\n      className={cn(\n        toggleVariants({\n          variant: context.variant || variant,\n          size: context.size || size,\n        }),\n        className\n      )}\n      {...props}\n    >\n      {children}\n    </ToggleGroupPrimitive.Item>\n  )\n})\n\nToggleGroupItem.displayName = ToggleGroupPrimitive.Item.displayName\n\nexport { ToggleGroup, ToggleGroupItem }\n","path":null,"size_bytes":1753,"size_tokens":null},"client/src/pages/login-history.tsx":{"content":"import { useQuery } from '@tanstack/react-query';\nimport { format } from 'date-fns';\nimport { Card, CardContent, CardDescription, CardHeader, CardTitle } from '@/components/ui/card';\nimport { Table, TableBody, TableCell, TableHead, TableHeader, TableRow } from '@/components/ui/table';\nimport { Badge } from '@/components/ui/badge';\nimport { Link } from 'wouter';\nimport { Button } from '@/components/ui/button';\nimport { ArrowLeft, CheckCircle2, XCircle, MapPin } from 'lucide-react';\nimport type { LoginAttempt } from '@shared/schema';\n\nexport default function LoginHistory() {\n  const { data: attempts = [], isLoading } = useQuery<LoginAttempt[]>({\n    queryKey: ['/api/login-attempts'],\n  });\n\n  return (\n    <div className=\"min-h-screen bg-background p-4\">\n      <div className=\"max-w-7xl mx-auto\">\n        <div className=\"mb-6\">\n          <Link href=\"/\">\n            <Button variant=\"ghost\" size=\"sm\" className=\"mb-4\" data-testid=\"button-back\">\n              <ArrowLeft className=\"h-4 w-4 mr-2\" />\n              Back to Dashboard\n            </Button>\n          </Link>\n          <h1 className=\"text-3xl font-light tracking-wide mb-2\" style={{ fontFamily: 'var(--font-serif)' }}>\n            Login Attempt History\n          </h1>\n          <p className=\"text-muted-foreground\" style={{ fontFamily: 'var(--font-sans)' }}>\n            Track all login attempts to your account\n          </p>\n        </div>\n\n        <Card>\n          <CardHeader>\n            <CardTitle style={{ fontFamily: 'var(--font-serif)' }}>Recent Login Attempts</CardTitle>\n            <CardDescription style={{ fontFamily: 'var(--font-sans)' }}>\n              Showing the last 100 login attempts\n            </CardDescription>\n          </CardHeader>\n          <CardContent>\n            {isLoading ? (\n              <div className=\"text-center py-12 text-muted-foreground\" style={{ fontFamily: 'var(--font-sans)' }}>\n                Loading login attempts...\n              </div>\n            ) : attempts.length === 0 ? (\n              <div className=\"text-center py-12 text-muted-foreground\" style={{ fontFamily: 'var(--font-sans)' }}>\n                No login attempts recorded yet\n              </div>\n            ) : (\n              <div className=\"overflow-x-auto\">\n                <Table>\n                  <TableHeader>\n                    <TableRow>\n                      <TableHead style={{ fontFamily: 'var(--font-sans)' }}>Status</TableHead>\n                      <TableHead style={{ fontFamily: 'var(--font-sans)' }}>Username</TableHead>\n                      <TableHead style={{ fontFamily: 'var(--font-sans)' }}>Failure Reason</TableHead>\n                      <TableHead style={{ fontFamily: 'var(--font-sans)' }}>IP Address</TableHead>\n                      <TableHead style={{ fontFamily: 'var(--font-sans)' }}>Location</TableHead>\n                      <TableHead style={{ fontFamily: 'var(--font-sans)' }}>User Agent</TableHead>\n                      <TableHead style={{ fontFamily: 'var(--font-sans)' }}>Date & Time</TableHead>\n                    </TableRow>\n                  </TableHeader>\n                  <TableBody>\n                    {attempts.map((attempt) => {\n                      const locationParts = [\n                        attempt.city,\n                        attempt.region,\n                        attempt.country\n                      ].filter(Boolean);\n                      const locationText = locationParts.length > 0 \n                        ? locationParts.join(', ') \n                        : 'Unknown';\n                      \n                      return (\n                        <TableRow key={attempt.id} data-testid={`row-attempt-${attempt.id}`}>\n                          <TableCell>\n                            {attempt.success ? (\n                              <Badge \n                                variant=\"outline\" \n                                className=\"bg-green-500/10 text-green-400 border-green-500/20\"\n                                data-testid=\"badge-success\"\n                              >\n                                <CheckCircle2 className=\"h-3 w-3 mr-1\" />\n                                Success\n                              </Badge>\n                            ) : (\n                              <Badge \n                                variant=\"outline\" \n                                className=\"bg-red-500/10 text-red-400 border-red-500/20\"\n                                data-testid=\"badge-failed\"\n                              >\n                                <XCircle className=\"h-3 w-3 mr-1\" />\n                                Failed\n                              </Badge>\n                            )}\n                          </TableCell>\n                          <TableCell \n                            className=\"font-mono text-sm\" \n                            style={{ fontFamily: 'var(--font-sans)' }}\n                            data-testid={`text-username-${attempt.id}`}\n                          >\n                            {attempt.username}\n                          </TableCell>\n                          <TableCell \n                            className=\"text-sm\"\n                            data-testid={`text-failure-reason-${attempt.id}`}\n                          >\n                            {attempt.success ? (\n                              <span className=\"text-muted-foreground\">-</span>\n                            ) : (\n                              <span className=\"text-amber-400\">{attempt.failureReason || 'Unknown'}</span>\n                            )}\n                          </TableCell>\n                          <TableCell \n                            className=\"font-mono text-sm text-muted-foreground\"\n                            data-testid={`text-ip-${attempt.id}`}\n                          >\n                            {attempt.ipAddress || 'N/A'}\n                          </TableCell>\n                          <TableCell \n                            className=\"text-sm\"\n                            data-testid={`text-location-${attempt.id}`}\n                          >\n                            <div className=\"flex items-center gap-1.5\">\n                              {locationParts.length > 0 && (\n                                <MapPin className=\"h-3.5 w-3.5 text-cyan-400 shrink-0\" />\n                              )}\n                              <span className=\"text-muted-foreground\">{locationText}</span>\n                            </div>\n                          </TableCell>\n                          <TableCell \n                            className=\"text-sm text-muted-foreground max-w-md truncate\" \n                            title={attempt.userAgent || 'N/A'}\n                            data-testid={`text-useragent-${attempt.id}`}\n                          >\n                            {attempt.userAgent || 'N/A'}\n                          </TableCell>\n                          <TableCell \n                            className=\"text-sm\" \n                            style={{ fontFamily: 'var(--font-sans)' }}\n                            data-testid={`text-date-${attempt.id}`}\n                          >\n                            {format(new Date(attempt.attemptedAt), 'MMM dd, yyyy HH:mm:ss')}\n                          </TableCell>\n                        </TableRow>\n                      );\n                    })}\n                  </TableBody>\n                </Table>\n              </div>\n            )}\n          </CardContent>\n        </Card>\n\n        {/* Summary Stats */}\n        {!isLoading && attempts.length > 0 && (\n          <div className=\"grid grid-cols-1 md:grid-cols-3 gap-4 mt-6\">\n            <Card>\n              <CardHeader className=\"pb-3\">\n                <CardTitle className=\"text-sm font-medium text-muted-foreground\" style={{ fontFamily: 'var(--font-sans)' }}>\n                  Total Attempts\n                </CardTitle>\n              </CardHeader>\n              <CardContent>\n                <div className=\"text-2xl font-light\" style={{ fontFamily: 'var(--font-serif)' }} data-testid=\"text-total-attempts\">\n                  {attempts.length}\n                </div>\n              </CardContent>\n            </Card>\n\n            <Card>\n              <CardHeader className=\"pb-3\">\n                <CardTitle className=\"text-sm font-medium text-muted-foreground\" style={{ fontFamily: 'var(--font-sans)' }}>\n                  Successful Logins\n                </CardTitle>\n              </CardHeader>\n              <CardContent>\n                <div className=\"text-2xl font-light text-green-400\" style={{ fontFamily: 'var(--font-serif)' }} data-testid=\"text-success-count\">\n                  {attempts.filter(a => a.success).length}\n                </div>\n              </CardContent>\n            </Card>\n\n            <Card>\n              <CardHeader className=\"pb-3\">\n                <CardTitle className=\"text-sm font-medium text-muted-foreground\" style={{ fontFamily: 'var(--font-sans)' }}>\n                  Failed Attempts\n                </CardTitle>\n              </CardHeader>\n              <CardContent>\n                <div className=\"text-2xl font-light text-red-400\" style={{ fontFamily: 'var(--font-serif)' }} data-testid=\"text-failed-count\">\n                  {attempts.filter(a => !a.success).length}\n                </div>\n              </CardContent>\n            </Card>\n          </div>\n        )}\n      </div>\n    </div>\n  );\n}\n","path":null,"size_bytes":9433,"size_tokens":null},"client/src/pages/walkthrough.tsx":{"content":"import { Link, useLocation } from \"wouter\";\nimport { Button } from \"@/components/ui/button\";\nimport { Card } from \"@/components/ui/card\";\nimport { \n  Search, \n  TrendingUp, \n  Globe, \n  Download, \n  PenTool, \n  BarChart3, \n  ArrowLeft,\n  Calendar,\n  MousePointer2,\n  Layers,\n  Type,\n  Ruler,\n  Minus,\n  LogOut,\n  BookOpen\n} from \"lucide-react\";\nimport logoImage from \"@assets/IPO Intelligence@2x_1758060026530.png\";\nimport { SuffixSearchModal } from \"@/components/suffix-search-modal\";\nimport { useAuth } from \"@/contexts/AuthContext\";\nimport {\n  Select,\n  SelectContent,\n  SelectItem,\n  SelectTrigger,\n  SelectValue,\n} from \"@/components/ui/select\";\n\nfunction LogoutButton() {\n  const { logout } = useAuth();\n  const [, setLocation] = useLocation();\n\n  const handleLogout = () => {\n    logout();\n    setLocation('/login');\n  };\n\n  return (\n    <button\n      onClick={handleLogout}\n      className=\"flex items-center gap-2 hover:opacity-80 transition-opacity\"\n      data-testid=\"button-logout\"\n      style={{ fontFamily: 'var(--font-sans)', fontSize: '16px', color: '#f7f7f7' }}\n    >\n      <LogOut className=\"h-5 w-5 text-[#5AF5FA]\" />\n      <span>Sign Out</span>\n    </button>\n  );\n}\n\nexport default function Walkthrough() {\n  const [, setLocation] = useLocation();\n\n  const handleChartTypeChange = (value: string) => {\n    setLocation(value);\n  };\n\n  return (\n    <div className=\"min-h-screen bg-background\">\n      {/* Navigation Header */}\n      <header className=\"border-b border-border sticky top-0 z-50 bg-background/95 backdrop-blur supports-[backdrop-filter]:bg-background/60\">\n        <div className=\"container mx-auto px-4 py-4\">\n          <div className=\"flex items-center justify-between\">\n            {/* Logo */}\n            <Link href=\"/\">\n              <img src={logoImage} alt=\"Logo\" className=\"w-[240px] h-auto max-[600px]:w-[180px] hover:opacity-80 transition-opacity cursor-pointer\" data-testid=\"link-home\" />\n            </Link>\n\n            {/* Navigation Items */}\n            <nav className=\"flex items-center gap-6\">\n              {/* Chart Type Dropdown */}\n              <Select onValueChange={handleChartTypeChange}>\n                <SelectTrigger \n                  className=\"w-[200px] bg-card border-border\"\n                  data-testid=\"select-chart-type\"\n                  style={{ fontFamily: 'var(--font-sans)' }}\n                >\n                  <SelectValue placeholder=\"Chart Type\" />\n                </SelectTrigger>\n                <SelectContent style={{ backgroundColor: '#3A3A3A' }}>\n                  <SelectItem value=\"/price-chart\">Price Chart</SelectItem>\n                  <SelectItem value=\"/comparison-chart\">Comparison Chart</SelectItem>\n                  <SelectItem value=\"/ai-copilot\">AI Co-Pilot</SelectItem>\n                </SelectContent>\n              </Select>\n\n              {/* Walkthrough Link */}\n              <Link href=\"/walkthrough\">\n                <span \n                  className=\"flex items-center gap-2 hover:opacity-80 transition-opacity cursor-pointer\"\n                  data-testid=\"link-walkthrough\"\n                  style={{ fontFamily: 'var(--font-sans)', fontSize: '16px', color: '#f7f7f7' }}\n                >\n                  <BookOpen className=\"h-5 w-5 text-[#5AF5FA]\" />\n                  <span>Walkthrough</span>\n                </span>\n              </Link>\n\n              {/* Logout Button */}\n              <LogoutButton />\n            </nav>\n          </div>\n        </div>\n      </header>\n\n      {/* Main Content */}\n      <main className=\"max-w-5xl mx-auto px-4 sm:px-6 lg:px-8 py-12\">\n        <div className=\"space-y-8\">\n          {/* Introduction */}\n          <div className=\"text-center space-y-4\">\n            <h1 className=\"text-4xl font-light\" style={{ fontFamily: 'Space Grotesk' }}>\n              Welcome to Intropic Chart Studio\n            </h1>\n            <p className=\"text-lg text-muted-foreground max-w-2xl mx-auto\">\n              A powerful tool for tracking and analyzing stock prices across global markets. \n              This guide will help you get started with all the features.\n            </p>\n          </div>\n\n          {/* Feature Sections */}\n          <div className=\"space-y-6\">\n            {/* Global Search */}\n            <Card className=\"p-6 border\">\n              <div className=\"flex items-start gap-4\">\n                <div className=\"p-3 rounded-lg bg-primary/10\">\n                  <Search className=\"h-6 w-6 text-[#5AF5FA]\" />\n                </div>\n                <div className=\"flex-1 space-y-3\">\n                  <h2 className=\"text-2xl font-semibold\">Global Stock Search</h2>\n                  <p className=\"text-muted-foreground\">\n                    Search for stocks, ETFs, and indices from 69 global exchanges using Bloomberg-style ticker suffixes.\n                  </p>\n                  <ul className=\"space-y-2 text-sm text-muted-foreground ml-4\">\n                    <li className=\"flex items-start gap-2\">\n                      <span className=\"text-[#5AF5FA] mt-1\"></span>\n                      <span>Type any company name or ticker symbol in the search bar</span>\n                    </li>\n                    <li className=\"flex items-start gap-2\">\n                      <span className=\"text-[#5AF5FA] mt-1\"></span>\n                      <span>Results are color-coded: <span className=\"text-[#FAFF50]\">Yellow</span> for indices, <span className=\"text-[#FFA5FF]\">Pink</span> for ETFs</span>\n                    </li>\n                    <li className=\"flex items-start gap-2\">\n                      <span className=\"text-[#5AF5FA] mt-1\"></span>\n                      <span>Use ticker suffixes to specify exchanges (e.g., AAPL:US for NASDAQ, 7203:JP for Toyota)</span>\n                    </li>\n                    <li className=\"flex items-start gap-2\">\n                      <span className=\"text-[#5AF5FA] mt-1\"></span>\n                      <span>Recent searches are saved for quick access</span>\n                    </li>\n                  </ul>\n                </div>\n              </div>\n            </Card>\n\n            {/* Suffix Guide */}\n            <SuffixSearchModal>\n              <Card \n                className=\"p-6 walkthrough-card cursor-pointer transition-all border\" \n                data-testid=\"card-suffix-guide\"\n              >\n                <div className=\"flex items-start gap-4\">\n                  <div className=\"p-3 rounded-lg bg-primary/10\">\n                    <Globe className=\"h-6 w-6 text-[#FAFF50]\" />\n                  </div>\n                  <div className=\"flex-1 space-y-3\">\n                    <h2 className=\"text-2xl font-semibold\">Ticker Suffix Guide</h2>\n                    <p className=\"text-muted-foreground\">\n                      Access a comprehensive guide to Bloomberg-style ticker suffixes for global exchanges.\n                    </p>\n                    <ul className=\"space-y-2 text-sm text-muted-foreground ml-4\">\n                      <li className=\"flex items-start gap-2\">\n                        <span className=\"text-[#5AF5FA] mt-1\"></span>\n                        <span>Click this card to open the Suffix Guide</span>\n                      </li>\n                      <li className=\"flex items-start gap-2\">\n                        <span className=\"text-[#5AF5FA] mt-1\"></span>\n                        <span>Search by country, exchange name, or suffix code</span>\n                      </li>\n                      <li className=\"flex items-start gap-2\">\n                        <span className=\"text-[#5AF5FA] mt-1\"></span>\n                        <span>View market hours and holiday information for each exchange</span>\n                      </li>\n                    </ul>\n                  </div>\n                </div>\n              </Card>\n            </SuffixSearchModal>\n\n            {/* Price Charts */}\n            <Card \n              className=\"p-6 walkthrough-card cursor-pointer transition-all border\" \n              onClick={() => setLocation('/')}\n              data-testid=\"card-price-charts\"\n            >\n              <div className=\"flex items-start gap-4\">\n                <div className=\"p-3 rounded-lg bg-primary/10\">\n                  <TrendingUp className=\"h-6 w-6 text-[#5AF5FA]\" />\n                </div>\n                <div className=\"flex-1 space-y-3\">\n                  <h2 className=\"text-2xl font-semibold\">Interactive Price Charts</h2>\n                  <p className=\"text-muted-foreground\">\n                    View detailed price charts with multiple timeframes and real-time data.\n                  </p>\n                  <ul className=\"space-y-2 text-sm text-muted-foreground ml-4\">\n                    <li className=\"flex items-start gap-2\">\n                      <span className=\"text-[#5AF5FA] mt-1\"></span>\n                      <span>Select from 9 timeframes: 1D, 5D, 2W, 1M, 3M, 1Y, 3Y, 5Y, or Custom date range</span>\n                    </li>\n                    <li className=\"flex items-start gap-2\">\n                      <span className=\"text-[#5AF5FA] mt-1\"></span>\n                      <span>Hover over the chart to see detailed price and time information</span>\n                    </li>\n                    <li className=\"flex items-start gap-2\">\n                      <span className=\"text-[#5AF5FA] mt-1\"></span>\n                      <span>Charts automatically adapt to mobile and desktop screen sizes</span>\n                    </li>\n                  </ul>\n                </div>\n              </div>\n            </Card>\n\n            {/* Comparison Charts */}\n            <Card \n              className=\"p-6 walkthrough-card cursor-pointer transition-all border\" \n              onClick={() => setLocation('/?action=compare')}\n              data-testid=\"card-comparison\"\n            >\n              <div className=\"flex items-start gap-4\">\n                <div className=\"p-3 rounded-lg bg-primary/10\">\n                  <BarChart3 className=\"h-6 w-6 text-[#5AF5FA]\" />\n                </div>\n                <div className=\"flex-1 space-y-3\">\n                  <h2 className=\"text-2xl font-semibold\">Stock Comparison</h2>\n                  <p className=\"text-muted-foreground\">\n                    Compare up to 12 stocks and indices side-by-side with percentage-based performance tracking.\n                  </p>\n                  <ul className=\"space-y-2 text-sm text-muted-foreground ml-4\">\n                    <li className=\"flex items-start gap-2\">\n                      <span className=\"text-[#5AF5FA] mt-1\"></span>\n                      <span>Click the \"Compare\" tab on any price chart</span>\n                    </li>\n                    <li className=\"flex items-start gap-2\">\n                      <span className=\"text-[#5AF5FA] mt-1\"></span>\n                      <span>Add multiple stocks using the search bar</span>\n                    </li>\n                    <li className=\"flex items-start gap-2\">\n                      <span className=\"text-[#5AF5FA] mt-1\"></span>\n                      <span>All comparisons are normalized to percentage changes for fair comparison</span>\n                    </li>\n                    <li className=\"flex items-start gap-2\">\n                      <span className=\"text-[#5AF5FA] mt-1\"></span>\n                      <span>Mix stocks and indices from different global markets</span>\n                    </li>\n                  </ul>\n                </div>\n              </div>\n            </Card>\n\n            {/* Annotation Tools */}\n            <Card \n              className=\"p-6 walkthrough-card cursor-pointer transition-all border\" \n              onClick={() => setLocation('/')}\n              data-testid=\"card-annotations\"\n            >\n              <div className=\"flex items-start gap-4\">\n                <div className=\"p-3 rounded-lg bg-primary/10\">\n                  <PenTool className=\"h-6 w-6 text-[#5AF5FA]\" />\n                </div>\n                <div className=\"flex-1 space-y-3\">\n                  <h2 className=\"text-2xl font-semibold\">Chart Annotations</h2>\n                  <p className=\"text-muted-foreground\">\n                    Mark up your charts with three powerful annotation tools.\n                  </p>\n                  <div className=\"space-y-4 mt-4\">\n                    <div className=\"flex items-start gap-3\">\n                      <Minus className=\"h-5 w-5 text-[#FAFF50] mt-1 flex-shrink-0\" />\n                      <div>\n                        <h3 className=\"font-semibold text-[#FAFF50]\">Vertical Line</h3>\n                        <p className=\"text-sm text-muted-foreground\">\n                          Mark specific dates or events on your chart. Click once to place a vertical line with a text label.\n                        </p>\n                      </div>\n                    </div>\n                    <div className=\"flex items-start gap-3\">\n                      <Ruler className=\"h-5 w-5 text-[#22C55E] mt-1 flex-shrink-0\" />\n                      <div>\n                        <h3 className=\"font-semibold text-[#22C55E]\">Measure Tool</h3>\n                        <p className=\"text-sm text-muted-foreground\">\n                          Calculate percentage change between two points. Click start and end points to see price difference, percentage change, and time span.\n                        </p>\n                      </div>\n                    </div>\n                    <div className=\"flex items-start gap-3\">\n                      <Minus className=\"h-5 w-5 text-[#AA99FF] mt-1 flex-shrink-0\" />\n                      <div>\n                        <h3 className=\"font-semibold text-[#AA99FF]\">Horizontal Line</h3>\n                        <p className=\"text-sm text-muted-foreground\">\n                          Mark support/resistance levels. Click to place a horizontal price line with a custom label.\n                        </p>\n                      </div>\n                    </div>\n                  </div>\n                  <ul className=\"space-y-2 text-sm text-muted-foreground ml-4 mt-4\">\n                    <li className=\"flex items-start gap-2\">\n                      <span className=\"text-[#5AF5FA] mt-1\"></span>\n                      <span>Color-coded cursors show which tool is active</span>\n                    </li>\n                    <li className=\"flex items-start gap-2\">\n                      <span className=\"text-[#5AF5FA] mt-1\"></span>\n                      <span>Annotations are automatically saved per ticker (toggle off to use globally)</span>\n                    </li>\n                    <li className=\"flex items-start gap-2\">\n                      <span className=\"text-[#5AF5FA] mt-1\"></span>\n                      <span>Delete individual annotations or clear all at once</span>\n                    </li>\n                    <li className=\"flex items-start gap-2\">\n                      <span className=\"text-[#5AF5FA] mt-1\"></span>\n                      <span>Drag annotation text boxes to reposition them</span>\n                    </li>\n                  </ul>\n                </div>\n              </div>\n            </Card>\n\n            {/* Export Features */}\n            <Card className=\"p-6 border\">\n              <div className=\"flex items-start gap-4\">\n                <div className=\"p-3 rounded-lg bg-primary/10\">\n                  <Download className=\"h-6 w-6 text-[#5AF5FA]\" />\n                </div>\n                <div className=\"flex-1 space-y-3\">\n                  <h2 className=\"text-2xl font-semibold\">Export & Share</h2>\n                  <p className=\"text-muted-foreground\">\n                    Save your charts and annotations for presentations or reports.\n                  </p>\n                  <ul className=\"space-y-2 text-sm text-muted-foreground ml-4\">\n                    <li className=\"flex items-start gap-2\">\n                      <span className=\"text-[#5AF5FA] mt-1\"></span>\n                      <span>Export charts as PNG images with all annotations included</span>\n                    </li>\n                    <li className=\"flex items-start gap-2\">\n                      <span className=\"text-[#5AF5FA] mt-1\"></span>\n                      <span>Download stock data as Excel spreadsheets</span>\n                    </li>\n                    <li className=\"flex items-start gap-2\">\n                      <span className=\"text-[#5AF5FA] mt-1\"></span>\n                      <span>Export comparison charts showing multiple stocks</span>\n                    </li>\n                  </ul>\n                </div>\n              </div>\n            </Card>\n          </div>\n\n          {/* Call to Action */}\n          <div className=\"text-center pt-8 pb-4\">\n            <Link href=\"/\">\n              <Button size=\"lg\" className=\"bg-[#5AF5FA] hover:bg-[#5AF5FA]/90 text-black\" data-testid=\"button-get-started\">\n                Get Started\n              </Button>\n            </Link>\n          </div>\n        </div>\n      </main>\n    </div>\n  );\n}\n","path":null,"size_bytes":16972,"size_tokens":null},"client/src/pages/home.tsx":{"content":"import { Link, useLocation } from \"wouter\";\nimport { Card } from \"@/components/ui/card\";\nimport { Button } from \"@/components/ui/button\";\nimport { BarChart3, TrendingUp, Sparkles, LogOut, Globe, MessageSquare, BookOpen } from \"lucide-react\";\nimport { useAuth } from \"@/contexts/AuthContext\";\nimport logoImage from \"@assets/IPO Intelligence@2x_1758060026530.png\";\nimport {\n  Select,\n  SelectContent,\n  SelectItem,\n  SelectTrigger,\n  SelectValue,\n} from \"@/components/ui/select\";\n\nfunction LogoutButton() {\n  const { logout } = useAuth();\n  const [, setLocation] = useLocation();\n\n  const handleLogout = () => {\n    logout();\n    setLocation('/login');\n  };\n\n  return (\n    <button\n      onClick={handleLogout}\n      className=\"flex items-center gap-2 hover:opacity-80 transition-opacity\"\n      data-testid=\"button-logout\"\n      style={{ fontFamily: 'var(--font-sans)', fontSize: '16px', color: '#f7f7f7' }}\n    >\n      <LogOut className=\"h-5 w-5 text-[#5AF5FA]\" />\n      <span>Sign Out</span>\n    </button>\n  );\n}\n\nexport default function Home() {\n  const [, setLocation] = useLocation();\n\n  const pathwayCards = [\n    {\n      id: 'price-chart',\n      title: 'Price Chart',\n      description: 'Single-ticker charts  look up almost any global stock and add your own editable annotations to bring your data to life. Perfect for quick visual analysis and storytelling.',\n      icon: BarChart3,\n      destination: '/price-chart',\n      buttonText: 'Open Price Chart',\n      iconColor: '#5AF5FA', // Cyan/Blue\n      titleColor: '#5AF5FA', // Cyan/Blue\n    },\n    {\n      id: 'comparison-chart',\n      title: 'Comparison Chart',\n      description: 'Compare multiple tickers or ETFs side-by-side to uncover performance trends, correlations, and outliers. Create dynamic visuals that highlight relative strength and movement across markets.',\n      icon: TrendingUp,\n      destination: '/comparison-chart',\n      buttonText: 'Open Comparison Chart',\n      iconColor: '#FAFF50', // Yellow\n      titleColor: '#FAFF50', // Yellow\n    },\n    {\n      id: 'ai-copilot',\n      title: 'AI Co-Pilot',\n      description: 'Upload a CSV or simply prompt the AI Co-Pilot to create bespoke charts using your data. Automatically styled in Intropic brand colours, ready to export in high-resolution or embed directly into reports.',\n      icon: Sparkles,\n      destination: '/ai-copilot',\n      buttonText: 'Open AI Co-Pilot',\n      iconColor: '#FFA5FF', // Pink\n      titleColor: '#50FFA5', // Green\n    },\n  ];\n\n  const handleChartTypeChange = (value: string) => {\n    setLocation(value);\n  };\n\n  return (\n    <div className=\"min-h-screen bg-background text-foreground\">\n      {/* Navigation Header */}\n      <header className=\"border-b border-border sticky top-0 z-50 bg-background/95 backdrop-blur supports-[backdrop-filter]:bg-background/60\">\n        <div className=\"container mx-auto px-4 py-4\">\n          <div className=\"flex items-center justify-between\">\n            {/* Logo */}\n            <Link href=\"/\">\n              <img src={logoImage} alt=\"Logo\" className=\"w-[240px] h-auto max-[600px]:w-[180px] hover:opacity-80 transition-opacity cursor-pointer\" data-testid=\"link-home\" />\n            </Link>\n\n            {/* Navigation Items */}\n            <nav className=\"flex items-center gap-6\">\n              {/* Chart Type Dropdown */}\n              <Select onValueChange={handleChartTypeChange}>\n                <SelectTrigger \n                  className=\"w-[200px] bg-card border-border\"\n                  data-testid=\"select-chart-type\"\n                  style={{ fontFamily: 'var(--font-sans)' }}\n                >\n                  <SelectValue placeholder=\"Chart Type\" />\n                </SelectTrigger>\n                <SelectContent style={{ backgroundColor: '#3A3A3A' }}>\n                  <SelectItem value=\"/price-chart\">Price Chart</SelectItem>\n                  <SelectItem value=\"/comparison-chart\">Comparison Chart</SelectItem>\n                  <SelectItem value=\"/ai-copilot\">AI Co-Pilot</SelectItem>\n                </SelectContent>\n              </Select>\n\n              {/* Walkthrough Link */}\n              <Link href=\"/walkthrough\">\n                <span \n                  className=\"flex items-center gap-2 hover:opacity-80 transition-opacity cursor-pointer\"\n                  data-testid=\"link-walkthrough\"\n                  style={{ fontFamily: 'var(--font-sans)', fontSize: '16px', color: '#f7f7f7' }}\n                >\n                  <BookOpen className=\"h-5 w-5 text-[#5AF5FA]\" />\n                  <span>Walkthrough</span>\n                </span>\n              </Link>\n\n              {/* Logout Button */}\n              <LogoutButton />\n            </nav>\n          </div>\n        </div>\n      </header>\n\n      {/* Main Content */}\n      <main className=\"container mx-auto px-4 py-12\">\n        {/* Hero Section */}\n        <div className=\"text-center mb-16\">\n          <h1 \n            className=\"text-5xl font-light mb-4 text-foreground\"\n            style={{ fontFamily: 'Space Grotesk, sans-serif' }}\n          >\n            Welcome to Chart Editor\n          </h1>\n          <p \n            className=\"text-xl text-muted-foreground max-w-2xl mx-auto\"\n            style={{ fontFamily: 'Mulish, sans-serif' }}\n          >\n            Choose your pathway to start creating professional, data-driven charts\n          </p>\n        </div>\n\n        {/* Pathway Cards */}\n        <div className=\"grid grid-cols-1 md:grid-cols-3 gap-8 max-w-7xl mx-auto\">\n          {pathwayCards.map((card) => {\n            const IconComponent = card.icon;\n            return (\n              <Card\n                key={card.id}\n                className=\"group relative overflow-hidden border-border hover:shadow-xl transition-all duration-300 hover:scale-105 cursor-pointer\"\n                style={{ backgroundColor: '#1C1C1C' }}\n                onClick={() => setLocation(card.destination)}\n                data-testid={`card-${card.id}`}\n              >\n                {/* Gradient border on hover */}\n                <div\n                  className=\"absolute inset-0 rounded opacity-0 group-hover:opacity-100 transition-opacity duration-200 pointer-events-none\"\n                  style={{\n                    background: 'linear-gradient(90deg, #5AF5FA 0%, #FFA5FF 100%)',\n                    padding: '1px',\n                    borderRadius: '4px',\n                  }}\n                >\n                  <div \n                    className=\"w-full h-full rounded\" \n                    style={{ \n                      backgroundColor: '#1C1C1C',\n                      borderRadius: '4px'\n                    }} \n                  />\n                </div>\n\n                <div className=\"relative p-8 flex flex-col h-full min-h-[320px]\">\n                  {/* Icon */}\n                  <div className=\"mb-6\">\n                    <div \n                      className=\"w-16 h-16 rounded-lg flex items-center justify-center\"\n                      style={{ backgroundColor: `${card.iconColor}20` }}\n                    >\n                      <IconComponent \n                        className=\"h-8 w-8\" \n                        style={{ color: card.iconColor }}\n                      />\n                    </div>\n                  </div>\n\n                  {/* Title */}\n                  <h2 \n                    className=\"text-2xl font-semibold mb-4\"\n                    style={{ \n                      fontFamily: 'Mulish, sans-serif',\n                      color: '#F7F7F7'\n                    }}\n                  >\n                    {card.title}\n                  </h2>\n\n                  {/* Description */}\n                  <p \n                    className=\"mb-6 flex-grow\"\n                    style={{ \n                      fontFamily: 'Mulish, sans-serif',\n                      fontSize: '15px',\n                      lineHeight: '1.6',\n                      color: '#F7F7F7'\n                    }}\n                  >\n                    {card.description}\n                  </p>\n\n                  {/* CTA Button */}\n                  <Button\n                    className=\"w-full font-medium\"\n                    style={{\n                      backgroundColor: '#5AF5FA',\n                      color: '#000000',\n                      fontFamily: 'Mulish, sans-serif',\n                    }}\n                    onClick={(e) => {\n                      e.stopPropagation();\n                      setLocation(card.destination);\n                    }}\n                    data-testid={`button-${card.id}`}\n                  >\n                    {card.buttonText}\n                  </Button>\n                </div>\n              </Card>\n            );\n          })}\n        </div>\n\n        {/* Additional Links Section */}\n        <div className=\"mt-16 text-center\">\n          <div className=\"inline-flex items-center gap-8\">\n            <Link href=\"/walkthrough\">\n              <span \n                className=\"flex items-center gap-2 text-[#5AF5FA] hover:opacity-80 transition-opacity cursor-pointer\"\n                data-testid=\"link-walkthrough-bottom\"\n              >\n                <BookOpen className=\"h-5 w-5\" />\n                <span style={{ fontFamily: 'Mulish, sans-serif' }}>View Product Walkthrough</span>\n              </span>\n            </Link>\n          </div>\n        </div>\n      </main>\n    </div>\n  );\n}\n","path":null,"size_bytes":9352,"size_tokens":null},"client/src/components/ai-copilot/chart.tsx":{"content":"import { BarChart, Bar, LineChart, Line, AreaChart, Area, PieChart, Pie, Cell, XAxis, YAxis, CartesianGrid, Tooltip, Legend, ResponsiveContainer } from 'recharts';\nimport { Button } from '@/components/ui/button';\nimport { Download, Code2, Copy, Check } from 'lucide-react';\nimport { toPng } from 'html-to-image';\nimport { useRef, useState } from 'react';\nimport { Dialog, DialogContent, DialogHeader, DialogTitle, DialogDescription } from '@/components/ui/dialog';\nimport { Tabs, TabsContent, TabsList, TabsTrigger } from '@/components/ui/tabs';\n\ninterface ChartConfig {\n  type: 'bar' | 'line' | 'pie' | 'area';\n  data: any[];\n  xKey: string;\n  yKeys: string[];\n  title: string;\n  colors: string[];\n}\n\ninterface Props {\n  config: ChartConfig;\n}\n\nexport function AICopilotChart({ config }: Props) {\n  const chartRef = useRef<HTMLDivElement>(null);\n  const [showCodeDialog, setShowCodeDialog] = useState(false);\n  const [copiedHtml, setCopiedHtml] = useState(false);\n  const [copiedReact, setCopiedReact] = useState(false);\n  const [copiedIframe, setCopiedIframe] = useState(false);\n\n  const handleExport = async () => {\n    if (!chartRef.current) {\n      console.error('Chart ref not found');\n      alert('Chart not ready for export. Please try again.');\n      return;\n    }\n\n    try {\n      const dataUrl = await toPng(chartRef.current, {\n        backgroundColor: '#121212',\n        pixelRatio: 2,\n        cacheBust: true,\n      });\n\n      const link = document.createElement('a');\n      link.download = `${config.title.replace(/[^a-z0-9]/gi, '_').toLowerCase()}.png`;\n      link.href = dataUrl;\n      link.click();\n    } catch (error) {\n      console.error('Export failed:', error);\n      alert('Failed to export chart. Please try again.');\n    }\n  };\n\n  const generateHtmlCode = () => {\n    const dataJson = JSON.stringify(config.data, null, 2);\n    const colorsJson = JSON.stringify(config.colors);\n    \n    return `<!DOCTYPE html>\n<html lang=\"en\">\n<head>\n  <meta charset=\"UTF-8\">\n  <meta name=\"viewport\" content=\"width=device-width, initial-scale=1.0\">\n  <title>${config.title}</title>\n  <script crossorigin src=\"https://unpkg.com/react@17/umd/react.production.min.js\"></script>\n  <script crossorigin src=\"https://unpkg.com/react-dom@17/umd/react-dom.production.min.js\"></script>\n  <script src=\"https://unpkg.com/recharts@2.5.0/dist/Recharts.js\"></script>\n  <script src=\"https://unpkg.com/@babel/standalone/babel.min.js\"></script>\n  <style>\n    body {\n      margin: 0;\n      padding: 20px;\n      background-color: #121212;\n      font-family: 'Mulish', sans-serif;\n      color: #f7f7f7;\n    }\n    #chart-container {\n      background-color: #121212;\n      padding: 20px;\n      border-radius: 8px;\n    }\n    .error {\n      color: #ff6b6b;\n      padding: 20px;\n      font-family: monospace;\n    }\n  </style>\n</head>\n<body>\n  <div id=\"root\"></div>\n  \n  <script>\n    // Error handling\n    window.onerror = function(msg, url, line, col, error) {\n      document.getElementById('root').innerHTML = '<div class=\"error\">Error loading chart: ' + msg + '</div>';\n      return false;\n    };\n    \n    // Check if dependencies loaded\n    if (typeof React === 'undefined' || typeof ReactDOM === 'undefined' || typeof Recharts === 'undefined') {\n      document.getElementById('root').innerHTML = '<div class=\"error\">Failed to load required libraries. Please check your internet connection.</div>';\n    }\n  </script>\n  \n  <script type=\"text/babel\">\n    const { ${config.type === 'bar' ? 'BarChart, Bar' : config.type === 'line' ? 'LineChart, Line' : config.type === 'area' ? 'AreaChart, Area' : 'PieChart, Pie, Cell'}, XAxis, YAxis, CartesianGrid, Tooltip, Legend, ResponsiveContainer } = Recharts;\n    \n    const data = ${dataJson};\n    const colors = ${colorsJson};\n    \n    function Chart() {\n      return (\n        <div id=\"chart-container\">\n          <h2 style={{ fontFamily: 'Mulish, sans-serif', color: '#f7f7f7', marginBottom: '20px' }}>\n            ${config.title}\n          </h2>\n          <ResponsiveContainer width=\"100%\" height={400}>\n            ${generateChartComponent()}\n          </ResponsiveContainer>\n        </div>\n      );\n    }\n    \n    ReactDOM.render(<Chart />, document.getElementById('root'));\n  </script>\n</body>\n</html>`;\n  };\n\n  const generateChartComponent = () => {\n    const textStyle = `{ fontFamily: 'Mulish, sans-serif', fontSize: 12, fill: '#f7f7f7' }`;\n    const tooltipStyle = `{ backgroundColor: '#121212', border: '1px solid #474747', color: '#f7f7f7', fontFamily: 'Mulish, sans-serif', fontSize: 12 }`;\n    \n    switch (config.type) {\n      case 'bar':\n        return `<BarChart data={data} margin={{ top: 20, right: 30, left: 20, bottom: 20 }}>\n              <CartesianGrid strokeDasharray=\"3 3\" stroke=\"#474747\" />\n              <XAxis dataKey=\"${config.xKey}\" stroke=\"#474747\" tick={${textStyle}} angle={-45} textAnchor=\"end\" height={60} />\n              <YAxis stroke=\"#474747\" tick={${textStyle}} />\n              <Tooltip contentStyle={${tooltipStyle}} />\n              <Legend wrapperStyle={{ fontFamily: 'Mulish, sans-serif', color: '#f7f7f7', fontSize: 12 }} />\n              ${config.yKeys.map((key, idx) => `<Bar dataKey=\"${key}\" fill={colors[${idx}]} />`).join('\\n              ')}\n            </BarChart>`;\n      case 'line':\n        return `<LineChart data={data} margin={{ top: 20, right: 30, left: 20, bottom: 20 }}>\n              <CartesianGrid strokeDasharray=\"3 3\" stroke=\"#474747\" />\n              <XAxis dataKey=\"${config.xKey}\" stroke=\"#474747\" tick={${textStyle}} angle={-45} textAnchor=\"end\" height={60} />\n              <YAxis stroke=\"#474747\" tick={${textStyle}} />\n              <Tooltip contentStyle={${tooltipStyle}} />\n              <Legend wrapperStyle={{ fontFamily: 'Mulish, sans-serif', color: '#f7f7f7', fontSize: 12 }} />\n              ${config.yKeys.map((key, idx) => `<Line type=\"monotone\" dataKey=\"${key}\" stroke={colors[${idx}]} strokeWidth={2} />`).join('\\n              ')}\n            </LineChart>`;\n      case 'area':\n        return `<AreaChart data={data} margin={{ top: 20, right: 30, left: 20, bottom: 20 }}>\n              <CartesianGrid strokeDasharray=\"3 3\" stroke=\"#474747\" />\n              <XAxis dataKey=\"${config.xKey}\" stroke=\"#474747\" tick={${textStyle}} angle={-45} textAnchor=\"end\" height={60} />\n              <YAxis stroke=\"#474747\" tick={${textStyle}} />\n              <Tooltip contentStyle={${tooltipStyle}} />\n              <Legend wrapperStyle={{ fontFamily: 'Mulish, sans-serif', color: '#f7f7f7', fontSize: 12 }} />\n              ${config.yKeys.map((key, idx) => `<Area type=\"monotone\" dataKey=\"${key}\" fill={colors[${idx}]} stroke={colors[${idx}]} fillOpacity={0.6} />`).join('\\n              ')}\n            </AreaChart>`;\n      case 'pie':\n        return `<PieChart>\n              <Pie data={data} dataKey=\"${config.yKeys[0]}\" nameKey=\"${config.xKey}\" cx=\"50%\" cy=\"50%\" outerRadius={120} label={{ fill: '#f7f7f7', fontSize: 12, fontFamily: 'Mulish, sans-serif' }}>\n                {data.map((entry, index) => <Cell key={'cell-' + index} fill={colors[index % colors.length]} />)}\n              </Pie>\n              <Tooltip contentStyle={${tooltipStyle}} />\n              <Legend wrapperStyle={{ fontFamily: 'Mulish, sans-serif', color: '#f7f7f7', fontSize: 12 }} />\n            </PieChart>`;\n    }\n  };\n\n  const generateReactCode = () => {\n    const dataJson = JSON.stringify(config.data, null, 2);\n    const colorsJson = JSON.stringify(config.colors);\n    \n    return `import { ${config.type === 'bar' ? 'BarChart, Bar' : config.type === 'line' ? 'LineChart, Line' : config.type === 'area' ? 'AreaChart, Area' : 'PieChart, Pie, Cell'}, XAxis, YAxis, CartesianGrid, Tooltip, Legend, ResponsiveContainer } from 'recharts';\n\nconst data = ${dataJson};\n\nconst colors = ${colorsJson};\n\nexport function Chart() {\n  const textStyle = { \n    fontFamily: 'Mulish, sans-serif', \n    fontSize: 12,\n    fill: '#f7f7f7'\n  };\n\n  return (\n    <div className=\"space-y-4\">\n      <h2 style={{ fontFamily: 'Mulish, sans-serif', color: '#f7f7f7' }}>\n        ${config.title}\n      </h2>\n      \n      <div className=\"rounded-lg p-4\" style={{ backgroundColor: '#121212' }}>\n        <ResponsiveContainer width=\"100%\" height={400}>\n          ${generateChartComponent()}\n        </ResponsiveContainer>\n      </div>\n    </div>\n  );\n}`;\n  };\n\n  const generateIframeCode = () => {\n    const htmlContent = generateHtmlCode();\n    \n    // UTF-8 safe base64 encoding for data URI\n    // Split into chunks to avoid call stack size limits\n    const utf8Bytes = new TextEncoder().encode(htmlContent);\n    let binaryString = '';\n    const chunkSize = 8192;\n    for (let i = 0; i < utf8Bytes.length; i += chunkSize) {\n      const chunk = utf8Bytes.slice(i, i + chunkSize);\n      binaryString += String.fromCharCode.apply(null, Array.from(chunk));\n    }\n    const base64Html = btoa(binaryString);\n    \n    // Escape title attribute\n    const escapedTitle = config.title\n      .replace(/&/g, '&amp;')\n      .replace(/\"/g, '&quot;')\n      .replace(/</g, '&lt;')\n      .replace(/>/g, '&gt;');\n    \n    return `<iframe \n  src=\"data:text/html;base64,${base64Html}\"\n  style=\"width: 100%; height: 500px; border: none;\"\n  title=\"${escapedTitle}\"\n></iframe>`;\n  };\n\n  const copyToClipboard = async (text: string, type: 'html' | 'react' | 'iframe') => {\n    try {\n      await navigator.clipboard.writeText(text);\n      if (type === 'html') {\n        setCopiedHtml(true);\n        setTimeout(() => setCopiedHtml(false), 2000);\n      } else if (type === 'react') {\n        setCopiedReact(true);\n        setTimeout(() => setCopiedReact(false), 2000);\n      } else {\n        setCopiedIframe(true);\n        setTimeout(() => setCopiedIframe(false), 2000);\n      }\n    } catch (error) {\n      console.error('Copy failed:', error);\n      alert('Failed to copy code. Please try again.');\n    }\n  };\n\n  const renderChart = () => {\n    const commonProps = {\n      data: config.data,\n      margin: { top: 20, right: 30, left: 20, bottom: 20 }\n    };\n\n    const textStyle = { \n      fontFamily: 'Mulish, sans-serif', \n      fontSize: 12,\n      fill: '#f7f7f7'\n    };\n\n    switch (config.type) {\n      case 'bar':\n        return (\n          <ResponsiveContainer width=\"100%\" height={400}>\n            <BarChart {...commonProps}>\n              <CartesianGrid strokeDasharray=\"3 3\" stroke=\"#474747\" />\n              <XAxis \n                dataKey={config.xKey} \n                stroke=\"#474747\" \n                tick={textStyle}\n                angle={-45}\n                textAnchor=\"end\"\n                height={60}\n              />\n              <YAxis \n                stroke=\"#474747\" \n                tick={textStyle}\n              />\n              <Tooltip \n                contentStyle={{ \n                  backgroundColor: '#121212', \n                  border: '1px solid #474747', \n                  color: '#f7f7f7',\n                  fontFamily: 'Mulish, sans-serif',\n                  fontSize: 12\n                }}\n                labelStyle={{ fontFamily: 'Mulish, sans-serif', fontSize: 12 }}\n              />\n              <Legend \n                wrapperStyle={{ fontFamily: 'Mulish, sans-serif', color: '#f7f7f7', fontSize: 12 }}\n                iconSize={12}\n              />\n              {config.yKeys.map((key, index) => (\n                <Bar \n                  key={key} \n                  dataKey={key} \n                  fill={config.colors[index % config.colors.length]} \n                />\n              ))}\n            </BarChart>\n          </ResponsiveContainer>\n        );\n\n      case 'line':\n        return (\n          <ResponsiveContainer width=\"100%\" height={400}>\n            <LineChart {...commonProps}>\n              <CartesianGrid strokeDasharray=\"3 3\" stroke=\"#474747\" />\n              <XAxis \n                dataKey={config.xKey} \n                stroke=\"#474747\" \n                tick={textStyle}\n                angle={-45}\n                textAnchor=\"end\"\n                height={60}\n              />\n              <YAxis \n                stroke=\"#474747\" \n                tick={textStyle}\n              />\n              <Tooltip \n                contentStyle={{ \n                  backgroundColor: '#121212', \n                  border: '1px solid #474747', \n                  color: '#f7f7f7',\n                  fontFamily: 'Mulish, sans-serif',\n                  fontSize: 12\n                }}\n                labelStyle={{ fontFamily: 'Mulish, sans-serif', fontSize: 12 }}\n              />\n              <Legend \n                wrapperStyle={{ fontFamily: 'Mulish, sans-serif', color: '#f7f7f7', fontSize: 12 }}\n                iconSize={12}\n              />\n              {config.yKeys.map((key, index) => (\n                <Line \n                  key={key} \n                  type=\"monotone\" \n                  dataKey={key} \n                  stroke={config.colors[index % config.colors.length]} \n                  strokeWidth={2}\n                />\n              ))}\n            </LineChart>\n          </ResponsiveContainer>\n        );\n\n      case 'area':\n        return (\n          <ResponsiveContainer width=\"100%\" height={400}>\n            <AreaChart {...commonProps}>\n              <CartesianGrid strokeDasharray=\"3 3\" stroke=\"#474747\" />\n              <XAxis \n                dataKey={config.xKey} \n                stroke=\"#474747\" \n                tick={textStyle}\n                angle={-45}\n                textAnchor=\"end\"\n                height={60}\n              />\n              <YAxis \n                stroke=\"#474747\" \n                tick={textStyle}\n              />\n              <Tooltip \n                contentStyle={{ \n                  backgroundColor: '#121212', \n                  border: '1px solid #474747', \n                  color: '#f7f7f7',\n                  fontFamily: 'Mulish, sans-serif',\n                  fontSize: 12\n                }}\n                labelStyle={{ fontFamily: 'Mulish, sans-serif', fontSize: 12 }}\n              />\n              <Legend \n                wrapperStyle={{ fontFamily: 'Mulish, sans-serif', color: '#f7f7f7', fontSize: 12 }}\n                iconSize={12}\n              />\n              {config.yKeys.map((key, index) => (\n                <Area \n                  key={key} \n                  type=\"monotone\" \n                  dataKey={key} \n                  fill={config.colors[index % config.colors.length]} \n                  stroke={config.colors[index % config.colors.length]}\n                  fillOpacity={0.6}\n                />\n              ))}\n            </AreaChart>\n          </ResponsiveContainer>\n        );\n\n      case 'pie':\n        return (\n          <ResponsiveContainer width=\"100%\" height={400}>\n            <PieChart>\n              <Pie\n                data={config.data}\n                dataKey={config.yKeys[0]}\n                nameKey={config.xKey}\n                cx=\"50%\"\n                cy=\"50%\"\n                outerRadius={120}\n                label={{\n                  fill: '#f7f7f7',\n                  fontSize: 12,\n                  fontFamily: 'Mulish, sans-serif'\n                }}\n              >\n                {config.data.map((entry, index) => (\n                  <Cell key={`cell-${index}`} fill={config.colors[index % config.colors.length]} />\n                ))}\n              </Pie>\n              <Tooltip \n                contentStyle={{ \n                  backgroundColor: '#121212', \n                  border: '1px solid #474747', \n                  color: '#f7f7f7',\n                  fontFamily: 'Mulish, sans-serif',\n                  fontSize: 12\n                }}\n                labelStyle={{ fontFamily: 'Mulish, sans-serif', fontSize: 12 }}\n              />\n              <Legend \n                wrapperStyle={{ fontFamily: 'Mulish, sans-serif', color: '#f7f7f7', fontSize: 12 }}\n                iconSize={12}\n              />\n            </PieChart>\n          </ResponsiveContainer>\n        );\n    }\n  };\n\n  return (\n    <>\n      <div className=\"space-y-4\">\n        <div className=\"flex items-center justify-between\">\n          <h3 \n            className=\"text-lg font-semibold\"\n            style={{ fontFamily: 'Mulish, sans-serif', color: '#F7F7F7' }}\n          >\n            {config.title}\n          </h3>\n          <div className=\"flex gap-2\">\n            <Button\n              size=\"sm\"\n              onClick={() => setShowCodeDialog(true)}\n              variant=\"outline\"\n              data-testid=\"button-export-code\"\n            >\n              <Code2 className=\"h-4 w-4 mr-2\" />\n              Export Code\n            </Button>\n            <Button\n              size=\"sm\"\n              onClick={handleExport}\n              variant=\"outline\"\n              data-testid=\"button-export-png\"\n            >\n              <Download className=\"h-4 w-4 mr-2\" />\n              Export PNG\n            </Button>\n          </div>\n        </div>\n\n        <div ref={chartRef} className=\"rounded-lg p-4\" style={{ backgroundColor: '#121212' }}>\n          {renderChart()}\n        </div>\n      </div>\n\n      <Dialog open={showCodeDialog} onOpenChange={setShowCodeDialog}>\n        <DialogContent className=\"max-w-4xl max-h-[80vh] overflow-hidden flex flex-col\">\n          <DialogHeader>\n            <DialogTitle>Export Code</DialogTitle>\n            <DialogDescription>\n              Copy the code below to embed this chart in your own website or CodePen.\n            </DialogDescription>\n          </DialogHeader>\n          \n          <Tabs defaultValue=\"iframe\" className=\"flex-1 overflow-hidden flex flex-col\">\n            <TabsList className=\"grid w-full grid-cols-3\">\n              <TabsTrigger value=\"iframe\">iframe Embed</TabsTrigger>\n              <TabsTrigger value=\"html\">HTML File</TabsTrigger>\n              <TabsTrigger value=\"react\">React Component</TabsTrigger>\n            </TabsList>\n            \n            <TabsContent value=\"iframe\" className=\"flex-1 overflow-hidden flex flex-col mt-4\">\n              <div className=\"flex justify-between items-center mb-2\">\n                <p className=\"text-sm text-muted-foreground\">\n                  Paste this iframe code directly into any website. Note: Some platforms may block data URIs due to CSP restrictions. If the chart doesn't display, use the HTML File option instead.\n                </p>\n                <Button\n                  size=\"sm\"\n                  onClick={() => copyToClipboard(generateIframeCode(), 'iframe')}\n                  variant=\"outline\"\n                  data-testid=\"button-copy-iframe\"\n                >\n                  {copiedIframe ? (\n                    <>\n                      <Check className=\"h-4 w-4 mr-2\" />\n                      Copied!\n                    </>\n                  ) : (\n                    <>\n                      <Copy className=\"h-4 w-4 mr-2\" />\n                      Copy Code\n                    </>\n                  )}\n                </Button>\n              </div>\n              <pre className=\"flex-1 overflow-auto rounded-lg border bg-[#1e1e1e] p-4 text-xs\">\n                <code>{generateIframeCode()}</code>\n              </pre>\n            </TabsContent>\n            \n            <TabsContent value=\"html\" className=\"flex-1 overflow-hidden flex flex-col mt-4\">\n              <div className=\"flex justify-between items-center mb-2\">\n                <p className=\"text-sm text-muted-foreground\">\n                  Self-contained HTML file with embedded chart\n                </p>\n                <Button\n                  size=\"sm\"\n                  onClick={() => copyToClipboard(generateHtmlCode(), 'html')}\n                  variant=\"outline\"\n                  data-testid=\"button-copy-html\"\n                >\n                  {copiedHtml ? (\n                    <>\n                      <Check className=\"h-4 w-4 mr-2\" />\n                      Copied!\n                    </>\n                  ) : (\n                    <>\n                      <Copy className=\"h-4 w-4 mr-2\" />\n                      Copy Code\n                    </>\n                  )}\n                </Button>\n              </div>\n              <pre className=\"flex-1 overflow-auto rounded-lg border bg-[#1e1e1e] p-4 text-xs\">\n                <code>{generateHtmlCode()}</code>\n              </pre>\n            </TabsContent>\n            \n            <TabsContent value=\"react\" className=\"flex-1 overflow-hidden flex flex-col mt-4\">\n              <div className=\"flex justify-between items-center mb-2\">\n                <p className=\"text-sm text-muted-foreground\">\n                  React component (requires recharts package)\n                </p>\n                <Button\n                  size=\"sm\"\n                  onClick={() => copyToClipboard(generateReactCode(), 'react')}\n                  variant=\"outline\"\n                  data-testid=\"button-copy-react\"\n                >\n                  {copiedReact ? (\n                    <>\n                      <Check className=\"h-4 w-4 mr-2\" />\n                      Copied!\n                    </>\n                  ) : (\n                    <>\n                      <Copy className=\"h-4 w-4 mr-2\" />\n                      Copy Code\n                    </>\n                  )}\n                </Button>\n              </div>\n              <pre className=\"flex-1 overflow-auto rounded-lg border bg-[#1e1e1e] p-4 text-xs\">\n                <code>{generateReactCode()}</code>\n              </pre>\n            </TabsContent>\n          </Tabs>\n        </DialogContent>\n      </Dialog>\n    </>\n  );\n}\n","path":null,"size_bytes":21469,"size_tokens":null},"client/src/pages/comparison-chart.tsx":{"content":"import { useState, useRef, useCallback, useEffect } from \"react\";\nimport { Link, useLocation } from \"wouter\";\nimport { Button } from \"@/components/ui/button\";\nimport { Card } from \"@/components/ui/card\";\nimport { LogOut, BookOpen, ChevronDown, Minus, Type, Ruler, RotateCcw, Download, Code, X, Trash2, Plus } from \"lucide-react\";\nimport { ComparisonChart as ComparisonChartComponent } from \"@/components/dashboard/comparison-chart\";\nimport { useAuth } from \"@/contexts/AuthContext\";\nimport logoImage from \"@assets/IPO Intelligence@2x_1758060026530.png\";\nimport { format } from 'date-fns';\nimport { useQuery, useMutation } from \"@tanstack/react-query\";\nimport { apiRequest, queryClient } from \"@/lib/queryClient\";\nimport { useToast } from \"@/hooks/use-toast\";\nimport type { CompareChartHistory } from \"@shared/schema\";\nimport {\n  Select,\n  SelectContent,\n  SelectItem,\n  SelectTrigger,\n  SelectValue,\n} from \"@/components/ui/select\";\nimport {\n  DropdownMenu,\n  DropdownMenuContent,\n  DropdownMenuItem,\n  DropdownMenuTrigger,\n} from \"@/components/ui/dropdown-menu\";\nimport { Switch } from \"@/components/ui/switch\";\nimport {\n  Tooltip,\n  TooltipContent,\n  TooltipProvider,\n  TooltipTrigger,\n} from \"@/components/ui/tooltip\";\nimport { Calendar } from \"@/components/ui/calendar\";\nimport { saveAs } from 'file-saver';\nimport * as htmlToImage from 'html-to-image';\nimport jsPDF from 'jspdf';\n\ninterface Annotation {\n  id: string;\n  type: 'text' | 'percentage' | 'horizontal' | 'note';\n  x: number;\n  y: number;\n  timestamp: number;\n  price: number;\n  text?: string;\n  time: string;\n  horizontalOffset?: number;\n  verticalOffset?: number;\n  startTimestamp?: number;\n  startPrice?: number;\n  startTime?: string;\n  endTimestamp?: number;\n  endPrice?: number;\n  endTime?: string;\n  percentage?: number;\n}\n\ninterface TickerData {\n  symbol: string;\n  color: string;\n  visible: boolean;\n}\n\nconst timeframes = [\n  { label: '1D', value: '1D' },\n  { label: '5D', value: '5D' },\n  { label: '2W', value: '2W' },\n  { label: '1M', value: '1M' },\n  { label: '3M', value: '3M' },\n  { label: '6M', value: '6M' },\n  { label: '1Y', value: '1Y' },\n  { label: '3Y', value: '3Y' },\n  { label: 'Custom', value: 'Custom' },\n];\n\nconst timeIntervals = [\n  { label: '15 min', value: '15' },\n  { label: '1 hour', value: '60' },\n  { label: '3 hour', value: '180' },\n  { label: '6 hour', value: '360' },\n  { label: 'Daily', value: 'D' },\n  { label: 'Weekly', value: 'W' },\n  { label: 'Monthly', value: 'M' },\n];\n\nfunction LogoutButton() {\n  const { logout } = useAuth();\n  const [, setLocation] = useLocation();\n\n  const handleLogout = () => {\n    logout();\n    setLocation('/login');\n  };\n\n  return (\n    <button\n      onClick={handleLogout}\n      className=\"flex items-center gap-2 hover:opacity-80 transition-opacity\"\n      data-testid=\"button-logout\"\n      style={{ fontFamily: 'var(--font-sans)', fontSize: '16px', color: '#f7f7f7' }}\n    >\n      <LogOut className=\"h-5 w-5 text-[#5AF5FA]\" />\n      <span>Sign Out</span>\n    </button>\n  );\n}\n\nfunction generateSessionId(): string {\n  return `compare-${Date.now()}-${Math.random().toString(36).substr(2, 9)}`;\n}\n\nexport default function ComparisonChart() {\n  const [, setLocation] = useLocation();\n  const [timeframe, setTimeframe] = useState(\"2W\");\n  const [chartType, setChartType] = useState<'line' | 'mountain'>('line');\n  const [selectedInterval, setSelectedInterval] = useState('D');\n  const [showHoverTooltip, setShowHoverTooltip] = useState(true);\n  const [annotations, setAnnotations] = useState<Annotation[]>([]);\n  const [annotationMode, setAnnotationMode] = useState<'text' | 'percentage' | 'horizontal' | 'note' | undefined>(undefined);\n  const [pendingPercentageStart, setPendingPercentageStart] = useState<{ timestamp: number; price: number; time: string } | null>(null);\n  const [startDate, setStartDate] = useState<Date | undefined>(undefined);\n  const [endDate, setEndDate] = useState<Date | undefined>(undefined);\n  const [showDatePicker, setShowDatePicker] = useState(false);\n  const [singleTradingDay, setSingleTradingDay] = useState(false);\n  const [startCalendarMonth, setStartCalendarMonth] = useState<Date>(new Date());\n  const [endCalendarMonth, setEndCalendarMonth] = useState<Date>(new Date());\n  const [chartSessionId, setChartSessionId] = useState(() => generateSessionId());\n  const [tickers, setTickers] = useState<TickerData[]>([]);\n  const [chartKey, setChartKey] = useState(0);\n  \n  const [confirmDeleteId, setConfirmDeleteId] = useState<number | null>(null);\n  const [confirmDeleteAll, setConfirmDeleteAll] = useState(false);\n  const [deletingId, setDeletingId] = useState<number | null>(null);\n  const confirmTimeoutRef = useRef<NodeJS.Timeout | null>(null);\n  const isInitialMountRef = useRef(true);\n  const lastSavedStateRef = useRef<string | null>(null);\n  \n  const comparisonRef = useRef<HTMLDivElement>(null);\n  const comparisonZoomInRef = useRef<(() => void) | null>(null);\n  const comparisonZoomOutRef = useRef<(() => void) | null>(null);\n  const comparisonFitToDataRef = useRef<(() => void) | null>(null);\n\n  const { toast } = useToast();\n\n  const handleChartTypeChange = (value: string) => {\n    setLocation(value);\n  };\n\n  const clearAll = useCallback(() => {\n    setAnnotations([]);\n    setAnnotationMode(undefined);\n    setPendingPercentageStart(null);\n  }, []);\n\n  const validIntervals = (() => {\n    const tf = timeframe;\n    if (tf === '1D') return ['15', '60', '180', '360'];\n    if (tf === '5D') return ['15', '60', '180', '360', 'D'];\n    if (tf === '2W') return ['60', '180', '360', 'D'];\n    if (tf === '1M') return ['D'];\n    if (tf === '3M') return ['D', 'W'];\n    if (tf === '6M' || tf === '1Y') return ['D', 'W', 'M'];\n    if (tf === '3Y') return ['W', 'M'];\n    if (tf === 'Custom') {\n      if (startDate && endDate) {\n        const days = Math.ceil((endDate.getTime() - startDate.getTime()) / (1000 * 60 * 60 * 24));\n        if (days <= 1) return ['15', '60', '180', '360'];\n        if (days <= 7) return ['15', '60', '180', '360', 'D'];\n        if (days <= 14) return ['60', '180', '360', 'D'];\n        if (days <= 30) return ['D'];\n        if (days <= 90) return ['D', 'W'];\n        if (days <= 365) return ['D', 'W', 'M'];\n        return ['W', 'M'];\n      }\n      return ['D'];\n    }\n    return ['D'];\n  })();\n\n  const { data: compareChartHistory = [] } = useQuery<CompareChartHistory[]>({\n    queryKey: ['/api/compare-chart-history'],\n    queryFn: async () => {\n      const response = await fetch('/api/compare-chart-history', {\n        headers: {\n          'Authorization': `Bearer ${localStorage.getItem('authToken')}`\n        }\n      });\n      if (!response.ok) throw new Error('Failed to fetch compare chart history');\n      return await response.json();\n    },\n  });\n\n  const saveCompareChartHistoryMutation = useMutation({\n    mutationFn: async ({ \n      sessionId, \n      timeframe, \n      customStartDate, \n      customEndDate, \n      tickers,\n      annotations \n    }: { \n      sessionId: string;\n      timeframe: string;\n      customStartDate?: string;\n      customEndDate?: string;\n      tickers: TickerData[];\n      annotations: Annotation[] \n    }) => {\n      await apiRequest('POST', '/api/compare-chart-history', { \n        sessionId,\n        timeframe,\n        customStartDate,\n        customEndDate,\n        tickers,\n        annotations \n      });\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: ['/api/compare-chart-history'] });\n    },\n    onError: (error) => {\n      console.error('Failed to save compare chart history:', error);\n    },\n  });\n\n  const deleteCompareChartHistoryMutation = useMutation({\n    mutationFn: async (id: number) => {\n      await apiRequest('DELETE', `/api/compare-chart-history/${id}`, {});\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: ['/api/compare-chart-history'] });\n      toast({\n        title: \"Chart Deleted\",\n        description: \"Compare chart history entry removed successfully\",\n      });\n    },\n    onError: (error) => {\n      toast({\n        title: \"Delete Failed\",\n        description: \"Failed to delete compare chart history entry\",\n        variant: \"destructive\",\n      });\n      console.error('Failed to delete compare chart history:', error);\n    },\n  });\n\n  const deleteAllCompareChartHistoryMutation = useMutation({\n    mutationFn: async () => {\n      await apiRequest('DELETE', '/api/compare-chart-history', {});\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: ['/api/compare-chart-history'] });\n      setConfirmDeleteAll(false);\n      toast({\n        title: \"All Charts Deleted\",\n        description: \"All compare chart history entries have been removed\",\n      });\n    },\n    onError: (error) => {\n      toast({\n        title: \"Delete Failed\",\n        description: \"Failed to delete compare chart history\",\n        variant: \"destructive\",\n      });\n      console.error('Failed to delete all compare chart history:', error);\n    },\n  });\n\n  const handleDeleteClick = (id: number) => {\n    if (confirmDeleteId === id) {\n      setDeletingId(id);\n      setConfirmDeleteId(null);\n      if (confirmTimeoutRef.current) {\n        clearTimeout(confirmTimeoutRef.current);\n      }\n      \n      setTimeout(() => {\n        deleteCompareChartHistoryMutation.mutate(id);\n        setDeletingId(null);\n      }, 300);\n    } else {\n      setConfirmDeleteId(id);\n      setConfirmDeleteAll(false);\n      \n      if (confirmTimeoutRef.current) {\n        clearTimeout(confirmTimeoutRef.current);\n      }\n      confirmTimeoutRef.current = setTimeout(() => {\n        setConfirmDeleteId(null);\n      }, 4000);\n    }\n  };\n\n  const handleDeleteAllClick = () => {\n    if (confirmDeleteAll) {\n      deleteAllCompareChartHistoryMutation.mutate();\n      setConfirmDeleteAll(false);\n      if (confirmTimeoutRef.current) {\n        clearTimeout(confirmTimeoutRef.current);\n      }\n    } else {\n      setConfirmDeleteAll(true);\n      setConfirmDeleteId(null);\n      \n      if (confirmTimeoutRef.current) {\n        clearTimeout(confirmTimeoutRef.current);\n      }\n      confirmTimeoutRef.current = setTimeout(() => {\n        setConfirmDeleteAll(false);\n      }, 4000);\n    }\n  };\n\n  useEffect(() => {\n    return () => {\n      if (confirmTimeoutRef.current) {\n        clearTimeout(confirmTimeoutRef.current);\n      }\n    };\n  }, []);\n\n  useEffect(() => {\n    if (isInitialMountRef.current) {\n      isInitialMountRef.current = false;\n      const initialState = JSON.stringify({\n        timeframe,\n        customStartDate: startDate?.toISOString(),\n        customEndDate: endDate?.toISOString(),\n        tickers,\n        annotations\n      });\n      lastSavedStateRef.current = initialState;\n      return;\n    }\n\n    const hasAnnotations = annotations.length > 0;\n    const hasTickers = tickers.length > 0;\n    const hasCustomDateRange = timeframe === 'Custom' && startDate && endDate;\n    \n    if (!hasAnnotations && !hasTickers && !hasCustomDateRange) {\n      lastSavedStateRef.current = null;\n      return;\n    }\n\n    const currentState = JSON.stringify({\n      timeframe,\n      customStartDate: startDate?.toISOString(),\n      customEndDate: endDate?.toISOString(),\n      tickers,\n      annotations\n    });\n    \n    if (currentState === lastSavedStateRef.current) {\n      return;\n    }\n\n    const timeoutId = setTimeout(() => {\n      saveCompareChartHistoryMutation.mutate({ \n        sessionId: chartSessionId,\n        timeframe,\n        customStartDate: timeframe === 'Custom' && startDate ? startDate.toISOString() : undefined,\n        customEndDate: timeframe === 'Custom' && endDate ? endDate.toISOString() : undefined,\n        tickers,\n        annotations \n      });\n      lastSavedStateRef.current = currentState;\n    }, 2000);\n\n    return () => {\n      clearTimeout(timeoutId);\n    };\n  }, [annotations, timeframe, startDate, endDate, tickers, chartSessionId, saveCompareChartHistoryMutation]);\n\n  const restoreFromHistory = (entry: CompareChartHistory) => {\n    setTimeframe(entry.timeframe);\n    \n    if (entry.timeframe === 'Custom' && entry.customStartDate && entry.customEndDate) {\n      setStartDate(new Date(entry.customStartDate));\n      setEndDate(new Date(entry.customEndDate));\n    } else {\n      setStartDate(undefined);\n      setEndDate(undefined);\n    }\n    \n    setTickers(entry.tickers || []);\n    setAnnotations(entry.annotations as Annotation[] || []);\n    \n    toast({\n      title: \"Chart Restored\",\n      description: `Loaded compare chart state from ${format(new Date(entry.savedAt), 'MMM dd, yyyy HH:mm')}`,\n    });\n  };\n\n  const exportAsPNG = useCallback(async () => {\n    if (!comparisonRef.current) return;\n    try {\n      const dataUrl = await htmlToImage.toPng(comparisonRef.current, {\n        backgroundColor: '#121212',\n        quality: 1.0,\n      });\n      saveAs(dataUrl, `comparison-chart-${new Date().toISOString().split('T')[0]}.png`);\n    } catch (error) {\n      console.error('Error exporting as PNG:', error);\n    }\n  }, []);\n\n  const exportAsPDF = useCallback(async () => {\n    if (!comparisonRef.current) return;\n    try {\n      const dataUrl = await htmlToImage.toPng(comparisonRef.current, {\n        backgroundColor: '#121212',\n        quality: 1.0,\n      });\n      const img = new Image();\n      img.src = dataUrl;\n      await new Promise((resolve) => { img.onload = resolve; });\n      const pdf = new jsPDF({\n        orientation: img.width > img.height ? 'landscape' : 'portrait',\n        unit: 'px',\n        format: [img.width, img.height],\n      });\n      pdf.addImage(dataUrl, 'PNG', 0, 0, img.width, img.height);\n      pdf.save(`comparison-chart-${new Date().toISOString().split('T')[0]}.pdf`);\n    } catch (error) {\n      console.error('Error exporting as PDF:', error);\n    }\n  }, []);\n\n  const exportAsSVG = useCallback(async () => {\n    if (!comparisonRef.current) return;\n    try {\n      const dataUrl = await htmlToImage.toSvg(comparisonRef.current, {\n        backgroundColor: '#121212',\n      });\n      const link = document.createElement('a');\n      link.download = `comparison-chart-${new Date().toISOString().split('T')[0]}.svg`;\n      link.href = dataUrl;\n      link.click();\n    } catch (error) {\n      console.error('Error exporting as SVG:', error);\n    }\n  }, []);\n\n  const handleTickersChange = useCallback((newTickers: TickerData[]) => {\n    setTickers(newTickers);\n  }, []);\n\n  const handleNewChart = useCallback(() => {\n    const hasContent = tickers.length > 0 || annotations.length > 0;\n    \n    if (hasContent) {\n      saveCompareChartHistoryMutation.mutate({\n        sessionId: chartSessionId,\n        timeframe,\n        customStartDate: timeframe === 'Custom' && startDate ? startDate.toISOString() : undefined,\n        customEndDate: timeframe === 'Custom' && endDate ? endDate.toISOString() : undefined,\n        tickers,\n        annotations\n      });\n      \n      toast({\n        title: \"Previous chart saved\",\n        description: \"Your chart has been saved in the history below\",\n      });\n    }\n    \n    setChartSessionId(generateSessionId());\n    setTickers([]);\n    setAnnotations([]);\n    setAnnotationMode(undefined);\n    setPendingPercentageStart(null);\n    setTimeframe('2W');\n    setStartDate(undefined);\n    setEndDate(undefined);\n    setShowDatePicker(false);\n    setSingleTradingDay(false);\n    setChartKey(prev => prev + 1);\n    lastSavedStateRef.current = null;\n    isInitialMountRef.current = true;\n  }, [tickers, annotations, chartSessionId, timeframe, startDate, endDate, saveCompareChartHistoryMutation, toast]);\n\n  return (\n    <div className=\"min-h-screen bg-background text-foreground\">\n      {/* Navigation Header */}\n      <header className=\"border-b border-border sticky top-0 z-50 bg-background/95 backdrop-blur supports-[backdrop-filter]:bg-background/60\">\n        <div className=\"container mx-auto px-4 py-4\">\n          <div className=\"flex items-center justify-between\">\n            {/* Logo */}\n            <Link href=\"/\">\n              <img src={logoImage} alt=\"Logo\" className=\"w-[240px] h-auto max-[600px]:w-[180px] hover:opacity-80 transition-opacity cursor-pointer\" data-testid=\"link-home\" />\n            </Link>\n\n            {/* Navigation Items */}\n            <nav className=\"flex items-center gap-6\">\n              {/* Chart Type Dropdown */}\n              <Select value=\"/comparison-chart\" onValueChange={handleChartTypeChange}>\n                <SelectTrigger \n                  className=\"w-[200px] bg-card border-border\"\n                  data-testid=\"select-chart-type\"\n                  style={{ fontFamily: 'var(--font-sans)' }}\n                >\n                  <SelectValue placeholder=\"Chart Type\" />\n                </SelectTrigger>\n                <SelectContent style={{ backgroundColor: '#3A3A3A' }}>\n                  <SelectItem value=\"/price-chart\">Price Chart</SelectItem>\n                  <SelectItem value=\"/comparison-chart\">Comparison Chart</SelectItem>\n                  <SelectItem value=\"/ai-copilot\">AI Co-Pilot</SelectItem>\n                </SelectContent>\n              </Select>\n\n              {/* Walkthrough Link */}\n              <Link href=\"/walkthrough\">\n                <span \n                  className=\"flex items-center gap-2 hover:opacity-80 transition-opacity cursor-pointer\"\n                  data-testid=\"link-walkthrough\"\n                  style={{ fontFamily: 'var(--font-sans)', fontSize: '16px', color: '#f7f7f7' }}\n                >\n                  <BookOpen className=\"h-5 w-5 text-[#5AF5FA]\" />\n                  <span>Walkthrough</span>\n                </span>\n              </Link>\n\n              {/* Logout Button */}\n              <LogoutButton />\n            </nav>\n          </div>\n        </div>\n      </header>\n\n      {/* Main Content */}\n      <main className=\"container mx-auto px-4 py-6\">\n        {/* Page Title with + New Chart button */}\n        <div className=\"mb-6\">\n          <div className=\"flex items-center justify-between\">\n            <h1 \n              className=\"text-4xl font-light\"\n              style={{ fontFamily: 'Space Grotesk, sans-serif', color: '#f7f7f7' }}\n            >\n              Comparison Chart\n            </h1>\n            <Button\n              onClick={handleNewChart}\n              className=\"bg-[#5AF5FA] text-[#121212] hover:bg-[#5AF5FA]/90 font-medium\"\n              data-testid=\"button-new-chart\"\n            >\n              <Plus className=\"w-4 h-4 mr-2\" />\n              New Chart\n            </Button>\n          </div>\n          <p \n            className=\"text-muted-foreground mt-2\"\n            style={{ fontFamily: 'Mulish, sans-serif' }}\n          >\n            Compare multiple tickers side-by-side to uncover performance trends and correlations\n          </p>\n        </div>\n\n        {/* Chart Controls Row 1: Timeframe buttons + Chart Type + Time Interval */}\n        <div className=\"flex gap-4 items-center flex-wrap max-[900px]:gap-2 w-full mb-4\">\n          {/* Mobile View: Timeframe Dropdown */}\n          <div className=\"min-[760px]:hidden w-full flex gap-2 items-center\">\n            <Select \n              value={timeframe} \n              onValueChange={(value) => {\n                setTimeframe(value);\n                if (value !== 'Custom') {\n                  setStartDate(undefined);\n                  setEndDate(undefined);\n                  setShowDatePicker(false);\n                } else {\n                  setShowDatePicker(true);\n                }\n              }}\n            >\n              <SelectTrigger className=\"flex-1 h-9 text-sm\" data-testid=\"select-timeframe-mobile\">\n                <SelectValue placeholder=\"Select timeframe\" />\n              </SelectTrigger>\n              <SelectContent style={{ backgroundColor: '#1a1a1a' }}>\n                {timeframes.map((tf) => (\n                  <SelectItem key={tf.value} value={tf.value} className=\"cursor-pointer\">\n                    {tf.label}\n                  </SelectItem>\n                ))}\n              </SelectContent>\n            </Select>\n          </div>\n          \n          {/* Desktop Buttons */}\n          <div className=\"hidden min-[760px]:flex gap-1 items-center flex-wrap\">\n            {timeframes.map((tf) => (\n              <Button\n                key={tf.value}\n                variant={timeframe === tf.value ? \"default\" : \"outline\"}\n                size=\"sm\"\n                onClick={() => {\n                  setTimeframe(tf.value);\n                  if (tf.value !== 'Custom') {\n                    setStartDate(undefined);\n                    setEndDate(undefined);\n                    setShowDatePicker(false);\n                  } else {\n                    setShowDatePicker(true);\n                  }\n                }}\n                className={`h-8 px-3 text-xs ${\n                  timeframe === tf.value \n                    ? 'bg-[#5AF5FA] text-black hover:bg-[#5AF5FA]/90' \n                    : 'hover:bg-muted'\n                }`}\n              >\n                {tf.label}\n              </Button>\n            ))}\n          </div>\n\n          {/* Chart Type selector (Line/Mountain only for comparison) */}\n          <DropdownMenu>\n            <DropdownMenuTrigger asChild>\n              <Button\n                size=\"sm\"\n                variant=\"outline\"\n                className=\"h-8 px-3 text-xs\"\n                data-testid=\"button-chart-type-dropdown\"\n              >\n                {chartType === 'line' && 'Line'}\n                {chartType === 'mountain' && 'Mountain'}\n                <ChevronDown className=\"w-3 h-3 ml-1\" style={{ color: '#5AF5FA' }} />\n              </Button>\n            </DropdownMenuTrigger>\n            <DropdownMenuContent align=\"start\">\n              <DropdownMenuItem\n                onClick={() => setChartType('line')}\n                className=\"cursor-pointer\"\n                data-testid=\"menu-chart-line\"\n              >\n                Line\n              </DropdownMenuItem>\n              <DropdownMenuItem\n                onClick={() => setChartType('mountain')}\n                className=\"cursor-pointer\"\n                data-testid=\"menu-chart-mountain\"\n              >\n                Mountain\n              </DropdownMenuItem>\n            </DropdownMenuContent>\n          </DropdownMenu>\n\n          {/* Time Interval selector */}\n          {validIntervals.length > 0 ? (\n            <DropdownMenu>\n              <DropdownMenuTrigger asChild>\n                <Button\n                  size=\"sm\"\n                  variant=\"outline\"\n                  className=\"h-8 px-3 text-xs\"\n                  data-testid=\"button-interval-dropdown\"\n                >\n                  {timeIntervals.find(i => i.value === selectedInterval)?.label || 'Daily'}\n                  <ChevronDown className=\"w-3 h-3 ml-1\" style={{ color: '#5AF5FA' }} />\n                </Button>\n              </DropdownMenuTrigger>\n              <DropdownMenuContent align=\"start\">\n                {timeIntervals\n                  .filter(interval => validIntervals.includes(interval.value))\n                  .map(interval => (\n                    <DropdownMenuItem\n                      key={interval.value}\n                      onClick={() => setSelectedInterval(interval.value)}\n                      className={`cursor-pointer ${selectedInterval === interval.value ? 'bg-[#5AF5FA]/20' : ''}`}\n                      data-testid={`menu-interval-${interval.value}`}\n                    >\n                      {interval.label}\n                    </DropdownMenuItem>\n                  ))\n                }\n              </DropdownMenuContent>\n            </DropdownMenu>\n          ) : (\n            <TooltipProvider>\n              <Tooltip>\n                <TooltipTrigger asChild>\n                  <Button\n                    size=\"sm\"\n                    variant=\"outline\"\n                    className=\"h-8 px-3 text-xs opacity-50 cursor-not-allowed\"\n                    disabled\n                    data-testid=\"button-interval-disabled\"\n                  >\n                    Daily\n                    <ChevronDown className=\"w-3 h-3 ml-1\" style={{ color: '#5AF5FA' }} />\n                  </Button>\n                </TooltipTrigger>\n                <TooltipContent>\n                  <p className=\"text-xs\">Intraday intervals unavailable for ranges over 3 months</p>\n                </TooltipContent>\n              </Tooltip>\n            </TooltipProvider>\n          )}\n        </div>\n\n        {/* Custom Date Picker */}\n        {timeframe === 'Custom' && showDatePicker && (\n          <div className=\"mb-4 p-4 border rounded-lg relative z-50\" style={{ zIndex: 9999, backgroundColor: '#3A3A3A' }}>\n            <div className=\"flex items-start justify-between mb-4\">\n              <div>\n                <div className=\"flex bg-muted rounded-lg p-1\">\n                  <button\n                    onClick={() => {\n                      setSingleTradingDay(false);\n                      setEndDate(undefined);\n                    }}\n                    className={`px-4 py-2 rounded-md text-sm transition-colors ${\n                      !singleTradingDay \n                        ? 'bg-background shadow-sm text-foreground' \n                        : 'text-muted-foreground hover:text-foreground'\n                    }`}\n                  >\n                    Date Range\n                  </button>\n                  <button\n                    onClick={() => {\n                      setSingleTradingDay(true);\n                      setEndDate(undefined);\n                    }}\n                    className={`px-4 py-2 rounded-md text-sm transition-colors ${\n                      singleTradingDay \n                        ? 'bg-background shadow-sm text-foreground' \n                        : 'text-muted-foreground hover:text-foreground'\n                    }`}\n                  >\n                    Single Trading Day\n                  </button>\n                </div>\n              </div>\n              <div className=\"flex items-start gap-3\">\n                {startDate && (singleTradingDay || endDate) && (\n                  <div className=\"text-right\">\n                    <div className=\"text-sm text-foreground\">\n                      Selected: {format(startDate, 'MMM dd, yyyy')}{!singleTradingDay && endDate && `  ${format(endDate, 'MMM dd, yyyy')}`}\n                    </div>\n                    <Button\n                      onClick={() => {\n                        if (singleTradingDay) {\n                          setEndDate(startDate);\n                        }\n                        setShowDatePicker(false);\n                      }}\n                      className=\"mt-2 bg-[#5AF5FA] text-[#121212] hover:bg-[#5AF5FA]/90 font-medium\"\n                      size=\"sm\"\n                      data-testid=\"button-apply-date-range\"\n                    >\n                      {singleTradingDay ? 'Show Trading Day' : 'Apply Date Range'}\n                    </Button>\n                  </div>\n                )}\n                <button\n                  onClick={() => {\n                    setShowDatePicker(false);\n                    setSingleTradingDay(false);\n                    setStartDate(undefined);\n                    setEndDate(undefined);\n                  }}\n                  className=\"text-muted-foreground hover:text-foreground transition-colors p-1\"\n                  title=\"Close date picker\"\n                >\n                  <X className=\"w-4 h-4\" />\n                </button>\n              </div>\n            </div>\n            \n            <div className=\"flex gap-6 flex-wrap\">\n              <div className=\"space-y-2\">\n                <label className=\"text-sm font-medium\">{singleTradingDay ? 'Select Date' : 'Start Date'}</label>\n                <Calendar\n                  mode=\"single\"\n                  selected={startDate}\n                  onSelect={setStartDate}\n                  month={startCalendarMonth}\n                  onMonthChange={setStartCalendarMonth}\n                  enableYearDropdown\n                  fromYear={new Date().getFullYear() - 10}\n                  toYear={new Date().getFullYear()}\n                  fromDate={(() => {\n                    const tenYearsAgo = new Date();\n                    tenYearsAgo.setFullYear(tenYearsAgo.getFullYear() - 10);\n                    return tenYearsAgo;\n                  })()}\n                  toDate={new Date()}\n                  disabled={(date) => {\n                    const isWeekend = date.getDay() === 0 || date.getDay() === 6;\n                    return isWeekend;\n                  }}\n                  className=\"rounded-md border\"\n                  classNames={{\n                    day_today: \"border border-white rounded bg-transparent text-foreground\",\n                    day_selected: \"bg-[#5AF5FA] text-[#121212] hover:bg-[#5AF5FA] hover:text-[#121212] focus:bg-[#5AF5FA] focus:text-[#121212]\",\n                    day: \"h-9 w-9 p-0 font-normal aria-selected:opacity-100 hover:bg-[#1C1C1C] hover:text-[#F7F7F7] focus:bg-[#1C1C1C] focus:text-[#F7F7F7] rounded transition-colors\"\n                  }}\n                />\n              </div>\n              \n              {!singleTradingDay && (\n                <div className=\"space-y-2\">\n                  <label className=\"text-sm font-medium\">End Date</label>\n                  <Calendar\n                    mode=\"single\"\n                    selected={endDate}\n                    onSelect={setEndDate}\n                    month={endCalendarMonth}\n                    onMonthChange={setEndCalendarMonth}\n                    enableYearDropdown\n                    fromYear={new Date().getFullYear() - 10}\n                    toYear={new Date().getFullYear()}\n                    fromDate={(() => {\n                      const tenYearsAgo = new Date();\n                      tenYearsAgo.setFullYear(tenYearsAgo.getFullYear() - 10);\n                      return tenYearsAgo;\n                    })()}\n                    toDate={new Date()}\n                    disabled={(date) => {\n                      const isWeekend = date.getDay() === 0 || date.getDay() === 6;\n                      if (!!startDate && date < startDate) return true;\n                      return isWeekend;\n                    }}\n                    className=\"rounded-md border\"\n                    classNames={{\n                      day_today: \"border border-white rounded bg-transparent text-foreground\",\n                      day_selected: \"bg-[#5AF5FA] text-[#121212] hover:bg-[#5AF5FA] hover:text-[#121212] focus:bg-[#5AF5FA] focus:text-[#121212]\",\n                      day: \"h-9 w-9 p-0 font-normal aria-selected:opacity-100 hover:bg-[#1C1C1C] hover:text-[#F7F7F7] focus:bg-[#1C1C1C] focus:text-[#F7F7F7] rounded transition-colors\"\n                    }}\n                  />\n                </div>\n              )}\n            </div>\n          </div>\n        )}\n\n        {/* Chart Controls Row 2: Annotation tools, Zoom, Hover toggle, Clear, Export */}\n        <div className=\"flex items-center justify-between mb-4\">\n          <div className=\"flex items-center justify-between\">\n            <div className=\"flex items-center gap-4\">\n              {/* Annotation Mode Controls */}\n              <div className=\"flex items-center gap-2\">\n                <DropdownMenu>\n                  <DropdownMenuTrigger asChild>\n                    <Button\n                      size=\"sm\"\n                      variant=\"outline\"\n                      className=\"h-8 px-3 text-xs\"\n                      data-testid=\"button-annotation-dropdown\"\n                    >\n                      {annotationMode === 'text' && (\n                        <>\n                          <div className=\"w-3 h-3 mr-1 flex items-center justify-center\" style={{ color: '#FAFF50' }}>\n                            <div className=\"w-0.5 h-3 bg-current\" />\n                          </div>\n                          Vertical\n                        </>\n                      )}\n                      {annotationMode === 'horizontal' && (\n                        <>\n                          <Minus className=\"w-3 h-3 mr-1\" style={{ color: '#AA99FF' }} />\n                          Horizontal\n                        </>\n                      )}\n                      {annotationMode === 'note' && (\n                        <>\n                          <Type className=\"w-3 h-3 mr-1\" style={{ color: '#FFFFFF' }} />\n                          Text Note\n                        </>\n                      )}\n                      {!annotationMode && 'Select Tool'}\n                      <ChevronDown className=\"w-3 h-3 ml-1\" style={{ color: '#5AF5FA' }} />\n                    </Button>\n                  </DropdownMenuTrigger>\n                  <DropdownMenuContent align=\"start\">\n                    <DropdownMenuItem\n                      onClick={() => {\n                        setAnnotationMode('text');\n                        setPendingPercentageStart(null);\n                      }}\n                      className=\"cursor-pointer\"\n                      data-testid=\"menu-annotation-text\"\n                    >\n                      <div className=\"w-3 h-3 mr-2 flex items-center justify-center\" style={{ color: '#FAFF50' }}>\n                        <div className=\"w-0.5 h-3 bg-current\" />\n                      </div>\n                      Vertical\n                    </DropdownMenuItem>\n                    <DropdownMenuItem\n                      onClick={() => {\n                        setAnnotationMode('horizontal');\n                        setPendingPercentageStart(null);\n                      }}\n                      className=\"cursor-pointer\"\n                      data-testid=\"menu-annotation-horizontal\"\n                    >\n                      <Minus className=\"w-3 h-3 mr-2\" style={{ color: '#AA99FF' }} />\n                      Horizontal\n                    </DropdownMenuItem>\n                    <DropdownMenuItem\n                      onClick={() => {\n                        setAnnotationMode('note');\n                        setPendingPercentageStart(null);\n                      }}\n                      className=\"cursor-pointer\"\n                      data-testid=\"menu-annotation-note\"\n                    >\n                      <Type className=\"w-3 h-3 mr-2\" style={{ color: '#FFFFFF' }} />\n                      Text Note\n                    </DropdownMenuItem>\n                  </DropdownMenuContent>\n                </DropdownMenu>\n              </div>\n\n              {/* Y-axis Zoom Controls */}\n              <div className=\"flex items-center gap-1\">\n                <span className=\"text-xs text-muted-foreground mr-1\">Y-Axis:</span>\n                <div className=\"flex border border-border rounded-md overflow-hidden bg-background\">\n                  <button\n                    onClick={() => comparisonZoomInRef.current?.()}\n                    className=\"h-8 w-8 text-sm font-medium bg-[#121212] text-white border-r border-border hover:bg-[#5AF5FA] hover:text-[#121212] disabled:opacity-50 disabled:cursor-not-allowed transition-colors duration-150 flex items-center justify-center\"\n                    data-testid=\"button-zoom-in-price\"\n                    title=\"Zoom In Y-Axis\"\n                  >\n                    +\n                  </button>\n                  <button\n                    onClick={() => comparisonZoomOutRef.current?.()}\n                    className=\"h-8 w-8 text-sm font-medium bg-[#121212] text-white border-r border-border hover:bg-[#5AF5FA] hover:text-[#121212] disabled:opacity-50 disabled:cursor-not-allowed transition-colors duration-150 flex items-center justify-center\"\n                    data-testid=\"button-zoom-out-price\"\n                    title=\"Zoom Out Y-Axis\"\n                  >\n                    \n                  </button>\n                  <button\n                    onClick={() => comparisonFitToDataRef.current?.()}\n                    className=\"h-8 w-10 text-xs font-medium bg-[#121212] text-white hover:bg-[#5AF5FA] hover:text-[#121212] transition-colors duration-150 flex items-center justify-center\"\n                    data-testid=\"button-fit-price-data\"\n                    title=\"Fit Y-Axis to Data\"\n                  >\n                    Fit\n                  </button>\n                </div>\n              </div>\n\n              {/* Hover Tool Toggle */}\n              <div className=\"flex items-center gap-2 ml-2\">\n                <Switch\n                  id=\"hover-tool\"\n                  checked={showHoverTooltip}\n                  onCheckedChange={setShowHoverTooltip}\n                  className=\"h-4 w-8\"\n                  data-testid=\"switch-hover-tool\"\n                />\n                <label\n                  htmlFor=\"hover-tool\"\n                  className=\"text-xs text-muted-foreground cursor-pointer hover:text-foreground transition-colors\"\n                >\n                  Hover: {showHoverTooltip ? 'On' : 'Off'}\n                </label>\n              </div>\n\n              {/* Clear All Button */}\n              <Button\n                variant=\"outline\"\n                size=\"sm\"\n                onClick={clearAll}\n                className=\"h-8 px-3 text-xs text-destructive hover:text-black hover:bg-[#5AF5FA]\"\n                data-testid=\"button-clear-all\"\n              >\n                <RotateCcw className=\"w-3 h-3 mr-1\" />\n                Clear All\n              </Button>\n              \n              {/* Export Dropdown */}\n              <DropdownMenu>\n                <DropdownMenuTrigger asChild>\n                  <Button\n                    variant=\"outline\"\n                    size=\"sm\"\n                    className=\"h-8 px-3 text-xs border-[#5AF5FA]/30 text-[#5AF5FA] hover:bg-[#5AF5FA]/10 ml-2\"\n                  >\n                    <Download className=\"w-3 h-3 mr-1\" />\n                    Export\n                    <ChevronDown className=\"w-3 h-3 ml-1\" style={{ color: '#5AF5FA' }} />\n                  </Button>\n                </DropdownMenuTrigger>\n                <DropdownMenuContent align=\"center\" className=\"w-36\">\n                  <DropdownMenuItem onClick={exportAsPNG} className=\"cursor-pointer\">\n                    <Download className=\"w-4 h-4 mr-2\" />\n                    Export as PNG\n                  </DropdownMenuItem>\n                  <DropdownMenuItem onClick={exportAsPDF} className=\"cursor-pointer\">\n                    <Download className=\"w-4 h-4 mr-2\" />\n                    Export as PDF\n                  </DropdownMenuItem>\n                  <DropdownMenuItem onClick={exportAsSVG} className=\"cursor-pointer\">\n                    <Download className=\"w-4 h-4 mr-2\" />\n                    Export as SVG\n                  </DropdownMenuItem>\n                </DropdownMenuContent>\n              </DropdownMenu>\n            </div>\n          </div>\n        </div>\n\n        {/* Comparison Chart Component */}\n        <div ref={comparisonRef}>\n          <ComparisonChartComponent \n            key={chartKey}\n            timeframe={timeframe}\n            startDate={startDate}\n            endDate={endDate}\n            singleTradingDay={singleTradingDay}\n            annotations={annotations}\n            onAnnotationsChange={setAnnotations}\n            annotationMode={annotationMode}\n            pendingPercentageStart={pendingPercentageStart}\n            setPendingPercentageStart={setPendingPercentageStart}\n            updateAnnotations={setAnnotations}\n            showHoverTooltip={showHoverTooltip}\n            onZoomIn={(fn) => { if (fn && typeof fn === 'function') comparisonZoomInRef.current = fn; }}\n            onZoomOut={(fn) => { if (fn && typeof fn === 'function') comparisonZoomOutRef.current = fn; }}\n            onFitToData={(fn) => { if (fn && typeof fn === 'function') comparisonFitToDataRef.current = fn; }}\n            onTickersChange={handleTickersChange}\n          />\n        </div>\n\n        {/* Compare Chart History Log */}\n        <Card className=\"p-6 mt-8\" style={{ backgroundColor: '#121212' }}>\n          <div className=\"flex items-center justify-between mb-4\">\n            <h3 className=\"text-lg font-semibold\">Compare Chart History</h3>\n            {compareChartHistory.length > 0 && (\n              <Button\n                variant=\"ghost\"\n                size=\"sm\"\n                onClick={handleDeleteAllClick}\n                className=\"hover:bg-transparent relative flex items-center justify-center\"\n                style={{ \n                  width: confirmDeleteAll ? '95px' : '90px',\n                  height: '32px',\n                  transition: 'width 300ms',\n                  overflow: 'hidden'\n                }}\n                data-testid=\"button-delete-all-history\"\n              >\n                <Trash2 \n                  className={`h-4 w-4 absolute transition-all duration-300 ${\n                    confirmDeleteAll ? 'opacity-0 -translate-x-12' : 'opacity-100 translate-x-0'\n                  }`}\n                  style={{ \n                    color: confirmDeleteAll ? '#5AF5FA' : '#F7F7F7',\n                    left: '4px'\n                  }}\n                  onMouseEnter={(e) => !confirmDeleteAll && (e.currentTarget.style.color = '#5AF5FA')}\n                  onMouseLeave={(e) => !confirmDeleteAll && (e.currentTarget.style.color = '#F7F7F7')}\n                />\n                <span \n                  className={`text-sm whitespace-nowrap font-medium absolute transition-all duration-300 ${\n                    confirmDeleteAll ? 'opacity-0 -translate-x-12' : 'opacity-100 translate-x-0'\n                  }`}\n                  style={{ \n                    color: '#F7F7F7',\n                    left: '28px'\n                  }}\n                  onMouseEnter={(e) => !confirmDeleteAll && (e.currentTarget.style.color = '#5AF5FA')}\n                  onMouseLeave={(e) => !confirmDeleteAll && (e.currentTarget.style.color = '#F7F7F7')}\n                >\n                  Delete All\n                </span>\n                <span \n                  className={`text-sm whitespace-nowrap font-medium absolute transition-all duration-300 ${\n                    confirmDeleteAll ? 'opacity-100 translate-x-0' : 'opacity-0 translate-x-12'\n                  }`}\n                  style={{ \n                    color: '#5AF5FA',\n                    left: '8px'\n                  }}\n                >\n                  Delete Now\n                </span>\n              </Button>\n            )}\n          </div>\n          <div className=\"h-[350px] overflow-y-scroll\">\n            {compareChartHistory.length > 0 ? (\n              <div className=\"grid grid-cols-1 md:grid-cols-2 gap-3\">\n                {compareChartHistory.map((entry) => {\n                  const tickerSymbols = (entry.tickers || []).map(t => t.symbol).join(', ');\n                  const annotationCounts = (entry.annotations || []).reduce((acc, ann) => {\n                    const type = ann.type === 'text' ? 'Vertical' : \n                                 ann.type === 'percentage' ? 'Measure' : \n                                 ann.type === 'horizontal' ? 'Horizontal' :\n                                 'Note';\n                    acc[type] = (acc[type] || 0) + 1;\n                    return acc;\n                  }, {} as Record<string, number>);\n\n                  const annotationSummary = Object.entries(annotationCounts)\n                    .map(([type, count]) => `${count} ${type}`)\n                    .join(', ');\n\n                  return (\n                    <Card \n                      key={entry.id} \n                      className={`p-4 bg-muted/50 cursor-pointer transition-all duration-300 hover:bg-muted/70 relative group ${\n                        deletingId === entry.id ? 'opacity-0 -translate-x-full' : ''\n                      }`}\n                      data-testid={`compare-chart-history-${entry.id}`}\n                      onClick={() => restoreFromHistory(entry)}\n                      style={{\n                        borderRadius: '4px',\n                      }}\n                    >\n                      {/* Hover gradient border */}\n                      <div \n                        className=\"absolute inset-0 rounded opacity-0 group-hover:opacity-100 transition-opacity duration-200 pointer-events-none\"\n                        style={{\n                          background: 'linear-gradient(90deg, #5AF5FA 0%, #FFA5FF 100%)',\n                          padding: '1px',\n                          borderRadius: '4px',\n                          WebkitMask: 'linear-gradient(#fff 0 0) content-box, linear-gradient(#fff 0 0)',\n                          WebkitMaskComposite: 'xor',\n                          maskComposite: 'exclude',\n                        }}\n                      />\n                      <div className=\"flex items-start justify-between relative z-10\">\n                        <div className=\"flex-1\">\n                          <div className=\"font-bold text-[#5AF5FA] mb-1\">\n                            {tickerSymbols || 'No tickers'}\n                          </div>\n                          <div className=\"text-sm text-muted-foreground mb-2\">\n                            {format(new Date(entry.savedAt), 'MMM dd, yyyy HH:mm:ss')}\n                          </div>\n                          <div className=\"text-xs text-muted-foreground mb-1\">\n                            Timeframe: {entry.timeframe}\n                            {(entry.tickers || []).length > 0 && `  ${entry.tickers.length} ticker${entry.tickers.length > 1 ? 's' : ''}`}\n                          </div>\n                          <div className=\"text-sm text-foreground\">\n                            {annotationSummary || 'No annotations'}\n                          </div>\n                        </div>\n                        {/* Delete button */}\n                        <Button\n                          variant=\"ghost\"\n                          size=\"sm\"\n                          onClick={(e) => {\n                            e.stopPropagation();\n                            handleDeleteClick(entry.id);\n                          }}\n                          className=\"ml-2 hover:bg-transparent relative flex items-center justify-center\"\n                          style={{ \n                            width: confirmDeleteId === entry.id ? '85px' : '36px',\n                            height: '32px',\n                            transition: 'width 300ms',\n                            overflow: 'hidden'\n                          }}\n                          data-testid={`button-delete-history-${entry.id}`}\n                        >\n                          <Trash2 \n                            className={`h-4 w-4 absolute transition-all duration-300 ${\n                              confirmDeleteId === entry.id ? 'opacity-0 -translate-x-12' : 'opacity-100 translate-x-0'\n                            }`}\n                            style={{ \n                              color: confirmDeleteId === entry.id ? '#5AF5FA' : '#F7F7F7'\n                            }}\n                            onMouseEnter={(e) => confirmDeleteId !== entry.id && (e.currentTarget.style.color = '#5AF5FA')}\n                            onMouseLeave={(e) => confirmDeleteId !== entry.id && (e.currentTarget.style.color = '#F7F7F7')}\n                          />\n                          <span \n                            className={`text-xs whitespace-nowrap font-medium absolute transition-all duration-300 ${\n                              confirmDeleteId === entry.id ? 'opacity-100 translate-x-0' : 'opacity-0 translate-x-12'\n                            }`}\n                            style={{ color: '#5AF5FA' }}\n                          >\n                            Delete Now\n                          </span>\n                        </Button>\n                      </div>\n                    </Card>\n                  );\n                })}\n              </div>\n            ) : (\n              <div className=\"flex items-center justify-center h-full text-muted-foreground text-center\">\n                <p data-testid=\"text-no-history\">No compare chart history yet. Add tickers or annotate a chart to see it here.</p>\n              </div>\n            )}\n          </div>\n        </Card>\n      </main>\n    </div>\n  );\n}\n","path":null,"size_bytes":48177,"size_tokens":null},"client/src/pages/ai-copilot.tsx":{"content":"import { Link, useLocation } from \"wouter\";\nimport { Card } from \"@/components/ui/card\";\nimport { Button } from \"@/components/ui/button\";\nimport { Textarea } from \"@/components/ui/textarea\";\nimport { Sparkles, LogOut, BookOpen, Send, Loader2, Download, BarChart3, Plus, Trash2, AlertCircle } from \"lucide-react\";\nimport { useAuth } from \"@/contexts/AuthContext\";\nimport logoImage from \"@assets/IPO Intelligence@2x_1758060026530.png\";\nimport {\n  Select,\n  SelectContent,\n  SelectItem,\n  SelectTrigger,\n  SelectValue,\n} from \"@/components/ui/select\";\nimport { useState, useEffect, useRef, Component } from \"react\";\nimport { useQuery, useMutation } from \"@tanstack/react-query\";\nimport { apiRequest, queryClient } from \"@/lib/queryClient\";\nimport type { AiCopilotMessage } from \"@shared/schema\";\nimport { AICopilotChart } from \"@/components/ai-copilot/chart\";\n\n// Error boundary for chart rendering\nclass ErrorBoundary extends Component<\n  { children: React.ReactNode },\n  { hasError: boolean; error: Error | null }\n> {\n  constructor(props: { children: React.ReactNode }) {\n    super(props);\n    this.state = { hasError: false, error: null };\n  }\n\n  static getDerivedStateFromError(error: Error) {\n    return { hasError: true, error };\n  }\n\n  componentDidCatch(error: Error, errorInfo: any) {\n    console.error('Chart rendering error:', error, errorInfo);\n  }\n\n  render() {\n    if (this.state.hasError) {\n      return (\n        <div className=\"h-full flex items-center justify-center\">\n          <div className=\"text-center max-w-md\">\n            <AlertCircle className=\"h-16 w-16 mx-auto mb-4\" style={{ color: '#FF6B6B', opacity: 0.8 }} />\n            <p \n              className=\"text-lg font-semibold mb-2\"\n              style={{ fontFamily: 'Mulish, sans-serif', color: '#FF6B6B' }}\n            >\n              Could not render chart\n            </p>\n            <p \n              className=\"text-sm\"\n              style={{ fontFamily: 'Mulish, sans-serif', color: '#A0A0A0' }}\n            >\n              {this.state.error?.message || 'The chart configuration is invalid or contains unsupported data'}\n            </p>\n            <Button\n              onClick={() => this.setState({ hasError: false, error: null })}\n              className=\"mt-4\"\n              style={{ backgroundColor: '#5AF5FA', color: '#000' }}\n            >\n              Try Again\n            </Button>\n          </div>\n        </div>\n      );\n    }\n\n    return this.props.children;\n  }\n}\n\nfunction LogoutButton() {\n  const { logout } = useAuth();\n  const [, setLocation] = useLocation();\n\n  const handleLogout = () => {\n    logout();\n    setLocation('/login');\n  };\n\n  return (\n    <button\n      onClick={handleLogout}\n      className=\"flex items-center gap-2 hover:opacity-80 transition-opacity\"\n      data-testid=\"button-logout\"\n      style={{ fontFamily: 'var(--font-sans)', fontSize: '16px', color: '#f7f7f7' }}\n    >\n      <LogOut className=\"h-5 w-5 text-[#5AF5FA]\" />\n      <span>Sign Out</span>\n    </button>\n  );\n}\n\nexport default function AICopilot() {\n  const [, setLocation] = useLocation();\n  const [chatId, setChatId] = useState<number | null>(null);\n  const [message, setMessage] = useState(\"\");\n  const [selectedChartId, setSelectedChartId] = useState<number | null>(null);\n  const messagesEndRef = useRef<HTMLDivElement>(null);\n  const [confirmDeleteId, setConfirmDeleteId] = useState<number | null>(null);\n  const [deletingId, setDeletingId] = useState<number | null>(null);\n  const [confirmDeleteAll, setConfirmDeleteAll] = useState(false);\n  const deleteTimerRef = useRef<NodeJS.Timeout | null>(null);\n  const deleteAllTimerRef = useRef<NodeJS.Timeout | null>(null);\n\n  const handleChartTypeChange = (value: string) => {\n    setLocation(value);\n  };\n\n  // Create chat session on mount\n  const createSessionMutation = useMutation({\n    mutationFn: async () => {\n      const res = await apiRequest('POST', '/api/ai-copilot/session');\n      return res.json();\n    },\n    onSuccess: (data) => {\n      setChatId(data.id);\n    },\n  });\n\n  useEffect(() => {\n    createSessionMutation.mutate();\n  }, []);\n\n  // Get messages for current chat\n  const { data: messages = [], refetch: refetchMessages } = useQuery<AiCopilotMessage[]>({\n    queryKey: ['/api/ai-copilot/messages', chatId],\n    enabled: !!chatId,\n  });\n\n  // Get all chart history across all sessions\n  const { \n    data: allChartMessages = [], \n    refetch: refetchAllCharts,\n    isError: chartHistoryError,\n    error: chartHistoryErrorData\n  } = useQuery<AiCopilotMessage[]>({\n    queryKey: ['/api/ai-copilot/all-charts'],\n  });\n\n  // Send message\n  const sendMessageMutation = useMutation({\n    mutationFn: async (msg: string) => {\n      const res = await apiRequest('POST', '/api/ai-copilot/chat', { chatId, message: msg });\n      return res.json();\n    },\n    onSuccess: () => {\n      setMessage(\"\");\n      refetchMessages();\n      refetchAllCharts(); // Also refresh the chart history\n    },\n  });\n\n  const handleSend = () => {\n    if (!message.trim() || !chatId) return;\n    sendMessageMutation.mutate(message);\n  };\n\n  // Auto-scroll to bottom\n  useEffect(() => {\n    messagesEndRef.current?.scrollIntoView({ behavior: 'smooth' });\n  }, [messages]);\n\n  // Auto-select latest chart when new one is generated\n  useEffect(() => {\n    const latestChart = messages.slice().reverse().find(m => m.chartConfig);\n    if (latestChart && !selectedChartId) {\n      setSelectedChartId(latestChart.id);\n    }\n  }, [messages, selectedChartId]);\n\n  // Use all chart messages across sessions instead of just current chat\n  const chartMessages = allChartMessages;\n  \n  // Get selected chart from all chart messages\n  const selectedChart = selectedChartId \n    ? allChartMessages.find(m => m.id === selectedChartId)\n    : chartMessages[0]; // Most recent chart (since ordered by desc)\n\n  // Handle new chat\n  const handleNewChat = () => {\n    setSelectedChartId(null);\n    createSessionMutation.mutate();\n  };\n\n  // Delete individual chart message\n  const deleteMessageMutation = useMutation({\n    mutationFn: async ({ messageId, messageChatId }: { messageId: number; messageChatId: number }) => {\n      await apiRequest('DELETE', `/api/ai-copilot/messages/${messageChatId}/${messageId}`);\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: ['/api/ai-copilot/all-charts'] });\n      queryClient.invalidateQueries({ queryKey: ['/api/ai-copilot/messages', chatId] });\n      setDeletingId(null);\n      setConfirmDeleteId(null);\n    },\n  });\n\n  // Delete all charts for the user\n  const deleteAllChartsMutation = useMutation({\n    mutationFn: async () => {\n      // Delete all charts across all user sessions\n      const deletePromises = allChartMessages.map(msg => \n        apiRequest('DELETE', `/api/ai-copilot/messages/${msg.chatId}/${msg.id}`)\n      );\n      await Promise.all(deletePromises);\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: ['/api/ai-copilot/all-charts'] });\n      queryClient.invalidateQueries({ queryKey: ['/api/ai-copilot/messages', chatId] });\n      setConfirmDeleteAll(false);\n      setSelectedChartId(null);\n    },\n  });\n\n  // Handle delete click (first click)\n  const handleDeleteClick = (messageId: number) => {\n    if (confirmDeleteId === messageId) {\n      // Second click - execute deletion\n      // Clear timer to prevent state update after unmount\n      if (deleteTimerRef.current) {\n        clearTimeout(deleteTimerRef.current);\n        deleteTimerRef.current = null;\n      }\n      \n      setDeletingId(messageId);\n      \n      // If this is the selected chart, clear selection\n      if (selectedChartId === messageId) {\n        setSelectedChartId(null);\n      }\n      \n      setTimeout(() => {\n        // Find the message to get its chatId\n        const message = allChartMessages.find(m => m.id === messageId);\n        if (message) {\n          deleteMessageMutation.mutate({ messageId, messageChatId: message.chatId });\n        }\n      }, 300); // Wait for animation\n    } else {\n      // First click - show confirmation\n      setConfirmDeleteId(messageId);\n      \n      // Clear any existing timer\n      if (deleteTimerRef.current) {\n        clearTimeout(deleteTimerRef.current);\n      }\n      \n      // Auto-reset after 4 seconds\n      deleteTimerRef.current = setTimeout(() => {\n        setConfirmDeleteId(null);\n      }, 4000);\n    }\n  };\n\n  // Handle delete all click\n  const handleDeleteAllClick = () => {\n    if (confirmDeleteAll) {\n      // Second click - execute deletion\n      // Clear timer to prevent state update after unmount\n      if (deleteAllTimerRef.current) {\n        clearTimeout(deleteAllTimerRef.current);\n        deleteAllTimerRef.current = null;\n      }\n      \n      deleteAllChartsMutation.mutate();\n    } else {\n      // First click - show confirmation\n      setConfirmDeleteAll(true);\n      \n      // Clear any existing timer\n      if (deleteAllTimerRef.current) {\n        clearTimeout(deleteAllTimerRef.current);\n      }\n      \n      // Auto-reset after 4 seconds\n      deleteAllTimerRef.current = setTimeout(() => {\n        setConfirmDeleteAll(false);\n      }, 4000);\n    }\n  };\n\n  // Clear timer when confirmDeleteId changes (switching targets)\n  useEffect(() => {\n    if (confirmDeleteId === null && deleteTimerRef.current) {\n      clearTimeout(deleteTimerRef.current);\n      deleteTimerRef.current = null;\n    }\n  }, [confirmDeleteId]);\n\n  // Clear timer when confirmDeleteAll changes\n  useEffect(() => {\n    if (!confirmDeleteAll && deleteAllTimerRef.current) {\n      clearTimeout(deleteAllTimerRef.current);\n      deleteAllTimerRef.current = null;\n    }\n  }, [confirmDeleteAll]);\n\n  // Cleanup timers on unmount\n  useEffect(() => {\n    return () => {\n      if (deleteTimerRef.current) {\n        clearTimeout(deleteTimerRef.current);\n      }\n      if (deleteAllTimerRef.current) {\n        clearTimeout(deleteAllTimerRef.current);\n      }\n    };\n  }, []);\n\n  return (\n    <div className=\"min-h-screen bg-background text-foreground\">\n      {/* Navigation Header */}\n      <header className=\"border-b border-border sticky top-0 z-50 bg-background/95 backdrop-blur supports-[backdrop-filter]:bg-background/60\">\n        <div className=\"container mx-auto px-4 py-4\">\n          <div className=\"flex items-center justify-between\">\n            {/* Logo */}\n            <Link href=\"/\">\n              <img src={logoImage} alt=\"Logo\" className=\"w-[240px] h-auto max-[600px]:w-[180px] hover:opacity-80 transition-opacity cursor-pointer\" data-testid=\"link-home\" />\n            </Link>\n\n            {/* Navigation Items */}\n            <nav className=\"flex items-center gap-6\">\n              {/* Chart Type Dropdown */}\n              <Select value=\"/ai-copilot\" onValueChange={handleChartTypeChange}>\n                <SelectTrigger \n                  className=\"w-[200px] bg-card border-border\"\n                  data-testid=\"select-chart-type\"\n                  style={{ fontFamily: 'var(--font-sans)' }}\n                >\n                  <SelectValue placeholder=\"Chart Type\" />\n                </SelectTrigger>\n                <SelectContent style={{ backgroundColor: '#3A3A3A' }}>\n                  <SelectItem value=\"/price-chart\">Price Chart</SelectItem>\n                  <SelectItem value=\"/comparison-chart\">Comparison Chart</SelectItem>\n                  <SelectItem value=\"/ai-copilot\">AI Co-Pilot</SelectItem>\n                </SelectContent>\n              </Select>\n\n              {/* Walkthrough Link */}\n              <Link href=\"/walkthrough\">\n                <span \n                  className=\"flex items-center gap-2 hover:opacity-80 transition-opacity cursor-pointer\"\n                  data-testid=\"link-walkthrough\"\n                  style={{ fontFamily: 'var(--font-sans)', fontSize: '16px', color: '#f7f7f7' }}\n                >\n                  <BookOpen className=\"h-5 w-5 text-[#5AF5FA]\" />\n                  <span>Walkthrough</span>\n                </span>\n              </Link>\n\n              {/* Logout Button */}\n              <LogoutButton />\n            </nav>\n          </div>\n        </div>\n      </header>\n\n      {/* Main Content */}\n      <main className=\"container mx-auto px-4 py-6 max-w-[1800px]\">\n        <div className=\"grid grid-cols-1 lg:grid-cols-4 gap-6 h-[calc(100vh-120px)]\">\n          {/* Left Sidebar: AI Co-Pilot Chat */}\n          <div className=\"lg:col-span-1 flex flex-col h-full overflow-hidden\">\n            {/* AI Co-Pilot Tools Section */}\n            <Card className=\"flex-1 flex flex-col overflow-hidden\" style={{ backgroundColor: '#1C1C1C' }}>\n              {/* Header */}\n              <div className=\"p-4 border-b border-border\">\n                <h3 \n                  className=\"text-lg font-semibold flex items-center gap-2\"\n                  style={{ fontFamily: 'Mulish, sans-serif', color: '#F7F7F7' }}\n                >\n                  <Sparkles className=\"h-5 w-5\" style={{ color: '#FFA5FF' }} />\n                  AI Co-Pilot\n                </h3>\n                <p \n                  className=\"text-xs mt-1\"\n                  style={{ fontFamily: 'Mulish, sans-serif', color: '#A0A0A0' }}\n                >\n                  Describe your chart and paste your data\n                </p>\n              </div>\n\n              {/* Messages */}\n              <div className=\"flex-1 overflow-y-auto p-3 space-y-3\">\n                {messages.length === 0 && (\n                  <div className=\"text-center py-8\">\n                    <Sparkles className=\"h-12 w-12 mx-auto mb-3\" style={{ color: '#FFA5FF' }} />\n                    <p className=\"text-sm\" style={{ fontFamily: 'Mulish, sans-serif', color: '#A0A0A0' }}>\n                      Describe your chart and paste data\n                    </p>\n                  </div>\n                )}\n\n                {messages.map((msg) => (\n                  <div \n                    key={msg.id}\n                    className={`flex ${msg.role === 'user' ? 'justify-end' : 'justify-start'}`}\n                  >\n                    <div \n                      className={`max-w-[85%] rounded-lg p-2.5 text-sm ${\n                        msg.role === 'user' \n                          ? 'bg-[#5AF5FA] text-black' \n                          : 'bg-[#2A2A2A] text-[#F7F7F7]'\n                      }`}\n                      style={{ fontFamily: 'Mulish, sans-serif' }}\n                    >\n                      <p className=\"whitespace-pre-wrap\">{msg.content}</p>\n                      \n                      {msg.chartConfig && (\n                        <div className=\"mt-2 p-2 bg-black/20 rounded text-xs\">\n                          <p className=\"font-semibold mb-0.5\"> Chart generated:</p>\n                          <p>{msg.chartConfig.title}</p>\n                        </div>\n                      )}\n                      \n                      {msg.role === 'assistant' && !msg.chartConfig && msg.content.includes('unable to generate') && (\n                        <div className=\"mt-2 p-2 bg-red-900/20 rounded text-xs border border-red-500/30\">\n                          <p className=\"text-red-400\"> Chart generation failed</p>\n                          <p className=\"text-red-300 mt-1\">Try providing more specific details or check your data format.</p>\n                        </div>\n                      )}\n                    </div>\n                  </div>\n                ))}\n\n                {sendMessageMutation.isPending && (\n                  <div className=\"flex justify-start\">\n                    <div className=\"bg-[#2A2A2A] rounded-lg p-2.5\">\n                      <Loader2 className=\"h-4 w-4 animate-spin\" style={{ color: '#5AF5FA' }} />\n                    </div>\n                  </div>\n                )}\n\n                <div ref={messagesEndRef} />\n              </div>\n\n              {/* Input Area */}\n              <div className=\"p-3 border-t border-border\">\n                <div className=\"flex gap-2\">\n                  <Textarea\n                    value={message}\n                    onChange={(e) => setMessage(e.target.value)}\n                    placeholder=\"Describe your chart and paste your data...\"\n                    className=\"flex-1 resize-none bg-[#2A2A2A] border-border text-[#F7F7F7] text-sm\"\n                    rows={2}\n                    onKeyDown={(e) => {\n                      if (e.key === 'Enter' && !e.shiftKey) {\n                        e.preventDefault();\n                        handleSend();\n                      }\n                    }}\n                    data-testid=\"input-message\"\n                  />\n\n                  <Button\n                    onClick={handleSend}\n                    disabled={!message.trim() || sendMessageMutation.isPending || !chatId}\n                    style={{ backgroundColor: '#5AF5FA', color: '#000' }}\n                    data-testid=\"button-send-message\"\n                    className=\"h-9 w-9 p-0\"\n                  >\n                    {sendMessageMutation.isPending ? (\n                      <Loader2 className=\"h-4 w-4 animate-spin\" />\n                    ) : (\n                      <Send className=\"h-4 w-4\" />\n                    )}\n                  </Button>\n                </div>\n              </div>\n            </Card>\n          </div>\n\n          {/* Main Chart Display with History - Takes up 3/4 of the screen */}\n          <div className=\"lg:col-span-3 flex flex-col gap-6 overflow-hidden\">\n            {/* Generated Chart */}\n            <Card className=\"flex-1 flex flex-col overflow-hidden\" style={{ backgroundColor: '#1C1C1C' }}>\n              <div className=\"p-4 border-b border-border\">\n                <h2 \n                  className=\"text-2xl font-semibold\"\n                  style={{ fontFamily: 'Mulish, sans-serif', color: '#F7F7F7' }}\n                >\n                  Generated Chart\n                </h2>\n              </div>\n\n              <div className=\"flex-1 p-6 overflow-auto\">\n                {chartHistoryError ? (\n                  <div className=\"h-full flex items-center justify-center\">\n                    <div className=\"text-center\">\n                      <AlertCircle className=\"h-20 w-20 mx-auto mb-4\" style={{ color: '#FF6B6B', opacity: 0.8 }} />\n                      <p \n                        className=\"text-lg font-semibold mb-2\"\n                        style={{ fontFamily: 'Mulish, sans-serif', color: '#FF6B6B' }}\n                      >\n                        Could not load chart history\n                      </p>\n                      <p \n                        className=\"text-sm\"\n                        style={{ fontFamily: 'Mulish, sans-serif', color: '#A0A0A0' }}\n                      >\n                        {chartHistoryErrorData instanceof Error ? chartHistoryErrorData.message : 'Failed to fetch chart data from server'}\n                      </p>\n                      <Button\n                        onClick={() => refetchAllCharts()}\n                        className=\"mt-4\"\n                        style={{ backgroundColor: '#5AF5FA', color: '#000' }}\n                      >\n                        Try Again\n                      </Button>\n                    </div>\n                  </div>\n                ) : selectedChart?.chartConfig ? (\n                  <div className=\"h-full\">\n                    <ErrorBoundary>\n                      <AICopilotChart \n                        config={selectedChart.chartConfig} \n                      />\n                    </ErrorBoundary>\n                  </div>\n                ) : (\n                  <div className=\"h-full flex items-center justify-center\">\n                    <div className=\"text-center\">\n                      <BarChart3 className=\"h-20 w-20 mx-auto mb-4\" style={{ color: '#5AF5FA', opacity: 0.2 }} />\n                      <p \n                        className=\"text-lg\"\n                        style={{ fontFamily: 'Mulish, sans-serif', color: '#A0A0A0' }}\n                      >\n                        Your chart will appear here\n                      </p>\n                      <p \n                        className=\"text-sm mt-2\"\n                        style={{ fontFamily: 'Mulish, sans-serif', color: '#707070' }}\n                      >\n                        Upload a CSV and describe the chart you want to create\n                      </p>\n                    </div>\n                  </div>\n                )}\n              </div>\n            </Card>\n\n            {/* Chart History - Permanent below Generated Chart */}\n            <Card className=\"h-64 flex flex-col overflow-hidden\" style={{ backgroundColor: '#1C1C1C' }}>\n              <div className=\"p-4 border-b border-border\">\n                <div className=\"flex items-center justify-between mb-2\">\n                  <h3 \n                    className=\"text-lg font-semibold\"\n                    style={{ fontFamily: 'Mulish, sans-serif', color: '#F7F7F7' }}\n                  >\n                    Chart History\n                  </h3>\n                  <div className=\"flex items-center gap-2\">\n                    {chartMessages.length > 0 && (\n                      <Button\n                        variant=\"ghost\"\n                        size=\"sm\"\n                        onClick={handleDeleteAllClick}\n                        className=\"hover:bg-transparent relative flex items-center justify-center\"\n                        style={{ \n                          width: confirmDeleteAll ? '95px' : '90px',\n                          height: '32px',\n                          transition: 'width 300ms',\n                          overflow: 'hidden'\n                        }}\n                        data-testid=\"button-delete-all-charts\"\n                      >\n                        <Trash2 \n                          className={`h-4 w-4 absolute transition-all duration-300 ${\n                            confirmDeleteAll ? 'opacity-0 -translate-x-12' : 'opacity-100 translate-x-0'\n                          }`}\n                          style={{ \n                            color: confirmDeleteAll ? '#5AF5FA' : '#F7F7F7',\n                            left: '4px'\n                          }}\n                          onMouseEnter={(e) => !confirmDeleteAll && (e.currentTarget.style.color = '#5AF5FA')}\n                          onMouseLeave={(e) => !confirmDeleteAll && (e.currentTarget.style.color = '#F7F7F7')}\n                        />\n                        <span \n                          className={`text-sm whitespace-nowrap font-medium absolute transition-all duration-300 ${\n                            confirmDeleteAll ? 'opacity-0 -translate-x-12' : 'opacity-100 translate-x-0'\n                          }`}\n                          style={{ \n                            color: '#F7F7F7',\n                            left: '28px'\n                          }}\n                          onMouseEnter={(e) => !confirmDeleteAll && (e.currentTarget.style.color = '#5AF5FA')}\n                          onMouseLeave={(e) => !confirmDeleteAll && (e.currentTarget.style.color = '#F7F7F7')}\n                        >\n                          Delete All\n                        </span>\n                        <span \n                          className={`text-sm whitespace-nowrap font-medium absolute transition-all duration-300 ${\n                            confirmDeleteAll ? 'opacity-100 translate-x-0' : 'opacity-0 translate-x-12'\n                          }`}\n                          style={{ \n                            color: '#5AF5FA',\n                            left: '8px'\n                          }}\n                        >\n                          Delete Now\n                        </span>\n                      </Button>\n                    )}\n                    <button\n                      onClick={handleNewChat}\n                      className=\"flex items-center gap-1 px-3 py-1.5 rounded-md hover:opacity-80 transition-opacity text-sm font-medium\"\n                      style={{ \n                        fontFamily: 'Mulish, sans-serif', \n                        backgroundColor: '#5AF5FA',\n                        color: '#000000'\n                      }}\n                      data-testid=\"button-new-chat-history\"\n                    >\n                      <Plus className=\"h-4 w-4\" />\n                      <span>New Chat</span>\n                    </button>\n                  </div>\n                </div>\n                <p \n                  className=\"text-xs\"\n                  style={{ fontFamily: 'Mulish, sans-serif', color: '#A0A0A0' }}\n                >\n                  {chartMessages.length} chart{chartMessages.length !== 1 ? 's' : ''} generated\n                </p>\n              </div>\n\n              <div className=\"flex-1 overflow-y-auto p-3 space-y-2\">\n                {chartMessages.length === 0 ? (\n                  <div className=\"text-center py-8\">\n                    <BarChart3 className=\"h-10 w-10 mx-auto mb-2\" style={{ color: '#5AF5FA', opacity: 0.3 }} />\n                    <p \n                      className=\"text-sm\"\n                      style={{ fontFamily: 'Mulish, sans-serif', color: '#A0A0A0' }}\n                    >\n                      No charts yet\n                    </p>\n                  </div>\n                ) : (\n                  <div className=\"grid grid-cols-1 md:grid-cols-2 gap-3\">\n                    {chartMessages.slice().reverse().map((msg) => (\n                      <div\n                        key={msg.id}\n                        className={`relative rounded-lg border transition-all duration-300 ${\n                          selectedChartId === msg.id \n                            ? 'border-[#5AF5FA] bg-[#5AF5FA]/10' \n                            : 'border-border hover:border-[#5AF5FA]/50 hover:bg-[#2A2A2A]'\n                        } ${deletingId === msg.id ? 'opacity-0 -translate-x-full' : ''}`}\n                        data-testid={`chart-history-card-${msg.id}`}\n                      >\n                        <button\n                          onClick={() => setSelectedChartId(msg.id)}\n                          className=\"w-full text-left p-2\"\n                        >\n                          <div className=\"flex items-start gap-2\">\n                            <BarChart3 \n                              className=\"h-4 w-4 mt-0.5 flex-shrink-0\" \n                              style={{ color: selectedChartId === msg.id ? '#5AF5FA' : '#A0A0A0' }} \n                            />\n                            <div className=\"flex-1 min-w-0\">\n                              <p \n                                className=\"text-sm font-medium truncate\"\n                                style={{ \n                                  fontFamily: 'Mulish, sans-serif', \n                                  color: selectedChartId === msg.id ? '#5AF5FA' : '#F7F7F7'\n                                }}\n                              >\n                                {msg.chartConfig?.title || 'Untitled Chart'}\n                              </p>\n                              <p \n                                className=\"text-xs mt-0.5 capitalize\"\n                                style={{ \n                                  fontFamily: 'Mulish, sans-serif', \n                                  color: '#A0A0A0'\n                                }}\n                              >\n                                {msg.chartConfig?.type} chart\n                              </p>\n                            </div>\n                          </div>\n                        </button>\n                        \n                        {/* Delete button */}\n                        <Button\n                          variant=\"ghost\"\n                          size=\"sm\"\n                          onClick={(e) => {\n                            e.stopPropagation();\n                            handleDeleteClick(msg.id);\n                          }}\n                          className=\"absolute top-1 right-1 hover:bg-transparent flex items-center justify-center\"\n                          style={{ \n                            width: confirmDeleteId === msg.id ? '95px' : '36px',\n                            height: '32px',\n                            transition: 'width 300ms',\n                            overflow: 'hidden'\n                          }}\n                          data-testid={`button-delete-chart-${msg.id}`}\n                        >\n                          <Trash2 \n                            className={`h-4 w-4 absolute transition-all duration-300 ${\n                              confirmDeleteId === msg.id ? 'opacity-0 -translate-x-12' : 'opacity-100 translate-x-0'\n                            }`}\n                            style={{ \n                              color: confirmDeleteId === msg.id ? '#5AF5FA' : '#F7F7F7',\n                              left: '8px'\n                            }}\n                            onMouseEnter={(e) => confirmDeleteId !== msg.id && (e.currentTarget.style.color = '#5AF5FA')}\n                            onMouseLeave={(e) => confirmDeleteId !== msg.id && (e.currentTarget.style.color = '#F7F7F7')}\n                          />\n                          <span \n                            className={`text-sm whitespace-nowrap font-medium absolute transition-all duration-300 ${\n                              confirmDeleteId === msg.id ? 'opacity-100 translate-x-0' : 'opacity-0 translate-x-12'\n                            }`}\n                            style={{ \n                              color: '#5AF5FA',\n                              left: '10px'\n                            }}\n                          >\n                            Delete Now\n                          </span>\n                        </Button>\n                      </div>\n                    ))}\n                  </div>\n                )}\n              </div>\n            </Card>\n          </div>\n        </div>\n      </main>\n    </div>\n  );\n}\n","path":null,"size_bytes":29888,"size_tokens":null},"server/services/alphaVantageService.ts":{"content":"const ALPHA_VANTAGE_API_KEY = process.env.ALPHA_VANTAGE_API_KEY || \"\";\nconst BASE_URL = \"https://www.alphavantage.co/query\";\n\ninterface AlphaVantageTimeSeriesDaily {\n  [date: string]: {\n    \"1. open\": string;\n    \"2. high\": string;\n    \"3. low\": string;\n    \"4. close\": string;\n    \"5. volume\": string;\n  };\n}\n\ninterface AlphaVantageResponse {\n  \"Meta Data\"?: {\n    \"1. Information\": string;\n    \"2. Symbol\": string;\n    \"3. Last Refreshed\": string;\n    \"4. Output Size\": string;\n    \"5. Time Zone\": string;\n  };\n  \"Time Series (Daily)\"?: AlphaVantageTimeSeriesDaily;\n  \"Error Message\"?: string;\n  \"Note\"?: string;\n}\n\nexport class AlphaVantageService {\n  private async makeRequest(params: Record<string, string>): Promise<any> {\n    const queryParams = new URLSearchParams({\n      ...params,\n      apikey: ALPHA_VANTAGE_API_KEY\n    });\n    const url = `${BASE_URL}?${queryParams}`;\n    \n    try {\n      const controller = new AbortController();\n      const timeoutId = setTimeout(() => controller.abort(), 30000); // 30 second timeout\n      \n      const response = await fetch(url, {\n        signal: controller.signal,\n        headers: {\n          'Accept-Encoding': 'gzip, deflate',\n          'User-Agent': 'Market-Dashboard/1.0'\n        }\n      });\n      \n      clearTimeout(timeoutId);\n      \n      if (!response.ok) {\n        throw new Error(`Alpha Vantage API error: ${response.status} ${response.statusText}`);\n      }\n      \n      const data = await response.json();\n      \n      // Check for API errors\n      if (data[\"Error Message\"]) {\n        console.error(`Alpha Vantage error: ${data[\"Error Message\"]}`);\n        return null;\n      }\n      \n      // Check for rate limit\n      if (data[\"Note\"]) {\n        console.warn(`Alpha Vantage rate limit: ${data[\"Note\"]}`);\n        return null;\n      }\n      \n      return data;\n    } catch (error) {\n      if (error instanceof Error && error.name === 'AbortError') {\n        console.error('Alpha Vantage request timeout');\n        throw new Error('Request timeout');\n      }\n      console.error('Error fetching from Alpha Vantage:', error);\n      throw error;\n    }\n  }\n\n  /**\n   * Get historical daily data for a symbol\n   * Returns data in Finnhub-compatible format for easy integration\n   */\n  async getStockCandles(symbol: string, from: number, to: number): Promise<any> {\n    try {\n      console.log(` Alpha Vantage fallback: Fetching historical data for ${symbol}`);\n      \n      const response = await this.makeRequest({\n        function: 'TIME_SERIES_DAILY',\n        symbol: symbol,\n        outputsize: 'full'\n      }) as AlphaVantageResponse;\n      \n      if (!response || !response[\"Time Series (Daily)\"]) {\n        console.log(` No data from Alpha Vantage for ${symbol}`);\n        return null;\n      }\n      \n      const timeSeries = response[\"Time Series (Daily)\"];\n      \n      // Convert to Finnhub format and filter by date range\n      const fromDate = new Date(from * 1000);\n      const toDate = new Date(to * 1000);\n      \n      const candleData = {\n        s: 'ok' as const,\n        t: [] as number[],\n        o: [] as number[],\n        h: [] as number[],\n        l: [] as number[],\n        c: [] as number[],\n        v: [] as number[]\n      };\n      \n      // Sort dates and filter by range\n      const dates = Object.keys(timeSeries).sort();\n      \n      for (const dateStr of dates) {\n        const date = new Date(dateStr + 'T00:00:00Z');\n        \n        // Only include dates within the requested range\n        if (date >= fromDate && date <= toDate) {\n          const data = timeSeries[dateStr];\n          \n          candleData.t.push(Math.floor(date.getTime() / 1000));\n          candleData.o.push(parseFloat(data[\"1. open\"]));\n          candleData.h.push(parseFloat(data[\"2. high\"]));\n          candleData.l.push(parseFloat(data[\"3. low\"]));\n          candleData.c.push(parseFloat(data[\"4. close\"]));\n          candleData.v.push(parseFloat(data[\"5. volume\"]));\n        }\n      }\n      \n      if (candleData.t.length === 0) {\n        console.log(` No data in date range for ${symbol}`);\n        return null;\n      }\n      \n      console.log(` Alpha Vantage: Retrieved ${candleData.t.length} data points for ${symbol}`);\n      console.log(`   Date range: ${new Date(candleData.t[0] * 1000).toLocaleDateString()} to ${new Date(candleData.t[candleData.t.length - 1] * 1000).toLocaleDateString()}`);\n      \n      return candleData;\n    } catch (error) {\n      console.error(`Error fetching candles from Alpha Vantage for ${symbol}:`, error);\n      return null;\n    }\n  }\n}\n\nexport const alphaVantageService = new AlphaVantageService();\n","path":null,"size_bytes":4625,"size_tokens":null},"client/src/components/ui/calendar-caption.tsx":{"content":"import { useNavigation } from \"react-day-picker\";\n\ninterface CalendarCaptionProps {\n  displayMonth: Date;\n  fromYear?: number;\n  toYear?: number;\n}\n\nexport function CalendarCaption({ displayMonth, fromYear = 2014, toYear = 2024 }: CalendarCaptionProps) {\n  const { goToMonth } = useNavigation();\n  const currentMonth = displayMonth.getMonth();\n  const currentYear = displayMonth.getFullYear();\n\n  const months = [\n    \"January\", \"February\", \"March\", \"April\", \"May\", \"June\",\n    \"July\", \"August\", \"September\", \"October\", \"November\", \"December\"\n  ];\n\n  const years = Array.from(\n    { length: toYear - fromYear + 1 },\n    (_, i) => fromYear + i\n  );\n\n  const handleMonthChange = (e: React.ChangeEvent<HTMLSelectElement>) => {\n    const newMonth = parseInt(e.target.value);\n    const newDate = new Date(currentYear, newMonth);\n    goToMonth(newDate);\n  };\n\n  const handleYearChange = (e: React.ChangeEvent<HTMLSelectElement>) => {\n    const newYear = parseInt(e.target.value);\n    const newDate = new Date(newYear, currentMonth);\n    goToMonth(newDate);\n  };\n\n  return (\n    <div className=\"flex items-center justify-center gap-2 mb-2\">\n      <select\n        value={currentMonth}\n        onChange={handleMonthChange}\n        className=\"bg-[#2A2A2A] text-[#f7f7f7] border border-[#474747] rounded px-2 py-1 text-sm cursor-pointer hover:bg-[#333333] focus:outline-none focus:ring-1 focus:ring-[#5AF5FA]\"\n        style={{ backgroundColor: '#2A2A2A', color: '#f7f7f7' }}\n      >\n        {months.map((month, index) => (\n          <option \n            key={month} \n            value={index}\n            style={{ backgroundColor: '#3A3A3A', color: '#f7f7f7' }}\n          >\n            {month}\n          </option>\n        ))}\n      </select>\n\n      <select\n        value={currentYear}\n        onChange={handleYearChange}\n        className=\"bg-[#2A2A2A] text-[#f7f7f7] border border-[#474747] rounded px-2 py-1 text-sm cursor-pointer hover:bg-[#333333] focus:outline-none focus:ring-1 focus:ring-[#5AF5FA]\"\n        style={{ backgroundColor: '#2A2A2A', color: '#f7f7f7' }}\n      >\n        {years.map((year) => (\n          <option \n            key={year} \n            value={year}\n            style={{ backgroundColor: '#3A3A3A', color: '#f7f7f7' }}\n          >\n            {year}\n          </option>\n        ))}\n      </select>\n    </div>\n  );\n}\n","path":null,"size_bytes":2333,"size_tokens":null},"client/src/components/ai-copilot/copilot-panel.tsx":{"content":"import React, { useState, useRef, useEffect } from 'react';\nimport { useQuery, useMutation } from '@tanstack/react-query';\nimport { Card } from '@/components/ui/card';\nimport { Button } from '@/components/ui/button';\nimport { Input } from '@/components/ui/input';\nimport { ScrollArea } from '@/components/ui/scroll-area';\nimport { Sheet, SheetContent, SheetHeader, SheetTitle } from '@/components/ui/sheet';\nimport { ResizablePanel } from '@/components/ui/resizable';\nimport { Bot, Send, X, Sparkles, FileText, TrendingUp, Loader2 } from 'lucide-react';\nimport { apiRequest, queryClient } from '@/lib/queryClient';\nimport { useToast } from '@/hooks/use-toast';\n\ninterface CopilotAction {\n  type: 'overlay:indicator' | 'overlay:custom' | 'timeframe:change' | 'annotation:add' | 'timeseries:replace';\n  payload: any;\n}\n\ninterface CopilotPanelProps {\n  symbol: string;\n  timeframe: string;\n  isOpen: boolean;\n  onClose: () => void;\n  onApplyOverlay?: (overlay: any) => void;\n  onApplyTimeSeries?: (data: any[]) => void;\n  onChangeTimeframe?: (timeframe: string) => void;\n  onAddAnnotation?: (annotation: any) => void;\n  isMobile?: boolean;\n}\n\nexport function CopilotPanel({\n  symbol,\n  timeframe,\n  isOpen,\n  onClose,\n  onApplyOverlay,\n  onApplyTimeSeries,\n  onChangeTimeframe,\n  onAddAnnotation,\n  isMobile = false\n}: CopilotPanelProps) {\n  const { toast } = useToast();\n  const [chatId, setChatId] = useState<string | null>(null);\n  const [messages, setMessages] = useState<any[]>([]);\n  const [input, setInput] = useState('');\n  const messagesEndRef = useRef<HTMLDivElement>(null);\n  const fileInputRef = useRef<HTMLInputElement>(null);\n\n  // Create chat session\n  const createSession = useMutation({\n    mutationFn: async () => {\n      const res = await apiRequest('POST', '/api/ai-copilot/session');\n      return res.json();\n    },\n    onSuccess: (data) => {\n      setChatId(data.id);\n      setMessages([]);\n    },\n    onError: () => {\n      toast({\n        title: \"Error\",\n        description: \"Failed to start AI copilot session\",\n        variant: \"destructive\"\n      });\n    }\n  });\n\n  // Fetch messages\n  const { data: messagesData } = useQuery({\n    queryKey: ['/api/ai-copilot/messages', chatId],\n    enabled: !!chatId && isOpen,\n    refetchInterval: 2000,\n  });\n\n  useEffect(() => {\n    if (messagesData) {\n      setMessages(messagesData);\n    }\n  }, [messagesData]);\n\n  // Send message\n  const sendMessage = useMutation({\n    mutationFn: async (msg: string) => {\n      const enrichedMessage = `\n        Stock: ${symbol}\n        Current timeframe: ${timeframe}\n        User request: ${msg}\n        \n        Context: The user is editing a price chart and wants assistance with overlays, metrics, or time series data.\n        Please provide specific, actionable suggestions for chart modifications.\n        If suggesting overlays, specify the exact parameters needed.\n        If the user provides data, help parse and validate it for chart display.\n      `;\n      \n      const res = await apiRequest('POST', '/api/ai-copilot/chat', { \n        chatId, \n        message: enrichedMessage\n      });\n      return res.json();\n    },\n    onSuccess: (response) => {\n      setInput('');\n      queryClient.invalidateQueries({ queryKey: ['/api/ai-copilot/messages', chatId] });\n      \n      // Process AI response for chart actions\n      if (response.chartConfig) {\n        processAIResponse(response.chartConfig);\n      }\n    },\n    onError: () => {\n      toast({\n        title: \"Error\",\n        description: \"Failed to send message\",\n        variant: \"destructive\"\n      });\n    }\n  });\n\n  // Process AI suggestions - convert to standard action format\n  const processAIResponse = (config: any) => {\n    try {\n      // Map config types to action types\n      if (config.type === 'overlay') {\n        if (onApplyOverlay) {\n          onApplyOverlay({\n            indicatorId: config.indicatorId || 'custom',\n            label: config.title || 'Custom Overlay',\n            params: config.params || {},\n            ...config\n          });\n        }\n      } else if (config.type === 'timeseries' && config.data) {\n        // Validate and apply time series data\n        const validatedData = validateTimeSeries(config.data);\n        if (validatedData && onApplyTimeSeries) {\n          onApplyTimeSeries(validatedData);\n        }\n      } else if (config.type === 'timeframe' && config.value) {\n        if (onChangeTimeframe) {\n          onChangeTimeframe(config.value);\n        }\n      } else if (config.type === 'annotation') {\n        if (onAddAnnotation) {\n          onAddAnnotation({\n            type: config.annotationType || 'text',\n            text: config.text || '',\n            timestamp: config.timestamp || Date.now(),\n            price: config.price || 0,\n            ...config\n          });\n        }\n      }\n    } catch (error) {\n      console.error('Error processing AI response:', error);\n      toast({\n        title: \"Error\",\n        description: \"Failed to apply AI suggestion\",\n        variant: \"destructive\"\n      });\n    }\n  };\n\n  // Validate time series data\n  const validateTimeSeries = (data: any[]): any[] | null => {\n    try {\n      return data.map(item => ({\n        timestamp: new Date(item.timestamp || item.date).getTime(),\n        value: parseFloat(item.value || item.price || item.close),\n        label: item.label || ''\n      })).filter(item => !isNaN(item.timestamp) && !isNaN(item.value));\n    } catch (error) {\n      toast({\n        title: \"Invalid Data\",\n        description: \"Could not parse the provided data\",\n        variant: \"destructive\"\n      });\n      return null;\n    }\n  };\n\n  // Handle file upload\n  const handleFileUpload = (event: React.ChangeEvent<HTMLInputElement>) => {\n    const file = event.target.files?.[0];\n    if (!file) return;\n\n    const reader = new FileReader();\n    reader.onload = (e) => {\n      const content = e.target?.result as string;\n      sendMessage.mutate(`I have uploaded data:\\n${content}\\n\\nPlease help me add this as an overlay on the chart.`);\n    };\n    reader.readAsText(file);\n  };\n\n  // Initialize session when panel opens\n  useEffect(() => {\n    if (isOpen && !chatId) {\n      createSession.mutate();\n    }\n  }, [isOpen]);\n\n  // Auto-scroll to bottom\n  useEffect(() => {\n    if (messagesEndRef.current) {\n      messagesEndRef.current.scrollIntoView({ behavior: 'smooth' });\n    }\n  }, [messages]);\n\n  const handleSend = () => {\n    if (!input.trim() || !chatId || sendMessage.isPending) return;\n    sendMessage.mutate(input);\n  };\n\n  const handleKeyPress = (e: React.KeyboardEvent) => {\n    if (e.key === 'Enter' && !e.shiftKey) {\n      e.preventDefault();\n      handleSend();\n    }\n  };\n\n  const panelContent = (\n    <div className=\"flex flex-col h-full\" style={{ backgroundColor: '#1C1C1C' }}>\n      {/* Header */}\n      <div className=\"p-4 border-b border-border flex items-center justify-between\">\n        <div className=\"flex items-center gap-2\">\n          <Bot className=\"h-5 w-5\" style={{ color: '#5AF5FA' }} />\n          <h3 className=\"font-semibold text-[#F7F7F7]\">AI Chart Assistant</h3>\n        </div>\n        <Button\n          variant=\"ghost\"\n          size=\"sm\"\n          onClick={onClose}\n          className=\"h-8 w-8 p-0\"\n          data-testid=\"button-close-copilot\"\n        >\n          <X className=\"h-4 w-4\" />\n        </Button>\n      </div>\n\n      {/* Context Bar */}\n      <div className=\"px-4 py-2 bg-[#121212] border-b border-border\">\n        <div className=\"flex items-center gap-4 text-xs text-muted-foreground\">\n          <span className=\"flex items-center gap-1\">\n            <TrendingUp className=\"h-3 w-3\" />\n            {symbol}\n          </span>\n          <span></span>\n          <span>{timeframe}</span>\n        </div>\n      </div>\n\n      {/* Messages */}\n      <ScrollArea className=\"flex-1 p-4\">\n        <div className=\"space-y-3\">\n          {messages.length === 0 && (\n            <div className=\"text-center py-8\">\n              <Sparkles className=\"h-12 w-12 mx-auto mb-3\" style={{ color: '#5AF5FA', opacity: 0.3 }} />\n              <p className=\"text-sm text-muted-foreground mb-4\">\n                Hi! I can help you with:\n              </p>\n              <div className=\"text-xs text-muted-foreground space-y-2\">\n                <div> Adding overlays and indicators</div>\n                <div> Analyzing custom time series data</div>\n                <div> Creating annotations</div>\n                <div> Adjusting timeframes</div>\n              </div>\n            </div>\n          )}\n\n          {messages.map((msg) => (\n            <div \n              key={msg.id}\n              className={`flex ${msg.role === 'user' ? 'justify-end' : 'justify-start'}`}\n            >\n              <div \n                className={`max-w-[85%] rounded-lg p-3 text-sm ${\n                  msg.role === 'user' \n                    ? 'bg-[#5AF5FA] text-black' \n                    : 'bg-[#2A2A2A] text-[#F7F7F7]'\n                }`}\n              >\n                <p className=\"whitespace-pre-wrap\">{msg.content}</p>\n                \n                {msg.chartConfig && (\n                  <div className=\"mt-2 p-2 bg-black/20 rounded text-xs\">\n                    <p className=\"font-semibold mb-1\"> Action available</p>\n                    <p>{msg.chartConfig.title || 'Chart modification ready'}</p>\n                  </div>\n                )}\n              </div>\n            </div>\n          ))}\n          <div ref={messagesEndRef} />\n        </div>\n      </ScrollArea>\n\n      {/* Input Area */}\n      <div className=\"p-4 border-t border-border\">\n        <div className=\"space-y-3\">\n          {/* File Upload Button */}\n          <div>\n            <input\n              ref={fileInputRef}\n              type=\"file\"\n              accept=\".csv,.txt,.json\"\n              className=\"hidden\"\n              onChange={handleFileUpload}\n              data-testid=\"input-file-upload\"\n            />\n            <Button\n              variant=\"outline\"\n              size=\"sm\"\n              onClick={() => fileInputRef.current?.click()}\n              className=\"w-full text-xs\"\n              disabled={!chatId || sendMessage.isPending}\n            >\n              <FileText className=\"h-3 w-3 mr-2\" />\n              Upload Data (CSV/JSON)\n            </Button>\n          </div>\n\n          {/* Message Input */}\n          <div className=\"flex gap-2\">\n            <Input\n              value={input}\n              onChange={(e) => setInput(e.target.value)}\n              onKeyPress={handleKeyPress}\n              placeholder=\"Ask about overlays, data, or metrics...\"\n              className=\"flex-1 text-sm\"\n              disabled={!chatId || sendMessage.isPending}\n              data-testid=\"input-copilot-message\"\n            />\n            <Button\n              onClick={handleSend}\n              disabled={!input.trim() || !chatId || sendMessage.isPending}\n              className=\"h-9 w-9 p-0\"\n              style={{ backgroundColor: '#5AF5FA', color: '#000' }}\n              data-testid=\"button-send-copilot\"\n            >\n              {sendMessage.isPending ? (\n                <Loader2 className=\"h-4 w-4 animate-spin\" />\n              ) : (\n                <Send className=\"h-4 w-4\" />\n              )}\n            </Button>\n          </div>\n        </div>\n      </div>\n    </div>\n  );\n\n  // Mobile: use Sheet\n  if (isMobile) {\n    return (\n      <Sheet open={isOpen} onOpenChange={(open) => !open && onClose()}>\n        <SheetContent side=\"right\" className=\"p-0 w-[85vw] sm:w-[400px]\">\n          {panelContent}\n        </SheetContent>\n      </Sheet>\n    );\n  }\n\n  // Desktop: use ResizablePanel (will be wrapped by parent)\n  if (!isOpen) return null;\n  \n  return (\n    <ResizablePanel \n      defaultSize={30} \n      minSize={25} \n      maxSize={40}\n      className=\"border-l border-border\"\n    >\n      {panelContent}\n    </ResizablePanel>\n  );\n}","path":null,"size_bytes":11863,"size_tokens":null},"server/types.d.ts":{"content":"// Extend Express Request to include userId from auth middleware\ndeclare namespace Express {\n  interface Request {\n    userId?: string;\n  }\n}\n","path":null,"size_bytes":142,"size_tokens":null}},"version":2}